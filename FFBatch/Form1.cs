using Microsoft.VisualBasic.FileIO;
using Microsoft.Win32;
using Shell32;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Diagnostics;
using System.Drawing;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Management.Instrumentation;
using System.Net;
using System.Reflection;
using System.Runtime.InteropServices;
using System.Security.Cryptography;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace FFBatch
{
    public partial class Form1 : Form
    {
        public string app_v { get; set; }

        internal const int CTRL_C_EVENT = 0;

        [DllImport("kernel32.dll")]
        internal static extern bool GenerateConsoleCtrlEvent(uint dwCtrlEvent, uint dwProcessGroupId);

        [DllImport("kernel32.dll", SetLastError = true)]
        internal static extern bool AttachConsole(uint dwProcessId);

        [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]
        internal static extern bool FreeConsole();

        [DllImport("kernel32.dll")]
        private static extern bool SetConsoleCtrlHandler(ConsoleCtrlDelegate HandlerRoutine, bool Add);

        // Delegate type to be used as the Handler Routine for SCCH
        private delegate Boolean ConsoleCtrlDelegate(uint CtrlType);

        private List<int> selecs = new List<int>();
        private ProgressBarWithText Pg1 = new ProgressBarWithText();
        private Boolean show_est = false;
        private int current_fr = 4000;
        private Boolean warn_space = false;
        private Decimal check_space = 1;
        private String img_dur_wiz = "0";
        private Boolean images_from_wiz = false;
        private String split_by_size = "";
        private String img_aud_from_wiz = "";
        private Boolean start_seq = false;
        private Boolean start_multi = false;
        public string language = FFBatch.Properties.Settings.Default.app_lang;
        private Boolean has_lives_multi = false;
        private Boolean t_out_yt = false;
        private int thumbs_count = 0;
        private Boolean display_eta = false;
        private String current_channel = "";
        private String bestv_a = "";
        private ListViewColumnSorter lvwColumnSorter3;
        private ListViewColumnSorter lvwColumnSorter_Full;
        private ColumnHeader SortingColumn = null;
        private Boolean batch_concat = false;
        public String concat_intro = "";
        public String concat_end = "";
        public String concat_intro_dur = "";
        public String concat_end_dur = "";
        private const int _minimumColumnWidth = 64;
        private List<string> list_successful_m = new List<string>();
        private List<string> list_failed_m = new List<string>();
        public String latest_ff = String.Empty;
        public Boolean show_wiz_start = true;
        public Boolean from_wizard = false;
        private Boolean prevent_sleep = false;
        private Boolean show_wiz = false;
        private String port_path = System.IO.Path.Combine(Application.StartupPath, "settings") + "\\";
        public Boolean res_col = false;
        private int col_width = 0;
        private String selected_add_col = "";
        private System.Media.SoundPlayer soundPlayer = new System.Media.SoundPlayer();
        private Boolean fix_pre = false;
        private Boolean play_on_end = false;
        private String play_file_path = String.Empty;
        private Boolean writable_yl = false;
        private String saved_pres_two = "";
        private String saved_ext_two = "";
        private Boolean stopped_recording = false;
        private String vc_download = "";
        private ToolTip toolT002 = new ToolTip();
        private String run_command = String.Empty;
        private String run_command_args = String.Empty;
        private Boolean m3u_params_checked, output_server_checked = false;
        private String down_speed_m = "";
        private String embed_subs_m = "";
        private String embed_meta_m = "";
        private String write_subs_m = "";
        private String convert_subs_m = "";
        private String format_out_m = "";
        private Boolean show_total_prog_m = false;
        private String m3u_output_ext_m = String.Empty;
        private String output_server_m = String.Empty;
        private String m3u_params_m = String.Empty;
        private String auto_subs_m = String.Empty;
        private DataGridView dg1_temp = new DataGridView();
        private Boolean opened_m = false;
        private String multi_dest = "";
        private Boolean fatal_parallel = false;
        private String fatal_parallel_msg = "";
        private Boolean one_ok = false;
        private Boolean yt_chk = false;
        public Boolean abort_validate_url = false;
        private float font_size = FFBatch.Properties.Settings.Default.font_size;
        private Boolean adding_youtube = false;
        private ListView lv_size = new ListView();
        private Boolean pop_invalids = false;
        private Boolean cancel_cache = false;
        private WebClient wc = new WebClient();
        private WebClient wc2 = new WebClient();
        private WebClient wc_dl = new WebClient();
        private Boolean cached = false;
        public long file_size_prog = 0;
        private Boolean cancelados_paralelos = false;
        private Boolean cancel_queue = false;
        private Boolean working = false;
        private int tiempo_apaga = 120;
        private Double durat_n = 0;
        private String validate_duration;
        private Boolean valid_prog = false;
        private String def_mux_video_enc = "copy";
        private String def_mux_audio_enc = "copy";
        private String def_mux_subs_enc = "copy";
        private String def_lang_und_tracks = "und";
        private Boolean Extract_img = false;
        private Boolean select_mp4 = false;
        private int time_n_tasks = 0;
        private Boolean total_time = false;
        private Boolean recording_scr = false;
        private Boolean hard_sub = false;
        private String add_suffix = "";
        private int capture_handle;
        private Boolean Enable_txt_hard_Subs = false;
        private long tot_size = 0;
        private Boolean add_subfs = false;

        //Boolean empty_text = false;
        private String n_th_suffix = String.Empty;

        private String n_th_source_ext = String.Empty;
        private int pending_dur = 0;
        private Boolean canceled_add = false;
        private Boolean dur_ok = false;
        private Boolean canceled_file_adding = false;
        private ListView list_pending_dur = new ListView();
        private ListView list_adding = new ListView();
        private ListView list_global_proc = new ListView();
        private List<string> files_to_add = new List<string>();
        private Image[] dg_thumbs = new Image[2000];
        private Boolean change_tab_1 = false;
        private Boolean change_tab_2 = false;
        private Boolean list_not_empty = false;
        private Process process_glob = new Process();
        private Process probe_urls = new Process();

        //private Process update_yl = new Process();
        private Label was_started = new Label();

        private Boolean avoid_overwriting = false;
        private Boolean stop_validating_url = false;
        private Boolean skip_current_url = false;
        private Boolean m3u_running = false;
        private Boolean multi_running = false;
        public Dictionary<string, Process> procs = new Dictionary<string, Process>();
        private Dictionary<string, Point> points = new Dictionary<string, Point>();
        private Dictionary<string, Size> sizes = new Dictionary<string, Size>();
        private Dictionary<string, PictureBox> m_images = new Dictionary<string, PictureBox>();
        private Dictionary<string, String> multi_logs = new Dictionary<string, String>();
        private Dictionary<string, String> multi_params = new Dictionary<string, String>();
        public List<string> multi_speeds = new List<string>();
        public List<string> multi_fps = new List<string>();
        private Boolean aborted_url = false;
        private int capture_count = 0;
        private Boolean tried_ok = false;
        private String textbox_params = String.Empty;
        private Boolean aborted = false;
        private Double total_duration = 0;
        private Double total_multi_duration = 0;
        private Double start_total_time = 0;

        //private ComboBox mem_prio = new ComboBox();
        private Boolean tracks_empty = true;

        private int time_est_size = 0;
        private Form frm_log = new Form();
        private DataGridView clonegrid = new DataGridView();
        private RichTextBox Rtxt = new RichTextBox();
        private Boolean skipped = false;
        private List<string> tried_params = new List<string>();
        private Boolean m3u_single_running = false;
        private Boolean paused = false;
        private ComboBox CB1_o = new ComboBox();
        private String audio_capture_device = String.Empty;
        private String prev_dev_audio = String.Empty;
        private Boolean abort_capture = false;
        private Boolean hw_decoders = false;
        private String hw_decode_glob = String.Empty;
        private Boolean warn_mux_webm = false;
        private Boolean warn_mux_mov = false;
        private String shut_type = "Power off";
        private Boolean fade_ok = true;
        private String silence_params = String.Empty;
        private String multi_pr1 = String.Empty;
        private String multi_pr2 = String.Empty;
        private String multi_pr3 = String.Empty;
        private String multi_pr1_ext = String.Empty;
        private String multi_pr2_ext = String.Empty;
        private String multi_pr3_ext = String.Empty;
        private int n_multi_presets = 0;
        private String multi_two_pr1 = String.Empty;
        private String multi_two_ext = String.Empty;
        private String multi_1st_pass = String.Empty;
        private Boolean ren_multi = false;
        private Boolean runnin_n_presets = false;
        private TextBox path_txt = new TextBox();
        private ListBox LB1_o_try = new ListBox();
        public Boolean is_portable = false;
        private ToolTip toolTip01 = new ToolTip();
        private ToolTip toolTip_settings = new ToolTip();
        private Boolean back_ff = true;
        private Boolean just_started = true;
        private Boolean just_started5 = true;
        private int current_prio;
        private Boolean save_path_state = false;
        private Boolean save_preset_state = false;
        private List<string> decoders = new List<string>();
        private Boolean big_res = false;
        private int ff_ver_proc = 0;
        private Form frm_output2 = new Form();
        private Boolean tip_sort_dur = false;
        private Boolean sort_multi_dur = false;
        private Boolean is_ff_ok = false;
        private Boolean first_concat = true;
        private ListView LB1_kf = new ListView();

        private Form3 form3 = new Form3();
        private Form4 form4 = new Form4();
        private Form5 form5 = new Form5();
        private Form16 frm_mux_jobs = new Form16();

        private Boolean delete_def = false;
        private Boolean delete_one = false;
        private OpenFileDialog file_dialog_ffq = new OpenFileDialog();
        private SaveFileDialog save_ffq = new SaveFileDialog();
        private Boolean send_par_consol = true;
        private Boolean warn_success_items = true;
        private Boolean no_warn_0_dur = true;
        private Boolean no_save_logs = false;
        private Boolean verbose_logs = false;
        private Boolean full_report = false;
        private Boolean no_save_cache = false;
        private Boolean os_save_cache = false;
        private Boolean remember_last_tab = false;
        private Boolean remember_w = false;
        private ListView unfilter_lv1 = new ListView();
        private ListView filtered_lv1 = new ListView();
        private ToolTip tool_undo_filter = new ToolTip();
        private Boolean size_sorted = false;
        private int initial_tab = 0;
        private PictureBox pic_pause = new PictureBox();
        private Boolean two_try_fail = false;
        public Boolean cancel_two = false;
        private int invalids = 0;
        private String file_to_copy = String.Empty;
        private Boolean ask_cache_net = false;
        private Boolean first_run = false;
        private Boolean current_save_prio = false;
        public TextBox pr_default = new TextBox();
        private int current_width = 0;
        private int current_height = 0;
        private Boolean mixed_urls = false;
        private Boolean opening_youtubes = false;
        private Boolean internet_up = true;
        private String pl_url = "";
        private String Clear_cache = "";
        private Double Total_dur_urls = 0;
        private Boolean checking_url_m3u = false;
        private String[] lines_txt_m3u = new String[] { "" };
        private int playlists_int = 0;
        private int errors_enc = 0;
        private int warn_enc = 0;
        private string down_ver = "https://raw.githubusercontent.com/eibol/ffmpeg_batch/gh-pages/current_ffb.txt";
        private string down_ver2 = "https://ffmpeg-batch.sourceforge.io/current_ffb.txt";
        private String yl_latest = "https://github.com/yt-dlp/yt-dlp/releases";
        private string proj_web = "https://ffmpeg-batch.sourceforge.io";
        private Boolean images_v = false;
        private String images_time = "5";

        public String pr1_string_main
        {
            get { return multi_pr1; }
            set { multi_pr1 = value; }
        }

        //Tecla global de parada ha sido pulsada

        [DllImport("user32.dll")]
        private static extern bool RegisterHotKey(IntPtr hWnd, int id, int fsModifiers, int vk);

        [DllImport("user32.dll")]
        private static extern bool UnregisterHotKey(IntPtr hWnd, int id);

        private enum KeyModifier
        {
            None = 0,
            Alt = 1,
            Control = 2,
            Shift = 4,
            WinKey = 8
        }

        [DllImport("user32.dll", CharSet = CharSet.Auto, ExactSpelling = true)]
        private static extern IntPtr GetForegroundWindow();

        [DllImport("user32.dll", CharSet = CharSet.Auto, SetLastError = true)]
        private static extern int GetWindowThreadProcessId(IntPtr handle, out int processId);

        public Form1()
        {
            InitializeComponent();

            int id = 0;     // The id of the hotkey.
            RegisterHotKey(this.Handle, id, (int)KeyModifier.Control + (int)KeyModifier.Shift, Keys.P.GetHashCode());

            check_res();
            String f_remember_w = String.Empty;
            if (is_portable == false)
            {
                f_remember_w = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_remember_w.ini";
            }
            else
            {
                f_remember_w = port_path + "ff_remember_w_portable.ini";
            }

            if (File.Exists(f_remember_w))
            {
                Rectangle resolution = Screen.PrimaryScreen.Bounds;
                Boolean out_r_h = false;
                Boolean out_r_w = false;
                this.StartPosition = FormStartPosition.Manual;
                this.Location = Properties.Settings.Default.wLocation;
                int lin = 0;
                foreach (String line in File.ReadLines(f_remember_w))
                {
                    if (lin == 0)
                    {
                        if (Convert.ToInt32(line) <= resolution.Height)
                        {
                            this.Height = Convert.ToInt32(line);
                            out_r_h = false;
                        }
                        else out_r_h = true;
                    }
                    else if (lin == 1)
                    {
                        if (Convert.ToInt32(line) <= resolution.Width)
                        {
                            this.Width = Convert.ToInt32(line);
                            out_r_w = false;
                        }
                        else out_r_w = true;
                    }
                    lin++;
                }
                if (out_r_w == true && out_r_h == true) this.StartPosition = FormStartPosition.CenterScreen;
            }

            lvwColumnSorter3 = new ListViewColumnSorter();
            this.listView3.ListViewItemSorter = lvwColumnSorter3;
            lvwColumnSorter_Full = new ListViewColumnSorter();
            this.listView1.ListViewItemSorter = lvwColumnSorter_Full;
            WebClient webClient1 = new WebClient();
        }

        protected override void WndProc(ref Message m)
        {
            base.WndProc(ref m);

            if (m.Msg == 0x0312)
            {
                /* Note that the three lines below are not needed if you only want to register one hotkey.
                 * The below lines are useful in case you want to register multiple keys, which you can use a switch with the id as argument, or if you want to know which key/modifier was pressed for some particular reason. */

                Keys key = (Keys)(((int)m.LParam >> 16) & 0xFFFF);                  // The key of the hotkey that was pressed.
                KeyModifier modifier = (KeyModifier)((int)m.LParam & 0xFFFF);       // The modifier of the hotkey that was pressed.
                int id = m.WParam.ToInt32();                                        // The id of the hotkey that was pressed.

                this.InvokeEx(f => this.WindowState = FormWindowState.Normal);
                this.InvokeEx(f => f.btn_abort_all.PerformClick());
            }
        }

        private void RefreshResources(Control ctrl, ComponentResourceManager res)
        {
            ctrl.SuspendLayout();
            this.InvokeEx(f => res.ApplyResources(ctrl, ctrl.Name, Thread.CurrentThread.CurrentUICulture));
            foreach (Control control in ctrl.Controls)
                RefreshResources(control, res); // recursion
            ctrl.ResumeLayout(false);
        }

        private void refresh_lang()
        {
            //Thread.CurrentThread.CurrentCulture = new CultureInfo(FFBatch.Properties.Settings.Default.app_lang, true);
            Thread.CurrentThread.CurrentUICulture = new CultureInfo(FFBatch.Properties.Settings.Default.app_lang, true);
            System.ComponentModel.ComponentResourceManager resources = new System.ComponentModel.ComponentResourceManager(typeof(Form1));
            RefreshResources(this, resources);
            btn_update.Text = Properties.Strings2.version + " " + Application.ProductVersion;
        }

        private void button1_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            if (!File.Exists(Path.Combine(Application.StartupPath, "ffmpeg.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_ffmpeg, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            openFileDialog1.Filter = FFBatch.Properties.Strings.av + "  |*.mp4; *.mkv; *.ts; *.mxf; *.mp3; *.wav; *.flac; *.m4a; *.avi; *.mts; *.flv; *.alac; *.aac; *.mpg; *.mp2; *.mpe; *.ogv; *.webm; *.aiff; *.vob; *.wma; *.wmv; *.mov; *.mka; *.m2ts; *.ac3; *.ogg|" + FFBatch.Properties.Strings2.imgs + " (*.jpg; *.png; *.gif) | *.jpg; *.png; *.gif|" + FFBatch.Properties.Strings.all_files + " (*.*) | *.*";

            if (tabControl1.SelectedIndex == 3)
            {
                btn_add_urls.PerformClick();
                return;
            }
            else if (tabControl1.SelectedIndex == 1)
            {
                openFileDialog1.Filter = FFBatch.Properties.Strings.av + "  |*.mp4; *.mkv; *.mxf; *.mp3; *.wav; *.flac; *.avi; *.mts; *.flv; *.alac; *.aac; *.mpg; *.mp2; *.mpe; *.ogv; *.webm; *.aiff; *.vob; *.wma; *.wmv; *.mov; *.mka; *.srt; *.m2ts; *.idx; *.ac3; *.jpg; *.png; *.gif; *.psd; *.tiff; *.ass; *.ogg|" + FFBatch.Properties.Strings.all_files + " (*.*) | *.*";
            }
            else if (tabControl1.SelectedIndex == 2)
            {
                openFileDialog1.Filter = FFBatch.Properties.Strings.av + "  | *.mp4; *.mkv; *.mxf; *.avi; *.mts; *.flv; *.mpg; *.mp2; *.mpe; *.ogv; *.webm; *.aiff; *.vob; *.wmv; *.mov; *.mka; *.m2ts; *.ogg| " + FFBatch.Properties.Strings.all_files + " (*.*) | *.*";
            }

            if (openFileDialog1.ShowDialog() == DialogResult.Cancel) from_wizard = false;
        }

        private void openFileDialog1_FileOk(object sender, CancelEventArgs e)
        {
            openFileDialog1.InitialDirectory = Path.GetDirectoryName(openFileDialog1.FileNames[0]);
            initial_tab = tabControl1.SelectedIndex;
            change_tab_1 = false;
            change_tab_2 = false;

            if (tabControl1.SelectedIndex == 1)
            {
                tabControl1.SelectedIndex = 0;
                change_tab_1 = true;
            }
            else if (tabControl1.SelectedIndex == 2)
            {
                tabControl1.SelectedIndex = 0;
                change_tab_2 = true;
            }

            string[] file_drop = (string[])openFileDialog1.FileNames;

            List<string> files2 = new List<string>();

            int num_drop = 0;
            foreach (String dropped in file_drop)
            {
                if (File.Exists(dropped))
                {
                    files2.Add(dropped);
                }

                num_drop = files2.Count();

                if (num_drop >= 10000)
                {
                    var a = MessageBox.Show(FFBatch.Properties.Strings.adding + " " + num_drop + " " + FFBatch.Properties.Strings.some_time, FFBatch.Properties.Strings.many_files, MessageBoxButtons.OKCancel, MessageBoxIcon.Question);
                    if (a == DialogResult.Cancel)
                    {
                        return;
                    }
                }
            }

            files_to_add = files2;
            canceled_file_adding = false;
            btn_cancel_add.Enabled = true;
            btn_cancel_add.Visible = true;
            btn_cancel_add.Refresh();
            BG_Files.RunWorkerAsync();
        }

        private void check_fade()
        {
            //Video fading

            if (fade_v_in.CheckState == CheckState.Checked && fade_v_out.CheckState == CheckState.Unchecked)
            {
                foreach (ListViewItem item in listView1.Items)
                {
                    if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                    {
                        if (TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds < Convert.ToDouble(num_v_in.Value))
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.fade1, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                            fade_ok = false;
                            return;
                        }
                    }
                }
            }

            if (fade_v_in.CheckState == CheckState.Unchecked && fade_v_out.CheckState == CheckState.Checked)
            {
                foreach (ListViewItem item in listView1.Items)
                {
                    if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                    {
                        if (TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds < Convert.ToDouble(num_v_out.Value))
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.fade2, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                            fade_ok = false;
                            return;
                        }
                    }
                }
            }
            if (fade_v_in.CheckState == CheckState.Checked && fade_v_out.CheckState == CheckState.Checked)
            {
                foreach (ListViewItem item in listView1.Items)
                {
                    if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                    {
                        if (TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds < (Convert.ToDouble(num_v_in.Value) + Convert.ToDouble(num_v_out.Value)))
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.fade3, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                            fade_ok = false;
                            return;
                        }
                    }
                }
            }
            //Audio fading
            if (fade_a_in.CheckState == CheckState.Checked && fade_a_out.CheckState == CheckState.Unchecked)
            {
                foreach (ListViewItem item in listView1.Items)
                {
                    if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                    {
                        if (TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds < Convert.ToDouble(num_a_in.Value))
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.fade4, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                            fade_ok = false;
                            return;
                        }
                    }
                }
            }

            if (fade_a_in.CheckState == CheckState.Unchecked && fade_a_out.CheckState == CheckState.Checked)
            {
                foreach (ListViewItem item in listView1.Items)
                {
                    if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                    {
                        if (TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds < Convert.ToDouble(num_a_out.Value))
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.fade5, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                            fade_ok = false;
                            return;
                        }
                    }
                }
            }
            if (fade_a_in.CheckState == CheckState.Checked && fade_a_out.CheckState == CheckState.Checked)
            {
                foreach (ListViewItem item in listView1.Items)
                {
                    if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                    {
                        if (TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds < (Convert.ToDouble(num_a_in.Value) + Convert.ToDouble(num_a_out.Value)))
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.fade6, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                            fade_ok = false;
                            return;
                        }
                    }
                }
            }
            //End audio fading
        }

        private Boolean dups_lv1()
        {
            if (checkBox1.CheckState == CheckState.Checked)
            {
                List<string> no_overw = new List<string>();

                string path_without = "";
                String out_path = txt_path_main.Text;

                foreach (ListViewItem item in listView1.Items)
                {
                    if (txt_path_main.Text.Length == 2)
                    {
                        if (txt_path_main.Text.Substring(0, 2) == ".\\")
                            out_path = item.SubItems[1].Text + txt_path_main.Text.Replace(".\\", "");
                    }
                    else
                    {
                        if (txt_path_main.Text.Substring(0, 2) == ".\\")
                            out_path = item.SubItems[1].Text + txt_path_main.Text.Replace("..", "");
                    }

                    path_without = out_path + "\\" + item.SubItems[1].Text.Substring(Path.GetPathRoot(item.SubItems[1].Text).Length);
                    no_overw.Add(path_without + "\\" + Path.GetFileNameWithoutExtension(item.Text) + "." + txt_format.Text);
                }

                var duplicates = no_overw.GroupBy(s => s).SelectMany(grp => grp.Skip(1));
                int count = no_overw.Count;
                no_overw = no_overw.Distinct().ToList();

                if (no_overw.Count < count)
                {
                    String to_show = "";
                    int i = 0;
                    foreach (String str in duplicates)
                    {
                        if (i < 5) to_show = to_show + Environment.NewLine + str;
                        i++;
                    }
                    MessageBox.Show((count - no_overw.Count).ToString() + " " + FFBatch.Properties.Strings.names_overw + Environment.NewLine + Environment.NewLine + to_show, "FFBatch.Properties.Strings.overw1", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return true;
                }
                return false;
            }
            else
            {
                List<string> no_overw = new List<string>();

                string path_without = "";
                String out_path = txt_path_main.Text;

                foreach (ListViewItem item in listView1.Items)
                {
                    if (txt_path_main.Text.Length == 2)
                    {
                        if (txt_path_main.Text.Substring(0, 2) == ".\\")
                            out_path = item.SubItems[1].Text + txt_path_main.Text.Replace(".\\", "");
                    }
                    else
                    {
                        if (txt_path_main.Text.Substring(0, 2) == ".\\")
                            out_path = item.SubItems[1].Text + txt_path_main.Text.Replace(".", "");
                    }

                    path_without = out_path;
                    no_overw.Add(path_without + "\\" + Path.GetFileNameWithoutExtension(item.Text) + "." + txt_format.Text);
                }

                var duplicates = no_overw.GroupBy(s => s).SelectMany(grp => grp.Skip(1));
                int count = no_overw.Count;
                no_overw = no_overw.Distinct().ToList();

                if (no_overw.Count < count)
                {
                    String to_show = "";
                    int i = 0;
                    foreach (String str in duplicates)
                    {
                        if (i < 5) to_show = to_show + Environment.NewLine + str;
                        i++;
                    }
                    MessageBox.Show((count - no_overw.Count).ToString() + " " + FFBatch.Properties.Strings.names_overw + Environment.NewLine + Environment.NewLine + to_show, "FFBatch.Properties.Strings.overw1", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return true;
                }
                return false;
            }
        }

        private void button2_Click(object sender, EventArgs e)
        {
            Pg1.Focus();

            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            LB_Wait.Visible = false;

            was_started.Text = btn_seq.Text;
            cancel_queue = false;
            notifyIcon1.Visible = true;

            if (listView1.Items.Count == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.list_empty, FFBatch.Properties.Strings.no_files, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (!File.Exists(Path.Combine(Application.StartupPath, "ffmpeg.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_ffmpeg, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }
            if (check_ff_md5() == false)
            {
                Form25 frm25 = new Form25();
                frm25.ShowDialog();
                return;
            }

            if (listView1.SelectedIndices.Count == 0)
            {
                listView1.Items[0].Selected = true;
                listView1.Items[0].Focused = true;
                listView1.Focus();
            }

            String filename1 = "";
            foreach (ListViewItem file2 in listView1.Items)
            {
                filename1 = file2.SubItems[1].Text + "\\" + file2.Text;
                if (!File.Exists(filename1))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file_not_found + " " + file2.Text, FFBatch.Properties.Strings.file_not_found2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }

            DateTime time2;
            if (!DateTime.TryParse(ss_time_input.Text, out time2))
            {
                MessageBox.Show(FFBatch.Properties.Strings.pre_input1, FFBatch.Properties.Strings.pre_input2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (ss_time_input.Text != "0:00:00")
            {
                foreach (ListViewItem item in listView1.Items)
                {
                    if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                    {
                        if (TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds <= TimeSpan.Parse(ss_time_input.Text).TotalSeconds)
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.pre_input3 + " " + '\u0022' + Path.GetFileName(item.Text) + '\u0022', FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            return;
                        }
                    }
                }
            }

            DateTime time;
            if (!DateTime.TryParse(ss_time_input.Text, out time))
            {
                MessageBox.Show(FFBatch.Properties.Strings.pre_input1, FFBatch.Properties.Strings.pre_input2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            avoid_overw();

            //Check path is writable
            String destino1 = String.Empty;
            Boolean rel_path = false;
            String filename = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text;
            if (txt_path_main.Text.Contains(".\\"))
            {
                destino1 = filename.Substring(0, filename.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
                rel_path = true;
            }
            else
            {
                if (checkBox1.CheckState == CheckState.Checked)
                {
                    String pre_dest = Path.GetDirectoryName(filename);
                    destino1 = Path.Combine(txt_path_main.Text, pre_dest.Substring(3, pre_dest.Length - 3));
                    rel_path = true;
                }
                else
                {
                    destino1 = txt_path_main.Text;
                }
            }

            try
            {
                if (rel_path == true)
                {
                    Directory.CreateDirectory(destino1);
                    System.Threading.Thread.Sleep(10);
                }
                else
                {
                    if (!Directory.Exists(destino1)) Directory.CreateDirectory(destino1);
                    File.WriteAllText(destino1 + "\\" + "FFBatch_test.txt", "FFBatch_test");
                    System.Threading.Thread.Sleep(10);
                    File.Delete(destino1 + "\\" + "FFBatch_test.txt");
                }
            }
            catch (System.Exception excpt)
            {
                MessageBox.Show(FFBatch.Properties.Strings.write_error1 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            //End path is writable

            //Validated list, start processing
            if ((fade_v_in.Checked == true && num_v_in.Value == 0) || (fade_v_out.Checked == true && num_v_out.Value == 0) || (fade_a_in.Checked == true && num_a_in.Value == 0) || (fade_a_out.Checked == true && num_a_out.Value == 0))
            {
                MessageBox.Show(FFBatch.Properties.Strings.fading_zero, FFBatch.Properties.Strings.fading_zero2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + "00h:00m:00s";

            foreach (String item in tried_params)
            {
                if (item == (txt_parameters.Text))
                {
                    tried_ok = true;
                }
            }

            if (tried_ok == false)
            {
                try
                {
                    BG_Try_preset.RunWorkerAsync();
                }
                catch
                {
                    tried_ok = true;
                }

                return;
            }
            tried_ok = false;

            //Remove test file/folder

            String file_prueba = "";
            String sel_test = filename;
            file_prueba = sel_test;
            String destino = Path.GetTempPath() + "\\" + "FFBatch_test";
            String borrar = destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + txt_format.Text;

            if (File.Exists(borrar))
            {
                try
                {
                    File.Delete(borrar);
                }
                catch { }
            }

            if (Directory.Exists(destino) == true)
            {
                try
                {
                    if (Directory.GetFiles(destino).Length == 0)
                    {
                        System.IO.Directory.Delete(destino);
                    }
                }
                catch { }
            }

            //END Remove test file/folder

            //Pending duration

            if (dur_ok == false)
            {
                list_pending_dur.Items.Clear();
                foreach (ListViewItem item in listView1.Items)
                {
                    list_pending_dur.Items.Add((ListViewItem)item.Clone());
                }
                BG_Dur.RunWorkerAsync();
                return;
            }

            if (avoid_overwriting == true && txt_path_main.Text.Contains(".\\") == false && txt_path_main.Text.Length < 4 && checkBox1.CheckState != CheckState.Checked)
            {
                avoid_overwriting = false;
                DialogResult a2 = MessageBox.Show(FFBatch.Properties.Strings.multiple_folders + " " + '\u0022' + FFBatch.Properties.Strings.recreate_path + '\u0022' + " " + "to avoid opossible overwritings." + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.continu, "Different input folders to single output folder", MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2);
                if (a2 == DialogResult.No) return;
            }

            //Verify names will not cause overwriting

            if (txt_format.Text != String.Empty && dups_lv1() == true)
            {
                return;
            }


            String is_overw = txt_path_main.Text + "\\" + Path.GetFileNameWithoutExtension(listView1.Items[0].Text) + "." + txt_format.Text;

            if (is_overw == listView1.Items[0].Text && chk_suffix.Checked == false)
            {
                if (chk_overw.CheckState == CheckState.Unchecked)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.overw_not_en + " " + '\u0022' + FFBatch.Properties.Strings.ren_out + '\u0022' + " " + FFBatch.Properties.Strings.checkb, FFBatch.Properties.Strings.overw_not_all, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                if (chk_overw.CheckState == CheckState.Checked)
                {
                    var a = MessageBox.Show(FFBatch.Properties.Strings.overw_confirm, FFBatch.Properties.Strings.over_conf2, MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                    if (a == DialogResult.No)
                    {
                        return;
                    }
                }
            }

            //Check queued items
            if (warn_success_items == true)
            {
                //Boolean all_complete = true;
                Boolean has_complete = false;
                foreach (ListViewItem item in listView1.Items)
                {
                    if (item.SubItems[5].Text == FFBatch.Properties.Strings.success || item.SubItems[5].Text == FFBatch.Properties.Strings.replaced)
                    {
                        has_complete = true;
                        break;
                    }
                }
                if (has_complete == true)
                {
                    DialogResult a = MessageBox.Show(FFBatch.Properties.Strings.already_encoded + " " + '\u0022' + FFBatch.Properties.Strings.queued + '\u0022' + " " + FFBatch.Properties.Strings.reset_items + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.cont_any, FFBatch.Properties.Strings.some_q, MessageBoxButtons.YesNoCancel, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2);
                    if (a == DialogResult.Cancel || a == DialogResult.No) return;
                }
            }
            //End check queued items

            if (chk_overw.Checked == true && txt_path_main.Text != "." + "\\")
            {
                DialogResult a = MessageBox.Show(FFBatch.Properties.Strings.overw_out, FFBatch.Properties.Strings.out_warn, MessageBoxButtons.YesNoCancel, MessageBoxIcon.Question);
                if (a != DialogResult.Yes) return;
            }

            if (images_from_wiz == true)
            {
                Double t_to = Convert.ToDouble(img_dur_wiz);
                TimeSpan t1 = TimeSpan.FromSeconds((t_to));
                String tx_1 = string.Format("{0:D2}:{1:D2}:{2:D2}",
                    t1.Hours,
                    t1.Minutes,
                    t1.Seconds);
                foreach (ListViewItem ite in listView1.Items) ite.SubItems[3].Text = tx_1;
                images_from_wiz = false;
            }

            ListView list_proc = new ListView();
            foreach (ListViewItem item in listView1.Items)
            {
                list_proc.Items.Add((ListViewItem)item.Clone());
                item.SubItems[5].Text = FFBatch.Properties.Strings.queued;
                //item.UseItemStyleForSubItems = true;
                //item.BackColor = Color.White;
                //item.SubItems[5].BackColor = Color.White;
            }

            cancel_queue = false;
            Pg1.Value = 0;
            pic_no_errors.Visible = false;
            pic_warnings.Visible = false;
            pic_recording.Visible = false;
            Disable_Controls();

            btn_skip_main.Enabled = true;
            working = true;
            aborted = false;

            this.InvokeEx(f => f.btn_try_pr.Image = img_try.Images[1]);

            String hw_decode = String.Empty;

            //Detect network files
            ask_cache_net = true;
            Boolean cache_net = false;
            Boolean file_is_network1 = false;
            if (no_save_cache == false)
            {
                foreach (ListViewItem item in list_proc.Items)
                {
                    try
                    {
                        DriveInfo driveInfo = new DriveInfo(item.SubItems[1].Text + "\\" + item.Text);
                        if (driveInfo.DriveType == DriveType.Network)
                        {
                            file_is_network1 = true;
                            if (ask_cache_net == true && file_is_network1 == true)
                            {
                                ask_cache_net = false;
                                DialogResult a = MessageBox.Show(FFBatch.Properties.Strings.queue_net, FFBatch.Properties.Strings.net_cach, MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2);
                                cache_net = a == DialogResult.Yes;
                            }
                            break;
                        }
                    }
                    catch
                    {
                        file_is_network1 = item.Text.Substring(0, 1) == ("\\");
                        if (ask_cache_net == true && file_is_network1 == true)
                        {
                            ask_cache_net = false;
                            DialogResult a = MessageBox.Show(FFBatch.Properties.Strings.queue_net, FFBatch.Properties.Strings.net_cach, MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2);
                            cache_net = a == DialogResult.Yes;
                        }
                    }
                    //End detect network files
                }
            }
            else
            {
                cache_net = false;
            }

            if (cb_hwdecode.SelectedItem.ToString() != "none")
            {
                hw_decode = "-hwaccel " + cb_hwdecode.SelectedItem.ToString();
            }

            //Save selected hw decoder

            String path2 = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_hw_dcd.ini";
            String txt_hw_dcd = cb_hwdecode.SelectedItem.ToString();
            if (txt_hw_dcd != "none")
            {
                File.WriteAllText(path2, txt_hw_dcd);
            }
            else
            {
                if (File.Exists(path2)) File.Delete(path2);
            }

            //End save hw decoder

            // Fade validation
            fade_ok = true;
            check_fade();
            if (fade_ok == false)
            {
                Enable_Controls();
                return;
            }
            // END Fade validation

            Pg1.Maximum = listView1.Items.Count;
            //listView1.SelectedIndices.Clear();
            //listView1.Items[0].Selected = true;

            total_duration = 0;
            Double total_prog = 0;

            //Get total duration of files

            foreach (ListViewItem item in listView1.Items)
            {
                if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                {
                    total_duration = total_duration + TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds - TimeSpan.Parse(ss_time_input.Text).TotalSeconds;
                }
                else
                {
                    total_duration = total_duration + 0;
                }
            }

            Pg1.Minimum = 0;
            Pg1.Maximum = 100;

            lbl_elapsed.Text = FFBatch.Properties.Strings.time_elapsed + " " + "00h:00m:00s";

            String remain_time = "0";
            //End get total duration of files

            List<string> list_lines = new List<string>();
            List<string> list_successful = new List<string>();
            List<string> list_failed = new List<string>();
            process_glob.StartInfo.Arguments = String.Empty;

            time_n_tasks = 0;
            timer_tasks.Start();
            timer_est_size.Start();
            time_est_size = 0;
            String file = String.Empty;

            Boolean refresh_list = false;

            btn_add_files.Enabled = true;
            btn_add_folders.Enabled = true;
            chk_subfolders.Enabled = true;
            panel2.Enabled = true;
            chk_delete_source.Enabled = true;
            foreach (Control ct in panel2.Controls)
            {
                if (ct.Name != chk_delete_source.Name)
                {
                    this.InvokeEx(f => ct.Enabled = false);
                }
            }
            String f_in_color = "Black";
            String f_out_color = "Black";
            if (combo_vin_col.SelectedIndex == 1) f_in_color = "White";
            if (combo_vout_color.SelectedIndex == 1) f_out_color = "White";

            String in_color = ":color=" + f_in_color;
            String out_color = ":color=" + f_out_color;
            if (combo_vin_col.SelectedIndex == 2) in_color = ":alpha=1";
            if (combo_vout_color.SelectedIndex == 2) out_color = ":alpha=1";

            //Save session variables
            String save_path_queue = Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "saved_queue_temp.ffq";
            if (is_portable == true) save_path_queue = port_path + "saved_queue_temp.ffq";
            String lista_queue = String.Empty;
            String queue_params = txt_parameters.Text + Environment.NewLine;
            String queue_ext = lista_queue + txt_format.Text;
            String checkbox1_state = Environment.NewLine + checkBox1.CheckState.ToString();
            String chk_suffix_state = String.Empty;
            int warn_enc = 0;

            if (chk_suffix.CheckState == CheckState.Unchecked) chk_suffix_state = "Unchecked";
            else
            {
                chk_suffix_state = txt_suffix.Text;
            }
            String saved_path = txt_path_main.Text;
            errors_enc = 0;

            wc.DownloadProgressChanged += new DownloadProgressChangedEventHandler(ProgressChanged);
            wc.DownloadFileCompleted += new AsyncCompletedEventHandler(Extract);

            Decimal tot_frames2 = 0;

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;

                for (int list_index = 0; list_index < listView1.Items.Count; list_index++)
                {
                    System.Threading.Thread.Sleep(50); //Allow kill process to send cancel_queue

                    Double size_dur = 0;
                    Double file_size = 0;

                    listView1.Invoke(new MethodInvoker(delegate
                    {
                        file = listView1.Items[list_index].SubItems[1].Text + "\\" + listView1.Items[list_index].Text;
                        FileInfo fs = new FileInfo(file);
                        file_size = fs.Length;
                        try
                        {
                            size_dur = TimeSpan.Parse(listView1.Items[list_index].SubItems[3].Text).TotalSeconds;
                        }
                        catch { size_dur = 0; }
                    }));

                    if (cancel_queue)
                    {
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        this.InvokeEx(f => this.Text = "FFmpeg Batch AV Converter");
                        if (is_portable) this.InvokeEx(f => this.Text = "FFmpeg Batch AV Converter Portable");
                        working = false;
                        time_est_size = 0;
                        Enable_Controls();
                        MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.task_abort, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                        return;
                    }

                    // Average frames
                    int fframes = 0;
                    Decimal dec = 0;
                    try
                    {
                        String ff_frames = String.Empty;

                        Process get_frames = new Process();
                        get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "mediainfo.exe");
                        String ffprobe_frames = "--Output=" + '\u0022' + "Video;%FrameCount%" + '\u0022';
                        get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + file + '\u0022';
                        get_frames.StartInfo.RedirectStandardOutput = true;
                        get_frames.StartInfo.RedirectStandardError = true;
                        get_frames.StartInfo.UseShellExecute = false;
                        get_frames.StartInfo.CreateNoWindow = true;
                        get_frames.EnableRaisingEvents = true;
                        get_frames.Start();

                        ff_frames = get_frames.StandardOutput.ReadLine();
                        get_frames.WaitForExit();

                        if (get_frames.ExitCode == 0)
                        {
                            if (ff_frames != null)
                            {
                                dec = decimal.Parse(ff_frames);
                                if (dec.ToString().Substring(dec.ToString().Length - 1, 1) == "0") dec = dec / 10;
                            }
                            else
                            {
                                dec = 0;
                            }

                            get_frames.Dispose();
                            tot_frames2 = tot_frames2 + dec;
                        }
                    }
                    catch
                    {
                        dec = 0;
                    }

                    // End average frames

                    //Detect network files
                    Boolean file_is_network = false;
                    try
                    {
                        DriveInfo driveInfo = new DriveInfo(Path.GetDirectoryName(file));
                        file_is_network = driveInfo.DriveType == DriveType.Network;
                    }
                    catch
                    {
                        file_is_network = file.Substring(0, 1) == ("\\");
                    }
                    //End detect network files

                    this.InvokeEx(f => timer_est_size.Start());

                    String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");
                    String fullPath = file;

                    //Begin Shifting
                    String shifting = "";
                    if (chk_shift.Checked == true)
                    {
                        shifting = " -itsoffset " + Num_Shift.Value.ToString().Replace(",", ".") + " -i " + '\u0022' + file + '\u0022' + " -map 1:v -map 0:a ";
                    }
                    //End Shifting

                    //Begin fading and volume changing
                    String change_vol_fade = "";
                    if (chk_vol.Checked == true)
                    {
                        change_vol_fade = "-af " + '\u0022' + "volume=" + vol_ch.Value.ToString() + "dB " + '\u0022' + " ";
                    }

                    String fade_filter = String.Empty;
                    Decimal fade_frames = 0;

                    if (fade_v_in.CheckState == CheckState.Checked || fade_v_out.CheckState == CheckState.Checked)
                    {
                        String ff_frames = String.Empty;
                        Process get_frames = new Process();
                        get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
                        String ffprobe_frames = " " + '\u0022' + "--Inform=Video;%FrameRate%" + '\u0022';
                        get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + list_proc.Items[list_index].SubItems[1].Text + "\\" + list_proc.Items[list_index].Text + '\u0022';
                        get_frames.StartInfo.RedirectStandardOutput = true;
                        get_frames.StartInfo.RedirectStandardError = true;
                        get_frames.StartInfo.UseShellExecute = false;
                        get_frames.StartInfo.CreateNoWindow = true;
                        get_frames.EnableRaisingEvents = true;
                        get_frames.Start();

                        ff_frames = get_frames.StandardOutput.ReadLine();
                        get_frames.WaitForExit();

                        if (get_frames.ExitCode == 0)
                        {
                            if (ff_frames != null)
                            {
                                fade_frames = decimal.Parse(ff_frames) / 1000;
                            }
                        }
                        get_frames.Dispose();
                    }

                    if (fade_v_in.CheckState == CheckState.Checked && fade_v_out.CheckState == CheckState.Unchecked)
                    {
                        Decimal fff_in = Math.Round(num_v_in.Value * fade_frames, 0);
                        fade_filter = "-vf " + '\u0022' + "fade=in:0:" + fff_in.ToString() + in_color + '\u0022';
                    }

                    if (fade_v_in.CheckState == CheckState.Unchecked && fade_v_out.CheckState == CheckState.Checked)
                    {
                        Double dur_frames = TimeSpan.Parse(list_proc.Items[list_index].SubItems[3].Text).TotalSeconds * Convert.ToDouble(fade_frames);
                        Decimal fade_out_total = Math.Round(Convert.ToDecimal(dur_frames), 3, MidpointRounding.AwayFromZero);
                        Decimal fade_out_initial = Math.Round(fade_out_total - (num_v_out.Value * fade_frames), 0, MidpointRounding.AwayFromZero);
                        Decimal fff_out = Math.Round(num_v_out.Value * fade_frames, 0, MidpointRounding.AwayFromZero);

                        fade_filter = "-vf " + '\u0022' + "fade=out:" + fade_out_initial.ToString() + ":" + fff_out.ToString() + out_color + '\u0022';
                    }

                    if (fade_v_in.CheckState == CheckState.Checked && fade_v_out.CheckState == CheckState.Checked)
                    {
                        Decimal fff_in = Math.Round(num_v_in.Value * fade_frames, 0, MidpointRounding.AwayFromZero);
                        Double dur_frames = TimeSpan.Parse(list_proc.Items[list_index].SubItems[3].Text).TotalSeconds * Convert.ToDouble(fade_frames);
                        Decimal fade_out_total = Math.Round(Convert.ToDecimal(dur_frames), 3, MidpointRounding.AwayFromZero);
                        Decimal fade_out_initial = Math.Round(fade_out_total - (num_v_out.Value * fade_frames), 0, MidpointRounding.AwayFromZero);
                        Decimal fff_out = Math.Round(num_v_out.Value * fade_frames, 0, MidpointRounding.AwayFromZero);

                        fade_filter = "-vf " + '\u0022' + "fade=in:0:" + fff_in.ToString() + in_color + ", " + "fade=out:" + fade_out_initial.ToString() + ":" + fff_out.ToString() + out_color + '\u0022';
                    }

                    //Audio fading
                    if (fade_a_in.CheckState == CheckState.Checked && fade_a_out.CheckState == CheckState.Unchecked)
                    {
                        if (chk_vol.Checked == false)
                        {
                            change_vol_fade = "-af " + '\u0022' + "afade=t=in:ss=0:d=" + num_a_in.Value.ToString() + '\u0022';
                        }
                        else
                        {
                            change_vol_fade = "-af " + '\u0022' + "afade=t=in:ss=0:d=" + num_a_in.Value.ToString() + ", " + "volume=" + vol_ch.Value.ToString() + "dB " + '\u0022';
                        }
                    }

                    if (fade_a_in.CheckState == CheckState.Unchecked && fade_a_out.CheckState == CheckState.Checked)
                    {
                        Double af_out = TimeSpan.Parse(list_proc.Items[list_index].SubItems[3].Text).TotalSeconds - Convert.ToDouble(num_a_out.Value);
                        Decimal af_out_dec = Math.Round(Convert.ToDecimal(af_out), 0, MidpointRounding.AwayFromZero);
                        if (chk_vol.Checked == false)
                        {
                            change_vol_fade = "-af " + '\u0022' + "afade=t=out:st=" + af_out_dec + ":d=" + num_a_out.Value.ToString() + '\u0022';
                        }
                        else
                        {
                            change_vol_fade = "-af " + '\u0022' + "afade=t=out:st=" + af_out_dec + ":d=" + num_a_out.Value.ToString() + ", " + "volume=" + vol_ch.Value.ToString() + "dB " + '\u0022';
                        }
                    }
                    if (fade_a_in.CheckState == CheckState.Checked && fade_a_out.CheckState == CheckState.Checked)
                    {
                        Double af_out = TimeSpan.Parse(list_proc.Items[list_index].SubItems[3].Text).TotalSeconds - Convert.ToDouble(num_a_out.Value);
                        Decimal af_out_dec = Math.Round(Convert.ToDecimal(af_out), 0, MidpointRounding.AwayFromZero);

                        if (chk_vol.Checked == false)
                        {
                            change_vol_fade = "-af " + '\u0022' + "afade=t=in:ss=0:d=" + num_a_in.Value.ToString() + ", " + "afade=t=out:st=" + af_out_dec + ":d=" + num_a_out.Value.ToString() + '\u0022';
                        }
                        else
                        {
                            change_vol_fade = "-af " + '\u0022' + "afade=t=in:ss=0:d=" + num_a_in.Value.ToString() + ", " + "afade=t=out:st=" + af_out_dec + ":d=" + num_a_out.Value.ToString() + ", " + "volume=" + vol_ch.Value.ToString() + "dB " + '\u0022';
                        }
                    }
                    //End audio fading

                    //End fading

                    //End Change Volume

                    if (txt_path_main.Text.Contains(".\\"))
                    {
                        if (txt_path_main.Text != ".\\")
                            destino = file.Substring(0, fullPath.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
                        else
                        {
                            destino = Path.GetDirectoryName(file);
                        }
                    }
                    else
                    {
                        if (checkBox1.CheckState == CheckState.Checked)
                        {
                            String pre_dest = Path.GetDirectoryName(file);
                            destino = Path.Combine(txt_path_main.Text, pre_dest.Substring(3, pre_dest.Length - 3));
                        }
                        else
                        {
                            destino = txt_path_main.Text;
                        }
                    }

                    String pre_input_var = "";
                    if (txt_pre_input.Text != "")
                    {
                        pre_input_var = txt_pre_input.Text;
                    }

                    String pre_ss = "";
                    if (TimeSpan.Parse(ss_time_input.Text).TotalSeconds != 0)
                    {
                        pre_ss = " -ss " + ss_time_input.Text;
                    }

                    add_suffix = "";

                    if (chk_suffix.Checked == true && txt_suffix.Text != String.Empty)
                    {
                        add_suffix = txt_suffix.Text;
                    }

                    String ext_output1 = txt_format.Text;
                    if (txt_format.Text == String.Empty)
                    {
                        ext_output1 = Path.GetExtension(file);
                    }
                    else
                    {
                        ext_output1 = "." + txt_format.Text;
                    }
                    if (txt_format.Text == "nul") ext_output1 = "nul";

                    textbox_params = txt_parameters.Text;
                    String file2 = file;
                    while (textbox_params.Contains("%fn"))
                    {
                        if (textbox_params.Contains("%fn"))
                        {
                            textbox_params = textbox_params.Replace("%fn", Path.GetFileNameWithoutExtension(file));
                        }
                    }
                    while (textbox_params.Contains("%fp"))
                    {
                        if (textbox_params.Contains("%fp"))
                        {
                            textbox_params = textbox_params.Replace("%fp", Path.GetDirectoryName(file));
                        }
                    }

                    while (textbox_params.Contains("%fd"))
                    {
                        if (textbox_params.Contains("%fd"))
                        {
                            var path = Path.GetFullPath(file);
                            var dirName = Path.GetFileName(Path.GetDirectoryName(path));
                            textbox_params = textbox_params.Replace("%fd", dirName);
                        }
                    }

                    while (textbox_params.Contains("%1"))
                    {
                        if (textbox_params.Contains("%1"))
                        {
                            file2 = file2.Replace("\\", "\\\\\\\\");
                            file2 = file2.Replace(":", ":" + "\\\\");
                            textbox_params = textbox_params.Replace("%1", '\u0022' + file2 + '\u0022');
                        }
                    }

                    while (textbox_params.Contains("%2"))
                    {
                        if (textbox_params.Contains("%2"))
                        {
                            file2 = file2.Replace("\\", "\\\\\\\\");
                            file2 = file2.Replace(":", ":" + "\\\\");
                            textbox_params = textbox_params.Replace("%2", '\u0022' + Path.Combine(System.IO.Path.GetDirectoryName(file2), Path.GetFileNameWithoutExtension(file2)) + '\u0022');
                        }
                    }

                    //Monitor available space
                    FileInfo f_root2 = new FileInfo(destino);
                    try
                    {
                        DriveInfo dest_drive2 = new DriveInfo(f_root2.Directory.Root.FullName);

                        if (dest_drive2.AvailableFreeSpace <= 500000000)
                        {
                            DialogResult a = DialogResult.Cancel;

                            a = MessageBox.Show(Properties.Strings2.warn_sp, Properties.Strings2.low_sp + " (" + (dest_drive2.AvailableFreeSpace / 1000000).ToString() + "MB)", MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation);
                            if (a == DialogResult.Yes)
                            {
                                aborted = true;
                                this.InvokeEx(f => f.lbl_est_size.Text = "");
                                this.InvokeEx(f => f.lbl_bitrate.Text = "");
                                working = false;
                                Enable_Controls();
                                return;
                            }
                        }
                    }
                    catch { }

                    //End monitor available space

                    String AppParam = String.Empty;

                    String file_cache = String.Empty;
                    String current_out = destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + add_suffix + ext_output1;
                    Boolean to_overw = false;

                    if (file_is_network == true && cache_net == true)
                    {
                        this.InvokeEx(f => f.pg_adding.Style = ProgressBarStyle.Marquee);
                        try
                        {
                            if (Directory.Exists(Path.Combine(Path.GetTempPath(), "FFBatch_test")) == false) Directory.CreateDirectory(Path.Combine(Path.GetTempPath(), "FFBatch_test"));
                            {
                                file_to_copy = file;
                                cached = false;
                                cancel_cache = false;
                                this.InvokeEx(f => f.txt_add_remain.Enabled = true);
                                this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
                                this.InvokeEx(f => f.txt_add_remain.Visible = true);

                                if (os_save_cache == false)
                                {
                                    CopyCache();
                                    do
                                    {
                                        Thread.Sleep(750);
                                    }
                                    while (cached == false && cancel_cache == false);
                                }
                                else
                                {
                                    this.InvokeEx(f => this.Enabled = false);
                                    this.InvokeEx(f => f.txt_add_remain.Visible = true);
                                    if (File.Exists(Path.Combine(Path.GetTempPath(), "FFBatch_test", Path.GetFileName(file_to_copy))))
                                    {
                                        FileInfo fi = new FileInfo(Path.Combine(Path.GetTempPath(), "FFBatch_test", Path.GetFileName(file_to_copy)));
                                        FileInfo fi2 = new FileInfo(file_to_copy);
                                        if (fi.Length == fi2.Length)
                                        {
                                            cached = true;
                                            this.InvokeEx(f => this.Enabled = true);
                                            this.InvokeEx(f => f.txt_add_remain.Visible = false);
                                            cached = true;
                                        }
                                    }
                                    else
                                    {
                                        net_speed();
                                        FileSystem.CopyFile(file, Path.Combine(Path.GetTempPath(), "FFBatch_test", Path.GetFileName(file)), UIOption.AllDialogs, UICancelOption.ThrowException);
                                        this.InvokeEx(f => this.Enabled = true);
                                        this.InvokeEx(f => f.txt_add_remain.Visible = false);
                                        cached = true;
                                    }
                                }

                                if (cached == true && cancel_cache == false)
                                {
                                    cache_net = true;
                                    file_cache = Path.Combine(Path.GetTempPath(), "FFBatch_test", Path.GetFileName(file));
                                    AppParam = hw_decode + " " + pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + file_cache + '\u0022' + " " + shifting + " -y " + textbox_params + " " + fade_filter + " " + change_vol_fade + " " + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_cache) + add_suffix + ext_output1 + '\u0022' + " -hide_banner";
                                }
                                else
                                {
                                    AppParam = hw_decode + " " + pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + file + '\u0022' + " " + shifting + " -y " + textbox_params + " " + fade_filter + " " + change_vol_fade + " " + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + add_suffix + ext_output1 + '\u0022' + " -hide_banner";
                                    cache_net = false;
                                }
                                cancel_cache = false;
                            }
                        }
                        catch
                        {
                            this.InvokeEx(f => this.Enabled = true);
                            this.InvokeEx(f => f.txt_add_remain.Visible = false);
                            this.InvokeEx(f => f.btn_abort_all.Enabled = true);
                            this.InvokeEx(f => f.btn_skip_main.Enabled = true);
                            Thread.Sleep(250);
                            this.InvokeEx(f => f.pg_adding.Visible = false);
                            this.InvokeEx(f => f.LB_Wait.Visible = false);
                            this.InvokeEx(f => f.btn_cancel_add.Visible = false);
                            this.InvokeEx(f => f.txt_adding_p.Visible = false);
                            this.InvokeEx(f => f.txt_add_remain.Visible = false);
                            this.InvokeEx(f => f.txt_add_remain.Enabled = false);
                            this.InvokeEx(f => f.btn_pause.Enabled = true);
                            cache_net = false;
                            AppParam = hw_decode + " " + pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + file + '\u0022' + " " + shifting + " -y " + textbox_params + " " + fade_filter + " " + change_vol_fade + " " + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + add_suffix + ext_output1 + '\u0022' + " -hide_banner";
                            if (ext_output1 == "nul") AppParam = hw_decode + " " + pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + file + '\u0022' + " " + shifting + " " + textbox_params + " " + fade_filter + " " + change_vol_fade + " " + " -hide_banner";
                        }
                    }
                    else
                    {
                        AppParam = hw_decode + " " + pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + file + '\u0022' + " " + shifting + " -y " + textbox_params + " " + fade_filter + " " + change_vol_fade + " " + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + add_suffix + ext_output1 + '\u0022' + " -hide_banner";
                        if (ext_output1 == "nul") AppParam = hw_decode + " " + pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + file + '\u0022' + " " + shifting + " " + textbox_params + " " + fade_filter + " " + change_vol_fade + " " + " -hide_banner";
                    }

                    if (chk_overw.CheckState == CheckState.Checked)
                    {
                        if (current_out == file)
                        {
                            AppParam = hw_decode + " " + pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + file + '\u0022' + " " + shifting + " -y " + textbox_params + " " + fade_filter + " " + change_vol_fade + " " + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + "_fftemp" + add_suffix + ext_output1 + '\u0022' + " -hide_banner";
                            if (ext_output1 == "nul") AppParam = hw_decode + " " + pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + file + '\u0022' + " " + shifting + " " + textbox_params + " " + fade_filter + " " + change_vol_fade + " " + " -hide_banner";
                            to_overw = true;
                        }
                    }
                    if (current_out == file && chk_overw.CheckState == CheckState.Unchecked)
                    {
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        working = false;
                        time_est_size = 0;
                        Enable_Controls();
                        MessageBox.Show(FFBatch.Properties.Strings.source_overw, FFBatch.Properties.Strings.overw_cant, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }

                    String second_path = "";
                    if (ext_output1 == "nul")
                    {
                        String[] split = txt_parameters.Text.Split(' ');
                        for (int i = 0; i < split.Length; i++)
                        {
                            if (split[i].Contains("\\") == true)
                            {
                                String pre_path = split[i].Replace("%fp", Path.GetDirectoryName(file)).Replace("%fn", Path.GetFileNameWithoutExtension(file)).Replace("%", "_");
                                second_path = Path.GetDirectoryName(pre_path.Replace('\u0022', ' '));

                                if (!Directory.Exists(second_path))
                                {
                                    try
                                    {
                                        Directory.CreateDirectory(second_path);
                                    }
                                    catch { }
                                }
                            }
                        }
                    }

                    if (!Directory.Exists(destino) && ext_output1 != "nul")
                    {
                        try { Directory.CreateDirectory(destino); }
                        catch { }
                    }

                    if (verbose_logs == false) AppParam = AppParam + " -loglevel warning -stats";
                    process_glob.StartInfo.FileName = ffm;

                    // Split by size

                    if (textbox_params.Contains(" (segment_size) "))
                    {
                        Double split_size = Convert.ToDouble(split_by_size);
                        String ff_frames = String.Empty;
                        Double ov_bitrate = 0;
                        ov_bitrate = file_size / size_dur;
                        Double bit_r = 0;
                        bit_r = ov_bitrate / 1000000;
                        bit_r = split_size / bit_r;
                        bit_r = Math.Round(bit_r, 2);
                        AppParam = AppParam.Replace(" (segment_size) ", " " + bit_r.ToString().Replace(",", ".") + " ");
                    }

                    // End split by size

                    process_glob.StartInfo.Arguments = AppParam;

                    valid_prog = false;
                    this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.processing);

                    process_glob.StartInfo.RedirectStandardOutput = true;
                    process_glob.StartInfo.StandardOutputEncoding = Encoding.UTF8;
                    process_glob.StartInfo.RedirectStandardInput = true;
                    process_glob.StartInfo.RedirectStandardError = true;
                    process_glob.StartInfo.StandardErrorEncoding = Encoding.UTF8;
                    process_glob.StartInfo.UseShellExecute = false;
                    process_glob.StartInfo.CreateNoWindow = true;
                    process_glob.EnableRaisingEvents = true;

                    if (aborted == false) process_glob.Start();

                    System.Threading.Thread.Sleep(50);
                    combo_prio.Invoke(new MethodInvoker(delegate
                    {
                        if (combo_prio.SelectedIndex != 2)
                        {
                            Change_mem_prio();
                        }
                    }));

                    check_space = 1;
                    DriveInfo dest_drive = null;
                    FileInfo f_root = new FileInfo(destino);
                    try
                    {
                        dest_drive = new DriveInfo(f_root.Directory.Root.FullName);
                        warn_space = true;
                    }
                    catch { warn_space = false; }

                    this.InvokeEx(f => validate_duration = listView1.Items[list_index].SubItems[3].Text);
                    if (validate_duration != FFBatch.Properties.Strings.n_a && validate_duration != "0:00:00" && validate_duration != "00:00:00" && validate_duration != FFBatch.Properties.Strings.pending)
                    {
                        valid_prog = true;
                    }

                    String err_txt = "";
                    Double interval = 0;
                    Decimal est_bitrate = 0;
                    Decimal est_size = 0;
                    this.InvokeEx(f => f.lbl_speed.Text = String.Empty);
                    Double sec_prog = 0;

                    if (images_from_wiz == true)
                    {
                        total_duration = Convert.ToDouble(img_dur_wiz);
                        valid_prog = true;
                    }
                    images_from_wiz = false;

                    while (!process_glob.StandardError.EndOfStream)
                    {
                        err_txt = process_glob.StandardError.ReadLine();
                        check_space++;
                        list_lines.Add(err_txt);
                        if (err_txt.Contains("time=") && err_txt.Contains("time=-") == false)
                        {
                            if (valid_prog == true)
                            {
                                this.InvokeEx(f => durat_n = TimeSpan.Parse(listView1.Items[list_index].SubItems[3].Text).TotalSeconds - TimeSpan.Parse(ss_time_input.Text).TotalSeconds);
                                int start_time_index = err_txt.IndexOf("time=") + 5;
                                sec_prog = TimeSpan.Parse(err_txt.Substring(start_time_index, 8)).TotalSeconds;

                                Double percent = (sec_prog * 100 / durat_n);

                                total_prog = total_prog + (sec_prog - interval);
                                interval = sec_prog;
                                int percent2 = Convert.ToInt32(percent);

                                Double percent_tot = (total_prog * 100 / total_duration);
                                int percent_tot_2 = Convert.ToInt32(percent_tot);

                                if (percent_tot_2 <= 100)
                                {
                                    this.InvokeEx(f => f.Pg1.Value = percent_tot_2);
                                    this.InvokeEx(f => f.Pg1.Refresh());

                                    if (Math.Round(percent_tot, 1).ToString().Contains(".") || Math.Round(percent_tot, 1).ToString().Contains(","))
                                    {
                                        this.InvokeEx(f => f.Pg1.Text = Math.Round(percent_tot, 1).ToString() + "%");
                                    }
                                    else
                                    {
                                        this.InvokeEx(f => f.Pg1.Text = Math.Round(percent_tot, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0" + "%");
                                    }

                                    this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, percent_tot, Pg1.Maximum));
                                }

                                if (percent2 <= 100)
                                {
                                    if (Math.Round(percent, 1).ToString().Contains(".") || Math.Round(percent, 1).ToString().Contains(","))
                                    {
                                        this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = Math.Round(percent, 1).ToString() + "%");
                                    }
                                    else
                                    {
                                        this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = Math.Round(percent, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0" + "%");
                                    }
                                }

                                if (cancel_queue == false)
                                {
                                    String fps_perf = String.Empty;
                                    //Estimated remaining time

                                    try
                                    {
                                        remain_time = err_txt.Substring(err_txt.LastIndexOf("speed=") + 6, err_txt.Length - err_txt.LastIndexOf("speed=") - 6);
                                        if (err_txt.Contains("fps="))
                                        {
                                            fps_perf = (err_txt.Substring(err_txt.IndexOf("fps=") + 4, 4)).TrimStart();
                                        }
                                        if (fps_perf.Length > 0) fps_perf = "  |  " + fps_perf.TrimEnd() + " fps";
                                        if (fps_perf.Contains("0.0"))
                                        {
                                            fps_perf = String.Empty;
                                        }

                                        if (time_est_size % 2 == 0)
                                        {
                                            String chk_0 = (FFBatch.Properties.Strings.speed + " " + remain_time).TrimEnd() + fps_perf;
                                            if (chk_0.Substring(chk_0.Length - 3, 3) == " 0x")
                                            {
                                                this.InvokeEx(f => f.lbl_speed.Text = "");
                                            }
                                            else this.InvokeEx(f => f.lbl_speed.Text = (FFBatch.Properties.Strings.speed + " " + remain_time).TrimEnd() + fps_perf);
                                        }
                                    }
                                    catch { }

                                    try
                                    {
                                        remain_time = remain_time.Replace("x", String.Empty);
                                        Double timing1 = 0;

                                        if (System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator == ",")
                                        {
                                            timing1 = Math.Round(Double.Parse(remain_time.Replace(".", ",")), 2);
                                        }
                                        else
                                        {
                                            timing1 = Math.Round(Double.Parse(remain_time), 2);
                                        }

                                        Decimal timing = (decimal)timing1;
                                        Decimal total_dur_dec = Convert.ToDecimal(total_duration);
                                        Decimal total_prog_dec = Convert.ToDecimal(total_prog);
                                        Decimal remain_secs = 0;
                                        if (timing > 0)
                                        {
                                            remain_secs = (decimal)(total_dur_dec - total_prog_dec) / timing;
                                        }

                                        if (remain_secs > 60)
                                        {
                                            remain_secs = remain_secs + 60;
                                        }

                                        String remain_from_secs = "";

                                        TimeSpan t = TimeSpan.FromSeconds(Convert.ToDouble(remain_secs));
                                        remain_from_secs = string.Format("{0:D2}h:{1:D2}",
                                           t.Hours,
                                          t.Minutes);

                                        if (remain_secs >= 43200)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Math.Round(remain_secs / 3600).ToString() + " " + FFBatch.Properties.Strings.hours);
                                            this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + Math.Round(remain_secs / 3600).ToString() + " " + FFBatch.Properties.Strings.hours);
                                        }

                                        if (remain_secs >= 3600 && remain_secs < 43200)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs + " " + FFBatch.Properties.Strings.minutes_abrev);
                                            this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + remain_from_secs + " " + FFBatch.Properties.Strings.minutes_abrev);
                                        }

                                        if (remain_secs < 3600 && remain_secs >= 600)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes);
                                            this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes_abrev);
                                        }
                                        if (remain_secs < 600 && remain_secs >= 120)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes);
                                            this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes_abrev);
                                        }

                                        if (remain_secs <= 59 && remain_secs != 0)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Convert.ToInt16(Math.Abs(remain_secs)) + " " + FFBatch.Properties.Strings.seconds);
                                            this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + Convert.ToInt16(Math.Abs(remain_secs)) + " s");
                                        }
                                        if (remain_secs == 0)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.about_finish);
                                            this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text);
                                        }
                                    }
                                    catch { }
                                }
                                //End remaining time

                                //Estimated size and bitrate

                                String read_size = String.Empty;
                                if (err_txt.Contains("size=") && (err_txt.Contains("N/A") == false) && (time_est_size % 3 == 0))
                                {
                                    int size_index = err_txt.IndexOf("size=") + 5;
                                    read_size = err_txt.Substring(size_index, 8);
                                    if (Convert.ToDecimal(sec_prog) != 0 & read_size.Contains(FFBatch.Properties.Strings.n_a) == false)
                                    {
                                        est_bitrate = (Math.Round(Convert.ToDecimal(read_size) * 8 / Convert.ToDecimal(sec_prog), 0));
                                    }
                                    else
                                    {
                                        est_bitrate = 0;
                                    }

                                    if (read_size.Contains(FFBatch.Properties.Strings.n_a) == false && Convert.ToDecimal(read_size) > 1 && time_n_tasks > 1)
                                    {
                                        if (est_bitrate < 9999)
                                        {
                                            if (est_bitrate > 48)
                                            {
                                                this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " " + est_bitrate + " " + "Kb/s");
                                            }
                                            else
                                            {
                                                this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " ");
                                            }
                                        }
                                        else
                                        {
                                            this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " " + (Math.Round(est_bitrate / 1000, 0)) + " " + "Mb/s");
                                        }
                                        //Estimated size
                                        est_size = Convert.ToDecimal(durat_n) * est_bitrate / 8;

                                        if (est_size > 1000000)
                                        {
                                            this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " " + (Math.Round(est_size / 1000000, 1)).ToString() + " " + "GB");
                                        }
                                        else
                                        {
                                            if (Math.Round(est_size / 1000, 0) > 0)
                                            {
                                                this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " " + (Math.Round(est_size / 1000, 0)).ToString() + " " + "MB");
                                            }
                                            else
                                            {
                                                this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " ");
                                            }
                                        }
                                    }

                                    this.InvokeEx(f => f.lbl_est_size.Refresh());
                                }
                            }
                        }
                        //Monitor available space

                        if (check_space % 30 == 0 && dest_drive.AvailableFreeSpace <= 500000000 && warn_space == true)
                        {
                            DialogResult a = DialogResult.Cancel;
                            process_glob.Suspend();
                            a = MessageBox.Show(Properties.Strings2.warn_sp, Properties.Strings2.low_sp + " (" + (dest_drive.AvailableFreeSpace / 1000000).ToString() + "MB)", MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation);
                            if (a == DialogResult.Yes)
                            {
                                process_glob.Resume();
                                Thread.Sleep(250);
                                aborted = true;
                                StreamWriter write_q = process_glob.StandardInput;
                                write_q.Write("q");

                                this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                                this.InvokeEx(f => this.Text = "FFmpeg Batch AV Converter");
                                if (is_portable == true) this.InvokeEx(f => this.Text = "FFmpeg Batch AV Converter Portable");
                                working = false;
                                time_est_size = 0;
                                Enable_Controls();
                                return;
                            }
                            warn_space = false;
                        }

                        //End monitor available space
                    }

                    process_glob.WaitForExit();
                    process_glob.StartInfo.Arguments = String.Empty;
                    timer_est_size.Stop();
                    time_est_size = 0;

                    this.InvokeEx(f => lbl_speed.Text = String.Empty);
                    this.InvokeEx(f => f.lbl_est_size.Text = String.Empty);
                    this.InvokeEx(f => f.lbl_bitrate.Text = String.Empty);

                    list_lines.Add("");
                    list_lines.Add("---------------------End of " + Path.GetFileName(file) + " log-------------------------------");
                    list_lines.Add("");

                    if (process_glob.ExitCode == 0)
                    {
                        list_successful.Add(file);
                        if (skipped == false)
                        {
                            this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.success);
                            if (chk_overw.CheckState == CheckState.Checked)
                            {
                                if (current_out == file)
                                {
                                    try
                                    {
                                        File.Delete(file);
                                        FileSystem.RenameFile(destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + "_fftemp" + add_suffix + ext_output1, Path.GetFileNameWithoutExtension(file) + add_suffix + ext_output1);
                                        this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.replaced);
                                        refresh_list = true;
                                    }
                                    catch
                                    {
                                        this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.not_replaced);
                                        warn_enc++;
                                    }
                                }
                            }
                            if (chk_delete_source.Checked == true && delete_one == true && delete_def == false)
                            {
                                try
                                {
                                    FileSystem.DeleteFile(file, UIOption.OnlyErrorDialogs, RecycleOption.SendToRecycleBin);
                                    this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.recycled);
                                }
                                catch
                                {
                                    this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.not_recycled);
                                    warn_enc++;
                                }
                            }
                            else if (chk_delete_source.Checked == true && delete_one == true && delete_def == true)
                            {
                                try
                                {
                                    FileInfo fs = new FileInfo(file);
                                    if (fs.IsReadOnly == true) fs.IsReadOnly = false;
                                    File.Delete(file);
                                    this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.deleted);
                                }
                                catch
                                {
                                    this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.not_deleted);
                                    warn_enc++;
                                }
                            }
                        }
                        else
                        {
                            this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.skipped);
                            total_prog = total_prog + durat_n - sec_prog;
                            try
                            {
                                File.Delete(current_out);
                            }
                            catch { }
                            skipped = false;
                        }
                    }
                    else
                    {
                        list_failed.Add(file);
                        this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.error);
                        errors_enc = errors_enc + 1;
                        if (aborted == true) this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.aborted);
                    }

                    //Save session
                    lista_queue = queue_params;
                    lista_queue = lista_queue + queue_ext;
                    lista_queue = lista_queue + checkbox1_state;
                    lista_queue = lista_queue + Environment.NewLine + chk_suffix_state;
                    lista_queue = lista_queue + Environment.NewLine + saved_path;
                    listView1.Invoke(new MethodInvoker(delegate
                    {
                        foreach (ListViewItem item in listView1.Items)
                        {
                            lista_queue = lista_queue + Environment.NewLine + item.SubItems[1].Text + "\\" + item.Text + " --0 " + item.SubItems[2].Text + " --1 " + item.SubItems[3].Text + " --2 " + item.SubItems[4].Text + " --3 " + item.SubItems[5].Text;
                        }
                    }));

                    if (file_is_network == true && cache_net == true && process_glob.ExitCode == 0)
                    {
                        Thread.Sleep(500);
                        try
                        {
                            File.Delete(file_cache.Replace("\\\\", "\\"));
                        }
                        catch { }
                    }
                    File.WriteAllText(save_path_queue, lista_queue);

                    //End save session

                    //Run on each file
                    int index = 0;
                    Boolean sh_check = false;
                    combo_shut.Invoke(new MethodInvoker(delegate
                    {
                        index = combo_shut.SelectedIndex;
                    }));
                    chkshut.Invoke(new MethodInvoker(delegate
                    {
                        if (chkshut.Checked == true) sh_check = true;
                    }));

                    if (index == 4 && cancel_queue == false && sh_check == true)
                    {
                        this.InvokeEx(f => this.Enabled = false);
                        Form14 frm_run = new Form14();
                        frm_run.txt_path.Text = run_command;
                        String dest_f = '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + add_suffix + ext_output1 + '\u0022';
                        if (ext_output1 == "nul") dest_f = '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + add_suffix + Path.GetExtension(file).Replace(".", "") + '\u0022';

                        frm_run.args = dest_f + " " + run_command_args;
                        frm_run.timer1.Interval = 100;
                        frm_run.ShowDialog();
                        this.InvokeEx(f => this.Enabled = true);
                        Enable_Controls();

                        if (frm_run.proc.ExitCode == 0)
                        {
                            this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = "OK & Run");
                            list_lines.Add(Properties.Strings2.ext_com_ok + " " + dest_f + Environment.NewLine + Environment.NewLine);
                        }
                        else
                        {
                            this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = "OK & Error");
                            list_lines.Add(Properties.Strings2.ext_com_err + " " + dest_f + Environment.NewLine + Environment.NewLine);
                        }
                        this.InvokeEx(f => this.TopMost = true);
                        this.InvokeEx(f => this.TopMost = false);
                    }

                    //End run on each file

                    String sep = System.Globalization.CultureInfo.CurrentUICulture.NumberFormat.NumberDecimalSeparator;
                    if (list_index == listView1.Items.Count - 1)
                    {
                        //Averages
                        if (time_n_tasks == 0) time_n_tasks = 1;
                        Double avg_enc = Math.Round((total_duration / time_n_tasks), 1);
                        Decimal deci = Convert.ToDecimal(time_n_tasks, CultureInfo.CurrentUICulture);

                        try
                        {
                            if (cancel_queue == false)
                            {
                                if (tot_frames2 != 0)
                                {
                                    list_lines.Add(Environment.NewLine + (FFBatch.Properties.Strings.avg_perf + " " + avg_enc.ToString() + "x" + "  |  " + Math.Round(tot_frames2 / time_n_tasks, 1)).ToString() + " fps");
                                    this.InvokeEx(f => f.lbl_speed.Text = ("AVG: " + avg_enc.ToString() + "x" + "  |  " + Math.Round(tot_frames2 / time_n_tasks, 1)).ToString() + " fps");
                                }
                                else
                                {
                                    list_lines.Add(Environment.NewLine + FFBatch.Properties.Strings.avg_perf + " " + avg_enc.ToString() + "x");
                                    this.InvokeEx(f => f.lbl_speed.Text = "AVG: " + avg_enc.ToString() + "x");
                                }
                            }
                        }
                        catch { }

                        //End averages

                        this.InvokeEx(f => f.Pg1.Value = 100);
                        this.InvokeEx(f => f.Pg1.Text = "100%");
                        this.InvokeEx(f => f.Pg1.Refresh());
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        this.InvokeEx(f => this.Text = "FFmpeg Batch AV Converter");
                        if (is_portable == true) this.InvokeEx(f => this.Text = "FFmpeg Batch AV Converter Portable");
                        try
                        {
                            File.Delete(save_path_queue);
                        }
                        catch { }

                        working = false;
                        timer_est_size.Stop();
                        time_est_size = 0;

                        //Save log
                        if (no_save_logs == false)
                        {
                            string[] array_err = list_lines.ToArray();
                            String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                            if (is_portable == true) path = port_path + "ff_batch_portable.log";

                            System.IO.StreamWriter SaveFile = new System.IO.StreamWriter(path);
                            SaveFile.WriteLine("FFmpeg log sesion: " + System.DateTime.Now);
                            SaveFile.WriteLine("-------------------------------");
                            foreach (String item in array_err)
                            {
                                SaveFile.WriteLine(item);
                            }
                            SaveFile.Close();

                            File.AppendAllText(path, "-----------------------");
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.end_log + Environment.NewLine);
                            File.AppendAllText(path, "-----------------------");
                            System.IO.FileInfo fileInfo = new System.IO.FileInfo(path);

                            var bytes = fileInfo.Length;

                            var kilobytes = (double)bytes / 1024;
                            var megabytes = kilobytes / 1024;
                            var gigabytes = megabytes / 1024;

                            //Format size view
                            String size = "";
                            String separator = ".";

                            if (bytes > 1000000000)
                            {
                                if (gigabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String gigas = gigabytes.ToString();
                                if (gigas.Length >= 5)
                                {
                                    gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                                    size = (gigas + " " + "GB");
                                }
                                else
                                {
                                    size = (gigas + " " + "GB");
                                }
                            }

                            if (bytes >= 1048576 && bytes <= 1000000000)
                            {
                                if (megabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }
                                String megas = megabytes.ToString();
                                if (megas.Length > 5)
                                {
                                    megas = megas.Substring(0, megas.LastIndexOf(separator));
                                    size = (megas + " " + "MB");
                                }
                                else
                                {
                                    size = (megas + " " + "MB");
                                }
                            }

                            if (bytes >= 1024 && bytes < 1048576)

                            {
                                if (kilobytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String kbs = kilobytes.ToString();
                                if (kbs.Length >= 5)
                                {
                                    kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                                    size = (kbs + " " + "KB");
                                }
                                else
                                {
                                    size = (kbs + " " + "KB");
                                }
                            }
                            if (bytes > -1 && bytes < 1024)
                            {
                                String bits = bytes.ToString();
                                size = (bits + " Bytes");
                            }

                            //End Format size view
                            timer_tasks.Stop();
                            TimeSpan t = TimeSpan.FromSeconds(time_n_tasks);
                            String tx_elapsed = string.Format("{0:D2}h:{1:D2}m:{2:D2}s",
                                t.Hours,
                                t.Minutes,
                                t.Seconds);
                            File.AppendAllText(path, Environment.NewLine);
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.total_time + " " + tx_elapsed);
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.log_size + " " + size);

                            //End save log
                        }

                        listView1.Invoke(new MethodInvoker(delegate
                        {
                            listView1.SelectedIndices.Clear();
                        }));
                        clean_ffb_test();

                        this.Invoke(new MethodInvoker(delegate
                        {
                            if (errors_enc == 0 && warn_enc == 0)
                            {
                                pic_no_errors.Visible = true;
                            }
                            else if (errors_enc == 0 && warn_enc > 0)
                            {
                                pic_no_errors.Visible = false;
                                pic_recording.Visible = false;
                                toolT002.SetToolTip(this.pic_warnings, FFBatch.Properties.Strings.there_w + " " + warn_enc.ToString() + " " + Properties.Strings2.warnings_last_s);
                                pic_warnings.Visible = true;
                            }
                            else if (errors_enc > 0)
                            {
                                pic_no_errors.Visible = false;
                                pic_recording.Visible = false;
                                toolT002.SetToolTip(this.pic_warnings, FFBatch.Properties.Strings.there_w + " " + errors_enc.ToString() + " " + FFBatch.Properties.Strings.errors_se);
                                pic_warnings.Visible = true;
                            }
                        }));

                        //Automatic shutdown check
                        if (chkshut.Checked && cancel_queue == false)
                        {
                            auto_shut();
                            return;
                        }
                        //End shutdown check
                        else
                        {
                            if (cancel_queue == false)
                            {
                                if (chk_delete_source.CheckState == CheckState.Checked && delete_one == false && delete_def == false)
                                {
                                    Disable_Controls();
                                    System.Threading.Thread.Sleep(500);

                                    Label prog_txt = new Label();
                                    this.InvokeEx(f => prog_txt.Parent = panel1);
                                    this.InvokeEx(f => prog_txt.Top = 95);
                                    this.InvokeEx(f => prog_txt.Left = 80);
                                    this.InvokeEx(f => prog_txt.Width = 250);
                                    this.InvokeEx(f => prog_txt.TabIndex = 1);
                                    this.InvokeEx(f => prog_txt.BackColor = panel1.BackColor);
                                    this.InvokeEx(f => prog_txt.BorderStyle = BorderStyle.None);
                                    this.InvokeEx(f => prog_txt.TextAlign = ContentAlignment.MiddleLeft);
                                    this.InvokeEx(f => prog_txt.BringToFront());
                                    this.InvokeEx(f => prog_txt.Text = FFBatch.Properties.Strings.to_recycle);

                                    ProgressBar pg_del = new ProgressBar();
                                    this.InvokeEx(f => pg_del.Parent = panel1);
                                    this.InvokeEx(f => pg_del.Top = 98);
                                    this.InvokeEx(f => pg_del.Left = 315);
                                    this.InvokeEx(f => pg_del.Width = 152);
                                    this.InvokeEx(f => pg_del.Height = 15);
                                    this.InvokeEx(f => pg_del.TabIndex = 0);
                                    this.InvokeEx(f => pg_del.BackColor = this.BackColor);
                                    this.InvokeEx(f => pg_del.Minimum = 0);
                                    this.InvokeEx(f => pg_del.BringToFront());
                                    this.InvokeEx(f => pg_del.Maximum = list_proc.Items.Count);
                                    this.InvokeEx(f => pg_del.Show());
                                    this.InvokeEx(f => pg_del.Refresh());
                                    int i = 0;
                                    int err = 0;

                                    foreach (String item in list_successful)
                                    {
                                        try
                                        {
                                            FileSystem.DeleteFile(item, UIOption.OnlyErrorDialogs, RecycleOption.SendToRecycleBin);
                                            this.InvokeEx(f => pg_del.Value = i);
                                            i = i + 1;
                                            listView1.Invoke(new MethodInvoker(delegate
                                            {
                                                foreach (ListViewItem item2 in listView1.Items)
                                                {
                                                    if (item2.Text == Path.GetFileName(item))
                                                    {
                                                        item2.SubItems[5].Text = FFBatch.Properties.Strings.recycled;
                                                    }
                                                }
                                            }));
                                        }
                                        catch
                                        {
                                            err = err + 1;
                                            list_failed.Add(item + " " + FFBatch.Properties.Strings2.not_deleted);
                                            listView1.Invoke(new MethodInvoker(delegate
                                            {
                                                foreach (ListViewItem item2 in listView1.Items)
                                                {
                                                    if (item2.Text == Path.GetFileName(item))
                                                    {
                                                        item2.SubItems[5].Text = FFBatch.Properties.Strings.not_recycled;
                                                    }
                                                }
                                            }));
                                        }

                                        this.InvokeEx(f => prog_txt.Text = FFBatch.Properties.Strings.to_recycle + i.ToString() + " " + FFBatch.Properties.Strings.of1 + " " + list_proc.Items.Count);
                                        this.InvokeEx(f => prog_txt.Refresh());
                                    }
                                    this.InvokeEx(f => prog_txt.Visible = false);
                                    this.InvokeEx(f => prog_txt.Dispose());
                                    this.InvokeEx(f => pg_del.Visible = false);
                                    this.InvokeEx(f => pg_del.Dispose());
                                    Enable_Controls();

                                    if (err > 0) MessageBox.Show(err.ToString() + " " + Properties.Strings.not_recycled2 + " " + Properties.Strings.check_log, FFBatch.Properties.Strings.not_recycled3, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);

                                    Boolean all_ok = true;
                                    foreach (ListViewItem item in list_proc.Items)
                                    {
                                        if (item.SubItems[5].Text != FFBatch.Properties.Strings.success)
                                        {
                                            all_ok = false;
                                            break;
                                        }
                                    }
                                    if (all_ok == true)
                                    {
                                        this.InvokeEx(f => f.btn_refresh.PerformClick());
                                    }
                                    if (list_failed.Count > 0)
                                    {
                                        String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                                        if (is_portable == true) path = port_path + "ff_batch_portable.log";

                                        File.AppendAllText(path, Environment.NewLine + Environment.NewLine + Properties.Strings2.source_not_deleted);
                                        File.AppendAllText(path, Environment.NewLine + "-------------------------------");
                                        foreach (String item in list_failed)
                                        {
                                            File.AppendAllText(path, Environment.NewLine + item);
                                        }
                                    }
                                }

                                if (chk_delete_source.CheckState == CheckState.Checked && delete_one == false && delete_def == true)
                                {
                                    Disable_Controls();
                                    System.Threading.Thread.Sleep(500);

                                    Label prog_txt = new Label();
                                    this.InvokeEx(f => prog_txt.Parent = panel1);
                                    this.InvokeEx(f => prog_txt.Top = 95);
                                    this.InvokeEx(f => prog_txt.Left = 80);
                                    this.InvokeEx(f => prog_txt.Width = 250);
                                    this.InvokeEx(f => prog_txt.TabIndex = 1);
                                    this.InvokeEx(f => prog_txt.BackColor = panel1.BackColor);
                                    this.InvokeEx(f => prog_txt.BorderStyle = BorderStyle.None);
                                    this.InvokeEx(f => prog_txt.TextAlign = ContentAlignment.MiddleLeft);
                                    this.InvokeEx(f => prog_txt.BringToFront());
                                    this.InvokeEx(f => prog_txt.Text = Properties.Strings2.deleting_proc);

                                    ProgressBar pg_del = new ProgressBar();
                                    this.InvokeEx(f => pg_del.Parent = panel1);
                                    this.InvokeEx(f => pg_del.Top = 98);
                                    this.InvokeEx(f => pg_del.Left = 315);
                                    this.InvokeEx(f => pg_del.Width = 152);
                                    this.InvokeEx(f => pg_del.Height = 15);
                                    this.InvokeEx(f => pg_del.TabIndex = 0);
                                    this.InvokeEx(f => pg_del.BackColor = this.BackColor);
                                    this.InvokeEx(f => pg_del.Minimum = 0);
                                    this.InvokeEx(f => pg_del.BringToFront());
                                    this.InvokeEx(f => pg_del.Maximum = list_proc.Items.Count);
                                    this.InvokeEx(f => pg_del.Show());
                                    this.InvokeEx(f => pg_del.Refresh());
                                    int i = 0;
                                    int err = 0;

                                    foreach (String item in list_successful)
                                    {
                                        try
                                        {
                                            FileInfo fs = new FileInfo(item);
                                            if (fs.IsReadOnly == true) fs.IsReadOnly = false;
                                            File.Delete(item);
                                            this.InvokeEx(f => pg_del.Value = i);
                                            i = i + 1;
                                            listView1.Invoke(new MethodInvoker(delegate
                                            {
                                                foreach (ListViewItem item2 in listView1.Items)
                                                {
                                                    if (item2.Text == Path.GetFileName(item))
                                                    {
                                                        item2.SubItems[5].Text = FFBatch.Properties.Strings.deleted;
                                                    }
                                                }
                                            }));
                                        }
                                        catch
                                        {
                                            err = err + 1;
                                            list_failed.Add(item + " " + FFBatch.Properties.Strings2.not_deleted);
                                            listView1.Invoke(new MethodInvoker(delegate
                                            {
                                                foreach (ListViewItem item2 in listView1.Items)
                                                {
                                                    if (item2.Text == Path.GetFileName(item))
                                                    {
                                                        item2.SubItems[5].Text = FFBatch.Properties.Strings.not_deleted;
                                                    }
                                                }
                                            }));
                                        }

                                        this.InvokeEx(f => prog_txt.Text = Properties.Strings2.deleting_sourc + " " + i.ToString() + " " + FFBatch.Properties.Strings.of1 + " " + list_proc.Items.Count);
                                        this.InvokeEx(f => prog_txt.Refresh());
                                    }
                                    this.InvokeEx(f => prog_txt.Visible = false);
                                    this.InvokeEx(f => prog_txt.Dispose());
                                    this.InvokeEx(f => pg_del.Visible = false);
                                    this.InvokeEx(f => pg_del.Dispose());
                                    Enable_Controls();

                                    if (err > 0) MessageBox.Show(err.ToString() + " " + Properties.Strings.not_recycled2 + " " + Properties.Strings.check_log, FFBatch.Properties.Strings.not_recycled3, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);

                                    Boolean all_ok = true;
                                    foreach (ListViewItem item in list_proc.Items)
                                    {
                                        if (item.SubItems[5].Text != FFBatch.Properties.Strings.success)
                                        {
                                            all_ok = false;
                                            break;
                                        }
                                    }
                                    if (all_ok == true)
                                    {
                                        this.InvokeEx(f => f.btn_refresh.PerformClick());
                                    }
                                    if (list_failed.Count > 0)
                                    {
                                        String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                                        if (is_portable == true) path = port_path + "ff_batch_portable.log";

                                        File.AppendAllText(path, Environment.NewLine + Environment.NewLine + Properties.Strings2.source_not_deleted);
                                        File.AppendAllText(path, Environment.NewLine + "-------------------------------");
                                        foreach (String item in list_failed)
                                        {
                                            File.AppendAllText(path, Environment.NewLine + item);
                                        }
                                    }
                                }

                                if (errors_enc == 0 && play_on_end)
                                {
                                    play_end();
                                }
                                else if (play_on_end) System.Media.SystemSounds.Asterisk.Play();

                                if (Form.ActiveForm == null)
                                {
                                    if (errors_enc == 0 && warn_enc == 0)
                                    {
                                        notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.enc_comp;
                                        notifyIcon1.BalloonTipIcon = ToolTipIcon.Info;
                                        notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.enc_comp2;
                                        notifyIcon1.ShowBalloonTip(0);
                                    }
                                    else if (errors_enc > 0)
                                    {
                                        notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.enc_comp3 + " " + errors_enc.ToString() + " " + FFBatch.Properties.Strings.errors1;
                                        notifyIcon1.BalloonTipIcon = ToolTipIcon.Warning;
                                        notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.enc_comp2;
                                        notifyIcon1.ShowBalloonTip(0);
                                    }
                                    else if (errors_enc == 0 && warn_enc > 0)
                                    {
                                        notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.enc_comp3 + " " + warn_enc.ToString() + " " + "warning(s).";
                                        notifyIcon1.BalloonTipIcon = ToolTipIcon.Warning;
                                        notifyIcon1.BalloonTipTitle = Properties.Strings.enc_comp2 + " - " + Properties.Strings.warn1;
                                        notifyIcon1.ShowBalloonTip(0);
                                    }
                                }

                                if (chk_open_compl.Checked)
                                {
                                    if (Directory.Exists(second_path) && Directory.GetFiles(second_path).Length != 0 && ext_output1 == "nul")
                                    {
                                        Process open_processed = new Process();
                                        open_processed.StartInfo.FileName = "explorer.exe";
                                        open_processed.StartInfo.Arguments = '\u0022' + second_path + '\u0022';
                                        open_processed.Start();
                                    }
                                    if (Directory.Exists(destino) && Directory.GetFiles(destino).Length != 0 && ext_output1 != "nul")
                                    {
                                        Process open_processed = new Process();
                                        open_processed.StartInfo.FileName = "explorer.exe";
                                        open_processed.StartInfo.Arguments = '\u0022' + destino + '\u0022';
                                        open_processed.Start();
                                    }
                                    else if (Directory.Exists(destino))
                                    {
                                        try { System.IO.Directory.Delete(destino); }
                                        catch { }
                                    }
                                }
                            }
                            else
                            {
                                this.InvokeEx(f => f.Pg1.Text = "100%");
                                this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.aborted, MessageBoxButtons.OK, MessageBoxIcon.Error));
                            }
                        }
                    }
                }

                this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                Enable_Controls();
            }).Start();
        }

        private void auto_shut()
        {
            int index = 0;
            combo_shut.Invoke(new MethodInvoker(delegate
            {
                index = combo_shut.SelectedIndex;
            }));

            if (index < 3)
            {
                Disable_Controls();
                disable_abort_btn();
                this.InvokeEx(f => f.chkshut.Enabled = false);
                this.InvokeEx(f => f.btn_pause.Enabled = false);
                this.InvokeEx(f => f.Timer_apaga.Start());
                this.InvokeEx(f => f.TopMost = true);
                this.InvokeEx(f => f.TB1.Enabled = true);
                this.InvokeEx(f => f.TB1.Visible = true);
                this.InvokeEx(f => f.btn_cancel_shut.Enabled = true);
                this.InvokeEx(f => f.btn_cancel_shut.Visible = true);
                this.InvokeEx(f => f.btn_abort_all.Enabled = false);
                this.InvokeEx(f => f.TB1.Text = Properties.Strings2.computer_will + " " + shut_type + " " + Properties.Strings2.in_60);
                this.InvokeEx(f => f.btn_cancel_shut.Text = Properties.Strings2.press_c + " " + shut_type);
                notifyIcon1.BalloonTipText = Properties.Strings2.computer_will + " " + shut_type + " " + Properties.Strings2.in_60;
                notifyIcon1.BalloonTipIcon = ToolTipIcon.Warning;
                notifyIcon1.BalloonTipTitle = "FFmpeg Batch AV Converter";
                notifyIcon1.ShowBalloonTip(0);
            }
            else if (index == 3)
            {
                this.InvokeEx(f => this.Enabled = false);
                Form14 frm_run = new Form14();
                frm_run.txt_path.Text = run_command;
                frm_run.args = run_command_args;
                frm_run.timer1.Interval = 1000;
                frm_run.ShowDialog();
                this.InvokeEx(f => this.Enabled = true);
                Enable_Controls();
            }
        }

        private void start_multiple()
        {
            cancel_queue = false;
            notifyIcon1.Visible = true;
            pic_no_errors.Visible = false;
            pic_warnings.Visible = false;
            pic_recording.Visible = false;
            errors_enc = 0;
            lbl_multip.Text = String.Empty;
            //Validated list, start processing
            if ((fade_v_in.Checked == true && num_v_in.Value == 0) || (fade_v_out.Checked == true && num_v_out.Value == 0) || (fade_a_in.Checked == true && num_a_in.Value == 0) || (fade_a_out.Checked == true && num_a_out.Value == 0))
            {
                MessageBox.Show(FFBatch.Properties.Strings.fading_zero, FFBatch.Properties.Strings.fading_zero2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + "00h:00m:00s";

            if (listView1.SelectedIndices.Count == 0)
            {
                listView1.Items[0].Selected = true;
                listView1.Items[0].Focused = true;
                listView1.Focus();
            }

            Boolean pr2_ok = false;
            foreach (String item in tried_params)
            {
                if (item == multi_pr1)
                {
                    tried_ok = true;
                    break;
                }
            }

            if (tried_ok == true)
            {
                foreach (String item in tried_params)
                {
                    if (item == (multi_pr2))
                    {
                        pr2_ok = true;
                        break;
                    }
                }
                if (pr2_ok != true) tried_ok = false;
            }

            if (tried_ok == true && multi_pr3.Length == 0)
            {
                foreach (String item in tried_params)
                {
                    if (item == (multi_pr2))
                    {
                        tried_ok = true;
                        break;
                    }
                }
            }

            if (tried_ok == false)
            {
                try
                {
                    BG_Try_multi.RunWorkerAsync();
                }
                catch
                {
                    tried_ok = true;
                }

                return;
            }
            tried_ok = false;

            //Remove test file/folder

            String file_prueba = "";
            String sel_test = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
            file_prueba = sel_test;
            String destino = Path.Combine(Path.GetTempPath(), "\\" + "FFBatch_test");
            String borrar = destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + txt_format.Text;

            if (File.Exists(borrar))
            {
                try
                {
                    File.Delete(borrar);
                }
                catch { }
            }

            if (Directory.Exists(destino) && Directory.GetFiles(destino).Length == 0)
            {
                System.IO.Directory.Delete(destino);
            }

            //END Remove test file/folder

            //Pending duration

            if (dur_ok == false)
            {
                list_pending_dur.Items.Clear();
                foreach (ListViewItem item in listView1.Items)
                {
                    list_pending_dur.Items.Add((ListViewItem)item.Clone());
                }
                BG_Dur.RunWorkerAsync();
                return;
            }

            //Check queued items

            if (warn_success_items == true)
            {
                Boolean no_queued = true;
                Boolean has_complete = false;
                foreach (ListViewItem item in listView1.Items)
                {
                    if (item.SubItems[5].Text == FFBatch.Properties.Strings.queued)
                    {
                        no_queued = false;
                    }
                    else if (item.SubItems[5].Text == FFBatch.Properties.Strings.success || item.SubItems[5].Text == FFBatch.Properties.Strings.replaced)
                    {
                        has_complete = true;
                    }
                }

                if (no_queued == true && listView1.Items.Count > 1)
                {
                    var a = MessageBox.Show(FFBatch.Properties.Strings.items_q + " " + '\u0022' + FFBatch.Properties.Strings.queued + '\u0022' + ". " + FFBatch.Properties.Strings.all_files + " " + FFBatch.Properties.Strings.already_proc, FFBatch.Properties.Strings.not_queued, MessageBoxButtons.OKCancel, MessageBoxIcon.Question);
                    if (a == DialogResult.Cancel) return;
                }

                else if (no_queued == false && has_complete == true)
                {
                    var a = MessageBox.Show(FFBatch.Properties.Strings.already_encoded + " " + '\u0022' + FFBatch.Properties.Strings.queued + '\u0022' + FFBatch.Properties.Strings.continu, FFBatch.Properties.Strings.some_q, MessageBoxButtons.OKCancel, MessageBoxIcon.Question);
                    if (a == DialogResult.Cancel) return;
                }
                //End check queued items
            }

            cancel_queue = false;
            Pg1.Value = 0;
            //pg_current.Value = 0;
            Disable_Controls();

            btn_skip_main.Enabled = true;
            //textBox4.Text = "0%";
            working = true;
            runnin_n_presets = true;

            ListView list_proc = new ListView();
            foreach (ListViewItem item in listView1.Items)
            {
                list_proc.Items.Add((ListViewItem)item.Clone());
                item.SubItems[5].Text = FFBatch.Properties.Strings.queued;
                item.BackColor = Color.White;
            }
            String hw_decode = String.Empty;
            if (cb_hwdecode.SelectedItem.ToString() != "none")
            {
                hw_decode = "-hwaccel " + cb_hwdecode.SelectedItem.ToString();
            }

            //Save selected hw decoder

            String path2 = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_hw_dcd.ini";
            String txt_hw_dcd = cb_hwdecode.SelectedItem.ToString();
            if (txt_hw_dcd != "none")
            {
                File.WriteAllText(path2, txt_hw_dcd);
            }
            else
            {
                if (File.Exists(path2)) File.Delete(path2);
            }

            //End save hw decoder

            // Fade validation
            fade_ok = true;
            check_fade();
            if (fade_ok == false)
            {
                Enable_Controls();
                return;
            }
            // END Fade validation

            Pg1.Maximum = listView1.Items.Count;
            listView1.SelectedIndices.Clear();

            total_duration = 0;
            Double total_prog = 0;

            //Get total duration of files

            foreach (ListViewItem item in listView1.Items)
            {
                if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                {
                    total_duration = total_duration + TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds - TimeSpan.Parse(ss_time_input.Text).TotalSeconds;
                }
                else
                {
                    total_duration = total_duration + 0;
                }
            }

            if (n_multi_presets == 2) total_duration = total_duration * 2;
            else if (n_multi_presets == 3) total_duration = total_duration * 3;

            Pg1.Minimum = 0;
            Pg1.Maximum = 100;
            String remain_time = "0";
            //End get total duration of files

            List<string> list_lines = new List<string>();
            process_glob.StartInfo.Arguments = String.Empty;

            time_n_tasks = 0;
            timer_tasks.Start();
            timer_est_size.Start();
            time_est_size = 0;
            String file = String.Empty;

            panel2.Enabled = true;
            chk_delete_source.Enabled = true;
            foreach (Control ct in panel2.Controls)
            {
                if (ct.Name != chk_delete_source.Name)
                {
                    this.InvokeEx(f => ct.Enabled = false);
                }
            }

            String f_in_color = combo_vin_col.SelectedIndex == 1 ? "White" : "Black";
            String f_out_color = combo_vout_color.SelectedIndex == 1 ? "White" : "Black";

            String in_color = combo_vin_col.SelectedIndex == 2 ? ":alpha=1" : ":color=" + f_in_color;
            String out_color = combo_vout_color.SelectedIndex == 2 ? ":alpha=1" : ":color=" + f_out_color;

            int preset_run = 1;
            int to_go = n_multi_presets;

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;

                for (int list_index = 0; list_index < listView1.Items.Count; list_index++)
                {
                    System.Threading.Thread.Sleep(50); //Allow kill process to send cancel_queue

                    listView1.Invoke(new MethodInvoker(delegate
                    {
                        file = listView1.Items[list_index].SubItems[1].Text + "\\" + listView1.Items[list_index].Text;
                    }));

                    if (cancel_queue == true)
                    {
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        working = false;
                        time_est_size = 0;
                        //this.InvokeEx(f => f.button2.Enabled = true);
                        Enable_Controls();
                        MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.task_abort, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                        return;
                    }

                    this.InvokeEx(f => timer_est_size.Start());

                    String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");
                    String fullPath = file;

                    //Begin Shifting
                    String shifting = "";
                    if (chk_shift.Checked == true)
                    {
                        shifting = " -itsoffset " + Num_Shift.Value.ToString().Replace(",", ".") + " -i " + '\u0022' + file + '\u0022' + " -map 1:v -map 0:a ";
                    }
                    //End Shifting

                    //Begin fading and volume changing
                    String change_vol_fade = "";
                    if (chk_vol.Checked == true)
                    {
                        change_vol_fade = "-af " + '\u0022' + "volume=" + vol_ch.Value.ToString() + "dB " + '\u0022' + " ";
                    }

                    String fade_filter = String.Empty;
                    Decimal fade_frames = 0;

                    if (fade_v_in.CheckState == CheckState.Checked || fade_v_out.CheckState == CheckState.Checked)
                    {
                        String ff_frames = String.Empty;
                        Process get_frames = new Process();
                        get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
                        String ffprobe_frames = " " + '\u0022' + "--Inform=Video;%FrameRate%" + '\u0022';
                        get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + list_proc.Items[list_index].SubItems[1].Text + "\\" + list_proc.Items[list_index].Text + '\u0022';
                        get_frames.StartInfo.RedirectStandardOutput = true;
                        get_frames.StartInfo.RedirectStandardError = true;
                        get_frames.StartInfo.UseShellExecute = false;
                        get_frames.StartInfo.CreateNoWindow = true;
                        get_frames.EnableRaisingEvents = true;
                        get_frames.Start();

                        ff_frames = get_frames.StandardOutput.ReadLine();
                        get_frames.WaitForExit();

                        if (get_frames.ExitCode == 0 && ff_frames != null)
                        {
                            fade_frames = decimal.Parse(ff_frames) / 1000;
                        }
                        get_frames.Dispose();
                    }

                    if (fade_v_in.CheckState == CheckState.Checked && fade_v_out.CheckState == CheckState.Unchecked)
                    {
                        Decimal fff_in = Math.Round(num_v_in.Value * fade_frames, 0);
                        fade_filter = "-vf " + '\u0022' + "fade=in:0:" + fff_in.ToString() + in_color + '\u0022';
                    }

                    if (fade_v_in.CheckState == CheckState.Unchecked && fade_v_out.CheckState == CheckState.Checked)
                    {
                        Double dur_frames = TimeSpan.Parse(list_proc.Items[list_index].SubItems[3].Text).TotalSeconds * Convert.ToDouble(fade_frames);
                        Decimal fade_out_total = Math.Round(Convert.ToDecimal(dur_frames), 3, MidpointRounding.AwayFromZero);
                        Decimal fade_out_initial = Math.Round(fade_out_total - (num_v_out.Value * fade_frames), 0, MidpointRounding.AwayFromZero);
                        Decimal fff_out = Math.Round(num_v_out.Value * fade_frames, 0, MidpointRounding.AwayFromZero);

                        fade_filter = "-vf " + '\u0022' + "fade=out:" + fade_out_initial.ToString() + ":" + fff_out.ToString() + out_color + '\u0022';
                    }

                    if (fade_v_in.CheckState == CheckState.Checked && fade_v_out.CheckState == CheckState.Checked)
                    {
                        Decimal fff_in = Math.Round(num_v_in.Value * fade_frames, 0, MidpointRounding.AwayFromZero);
                        Double dur_frames = TimeSpan.Parse(list_proc.Items[list_index].SubItems[3].Text).TotalSeconds * Convert.ToDouble(fade_frames);
                        Decimal fade_out_total = Math.Round(Convert.ToDecimal(dur_frames), 3, MidpointRounding.AwayFromZero);
                        Decimal fade_out_initial = Math.Round(fade_out_total - (num_v_out.Value * fade_frames), 0, MidpointRounding.AwayFromZero);
                        Decimal fff_out = Math.Round(num_v_out.Value * fade_frames, 0, MidpointRounding.AwayFromZero);

                        fade_filter = "-vf " + '\u0022' + "fade=in:0:" + fff_in.ToString() + in_color + ", " + "fade=out:" + fade_out_initial.ToString() + ":" + fff_out.ToString() + out_color + '\u0022';
                    }

                    //Audio fading
                    if (fade_a_in.CheckState == CheckState.Checked && fade_a_out.CheckState == CheckState.Unchecked)
                    {
                        if (chk_vol.Checked == false)
                        {
                            change_vol_fade = "-af " + '\u0022' + "afade=t=in:ss=0:d=" + num_a_in.Value.ToString() + '\u0022';
                        }
                        else
                        {
                            change_vol_fade = "-af " + '\u0022' + "afade=t=in:ss=0:d=" + num_a_in.Value.ToString() + ", " + "volume=" + vol_ch.Value.ToString() + "dB " + '\u0022';
                        }
                    }

                    if (fade_a_in.CheckState == CheckState.Unchecked && fade_a_out.CheckState == CheckState.Checked)
                    {
                        Double af_out = TimeSpan.Parse(list_proc.Items[list_index].SubItems[3].Text).TotalSeconds - Convert.ToDouble(num_a_out.Value);
                        Decimal af_out_dec = Math.Round(Convert.ToDecimal(af_out), 0, MidpointRounding.AwayFromZero);
                        if (chk_vol.Checked == false)
                        {
                            change_vol_fade = "-af " + '\u0022' + "afade=t=out:st=" + af_out_dec + ":d=" + num_a_out.Value.ToString() + '\u0022';
                        }
                        else
                        {
                            change_vol_fade = "-af " + '\u0022' + "afade=t=out:st=" + af_out_dec + ":d=" + num_a_out.Value.ToString() + ", " + "volume=" + vol_ch.Value.ToString() + "dB " + '\u0022';
                        }
                    }
                    if (fade_a_in.CheckState == CheckState.Checked && fade_a_out.CheckState == CheckState.Checked)
                    {
                        Double af_out = TimeSpan.Parse(list_proc.Items[list_index].SubItems[3].Text).TotalSeconds - Convert.ToDouble(num_a_out.Value);
                        Decimal af_out_dec = Math.Round(Convert.ToDecimal(af_out), 0, MidpointRounding.AwayFromZero);

                        if (chk_vol.Checked == false)
                        {
                            change_vol_fade = "-af " + '\u0022' + "afade=t=in:ss=0:d=" + num_a_in.Value.ToString() + ", " + "afade=t=out:st=" + af_out_dec + ":d=" + num_a_out.Value.ToString() + '\u0022';
                        }
                        else
                        {
                            change_vol_fade = "-af " + '\u0022' + "afade=t=in:ss=0:d=" + num_a_in.Value.ToString() + ", " + "afade=t=out:st=" + af_out_dec + ":d=" + num_a_out.Value.ToString() + ", " + "volume=" + vol_ch.Value.ToString() + "dB " + '\u0022';
                        }
                    }
                    //End audio fading

                    //End fading

                    //End Change Volume

                    if (txt_path_main.Text.Contains(".\\"))
                    {
                        if (txt_path_main.Text != ".\\")
                            destino = file.Substring(0, fullPath.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
                        else
                        {
                            destino = Path.GetDirectoryName(file);
                        }
                    }
                    else
                    {
                        if (checkBox1.CheckState == CheckState.Checked)
                        {
                            String pre_dest = Path.GetDirectoryName(file);
                            destino = Path.Combine(txt_path_main.Text, pre_dest.Substring(3, pre_dest.Length - 3));
                        }
                        else
                        {
                            destino = txt_path_main.Text;
                        }
                    }

                    String pre_input_var = "";
                    if (txt_pre_input.Text != "")
                    {
                        pre_input_var = txt_pre_input.Text;
                    }

                    String pre_ss = "";
                    if (TimeSpan.Parse(ss_time_input.Text).TotalSeconds != 0)
                    {
                        pre_ss = " -ss " + ss_time_input.Text;
                    }

                    add_suffix = "";

                    if (chk_suffix.Checked == true && txt_suffix.Text != String.Empty)
                    {
                        add_suffix = txt_suffix.Text;
                    }
                    String add_pr_suffix = String.Empty;
                    if (ren_multi == true)
                    {
                        add_pr_suffix = "_" + preset_run.ToString();
                    }

                    String ext_output1 = String.Empty;

                    if (preset_run == 1)
                    {
                        ext_output1 = multi_pr1_ext;
                        textbox_params = multi_pr1;
                    }
                    else if (preset_run == 2)
                    {
                        ext_output1 = multi_pr2_ext;
                        textbox_params = multi_pr2;
                    }
                    else if (preset_run == 3)
                    {
                        ext_output1 = multi_pr3_ext;
                        textbox_params = multi_pr3;
                    }
                    ext_output1 = "." + ext_output1;

                    String file2 = file;

                    if (textbox_params.Contains("%fn"))
                    {
                        textbox_params = textbox_params.Replace("%fn", Path.GetFileNameWithoutExtension(file));
                    }
                    if (textbox_params.Contains("%fp"))
                    {
                        textbox_params = textbox_params.Replace("%fp", Path.GetDirectoryName(file));
                    }
                    if (textbox_params.Contains("%fd"))
                    {
                        var path = Path.GetFullPath(file);
                        var dirName = Path.GetFileName(Path.GetDirectoryName(path));
                        textbox_params = textbox_params.Replace("%fd", dirName);
                    }

                    while (textbox_params.Contains("%1"))
                    {
                        if (textbox_params.Contains("%1"))
                        {
                            file2 = file2.Replace("\\", "\\\\\\\\");
                            file2 = file2.Replace(":", ":" + "\\\\");
                            textbox_params = textbox_params.Replace("%1", '\u0022' + file2 + '\u0022');
                        }
                    }

                    while (textbox_params.Contains("%2"))
                    {
                        if (textbox_params.Contains("%2"))
                        {
                            file2 = file2.Replace("\\", "\\\\\\\\");
                            file2 = file2.Replace(":", ":" + "\\\\");
                            textbox_params = textbox_params.Replace("%2", '\u0022' + Path.Combine(System.IO.Path.GetDirectoryName(file2), Path.GetFileNameWithoutExtension(file2)) + '\u0022');
                        }
                    }

                    String output_file = output_file = '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + add_suffix + add_pr_suffix + ext_output1 + '\u0022';

                    String AppParam = hw_decode + " " + pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + file + '\u0022' + " " + shifting + " -y " + textbox_params + " " + fade_filter + " " + change_vol_fade + " " + output_file;

                    if (!Directory.Exists(destino))
                    {
                        Directory.CreateDirectory(destino);
                    }

                    process_glob.StartInfo.FileName = ffm;
                    process_glob.StartInfo.Arguments = AppParam;

                    valid_prog = false;
                    this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.processing);
                    //this.InvokeEx(f => f.pg_current.Value = 0);
                    //this.InvokeEx(f => f.pg_current.Refresh());

                    process_glob.StartInfo.RedirectStandardOutput = true;
                    process_glob.StartInfo.RedirectStandardInput = true;
                    process_glob.StartInfo.RedirectStandardError = true;
                    process_glob.StartInfo.UseShellExecute = false;
                    process_glob.StartInfo.CreateNoWindow = true;
                    process_glob.EnableRaisingEvents = true;
                    process_glob.Start();

                    System.Threading.Thread.Sleep(50);
                    combo_prio.Invoke(new MethodInvoker(delegate
                    {
                        if (combo_prio.SelectedIndex != 2)
                        {
                            Change_mem_prio();
                        }
                    }));

                    this.InvokeEx(f => validate_duration = listView1.Items[list_index].SubItems[3].Text);
                    if (validate_duration != FFBatch.Properties.Strings.n_a && validate_duration != "0:00:00" && validate_duration != "00:00:00" && validate_duration != FFBatch.Properties.Strings.pending)
                    {
                        valid_prog = true;
                    }

                    String err_txt = "";
                    Double interval = 0;
                    Decimal est_bitrate = 0;
                    Decimal est_size = 0;
                    this.InvokeEx(f => durat_n = TimeSpan.Parse(listView1.Items[list_index].SubItems[3].Text).TotalSeconds - TimeSpan.Parse(ss_time_input.Text).TotalSeconds);

                    lbl_speed.Text = String.Empty;
                    Double sec_prog = 0;
                    this.InvokeEx(f => f.lbl_multip.Enabled = true);
                    this.InvokeEx(f => f.lbl_multip.Visible = true);
                    this.InvokeEx(f => f.lbl_multip.Text = Properties.Strings.Encoding + " " + "Preset" + " " + preset_run.ToString() + " " + FFBatch.Properties.Strings.of1 + " " + to_go.ToString());

                    while (!process_glob.StandardError.EndOfStream)
                    {
                        err_txt = process_glob.StandardError.ReadLine();
                        list_lines.Add(err_txt);

                        if (err_txt.Contains("time=") && err_txt.Contains("time=-") == false)
                        {
                            if (valid_prog == true)
                            {
                                int start_time_index = err_txt.IndexOf("time=") + 5;
                                sec_prog = TimeSpan.Parse(err_txt.Substring(start_time_index, 8)).TotalSeconds;

                                Double percent = (sec_prog * 100 / durat_n);

                                total_prog = total_prog + (sec_prog - interval);
                                interval = sec_prog;
                                int percent2 = Convert.ToInt32(percent);

                                Double percent_tot = (total_prog * 100 / total_duration);
                                int percent_tot_2 = Convert.ToInt32(percent_tot);

                                if (percent_tot_2 <= 100)
                                {
                                    this.InvokeEx(f => f.Pg1.Value = percent_tot_2);
                                    this.InvokeEx(f => f.Pg1.Refresh());

                                    this.InvokeEx(f => f.Pg1.Text = Math.Round(percent_tot, 1).ToString() + "%");
                                    this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, percent_tot, Pg1.Maximum));
                                }

                                if (percent2 <= 100)
                                {
                                    if (Math.Round(percent, 1).ToString().Contains(".") || Math.Round(percent, 1).ToString().Contains(","))
                                    {
                                        this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = Math.Round(percent, 1).ToString() + "%");
                                    }
                                    else
                                    {
                                        this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = Math.Round(percent, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0" + "%");
                                    }
                                }

                                if (cancel_queue == false)
                                {
                                    //Estimated remaining time

                                    remain_time = err_txt.Substring(err_txt.LastIndexOf("speed=") + 6, err_txt.Length - err_txt.LastIndexOf("speed=") - 6);
                                    if (time_est_size % 3 == 0) this.InvokeEx(f => f.lbl_speed.Text = FFBatch.Properties.Strings.speed + " " + remain_time);
                                    remain_time = remain_time.Replace("x", String.Empty);
                                    Double timing1 = 0;

                                    if (System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator == ",")
                                    {
                                        timing1 = Math.Round(Double.Parse(remain_time.Replace(".", ",")), 2);
                                    }
                                    else
                                    {
                                        timing1 = Math.Round(Double.Parse(remain_time), 2);
                                    }

                                    Decimal timing = (decimal)timing1;
                                    Decimal total_dur_dec = Convert.ToDecimal(total_duration);
                                    Decimal total_prog_dec = Convert.ToDecimal(total_prog);
                                    Decimal remain_secs = 0;

                                    if (timing > 0)
                                    {
                                        remain_secs = (decimal)(total_dur_dec - total_prog_dec) / timing;
                                    }

                                    if (remain_secs > 60)
                                    {
                                        remain_secs = remain_secs + 60;
                                    }

                                    String remain_from_secs = String.Empty;

                                    TimeSpan t = TimeSpan.FromSeconds(Convert.ToDouble(remain_secs));
                                    remain_from_secs = string.Format("{0:D2}h:{1:D2}", t.Hours, t.Minutes);

                                    if (remain_secs >= 43200)
                                    {
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Math.Round(remain_secs / 3600).ToString() + " " + FFBatch.Properties.Strings.hours);
                                    }

                                    if (remain_secs >= 3600 && remain_secs < 43200)
                                    {
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs + " " + FFBatch.Properties.Strings.minutes_abrev);
                                    }

                                    if (remain_secs < 3600 && remain_secs >= 600)
                                    {
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes);
                                    }

                                    if (remain_secs < 600 && remain_secs >= 120)
                                    {
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes);
                                    }

                                    if (remain_secs <= 59 && remain_secs != 0)
                                    {
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Convert.ToInt16(remain_secs) + " " + FFBatch.Properties.Strings.seconds);
                                    }

                                    if (remain_secs == 0)
                                    {
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.about_finish);
                                    }
                                }

                                //End remaining time

                                //Estimated size and bitrate

                                String read_size = String.Empty;
                                if (err_txt.Contains("size=") && (time_est_size % 3 == 0))
                                {
                                    int size_index = err_txt.IndexOf("size=") + 5;
                                    read_size = err_txt.Substring(size_index, 8);
                                    if (Convert.ToDecimal(sec_prog) != 0)
                                    {
                                        est_bitrate = (Math.Round(Convert.ToDecimal(read_size) * 8 / Convert.ToDecimal(sec_prog), 0));
                                    }
                                    else
                                    {
                                        est_bitrate = 0;
                                    }

                                    if (Convert.ToDecimal(read_size) > 1 && time_n_tasks > 1)
                                    {
                                        if (est_bitrate < 9999)
                                        {
                                            if (est_bitrate > 48)
                                            {
                                                this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " " + est_bitrate + " " + "Kb/s");
                                            }
                                            else
                                            {
                                                this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " ");
                                            }
                                        }
                                        else
                                        {
                                            this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " " + (Math.Round(est_bitrate / 1000, 0)) + " " + "Mb/s");
                                        }
                                        //Estimated size
                                        est_size = Convert.ToDecimal(durat_n) * est_bitrate / 8;

                                        if (est_size > 1000000)
                                        {
                                            this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " " + (Math.Round(est_size / 1000000, 1)).ToString() + " " + "GB");
                                        }
                                        else
                                        {
                                            if (Math.Round(est_size / 1000, 0) > 0)
                                            {
                                                this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " " + (Math.Round(est_size / 1000, 0)).ToString() + " " + "MB");
                                            }
                                            else
                                            {
                                                this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " ");
                                            }
                                        }
                                    }

                                    this.InvokeEx(f => f.lbl_est_size.Refresh());
                                }
                            }
                        }
                    }
                    process_glob.WaitForExit();
                    process_glob.StartInfo.Arguments = String.Empty;
                    timer_est_size.Stop();
                    time_est_size = 0;
                    this.InvokeEx(f => lbl_speed.Text = String.Empty);
                    this.InvokeEx(f => f.lbl_est_size.Text = String.Empty);
                    this.InvokeEx(f => f.lbl_bitrate.Text = String.Empty);
                    list_lines.Add("");
                    list_lines.Add("---------------------End of " + Path.GetFileName(file) + " log-------------------------------");
                    list_lines.Add("");

                    if (process_glob.ExitCode == 0)
                    {
                        if (skipped == false)
                        {
                            this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.success);
                            this.InvokeEx(f => f.listView1.Items[list_index].BackColor = listView1.BackColor);
                        }
                        else
                        {
                            this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.skipped);
                            total_prog = (total_prog + durat_n - sec_prog) / n_multi_presets;
                            skipped = false;
                        }
                        //this.InvokeEx(f => f.listView1.Items[list_index].EnsureVisible());
                    }
                    else
                    {
                        this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.error);
                        errors_enc = errors_enc + 1;
                        total_prog = total_prog + durat_n - sec_prog;
                    }

                    if (list_index == listView1.Items.Count - 1)
                    {
                        n_multi_presets = n_multi_presets - 1;
                        preset_run = preset_run + 1;
                        list_index = -1;
                    }
                    if (n_multi_presets == 0)
                    {
                        this.InvokeEx(f => f.lbl_multip.Visible = false);
                        runnin_n_presets = false;
                        list_index = listView1.Items.Count - 1;
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        this.InvokeEx(f => f.Pg1.Value = 100);
                        this.InvokeEx(f => f.Pg1.Text = "100%");
                        this.InvokeEx(f => f.Pg1.Refresh());
                        working = false;
                        timer_est_size.Stop();
                        time_est_size = 0;

                        if (no_save_logs == false)
                        {
                            //Save log
                            string[] array_err = list_lines.ToArray();
                            String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                            if (is_portable == true) path = port_path + "ff_batch_portable.log";

                            System.IO.StreamWriter SaveFile = new System.IO.StreamWriter(path);
                            SaveFile.WriteLine("FFmpeg log sesion: " + System.DateTime.Now);
                            SaveFile.WriteLine("-------------------------------");
                            foreach (String item in array_err)
                            {
                                SaveFile.WriteLine(item);
                            }
                            SaveFile.Close();

                            File.AppendAllText(path, "-----------------------");
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.end_log + Environment.NewLine);
                            File.AppendAllText(path, "-----------------------");
                            System.IO.FileInfo fileInfo = new System.IO.FileInfo(path);

                            var bytes = fileInfo.Length;

                            var kilobytes = (double)bytes / 1024;
                            var megabytes = kilobytes / 1024;
                            var gigabytes = megabytes / 1024;

                            //Format size view
                            String size = "";
                            String separator = ".";

                            if (bytes > 1000000000)
                            {
                                if (gigabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String gigas = gigabytes.ToString();
                                if (gigas.Length >= 5)
                                {
                                    gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                                    size = (gigas + " " + "GB");
                                }
                                else
                                {
                                    size = (gigas + " " + "GB");
                                }
                            }

                            if (bytes >= 1048576 && bytes <= 1000000000)
                            {
                                if (megabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }
                                String megas = megabytes.ToString();
                                if (megas.Length > 5)
                                {
                                    megas = megas.Substring(0, megas.LastIndexOf(separator));
                                    size = (megas + " " + "MB");
                                }
                                else
                                {
                                    size = (megas + " " + "MB");
                                }
                            }

                            if (bytes >= 1024 && bytes < 1048576)

                            {
                                if (kilobytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String kbs = kilobytes.ToString();
                                if (kbs.Length >= 5)
                                {
                                    kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                                    size = (kbs + " " + "KB");
                                }
                                else
                                {
                                    size = (kbs + " " + "KB");
                                }
                            }
                            if (bytes > -1 && bytes < 1024)
                            {
                                String bits = bytes.ToString();
                                size = (bits + " Bytes");
                            }

                            //End Format size view
                            timer_tasks.Stop();
                            TimeSpan t = TimeSpan.FromSeconds(time_n_tasks);
                            String tx_elapsed = string.Format("{0:D2}h:{1:D2}m:{2:D2}s",
                                t.Hours,
                                t.Minutes,
                                t.Seconds);
                            File.AppendAllText(path, Environment.NewLine);
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.total_time + " " + tx_elapsed);
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.log_size + " " + size);
                            //End save log
                        }

                        this.Invoke(new MethodInvoker(delegate
                        {
                            if (errors_enc == 0) pic_no_errors.Visible = true;
                            else
                            {
                                toolT002.RemoveAll();
                                pic_no_errors.Visible = false;
                                pic_recording.Visible = false;
                                toolT002.SetToolTip(this.pic_warnings, FFBatch.Properties.Strings.there_w + " " + errors_enc.ToString() + " " + FFBatch.Properties.Strings.errors_se);
                                pic_warnings.Visible = true;
                            }
                        }));

                        //Automatic shutdown check
                        if (chkshut.Checked && cancel_queue == false)
                        {
                            auto_shut();
                            return;
                        }
                        //End shutdown check
                        else
                        {
                            if (cancel_queue == false)
                            {
                                if (chk_delete_source.CheckState == CheckState.Checked)
                                {
                                    Disable_Controls();
                                    System.Threading.Thread.Sleep(500);
                                    list_proc.Items.Clear();
                                    listView1.Invoke(new MethodInvoker(delegate
                                    {
                                        foreach (ListViewItem item in listView1.Items)
                                        {
                                            list_proc.Items.Add((ListViewItem)item.Clone());
                                        }
                                    }));

                                    Label prog_txt = new Label();
                                    this.InvokeEx(f => prog_txt.Parent = panel1);
                                    this.InvokeEx(f => prog_txt.Top = 95);
                                    this.InvokeEx(f => prog_txt.Left = 80);
                                    this.InvokeEx(f => prog_txt.Width = 250);
                                    this.InvokeEx(f => prog_txt.TabIndex = 1);
                                    this.InvokeEx(f => prog_txt.BackColor = panel1.BackColor);
                                    this.InvokeEx(f => prog_txt.BorderStyle = BorderStyle.None);
                                    this.InvokeEx(f => prog_txt.TextAlign = ContentAlignment.MiddleLeft);
                                    this.InvokeEx(f => prog_txt.BringToFront());
                                    this.InvokeEx(f => prog_txt.Text = FFBatch.Properties.Strings.to_recycle);

                                    ProgressBar pg_del = new ProgressBar();
                                    this.InvokeEx(f => pg_del.Parent = panel1);
                                    this.InvokeEx(f => pg_del.Top = 98);
                                    this.InvokeEx(f => pg_del.Left = 315);
                                    this.InvokeEx(f => pg_del.Width = 302);
                                    this.InvokeEx(f => pg_del.Height = 15);
                                    this.InvokeEx(f => pg_del.TabIndex = 0);
                                    this.InvokeEx(f => pg_del.BackColor = this.BackColor);
                                    this.InvokeEx(f => pg_del.Minimum = 0);
                                    this.InvokeEx(f => pg_del.BringToFront());
                                    this.InvokeEx(f => pg_del.Maximum = list_proc.Items.Count);
                                    this.InvokeEx(f => pg_del.Show());
                                    this.InvokeEx(f => pg_del.Refresh());
                                    int i = 0;
                                    int err = 0;

                                    foreach (ListViewItem item in list_proc.Items)
                                    {
                                        if (item.SubItems[5].Text == FFBatch.Properties.Strings.success)
                                        {
                                            try
                                            {
                                                FileSystem.DeleteFile(item.SubItems[1].Text + "\\" + item.Text, UIOption.OnlyErrorDialogs, RecycleOption.SendToRecycleBin);
                                                this.InvokeEx(f => pg_del.Value = i);
                                                i = i + 1;
                                            }
                                            catch
                                            {
                                                err = err + 1;
                                            }

                                            this.InvokeEx(f => prog_txt.Text = FFBatch.Properties.Strings.to_recycle + i.ToString() + " " + FFBatch.Properties.Strings.of1 + " " + list_proc.Items.Count);
                                            this.InvokeEx(f => prog_txt.Refresh());
                                        }
                                    }
                                    this.InvokeEx(f => prog_txt.Visible = false);
                                    this.InvokeEx(f => prog_txt.Dispose());
                                    this.InvokeEx(f => pg_del.Visible = false);
                                    this.InvokeEx(f => pg_del.Dispose());
                                    Enable_Controls();

                                    if (err > 0) MessageBox.Show(err.ToString() + " " + FFBatch.Properties.Strings.not_recycled2, FFBatch.Properties.Strings.not_recycled3, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);

                                    Boolean all_ok = true;
                                    foreach (ListViewItem item in list_proc.Items)
                                    {
                                        if (item.SubItems[5].Text != FFBatch.Properties.Strings.success)
                                        {
                                            all_ok = false;
                                            break;
                                        }
                                    }
                                    if (all_ok == true)
                                    {
                                        this.InvokeEx(f => f.btn_refresh.PerformClick());
                                    }
                                }
                                if (errors_enc == 0 && play_on_end)
                                {
                                    play_end();
                                }
                                else if (play_on_end == true) System.Media.SystemSounds.Asterisk.Play();

                                if (Form.ActiveForm == null)
                                {
                                    if (errors_enc == 0)
                                    {
                                        notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.enc_comp;
                                        notifyIcon1.BalloonTipIcon = ToolTipIcon.Info;
                                        notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.enc_comp2;
                                        notifyIcon1.ShowBalloonTip(0);
                                    }
                                    else
                                    {
                                        notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.enc_comp3 + " " + errors_enc.ToString() + " " + Properties.Strings.errors1;
                                        notifyIcon1.BalloonTipIcon = ToolTipIcon.Warning;
                                        notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.enc_comp2;
                                        notifyIcon1.ShowBalloonTip(0);
                                    }
                                }

                                if (chk_open_compl.Checked)
                                {
                                    if (Directory.GetFiles(destino).Length != 0)
                                    {
                                        Process open_processed = new Process();
                                        open_processed.StartInfo.FileName = "explorer.exe";
                                        open_processed.StartInfo.Arguments = '\u0022' + destino + '\u0022';
                                        open_processed.Start();
                                    }
                                    else
                                    {
                                        if (Directory.Exists(destino))
                                        {
                                            System.IO.Directory.Delete(destino);
                                        }
                                    }
                                }
                            }
                            else
                            {
                                this.InvokeEx(f => f.Pg1.Text = "100%");
                                this.InvokeEx(f => f.Pg1.Refresh());
                                this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.aborted, MessageBoxButtons.OK, MessageBoxIcon.Error));
                            }
                        }
                    }
                }

                this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                Enable_Controls();
            }).Start();
        }

        private void detect_silence()
        {
            Pg1.Focus();
            if (!File.Exists(Path.Combine(Application.StartupPath, "ffmpeg.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_ffmpeg, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            String ffm = Path.Combine(Application.StartupPath, "AeroWizard.dll");
            if (!File.Exists(ffm))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_aerowiz, FFBatch.Properties.Strings.required_file, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (listView1.Items.Count == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.list_empty, FFBatch.Properties.Strings.no_files, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            foreach (ListViewItem file2 in listView1.Items)
            {
                if (!File.Exists(file2.SubItems[1].Text + "\\" + file2.Text))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file_not_found + " " + file2.Text, FFBatch.Properties.Strings.file_not_found2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }

            pg_adding.Visible = true;
            pg_adding.Value = 0;
            pg_adding.Maximum = listView1.Items.Count;
            LB_Wait.Visible = true;
            txt_adding_p.Visible = true;

            LB_Wait.Text = String.Empty;
            LB_Wait.Visible = false;
            pg_adding.Visible = false;
            txt_adding_p.Text = String.Empty;

            String f_nologs = String.Empty;
            if (is_portable == false)
            {
                f_nologs = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_nologs.ini";
            }
            else
            {
                f_nologs = port_path + "ff_nologs_portable.ini";
            }

            no_save_logs = File.Exists(f_nologs);
            //End do not save logs

            if (no_save_logs == true)
            {
                DialogResult a = MessageBox.Show(FFBatch.Properties.Strings.log_req, FFBatch.Properties.Strings.log_dis, MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                if (a == DialogResult.No) return;
                else
                {
                    no_save_logs = false;
                    try
                    {
                        File.Delete(f_nologs);
                    }
                    catch (Exception excpt)
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.log_enab + Environment.NewLine + Environment.NewLine + excpt.Message);
                    }
                }
            }

            AeroWizard4 wizard4 = new AeroWizard4();
            wizard4.StartPosition = FormStartPosition.CenterScreen;
            wizard4.ShowDialog();
            if (wizard4.ok_silence == true)
            {
                silence_params = wizard4.pr1_first_params;
                start_silence();
            }
            else
            {
                return;
            }
        }

        private void start_silence()
        {
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            cancel_queue = false;
            notifyIcon1.Visible = true;
            lbl_multip.Text = String.Empty;
            //Validated list, start processing

            txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + "00h:00m:00s";

            if (listView1.SelectedIndices.Count == 0)
            {
                listView1.Items[0].Selected = true;
                listView1.Items[0].Focused = true;
                listView1.Focus();
            }

            //Remove test file/folder

            String file_prueba = "";
            String sel_test = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
            file_prueba = sel_test;
            String destino = Path.Combine(Path.GetTempPath(), "\\" + "FFBatch_test");
            String borrar = destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + txt_format.Text;

            cancel_queue = false;
            Pg1.Value = 0;
            //pg_current.Value = 0;
            Disable_Controls();

            btn_skip_main.Enabled = true;
            //textBox4.Text = "0%";
            working = true;
            runnin_n_presets = true;

            ListView list_proc = new ListView();
            foreach (ListViewItem item in listView1.Items)
            {
                list_proc.Items.Add((ListViewItem)item.Clone());
                item.SubItems[5].Text = FFBatch.Properties.Strings.queued;
                item.BackColor = Color.White;
            }

            //End save hw decoder

            Pg1.Maximum = listView1.Items.Count;
            listView1.SelectedIndices.Clear();

            total_duration = 0;
            Double total_prog = 0;

            //Get total duration of files

            foreach (ListViewItem item in listView1.Items)
            {
                if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                {
                    total_duration = total_duration + TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds - TimeSpan.Parse(ss_time_input.Text).TotalSeconds;
                }
                else
                {
                    total_duration = total_duration + 0;
                }
            }

            Pg1.Minimum = 0;
            Pg1.Maximum = 100;
            String remain_time = "0";
            //End get total duration of files

            List<string> list_lines = new List<string>();
            process_glob.StartInfo.Arguments = String.Empty;

            time_n_tasks = 0;
            timer_tasks.Start();
            timer_est_size.Start();
            time_est_size = 0;
            String file = String.Empty;

            panel2.Enabled = true;
            chk_delete_source.Enabled = true;

            Boolean silence_found = false;

            foreach (Control ct in panel2.Controls)
            {
                if (ct.Name != chk_delete_source.Name)
                {
                    this.InvokeEx(f => ct.Enabled = false);
                }
            }

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;

                for (int list_index = 0; list_index < listView1.Items.Count; list_index++)
                {
                    System.Threading.Thread.Sleep(50); //Allow kill process to send cancel_queue

                    listView1.Invoke(new MethodInvoker(delegate
                    {
                        file = listView1.Items[list_index].SubItems[1].Text + "\\" + listView1.Items[list_index].Text;
                    }));

                    if (cancel_queue == true)
                    {
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        working = false;
                        time_est_size = 0;

                        Enable_Controls();
                        MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.task_abort, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                        return;
                    }
                    this.InvokeEx(f => timer_est_size.Start());

                    String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");
                    String fullPath = file;

                    if (txt_path_main.Text.Contains(".\\"))
                    {
                        if (txt_path_main.Text != ".\\")
                            destino = file.Substring(0, fullPath.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
                        else
                        {
                            destino = Path.GetDirectoryName(file);
                        }
                    }
                    else
                    {
                        if (checkBox1.CheckState == CheckState.Checked)
                        {
                            String pre_dest = Path.GetDirectoryName(file);
                            destino = Path.Combine(txt_path_main.Text, pre_dest.Substring(3, pre_dest.Length - 3));
                        }
                        else
                        {
                            destino = txt_path_main.Text;
                        }
                    }

                    String pre_input_var = "";
                    if (txt_pre_input.Text != "")
                    {
                        pre_input_var = txt_pre_input.Text;
                    }

                    String pre_ss = "";
                    if (TimeSpan.Parse(ss_time_input.Text).TotalSeconds != 0)
                    {
                        pre_ss = " -ss " + ss_time_input.Text;
                    }

                    add_suffix = "";

                    if (chk_suffix.Checked == true && txt_suffix.Text != String.Empty)
                    {
                        add_suffix = txt_suffix.Text;
                    }

                    String AppParam = pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + file + '\u0022' + " " + silence_params + " -loglevel info -stats";

                    if (!Directory.Exists(destino))
                    {
                        Directory.CreateDirectory(destino);
                    }

                    process_glob.StartInfo.FileName = ffm;
                    process_glob.StartInfo.Arguments = AppParam;

                    valid_prog = false;
                    this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.processing);

                    process_glob.StartInfo.RedirectStandardOutput = true;
                    process_glob.StartInfo.RedirectStandardInput = true;
                    process_glob.StartInfo.RedirectStandardError = true;
                    process_glob.StartInfo.UseShellExecute = false;
                    process_glob.StartInfo.CreateNoWindow = true;
                    process_glob.EnableRaisingEvents = true;
                    process_glob.Start();

                    System.Threading.Thread.Sleep(50);
                    combo_prio.Invoke(new MethodInvoker(delegate
                    {
                        if (combo_prio.SelectedIndex != 2)
                        {
                            Change_mem_prio();
                        }
                    }));

                    this.InvokeEx(f => validate_duration = listView1.Items[list_index].SubItems[3].Text);
                    if (validate_duration != FFBatch.Properties.Strings.n_a && validate_duration != "0:00:00" && validate_duration != "00:00:00" && validate_duration != FFBatch.Properties.Strings.pending)
                    {
                        valid_prog = true;
                    }

                    String err_txt = "";

                    String silence_duration = String.Empty;
                    String silence_start = String.Empty;
                    Double interval = 0;
                    this.InvokeEx(f => durat_n = TimeSpan.Parse(listView1.Items[list_index].SubItems[3].Text).TotalSeconds - TimeSpan.Parse(ss_time_input.Text).TotalSeconds);

                    lbl_speed.Text = String.Empty;
                    Double sec_prog = 0;
                    Boolean silence_found_file = false;

                    while (!process_glob.StandardError.EndOfStream)
                    {
                        err_txt = process_glob.StandardError.ReadLine();

                        if (err_txt.ToLower().Contains("silence"))
                        {
                            silence_found = true;
                            silence_found_file = true;
                            list_lines.Add(err_txt);
                            try
                            {
                                if (err_txt.ToLower().Contains("silence_start:")) silence_start = err_txt.Substring(err_txt.LastIndexOf("silence_start:") + 15, 6);
                                if (err_txt.ToLower().Contains("silence_duration:")) silence_duration = err_txt.Substring(err_txt.LastIndexOf("silence_duration:") + 18, 6);
                            }
                            catch { }
                        }
                        if (err_txt.Contains("time=") && err_txt.Contains("time=-") == false)
                        {
                            if (valid_prog == true)
                            {
                                int start_time_index = err_txt.IndexOf("time=") + 5;
                                sec_prog = TimeSpan.Parse(err_txt.Substring(start_time_index, 8)).TotalSeconds;

                                Double percent = (sec_prog * 100 / durat_n);

                                total_prog = total_prog + (sec_prog - interval);
                                interval = sec_prog;
                                int percent2 = Convert.ToInt32(percent);

                                Double percent_tot = (total_prog * 100 / total_duration);
                                int percent_tot_2 = Convert.ToInt32(percent_tot);

                                if (percent_tot_2 <= 100)
                                {
                                    this.InvokeEx(f => f.Pg1.Value = percent_tot_2);
                                    this.InvokeEx(f => f.Pg1.Refresh());

                                    this.InvokeEx(f => f.Pg1.Text = Math.Round(percent_tot, 1).ToString() + "%");
                                    this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, percent_tot, Pg1.Maximum));
                                }

                                if (percent2 <= 100)
                                {
                                    if (Math.Round(percent, 1).ToString().Contains(".") || Math.Round(percent, 1).ToString().Contains(","))
                                    {
                                        this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = Math.Round(percent, 1).ToString() + "%");
                                    }
                                    else
                                    {
                                        this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = Math.Round(percent, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0" + "%");
                                    }
                                }

                                if (cancel_queue == false)
                                {
                                    //Estimated remaining time

                                    remain_time = err_txt.Substring(err_txt.LastIndexOf("speed=") + 6, err_txt.Length - err_txt.LastIndexOf("speed=") - 6);
                                    if (time_est_size % 3 == 0) this.InvokeEx(f => f.lbl_speed.Text = FFBatch.Properties.Strings.speed + " " + remain_time);
                                    remain_time = remain_time.Replace("x", String.Empty);
                                    Double timing1 = 0;

                                    if (System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator == ",")
                                    {
                                        timing1 = Math.Round(Double.Parse(remain_time.Replace(".", ",")), 2);
                                    }
                                    else
                                    {
                                        timing1 = Math.Round(Double.Parse(remain_time), 2);
                                    }

                                    Decimal timing = (decimal)timing1;
                                    Decimal total_dur_dec = Convert.ToDecimal(total_duration);
                                    Decimal total_prog_dec = Convert.ToDecimal(total_prog);
                                    Decimal remain_secs = 0;

                                    if (timing > 0)
                                    {
                                        remain_secs = (decimal)(total_dur_dec - total_prog_dec) / timing;
                                    }

                                    if (remain_secs > 60)
                                    {
                                        remain_secs = remain_secs + 60;
                                    }

                                    String remain_from_secs = String.Empty;

                                    TimeSpan t = TimeSpan.FromSeconds(Convert.ToDouble(remain_secs));
                                    remain_from_secs = string.Format("{0:D2}h:{1:D2}", t.Hours, t.Minutes);

                                    if (remain_secs >= 43200)
                                    {
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Math.Round(remain_secs / 3600).ToString() + " " + FFBatch.Properties.Strings.hours);
                                    }

                                    if (remain_secs >= 3600 && remain_secs < 43200)
                                    {
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs + " " + FFBatch.Properties.Strings.minutes_abrev);
                                    }

                                    if (remain_secs < 3600 && remain_secs >= 600)
                                    {
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes);
                                    }

                                    if (remain_secs < 600 && remain_secs >= 120)
                                    {
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes);
                                    }

                                    if (remain_secs <= 59 && remain_secs != 0)
                                    {
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Convert.ToInt16(remain_secs) + " " + FFBatch.Properties.Strings.seconds);
                                    }

                                    if (remain_secs == 0)
                                    {
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.about_finish);
                                    }
                                }
                                //End remaining time
                            }
                        }
                    }
                    process_glob.WaitForExit();
                    process_glob.StartInfo.Arguments = String.Empty;
                    timer_est_size.Stop();
                    time_est_size = 0;
                    this.InvokeEx(f => lbl_speed.Text = String.Empty);
                    //this.InvokeEx(f => pg_lv.Visible = false);
                    //this.InvokeEx(f => pg_lv.Dispose());
                    this.InvokeEx(f => f.lbl_est_size.Text = String.Empty);
                    this.InvokeEx(f => f.lbl_bitrate.Text = String.Empty);

                    list_lines.Add("");
                    list_lines.Add("---------------------End of " + Path.GetFileName(file) + " log-------------------------------");
                    list_lines.Add("");

                    if (process_glob.ExitCode == 0)
                    {
                        if (skipped == false)
                        {
                            if (silence_found_file == false)
                            {
                                this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.success);
                            }
                            else
                            {
                                this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.silence_start + " " + silence_start + " " + FFBatch.Properties.Strings.dur1 + " " + silence_duration);
                                this.InvokeEx(f => f.listView1.Items[list_index].BackColor = Color.LightGoldenrodYellow);
                            }
                        }
                        else
                        {
                            this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.skipped);
                            total_prog = (total_prog + durat_n - sec_prog) / n_multi_presets;
                            skipped = false;
                        }
                    }
                    else
                    {
                        this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.error);
                        total_prog = total_prog + durat_n - sec_prog;
                    }

                    if (list_index == listView1.Items.Count - 1)
                    {
                        this.InvokeEx(f => f.lbl_multip.Visible = false);
                        runnin_n_presets = false;
                        list_index = listView1.Items.Count - 1;
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        this.InvokeEx(f => f.Pg1.Value = 100);
                        this.InvokeEx(f => f.Pg1.Text = "100%");
                        working = false;
                        timer_est_size.Stop();
                        time_est_size = 0;

                        if (no_save_logs == false)
                        {
                            //Save log
                            string[] array_err = list_lines.ToArray();
                            String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                            if (is_portable == true) path = port_path + "ff_batch_portable.log";

                            System.IO.StreamWriter SaveFile = new System.IO.StreamWriter(path);
                            SaveFile.WriteLine("FFmpeg log sesion: " + System.DateTime.Now);
                            SaveFile.WriteLine("-------------------------------");
                            foreach (String item in array_err)
                            {
                                SaveFile.WriteLine(item);
                            }
                            SaveFile.Close();

                            File.AppendAllText(path, "-----------------------");
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.end_log + Environment.NewLine);
                            File.AppendAllText(path, "-----------------------");
                            System.IO.FileInfo fileInfo = new System.IO.FileInfo(path);

                            var bytes = fileInfo.Length;

                            var kilobytes = (double)bytes / 1024;
                            var megabytes = kilobytes / 1024;
                            var gigabytes = megabytes / 1024;

                            //Format size view
                            String size = "";
                            String separator = ".";

                            if (bytes > 1000000000)
                            {
                                if (gigabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String gigas = gigabytes.ToString();
                                if (gigas.Length >= 5)
                                {
                                    gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                                    size = (gigas + " " + "GB");
                                }
                                else
                                {
                                    size = (gigas + " " + "GB");
                                }
                            }

                            if (bytes >= 1048576 && bytes <= 1000000000)
                            {
                                if (megabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }
                                String megas = megabytes.ToString();
                                if (megas.Length > 5)
                                {
                                    megas = megas.Substring(0, megas.LastIndexOf(separator));
                                    size = (megas + " " + "MB");
                                }
                                else
                                {
                                    size = (megas + " " + "MB");
                                }
                            }

                            if (bytes >= 1024 && bytes < 1048576)

                            {
                                if (kilobytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String kbs = kilobytes.ToString();
                                if (kbs.Length >= 5)
                                {
                                    kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                                    size = (kbs + " " + "KB");
                                }
                                else
                                {
                                    size = (kbs + " " + "KB");
                                }
                            }
                            if (bytes > -1 && bytes < 1024)
                            {
                                String bits = bytes.ToString();
                                size = (bits + " Bytes");
                            }

                            //End Format size view
                            timer_tasks.Stop();
                            TimeSpan t = TimeSpan.FromSeconds(time_n_tasks);
                            String tx_elapsed = string.Format("{0:D2}h:{1:D2}m:{2:D2}s",
                                t.Hours,
                                t.Minutes,
                                t.Seconds);
                            File.AppendAllText(path, Environment.NewLine);
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.total_time + " " + tx_elapsed);
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.log_size + " " + size);
                            //End save log
                        }

                        //Automatic shutdown check
                        if (chkshut.Checked && cancel_queue == false)
                        {
                            auto_shut();
                            return;
                        }
                        //End shutdown check
                        else
                        {
                            if (cancel_queue == false)
                            {
                                if (chk_delete_source.CheckState == CheckState.Checked)
                                {
                                    Disable_Controls();
                                    System.Threading.Thread.Sleep(500);
                                    list_proc.Items.Clear();
                                    listView1.Invoke(new MethodInvoker(delegate
                                    {
                                        foreach (ListViewItem item in listView1.Items)
                                        {
                                            list_proc.Items.Add((ListViewItem)item.Clone());
                                        }
                                    }));

                                    Label prog_txt = new Label();
                                    this.InvokeEx(f => prog_txt.Parent = panel1);
                                    this.InvokeEx(f => prog_txt.Top = 95);
                                    this.InvokeEx(f => prog_txt.Left = 80);
                                    this.InvokeEx(f => prog_txt.Width = 250);
                                    this.InvokeEx(f => prog_txt.TabIndex = 1);
                                    this.InvokeEx(f => prog_txt.BackColor = panel1.BackColor);
                                    this.InvokeEx(f => prog_txt.BorderStyle = BorderStyle.None);
                                    this.InvokeEx(f => prog_txt.TextAlign = ContentAlignment.MiddleLeft);
                                    this.InvokeEx(f => prog_txt.BringToFront());
                                    this.InvokeEx(f => prog_txt.Text = FFBatch.Properties.Strings.to_recycle);

                                    ProgressBar pg_del = new ProgressBar();
                                    this.InvokeEx(f => pg_del.Parent = panel1);
                                    this.InvokeEx(f => pg_del.Top = 98);
                                    this.InvokeEx(f => pg_del.Left = 315);
                                    this.InvokeEx(f => pg_del.Width = 302);
                                    this.InvokeEx(f => pg_del.Height = 15);
                                    this.InvokeEx(f => pg_del.TabIndex = 0);
                                    this.InvokeEx(f => pg_del.BackColor = this.BackColor);
                                    this.InvokeEx(f => pg_del.Minimum = 0);
                                    this.InvokeEx(f => pg_del.BringToFront());
                                    this.InvokeEx(f => pg_del.Maximum = list_proc.Items.Count);
                                    this.InvokeEx(f => pg_del.Show());
                                    this.InvokeEx(f => pg_del.Refresh());
                                    int i = 0;
                                    int err = 0;

                                    foreach (ListViewItem item in list_proc.Items)
                                    {
                                        if (item.SubItems[5].Text == FFBatch.Properties.Strings.success)
                                        {
                                            try
                                            {
                                                FileSystem.DeleteFile(item.SubItems[1].Text + "\\" + item.Text, UIOption.OnlyErrorDialogs, RecycleOption.SendToRecycleBin);
                                                this.InvokeEx(f => pg_del.Value = i);
                                                i = i + 1;
                                            }
                                            catch
                                            {
                                                err = err + 1;
                                            }

                                            this.InvokeEx(f => prog_txt.Text = FFBatch.Properties.Strings.to_recycle + i.ToString() + " " + FFBatch.Properties.Strings.of1 + " " + list_proc.Items.Count);
                                            this.InvokeEx(f => prog_txt.Refresh());
                                        }
                                    }
                                    this.InvokeEx(f => prog_txt.Visible = false);
                                    this.InvokeEx(f => prog_txt.Dispose());
                                    this.InvokeEx(f => pg_del.Visible = false);
                                    this.InvokeEx(f => pg_del.Dispose());
                                    Enable_Controls();

                                    if (err > 0) MessageBox.Show(err.ToString() + " " + FFBatch.Properties.Strings.not_recycled2, FFBatch.Properties.Strings.not_recycled3, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);

                                    Boolean all_ok = true;
                                    foreach (ListViewItem item in list_proc.Items)
                                    {
                                        if (item.SubItems[5].Text != FFBatch.Properties.Strings.success)
                                        {
                                            all_ok = false;
                                            break;
                                        }
                                    }
                                    if (all_ok == true)
                                    {
                                        this.InvokeEx(f => f.btn_refresh.PerformClick());
                                    }
                                }

                                if (play_on_end == true) play_end();

                                if (Form.ActiveForm == null)
                                {
                                    notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.ff_silence_c;
                                    notifyIcon1.BalloonTipIcon = ToolTipIcon.Info;
                                    notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.silence_c;
                                    notifyIcon1.ShowBalloonTip(0);
                                }

                                if (chk_open_compl.Checked)
                                {
                                    if (Directory.GetFiles(destino).Length != 0)
                                    {
                                        Process open_processed = new Process();
                                        open_processed.StartInfo.FileName = "explorer.exe";
                                        open_processed.StartInfo.Arguments = '\u0022' + destino + '\u0022';
                                        open_processed.Start();
                                    }
                                    else
                                    {
                                        if (Directory.Exists(destino))
                                        {
                                            System.IO.Directory.Delete(destino);
                                        }
                                    }
                                }
                            }
                            else
                            {
                                this.InvokeEx(f => f.Pg1.Text = "100%");
                                this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.aborted, MessageBoxButtons.OK, MessageBoxIcon.Error));
                            }
                        }
                        this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                        Enable_Controls();
                        if (silence_found == true)
                        {
                            Enable_Controls();
                            if (play_on_end == true)
                            {
                                System.Media.SystemSounds.Asterisk.Play();
                            }
                            this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.silence_detect, FFBatch.Properties.Strings.silence_found, MessageBoxButtons.OK, MessageBoxIcon.Warning));
                        }
                    }
                }
            }).Start();
        }

        private void two_pass_encoding()
        {
            cancel_queue = false;
            notifyIcon1.Visible = true;
            lbl_multip.Text = String.Empty;
            //Validated list, start processing
            if ((fade_v_in.Checked == true && num_v_in.Value == 0) || (fade_v_out.Checked == true && num_v_out.Value == 0) || (fade_a_in.Checked == true && num_a_in.Value == 0) || (fade_a_out.Checked == true && num_a_out.Value == 0))
            {
                MessageBox.Show(FFBatch.Properties.Strings.fading_zero, FFBatch.Properties.Strings.fading_zero2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + "00h:00m:00s";

            if (listView1.SelectedIndices.Count == 0)
            {
                listView1.Items[0].Selected = true;
                listView1.Items[0].Focused = true;
                listView1.Focus();
            }
            String destino = Path.GetTempPath() + "\\" + "FFBatch_test";
            //Pending duration

            if (dur_ok == false)
            {
                list_pending_dur.Items.Clear();
                foreach (ListViewItem item in listView1.Items)
                {
                    list_pending_dur.Items.Add((ListViewItem)item.Clone());
                }
                BG_Dur.RunWorkerAsync();
                return;
            }

            //Check queued items

            if (warn_success_items == true)
            {
                Boolean no_queued = true;
                Boolean has_complete = false;
                foreach (ListViewItem item in listView1.Items)
                {
                    if (item.SubItems[5].Text == FFBatch.Properties.Strings.queued)
                    {
                        no_queued = false;
                    }
                    if (item.SubItems[5].Text == FFBatch.Properties.Strings.success || item.SubItems[5].Text == FFBatch.Properties.Strings.replaced)
                    {
                        has_complete = true;
                    }
                }

                if (no_queued == true && listView1.Items.Count > 1)
                {
                    var a = MessageBox.Show(FFBatch.Properties.Strings.items_q + " " + '\u0022' + FFBatch.Properties.Strings.queued + '\u0022' + ". " + FFBatch.Properties.Strings.all_files + " " + FFBatch.Properties.Strings.already_proc, FFBatch.Properties.Strings.not_queued, MessageBoxButtons.OKCancel, MessageBoxIcon.Question);
                    if (a == DialogResult.Cancel) return;
                }

                if (no_queued == false && has_complete == true)
                {
                    var a = MessageBox.Show(FFBatch.Properties.Strings.already_encoded + " " + '\u0022' + FFBatch.Properties.Strings.queued + '\u0022' + FFBatch.Properties.Strings.continu, FFBatch.Properties.Strings.some_q, MessageBoxButtons.OKCancel, MessageBoxIcon.Question);
                    if (a == DialogResult.Cancel) return;
                }
                //End check queued items
            }

            cancel_queue = false;
            Pg1.Value = 0;
            //pg_current.Value = 0;
            Disable_Controls();

            btn_skip_main.Enabled = true;
            //textBox4.Text = "0%";
            working = true;
            runnin_n_presets = true;

            ListView list_proc = new ListView();
            foreach (ListViewItem item in listView1.Items)
            {
                list_proc.Items.Add((ListViewItem)item.Clone());
                item.SubItems[5].Text = FFBatch.Properties.Strings.queued;
                item.BackColor = Color.White;
            }
            String hw_decode = String.Empty;
            if (cb_hwdecode.SelectedItem.ToString() != "none")
            {
                hw_decode = "-hwaccel " + cb_hwdecode.SelectedItem.ToString();
            }

            //Save selected hw decoder

            String path2 = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_hw_dcd.ini";
            String txt_hw_dcd = cb_hwdecode.SelectedItem.ToString();
            if (txt_hw_dcd != "none")
            {
                File.WriteAllText(path2, txt_hw_dcd);
            }
            else
            {
                if (File.Exists(path2)) File.Delete(path2);
            }

            //End save hw decoder

            // Fade validation
            fade_ok = true;
            check_fade();
            if (fade_ok == false)
            {
                Enable_Controls();
                return;
            }
            // END Fade validation

            Pg1.Maximum = listView1.Items.Count;
            listView1.SelectedIndices.Clear();

            total_duration = 0;
            Double total_prog = 0;

            //Get total duration of files

            foreach (ListViewItem item in listView1.Items)
            {
                if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                {
                    total_duration = total_duration + TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds - TimeSpan.Parse(ss_time_input.Text).TotalSeconds;
                }
                else
                {
                    total_duration = total_duration + 0;
                }
            }

            Pg1.Minimum = 0;
            Pg1.Maximum = 100;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            String remain_time = "0";
            //End get total duration of files

            List<string> list_lines = new List<string>();
            process_glob.StartInfo.Arguments = String.Empty;

            time_n_tasks = 0;
            timer_tasks.Start();
            timer_est_size.Start();
            time_est_size = 0;
            String file = String.Empty;

            panel2.Enabled = true;
            chk_delete_source.Enabled = true;
            foreach (Control ct in panel2.Controls)
            {
                if (ct.Name != chk_delete_source.Name)
                {
                    this.InvokeEx(f => ct.Enabled = false);
                }
            }

            String f_in_color = "Black";
            String f_out_color = "Black";
            if (combo_vin_col.SelectedIndex == 1) f_in_color = "White";
            if (combo_vout_color.SelectedIndex == 1) f_out_color = "White";

            String in_color = ":color=" + f_in_color;
            String out_color = ":color=" + f_out_color;
            if (combo_vin_col.SelectedIndex == 2) in_color = ":alpha=1";
            if (combo_vout_color.SelectedIndex == 2) out_color = ":alpha=1";

            n_multi_presets = 2;
            int preset_run = 1;
            int to_go = n_multi_presets;

            Boolean is_vp9 = false;
            if (multi_two_pr1.ToLower().Contains("libvpx-vp9"))
            {
                is_vp9 = true;
            }
            else
            {
                total_duration = total_duration * 2;
            }

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;

                for (int list_index = 0; list_index < listView1.Items.Count;)
                {
                    System.Threading.Thread.Sleep(50); //Allow kill process to send cancel_queue

                    listView1.Invoke(new MethodInvoker(delegate
                    {
                        file = listView1.Items[list_index].SubItems[1].Text + "\\" + listView1.Items[list_index].Text;
                    }));

                    if (cancel_queue == true)
                    {
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        working = false;
                        time_est_size = 0;
                        //this.InvokeEx(f => f.button2.Enabled = true);
                        Enable_Controls();
                        MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.task_abort, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                        return;
                    }
                    int fframes = 0;
                    ProgressBarWithText pg_lv_vp9 = new ProgressBarWithText();

                    if (is_vp9 == true && preset_run == 1)
                    {
                        this.InvokeEx(f => f.Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%");
                        this.InvokeEx(f => f.Pg1.Refresh());
                        this.InvokeEx(f => pg_lv_vp9.Parent = panel1);
                        this.InvokeEx(f => pg_lv_vp9.Top = 98);
                        this.InvokeEx(f => pg_lv_vp9.Left = 339);
                        this.InvokeEx(f => pg_lv_vp9.Width = 130);
                        this.InvokeEx(f => pg_lv_vp9.Height = 15);
                        this.InvokeEx(f => pg_lv_vp9.BringToFront());
                        this.InvokeEx(f => pg_lv_vp9.Show());

                        String ff_frames = String.Empty;
                        Process get_frames = new Process();
                        get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "mediainfo.exe");
                        String ffprobe_frames = "--Output=" + '\u0022' + "Video;%FrameCount%" + '\u0022';
                        get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + list_proc.Items[list_index].SubItems[1].Text + "\\" + list_proc.Items[list_index].Text + '\u0022';
                        get_frames.StartInfo.RedirectStandardOutput = true;
                        get_frames.StartInfo.RedirectStandardError = true;
                        get_frames.StartInfo.UseShellExecute = false;
                        get_frames.StartInfo.CreateNoWindow = true;
                        get_frames.EnableRaisingEvents = true;
                        get_frames.Start();

                        ff_frames = get_frames.StandardOutput.ReadLine();
                        get_frames.WaitForExit();

                        if (get_frames.ExitCode == 0)
                        {
                            if (ff_frames != null)
                            {
                                if (ff_frames.ToLower() != FFBatch.Properties.Strings.n_a)
                                {
                                    int try_ff = 0;
                                    if (int.TryParse(ff_frames, out try_ff))
                                    {
                                        fframes = try_ff;
                                    }
                                }
                                else
                                {
                                    fframes = 0;
                                }
                            }
                        }
                        else
                        {
                            fframes = 0;
                        }

                        get_frames.Dispose();
                        this.InvokeEx(f => pg_lv_vp9.Maximum = fframes);
                    }

                    this.InvokeEx(f => timer_est_size.Start());

                    String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");
                    String fullPath = file;

                    //Begin Shifting
                    String shifting = "";
                    if (chk_shift.Checked == true)
                    {
                        shifting = " -itsoffset " + Num_Shift.Value.ToString().Replace(",", ".") + " -i " + '\u0022' + file + '\u0022' + " -map 1:v -map 0:a ";
                    }
                    //End Shifting

                    //Begin fading and volume changing
                    String change_vol_fade = "";
                    if (chk_vol.Checked == true)
                    {
                        change_vol_fade = "-af " + '\u0022' + "volume=" + vol_ch.Value.ToString() + "dB " + '\u0022' + " ";
                    }

                    String fade_filter = String.Empty;
                    Decimal fade_frames = 0;

                    if (fade_v_in.CheckState == CheckState.Checked || fade_v_out.CheckState == CheckState.Checked || fframes == 0)
                    {
                        String ff_frames = String.Empty;
                        Process get_frames = new Process();
                        get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
                        String ffprobe_frames = " " + '\u0022' + "--Inform=Video;%FrameRate%" + '\u0022';
                        get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + list_proc.Items[list_index].SubItems[1].Text + "\\" + list_proc.Items[list_index].Text + '\u0022';
                        get_frames.StartInfo.RedirectStandardOutput = true;
                        get_frames.StartInfo.RedirectStandardError = true;
                        get_frames.StartInfo.UseShellExecute = false;
                        get_frames.StartInfo.CreateNoWindow = true;
                        get_frames.EnableRaisingEvents = true;
                        get_frames.Start();

                        ff_frames = get_frames.StandardOutput.ReadLine();

                        get_frames.WaitForExit();

                        if (get_frames.ExitCode == 0 && ff_frames != null)
                        {
                            try
                            {
                                fade_frames = decimal.Parse(ff_frames) / 1000;
                            }
                            catch { fade_frames = 0; }
                        }
                        get_frames.Dispose();
                    }

                    if (fade_v_in.CheckState == CheckState.Checked && fade_v_out.CheckState == CheckState.Unchecked)
                    {
                        Decimal fff_in = Math.Round(num_v_in.Value * fade_frames, 0);
                        fade_filter = "-vf " + '\u0022' + "fade=in:0:" + fff_in.ToString() + in_color + '\u0022';
                    }

                    if (fade_v_in.CheckState == CheckState.Unchecked && fade_v_out.CheckState == CheckState.Checked)
                    {
                        Double dur_frames = TimeSpan.Parse(list_proc.Items[list_index].SubItems[3].Text).TotalSeconds * Convert.ToDouble(fade_frames);
                        Decimal fade_out_total = Math.Round(Convert.ToDecimal(dur_frames), 3, MidpointRounding.AwayFromZero);
                        Decimal fade_out_initial = Math.Round(fade_out_total - (num_v_out.Value * fade_frames), 0, MidpointRounding.AwayFromZero);
                        Decimal fff_out = Math.Round(num_v_out.Value * fade_frames, 0, MidpointRounding.AwayFromZero);

                        fade_filter = "-vf " + '\u0022' + "fade=out:" + fade_out_initial.ToString() + ":" + fff_out.ToString() + out_color + '\u0022';
                    }

                    if (fade_v_in.CheckState == CheckState.Checked && fade_v_out.CheckState == CheckState.Checked)
                    {
                        Decimal fff_in = Math.Round(num_v_in.Value * fade_frames, 0, MidpointRounding.AwayFromZero);
                        Double dur_frames = TimeSpan.Parse(list_proc.Items[list_index].SubItems[3].Text).TotalSeconds * Convert.ToDouble(fade_frames);
                        Decimal fade_out_total = Math.Round(Convert.ToDecimal(dur_frames), 3, MidpointRounding.AwayFromZero);
                        Decimal fade_out_initial = Math.Round(fade_out_total - (num_v_out.Value * fade_frames), 0, MidpointRounding.AwayFromZero);
                        Decimal fff_out = Math.Round(num_v_out.Value * fade_frames, 0, MidpointRounding.AwayFromZero);

                        fade_filter = "-vf " + '\u0022' + "fade=in:0:" + fff_in.ToString() + in_color + ", " + "fade=out:" + fade_out_initial.ToString() + ":" + fff_out.ToString() + out_color + '\u0022';
                    }

                    //Audio fading
                    if (fade_a_in.CheckState == CheckState.Checked && fade_a_out.CheckState == CheckState.Unchecked)
                    {
                        if (chk_vol.Checked == false)
                        {
                            change_vol_fade = "-af " + '\u0022' + "afade=t=in:ss=0:d=" + num_a_in.Value.ToString() + '\u0022';
                        }
                        else
                        {
                            change_vol_fade = "-af " + '\u0022' + "afade=t=in:ss=0:d=" + num_a_in.Value.ToString() + ", " + "volume=" + vol_ch.Value.ToString() + "dB " + '\u0022';
                        }
                    }

                    if (fade_a_in.CheckState == CheckState.Unchecked && fade_a_out.CheckState == CheckState.Checked)
                    {
                        Double af_out = TimeSpan.Parse(list_proc.Items[list_index].SubItems[3].Text).TotalSeconds - Convert.ToDouble(num_a_out.Value);
                        Decimal af_out_dec = Math.Round(Convert.ToDecimal(af_out), 0, MidpointRounding.AwayFromZero);
                        if (chk_vol.Checked == false)
                        {
                            change_vol_fade = "-af " + '\u0022' + "afade=t=out:st=" + af_out_dec + ":d=" + num_a_out.Value.ToString() + '\u0022';
                        }
                        else
                        {
                            change_vol_fade = "-af " + '\u0022' + "afade=t=out:st=" + af_out_dec + ":d=" + num_a_out.Value.ToString() + ", " + "volume=" + vol_ch.Value.ToString() + "dB " + '\u0022';
                        }
                    }
                    if (fade_a_in.CheckState == CheckState.Checked && fade_a_out.CheckState == CheckState.Checked)
                    {
                        Double af_out = TimeSpan.Parse(list_proc.Items[list_index].SubItems[3].Text).TotalSeconds - Convert.ToDouble(num_a_out.Value);
                        Decimal af_out_dec = Math.Round(Convert.ToDecimal(af_out), 0, MidpointRounding.AwayFromZero);

                        if (chk_vol.Checked == false)
                        {
                            change_vol_fade = "-af " + '\u0022' + "afade=t=in:ss=0:d=" + num_a_in.Value.ToString() + ", " + "afade=t=out:st=" + af_out_dec + ":d=" + num_a_out.Value.ToString() + '\u0022';
                        }
                        else
                        {
                            change_vol_fade = "-af " + '\u0022' + "afade=t=in:ss=0:d=" + num_a_in.Value.ToString() + ", " + "afade=t=out:st=" + af_out_dec + ":d=" + num_a_out.Value.ToString() + ", " + "volume=" + vol_ch.Value.ToString() + "dB " + '\u0022';
                        }
                    }
                    //End audio fading

                    //End fading

                    //End Change Volume

                    if (txt_path_main.Text.Contains(".\\"))
                    {
                        destino = file.Substring(0, fullPath.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
                    }
                    else
                    {
                        if (checkBox1.CheckState == CheckState.Checked)
                        {
                            String pre_dest = Path.GetDirectoryName(file);
                            destino = Path.Combine(txt_path_main.Text, pre_dest.Substring(3, pre_dest.Length - 3));
                        }
                        else
                        {
                            destino = txt_path_main.Text;
                        }
                    }

                    String pre_input_var = "";
                    if (txt_pre_input.Text != "")
                    {
                        pre_input_var = txt_pre_input.Text;
                    }

                    String pre_ss = "";
                    if (TimeSpan.Parse(ss_time_input.Text).TotalSeconds != 0)
                    {
                        pre_ss = " -ss " + ss_time_input.Text;
                    }

                    add_suffix = "";

                    if (chk_suffix.Checked == true && txt_suffix.Text != String.Empty)
                    {
                        add_suffix = txt_suffix.Text;
                    }
                    String add_pr_suffix = String.Empty;
                    if (ren_multi == true)
                    {
                        add_pr_suffix = "_" + preset_run.ToString();
                    }

                    String ext_output1 = String.Empty;

                    if (preset_run == 1)
                    {
                        ext_output1 = "nul";
                        textbox_params = multi_1st_pass;
                    }
                    if (preset_run == 2)
                    {
                        ext_output1 = multi_two_ext;
                        ext_output1 = "." + ext_output1;
                        textbox_params = multi_two_pr1;
                    }

                    String file2 = file;
                    if (textbox_params.Contains("%fn"))
                    {
                        textbox_params = textbox_params.Replace("%fn", Path.GetFileNameWithoutExtension(file));
                    }
                    if (textbox_params.Contains("%fp"))
                    {
                        textbox_params = textbox_params.Replace("%fp", Path.GetDirectoryName(file));
                    }
                    if (textbox_params.Contains("%fd"))
                    {
                        var path = Path.GetFullPath(file);
                        var dirName = Path.GetFileName(Path.GetDirectoryName(path));
                        textbox_params = textbox_params.Replace("%fd", dirName);
                    }
                    while (textbox_params.Contains("%1"))
                    {
                        if (textbox_params.Contains("%1"))
                        {
                            file2 = file2.Replace("\\", "\\\\\\\\");
                            file2 = file2.Replace(":", ":" + "\\\\");
                            textbox_params = textbox_params.Replace("%1", '\u0022' + file2 + '\u0022');
                        }
                    }

                    while (textbox_params.Contains("%2"))
                    {
                        if (textbox_params.Contains("%2"))
                        {
                            file2 = file2.Replace("\\", "\\\\\\\\");
                            file2 = file2.Replace(":", ":" + "\\\\");
                            textbox_params = textbox_params.Replace("%2", '\u0022' + Path.Combine(System.IO.Path.GetDirectoryName(file2), Path.GetFileNameWithoutExtension(file2)) + '\u0022');
                        }
                    }
                    String AppParam = String.Empty;
                    String templog = Path.GetTempPath() + "\\" + "FF_pass2.log";

                    if (preset_run == 1) AppParam = hw_decode + " " + pre_input_var + " " + pre_ss + " -y -i " + "" + '\u0022' + file + '\u0022' + " " + shifting + " " + textbox_params + " -passlogfile " + '\u0022' + templog + '\u0022' + " " + ext_output1;
                    else AppParam = hw_decode + " " + pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + file + '\u0022' + " " + shifting + " -y " + textbox_params + " -passlogfile " + '\u0022' + templog + '\u0022' + " " + fade_filter + " " + change_vol_fade + " " + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + add_suffix + add_pr_suffix + ext_output1 + '\u0022';

                    if (!Directory.Exists(destino))
                    {
                        Directory.CreateDirectory(destino);
                    }

                    process_glob.StartInfo.FileName = ffm;
                    process_glob.StartInfo.Arguments = AppParam;

                    valid_prog = false;
                    if (preset_run == 1) this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.processing);

                    process_glob.StartInfo.RedirectStandardOutput = true;
                    process_glob.StartInfo.RedirectStandardInput = true;
                    process_glob.StartInfo.RedirectStandardError = true;
                    process_glob.StartInfo.UseShellExecute = false;
                    process_glob.StartInfo.CreateNoWindow = true;
                    process_glob.EnableRaisingEvents = true;
                    process_glob.Start();

                    System.Threading.Thread.Sleep(50);
                    combo_prio.Invoke(new MethodInvoker(delegate
                    {
                        if (combo_prio.SelectedIndex != 2)
                        {
                            Change_mem_prio();
                        }
                    }));

                    this.InvokeEx(f => durat_n = TimeSpan.Parse(listView1.Items[list_index].SubItems[3].Text).TotalSeconds - TimeSpan.Parse(ss_time_input.Text).TotalSeconds);

                    //Recalculate total frames for vp9

                    if (fframes == 0)
                    {
                        try
                        {
                            fframes = Convert.ToInt32(Math.Ceiling(Convert.ToDouble(fade_frames) * durat_n));
                        }
                        catch { }
                        this.InvokeEx(f => pg_lv_vp9.Minimum = 0);
                        this.InvokeEx(f => pg_lv_vp9.Maximum = fframes);
                    }
                    //End recalculate total frames for vp9

                    this.InvokeEx(f => validate_duration = listView1.Items[list_index].SubItems[3].Text);
                    if (validate_duration != FFBatch.Properties.Strings.n_a && validate_duration != "0:00:00" && validate_duration != "00:00:00" && validate_duration != FFBatch.Properties.Strings.pending)
                    {
                        valid_prog = true;
                    }

                    String err_txt = "";
                    Double interval = 0;
                    Decimal est_bitrate = 0;
                    Decimal est_size = 0;
                    lbl_speed.Text = String.Empty;
                    Double sec_prog = 0;
                    this.InvokeEx(f => f.lbl_multip.Enabled = true);
                    this.InvokeEx(f => f.lbl_multip.Visible = true);
                    if (preset_run == 1) this.InvokeEx(f => f.lbl_multip.Text = FFBatch.Properties.Strings.pass1);
                    if (preset_run == 2)
                    {
                        this.InvokeEx(f => f.lbl_multip.Text = FFBatch.Properties.Strings.pass2);
                        this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = "50%");
                        //this.InvokeEx(f => pg_lv.Value = 50);
                    }

                    while (!process_glob.StandardError.EndOfStream)
                    {
                        err_txt = process_glob.StandardError.ReadLine();
                        list_lines.Add(err_txt);
                        if (is_vp9 == false || preset_run == 2)
                        {
                            if (err_txt.Contains("time=") && err_txt.Contains("time=-") == false)
                            {
                                if (valid_prog == true)
                                {
                                    this.InvokeEx(f => durat_n = TimeSpan.Parse(listView1.Items[list_index].SubItems[3].Text).TotalSeconds - TimeSpan.Parse(ss_time_input.Text).TotalSeconds);
                                    durat_n = durat_n * 2;
                                    int start_time_index = err_txt.IndexOf("time=") + 5;
                                    sec_prog = TimeSpan.Parse(err_txt.Substring(start_time_index, 8)).TotalSeconds;

                                    Double percent = (sec_prog * 100 / durat_n);

                                    total_prog = total_prog + (sec_prog - interval);
                                    interval = sec_prog;
                                    int percent2 = Convert.ToInt32(percent);

                                    Double percent_tot = (total_prog * 100 / total_duration);
                                    int percent_tot_2 = Convert.ToInt32(percent_tot);

                                    if (percent_tot_2 <= 100)
                                    {
                                        this.InvokeEx(f => f.Pg1.Value = percent_tot_2);
                                        this.InvokeEx(f => f.Pg1.Refresh());

                                        if (Math.Round(percent_tot, 1).ToString().Contains(".") || Math.Round(percent_tot, 1).ToString().Contains(","))
                                        {
                                            this.InvokeEx(f => f.Pg1.Text = Math.Round(percent_tot, 1).ToString() + "%");
                                        }
                                        else
                                        {
                                            this.InvokeEx(f => f.Pg1.Text = Math.Round(percent_tot, 1).ToString() + ".0" + "%");
                                        }

                                        this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, percent_tot, Pg1.Maximum));
                                    }

                                    if (percent2 <= 100)
                                    {
                                        //this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = percent2.ToString() + "%");

                                        if (preset_run == 2)
                                            if (percent2 <= 50)
                                            {
                                                if (Math.Round(percent, 1).ToString().Contains(".") || Math.Round(percent, 1).ToString().Contains(","))
                                                {
                                                    this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = Math.Round(percent + 50, 1).ToString() + "%");
                                                }
                                                else
                                                {
                                                    this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = Math.Round(percent + 50, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0" + "%");
                                                }
                                            }
                                            else
                                            {
                                                if (Math.Round(percent, 1).ToString().Contains(".") || Math.Round(percent, 1).ToString().Contains(","))
                                                {
                                                    this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = "100%");
                                                }
                                                else
                                                {
                                                    this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = "100%");
                                                }
                                            }
                                        else
                                        {
                                            if (Math.Round(percent, 1).ToString().Contains(".") || Math.Round(percent, 1).ToString().Contains(","))
                                            {
                                                this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = Math.Round(percent, 1).ToString() + "%");
                                            }
                                            else
                                            {
                                                this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = Math.Round(percent, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0" + "%");
                                            }
                                        }

                                        if (preset_run == 2)
                                        {
                                            if (Math.Round(percent, 1).ToString().Contains(".") || Math.Round(percent, 1).ToString().Contains(","))
                                            {
                                                this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = Math.Round(percent + 50, 1).ToString() + "%");
                                            }
                                            else
                                            {
                                                this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = Math.Round(percent + 50, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0" + "%");
                                            }
                                        }
                                        else
                                        {
                                            if (Math.Round(percent, 1).ToString().Contains(".") || Math.Round(percent, 1).ToString().Contains(","))
                                            {
                                                this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = Math.Round(percent, 1).ToString() + "%");
                                            }
                                            else
                                            {
                                                this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = Math.Round(percent, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0" + "%");
                                            }
                                        }
                                        //this.InvokeEx(f => pg_lv.Refresh());
                                    }

                                    if (cancel_queue == false)
                                    {
                                        //Estimated remaining time

                                        remain_time = err_txt.Substring(err_txt.LastIndexOf("speed=") + 6, err_txt.Length - err_txt.LastIndexOf("speed=") - 6);
                                        if (time_est_size % 3 == 0) this.InvokeEx(f => f.lbl_speed.Text = FFBatch.Properties.Strings.speed + " " + remain_time);
                                        remain_time = remain_time.Replace("x", String.Empty);
                                        Double timing1 = 0;

                                        if (System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator == ",")
                                        {
                                            timing1 = Math.Round(Double.Parse(remain_time.Replace(".", ",")), 2);
                                        }
                                        else
                                        {
                                            timing1 = Math.Round(Double.Parse(remain_time), 2);
                                        }

                                        Decimal timing = (decimal)timing1;
                                        Decimal total_dur_dec = Convert.ToDecimal(total_duration);
                                        Decimal total_prog_dec = Convert.ToDecimal(total_prog);
                                        Decimal remain_secs = 0;

                                        if (timing > 0)
                                        {
                                            remain_secs = (decimal)(total_dur_dec - total_prog_dec) / timing;
                                        }

                                        if (remain_secs > 60)
                                        {
                                            remain_secs = remain_secs + 60;
                                        }

                                        String remain_from_secs = String.Empty;

                                        TimeSpan t = TimeSpan.FromSeconds(Convert.ToDouble(remain_secs));
                                        remain_from_secs = string.Format("{0:D2}h:{1:D2}", t.Hours, t.Minutes);

                                        if (remain_secs >= 43200)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Math.Round(remain_secs / 3600).ToString() + " " + FFBatch.Properties.Strings.hours);
                                        }

                                        if (remain_secs >= 3600 && remain_secs < 43200)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs + " " + FFBatch.Properties.Strings.minutes_abrev);
                                        }

                                        if (remain_secs < 3600 && remain_secs >= 600)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes);
                                        }

                                        if (remain_secs < 600 && remain_secs >= 120)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes);
                                        }

                                        if (remain_secs <= 59 && remain_secs != 0)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Convert.ToInt16(remain_secs) + " " + FFBatch.Properties.Strings.seconds);
                                        }

                                        if (remain_secs <= 0)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.about_finish);
                                        }
                                    }

                                    //End remaining time

                                    if (preset_run == 2)
                                    {
                                        //Estimated size and bitrate

                                        String read_size = String.Empty;
                                        if (err_txt.Contains("size=") && (time_est_size % 3 == 0))
                                        {
                                            int size_index = err_txt.IndexOf("size=") + 5;
                                            read_size = err_txt.Substring(size_index, 8);
                                            if (Convert.ToDecimal(sec_prog) != 0)
                                            {
                                                est_bitrate = (Math.Round(Convert.ToDecimal(read_size) * 8 / Convert.ToDecimal(sec_prog), 0));
                                            }
                                            else
                                            {
                                                est_bitrate = 0;
                                            }

                                            if (Convert.ToDecimal(read_size) > 1 && time_n_tasks > 1)
                                            {
                                                if (est_bitrate < 9999)
                                                {
                                                    if (est_bitrate > 48)
                                                    {
                                                        this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " " + est_bitrate + " " + "Kb/s");
                                                    }
                                                    else
                                                    {
                                                        this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " ");
                                                    }
                                                }
                                                else
                                                {
                                                    this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " " + (Math.Round(est_bitrate / 1000, 0)) + " " + "Mb/s");
                                                }
                                                //Estimated size
                                                est_size = Convert.ToDecimal(durat_n) * est_bitrate / 8;

                                                if (est_size > 1000000)
                                                {
                                                    this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " " + (Math.Round(est_size / 1000000, 1)).ToString() + " " + "GB");
                                                }
                                                else
                                                {
                                                    if (Math.Round(est_size / 1000, 0) > 0)
                                                    {
                                                        this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " " + (Math.Round(est_size / 1000, 0)).ToString() + " " + "MB");
                                                    }
                                                    else
                                                    {
                                                        this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " ");
                                                    }
                                                }
                                            }

                                            this.InvokeEx(f => f.lbl_est_size.Refresh());
                                        }
                                    }
                                }
                            }
                        }
                        else
                        {
                            //Progress bar vp9

                            if (err_txt.ToLower().Contains("frame="))
                            {
                                int start_fps_index = err_txt.IndexOf("frame=");
                                int try_ff = 0;

                                if (int.TryParse(err_txt.Substring(start_fps_index + 6, 5), out try_ff) && fframes != 0 && fframes <= pg_lv_vp9.Maximum)
                                {
                                    this.InvokeEx(f => pg_lv_vp9.Value = try_ff);
                                    this.InvokeEx(f => pg_lv_vp9.Text = (try_ff * 100 / fframes).ToString() + "%");
                                    this.InvokeEx(f => pg_lv_vp9.Refresh());
                                    //this.InvokeEx(f => pg_lv.Value = try_ff * 100 / fframes / 2);
                                    this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = (try_ff * 100 / fframes / 2).ToString() + "%");
                                    //this.InvokeEx(f => pg_lv.Refresh());
                                }
                                else
                                {
                                    this.InvokeEx(f => pg_lv_vp9.Value = 0);
                                }
                                //End Progress bar
                            }
                        }
                    }
                    process_glob.WaitForExit();
                    process_glob.StartInfo.Arguments = String.Empty;
                    this.InvokeEx(f => pg_lv_vp9.Dispose());
                    timer_est_size.Stop();
                    time_est_size = 0;
                    this.InvokeEx(f => lbl_speed.Text = String.Empty);
                    //if (preset_run == 1)
                    //{
                    //    //this.InvokeEx(f => pg_lv.Visible = false);
                    //    //this.InvokeEx(f => pg_lv.Dispose());
                    //}
                    if (preset_run == 2)
                    {
                        this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = "50%");
                        //this.InvokeEx(f => pg_lv.Refresh());
                    }

                    this.InvokeEx(f => f.lbl_est_size.Text = String.Empty);
                    this.InvokeEx(f => f.lbl_bitrate.Text = String.Empty);

                    list_lines.Add("");
                    list_lines.Add("---------------------End of " + Path.GetFileName(file) + " log-------------------------------");
                    list_lines.Add("");

                    if (preset_run == 2)
                    {
                        this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = "100%");
                        //this.InvokeEx(f => pg_lv.Visible = false);
                        if (process_glob.ExitCode == 0)
                        {
                            if (skipped == false)
                            {
                                this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.success);
                                //this.InvokeEx(f => f.listView1.Items[list_index].BackColor = listView1.BackColor);
                            }
                            else
                            {
                                this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.skipped);
                                total_prog = (total_prog + durat_n - sec_prog) / n_multi_presets;
                                skipped = false;
                            }
                        }
                        else
                        {
                            this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.error);
                            this.InvokeEx(f => f.listView1.Items[list_index].BackColor = Color.PaleGoldenrod);
                            total_prog = total_prog + durat_n - sec_prog;
                        }
                        preset_run = 1;
                        list_index = list_index + 1;
                    }
                    else
                    {
                        if (process_glob.ExitCode != 0)
                        {
                            this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.error);
                            this.InvokeEx(f => f.listView1.Items[list_index].BackColor = Color.PaleGoldenrod);
                            total_prog = total_prog + durat_n - sec_prog;
                            list_index = list_index + 1;
                            preset_run = 1;
                        }
                        if (process_glob.ExitCode == 0)
                        {
                            if (skipped == false)
                            {
                                this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = "50%");
                                preset_run = 2;
                            }
                            else
                            {
                                this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.skipped);
                                total_prog = (total_prog + durat_n - sec_prog) / n_multi_presets;
                                skipped = false;
                                list_index = list_index + 1;
                                preset_run = 1;
                            }
                        }
                    }

                    if (list_index == listView1.Items.Count)
                    {
                        this.InvokeEx(f => f.lbl_multip.Visible = false);
                        //this.InvokeEx(f => pg_lv.Visible = false);
                        //this.InvokeEx(f => pg_lv.Dispose());
                        runnin_n_presets = false;
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        this.InvokeEx(f => f.Pg1.Value = 100);
                        this.InvokeEx(f => f.Pg1.Text = "100%");
                        working = false;
                        timer_est_size.Stop();
                        time_est_size = 0;

                        if (no_save_logs == false)
                        {
                            //Save log
                            string[] array_err = list_lines.ToArray();
                            String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                            if (is_portable == true) path = port_path + "ff_batch_portable.log";

                            System.IO.StreamWriter SaveFile = new System.IO.StreamWriter(path);
                            SaveFile.WriteLine("FFmpeg log sesion: " + System.DateTime.Now);
                            SaveFile.WriteLine("-------------------------------");
                            foreach (String item in array_err)
                            {
                                SaveFile.WriteLine(item);
                            }
                            SaveFile.Close();

                            File.AppendAllText(path, "-----------------------");
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.end_log + Environment.NewLine);
                            File.AppendAllText(path, "-----------------------");
                            System.IO.FileInfo fileInfo = new System.IO.FileInfo(path);

                            var bytes = fileInfo.Length;

                            var kilobytes = (double)bytes / 1024;
                            var megabytes = kilobytes / 1024;
                            var gigabytes = megabytes / 1024;

                            //Format size view
                            String size = "";
                            String separator = ".";

                            if (bytes > 1000000000)
                            {
                                if (gigabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String gigas = gigabytes.ToString();
                                if (gigas.Length >= 5)
                                {
                                    gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                                    size = (gigas + " " + "GB");
                                }
                                else
                                {
                                    size = (gigas + " " + "GB");
                                }
                            }

                            if (bytes >= 1048576 && bytes <= 1000000000)
                            {
                                if (megabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }
                                String megas = megabytes.ToString();
                                if (megas.Length > 5)
                                {
                                    megas = megas.Substring(0, megas.LastIndexOf(separator));
                                    size = (megas + " " + "MB");
                                }
                                else
                                {
                                    size = (megas + " " + "MB");
                                }
                            }

                            if (bytes >= 1024 && bytes < 1048576)

                            {
                                if (kilobytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String kbs = kilobytes.ToString();
                                if (kbs.Length >= 5)
                                {
                                    kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                                    size = (kbs + " " + "KB");
                                }
                                else
                                {
                                    size = (kbs + " " + "KB");
                                }
                            }
                            if (bytes > -1 && bytes < 1024)
                            {
                                String bits = bytes.ToString();
                                size = (bits + " Bytes");
                            }

                            //End Format size view
                            timer_tasks.Stop();
                            TimeSpan t = TimeSpan.FromSeconds(time_n_tasks);
                            String tx_elapsed = string.Format("{0:D2}h:{1:D2}m:{2:D2}s",
                                t.Hours,
                                t.Minutes,
                                t.Seconds);
                            File.AppendAllText(path, Environment.NewLine);
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.total_time + " " + tx_elapsed);
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.log_size + " " + size);
                            //End save log
                        }

                        //Automatic shutdown check

                        if (chkshut.Checked && cancel_queue == false)
                        {
                            auto_shut();
                            return;
                        }
                        //End shutdown check
                        else
                        {
                            if (cancel_queue == false)
                            {
                                if (chk_delete_source.CheckState == CheckState.Checked)
                                {
                                    Disable_Controls();
                                    System.Threading.Thread.Sleep(500);
                                    list_proc.Items.Clear();
                                    listView1.Invoke(new MethodInvoker(delegate
                                    {
                                        foreach (ListViewItem item in listView1.Items)
                                        {
                                            list_proc.Items.Add((ListViewItem)item.Clone());
                                        }
                                    }));

                                    Label prog_txt = new Label();
                                    this.InvokeEx(f => prog_txt.Parent = panel1);
                                    this.InvokeEx(f => prog_txt.Top = 95);
                                    this.InvokeEx(f => prog_txt.Left = 80);
                                    this.InvokeEx(f => prog_txt.Width = 250);
                                    this.InvokeEx(f => prog_txt.TabIndex = 1);
                                    this.InvokeEx(f => prog_txt.BackColor = panel1.BackColor);
                                    this.InvokeEx(f => prog_txt.BorderStyle = BorderStyle.None);
                                    this.InvokeEx(f => prog_txt.TextAlign = ContentAlignment.MiddleLeft);
                                    this.InvokeEx(f => prog_txt.BringToFront());
                                    this.InvokeEx(f => prog_txt.Text = FFBatch.Properties.Strings.to_recycle);

                                    ProgressBar pg_del = new ProgressBar();
                                    this.InvokeEx(f => pg_del.Parent = panel1);
                                    this.InvokeEx(f => pg_del.Top = 98);
                                    this.InvokeEx(f => pg_del.Left = 315);
                                    this.InvokeEx(f => pg_del.Width = 302);
                                    this.InvokeEx(f => pg_del.Height = 15);
                                    this.InvokeEx(f => pg_del.TabIndex = 0);
                                    this.InvokeEx(f => pg_del.BackColor = this.BackColor);
                                    this.InvokeEx(f => pg_del.Minimum = 0);
                                    this.InvokeEx(f => pg_del.BringToFront());
                                    this.InvokeEx(f => pg_del.Maximum = list_proc.Items.Count);
                                    this.InvokeEx(f => pg_del.Show());
                                    this.InvokeEx(f => pg_del.Refresh());
                                    int i = 0;
                                    int err = 0;

                                    foreach (ListViewItem item in list_proc.Items)
                                    {
                                        if (item.SubItems[5].Text == FFBatch.Properties.Strings.success)
                                        {
                                            try
                                            {
                                                FileSystem.DeleteFile(item.SubItems[1].Text + "\\" + item.Text, UIOption.OnlyErrorDialogs, RecycleOption.SendToRecycleBin);
                                                this.InvokeEx(f => pg_del.Value = i);
                                                i = i + 1;
                                            }
                                            catch
                                            {
                                                err = err + 1;
                                            }

                                            this.InvokeEx(f => prog_txt.Text = FFBatch.Properties.Strings.to_recycle + i.ToString() + " " + FFBatch.Properties.Strings.of1 + " " + list_proc.Items.Count);
                                            this.InvokeEx(f => prog_txt.Refresh());
                                        }
                                    }
                                    this.InvokeEx(f => prog_txt.Visible = false);
                                    this.InvokeEx(f => prog_txt.Dispose());
                                    this.InvokeEx(f => pg_del.Visible = false);
                                    this.InvokeEx(f => pg_del.Dispose());
                                    Enable_Controls();

                                    if (err > 0) MessageBox.Show(err.ToString() + " " + FFBatch.Properties.Strings.not_recycled2, FFBatch.Properties.Strings.not_recycled3, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);

                                    Boolean all_ok = true;
                                    foreach (ListViewItem item in list_proc.Items)
                                    {
                                        if (item.SubItems[5].Text != FFBatch.Properties.Strings.success)
                                        {
                                            all_ok = false;
                                            break;
                                        }
                                    }
                                    if (all_ok == true)
                                    {
                                        this.InvokeEx(f => f.btn_refresh.PerformClick());
                                    }
                                }

                                if (play_on_end == true) play_end();
                                if (Form.ActiveForm == null)
                                {
                                    notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.enc_comp;
                                    notifyIcon1.BalloonTipIcon = ToolTipIcon.Info;
                                    notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.enc_comp2;
                                    notifyIcon1.ShowBalloonTip(0);
                                }

                                if (chk_open_compl.Checked)
                                {
                                    if (Directory.GetFiles(destino).Length != 0)
                                    {
                                        Process open_processed = new Process();
                                        open_processed.StartInfo.FileName = "explorer.exe";
                                        open_processed.StartInfo.Arguments = '\u0022' + destino + '\u0022';
                                        open_processed.Start();
                                    }
                                    else
                                    {
                                        if (Directory.Exists(destino))
                                        {
                                            System.IO.Directory.Delete(destino);
                                        }
                                    }
                                }
                            }
                            else
                            {
                                this.InvokeEx(f => f.Pg1.Text = "100%");
                                this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.aborted, MessageBoxButtons.OK, MessageBoxIcon.Error));
                            }
                        }
                    }
                }

                this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                Enable_Controls();
            }).Start();
        }

        private void check_res()
        {
            SystemEvents.DisplaySettingsChanged += new EventHandler(SystemEvents_DisplaySettingsChanged);

            foreach (Control ct1 in this.Controls)
            {
                points.Add(ct1.Name, new Point(ct1.Left, ct1.Top));
            }
            foreach (Control ct1 in this.Controls)
            {
                sizes.Add(ct1.Name, new Size(ct1.Width, ct1.Height));
            }

            Rectangle resolution = Screen.PrimaryScreen.Bounds;
            if (resolution.Width > 1366 && resolution.Height > 768)
            {
                big_res = true;
                this.Width = this.Width + 30;
                foreach (Control ct in this.Controls)
                {
                    ct.Left = ct.Left + 15;
                }
                this.Height = this.Height + 25;
                foreach (Control ct in this.Controls)
                {
                    ct.Top = ct.Top + 6;
                }

                group_prog.Height = group_prog.Height + 6;

                foreach (Control ct in group_prog.Controls)
                {
                    ct.Top = ct.Top + 3;
                }
                pic_title.Top = pic_title.Top - 9;
                change_ff.Top = change_ff.Top - 9;
                btn_clear_list.Left = btn_clear_list.Left - 2;
                btn_add_files.Left = btn_add_files.Left - 2;
                tabControl1.Left = tabControl1.Left + 2;
                tabControl1.Width = tabControl1.Width - 2;
            }
            else
            {
                big_res = false;
            }
        }

        private void SystemEvents_DisplaySettingsChanged(object sender, EventArgs e)
        {
            //Rectangle resolution = Screen.PrimaryScreen.Bounds;
            //if (resolution.Width <= 1366 && resolution.Height <= 800 && big_res == true)
            //{
            //this.Width = this.Width - 20;
            //this.Height = this.Height - 30;
            //groupBox5.Height = groupBox5.Height - 6;
            //groupBox10.Height = groupBox10.Height - 6;
            //pictureBox1.Top = pictureBox1.Top + 9;
            //change_ff.Top = change_ff.Top + 9;
            //button5.Left = button5.Left + 2;
            //button1.Left = button1.Left + 2;
            //foreach (Control ct in groupBox5.Controls)
            //{
            //ct.Top = ct.Top -3;
            //}
            //foreach (Control ct in groupBox10.Controls)
            //{
            //ct.Top = ct.Top - 3;
            //}

            //foreach (Control ct2 in this.Controls)
            //{
            //ct2.Left = points[ct2.Name].X;
            //ct2.Top = points[ct2.Name].Y;
            //ct2.Width = sizes[ct2.Name].Width;
            //ct2.Height = sizes[ct2.Name].Height;
            //}

            //big_res = false;
            //}

            //if (resolution.Width >= 1366 && resolution.Height >= 800 && big_res == false)
            //{
            //this.Width = this.Width + 30;
            //foreach (Control ct in this.Controls)
            //{
            //ct.Left = ct.Left + 15;
            //
            //}
            //this.Height = this.Height + 30;
            //foreach (Control ct in this.Controls)
            //{
            //ct.Top = ct.Top + 12;
            //}
            //groupBox5.Height = groupBox5.Height + 6;
            //groupBox10.Height = groupBox10.Height + 6;
            //foreach (Control ct in groupBox5.Controls)
            //{
            //ct.Top = ct.Top + 3;
            //}
            //foreach (Control ct in groupBox10.Controls)
            //{
            //ct.Top = ct.Top + 3;
            //}
            //pictureBox1.Top = pictureBox1.Top - 9;
            //change_ff.Top = change_ff.Top - 9;
            //button5.Left = button5.Left - 2;
            //button1.Left = button1.Left - 2;
            //big_res = true;
            //}
        }

        private void check_back_updates()
        {
            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;
                Thread.Sleep(500);
                String current_ver = btn_update.Text;

                String content2 = String.Empty;
                try
                {
                    WebClient client = new WebClientWithTimeout();
                    Stream stream = client.OpenRead(down_ver);
                    StreamReader reader = new StreamReader(stream);
                    String content = reader.ReadToEnd();
                    content2 = content;
                }
                catch
                {
                    try
                    {
                        //Backup server
                        WebClient client = new WebClientWithTimeout();
                        Stream stream = client.OpenRead(down_ver2);
                        StreamReader reader = new StreamReader(stream);
                        String content = reader.ReadToEnd();
                        content2 = content;
                    }
                    catch
                    {
                        this.InvokeEx(f => f.lbl_updates.Text = FFBatch.Properties.Strings.up_err);
                        this.InvokeEx(f => f.lbl_updates.Cursor = Cursors.Hand);
                        this.InvokeEx(f => f.btn_update.Text = current_ver);
                        return;
                    }
                }

                try
                {
                    if (Convert.ToInt16(content2.Replace(".", String.Empty).Substring(0, 3)) > Convert.ToInt16(Application.ProductVersion.Replace(".", String.Empty)))
                    {
                        this.InvokeEx(f => f.lbl_updates.Text = Properties.Strings2.version + " " + content2.Substring(0, 5) + " " + FFBatch.Properties.Strings.available);
                        this.InvokeEx(f => f.lbl_updates.Cursor = Cursors.Hand);
                        String f_skip_ver = String.Empty;
                        if (is_portable == false)
                        {
                            f_skip_ver = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_skip_ver.ini";
                        }
                        else
                        {
                            f_skip_ver = port_path + "ff_skip_ver_portable.ini";
                        }
                        if (File.Exists(f_skip_ver))
                        {
                            String skipped_ver = File.ReadAllText(f_skip_ver);
                            if (skipped_ver == content2.Substring(0, 5)) return;
                        }
                        this.InvokeEx(f => this.Enabled = false);
                        Form21 frm21 = new Form21();
                        frm21.lbl_ver.Text = Properties.Strings2.version + " " + content2.Substring(0, 5);
                        frm21.textBox1.Text = content2.Substring(6, content2.Length - 6);
                        frm21.ShowDialog();
                        this.InvokeEx(f => this.Enabled = true);
                        this.InvokeEx(f => this.TopMost = true);
                        this.InvokeEx(f => this.TopMost = false);
                        if (frm21.cancel == false && frm21.update == true && frm21.skip_ver == false)
                        {
                            try
                            {
                                File.Delete(f_skip_ver);
                            }
                            catch { }

                            Process.Start("https://sourceforge.net/p/ffmpeg-batch/wiki");
                        }
                        if (frm21.cancel == false && frm21.update == false && frm21.skip_ver == true)
                        {
                            try
                            {
                                File.WriteAllText(f_skip_ver, content2.Substring(0, 5));
                            }
                            catch (Exception excpt)
                            {
                                MessageBox.Show(FFBatch.Properties.Strings.skip_err + Environment.NewLine + Environment.NewLine + excpt.Message, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            }
                        }
                    }
                }
                catch (Exception excpt)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.err_check + Environment.NewLine + Environment.NewLine + excpt.Message, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                }

                this.InvokeEx(f => f.btn_update.Text = current_ver);
            }).Start();
        }

        private void check_internet()
        {
            internet_up = true;

            System.Threading.Thread.CurrentThread.IsBackground = true;
            String current_ver = btn_update.Text;

            String content2 = String.Empty;
            try
            {
                WebClient client = new WebClientWithTimeout();
                Stream stream = client.OpenRead("http://google.com/generate_204");
                StreamReader reader = new StreamReader(stream);
                String content = reader.ReadToEnd();
                content2 = content;
            }
            catch
            {
                try
                {
                    //Backup server
                    WebClient client = new WebClientWithTimeout();
                    Stream stream = client.OpenRead("http://www.baidu.com/baidu.html?from=noscript");
                    StreamReader reader = new StreamReader(stream);
                    String content = reader.ReadToEnd();
                    content2 = content;
                }
                catch
                {
                    DialogResult a = MessageBox.Show(FFBatch.Properties.Strings.err_connect, FFBatch.Properties.Strings.err_con2, MessageBoxButtons.OKCancel, MessageBoxIcon.Warning);
                    if (a == DialogResult.OK) internet_up = true;
                    else internet_up = false;
                }
            }
        }

        private void sort_size_lv1()
        {
            //Create sortable size listview

            listView1.BeginUpdate();
            foreach (ListViewItem item in listView1.Items)
            {
                if (File.Exists(item.Text))
                {
                    FileInfo fi = new FileInfo(item.Text);
                    item.SubItems[3].Text = fi.Length.ToString("D13");
                }
                else
                {
                    item.SubItems[3].Text = "0000000000000";
                }
            }

            listView1.EndUpdate();
            lvwColumnSorter_Full.SortColumn = 3;
            lvwColumnSorter_Full.Order = SortOrder.Descending;
            listView1.Sort();
            this.Cursor = Cursors.Arrow;
            foreach (ListViewItem item in listView1.Items)
            {
                //Format size view
                var bytes = long.Parse(item.SubItems[3].Text);

                var kilobytes = (double)bytes / 1024;
                var megabytes = kilobytes / 1024;
                var gigabytes = megabytes / 1024;

                String size = "";

                String separator = System.Globalization.CultureInfo.CurrentUICulture.NumberFormat.NumberDecimalSeparator;

                if (bytes > 1000000000)
                {
                    String gigas = gigabytes.ToString();
                    if (gigas.Length >= 5)
                    {
                        gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                        size = (gigas + " " + "GB");
                    }
                    else
                    {
                        size = (gigas + " " + "GB");
                    }
                }

                if (bytes >= 1048576 && bytes <= 1000000000)
                {
                    String megas = megabytes.ToString();
                    if (megas.Length > 5)
                    {
                        megas = megas.Substring(0, megas.LastIndexOf(separator) + 2);
                        size = (megas + " " + "MB");
                    }
                    else
                    {
                        size = (megas + " " + "MB");
                    }
                }

                if (bytes >= 1024 && bytes < 1048576)

                {
                    String kbs = kilobytes.ToString();
                    if (kbs.Length >= 5)
                    {
                        kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                        size = (kbs + " " + "KB");
                    }
                    else
                    {
                        size = (kbs + " " + "KB");
                    }
                }
                if (bytes > -1 && bytes < 1024)
                {
                    String bits = bytes.ToString();
                    size = (bits + " Bytes");
                }
                item.SubItems[3].Text = size;

                //End Format size view
            }
        }

        private void clone_lv_grid()
        {
            if (listView1.Items.Count == 0) return;
            clonegrid.Rows.Clear();
            int ni = listView1.Items.Count * 2;
            int nl = listView1.Items.Count;
            if (listView1.Items.Count > 1000)
            {
                pg_adding.Value = 0;
                pg_adding.Visible = true;
                pg_adding.Maximum = listView1.Items.Count * 2;
                LB_Wait.Visible = true;
                txt_adding_p.Visible = true;
                LB_Wait.Text = FFBatch.Properties.Strings.sort_list;
            }

            listView1.BeginUpdate();

            for (int i = 0; i < listView1.Items.Count; i++)
            {
                if (nl > 1000)
                {
                    pg_adding.Value = pg_adding.Value + 1;
                    txt_adding_p.Text = (pg_adding.Value * 100 / ni).ToString() + "%";
                    txt_adding_p.Refresh();
                    LB_Wait.Refresh();
                    pg_adding.Refresh();
                }

                FileInfo fi = new FileInfo(listView1.Items[i].Text);

                if (File.Exists(listView1.Items[i].Text))
                {
                    clonegrid.Rows.Add(listView1.Items[i].Text, listView1.Items[i].SubItems[1].Text, listView1.Items[i].SubItems[3].Text, fi.Length, listView1.Items[i].SubItems[5].Text);
                }
                else
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file + " " + listView1.Items[i].Text + Environment.NewLine + FFBatch.Properties.Strings.not_found1, FFBatch.Properties.Strings.missing1, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    this.Cursor = Cursors.Arrow;
                    pg_adding.Visible = false;
                    txt_adding_p.Visible = false;
                    pg_adding.Value = 0;
                    LB_Wait.Text = String.Empty;
                    listView1.EndUpdate();
                    return;
                }
            }
            if (size_sorted == false)
            {
                size_sorted = true;
                this.clonegrid.Sort(this.clonegrid.Columns[FFBatch.Properties.Strings.size], ListSortDirection.Descending);
            }
            else
            {
                size_sorted = false;
                this.clonegrid.Sort(this.clonegrid.Columns[FFBatch.Properties.Strings.size], ListSortDirection.Ascending);
            }

            Type ts = Type.GetTypeFromProgID("Shell.Application");
            dynamic shell = Activator.CreateInstance(ts);
            int files_to_add = listView1.Items.Count;
            ListViewItem[] itemsToAdd = new ListViewItem[listView1.Items.Count];
            listView1.Items.Clear();

            for (int n = 0; n < files_to_add; n++)
            {
                if (nl > 1000)
                {
                    pg_adding.Value = pg_adding.Value + 1;
                    pg_adding.Refresh();
                    LB_Wait.Text = FFBatch.Properties.Strings.sort_list;
                    txt_adding_p.Text = (pg_adding.Value * 100 / ni).ToString() + "%";
                    txt_adding_p.Refresh();
                }

                Icon iconForFile = SystemIcons.WinLogo;

                if (!imageList2.Images.ContainsKey(System.IO.Path.GetExtension(clonegrid.Rows[n].Cells[1].Value.ToString())))
                {
                    iconForFile = System.Drawing.Icon.ExtractAssociatedIcon(clonegrid.Rows[n].Cells[1].Value.ToString());
                    this.InvokeEx(f => f.imageList2.Images.Add(System.IO.Path.GetExtension(clonegrid.Rows[n].Cells[1].Value.ToString()), iconForFile));
                }

                itemsToAdd[n] = new ListViewItem(clonegrid.Rows[n].Cells[1].Value.ToString());
                itemsToAdd[n].ImageKey = System.IO.Path.GetExtension(clonegrid.Rows[n].Cells[1].Value.ToString());

                Folder rFolder = shell.NameSpace(Path.GetDirectoryName(clonegrid.Rows[n].Cells[1].Value.ToString()));
                FolderItem rFiles = rFolder.ParseName(System.IO.Path.GetFileName(clonegrid.Rows[n].Cells[1].Value.ToString()));
                String FileSize = rFolder.GetDetailsOf(rFiles, 1).Trim();
                itemsToAdd[n].SubItems.Add(clonegrid.Rows[n].Cells[2].Value.ToString());
                itemsToAdd[n].SubItems.Add(clonegrid.Rows[n].Cells[3].Value.ToString());
                itemsToAdd[n].SubItems.Add(FileSize);
                itemsToAdd[n].SubItems.Add(clonegrid.Rows[n].Cells[5].Value.ToString());
            }
            listView1.Items.AddRange(itemsToAdd.ToArray());
            listView1.EndUpdate();
            pg_adding.Visible = false;
            txt_adding_p.Visible = false;
            pg_adding.Value = 0;
            LB_Wait.Text = String.Empty;
        }

        private void abort_view1()
        {
            Pg1.Focus();
            if (is_portable == false) this.Text = "FFmpeg Batch AV Converter";
            else this.Text = "FFmpeg Batch AV Converter Portable";
            if (recording_scr == true)
            {
                working = false;
                recording_scr = false;
                StreamWriter write_q = process_glob.StandardInput;
                write_q.Write("q");
                this.InvokeEx(f => f.pic_recording.Visible = false);
                Enable_Controls();
                return;
            }
            if (working == false)
            {
                int num = 0;
                Process[] localByName = Process.GetProcessesByName("ffmpeg");
                num = localByName.Length;
                if (num > 0 && localByName[0].Id == ff_ver_proc) return;

                if (num > 0)
                {
                    var a = MessageBox.Show(FFBatch.Properties.Strings.ff_running, FFBatch.Properties.Strings.ff_run2, MessageBoxButtons.YesNo, MessageBoxIcon.Warning);
                    if (a == DialogResult.Yes)
                    {
                        foreach (Process p in localByName)
                        {
                            try
                            {
                                p.Kill();
                            }
                            catch
                            {
                                MessageBox.Show(FFBatch.Properties.Strings.err_close_procs + "ID" + " " + p.Id, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            }
                        }
                    }
                }
                cancelados_paralelos = true;
                return;
            }
            working = false;
            btn_abort_all.Enabled = false;
            lbl_multip.Visible = false;
            runnin_n_presets = false;

            if (multi_running == true)
            {
                timer_aborting.Start();
                working = false;
                multi_running = false;
                aborted = true;
                cancelados_paralelos = true;

                foreach (ListViewItem item in listView1.Items)
                {
                    if (item.SubItems[5].Text != FFBatch.Properties.Strings.success && item.SubItems[5].Text != FFBatch.Properties.Strings.ready && item.SubItems[5].Text != FFBatch.Properties.Strings.queued && item.SubItems[5].Text != FFBatch.Properties.Strings.replaced && item.SubItems[5].Text != FFBatch.Properties.Strings.renamed && item.SubItems[5].Text != FFBatch.Properties.Strings.deleted && item.SubItems[5].Text != FFBatch.Properties.Strings.not_renamed && item.SubItems[5].Text != FFBatch.Properties.Strings.recycled && item.SubItems[5].Text != FFBatch.Properties.Strings.not_recycled && item.SubItems[5].Text != FFBatch.Properties.Strings.not_deleted)
                    {
                        item.SubItems[5].Text = FFBatch.Properties.Strings.aborting;
                    }
                }

                foreach (Process proc in procs.Values)
                {
                    cancelados_paralelos = true;
                    if (proc.StartInfo.Arguments != String.Empty)

                    {
                        try
                        {
                            StreamWriter write_q = proc.StandardInput;
                            write_q.Write("q");
                        }
                        catch (Exception exc)
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + exc.Message + " " + FFBatch.Properties.Strings.some_procs, FFBatch.Properties.Strings.abort_inc, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        }
                    }
                }
                return;
            }

            if (process_glob.StartInfo.Arguments != String.Empty)
            {
                try
                {
                    process_glob.Kill();
                    aborted = true;
                    working = false;
                }
                catch { }
            }
            else
            {
                MessageBox.Show(FFBatch.Properties.Strings.not_abort, FFBatch.Properties.Strings.abort_inc, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            cancel_queue = true;
            cancelados_paralelos = true;

            if (process_glob.StartInfo.Arguments != String.Empty)
            {
                StreamWriter write_q = process_glob.StandardInput;
                write_q.Write("q");
                return;
            }
        }

        private void init_lang()
        {
            Thread.CurrentThread.CurrentUICulture = new CultureInfo(FFBatch.Properties.Settings.Default.app_lang);
            Thread.CurrentThread.CurrentCulture = new CultureInfo(FFBatch.Properties.Settings.Default.app_lang);
            System.ComponentModel.ComponentResourceManager resources = new System.ComponentModel.ComponentResourceManager(typeof(Form1));
            RefreshResources(this, resources);
            post_lang();

            combo_prio.Items.Clear();
            combo_prio.Items.Add(FFBatch.Properties.Strings.High);
            combo_prio.Items.Add(FFBatch.Properties.Strings.Above_normal);
            combo_prio.Items.Add(FFBatch.Properties.Strings.Normal);
            combo_prio.Items.Add(FFBatch.Properties.Strings.Below_normal);
            combo_prio.Items.Add(FFBatch.Properties.Strings.Idle);
            combo_presets.Text = Properties.Strings.default_param;

            btn_update.Text = Properties.Strings2.version + " " + Application.ProductVersion;
            load_priority();
            remember_tab();
            resize();
        }

        private void get_frame()
        {
            //Attempt to extract frame as image

            DateTime time2;
            Double seconds = 0;
            if (tabControl1.SelectedIndex == 0)
            {
                if (!DateTime.TryParse(listView1.SelectedItems[0].SubItems[3].Text, out time2)) current_fr = 0;
            }
            if (tabControl1.SelectedIndex == 1)
            {
                if (!DateTime.TryParse(listView1.Items[listView2.SelectedItems[0].Index].SubItems[3].Text, out time2)) current_fr = 0;
            }

            String file_img = "";
            if (tabControl1.SelectedIndex == 0) file_img = Path.GetFullPath(listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text);
            if (tabControl1.SelectedIndex == 1) file_img = Path.GetFullPath(listView2.SelectedItems[0].Text);

            try
            {
                Task t = Task.Run(() =>
            {
                String time_frame = "";
                Double t_to = (double)current_fr;
                TimeSpan t1 = TimeSpan.FromMilliseconds((t_to));
                String tx_1 = string.Format("{0:D2}:{1:D2}:{2:D2}.{3:D3}",
                             (int)t1.TotalHours,
                             t1.Minutes,
                             t1.Seconds,
                             t1.Milliseconds);
                time_frame = tx_1;
                String repl_frm = time_frame.Replace(",", "").Replace(".", "").Replace(":", "");

                Process proc_img = new System.Diagnostics.Process();
                String ffm_img = Path.Combine(Application.StartupPath, "ffmpeg.exe");
                String fullPath_img = file_img;
                String AppParam_img = "";
                String destino = Path.Combine(Path.GetTempPath(), "FFBatch_test");

                String rel_path = Path.GetDirectoryName(file_img).Replace(":", "_").Replace("\\", "_") + Path.GetExtension(file_img).Replace(".", "_");
                String target_img = Path.GetTempPath() + "FFBatch_Test" + "\\" + Path.GetFileNameWithoutExtension(file_img) + "_480_" + rel_path + "_" + repl_frm + "." + "jpg";

                if (File.Exists(target_img))
                {
                    Image img_tmp;
                    using (var bmpTemp = new Bitmap(target_img))
                    {
                        img_tmp = new Bitmap(bmpTemp);
                        pic_frame.Invoke(new MethodInvoker(delegate
                        {
                            pic_frame.Image = img_tmp;
                        }));
                        return;
                    }
                }

                AppParam_img = " -ss " + time_frame + " -i " + "" + '\u0022' + file_img + '\u0022' + " -qscale:v 0" + " -vf scale=480:-1" + " -f image2 -y " + '\u0022' + target_img + '\u0022';

                proc_img.StartInfo.RedirectStandardOutput = false;
                proc_img.StartInfo.RedirectStandardError = false;
                proc_img.StartInfo.UseShellExecute = true;
                proc_img.StartInfo.CreateNoWindow = false;
                proc_img.EnableRaisingEvents = false;
                proc_img.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;

                proc_img.StartInfo.FileName = ffm_img;
                proc_img.StartInfo.Arguments = AppParam_img;

                proc_img.Start();
                proc_img.WaitForExit(2000);

                try
                {
                    Image img_tmp1;

                    using (var bmpTemp = new Bitmap(target_img))
                    {
                        img_tmp1 = new Bitmap(bmpTemp);
                        pic_frame.Invoke(new MethodInvoker(delegate
                        {
                            pic_frame.Image = img_tmp1;
                        }));
                    }
                }
                catch { }
            });
            }
            catch { }
        }

        private void get_all_thumbs()
        {
            int items = 10;
            if (listView1.Items.Count < 10) items = listView1.Items.Count;
            Task t = Task.Run(() =>
            {
                try
                {
                    for (int i = 0; i < items; i++)
                    {
                        String file_img = "";

                        listView1.Invoke(new MethodInvoker(delegate
                        {
                            try
                            {
                                file_img = Path.GetFullPath(listView1.Items[i].SubItems[1].Text + "\\" + listView1.Items[i].Text);
                            }
                            catch { }
                        }));

                        Decimal time_frame = Math.Round((decimal)current_fr, 0);
                        Process proc_img = new System.Diagnostics.Process();
                        String ffm_img = Path.Combine(Application.StartupPath, "ffmpeg.exe");
                        String fullPath_img = file_img;
                        String AppParam_img = "";
                        String destino = Path.Combine(Path.GetTempPath(), "FFBatch_test");
                        String extracted_img = destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_img) + "_480_" + time_frame.ToString() + "." + "jpg";

                        if (File.Exists(extracted_img)) continue;

                        AppParam_img = " -ss " + time_frame + " -i " + '\u0022' + file_img + '\u0022' + " -qscale:v 2" + " -vf scale=480:-1" + " -f image2 -y " + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_img) + "_480_" + time_frame.ToString() + "." + "jpg" + '\u0022';

                        proc_img.StartInfo.RedirectStandardOutput = false;
                        proc_img.StartInfo.RedirectStandardError = false;
                        proc_img.StartInfo.UseShellExecute = true;
                        proc_img.StartInfo.CreateNoWindow = false;
                        proc_img.EnableRaisingEvents = false;
                        proc_img.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;

                        proc_img.StartInfo.FileName = ffm_img;
                        proc_img.StartInfo.Arguments = AppParam_img;

                        proc_img.Start();
                        Thread.Sleep(50);
                        proc_img.PriorityClass = ProcessPriorityClass.BelowNormal;
                        proc_img.WaitForExit();
                    }
                }
                catch { }
            });
        }

        private void main_progress_bar()
        {
            Pg1.Parent = group_prog;
            Pg1.Value = 0;
            Pg1.Top = 30;
            //if (Properties.Settings.Default.app_lang == "es") Pg1.Top = group_prog.Height - 50;
            Pg1.Left = 261;
            Pg1.Width = 743;
            Pg1.Height = 21;
            Pg1.Value = 0;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            Pg1.Show();
        }

        private void Form1_Load(object sender, EventArgs e)
        {
            main_progress_bar();

            String app_location = Application.StartupPath;
            String portable_flag = Application.StartupPath + "\\" + "portable.ini";
            if (File.Exists(portable_flag))
            {
                is_portable = true;
                this.Text = "FFmpeg Batch AV Converter Portable";
                if (!Directory.Exists(Path.Combine(Application.StartupPath, "settings")))
                {
                    try
                    {
                        Directory.CreateDirectory(Path.Combine(Application.StartupPath, "settings"));
                        reset_portable();
                    }
                    catch (Exception excpt)
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.err_port + Environment.NewLine + excpt.Message, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
            }
            else is_portable = false;

            pic_pause.Image = btn_pause.Image;
            listView1.OwnerDraw = true;
            listView3.OwnerDraw = true;

            typeof(DataGridView).InvokeMember(
            "DoubleBuffered", BindingFlags.NonPublic | BindingFlags.Instance | BindingFlags.SetProperty,
            null, listView1, new object[] { true });
            typeof(DataGridView).InvokeMember(
            "DoubleBuffered", BindingFlags.NonPublic | BindingFlags.Instance | BindingFlags.SetProperty,
            null, listView3, new object[] { true });

            clonegrid.Columns.Add(FFBatch.Properties.Strings.filename, String.Empty);
            clonegrid.Columns.Add("Media type", String.Empty);
            clonegrid.Columns.Add(FFBatch.Properties.Strings.duration, String.Empty);
            clonegrid.Columns.Add(FFBatch.Properties.Strings.size, String.Empty);
            clonegrid.Columns.Add(FFBatch.Properties.Strings.status, String.Empty);
            clonegrid.AllowUserToAddRows = false;

            if (!Directory.Exists(Path.Combine(Path.GetTempPath(), "FFBatch_test")))
            {
                try
                {
                    Directory.CreateDirectory(Path.Combine(Path.GetTempPath(), "FFBatch_test"));
                    watch_other_instance.Path = Path.Combine(Path.GetTempPath(), "FFBatch_test");
                }
                catch (Exception excpt)
                {
                    watch_other_instance.Path = String.Empty;
                    MessageBox.Show(Properties.Strings2.err_write_temp + Environment.NewLine + Environment.NewLine + excpt.Message);
                }
            }
            else
            {
                watch_other_instance.Path = Path.Combine(Path.GetTempPath(), "FFBatch_test");
            }

            this.MainMenuStrip = main_menu;
            this.Cursor = Cursors.WaitCursor;

            read_main_config();

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;

                foreach (String item in Combo_sub_lang_mux.Items)
                {
                    Combo_single_subs_lang.Items.Add(item);
                    ct3_combo_language.Items.Add(item);
                    combo_item_lang_2.Items.Add(item);
                }
            }).Start();

            //Autorun setting

            String f_autorun = String.Empty;
            String f_multi = String.Empty;
            if (is_portable == false)
            {
                f_autorun = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_autorun.ini";
                f_multi = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_autorun_m.ini";
            }
            else
            {
                f_autorun = port_path + "ff_autorun_portable.ini";
                f_multi = port_path + "ff_autorun_m_portable.ini";
            }
            if (File.Exists(f_autorun))
            {
                start_seq = true;
                chk_autor.ImageIndex = 1;
                if (File.Exists(f_multi)) start_multi = true;
                else start_multi = false;
            }
            else
            {
                chk_autor.ImageIndex = 0;
                start_seq = false;
                start_multi = false;
            }

            //End autorun

            read_config_files();
            read_hw_dec();

            Task t = Task.Run(() =>
            {
                get_ff_ver();
            });

            this.Cursor = Cursors.Arrow;
            //Select language

            String f_lang = String.Empty;
            if (is_portable == false)
            {
                f_lang = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_lang.ini";
            }
            else
            {
                f_lang = port_path + "ff_lang_portable.ini";
            }

            if (File.Exists(f_lang))
            {
                String read_lang = File.ReadAllText(f_lang);
                language = read_lang;
                FFBatch.Properties.Settings.Default.app_lang = language;
                FFBatch.Properties.Settings.Default.Save();
                String cultur = CultureInfo.CurrentUICulture.TwoLetterISOLanguageName;
                if (CultureInfo.CurrentUICulture.TwoLetterISOLanguageName != language)
                {
                    if (cultur == "es")
                    {
                        if (language != "es") init_lang();
                    }

                    else if (cultur == "en")
                    {
                        if (language != "en") init_lang();
                    }

                    else if (cultur == "it")
                    {
                        if (language != "it") init_lang();
                    }

                    else if (cultur == "pt-BR")
                    {
                        if (language != "pt-BR") init_lang();
                    }

                    else if (cultur == "zh-Hans")
                    {
                        if (language != "zh-Hans") init_lang();
                    }
                    else
                    {
                        init_lang();
                    }
                }
                else
                {
                    post_lang();
                    combo_prio.Items.Clear();
                    combo_prio.Items.Add(FFBatch.Properties.Strings.High);
                    combo_prio.Items.Add(FFBatch.Properties.Strings.Above_normal);
                    combo_prio.Items.Add(FFBatch.Properties.Strings.Normal);
                    combo_prio.Items.Add(FFBatch.Properties.Strings.Below_normal);
                    combo_prio.Items.Add(FFBatch.Properties.Strings.Idle);
                    combo_presets.Text = Properties.Strings.default_param;

                    btn_update.Text = Properties.Strings2.version + " " + Application.ProductVersion;
                    load_priority();
                    remember_tab();
                    resize();
                }
            }
            else
            {
                Thread.Sleep(85);
                for (int i = Application.OpenForms.Count - 1; i >= 0; i--)
                {
                    if (Application.OpenForms[i].Name == "Form6")
                    {
                        this.InvokeEx(f => Application.OpenForms[i].Close());
                        break;
                    }
                }

                Form24 frm24 = new Form24();
                frm24.ShowDialog();

                switch (frm24.combo_lang.SelectedIndex)
                {
                    case 0:
                        language = "en";
                        break;
                    case 1:
                        language = "es";
                        break;
                    case 2:
                        language = "it";
                        break;
                    case 3:
                        language = "pt-BR";
                        break;
                    case 4:
                        language = "zh-Hans";
                        break;
                    default:
                        language = "en";
                        break;
                }

                File.WriteAllText(f_lang, language);
                FFBatch.Properties.Settings.Default.app_lang = language;
                FFBatch.Properties.Settings.Default.Save();
                init_lang();
                btn_update.Text = Properties.Strings2.version + " " + Application.ProductVersion;
            }
            //End select language
            load_priority();
            if (Properties.Settings.Default.dark_mode == true)
            {
                foreach (Control c in this.Controls) UpdateColorDark(c);
                post_dark();
            }
        }

        private void load_priority()
        {
            //Load priority

            String f_prio = String.Empty;
            if (is_portable == false)
            {
                f_prio = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_priority.ini";
            }
            else
            {
                f_prio = port_path + "ff_priority_portable.ini";
            }

            if (File.Exists(f_prio))
            {
                String saved_prio = File.ReadAllText(f_prio);
                if (saved_prio != String.Empty)
                {
                    this.InvokeEx(f => f.combo_prio.SelectedIndex = Convert.ToInt16(saved_prio));
                    current_prio = Convert.ToInt16(saved_prio);
                }
            }
            else
            {
                this.InvokeEx(f => f.combo_prio.SelectedIndex = 2);
            }
            this.InvokeEx(f => f.btn_save_prio.Enabled = false);

            //End load priority
        }

        private void get_ff_ver()
        {
            Task t = Task.Run(() =>
            {
                try
                {
                    WebClient client = new WebClientWithTimeout();
                    Stream stream = client.OpenRead("https://www.gyan.dev/ffmpeg/builds/release-version");
                    StreamReader reader = new StreamReader(stream);
                    String content = reader.ReadToEnd();
                    latest_ff = content;
                }
                catch
                {
                    latest_ff = FFBatch.Properties.Strings.error;
                }
            });
        }

        private void read_hw_dec()
        {
            //HW_Decoders
            try
            {
                String f_hw_dcd = String.Empty;
                if (is_portable == false)
                {
                    f_hw_dcd = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_hw_dcd.ini";
                }
                else
                {
                    f_hw_dcd = port_path + "ff_hw_dcd_portable.ini";
                }

                Boolean bug_1 = false;
                if (File.Exists(f_hw_dcd))
                {
                    String all_file = File.ReadAllText(f_hw_dcd);
                    if (f_hw_dcd.Contains("*")) bug_1 = true;
                }
                else
                {
                    bug_1 = true;
                }
                if (bug_1 == false)
                {
                    int dcd_saved = 0;
                    String[] saved_hw_dcd = File.ReadAllLines(f_hw_dcd);
                    foreach (string line in File.ReadLines(f_hw_dcd))
                    {
                        this.InvokeEx(f => f.cb_hwdecode.Items.Add(line));
                    }
                    this.InvokeEx(f => f.cb_hwdecode.SelectedIndex = dcd_saved);
                }
                else
                {
                    cb_hwdecode.Invoke(new MethodInvoker(delegate
                    {
                        this.InvokeEx(f => f.cb_hwdecode.Items.Add("none"));
                        decoders.Add("none");
                        this.InvokeEx(f => f.cb_hwdecode.SelectedIndex = 0);
                        String selected = cb_hwdecode.SelectedItem.ToString();
                        if (hw_decoders == true) return;

                        if (hw_decoders == false)
                        {
                            hw_decoders = true;

                            //Read hardware decoders
                            Process consola_hw = new Process();

                            consola_hw.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");
                            consola_hw.StartInfo.Arguments = " -hwaccels";
                            consola_hw.StartInfo.RedirectStandardOutput = true;
                            consola_hw.StartInfo.RedirectStandardError = true;
                            consola_hw.StartInfo.UseShellExecute = false;
                            consola_hw.StartInfo.CreateNoWindow = true;
                            consola_hw.EnableRaisingEvents = true;

                            String duracion = String.Empty;
                            String std_out = String.Empty;
                            consola_hw.Start();
                            Boolean hw_found = false;

                            while (!consola_hw.StandardOutput.EndOfStream)
                            {
                                std_out = consola_hw.StandardOutput.ReadLine();

                                if (std_out.Contains("Hardware acceleration methods:"))
                                {
                                    if (selected != "auto") cb_hwdecode.Items.Add("auto");
                                    hw_found = true;
                                    decoders.Add("auto");
                                    continue;
                                }

                                if (hw_found == true && std_out != String.Empty && std_out != selected)
                                {
                                    cb_hwdecode.Items.Add(std_out);
                                    decoders.Add(std_out);
                                }
                            }
                            consola_hw.WaitForExit();
                            consola_hw.Close();
                            File.WriteAllLines(f_hw_dcd, decoders);
                        }
                    }));
                }
            }
            catch
            {
                this.InvokeEx(f => f.cb_hwdecode.Items.Add("none"));
                decoders.Add("none");
                this.InvokeEx(f => f.cb_hwdecode.SelectedIndex = 0);
            }
            //End HW_Decoders
        }

        private void read_saved_path()
        {
            String path_s = String.Empty;
            if (is_portable == false)
            {
                path_s = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_path.ini";
            }
            else
            {
                path_s = port_path + "ff_path_portable.ini";
            }

            if (File.Exists(path_s))
            {
                String saved_path = File.ReadAllText(path_s);

                if (saved_path != String.Empty)
                {
                    if (Directory.Exists(saved_path) == true)
                    {
                        txt_path_main.Text = saved_path;
                        txt_path_main.BackColor = Color.White;
                    }
                    else
                    {
                        if (saved_path.Contains(".\\"))
                        {
                            txt_path_main.Text = saved_path;
                            txt_path_main.BackColor = txt_parameters.BackColor;
                            txt_path_main.BackColor = this.BackColor;
                        }
                    }
                }
                else
                {
                    File.Delete(path_s);
                    txt_path_main.BackColor = this.BackColor;
                }
            }
            else
            {
                txt_path_main.Text = ".\\FFBatch";
                txt_path_main.BackColor = this.BackColor;
            }

            //End read saved path
        }

        private void read_main_config()
        {
            //Read saved path

            String path_s = String.Empty;
            if (is_portable == false)
            {
                path_s = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_path.ini";
            }
            else
            {
                path_s = port_path + "ff_path_portable.ini";
            }

            if (File.Exists(path_s))
            {
                String saved_path = File.ReadAllText(path_s);

                if (saved_path != String.Empty)
                {
                    if (Directory.Exists(saved_path) == true)
                    {
                        txt_path_main.Text = saved_path;
                        txt_path_main.BackColor = Color.White;
                    }
                    else
                    {
                        if (saved_path.Contains(".\\"))
                        {
                            txt_path_main.Text = saved_path;
                            txt_path_main.BackColor = txt_parameters.BackColor;
                        }
                        txt_path_main.BackColor = this.BackColor;
                    }
                }
                else
                {
                    File.Delete(path_s);
                    txt_path_main.BackColor = this.BackColor;
                }
            }

            //End read saved path

            //Read saved path URL

            String path_s2 = String.Empty;
            if (is_portable == false)
            {
                path_s2 = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_path_url.ini";
            }
            else
            {
                path_s2 = port_path + "ff_path_url_portable.ini";
            }

            if (File.Exists(path_s2))
            {
                String saved_path = File.ReadAllText(path_s2);

                if (saved_path.Length != 0)
                {
                    if (Directory.Exists(saved_path) == true)
                    {
                        txt_path_m3u.Text = saved_path;
                    }
                }
                else
                {
                    File.Delete(path_s2);
                }
            }

            //End read saved path URL

            //Read configuration

            SetStyle(ControlStyles.SupportsTransparentBackColor, true);

            this.InvokeEx(f => f.combo_presets.Items.Add(FFBatch.Properties.Strings.default_param));
            this.InvokeEx(f => f.combo_presets.SelectedIndex = 0);
            //this.InvokeEx(f => f.combo_presets.Items.Clear());
            //this.InvokeEx(f => f.combo_presets.Items.Add(FFBatch.Properties.Strings.default_param));

            String path = String.Empty;
            String path_pr = String.Empty;
            if (is_portable == false)
            {
                path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.ini";
                path_pr = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_presets.ini";
            }
            else
            {
                path = port_path + "ff_batch_portable.ini";
                path_pr = port_path + "ff_presets_portable.ini";
            }

            int linea = 0;
            this.InvokeEx(f => f.combo_presets.SelectedIndex = combo_presets.FindString((FFBatch.Properties.Strings.default_param)));

            foreach (string line in File.ReadLines(path))
            {
                linea = linea + 1;
                if (linea == 1)
                {
                    this.InvokeEx(f => f.txt_parameters.Text = line);
                    continue;
                }

                if (linea == 2)
                {
                    this.InvokeEx(f => f.txt_format.Text = line);
                    continue;
                }

                if (line == "Yes")

                {
                    this.InvokeEx(f => f.chk_open_compl.CheckState = CheckState.Checked);
                    continue;
                }

                if (line == "No")
                {
                    this.InvokeEx(f => f.chk_open_compl.CheckState = CheckState.Unchecked);
                    continue;
                }

                if (line == "Vn")
                {
                    this.InvokeEx(f => f.chk_suffix.CheckState = CheckState.Unchecked);
                    continue;
                }
                if (line.Length > 1 && line.Substring(0, 2) == "Vs")
                {
                    this.InvokeEx(f => f.chk_suffix.CheckState = CheckState.Checked);
                    this.InvokeEx(f => f.txt_suffix.Text = line.Substring(3, line.Length - 3));
                    continue;
                }

                if (line == "grid_yes")
                {
                    this.InvokeEx(f => f.listView1.GridLines = true);
                    this.InvokeEx(f => f.listView2.GridLines = true);
                    this.InvokeEx(f => f.listView3.GridLines = true);
                    continue;
                }
                if (line == "grid_no")
                {
                    this.InvokeEx(f => f.listView1.GridLines = false);
                    this.InvokeEx(f => f.listView2.GridLines = false);
                    this.InvokeEx(f => f.listView3.GridLines = false);
                    continue;
                }

                if (line == "keep_yes")
                {
                    this.InvokeEx(f => f.checkBox1.CheckState = CheckState.Checked);
                    continue;
                }
                if (line == "keep_no")
                {
                    this.InvokeEx(f => f.checkBox1.CheckState = CheckState.Unchecked);
                    continue;
                }

                if (line == "subf_yes")
                {
                    this.InvokeEx(f => f.chk_subfolders.CheckState = CheckState.Checked);
                    add_subfs = true;
                    continue;
                }
                if (line == "subf_no")
                {
                    this.InvokeEx(f => f.chk_subfolders.CheckState = CheckState.Unchecked);
                    add_subfs = false;
                    continue;
                }
            }
            if (File.Exists(path_pr))
            {
                foreach (string line in File.ReadLines(path_pr))
                {
                    if (line.Length > 8)
                    {
                        if (line.Substring(0, 7).ToLower() == "version")
                        {
                            txt_config_ver.Text = line.Substring(8, line.Length - 8);
                            continue;
                        }
                    }

                    if (line.Contains("PR: "))
                    {
                        this.InvokeEx(f => f.combo_presets.Items.Add(line.Substring(4, line.LastIndexOf("&") - 5)));
                    }
                }
            }

            this.InvokeEx(f => f.btn_save_config.ImageKey = "Save_settings_39.png");

            //End read configuration
        }

        private void read_config_files()
        {
            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;

                //N-threads read
                this.InvokeEx(f => f.n_threads.Maximum = Environment.ProcessorCount);
                this.InvokeEx(f => f.n_downs.Maximum = n_threads.Maximum);
                tabControl1.Invoke(new MethodInvoker(delegate
                {
                    if (n_threads.Maximum > 2)
                    {
                        n_threads.Minimum = 2;
                        n_downs.Minimum = 2;
                    }
                    else
                    {
                        n_threads.Minimum = 1;
                        n_downs.Minimum = 1;
                    }

                    try
                    {
                        if (Environment.ProcessorCount > 2)
                        {
                            n_threads.Value = Environment.ProcessorCount / 2;
                            n_downs.Value = Environment.ProcessorCount / 2;
                        }
                        else
                        {
                            n_threads.Value = 2;
                            n_downs.Value = 2;
                        }
                    }
                    catch
                    {
                        if (n_threads.Maximum >= 2)
                        {
                            n_threads.Value = 2;
                            n_downs.Value = 2;
                        }
                    }
                }));

                String path_first = String.Empty;
                if (is_portable == false)
                {
                    path_first = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_first.ini";
                }
                else
                {
                    path_first = port_path + "ff_first_portable.ini";
                }
                if (!File.Exists(path_first))
                {
                    first_run = true;
                    File.WriteAllText(path_first, String.Empty);
                }

                String f_thr = String.Empty;
                if (is_portable == false)
                {
                    f_thr = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_nthreads.ini";
                }
                else
                {
                    f_thr = port_path + "ff_nthreads_portable.ini";
                }

                if (File.Exists(f_thr))
                {
                    String saved_th = File.ReadAllText(f_thr);
                    this.InvokeEx(f => f.n_threads.Value = Convert.ToInt16(saved_th));
                }
                //End N-threads read

                //Begin n_downloads

                String f_thr2 = String.Empty;
                if (is_portable == false)
                {
                    f_thr2 = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_downs.ini";
                }
                else
                {
                    f_thr2 = port_path + "ff_downs_portable.ini";
                }

                if (File.Exists(f_thr2))
                {
                    String saved_th2 = File.ReadAllText(f_thr2);
                    this.InvokeEx(f => f.n_downs.Value = Convert.ToInt16(saved_th2));
                }
                //End N-downloads

                this.InvokeEx(f => f.pic_title.BackColor = Color.Transparent);
                //this.InvokeEx(f => f.mem_prio.Items.AddRange(combo_prio.Items.Cast<Object>().ToArray()));
                this.InvokeEx(f => f.combo_prio.Text = "Priority");

                //Sleep off

                String f_sleep = String.Empty;
                if (is_portable == false)
                {
                    f_sleep = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_sleep.ini";
                }
                else
                {
                    f_sleep = port_path + "ff_sleep_portable.ini";
                }

                if (File.Exists(f_sleep))
                {
                    NativeMethods.SetThreadExecutionState(EXECUTION_STATE.ES_CONTINUOUS);
                    Timer_idle.Enabled = true;
                    Timer_idle.Start();
                }

                //End sleep off

                //Disable try preset

                String f_try = String.Empty;
                if (is_portable == false)
                {
                    f_try = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_try.ini";
                }
                else
                {
                    f_try = port_path + "ff_try_portable.ini";
                }

                if (File.Exists(f_try))
                {
                    this.InvokeEx(f => f.chk_try.Checked = true);
                }
                else
                {
                    this.InvokeEx(f => f.chk_try.Checked = false);
                }
                //End Disable preset

                //Send params to console

                String f_params_console = String.Empty;
                if (is_portable == false)
                {
                    f_params_console = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_par_con.ini";
                }
                else
                {
                    f_params_console = port_path + "ff_par_con_portable.ini";
                }

                send_par_consol = !File.Exists(f_params_console);
                //End send params to console

                //Concat video filter

                String f_concat = String.Empty;
                if (is_portable == false)
                {
                    f_concat = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_concat.ini";
                }
                else
                {
                    f_concat = port_path + "ff_concat_portable.ini";
                }

                if (File.Exists(f_concat))
                {
                    this.InvokeEx(f => f.check_concat.Checked = true);
                }
                else
                {
                    this.InvokeEx(f => f.check_concat.Checked = false);
                }
                first_concat = false;
                //End concat video filter

                //Warn successful items

                String f_warn_suc = String.Empty;
                if (is_portable == false)
                {
                    f_warn_suc = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_warn_suc.ini";
                }
                else
                {
                    f_warn_suc = port_path + "ff_warn_suc_portable.ini";
                }

                warn_success_items = !File.Exists(f_warn_suc);
                //End warn sucessful items

                //Warn 0

                String f_warn_0 = String.Empty;
                if (is_portable == false)
                {
                    f_warn_0 = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_warn_0.ini";
                }
                else
                {
                    f_warn_0 = port_path + "ff_warn_0_portable.ini";
                }

                no_warn_0_dur = File.Exists(f_warn_0);
                //End warn 0

                //Do not save logs

                String f_nologs = String.Empty;
                if (is_portable == false)
                {
                    f_nologs = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_nologs.ini";
                }
                else
                {
                    f_nologs = port_path + "ff_nologs_portable.ini";
                }

                no_save_logs = (File.Exists(f_nologs));
                //End do not save logs

                //Verbose logs

                String f_verbose = String.Empty;
                if (is_portable == false)
                {
                    f_verbose = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_verbose.ini";
                }
                else
                {
                    f_verbose = port_path + "ff_verbose_portable.ini";
                }

                verbose_logs = File.Exists(f_verbose);
                //End Verbose logs

                //Full report

                String f_report = String.Empty;
                if (is_portable == false)
                {
                    f_report = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_report.ini";
                }
                else
                {
                    f_report = port_path + "ff_report_portable.ini";
                }

                full_report = File.Exists(f_report);
                //End full report

                //Do not cache network files

                String f_nocache = String.Empty;
                if (is_portable == false)
                {
                    f_nocache = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_nocache.ini";
                }
                else
                {
                    f_nocache = port_path + "ff_nocache_portable.ini";
                }

                no_save_cache = File.Exists(f_nocache);
                //End do cache network files

                //Use OS cache dialog

                String f_oscache = String.Empty;
                if (is_portable == false)
                {
                    f_oscache = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_oscache.ini";
                }
                else
                {
                    f_oscache = port_path + "ff_oscache_portable.ini";
                }

                os_save_cache = File.Exists(f_oscache);
                //End use OS cache dialog

                //Delete source files to recycle bin

                String f_delete = String.Empty;
                if (is_portable == false)
                {
                    f_delete = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_delete.ini";
                }
                else
                {
                    f_delete = port_path + "ff_delete_portable.ini";
                }

                if (File.Exists(f_delete))
                {
                    this.InvokeEx(f => f.chk_delete_source.CheckState = CheckState.Checked);
                }
                else
                {
                    this.InvokeEx(f => f.chk_delete_source.CheckState = CheckState.Unchecked);
                }

                //END delete source files to recycle bin

                //Read play sound

                String ff_play_sound = String.Empty;
                if (is_portable == false)
                {
                    ff_play_sound = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_play.ini";
                }
                else
                {
                    ff_play_sound = port_path + "ff_play_portable.ini";
                }

                if (!File.Exists(ff_play_sound))
                {
                    play_on_end = false;
                }
                else
                {
                    String read_play = File.ReadAllText(ff_play_sound);
                    if (read_play.Length != 0)
                    {
                        play_on_end = true;
                        play_file_path = read_play;
                    }
                    else
                    {
                        play_on_end = false;
                    }
                }
                //End Read play sound

                String f_remember_w = String.Empty;
                if (is_portable == false)
                {
                    f_remember_w = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_remember_w.ini";
                }
                else
                {
                    f_remember_w = port_path + "ff_remember_w_portable.ini";
                }
                remember_w = File.Exists(f_remember_w);
                //Fix pre-input

                String f_fix_pre = String.Empty;
                if (is_portable == false)
                {
                    f_fix_pre = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_fix_pre.ini";
                }
                else
                {
                    f_fix_pre = port_path + "ff_fix_pre_portable.ini";
                }
                if (File.Exists(f_fix_pre))
                {
                    fix_pre = true;
                    this.InvokeEx(f => f.txt_pre_input.Text = File.ReadAllText(f_fix_pre));
                }
                else
                {
                    fix_pre = false;
                    this.InvokeEx(f => f.txt_pre_input.Text = String.Empty);
                }

                //End fix pre_input

                //Save trim check

                String f_trim = String.Empty;
                if (is_portable == false)
                {
                    f_trim = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_trim.ini";
                }
                else
                {
                    f_trim = port_path + "ff_trim_portable.ini";
                }
                if (File.Exists(f_trim))
                {
                    this.InvokeEx(f => f.chk_trim2.CheckState = CheckState.Checked);
                }
                else
                {
                    this.InvokeEx(f => f.chk_trim2.CheckState = CheckState.Unchecked);
                }

                //End save trim check

                //Delete full

                String f_delete_full = String.Empty;
                if (is_portable == false)
                {
                    f_delete_full = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_delete_full.ini";
                }
                else
                {
                    f_delete_full = port_path + "ff_delete_full_portable.ini";
                }

                if (File.Exists(f_delete_full)) delete_def = true;
                else delete_def = false;
                //End delete full

                //Delete one

                String f_delete_one = String.Empty;
                if (is_portable == false)
                {
                    f_delete_one = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_delete_one.ini";
                }
                else
                {
                    f_delete_one = port_path + "ff_delete_one_portable.ini";
                }
                if (File.Exists(f_delete_one)) delete_one = true;
                else delete_one = false;

                //End delete one
            }).Start();
        }

        private void add_col_start()
        {
            String f_cols = String.Empty;
            if (is_portable == false)
            {
                f_cols = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_cols.ini";
            }
            else
            {
                f_cols = port_path + "ff_cols_portable.ini";
            }

            if (!File.Exists(f_cols)) return;
            foreach (String str in File.ReadLines(f_cols))
            {
                if (str.Contains(FFBatch.Properties.Strings.height))
                {
                    listView1.Invoke(new MethodInvoker(delegate
                    {
                        ColumnHeader columnHeader = listView1.Columns.Add(FFBatch.Properties.Strings.width, 50, HorizontalAlignment.Center);
                        ColumnHeader columnHeader2 = listView1.Columns.Add(FFBatch.Properties.Strings.height, 50, HorizontalAlignment.Center);
                        listView1.Columns[0].Width = listView1.Columns[0].Width - 110;
                    }));
                }

                if (str.Contains(FFBatch.Properties.Strings.Video_codec))
                {
                    listView1.Invoke(new MethodInvoker(delegate
                    {
                        ColumnHeader columnHeader = listView1.Columns.Add(FFBatch.Properties.Strings.Video_codec, 100, HorizontalAlignment.Left);
                        listView1.Columns[0].Width = listView1.Columns[0].Width - 110;
                    }));
                }
                if (str.Contains(FFBatch.Properties.Strings.Audio_codec))
                {
                    listView1.Invoke(new MethodInvoker(delegate
                    {
                        ColumnHeader columnHeader = listView1.Columns.Add(FFBatch.Properties.Strings.Audio_codec, 100, HorizontalAlignment.Center);
                        listView1.Columns[0].Width = listView1.Columns[0].Width - 110;
                    }));
                }

                if (str.Contains(FFBatch.Properties.Strings.v_bitr))
                {
                    listView1.Invoke(new MethodInvoker(delegate
                    {
                        ColumnHeader columnHeader = listView1.Columns.Add(FFBatch.Properties.Strings.v_bitr, 100, HorizontalAlignment.Center);
                        listView1.Columns[0].Width = listView1.Columns[0].Width - 110;
                    }));
                }
                if (str.Contains(FFBatch.Properties.Strings2.a_bitr))
                {
                    listView1.Invoke(new MethodInvoker(delegate
                    {
                        ColumnHeader columnHeader = listView1.Columns.Add(FFBatch.Properties.Strings2.a_bitr, 100, HorizontalAlignment.Center);
                        listView1.Columns[0].Width = listView1.Columns[0].Width - 110;
                    }));
                }
                if (str.Contains(FFBatch.Properties.Strings2.bitrate))
                {
                    listView1.Invoke(new MethodInvoker(delegate
                    {
                        ColumnHeader columnHeader = listView1.Columns.Add(FFBatch.Properties.Strings2.bitrate, 100, HorizontalAlignment.Center);
                        listView1.Columns[0].Width = listView1.Columns[0].Width - 110;
                    }));
                }
            }
        }

        private void button3_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            String path_log_backup = String.Empty;
            String path, path_pre = String.Empty;
            if (is_portable == false)
            {
                path_log_backup = Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch_bck.ini";
                path = Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.ini";
                path_pre = Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch_pre.ini";
            }
            else
            {
                path_log_backup = port_path + "ff_batch_bck_portable.ini";
                path = port_path + "ff_batch_portable.ini";
                path_pre = port_path + "ff_batch_pre_portable.ini";
                if (!File.Exists(path)) reset_portable();
            }

            File.Copy(path, path_log_backup, true);

            String[] lines = System.IO.File.ReadAllLines(path);

            for (int i = 0; i < lines.Length - 1; i++)
            {
                lines[0] = txt_parameters.Text;
                lines[1] = txt_format.Text;

                if (chk_open_compl.Checked)
                {
                    lines[2] = "Yes";
                }
                else
                {
                    lines[2] = "No";
                }

                if (chk_suffix.Checked)
                {
                    lines[3] = "Vs " + txt_suffix.Text;
                }
                else
                {
                    lines[3] = "Vn";
                }

                if (listView1.GridLines == true)
                {
                    lines[4] = "grid_yes";
                }
                else
                {
                    lines[4] = "grid_no";
                }

                if (checkBox1.Checked)
                {
                    lines[5] = "keep_yes";
                }
                else
                {
                    lines[5] = "keep_no";
                }

                if (chk_subfolders.Checked)
                {
                    lines[6] = "subf_yes";
                }
                else
                {
                    lines[6] = "subf_no";
                }
            }
            File.WriteAllLines(path, lines);
            //if (txt_pre_input.Text.Length > 0) File.WriteAllText(path_pre, "Default " + txt_pre_input.Text);
            //else
            //{
            //    try
            //    {
            //        File.Delete(path_pre);
            //    }
            //    catch
            //    {
            //        MessageBox.Show(FFBatch.Properties.Strings.pre_in_path, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
            //    }
            //}

            btn_save_config.ImageKey = "Save_settings_39.png";

            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.params_def);
            btn_load_config.PerformClick();
        }

        private void button5_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            pic_frame.Image = pic_frame.InitialImage;
            current_fr = 4000;
            lbl_a_th.Text = "-";
            lbl_s_th.Text = "-";
            lbl_v_th.Text = "-";
            lbl_gb_th.Text = "-";
            lbl_mux_jobs.Text = Properties.Strings.jobs + " " + frm_mux_jobs.dg_pr.RowCount.ToString();
            lbl_size.Text = "";
            LB_Wait.Visible = false;
            txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + "00h:00m:00s";
            lbl_elapsed.Text = FFBatch.Properties.Strings.time_elapsed + " " + "00h:00m:00s";
            listView1.Items.Clear();
            listView2.Items.Clear();
            listView3.Items.Clear();
            dg1.Rows.Clear();
            ss_time_input.Text = "0:00:00.000";
            //txt_pre_input.Text = "";
            //txt_pre_input.BackColor = textBox1.BackColor;
            txt_folder_subs.Text = String.Empty;
            txt_folder_subs.BackColor = Control.DefaultBackColor;
            lbl_items.Text = "";
            lbl_dur_list.Text = "";
            lbl_speed.Text = String.Empty;
            Pg1.Value = 0;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            Pg1.Refresh();
            list_tracks.Items.Clear();
            combo_item_lang_2.SelectedIndex = -1;
            Combo_sub_lang_mux.SelectedIndex = -1;
            lbl_tr_n.Text = FFBatch.Properties.Strings.tracks + " " + "0";
            lbl_urls_time.Text = "";
            txt_mux_type.Text = String.Empty;
            btn_try_pr.Image = img_try.Images[0];
            lbl_urls_time.Text = "";
            lbl_n_urls.Text = "";
            pic_warnings.Visible = false;
            pic_no_errors.Visible = false;
            pic_recording.Visible = false;
            clean_imgs();
        }

        private void comboBox1_SelectedIndexChanged(object sender, EventArgs e)
        {
            String path;
            String path_pr;

            if (is_portable == false)
            {
                path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.ini";
                path_pr = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_presets.ini";
            }
            else
            {
                path = port_path + "ff_batch_portable.ini";
                path_pr = port_path + "ff_presets_portable.ini";
            }

            if (combo_presets.SelectedIndex == 0)
            {
                txt_pre_input.BackColor = txt_parameters.BackColor;

                if (is_portable == false)
                {
                    if (!Directory.Exists(System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch")))
                    {
                        Directory.CreateDirectory(System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch"));
                    }
                }
                else
                {
                    if (!Directory.Exists(port_path))
                    {
                        Directory.CreateDirectory(port_path);
                    }
                }

                if (!File.Exists(path))
                {
                    File.WriteAllText(path, "-c copy" + Environment.NewLine + "mp4" + Environment.NewLine + "Yes"
                        + Environment.NewLine + "Vn" + Environment.NewLine + "grid_yes" + Environment.NewLine + "keep_no"
                        + Environment.NewLine + "subf_no");
                }

                if (!File.Exists(path_pr) && File.Exists(path))
                {
                    List<string> presets_old = new List<string>();
                    List<string> new_config = new List<string>();
                    foreach (string line in File.ReadLines(path))
                    {
                        if (line.Length > 4)
                        {
                            if (line.Substring(0, 4) == "PR: ")
                            {
                                presets_old.Add(line + Environment.NewLine);
                            }
                        }
                        if (!line.Contains("PR: ") && line.Substring(0, 2).ToLower() != "ve") new_config.Add(line + Environment.NewLine);
                    }

                    File.Delete(path);
                    foreach (String st in presets_old) File.AppendAllText(path_pr, st);
                    foreach (String st in new_config)
                    {
                        File.AppendAllText(path, st);
                    }
                }

                int linea = 0;
                foreach (string line in File.ReadLines(path))
                {
                    linea = linea + 1;

                    if (linea == 1)
                    {
                        txt_parameters.Text = line;
                    }

                    if (linea == 2)
                    {
                        txt_format.Text = line;
                    }

                    if (line == "Yes")

                    {
                        chk_open_compl.CheckState = CheckState.Checked;
                    }

                    if (line == "No")
                    {
                        chk_open_compl.CheckState = CheckState.Unchecked;
                    }
                }
            }
            else
            {
                String pre_name = String.Empty;
                if (File.Exists(path_pr)) path = path_pr;
                int i = 0;
                foreach (string line in File.ReadLines(path))
                {
                    if (line.Length > 8)
                    {
                        if (line.Substring(0, 7).ToLower() == "version")
                        {
                            txt_config_ver.Text = line.Substring(8, line.Length - 8);
                            continue;
                        }
                    }
                    if (line.Length > 4 && line.Substring(4, line.IndexOf("&") - 5) == combo_presets.SelectedItem.ToString())
                    {
                        int cortar = line.LastIndexOf("%") - line.LastIndexOf("&");
                        txt_format.Text = line.Substring(line.LastIndexOf("%") + 2);
                        try
                        {
                            txt_parameters.Text = line.Substring(line.LastIndexOf("&") + 2, cortar - 3);
                        }
                        catch
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.invalid_pres, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        }
                        continue;
                    }
                }
            }
            btn_save_preset.Enabled = false;
            //Read pre-input

            if (combo_presets.SelectedIndex == 0)
            {
                String path_pre = String.Empty;
                if (is_portable == false)
                {
                    path_pre = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch_pre.ini";
                }
                else
                {
                    path_pre = port_path + "ff_batch_pre_portable.ini";
                }

                String pre_input = String.Empty;
                if (File.Exists(path_pre)) pre_input = File.ReadAllText(path_pre);

                if (pre_input.Length > 0)
                    txt_pre_input.Text = pre_input.Substring(8, pre_input.Length - 8);
            }
            else
            {
                if (fix_pre == false) txt_pre_input.Text = "";
            }
            //End read-pre-input
        }

        private void cti1_Click(object sender, EventArgs e)
        {
            if (listView1.SelectedItems.Count > 0)
            {
                String fullPath = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
                String destino = Path.GetDirectoryName(fullPath);

                if (Directory.Exists(destino))
                {
                    Process process = new System.Diagnostics.Process();
                    process.StartInfo.FileName = "explorer.exe";
                    process.StartInfo.Arguments = "\u0022" + destino + "\u0022";
                    process.StartInfo.WindowStyle = System.Diagnostics.ProcessWindowStyle.Normal;
                    process.Start();
                }
                else
                {
                    MessageBox.Show(Properties.Strings.no_path, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        private void cti2_Click(object sender, EventArgs e)
        {
            if (listView1.SelectedItems.Count > 0)
            {
                String fullPath = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
                if (File.Exists(fullPath))
                {
                    System.Diagnostics.Process.Start(fullPath);
                }
                else
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file_not_found, FFBatch.Properties.Strings.file_miss, MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        private void ctm1_Opening(object sender, CancelEventArgs e)
        {
            //ct1_paste_m3u.Image = ct1_paste_m3u.Image;
            if (Properties.Settings.Default.dark_mode == true)
            {
                ctm1.BackColor = Color.FromArgb(255, 64, 64, 64);
                ctm1.ForeColor = Color.White;
            }
            else
            {
                ctm1.BackColor = SystemColors.InactiveBorder;
                ctm1.ForeColor = Control.DefaultForeColor;
            }

            cti6.Visible = false;
            if (runnin_n_presets == true) e.Cancel = true;

            ctm1_queue.Enabled = false;

            if (working == true)
            {
                ct_move_bottom.Enabled = false;
                ct_move_top.Enabled = false;

                cti1.Enabled = false;
                cti2.Enabled = false;
                cti3.Enabled = false;
                cti4.Enabled = false;
                cti5.Enabled = false;
                if (listView1.SelectedItems.Count > 0) ctdel.Enabled = true;
                ct1_total_frames.Enabled = false;
                ct1_streams.Enabled = false;
                ctm1_queue.Enabled = false;
                cti1_cols.Enabled = false;
                cti_remove_col.Enabled = false;
                ctm1_encode.Visible = false;

                if (listView1.SelectedItems.Count == 1 && listView1.SelectedItems[0].SubItems[5].Text != FFBatch.Properties.Strings.aborted && listView1.SelectedItems[0].SubItems[5].Text != FFBatch.Properties.Strings.queued && listView1.SelectedItems[0].SubItems[5].Text != FFBatch.Properties.Strings.aborting && listView1.SelectedItems[0].SubItems[5].Text != FFBatch.Properties.Strings.success)
                {
                    cti6.Visible = true;
                    cti6.Text = Properties.Strings2.stop_proc + " " + "\u0022" + Path.GetFileName(listView1.SelectedItems[0].Text) + "\u0022";
                }

                foreach (ListViewItem item in listView1.SelectedItems)
                {
                    if (item.SubItems[5].Text == FFBatch.Properties.Strings.queued)
                    {
                        ctdel.Enabled = true;
                        if (multi_running == false) ctdel.Text = Properties.Strings2.rem_from_list;
                        else ctdel.Text = Properties.Strings2.skip_from_list;
                    }
                    else
                    {
                        ctdel.Enabled = false;
                        break;
                    }
                }
            }
            else
            {
                ctm1_encode.Visible = false;
                if (!Clipboard.ContainsText())
                {
                    ct1_paste_m3u.Visible = false;
                    ct1_paste_youtube.Visible = false;
                }
                else
                {
                    if (Clipboard.GetText().ToLower().Contains("youtu.be") || Clipboard.GetText().ToLower().Contains("youtube.com"))
                    {
                        ct1_paste_youtube.Visible = true;
                        ct1_paste_m3u.Visible = false;
                    }
                    else
                    {
                        ct1_paste_youtube.Visible = false;

                        if (Clipboard.GetText().ToLower().Contains("http") == true)
                        {
                            if (Clipboard.GetText().ToLower().Contains("m3u") == true)
                            {
                                ct1_paste_m3u.Text = Properties.Strings.Paste_M3u_URL;
                            }
                            else
                            {
                                ct1_paste_m3u.Text = Properties.Strings2.Paste_any_URL;
                            }
                            ct1_paste_m3u.Visible = true;
                        }
                        else
                        {
                            ct1_paste_m3u.Visible = false;
                        }
                    }

                    cti1_cols.Enabled = listView1.Columns.Count <= 13 && listView1.Columns.Count >= 6;
                    cti_remove_col.Enabled = listView1.Columns.Count > 6;
                }

                if (listView1.SelectedItems.Count > 0)
                {
                    cti1.Enabled = true;
                    cti2.Enabled = true;

                    String fullPath = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
                    String destino = "";
                    if (txt_path_main.Text.Contains(".\\"))
                    {
                        destino = fullPath.Substring(0, fullPath.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
                    }
                    else
                    {
                        destino = txt_path_main.Text;
                    }

                    cti3.Enabled = Directory.Exists(destino);

                    String second_path = "";
                    if (txt_format.Text == "nul")
                    {
                        String[] split = txt_parameters.Text.Split(' ');
                        for (int i = 0; i < split.Length; i++)
                        {
                            if (split[i].Contains("\\") == true)
                            {
                                String pre_path = split[i].Replace("%fp", Path.GetDirectoryName(fullPath)).Replace("%", "_");

                                second_path = Path.GetDirectoryName(pre_path.Replace('\u0022', ' '));
                                cti3.Enabled = Directory.Exists(second_path);
                            }
                        }
                    }

                    cti4.Enabled = true;
                    cti5.Enabled = true;
                    ctdel.Enabled = true;
                    ctdel.Enabled = true;
                    if (multi_running == false) ctdel.Text = Properties.Strings2.rem_from_list;
                    else ctdel.Text = Properties.Strings2.skip_from_list;
                    ct1_total_frames.Enabled = true;
                    ct1_streams.Enabled = true;
                    ctm_add_files.Visible = false;
                    ctm_add_folder.Visible = false;
                    ctm_paste_path.Visible = false;
                    ct_move_bottom.Enabled = true;
                    ct_move_top.Enabled = true;
                    toolStripSeparator2.Visible = false;
                    ctm1_queue.Enabled = false;
                    foreach (ListViewItem item in listView1.SelectedItems)
                    {
                        if (item.SubItems[5].Text != FFBatch.Properties.Strings.queued)
                        {
                            ctm1_queue.Enabled = true;
                            break;
                        }
                    }
                    ctm1_encode.Visible = true;
                }
                else
                {
                    e.Cancel = false;
                    ctm_add_files.Visible = true;
                    ctm_add_folder.Visible = true;
                    ctm_paste_path.Visible = true;
                    ctm1_queue.Enabled = false;
                    ct_move_bottom.Enabled = false;
                    ct_move_top.Enabled = false;
                    toolStripSeparator2.Visible = true;
                    cti1.Enabled = false;
                    cti2.Enabled = false;
                    cti3.Enabled = false;
                    cti4.Enabled = false;
                    cti5.Enabled = false;
                    ctdel.Enabled = false;
                    ct1_total_frames.Enabled = false;
                    ct1_streams.Enabled = false;
                    toolStripSeparator2.Visible = true;
                }
            }
        }

        private void timer1_Tick(object sender, EventArgs e)
        {
            Double weight = 0;
            Double dg_multi_prog = 0;
            total_multi_duration = 0;

            foreach (ListViewItem item in listView1.Items)
            {
                DateTime time2;
                if (DateTime.TryParse(item.SubItems[3].Text, out time2))

                {
                    total_multi_duration = total_multi_duration + TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds - TimeSpan.Parse(ss_time_input.Text).TotalSeconds;
                }
            }

            Pg1.Maximum = listView1.Items.Count * 100;
            start_total_time = start_total_time + 0.5;

            try
            {
                TimeSpan t9 = TimeSpan.FromSeconds(start_total_time);
                String tx_elapsed = string.Format("{0:D2}h:{1:D2}m:{2:D2}s",
                    t9.Hours,
                    t9.Minutes,
                    t9.Seconds);
                lbl_elapsed.Text = FFBatch.Properties.Strings.time_elapsed + " " + tx_elapsed;

                foreach (ListViewItem item_p in listView1.Items)
                {
                    if (item_p.SubItems[3].Text == FFBatch.Properties.Strings.n_a)
                    {
                        weight = 1 / listView1.Items.Count;
                    }
                    else
                    {
                        weight = (TimeSpan.Parse(item_p.SubItems[3].Text).TotalSeconds - TimeSpan.Parse(ss_time_input.Text).TotalSeconds) / total_multi_duration;
                    }

                    if (item_p.SubItems[5].Text.Contains("%") == true && cancelados_paralelos == false)
                    {
                        if (item_p.SubItems[5].Text.Contains(".0") || item_p.SubItems[5].Text.Contains(",0"))
                        {
                            dg_multi_prog = dg_multi_prog + Convert.ToDouble(item_p.SubItems[5].Text.Replace("%", "")) / 10 * weight * listView1.Items.Count;
                        }
                        else
                        {
                            dg_multi_prog = dg_multi_prog + Convert.ToDouble(item_p.SubItems[5].Text.Replace("%", "")) * weight * listView1.Items.Count;
                        }
                    }

                    if (item_p.SubItems[5].Text == FFBatch.Properties.Strings.success || item_p.SubItems[5].Text == FFBatch.Properties.Strings.failed || item_p.SubItems[5].Text == FFBatch.Properties.Strings.aborted || item_p.SubItems[5].Text == FFBatch.Properties.Strings.aborting || item_p.SubItems[5].Text == FFBatch.Properties.Strings.skipped || item_p.SubItems[5].Text == FFBatch.Properties.Strings.replaced || item_p.SubItems[5].Text == FFBatch.Properties.Strings.not_replaced || item_p.SubItems[5].Text == FFBatch.Properties.Strings.recycled || item_p.SubItems[5].Text == FFBatch.Properties.Strings.not_recycled || item_p.SubItems[5].Text == FFBatch.Properties.Strings.deleted || item_p.SubItems[5].Text == FFBatch.Properties.Strings.not_deleted || item_p.SubItems[5].Text == "OK & Run" || item_p.SubItems[5].Text == "OK & Error")
                    {
                        dg_multi_prog = dg_multi_prog + (100 * weight * listView1.Items.Count);
                    }
                }

                if (time_n_tasks > 1)
                {
                    if (Math.Round(dg_multi_prog / listView1.Items.Count, 1).ToString().Contains(".") || Math.Round(dg_multi_prog / listView1.Items.Count, 1).ToString().Contains(","))
                    {
                        Pg1.Text = Math.Round(dg_multi_prog / listView1.Items.Count, 1).ToString() + "%";
                    }
                    else
                    {
                        Pg1.Text = Math.Round(dg_multi_prog / listView1.Items.Count, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
                    }

                    Pg1.Value = (int)(dg_multi_prog);
                    TaskbarProgress.SetValue(this.Handle, Convert.ToInt32(dg_multi_prog), Pg1.Maximum);
                }
                else
                {
                    Pg1.Value = 0;
                    Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
                }

                if (Pg1.Value / listView1.Items.Count > 0 && start_total_time > 4)
                {
                    Double remain_secs = time_n_tasks * 100 / (Pg1.Value / listView1.Items.Count) - start_total_time;
                    String remain_string = String.Empty;

                    TimeSpan t = TimeSpan.FromSeconds(remain_secs);
                    remain_string = string.Format("{0:D2}h:{1:D2}",
                    t.Hours,
                    t.Minutes);

                    if (remain_secs >= 43200)
                    {
                        txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Math.Round(remain_secs / 3600).ToString() + " " + FFBatch.Properties.Strings.hours;
                        this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + Math.Round(remain_secs / 3600).ToString() + " " + FFBatch.Properties.Strings.hours);
                    }

                    if (remain_secs >= 3600 && remain_secs < 43200)
                    {
                        txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_string + " " + FFBatch.Properties.Strings.minutes_abrev;
                        this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + remain_string + " " + FFBatch.Properties.Strings.minutes_abrev);
                    }

                    if (remain_secs < 3600 && remain_secs >= 600)
                    {
                        txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_string.Substring(remain_string.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes;
                        this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + remain_string.Substring(remain_string.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes_abrev);
                    }
                    if (remain_secs < 600 && remain_secs >= 120)
                    {
                        txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_string.Substring(remain_string.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes;
                        this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + remain_string.Substring(remain_string.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes_abrev);
                    }

                    if (remain_secs < 120 && remain_secs > 59)
                    {
                        txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.about_1;
                        this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + remain_string.Substring(remain_string.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes_abrev);
                    }

                    if (remain_secs <= 59)
                    {
                        txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.less_one;
                        this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + Convert.ToInt16(Math.Abs(remain_secs)) + " s");
                    }
                    if (remain_secs <= 0)
                    {
                        txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.almost_done;
                        this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + FFBatch.Properties.Strings.almost_done);
                    }
                    txt_remain.Refresh();
                    Decimal speeds = 0;
                    Decimal fps = 0;
                    String sep = System.Globalization.CultureInfo.CurrentUICulture.NumberFormat.NumberDecimalSeparator;

                    try
                    {
                        Decimal deci = 0;

                        foreach (String str in multi_speeds)
                        {
                            if (str.Contains(sep))
                            {
                                deci = Convert.ToDecimal(str, CultureInfo.CurrentUICulture);
                            }
                            else
                            {
                                if (str.Contains(",")) deci = Convert.ToDecimal(str.Replace(",", "."));
                                else deci = Convert.ToDecimal(str.Replace(".", ","));
                            }
                            speeds = Math.Round(Decimal.Add(speeds, deci), 2);
                        }
                    }
                    catch (Exception excpt)
                    {
                        speeds = 0;
                    }

                    try
                    {
                        Decimal deci = 0;
                        foreach (String str in multi_fps)
                        {
                            if (str.Contains(sep))
                            {
                                deci = Convert.ToDecimal(str, CultureInfo.CurrentUICulture);
                                fps = Decimal.Add(fps, deci);
                            }
                            else
                            {
                                if (str.Contains(",")) deci = Convert.ToDecimal(str.Replace(",", "."));
                                else deci = Convert.ToDecimal(str.Replace(".", ","));
                                fps = Decimal.Add(fps, deci);
                            }
                        }
                    }
                    catch { fps = 0; }

                    String fps_perf = fps.ToString();
                    if (fps_perf == "0")
                    {
                        lbl_speed.Text = FFBatch.Properties.Strings.speed + " " + speeds.ToString() + "x";
                    }
                    else
                    {
                        lbl_speed.Text = FFBatch.Properties.Strings.speed + " " + speeds.ToString() + "x" + "  |  " + fps_perf.TrimEnd() + " fps";
                    }
                }
                else
                {
                    txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.calcul;
                    txt_remain.Refresh();
                }
                if (cancelados_paralelos == true)
                {
                    this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                }
            }
            catch
            {
                txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.calcul;
                txt_remain.Refresh();
            }
        }

        private void cti3_Click(object sender, EventArgs e)
        {
            String fullPath = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
            String destino = "";
            if (txt_format.Text != "nul")
            {
                if (txt_path_main.Text.Contains(".\\"))
                {
                    destino = fullPath.Substring(0, fullPath.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
                }
                else
                {
                    destino = txt_path_main.Text;
                }

                if (Directory.Exists(destino))
                {
                    var process = new System.Diagnostics.Process();
                    process.StartInfo.FileName = "explorer.exe";
                    process.StartInfo.Arguments = "\u0022" + destino + "\u0022";
                    process.StartInfo.WindowStyle = System.Diagnostics.ProcessWindowStyle.Normal;
                    process.Start();
                }
                else
                {
                    MessageBox.Show(FFBatch.Properties.Strings.no_path, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            }
            String second_path = "";
            if (txt_format.Text == "nul")
            {
                String[] split = txt_parameters.Text.Split(' ');
                for (int i = 0; i < split.Length; i++)
                {
                    if (split[i].Contains("\\") == true)
                    {
                        String pre_path = split[i].Replace("%fp", Path.GetDirectoryName(fullPath)).Replace("%", "_");

                        second_path = Path.GetDirectoryName(pre_path.Replace('\u0022', ' '));

                        if (Directory.Exists(second_path))
                        {
                            var process = new System.Diagnostics.Process();
                            process.StartInfo.FileName = "explorer.exe";
                            process.StartInfo.Arguments = "\u0022" + second_path + "\u0022";
                            process.StartInfo.WindowStyle = System.Diagnostics.ProcessWindowStyle.Normal;
                            process.Start();
                        }
                        else
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.no_path, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        }
                    }
                }
            }
        }

        private void cti4_Click(object sender, EventArgs e)
        {
            media_info();
        }

        private void media_info()
        {
            if (listView1.Items.Count == 1) listView1.Items[0].Selected = true;

            String ffm = System.IO.Path.Combine(Application.StartupPath, "mediainfo.exe");
            if (!File.Exists(ffm))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_mediainfo, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (listView1.SelectedItems.Count == 1)
            {
                String file1 = System.IO.Path.Combine(Application.StartupPath + "\\", "mediainfo.exe");
                String fullPath = "\u0022" + listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text + "\u0022";
                String testPath = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
                if (!File.Exists(testPath))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file_not_found, FFBatch.Properties.Strings.file_miss, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
                this.Cursor = Cursors.WaitCursor;

                String salida = "";

                Form frmInfo = new Form();
                frmInfo.Name = FFBatch.Properties.Strings.multi_info;
                frmInfo.Text = "FFmpeg Batch AV Converter";
                if (is_portable == true) frmInfo.Text = "FFmpeg Batch AV Converter Portable";
                frmInfo.Icon = this.Icon;
                frmInfo.Height = 721;
                frmInfo.Width = 492;
                frmInfo.FormBorderStyle = FormBorderStyle.FixedSingle;
                frmInfo.MaximizeBox = false;
                frmInfo.MinimizeBox = false;
                frmInfo.BackColor = this.BackColor;

                var fuente_list = new System.Drawing.Font("Microsoft Sans Serif", 9, FontStyle.Regular);

                ListView LB1 = new ListView();
                LB1.Parent = frmInfo;
                LB1.ShowItemToolTips = true;
                LB1.Left = 14;
                LB1.Top = 56;
                LB1.Height = 587;
                LB1.Width = 447;
                LB1.SmallImageList = img_streams;
                LB1.View = View.Details;
                LB1.FullRowSelect = true;
                LB1.GridLines = true;
                LB1.Columns.Add("", 130);
                LB1.Columns.Add("", 295);
                LB1.HeaderStyle = ColumnHeaderStyle.None;
                LB1.Refresh();

                TextBox titulo = new TextBox();
                titulo.Parent = frmInfo;
                titulo.Top = 6;
                titulo.Left = 14;
                titulo.Width = 448;
                titulo.TabIndex = 0;
                var fuente = new System.Drawing.Font("Microsoft Sans Serif", 10, FontStyle.Bold);
                titulo.BackColor = this.BackColor;

                titulo.Font = fuente;
                titulo.BorderStyle = BorderStyle.Fixed3D;
                titulo.TextAlign = HorizontalAlignment.Center;
                titulo.ReadOnly = true;

                if (full_report == false) titulo.Text = FFBatch.Properties.Strings.multi_summary;
                else titulo.Text = FFBatch.Properties.Strings.multi_full;

                Button boton_ok = new Button();
                boton_ok.Parent = frmInfo;
                boton_ok.Left = 73;
                boton_ok.Top = 650;
                boton_ok.Width = 330;
                boton_ok.Height = 27;
                boton_ok.Text = FFBatch.Properties.Strings.close_win;
                boton_ok.Click += new EventHandler(boton_ok_Click);
                frmInfo.CancelButton = boton_ok;

                Button btn_next = new Button();
                btn_next.Parent = frmInfo;
                btn_next.Left = 404;
                btn_next.Top = 650;
                btn_next.Width = 59;
                btn_next.Height = 27;
                btn_next.Text = FFBatch.Properties.Strings.next;
                btn_next.Click += new EventHandler(btn_next_Click);

                Button btn_prev = new Button();
                btn_prev.Parent = frmInfo;
                btn_prev.Left = 14;
                btn_prev.Top = 650;
                btn_prev.Width = 59;
                btn_prev.Height = 27;
                btn_prev.Text = FFBatch.Properties.Strings.prev;
                btn_prev.Click += new EventHandler(btn_prev_Click);

                String fichero = Path.GetFileName(listView1.SelectedItems[0].Text);
                TextBox titulo2 = new TextBox();
                titulo2.Parent = frmInfo;
                titulo2.Top = 34;
                titulo2.Left = 14;
                titulo2.Width = 440;
                titulo2.BackColor = this.BackColor;

                titulo2.BorderStyle = BorderStyle.None;
                titulo2.TextAlign = HorizontalAlignment.Center;
                titulo2.ReadOnly = true;

                titulo2.Text = fichero;

                if (Properties.Settings.Default.dark_mode == true)
                {
                    foreach (Control c in frmInfo.Controls) UpdateColorDark(c);
                    frmInfo.BackColor = Color.FromArgb(255, 64, 64, 64);
                }

                int indx = 0;
                List<string> salida1 = new List<string>();
                var font_item = new System.Drawing.Font("Microsoft Sans Serif", 8, FontStyle.Bold);

                String[] fields_mi = new string[] { "Format  ", "Bit depth", "General", "Bit rate", "bit rate", "Duration", "Audio", "Frame rate  ", "Width", "Height", "Color space", "Chroma subsampling", "Channel(s)", "Channel positions", "Sampling rate ", "Maximum bit rate", "File size", "Format profile", "Display aspect ratio", "Stream size", "Text", "Language", "Recorded date", "Performer", "Album", "Genre", "Track name" };

                var process = new System.Diagnostics.Process();
                process.StartInfo.WindowStyle = System.Diagnostics.ProcessWindowStyle.Hidden;
                process.StartInfo.FileName = file1;
                process.StartInfo.Arguments = fullPath;
                process.StartInfo.UseShellExecute = false;
                process.StartInfo.CreateNoWindow = true;
                process.StartInfo.RedirectStandardOutput = true;
                process.StartInfo.StandardOutputEncoding = Encoding.UTF8;
                process.Start();

                while (!process.StandardOutput.EndOfStream)
                {
                    salida = process.StandardOutput.ReadLine();
                    salida1.Add(salida);
                }
                process.WaitForExit();
                LB1.BeginUpdate();

                foreach (String salida2 in salida1)
                {
                    Boolean match = false;
                    if (full_report == false)
                    {
                        foreach (String str in fields_mi)
                        {
                            if (salida2.Contains(str))
                            {
                                match = true;
                                break;
                            }
                        }
                    }
                    else match = true;

                    if (salida2 == "" || salida2 == "Video" || match == true)

                    {
                        int derecha = 0;

                        if (!salida2.Contains("  : "))
                        {
                            LB1.Items.Add(salida2.ToUpper());
                            LB1.Items[indx].Font = font_item;
                            LB1.Items[indx].ForeColor = Color.DarkBlue;
                            if (salida2 != String.Empty)
                            {
                                LB1.Items[indx].SubItems[0].BackColor = Color.FromArgb(255, 220, 238, 255);
                                if (salida2.Contains("Video"))
                                {
                                    LB1.Items[indx].ImageIndex = 0;
                                    LB1.Items[indx].SubItems[0].BackColor = Color.FromArgb(255, 255, 242, 222);
                                }
                                if (salida2.Contains("Audio")) LB1.Items[indx].ImageIndex = 1;
                                if (salida2.Contains("Text")) LB1.Items[indx].ImageIndex = 2;
                                if (salida2.Contains("General"))
                                {
                                    LB1.Items[indx].ImageIndex = 5;
                                    LB1.Items[indx].SubItems[0].BackColor = Color.FromArgb(255, 255, 248, 220);
                                }
                            }

                            indx = indx + 1;
                        }
                        else

                        {
                            if (!salida2.Contains("SPF"))
                            {
                                LB1.Items.Add(salida2.Substring(0, salida2.LastIndexOf("  : ")).Replace("  ", ""));
                                derecha = salida2.Length - (salida2.LastIndexOf("  :"));
                                LB1.Items[indx].SubItems.Add(salida2.Substring(salida2.LastIndexOf("  :") + 4, derecha - 4).Replace("kb", "Kb"));
                                indx = indx + 1;
                            }
                        }
                    }
                }

                for (int x = 0; x < 2; x++)
                {
                    LB1.Items.RemoveAt(LB1.Items.Count - 1);
                }

                int duraciones = 0;
                String elemento = "";
                for (int i = 0; i < LB1.Items.Count; i++)
                {
                    elemento = LB1.Items[i].Text;

                    if (elemento.Contains(FFBatch.Properties.Strings.duration))
                    {
                        duraciones = duraciones + 1;

                        if (duraciones > 1)
                        {
                            LB1.Items.RemoveAt(i);
                        }
                    }
                }

                foreach (ListViewItem item in LB1.Items)
                {
                    if (item.Text == String.Empty)
                    {
                        item.Remove();
                    }
                }
                LB1.EndUpdate();
                frmInfo.StartPosition = FormStartPosition.CenterParent;
                this.Cursor = Cursors.Arrow;
                frmInfo.ShowDialog();
            }
            else

            {
                MessageBox.Show(FFBatch.Properties.Strings.no_item_sel, FFBatch.Properties.Strings.information, MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
            this.Cursor = Cursors.Arrow;
        }

        private void button6_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            if (!File.Exists(Path.Combine(Application.StartupPath, "ffmpeg.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_ffmpeg, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            folderBrowserDialog1.Description = FFBatch.Properties.Strings.not_subfolders;
            if (add_subfs == true)
            {
                folderBrowserDialog1.Description = FFBatch.Properties.Strings.yes_subfolders;
            }

            folderBrowserDialog1.ShowNewFolderButton = false;

            change_tab_1 = false;
            change_tab_2 = false;

            list_not_empty = listView1.Items.Count > 0;

            if (tabControl1.SelectedIndex == 1)
            {
                change_tab_1 = true;
            }
            else if (tabControl1.SelectedIndex == 2)
            {
                change_tab_2 = true;
            }
            int fl = 0;
            if (folderBrowserDialog1.ShowDialog() == DialogResult.OK)
            {
                Form11_2 frm11_2 = new Form11_2();
                Task t2 = Task.Run(() =>
                {
                    frm11_2.label1.Text = FFBatch.Properties.Strings.reading_path;
                    frm11_2.ShowDialog();
                });
                Thread.Sleep(100);
                List<string> files2 = new List<string>();

                foreach (string file in Directory.GetFiles(folderBrowserDialog1.SelectedPath))
                {
                    if (!File.GetAttributes(file).HasFlag(FileAttributes.Hidden))
                    {
                        files2.Add(file);
                        fl = fl + 1;
                        if (frm11_2.abort_validate) return;
                        try
                        {
                            frm11_2.Invoke(new MethodInvoker(delegate
                            {
                                frm11_2.label2.Text = fl.ToString() + " " + FFBatch.Properties.Strings.files;
                            }));
                        }
                        catch { }
                    }
                }

                int num_drop = files2.Count();

                if (add_subfs == true)
                {
                    string[] dirs = Directory.GetDirectories(folderBrowserDialog1.SelectedPath);

                    foreach (string ds in dirs)
                    {
                        try
                        {
                            foreach (string f in Directory.GetFiles(ds, "*.*", System.IO.SearchOption.AllDirectories))
                            {
                                if (!File.GetAttributes(f).HasFlag(FileAttributes.Hidden))
                                {
                                    files2.Add(f);
                                    fl = fl + 1;
                                    num_drop++;
                                    if (frm11_2.abort_validate) return;
                                    try
                                    {
                                        frm11_2.Invoke(new MethodInvoker(delegate
                                        {
                                            frm11_2.label2.Text = fl.ToString() + " " + FFBatch.Properties.Strings.files;
                                        }));
                                    }
                                    catch { }
                                }
                            }
                        }
                        catch (System.Exception excpt)
                        {
                            try
                            {
                                frm11_2.Invoke(new MethodInvoker(delegate
                                {
                                    frm11_2.TopMost = true;
                                    frm11_2.TopMost = false;
                                }));
                            }
                            catch { }
                            var a = MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message + " " + FFBatch.Properties.Strings2.contin, FFBatch.Properties.Strings.error3, MessageBoxButtons.OKCancel, MessageBoxIcon.Error);
                            if (a == DialogResult.Cancel)
                            {
                                try
                                {
                                    frm11_2.Invoke(new MethodInvoker(delegate
                                    {
                                        frm11_2.Dispose();
                                    }));
                                }
                                catch { }
                                return;
                            }
                        }
                    }
                }
                Thread.Sleep(100);
                try
                {
                    frm11_2.Invoke(new MethodInvoker(delegate
                    {
                        frm11_2.Dispose();
                    }));
                }
                catch { }

                if (num_drop == 0)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.folder_empty, FFBatch.Properties.Strings.information, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                files_to_add = files2;
                canceled_file_adding = false;
                btn_cancel_add.Enabled = true;
                btn_cancel_add.Visible = true;
                btn_cancel_add.Refresh();
                BG_Files.RunWorkerAsync();
            }
            else from_wizard = false;
        }

        private void ctdel_Click(object sender, EventArgs e)
        {
            if (multi_running == true)
            {
                foreach (ListViewItem item in listView1.SelectedItems)
                {
                    item.SubItems[5].Text = FFBatch.Properties.Strings.skipped;
                    if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                    {
                        total_duration = total_duration - TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds;
                    }
                }
                return;
            }

            if (listView1.SelectedItems.Count > 0)
            {
                listView1.BeginUpdate();
                foreach (ListViewItem item in listView1.SelectedItems)
                {
                    if (working == false)
                    {
                        listView1.Items.Remove(item);

                        foreach (ListViewItem item2 in listView3.Items)
                        {
                            if (item2.Text == item.Text)
                            {
                                listView3.Items.RemoveAt(item2.Index);
                            }
                        }
                    }
                    else
                    {
                        if (item.SubItems[5].Text == FFBatch.Properties.Strings.queued)
                        {
                            listView1.Items.RemoveAt(item.Index);
                        }
                    }
                }

                listView1.EndUpdate();
                lbl_items.Text = listView1.Items.Count + " " + FFBatch.Properties.Strings.files;

                calc_total_dur();
                calc_list_size();

                if (working == true && multi_running == false)
                {
                    total_duration = 0;

                    foreach (ListViewItem item in listView1.Items)
                    {
                        if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                        {
                            total_duration = total_duration + TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds - TimeSpan.Parse(ss_time_input.Text).TotalSeconds;
                        }
                        else
                        {
                            total_duration = total_duration + 0;
                        }
                    }
                }
            }
        }

        private void ctm_add_files_Click(object sender, EventArgs e)
        {
            this.btn_add_files.PerformClick();
        }

        private void ctm_add_folder_Click(object sender, EventArgs e)
        {
            this.btn_add_folders.PerformClick();
        }

        private void boton_ok_Click(object sender, System.EventArgs e)
        {
            Form.ActiveForm.Close();
        }

        private void btn_next_Click(object sender, System.EventArgs e)
        {
            Form.ActiveForm.Close();
            if (listView1.SelectedItems[0].Index < listView1.Items.Count - 1)
            {
                listView1.Items[listView1.SelectedIndices[0] + 1].Selected = true;
                listView1.Items[listView1.SelectedIndices[0]].Selected = false;
                listView1.Select();
                cti4.PerformClick();
            }
        }

        private void btn_prev_Click(object sender, System.EventArgs e)
        {
            Form.ActiveForm.Close();
            if (listView1.SelectedItems[0].Index > 0)
            {
                int selected_item = listView1.SelectedIndices[0];
                //listView1.Items[listView1.SelectedIndices[0] - 2].Selected = true;
                listView1.Items[selected_item].Selected = false;
                listView1.Items[selected_item - 1].Selected = true;
                listView1.Select();
                cti4.PerformClick();
            }
        }

        private void boton_ok_wave_Click(object sender, System.EventArgs e)
        {
            Form.ActiveForm.Close();
        }

        private void boton_kill_Click(object sender, System.EventArgs e)
        {
            cancelados_paralelos = true;
            cancel_queue = true;

            Form.ActiveForm.Close();

            Process[] localByName = Process.GetProcessesByName("ffmpeg");
            foreach (Process p in localByName)
                p.Kill();
            System.Threading.Thread.Sleep(250);
            Process[] localByName2 = Process.GetProcessesByName("ffmpeg");
            foreach (Process p2 in localByName2)
                p2.Kill();
        }

        private void boton_ok_ff_Click(object sender, System.EventArgs e)
        {
            Form.ActiveForm.Close();
            this.InvokeEx(f => this.Enabled = true);
        }

        private void boton_copy_kf_Click(object sender, System.EventArgs e)
        {
            String lista = "Video keyframes" + Environment.NewLine;

            foreach (ListViewItem item in LB1_kf.Items)
            {
                try
                {
                    lista = lista + Environment.NewLine + item.Text + " --- " + item.SubItems[1].Text + " ---" + item.SubItems[3].Text;
                }
                catch
                {
                    continue;
                }
            }

            String temp_file = Path.Combine(Path.GetTempPath(), "temp_copy_kf.ff");
            if (File.Exists(temp_file))
            {
                try
                {
                    File.Delete(temp_file);
                }
                catch
                {
                    MessageBox.Show(Properties.Strings2.err_clipb);
                    return;
                }
            }

            File.WriteAllText(Path.Combine(Path.GetTempPath(), "temp_copy_kf.ff"), lista);
            Process.Start("notepad.exe", Path.Combine(Path.GetTempPath(), "temp_copy_kf.ff"));
        }

        private void boton_copy_ff_Click(object sender, System.EventArgs e)
        {
            String lista = String.Empty;

            for (int i = 0; i < LB1_o_try.Items.Count; i++)
            {
                lista = lista + Environment.NewLine + LB1_o_try.Items[i].ToString();
            }

            String temp_file = Path.Combine(Path.GetTempPath(), "temp_copy_clp.ff");
            if (File.Exists(temp_file))
            {
                try
                {
                    File.Delete(temp_file);
                }
                catch
                {
                    MessageBox.Show(Properties.Strings2.err_clipb);
                }
            }

            File.WriteAllText(Path.Combine(Path.GetTempPath(), "temp_copy_clp.ff"), lista);
            Process.Start("notepad.exe", Path.Combine(Path.GetTempPath(), "temp_copy_clp.ff"));
        }

        private void LB1_o_Click(object sender, System.EventArgs e)
        {
            //Form.ActiveForm.Close();
        }

        private void Timer_apaga_Tick(object sender, EventArgs e)
        {
            tiempo_apaga = tiempo_apaga - 1;

            if (tiempo_apaga % 2 == 0)

            {
                TB1.ForeColor = Color.Black;
                this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, 100, 100));
                this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.Paused));
            }
            else
            {
                TB1.ForeColor = Color.DarkRed;
                this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, 100, 100));
                this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.Error));
            }

            TB1.Text = Properties.Strings2.computer_will + " " + combo_shut.SelectedItem.ToString().ToUpper() + " IN " + (tiempo_apaga / 2).ToString() + " " + FFBatch.Properties.Strings.seconds;

            if (tiempo_apaga == 0)
            {
                if (combo_shut.SelectedIndex == 0)
                {
                    Process apagar = new System.Diagnostics.Process();
                    apagar.StartInfo.FileName = "shutdown.exe";
                    apagar.StartInfo.Arguments = "-s -t 60";
                    apagar.StartInfo.CreateNoWindow = true;
                    apagar.Start();
                    //Application.Exit();
                    TB1.Text = Properties.Strings2.autoshut_st;
                }
                else if (combo_shut.SelectedIndex == 1) Application.SetSuspendState(PowerState.Hibernate, true, true);
                else if (combo_shut.SelectedIndex == 2) Application.SetSuspendState(PowerState.Suspend, true, true);
                Timer_apaga.Stop();
            }
        }

        private void disable_abort_btn()
        {
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.tabControl1.Enabled = false);
            this.InvokeEx(f => f.btn_stop_m3u8.Enabled = false);
        }

        private void button10_Click(object sender, EventArgs e)
        {
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.Normal));
            this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, 0, 100));
            this.TopMost = false;
            Enable_Controls();
            chkshut.Enabled = true;
            btn_pause.Enabled = true;
            txt_parameters.Enabled = true;
            btn_save_config.Enabled = true;
            btn_load_config.Enabled = true;

            chk_open_compl.Enabled = true;

            Timer_apaga.Stop();
            TB1.Visible = false;
            TB1.Text = Properties.Strings2.autoshut_en;
            btn_cancel_shut.Visible = false;

            chkshut.CheckState = CheckState.Unchecked;
            notifyIcon1.Visible = false;
            txt_remain.Text = Properties.Strings.remain_time;

            if (tiempo_apaga == 0)
            {
                Process no_apagar = new System.Diagnostics.Process();
                no_apagar.StartInfo.FileName = "shutdown.exe";
                no_apagar.StartInfo.Arguments = "-a";
                no_apagar.StartInfo.UseShellExecute = false;
                no_apagar.StartInfo.CreateNoWindow = true;
                no_apagar.Start();
            }
            tiempo_apaga = 120;
        }

        private void comboBox1_DropDown(object sender, EventArgs e)
        {
            if (combo_presets.Text == "")
            {
                return;
            }

            String path = String.Empty;
            String path_pr = String.Empty;

            if (is_portable == false)
            {
                path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.ini";
                path_pr = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_presets.ini";
            }
            else
            {
                path = port_path + "ff_batch_portable.ini";
                path_pr = port_path + "ff_presets_portable.ini";
            }

            if (combo_presets.SelectedIndex == 0)
            {
                int linea = 0;
                foreach (string line in File.ReadLines(path))
                {
                    linea = linea + 1;

                    if (linea == 1)
                    {
                        txt_parameters.Text = line;
                    }
                    else if (linea == 2)
                    {
                        txt_format.Text = line;
                    }

                    if (line == "Yes")

                    {
                        chk_open_compl.CheckState = CheckState.Checked;
                    }

                    if (line == "No")
                    {
                        chk_open_compl.CheckState = CheckState.Unchecked;
                    }
                }
            }
            else
            {
                if (File.Exists(path_pr)) path = path_pr;
                foreach (string line in File.ReadLines(path))
                {
                    if (line.Contains(combo_presets.Text))
                    {
                        int cortar = line.LastIndexOf("%") - line.LastIndexOf("&");

                        txt_format.Text = line.Substring(line.LastIndexOf("%") + 2);
                        txt_parameters.Text = line.Substring(line.LastIndexOf("&") + 2, cortar - 3);
                    }
                }
            }
        }

        private void button13_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            if (!File.Exists(Path.Combine(Application.StartupPath, "ffmpeg.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_ffmpeg, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            String path = "cmd.exe";
            String param = String.Empty;
            Process ff_ext = new Process();
            if (listView1.Items.Count == 0) param = "/k " + "ffmpeg.exe -version " + '\u0022' + "chcp 65001 >nul " + '\u0022';
            else
            {
                if (send_par_consol == true)
                {
                    if (!Directory.Exists(Path.GetTempPath() + "FFBatch_test"))
                    {
                        try
                        {
                            Directory.CreateDirectory(Path.GetTempPath() + "FFBatch_test");
                        }
                        catch (Exception excpt)
                        {
                            MessageBox.Show(Properties.Strings2.err_test_temp + Environment.NewLine + excpt.Message, Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                        }
                    }

                    param = "/k " + "ffmpeg.exe " + txt_pre_input.Text + " -i " + '\u0022' + listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text + '\u0022' + " " + txt_parameters.Text + " " + '\u0022' + Path.GetTempPath() + "FFBatch_test" + "\\" + Path.GetFileNameWithoutExtension(listView1.Items[0].Text) + "." + txt_format.Text + '\u0022';
                    Clipboard.SetText(param.Substring(3, param.Length - 3));
                }
                else param = "/k " + "ffmpeg.exe -version " + '\u0022' + "chcp 65001 >nul " + '\u0022';
            }

            ff_ext.StartInfo.FileName = path;
            ff_ext.StartInfo.Arguments = param;
            ff_ext.Start();
            if (listView1.Items.Count == 0) Clipboard.GetText();
            ff_ext.WaitForExit();
        }

        private void chkshut_CheckedChanged(object sender, EventArgs e)
        {
            Pg1.Focus();
            if (btn_cancel_shut.Visible == true)
            {
                return;
            }

            if (chkshut.Checked == false)
            {
                TB1.Visible = false;
                chkshut.ImageIndex = 0;
                combo_shut.Enabled = false;
                group_prog.Focus();
            }
            else
            {
                chkshut.ImageIndex = 1;
                combo_shut.Enabled = true;
                chk_delete_source.CheckState = CheckState.Unchecked;
            }
        }

        private void OnApplicationExit(object sender, EventArgs e)
        {
            Process[] localByName = Process.GetProcessesByName("ffmpeg");
            foreach (Process p in localByName)
                p.Kill();
        }

        private void listView1_DragDrop(object sender, DragEventArgs e)
        {
            listView1.BackgroundImage = null;
            if (Properties.Settings.Default.dark_mode == false) listView1.BackColor = SystemColors.Window;
            else
                listView1.BackColor = Color.FromArgb(255, 64, 64, 64);

            change_tab_1 = false;
            change_tab_2 = false;

            string[] file_drop = (string[])e.Data.GetData(DataFormats.FileDrop);

            List<string> files2 = new List<string>();

            int num_drop = 0;

            //Load queue file

            if (file_drop.Count() == 1 && Path.GetExtension(file_drop[0]) == ".ffq")
            {
                int linea = 0;
                int not_found = 0;
                combo_presets.Text = "";
                List<ListViewItem> itemsToAdd = new List<ListViewItem>();
                try
                {
                    foreach (string line in File.ReadLines(file_drop[0]))
                    {
                        if (linea == 0)
                        {
                            txt_parameters.Text = line;
                        }
                        else if (linea == 1)
                        {
                            txt_format.Text = line;
                        }
                        else if (linea == 2)
                        {
                            checkBox1.CheckState = line == "Unchecked" ? CheckState.Unchecked : CheckState.Checked;
                        }

                        else if (linea == 3)
                        {
                            if (line == "Unchecked") chk_suffix.CheckState = CheckState.Unchecked;
                            else
                            {
                                chk_suffix.CheckState = CheckState.Checked;
                                txt_suffix.Text = line;
                            }
                        }
                        else if (linea == 4)
                        {
                            txt_path_main.Text = line;
                        }
                        else if (linea > 4)
                        {
                            Boolean missing = false;
                            listView1.SmallImageList = imageList2;

                            itemsToAdd.Add(new ListViewItem(Path.GetFileName(line.Substring(0, line.LastIndexOf(" --0 "))), 1));
                            //ListViewItem elemento = new ListViewItem(line.Substring(0, line.LastIndexOf(" --0 ")), 1);
                            //Begin get file icon
                            Icon iconForFile = SystemIcons.WinLogo;

                            // Check to see if the image collection contains an image
                            // for this extension, using the extension as a key.
                            if (File.Exists(line.Substring(0, line.LastIndexOf(" --0 "))))
                            {
                                if (!imageList2.Images.ContainsKey(System.IO.Path.GetExtension(line.Substring(0, line.LastIndexOf(" --0 ")))))
                                {
                                    // If not, add the image to the image list.
                                    iconForFile = System.Drawing.Icon.ExtractAssociatedIcon(line.Substring(0, line.LastIndexOf(" --0 ")));
                                    imageList2.Images.Add(System.IO.Path.GetExtension(line.Substring(0, line.LastIndexOf(" --0 "))), iconForFile);
                                }

                                //listView1.Items.Add(elemento);
                                itemsToAdd[linea - 5].ImageKey = System.IO.Path.GetExtension(System.IO.Path.GetExtension(line.Substring(0, line.LastIndexOf(" --0 "))));
                            }
                            else
                            {
                                not_found = not_found + 1;
                                missing = true;
                            }

                            //listView1.Items.Add(line.Substring(0,line.LastIndexOf(" --0 ")));
                            String type = line.Substring(line.LastIndexOf(" --0 ") + 5, line.Length - (line.LastIndexOf(" --0") + 5));
                            type = type.Substring(0, type.LastIndexOf(" --1"));
                            String dur = line.Substring(line.LastIndexOf(" --1 ") + 5, line.Length - (line.LastIndexOf(" --1") + 5));
                            dur = dur.Substring(0, dur.LastIndexOf(" --2"));
                            String size = line.Substring(line.LastIndexOf(" --2 ") + 5, line.Length - (line.LastIndexOf(" --2") + 5));
                            size = size.Substring(0, size.LastIndexOf(" --3"));
                            String status = line.Substring(line.LastIndexOf(" --3 ") + 5, line.Length - (line.LastIndexOf(" --3") + 5));

                            itemsToAdd[linea - 5].SubItems.Add(Path.GetDirectoryName(line.Substring(0, line.LastIndexOf(" --0 "))));
                            itemsToAdd[linea - 5].SubItems.Add(type);
                            itemsToAdd[linea - 5].SubItems.Add(dur);
                            itemsToAdd[linea - 5].SubItems.Add(size);
                            if (missing == false) itemsToAdd[linea - 5].SubItems.Add(status);
                            else
                            {
                                itemsToAdd[linea - 5].SubItems.Add(FFBatch.Properties.Strings.file_not_f);
                                itemsToAdd[linea - 5].BackColor = Color.LightGoldenrodYellow;
                            }
                        }
                        linea = linea + 1;
                    }
                    listView1.Items.AddRange(itemsToAdd.ToArray());
                }
                catch (Exception excpt)
                {
                    this.Cursor = Cursors.Arrow;
                    MessageBox.Show(FFBatch.Properties.Strings.err_qf + Environment.NewLine + excpt.Message, Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    btn_load_config.PerformClick();
                    read_saved_path();
                    return;
                }
                this.Cursor = Cursors.Arrow;

                if (tabControl1.SelectedIndex == 0)
                {
                    calc_list_size();
                    calc_total_dur();
                    lbl_items.Text = listView1.Items.Count.ToString() + " " + FFBatch.Properties.Strings.files;

                    if (not_found > 0)
                    {
                        this.Cursor = Cursors.Arrow;
                        MessageBox.Show(FFBatch.Properties.Strings.queue_ok + Environment.NewLine + not_found.ToString() + " " + FFBatch.Properties.Strings2.queue_not_f + " " + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings2.sort_status + " " + '\u0022' + FFBatch.Properties.Strings.file_not_f + '\u0022' + ".", Properties.Strings2.missing_f, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    }
                    return;
                }
            }

            //End load queue file
            int fl = 0;
            Form11_2 frm11_2 = new Form11_2();
            Task t2 = Task.Run(() =>
            {
                frm11_2.label1.Text = FFBatch.Properties.Strings.reading_path;
                frm11_2.ShowDialog();
            });
            Thread.Sleep(100);

            foreach (String dropped in file_drop)
            {
                if (File.Exists(dropped))
                {
                    files2.Add(dropped);
                    num_drop = files2.Count();

                    if (frm11_2.abort_validate) return;
                    else
                    {
                        try
                        {
                            frm11_2.Invoke(new MethodInvoker(delegate
                            {
                                frm11_2.label2.Text = fl.ToString() + " " + FFBatch.Properties.Strings.files;
                            }));
                        }
                        catch { }
                    }
                }
                else
                {
                    if (Directory.Exists(dropped))
                    {
                        if (add_subfs == false)
                        {
                            foreach (String file in Directory.GetFiles(dropped))
                            {
                                if (!File.GetAttributes(file).HasFlag(FileAttributes.Hidden))
                                {
                                    files2.Add(file);
                                    fl = fl + 1;
                                    num_drop = num_drop + 1;

                                    if (frm11_2.abort_validate) return;
                                    else
                                    {
                                        try
                                        {
                                            frm11_2.Invoke(new MethodInvoker(delegate
                                            {
                                                frm11_2.label2.Text = fl.ToString() + " " + FFBatch.Properties.Strings.files;
                                            }));
                                        }
                                        catch { }
                                    }
                                }
                            }
                        }
                        else
                        {
                            try
                            {
                                foreach (string f in Directory.GetFiles(dropped, "*.*", System.IO.SearchOption.AllDirectories))
                                {
                                    if (!File.GetAttributes(f).HasFlag(FileAttributes.Hidden))
                                    {
                                        files2.Add(f);
                                        fl = fl + 1;
                                        num_drop = num_drop + 1;

                                        if (frm11_2.abort_validate == true) return;
                                        else
                                        {
                                            try
                                            {
                                                frm11_2.Invoke(new MethodInvoker(delegate
                                                {
                                                    frm11_2.label2.Text = fl.ToString() + " " + FFBatch.Properties.Strings.files;
                                                }));
                                            }
                                            catch { }
                                        }
                                    }
                                }
                            }
                            catch (System.Exception excpt)
                            {
                                try
                                {
                                    frm11_2.Invoke(new MethodInvoker(delegate
                                    {
                                        frm11_2.TopMost = true;
                                        frm11_2.TopMost = false;
                                    }));
                                }
                                catch { }
                                try
                                {
                                    frm11_2.Invoke(new MethodInvoker(delegate
                                    {
                                        frm11_2.Dispose();
                                    }));
                                }
                                catch { }
                                var a = MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message, FFBatch.Properties.Strings.error3, MessageBoxButtons.OK, MessageBoxIcon.Error);
                                return;
                            }
                        }
                    }
                }
            }

            Thread.Sleep(100);
            try
            {
                frm11_2.Invoke(new MethodInvoker(delegate
                {
                    frm11_2.Dispose();
                }));
            }
            catch { }

            files_to_add = files2;
            canceled_file_adding = false;
            btn_cancel_add.Enabled = true;
            btn_cancel_add.Visible = true;
            btn_cancel_add.Refresh();
            BG_Files.RunWorkerAsync();
        }

        private void listView1_DragEnter(object sender, DragEventArgs e)
        {
            if (e.Data.GetDataPresent(DataFormats.FileDrop, false))

            {
                e.Effect = DragDropEffects.All;
                if (Properties.Settings.Default.dark_mode == true) listView1.BackColor = Color.FromArgb(255, 128, 128, 128);
                else
                {
                    using (var bmp1 = new Bitmap(listView1.ClientSize.Width, listView1.ClientSize.Height - 24))
                    {
                        using (var g1 = Graphics.FromImage(bmp1))
                        {
                            g1.DrawImage(pic_drag.Image, 0, 0, bmp1.Width, bmp1.Height);
                            listView1.BackgroundImage = bmp1;
                        }
                    }
                }
            }
            else
            {
                e.Effect = DragDropEffects.None;
            }
        }

        private void button16_Click(object sender, EventArgs e)
        {
            listView1.View = View.LargeIcon;
        }

        private void listView1_KeyUp(object sender, KeyEventArgs e)
        {
            if (e.KeyCode != Keys.Delete || multi_running == true) return;

            if (working == true)
            {
                Boolean remove = true;
                foreach (ListViewItem item in listView1.SelectedItems)
                {
                    if (item.SubItems[5].Text != FFBatch.Properties.Strings.queued)
                    {
                        remove = false;
                        break;
                    }
                }

                if (e.KeyCode == Keys.Delete && remove == true)
                {
                    ctdel.PerformClick();
                }
                return;
            }

            if (e.KeyCode == Keys.Delete)
            {
                ctdel.PerformClick();
            }
        }

        private void button17_Click(object sender, EventArgs e)
        {
            listView1.Sorting = SortOrder.Ascending;
        }

        private void button17_Click_1(object sender, EventArgs e)
        {
            foreach (ListViewItem n_a in listView1.Items)
            {
                if (n_a.BackColor == Color.LightGoldenrodYellow)
                {
                    n_a.Remove();
                }
            }
            lbl_items.Text = listView1.Items.Count + " " + FFBatch.Properties.Strings.files;
        }

        private void listView1_DoubleClick(object sender, EventArgs e)
        {
            media_info();
        }

        private void listView1_ColumnClick(object sender, ColumnClickEventArgs e)
        {
            if (working == true) return;
            System.Globalization.CultureInfo ci = System.Threading.Thread.CurrentThread.CurrentUICulture;
            String separator = ci.NumberFormat.NumberDecimalSeparator;
            String sep_th = ci.NumberFormat.CurrencyGroupSeparator;

            ListView myListView = (ListView)sender;

            if (e.Column == 4)
            {
                lvwColumnSorter_Full.SortColumn = 4;
                if (size_sorted == false)
                {
                    size_sorted = true;
                    lvwColumnSorter_Full.Order = SortOrder.Descending;
                }
                else
                {
                    size_sorted = false;
                    lvwColumnSorter_Full.Order = SortOrder.Ascending;
                }

                if (listView1.Items.Count > 6000) this.Cursor = Cursors.WaitCursor;
                listView1.BeginUpdate();

                foreach (ListViewItem item in listView1.Items)
                {
                    String filename = item.SubItems[1].Text + "\\" + item.Text;
                    if (File.Exists(filename))
                    {
                        FileInfo fi = new FileInfo(filename);
                        item.SubItems[4].Text = fi.Length.ToString("D13");
                    }
                    else
                    {
                        item.SubItems[4].Text = "0000000000000";
                    }
                }
                ColumnHeader new_sorting_column = listView1.Columns[e.Column];

                // Figure out the new sorting order.

                System.Data.SqlClient.SortOrder sort_order;
                if (SortingColumn == null)
                {
                    // New column. Sort ascending.
                    sort_order = System.Data.SqlClient.SortOrder.Ascending;
                }
                else
                {
                    // See if this is the same column.
                    if (new_sorting_column == SortingColumn)
                    {
                        // Same column. Switch the sort order.
                        if (SortingColumn.Text.StartsWith("> "))
                        {
                            sort_order = System.Data.SqlClient.SortOrder.Descending;
                        }
                        else
                        {
                            sort_order = System.Data.SqlClient.SortOrder.Ascending;
                        }
                    }
                    else
                    {
                        // New column. Sort ascending.
                        sort_order = System.Data.SqlClient.SortOrder.Ascending;
                    }

                    // Remove the old sort indicator.
                    SortingColumn.Text = SortingColumn.Text.Substring(2);
                }

                // Display the new sort order.
                SortingColumn = new_sorting_column;
                if (sort_order == System.Data.SqlClient.SortOrder.Ascending)
                {
                    SortingColumn.Text = "> " + SortingColumn.Text;
                }
                else
                {
                    SortingColumn.Text = "< " + SortingColumn.Text;
                }

                // Create a comparer.
                listView1.ListViewItemSorter =
                    new ListViewComparer(e.Column, sort_order);

                // Sort.
                listView1.Sort();

                foreach (ListViewItem item in listView1.Items)
                {
                    //Format size view
                    var bytes = long.Parse(item.SubItems[4].Text);

                    var kilobytes = (double)bytes / 1024;
                    var megabytes = kilobytes / 1024;
                    var gigabytes = megabytes / 1024;

                    String size = "";

                    if (bytes > 1000000000)
                    {
                        String gigas = gigabytes.ToString();
                        if (gigas.Length >= 5)
                        {
                            gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                            size = (gigas + " " + "GB");
                        }
                        else
                        {
                            size = (gigas + " " + "GB");
                        }
                    }

                    if (bytes >= 1048576 && bytes <= 1000000000)
                    {
                        String megas = megabytes.ToString();
                        if (megas.Length > 5)
                        {
                            megas = megas.Substring(0, megas.LastIndexOf(separator) + 2);
                            size = (megas + " " + "MB");
                        }
                        else
                        {
                            size = (megas + " " + "MB");
                        }
                    }

                    if (bytes >= 1024 && bytes < 1048576)

                    {
                        String kbs = kilobytes.ToString();
                        if (kbs.Length >= 5)
                        {
                            kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                            size = (kbs + " " + "KB");
                        }
                        else
                        {
                            size = (kbs + " " + "KB");
                        }
                    }
                    if (bytes > -1 && bytes < 1024)
                    {
                        String bits = bytes.ToString();
                        size = (bits + " Bytes");
                    }
                    item.SubItems[4].Text = size;

                    //End Format size view
                }
                this.Cursor = Cursors.Arrow;
                listView1.EndUpdate();
            }

            if (e.Column != 4)
            {
                if (listView1.Columns[e.Column].Text.Contains(Properties.Strings.v_bitr))
                {
                    lvwColumnSorter_Full.SortColumn = listView1.Columns[e.Column].Index;
                    if (size_sorted == false)
                    {
                        size_sorted = true;
                        lvwColumnSorter_Full.Order = SortOrder.Descending;
                    }
                    else
                    {
                        size_sorted = false;
                        lvwColumnSorter_Full.Order = SortOrder.Ascending;
                    }

                    if (listView1.Items.Count > 6000) this.Cursor = Cursors.WaitCursor;
                    listView1.BeginUpdate();

                    foreach (ListViewItem item in listView1.Items)
                    {
                        String filename = item.SubItems[1].Text + "\\" + item.Text;
                        if (item.SubItems[e.Column].Text.Length < 1) item.SubItems[e.Column].Text = "-";
                        String subit = "0";

                        if (File.Exists(filename))
                        {
                            //Format size view

                            subit = item.SubItems[e.Column].Text;

                            Boolean has_dot = false;
                            if (subit.Contains(".") || subit.Contains(","))
                            {
                                has_dot = true;
                                subit = subit.Replace(".", separator);
                                subit = subit.Replace(",", separator);
                            }
                            subit = Regex.Replace(subit, "[^.0-9]", "");

                            int pad = 0;
                            if (item.SubItems[e.Column].Text.ToLower().Contains("kb/s"))
                            {
                                if (has_dot == true)
                                {
                                    subit = subit.Substring(0, subit.Length - 1);
                                }

                                pad = 16 - subit.Length;
                                for (int ii = 0; ii < pad; ii++) subit = "0" + subit;
                            }
                            if (item.SubItems[e.Column].Text.ToLower().Contains("mb/s") || item.SubItems[e.Column].Text.ToLower().Contains("gb/s"))
                            {
                                if (has_dot == false) subit = subit + "000";
                                else subit = (subit + "00");
                                //subit = subit.Replace(sep_th, " ");
                                pad = 16 - subit.Length;
                                for (int ii = 0; ii < pad; ii++) subit = "0" + subit;
                            }
                            if (item.SubItems[e.Column].Text.ToLower().Contains("gb/s"))
                            {
                                if (has_dot == false) subit = subit + "0000";
                                else subit = subit + "000";
                                pad = 16 - subit.Length;
                                for (int ii = 0; ii < pad; ii++) subit = "0" + subit;
                            }
                            item.SubItems[e.Column].Text = subit;
                        }
                        else
                        {
                            item.SubItems[e.Column].Text = "-";
                        }

                        if (item.SubItems[e.Column].Text.Length == 0)
                        {
                            item.SubItems[e.Column].Text = "-";
                        }
                    }

                    ColumnHeader new_sorting_column = listView1.Columns[e.Column];

                    // Figure out the new sorting order.

                    System.Data.SqlClient.SortOrder sort_order;
                    if (SortingColumn == null)
                    {
                        // New column. Sort ascending.
                        sort_order = System.Data.SqlClient.SortOrder.Ascending;
                    }
                    else
                    {
                        // See if this is the same column.
                        if (new_sorting_column == SortingColumn)
                        {
                            // Same column. Switch the sort order.
                            if (SortingColumn.Text.StartsWith("> "))
                            {
                                sort_order = System.Data.SqlClient.SortOrder.Descending;
                            }
                            else
                            {
                                sort_order = System.Data.SqlClient.SortOrder.Ascending;
                            }
                        }
                        else
                        {
                            // New column. Sort ascending.
                            sort_order = System.Data.SqlClient.SortOrder.Ascending;
                        }

                        // Remove the old sort indicator.
                        SortingColumn.Text = SortingColumn.Text.Substring(2);
                    }

                    // Display the new sort order.
                    SortingColumn = new_sorting_column;
                    if (sort_order == System.Data.SqlClient.SortOrder.Ascending)
                    {
                        SortingColumn.Text = "> " + SortingColumn.Text;
                    }
                    else
                    {
                        SortingColumn.Text = "< " + SortingColumn.Text;
                    }

                    // Create a comparer.
                    listView1.ListViewItemSorter =
                        new ListViewComparer(e.Column, sort_order);

                    // Sort.
                    listView1.Sort();

                    foreach (ListViewItem item in listView1.Items)
                    {
                        String size = "0";
                        if (item.SubItems[e.Column].Text != "-" && item.SubItems[e.Column].Text != "0000000000000000") size = item.SubItems[e.Column].Text.TrimStart('0');

                        Decimal bytes = Decimal.Parse(size);

                        if (bytes > 10000000) size = (bytes / 1000000) + " " + "Gb/s";
                        if (bytes >= 10000 && bytes < 10000000)
                        {
                            size = (bytes / 1000) + " " + "Mb/s";
                            // if (size.Length == 9) size = (size.Substring(0, 1) + sep_th + size.Substring(1, size.Length - 1));
                        }

                        //if (bytes < 100000 && bytes > 10000) size = bytes / 1000 + " " + "Mb/s";
                        if (bytes < 10000) size = bytes + " " + "Kb/s";

                        //if (bytes > -1 && bytes < 1024) { size = (bytes) + " " + "b/s"; }
                        item.SubItems[e.Column].Text = size;

                        //End Format size view
                    }
                    this.Cursor = Cursors.Arrow;
                    listView1.EndUpdate();
                }
                else if (listView1.Columns[e.Column].Text.Contains(Properties.Strings2.a_bitr))
                {
                    lvwColumnSorter_Full.SortColumn = listView1.Columns[e.Column].Index;
                    if (size_sorted == false)
                    {
                        size_sorted = true;
                        lvwColumnSorter_Full.Order = SortOrder.Descending;
                    }
                    else
                    {
                        size_sorted = false;
                        lvwColumnSorter_Full.Order = SortOrder.Ascending;
                    }

                    if (listView1.Items.Count > 6000) this.Cursor = Cursors.WaitCursor;
                    listView1.BeginUpdate();

                    foreach (ListViewItem item in listView1.Items)
                    {
                        String filename = item.SubItems[1].Text + "\\" + item.Text;
                        if (item.SubItems[e.Column].Text.Length < 1) item.SubItems[e.Column].Text = "-";
                        String subit = "0";

                        if (File.Exists(filename))
                        {
                            //Format size view

                            subit = item.SubItems[e.Column].Text;

                            Boolean has_dot = false;
                            if (subit.Contains(".") || subit.Contains(","))
                            {
                                has_dot = true;
                                subit = subit.Replace(".", separator);
                                subit = subit.Replace(",", separator);
                            }
                            subit = Regex.Replace(subit, "[^.0-9]", "");

                            int pad = 0;
                            if (item.SubItems[e.Column].Text.ToLower().Contains("kb/s"))
                            {
                                if (has_dot == true)
                                {
                                    subit = subit.Substring(0, subit.Length - 1);
                                }

                                pad = 16 - subit.Length;
                                for (int ii = 0; ii < pad; ii++) subit = "0" + subit;
                            }
                            if (item.SubItems[e.Column].Text.ToLower().Contains("mb/s") || item.SubItems[e.Column].Text.ToLower().Contains("gb/s"))
                            {
                                if (has_dot == false) subit = subit + "000";
                                else subit = (subit + "00");

                                pad = 16 - subit.Length;
                                for (int ii = 0; ii < pad; ii++) subit = "0" + subit;
                            }
                            if (item.SubItems[e.Column].Text.ToLower().Contains("gb/s"))
                            {
                                if (has_dot == false) subit = subit + "0000";
                                else subit = subit + "000";
                                pad = 16 - subit.Length;
                                for (int ii = 0; ii < pad; ii++) subit = "0" + subit;
                            }
                            item.SubItems[e.Column].Text = subit;
                        }
                        else
                        {
                            item.SubItems[e.Column].Text = "-";
                        }

                        if (item.SubItems[e.Column].Text == "-" || item.SubItems[e.Column].Text.Length == 0)
                        {
                            item.SubItems[e.Column].Text = "-";
                        }
                    }

                    ColumnHeader new_sorting_column = listView1.Columns[e.Column];

                    // Figure out the new sorting order.

                    System.Data.SqlClient.SortOrder sort_order;
                    if (SortingColumn == null)
                    {
                        // New column. Sort ascending.
                        sort_order = System.Data.SqlClient.SortOrder.Ascending;
                    }
                    else
                    {
                        // See if this is the same column.
                        if (new_sorting_column == SortingColumn)
                        {
                            // Same column. Switch the sort order.
                            if (SortingColumn.Text.StartsWith("> "))
                            {
                                sort_order = System.Data.SqlClient.SortOrder.Descending;
                            }
                            else
                            {
                                sort_order = System.Data.SqlClient.SortOrder.Ascending;
                            }
                        }
                        else
                        {
                            // New column. Sort ascending.
                            sort_order = System.Data.SqlClient.SortOrder.Ascending;
                        }

                        // Remove the old sort indicator.
                        SortingColumn.Text = SortingColumn.Text.Substring(2);
                    }

                    // Display the new sort order.
                    SortingColumn = new_sorting_column;
                    if (sort_order == System.Data.SqlClient.SortOrder.Ascending)
                    {
                        SortingColumn.Text = "> " + SortingColumn.Text;
                    }
                    else
                    {
                        SortingColumn.Text = "< " + SortingColumn.Text;
                    }

                    // Create a comparer.
                    listView1.ListViewItemSorter =
                        new ListViewComparer(e.Column, sort_order);

                    // Sort.
                    listView1.Sort();

                    foreach (ListViewItem item in listView1.Items)
                    {
                        String size = "0";
                        if (item.SubItems[e.Column].Text != "-" && item.SubItems[e.Column].Text != "0000000000000000") size = item.SubItems[e.Column].Text.TrimStart('0');

                        Decimal bytes = Decimal.Parse(size);

                        if (bytes > 10000000) size = (bytes / 1000000) + " " + "Gb/s";
                        if (bytes >= 10000 && bytes < 10000000)
                        {
                            size = (bytes / 1000) + " " + "Mb/s";
                            // if (size.Length == 9) size = (size.Substring(0, 1) + sep_th + size.Substring(1, size.Length - 1));
                        }

                        //if (bytes < 100000 && bytes > 10000) size = bytes / 1000 + " " + "Mb/s";
                        if (bytes < 10000) size = bytes + " " + "Kb/s";

                        //if (bytes > -1 && bytes < 1024) { size = (bytes) + " " + "b/s"; }
                        item.SubItems[e.Column].Text = size;

                        //End Format size view
                    }
                    this.Cursor = Cursors.Arrow;
                    listView1.EndUpdate();
                }
                else if (listView1.Columns[e.Column].Text.Contains(Properties.Strings2.bitrate))
                {
                    
                        lvwColumnSorter_Full.SortColumn = listView1.Columns[e.Column].Index;
                        if (size_sorted == false)
                        {
                            size_sorted = true;
                            lvwColumnSorter_Full.Order = SortOrder.Descending;
                        }
                        else
                        {
                            size_sorted = false;
                            lvwColumnSorter_Full.Order = SortOrder.Ascending;
                        }

                        if (listView1.Items.Count > 6000) this.Cursor = Cursors.WaitCursor;
                        listView1.BeginUpdate();

                        foreach (ListViewItem item in listView1.Items)
                        {
                            String filename = item.SubItems[1].Text + "\\" + item.Text;
                            if (item.SubItems[e.Column].Text.Length < 1) item.SubItems[e.Column].Text = "-";
                            String subit = "0";

                            if (File.Exists(filename))
                            {
                                //Format size view

                                subit = item.SubItems[e.Column].Text;
                            if (subit.ToLower().Contains("mb/s")) subit = subit + "000";
                            if (subit.ToLower().Contains("gb/s")) subit = subit + "000000";
                            int c_ths = 0;
                            if (subit.Contains(sep_th))
                            {
                                c_ths = subit.Count(f => f == Convert.ToChar(sep_th));
                                subit = subit.Replace(sep_th, "");
                            }
                            if (subit.Contains(separator))
                            {                                
                                subit = subit.Replace(separator, "");
                                subit = subit.Substring(0, subit.Length - 1);
                            }
                            subit = Regex.Replace(subit, "[^0-9]", "");

                                int pad = 0;
                            
                                //if (c_ths == 1) subit = subit + "0";
                                //if  (c_ths == 2) subit = subit + "00";
                                //if (c_ths == 3) subit = subit + "000";                                
                                pad = 16 - subit.Length;
                                for (int ii = 0; ii < pad; ii++) subit = "0" + subit;
                            
                                                
                            
                            item.SubItems[e.Column].Text = subit;
                            }
                            else
                            {
                                item.SubItems[e.Column].Text = "-";
                            }

                            if (item.SubItems[e.Column].Text.Length == 0)
                            {
                                item.SubItems[e.Column].Text = "-";
                            }
                        }

                        ColumnHeader new_sorting_column = listView1.Columns[e.Column];

                        // Figure out the new sorting order.

                        System.Data.SqlClient.SortOrder sort_order;
                        if (SortingColumn == null)
                        {
                            // New column. Sort ascending.
                            sort_order = System.Data.SqlClient.SortOrder.Ascending;
                        }
                        else
                        {
                            // See if this is the same column.
                            if (new_sorting_column == SortingColumn)
                            {
                                // Same column. Switch the sort order.
                                if (SortingColumn.Text.StartsWith("> "))
                                {
                                    sort_order = System.Data.SqlClient.SortOrder.Descending;
                                }
                                else
                                {
                                    sort_order = System.Data.SqlClient.SortOrder.Ascending;
                                }
                            }
                            else
                            {
                                // New column. Sort ascending.
                                sort_order = System.Data.SqlClient.SortOrder.Ascending;
                            }

                            // Remove the old sort indicator.
                            SortingColumn.Text = SortingColumn.Text.Substring(2);
                        }

                        // Display the new sort order.
                        SortingColumn = new_sorting_column;
                        if (sort_order == System.Data.SqlClient.SortOrder.Ascending)
                        {
                            SortingColumn.Text = "> " + SortingColumn.Text;
                        }
                        else
                        {
                            SortingColumn.Text = "< " + SortingColumn.Text;
                        }

                        // Create a comparer.
                        listView1.ListViewItemSorter =
                            new ListViewComparer(e.Column, sort_order);

                        // Sort.
                        listView1.Sort();

                        foreach (ListViewItem item in listView1.Items)
                        {
                            String size = "0";
                            if (item.SubItems[e.Column].Text != "-" && item.SubItems[e.Column].Text != "0000000000000000" && item.SubItems[e.Column].Text.Length > 0) size = item.SubItems[e.Column].Text.TrimStart('0');

                            Decimal bytes = 0;
                            try { bytes = Decimal.Parse(size); } catch { }

                        if (bytes >= 1000000) size = (bytes / 1000000).ToString("#,##0.0") + " " + "Gb/s";
                        if (bytes >= 10000 && bytes < 1000000)
                        {
                            size = (bytes / 1000).ToString("#,##0.0") + " " + "Mb/s";
                            //if (size.Length == 9) size = (size.Substring(0, 1) + sep_th + size.Substring(1, size.Length - 1));
                        }

                        ////if (bytes < 100000 && bytes > 10000) size = bytes / 1000 + " " + "Mb/s";
                        if (bytes < 10000) size = bytes.ToString("#,##0") + " " + "Kb/s";
                            //size = bytes.ToString("#,##0") + " " + "Kb/s";

                            //if (bytes > -1 && bytes < 1024) { size = (bytes) + " " + "b/s"; }
                            item.SubItems[e.Column].Text = size;

                            //End Format size view
                        }
                        this.Cursor = Cursors.Arrow;
                        listView1.EndUpdate();                   
                }

                //Rest of columns
                else
                {
                    ColumnHeader new_sorting_column = listView1.Columns[e.Column];

                    // Figure out the new sorting order.

                    System.Data.SqlClient.SortOrder sort_order;
                    if (SortingColumn == null)
                    {
                        // New column. Sort ascending.
                        sort_order = System.Data.SqlClient.SortOrder.Ascending;
                    }
                    else
                    {
                        // See if this is the same column.
                        if (new_sorting_column == SortingColumn)
                        {
                            // Same column. Switch the sort order.
                            if (SortingColumn.Text.StartsWith("> "))
                            {
                                sort_order = System.Data.SqlClient.SortOrder.Descending;
                            }
                            else
                            {
                                sort_order = System.Data.SqlClient.SortOrder.Ascending;
                            }
                        }
                        else
                        {
                            // New column. Sort ascending.
                            sort_order = System.Data.SqlClient.SortOrder.Ascending;
                        }

                        // Remove the old sort indicator.
                        SortingColumn.Text = SortingColumn.Text.Substring(2);
                    }

                    // Display the new sort order.
                    SortingColumn = new_sorting_column;
                    if (sort_order == System.Data.SqlClient.SortOrder.Ascending)
                    {
                        SortingColumn.Text = "> " + SortingColumn.Text;
                    }
                    else
                    {
                        SortingColumn.Text = "< " + SortingColumn.Text;
                    }

                    // Create a comparer.
                    listView1.ListViewItemSorter =
                        new ListViewComparer(e.Column, sort_order);

                    // Sort.
                    listView1.Sort();
                }
            }
        }

        private void button19_Click(object sender, EventArgs e)
        {
            listView1.View = View.Details;
            listView2.View = View.Details;
            listView3.View = View.Details;
        }

        private void button12_Click(object sender, EventArgs e)
        {
            Pg1.Focus();

            if (tabControl1.SelectedIndex == 0)
            {
                this.Cursor = Cursors.WaitCursor;
                //Backup listview1
                ListViewItem[] itemsToAdd = new ListViewItem[listView1.Items.Count];
                ListView lv_clean = new ListView();
                listView1.BeginUpdate();
                lv_clean.Items.AddRange((from ListViewItem item in listView1.Items select (ListViewItem)item.Clone()).ToArray());

                foreach (ListViewItem n_a in lv_clean.Items)
                {
                    if (n_a.SubItems[3].Text == FFBatch.Properties.Strings.n_a || n_a.SubItems[3].Text == "0:00:00" || n_a.SubItems[3].Text == "00:00:00" || n_a.SubItems[3].Text == "00:00:00.000")
                    {
                        n_a.Remove();
                    }
                }
                listView1.Items.Clear();
                listView1.Items.AddRange((from ListViewItem item in lv_clean.Items select (ListViewItem)item.Clone()).ToArray());
                lbl_items.Text = listView1.Items.Count + " " + FFBatch.Properties.Strings.files;
                calc_total_dur();
                calc_list_size();
                listView1.EndUpdate();
            }

            if (tabControl1.SelectedIndex == 3)
            {
                if (dg1.RowCount == 0) return;
                this.Cursor = Cursors.WaitCursor;
                dg1.EndEdit();
                dg1.ClearSelection();

                for (int i = 1; i < dg1.RowCount; i++)

                {
                    if (dg1.Rows[i].Cells[5].Value.ToString() == FFBatch.Properties.Strings.error)

                    {
                        dg1.Rows.RemoveAt(i);
                        i--;
                    }
                }

                if (dg1.Rows[0].Cells[1] != null && dg1.Rows[0].Cells[5].Value.ToString() == FFBatch.Properties.Strings.error)
                {
                    dg1.Rows.RemoveAt(0);
                    this.Cursor = Cursors.Arrow;
                    return;
                }
                dg1.Refresh();
            }
            this.Cursor = Cursors.Arrow;
        }

        private void CopyAction(object sender, EventArgs e)
        {
            if (Rtxt.SelectedText != String.Empty) Clipboard.SetText(Rtxt.SelectedText);
        }

        private void Disable_Controls()
        {
            save_path_state = btn_save_path.Enabled;
            save_preset_state = btn_save_preset.Enabled;
            current_save_prio = btn_save_prio.Enabled;

            foreach (Control p in this.Controls)
            {
                if (p.Name != panel1.Name && p.Name != tabControl1.Name && p.Name != group_subs.Name && p.Name != group_prog.Name && p.Name != groupBox_m3u.Name && p.Name != groupBox9.Name && p.Name != groupBox1.Name && p.Name != groupBox4.Name)
                {
                    this.InvokeEx(f => p.Enabled = false);
                }
                this.InvokeEx(f => f.btn_pause.Enabled = true);
            }
            if (Properties.Settings.Default.dark_mode == true)
            {
                Bitmap bm = new Bitmap(listView1.ClientSize.Width, listView1.ClientSize.Height);
                Graphics.FromImage(bm).Clear(listView1.BackColor);
                this.InvokeEx(f => f.listView1.BackgroundImage = bm);

                bm = new Bitmap(listView3.ClientSize.Width, listView3.ClientSize.Height);
                Graphics.FromImage(bm).Clear(listView1.BackColor);
                this.InvokeEx(f => f.listView3.BackgroundImage = bm);
            }

            foreach (Control ct in groupBox_m3u.Controls)
            {
                this.InvokeEx(f => ct.Enabled = false);
            }

            this.InvokeEx(f => f.btn_stop_m3u8.Enabled = true);

            foreach (Control ct in panel1.Controls)
            {
                this.InvokeEx(f => ct.Enabled = false);
            }

            foreach (Control ct_g in group_subs.Controls)
            {
                this.InvokeEx(f => ct_g.Enabled = false);
            }

            foreach (Control ct in groupBox9.Controls)
            {
                this.InvokeEx(f => ct.Enabled = false);
            }
            foreach (Control ct in groupBox1.Controls)
            {
                this.InvokeEx(f => ct.Enabled = false);
            }

            this.InvokeEx(f => f.groupBox4.Enabled = true);
            foreach (Control ct in groupBox4.Controls)
            {
                if (ct.Name != chk_delete_source.Name)
                    this.InvokeEx(f => ct.Enabled = false);
            }

            this.InvokeEx(f => f.TB1.Enabled = true);
            this.InvokeEx(f => f.chkshut.Enabled = true);

            if (chkshut.CheckState == CheckState.Checked)
            {
                this.InvokeEx(f => f.combo_shut.Enabled = true);
            }

            this.InvokeEx(f => f.btn_pause.Enabled = true);

            this.InvokeEx(f => f.listView2.Enabled = false);
            Bitmap bm2 = new Bitmap(listView2.ClientSize.Width, listView2.ClientSize.Height);
            Graphics.FromImage(bm2).Clear(listView2.BackColor);
            this.InvokeEx(f => f.listView2.BackgroundImage = bm2);

            this.InvokeEx(f => f.list_tracks.Enabled = false);
            bm2 = new Bitmap(list_tracks.ClientSize.Width, list_tracks.ClientSize.Height);
            Graphics.FromImage(bm2).Clear(list_tracks.BackColor);
            this.InvokeEx(f => f.list_tracks.BackgroundImage = bm2);
            this.InvokeEx(f => f.btn_mux.Enabled = false);

            this.InvokeEx(f => f.listView1.Enabled = true);
            this.InvokeEx(f => f.txt_remain.Enabled = true);
            this.InvokeEx(f => f.lbl_tot_prog.Enabled = true);
            this.InvokeEx(f => f.Pg1.Enabled = true);
            //this.InvokeEx(f => f.pg_current.Enabled = true);
            total_time = false;
            this.InvokeEx(f => f.LB_Wait.Enabled = true);
            this.InvokeEx(f => f.pg_adding.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Enabled = true);

            this.InvokeEx(f => f.combo_prio.Enabled = true);

            this.InvokeEx(f => f.item_up.Enabled = true);
            this.InvokeEx(f => f.item_down.Enabled = true);

            if (runnin_n_presets == true)
            {
                this.InvokeEx(f => f.btn_add_files.Enabled = false);
                this.InvokeEx(f => f.btn_add_folders.Enabled = false);
                this.InvokeEx(f => f.chk_subfolders.Enabled = false);
            }
            if (multi_running == true) this.InvokeEx(f => f.btn_skip_main.Enabled = true);
        }

        private void Enable_Controls()
        {
            //this.InvokeEx(f => f.button20.Text = "Abort queue");
            foreach (Control p in this.Controls)
            {
                this.InvokeEx(f => p.Enabled = true);
            }
            foreach (Control p2 in group_prog.Controls)
            {
                this.InvokeEx(f => p2.Enabled = true);
            }
            foreach (Control ct in panel1.Controls)
            {
                this.InvokeEx(f => ct.Enabled = true);
            }

            if (save_path_state == false)
            {
                this.InvokeEx(f => f.btn_save_path.Enabled = false);
            }

            foreach (Control ct in panel2.Controls)
            {
                this.InvokeEx(f => ct.Enabled = true);
            }

            foreach (Control ct_g in group_subs.Controls)
            {
                this.InvokeEx(f => ct_g.Enabled = true);
            }

            foreach (Control ct_g in groupBox1.Controls)
            {
                this.InvokeEx(f => ct_g.Enabled = true);
            }

            if (save_preset_state == false)
            {
                this.InvokeEx(f => f.btn_save_preset.Enabled = false);
            }

            if (current_save_prio == false)
            {
                this.InvokeEx(f => f.btn_save_prio.Enabled = false);
            }

            foreach (Control ct in groupBox_m3u.Controls)
            {
                this.InvokeEx(f => ct.Enabled = true);
            }

            foreach (Control ct in groupBox9.Controls)
            {
                this.InvokeEx(f => ct.Enabled = true);
            }

            foreach (Control ct in groupBox2.Controls)
            {
                this.InvokeEx(f => ct.Enabled = true);
            }

            foreach (Control ct in groupBox4.Controls)
            {
                this.InvokeEx(f => ct.Enabled = true);
            }

            if (chkshut.CheckState == CheckState.Checked)
            {
                this.InvokeEx(f => f.combo_shut.Enabled = true);
            }
            else
            {
                this.InvokeEx(f => f.combo_shut.Enabled = false);
            }

            //this.InvokeEx(f => f.chk_shift.Checked = false);
            //this.InvokeEx(f => f.Num_Shift.Enabled = false);
            this.InvokeEx(f => f.listView2.Enabled = true);
            this.InvokeEx(f => f.list_tracks.Enabled = true);
            this.InvokeEx(f => f.btn_mux.Enabled = true);
            this.InvokeEx(f => f.txt_remain.Text = "");

            if (Enable_txt_hard_Subs == true)
            {
                this.InvokeEx(f => f.txt_hard_subs.Enabled = true);
            }
            else
            {
                this.InvokeEx(f => f.txt_hard_subs.Enabled = false);
            }

            timer_tasks.Stop();
            TimeSpan t = TimeSpan.FromSeconds(time_n_tasks);
            String tx_elapsed = string.Format("{0:D2}h:{1:D2}m:{2:D2}s",
                t.Hours,
                t.Minutes,
                t.Seconds);
            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + "00h:00m:00s");

            this.InvokeEx(f => f.pg_adding.Visible = false);

            if (chk_m3u_params.CheckState == CheckState.Checked)
            {
                this.InvokeEx(f => f.txt_m3u_params.Enabled = true);
            }
            else
            {
                this.InvokeEx(f => f.txt_m3u_params.Enabled = false);
            }

            if (chk_output_server.CheckState == CheckState.Checked)
            {
                this.InvokeEx(f => f.txt_output_server.Enabled = true);
            }
            else
            {
                this.InvokeEx(f => f.txt_output_server.Enabled = false);
            }
            check_jobs();
        }

        private void Rem_tips()
        { }

        private void Create_Tooltips()
        {
            ToolTip toolT_pre_ss = new ToolTip();
            ToolTip toolT4z = new ToolTip();
            ToolTip toolT44z = new ToolTip();
            ToolTip toolT5z = new ToolTip();
            ToolTip toolT2z = new ToolTip();
            ToolTip toolT1z = new ToolTip();
            ToolTip toolT0z = new ToolTip();
            ToolTip toolT00z = new ToolTip();
            ToolTip toolT002 = new ToolTip();
            ToolTip toolT001 = new ToolTip();
            ToolTip toolTipaH7 = new ToolTip();
            ToolTip toolTipaH8 = new ToolTip();
            ToolTip toolTipaH6 = new ToolTip();
            ToolTip toolTipaA6 = new ToolTip();
            ToolTip toolTipaA5 = new ToolTip();
            ToolTip toolTipaA4 = new ToolTip();
            ToolTip toolTipaA3 = new ToolTip();
            ToolTip toolTipa33 = new ToolTip();
            ToolTip toolTipa3 = new ToolTip();
            ToolTip toolTip03 = new ToolTip();
            ToolTip toolTip022 = new ToolTip();
            ToolTip toolTip02 = new ToolTip();
            ToolTip toolTip033 = new ToolTip();
            ToolTip toolTip04 = new ToolTip();
            ToolTip toolTip0 = new ToolTip();
            ToolTip toolTip1 = new ToolTip();
            ToolTip toolTip2 = new ToolTip();
            ToolTip toolTip3 = new ToolTip();
            ToolTip toolTip4 = new ToolTip();
            ToolTip toolTip5 = new ToolTip();
            ToolTip toolTip6 = new ToolTip();
            ToolTip toolTip6_2 = new ToolTip();
            ToolTip toolTip8 = new ToolTip();
            ToolTip toolTipZ8 = new ToolTip();
            ToolTip toolTip12 = new ToolTip();
            ToolTip toolTip13 = new ToolTip();
            ToolTip toolTip15 = new ToolTip();
            ToolTip toolTip16 = new ToolTip();
            ToolTip toolTip18 = new ToolTip();
            ToolTip toolTip20 = new ToolTip();
            ToolTip toolTip21 = new ToolTip();
            ToolTip toolTip22 = new ToolTip();
            ToolTip toolTip24 = new ToolTip();
            ToolTip toolTip25 = new ToolTip();
            ToolTip toolTip26 = new ToolTip();
            ToolTip toolTip27 = new ToolTip();
            ToolTip toolTip30 = new ToolTip();
            ToolTip toolTip32 = new ToolTip();
            ToolTip toolTip33 = new ToolTip();
            ToolTip toolTip34 = new ToolTip();
            ToolTip toolTip35 = new ToolTip();
            ToolTip toolTip36 = new ToolTip();
            ToolTip toolTip37 = new ToolTip();
            ToolTip toolTip38 = new ToolTip();
            ToolTip toolTip39 = new ToolTip();
            ToolTip toolTip40 = new ToolTip();
            ToolTip toolTip41 = new ToolTip();
            ToolTip toolTip42 = new ToolTip();
            ToolTip toolTip43 = new ToolTip();
            ToolTip toolTip17 = new ToolTip();
            ToolTip toolTip45 = new ToolTip();

            toolT_pre_ss.RemoveAll();
            toolT4z.RemoveAll();
            toolT44z.RemoveAll();
            toolT5z.RemoveAll();
            toolT2z.RemoveAll();
            toolT1z.RemoveAll();
            toolT0z.RemoveAll();
            toolT00z.RemoveAll();
            toolT002.RemoveAll();
            toolT001.RemoveAll();
            toolTipaH7.RemoveAll();
            toolTipaH8.RemoveAll();
            toolTipaH6.RemoveAll();
            tool_undo_filter.RemoveAll();
            toolTipaA6.RemoveAll();
            toolTipaA5.RemoveAll();
            toolTipaA4.RemoveAll();
            toolTipaA3.RemoveAll();
            toolTipa33.RemoveAll();
            toolTipa3.RemoveAll();
            toolTip_settings.RemoveAll();
            toolTip03.RemoveAll();
            toolTip022.RemoveAll();
            toolTip02.RemoveAll();
            toolTip033.RemoveAll();
            toolTip04.RemoveAll();
            toolTip0.RemoveAll();
            toolTip1.RemoveAll();
            toolTip1.RemoveAll();
            toolTip3.RemoveAll();
            toolTip4.RemoveAll();
            toolTip5.RemoveAll();
            toolTip6.RemoveAll();
            toolTip6_2.RemoveAll();
            toolTip8.RemoveAll();
            toolTipZ8.RemoveAll();
            toolTip12.RemoveAll();
            toolTip13.RemoveAll();
            toolTip15.RemoveAll();
            toolTip16.RemoveAll();
            toolTip18.RemoveAll();
            toolTip20.RemoveAll();
            toolTip21.RemoveAll();
            toolTip22.RemoveAll();
            toolTip24.RemoveAll();
            toolTip25.RemoveAll();
            toolTip26.RemoveAll();
            toolTip27.RemoveAll();
            toolTip30.RemoveAll();
            toolTip32.RemoveAll();
            toolTip33.RemoveAll();
            toolTip34.RemoveAll();
            toolTip35.RemoveAll();
            toolTip36.RemoveAll();
            toolTip37.RemoveAll();
            toolTip38.RemoveAll();
            toolTip39.RemoveAll();
            toolTip40.RemoveAll();
            toolTip41.RemoveAll();
            toolTip42.RemoveAll();
            toolTip43.RemoveAll();
            toolTip17.RemoveAll();
            toolTip45.RemoveAll();

            toolT_pre_ss.AutoPopDelay = 9000;
            toolT_pre_ss.InitialDelay = 750;
            toolT_pre_ss.ReshowDelay = 500;
            toolT_pre_ss.ShowAlways = true;
            toolT_pre_ss.SetToolTip(this.lbl_pre_input, FFBatch.Properties.Strings2.pre_ss);

            toolT4z.AutoPopDelay = 9000;
            toolT4z.InitialDelay = 750;
            toolT4z.ReshowDelay = 500;
            toolT4z.ShowAlways = true;
            toolT4z.SetToolTip(this.btn_track_up, FFBatch.Properties.Strings.track_up);

            toolT44z.AutoPopDelay = 9000;
            toolT44z.InitialDelay = 750;
            toolT44z.ReshowDelay = 500;
            toolT44z.ShowAlways = true;
            toolT44z.SetToolTip(this.btn_add_folders, FFBatch.Properties.Strings.open_folder_d + Environment.NewLine + FFBatch.Properties.Strings.right_man_path);

            toolT5z.AutoPopDelay = 9000;
            toolT5z.InitialDelay = 750;
            toolT5z.ReshowDelay = 500;
            toolT5z.ShowAlways = true;
            toolT5z.SetToolTip(this.btn_track_down, FFBatch.Properties.Strings.track_down);

            toolT2z.AutoPopDelay = 9000;
            toolT2z.InitialDelay = 750;
            toolT2z.ReshowDelay = 500;
            toolT2z.ShowAlways = true;
            toolT2z.SetToolTip(this.pic_title, FFBatch.Properties.Strings.about_don);

            toolT1z.AutoPopDelay = 9000;
            toolT1z.InitialDelay = 750;
            toolT1z.ReshowDelay = 500;
            toolT1z.ShowAlways = true;
            toolT1z.SetToolTip(this.btn_add_col, FFBatch.Properties.Strings.add_col_l);

            toolT0z.AutoPopDelay = 9000;
            toolT0z.InitialDelay = 750;
            toolT0z.ReshowDelay = 500;
            toolT0z.ShowAlways = true;
            toolT0z.SetToolTip(this.btn_display_log, FFBatch.Properties.Strings.last_log);

            toolT00z.AutoPopDelay = 9000;
            toolT00z.InitialDelay = 750;
            toolT00z.ReshowDelay = 500;
            toolT00z.ShowAlways = true;
            toolT00z.SetToolTip(this.btn_edit_presets, FFBatch.Properties.Strings.edit_pres);

            toolT002.AutoPopDelay = 9000;
            toolT002.InitialDelay = 750;
            toolT002.ReshowDelay = 500;
            toolT002.ShowAlways = true;
            //toolT002.SetToolTip(this.pic_warnings, FFBatch.Properties.Strings.error_last_ses);

            toolT001.AutoPopDelay = 9000;
            toolT001.InitialDelay = 750;
            toolT001.ReshowDelay = 500;
            toolT001.ShowAlways = true;
            toolT001.SetToolTip(this.pic_no_errors, FFBatch.Properties.Strings.all_items_ok);

            toolTipaH7.AutoPopDelay = 9000;
            toolTipaH7.InitialDelay = 750;
            toolTipaH7.ReshowDelay = 500;
            toolTipaH7.ShowAlways = true;
            toolTipaH7.SetToolTip(this.btn_inc_font, FFBatch.Properties.Strings.inc_font);

            toolTipaH8.AutoPopDelay = 9000;
            toolTipaH8.InitialDelay = 750;
            toolTipaH8.ReshowDelay = 500;
            toolTipaH8.ShowAlways = true;
            toolTipaH8.SetToolTip(this.btn_decr_font, FFBatch.Properties.Strings.dec_font);

            toolTipaH6.AutoPopDelay = 9000;
            toolTipaH6.InitialDelay = 750;
            toolTipaH6.ReshowDelay = 500;
            toolTipaH6.ShowAlways = true;
            toolTipaH6.SetToolTip(this.combo_prio, FFBatch.Properties.Strings.end_prio);

            tool_undo_filter.AutoPopDelay = 9000;
            tool_undo_filter.InitialDelay = 750;
            tool_undo_filter.ReshowDelay = 500;
            tool_undo_filter.ShowAlways = true;
            tool_undo_filter.SetToolTip(this.btn_undo_filter, FFBatch.Properties.Strings.undo_fil);

            toolTipaA6.AutoPopDelay = 9000;
            toolTipaA6.InitialDelay = 750;
            toolTipaA6.ReshowDelay = 500;
            toolTipaA6.ShowAlways = true;
            toolTipaA6.SetToolTip(this.btn_filter, FFBatch.Properties.Strings.filter_list);

            toolTipaA5.AutoPopDelay = 9000;
            toolTipaA5.InitialDelay = 750;
            toolTipaA5.ReshowDelay = 500;
            toolTipaA5.ShowAlways = true;
            toolTipaA5.SetToolTip(this.chk_overw, FFBatch.Properties.Strings.allow_overw);

            toolTipaA4.AutoPopDelay = 9000;
            toolTipaA4.InitialDelay = 750;
            toolTipaA4.ReshowDelay = 500;
            toolTipaA4.ShowAlways = true;
            toolTipaA4.SetToolTip(this.chk_trim2, FFBatch.Properties.Strings.check_trim1 + Environment.NewLine + FFBatch.Properties.Strings.check_trim2);

            toolTipaA3.AutoPopDelay = 5000;
            toolTipaA3.InitialDelay = 750;
            toolTipaA3.ReshowDelay = 500;
            toolTipaA3.ShowAlways = true;
            toolTipaA3.SetToolTip(this.check_concat, FFBatch.Properties.Strings.concat_mux);

            toolTipa33.AutoPopDelay = 5000;
            toolTipa33.InitialDelay = 750;
            toolTipa33.ReshowDelay = 500;
            toolTipa33.ShowAlways = true;
            toolTipa33.SetToolTip(this.checkBox1, FFBatch.Properties.Strings.recreate);

            toolTipa3.AutoPopDelay = 5000;
            toolTipa3.InitialDelay = 750;
            toolTipa3.ReshowDelay = 500;
            toolTipa3.ShowAlways = true;
            toolTipa3.SetToolTip(this.btn_ref_dcd, FFBatch.Properties.Strings.act_Dec);

            toolTip_settings.AutoPopDelay = 5000;
            toolTip_settings.InitialDelay = 750;
            toolTip_settings.ReshowDelay = 500;
            toolTip_settings.ShowAlways = true;
            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.save_def);

            toolTip03.AutoPopDelay = 5000;
            toolTip03.InitialDelay = 750;
            toolTip03.ReshowDelay = 500;
            toolTip03.ShowAlways = true;
            toolTip03.SetToolTip(this.change_ff, FFBatch.Properties.Strings.replace_ff);

            toolTip022.AutoPopDelay = 5000;
            toolTip022.InitialDelay = 750;
            toolTip022.ReshowDelay = 500;
            toolTip022.ShowAlways = true;
            toolTip022.SetToolTip(this.chk_try, FFBatch.Properties.Strings.dis_try + Environment.NewLine + "Check it in case of trouble processing queue.");

            toolTip02.AutoPopDelay = 5000;
            toolTip02.InitialDelay = 750;
            toolTip02.ReshowDelay = 500;
            toolTip02.ShowAlways = true;
            toolTip02.SetToolTip(this.item_up, FFBatch.Properties.Strings.q_up);

            toolTip033.AutoPopDelay = 5000;
            toolTip033.InitialDelay = 750;
            toolTip033.ReshowDelay = 500;
            toolTip033.ShowAlways = true;
            toolTip033.SetToolTip(this.item_down, FFBatch.Properties.Strings.q_down);

            toolTip04.AutoPopDelay = 5000;
            toolTip04.InitialDelay = 750;
            toolTip04.ReshowDelay = 500;
            toolTip04.ShowAlways = true;
            toolTip04.SetToolTip(this.requeue, FFBatch.Properties.Strings.Reset_list_items_to_queued);

            toolTip0.AutoPopDelay = 5000;
            toolTip0.InitialDelay = 750;
            toolTip0.ReshowDelay = 500;
            toolTip0.ShowAlways = true;
            toolTip0.SetToolTip(this.chk_delete_source, FFBatch.Properties.Strings.set_del);

            toolTip1.AutoPopDelay = 5000;
            toolTip1.InitialDelay = 750;
            toolTip1.ReshowDelay = 500;
            toolTip1.ShowAlways = true;
            toolTip1.SetToolTip(this.listView1, FFBatch.Properties.Strings.drag1);

            toolTip2.AutoPopDelay = 5000;
            toolTip2.InitialDelay = 750;
            toolTip2.ReshowDelay = 500;
            toolTip1.ShowAlways = true;
            toolTip1.SetToolTip(this.btn_del_preset, FFBatch.Properties.Strings.del_pres);

            toolTip3.AutoPopDelay = 5000;
            toolTip3.InitialDelay = 750;
            toolTip3.ReshowDelay = 500;
            toolTip3.ShowAlways = true;
            toolTip3.SetToolTip(this.btn_try_pr, FFBatch.Properties.Strings.try_ff);

            toolTip4.AutoPopDelay = 5000;
            toolTip4.InitialDelay = 750;
            toolTip4.ReshowDelay = 500;
            toolTip4.ShowAlways = true;
            toolTip4.SetToolTip(this.btn_clean_list, FFBatch.Properties.Strings.Remove_invalid_items);

            toolTip5.AutoPopDelay = 5000;
            toolTip5.InitialDelay = 750;
            toolTip5.ReshowDelay = 500;
            toolTip5.ShowAlways = true;
            toolTip5.SetToolTip(this.chkshut, FFBatch.Properties.Strings.auto_sh);

            toolTip6.AutoPopDelay = 5000;
            toolTip6.InitialDelay = 500;
            toolTip6.ReshowDelay = 500;
            toolTip6.ShowAlways = true;
            toolTip6.SetToolTip(this.txt_path_main, FFBatch.Properties.Strings.reset_out);

            toolTip6_2.AutoPopDelay = 5000;
            toolTip6_2.InitialDelay = 500;
            toolTip6_2.ReshowDelay = 500;
            toolTip6_2.ShowAlways = true;
            toolTip6_2.SetToolTip(this.btn_reset_path, FFBatch.Properties.Strings.reset_out);

            toolTip8.AutoPopDelay = 5000;
            toolTip8.InitialDelay = 750;
            toolTip8.ReshowDelay = 500;
            toolTip8.ShowAlways = true;
            toolTip8.SetToolTip(this.btn_seq, FFBatch.Properties.Strings.start_set);

            toolTipZ8.AutoPopDelay = 5000;
            toolTipZ8.InitialDelay = 750;
            toolTipZ8.ReshowDelay = 500;
            toolTipZ8.ShowAlways = true;
            toolTipZ8.SetToolTip(this.btn_abort_all, FFBatch.Properties.Strings.abort_enc);

            toolTip12.AutoPopDelay = 5000;
            toolTip12.InitialDelay = 750;
            toolTip12.ReshowDelay = 500;
            toolTip12.ShowAlways = true;
            toolTip12.SetToolTip(this.chk_open_compl, FFBatch.Properties.Strings.open_out);

            toolTip13.AutoPopDelay = 5000;
            toolTip13.InitialDelay = 750;
            toolTip13.ReshowDelay = 500;
            toolTip13.ShowAlways = true;
            toolTip13.SetToolTip(this.button22, FFBatch.Properties.Strings.wavef);

            toolTip15.AutoPopDelay = 1500;
            toolTip15.InitialDelay = 750;
            toolTip15.ReshowDelay = 500;
            toolTip15.ShowAlways = true;
            toolTip15.SetToolTip(this.label13, FFBatch.Properties.Strings.reset_out);

            toolTip16.AutoPopDelay = 1500;
            toolTip16.InitialDelay = 750;
            toolTip16.ReshowDelay = 500;
            toolTip16.ShowAlways = true;
            toolTip16.SetToolTip(this.button23, FFBatch.Properties.Strings.cl_tracks);

            toolTip18.AutoPopDelay = 1500;
            toolTip18.InitialDelay = 750;
            toolTip18.ReshowDelay = 500;
            toolTip18.ShowAlways = true;
            toolTip18.SetToolTip(this.btn_mux, FFBatch.Properties.Strings.mux_st);

            toolTip20.AutoPopDelay = 1500;
            toolTip20.InitialDelay = 750;
            toolTip20.ReshowDelay = 500;
            toolTip20.ShowAlways = true;
            toolTip20.SetToolTip(this.btn_set_track_param, FFBatch.Properties.Strings.rest_params);

            toolTip21.AutoPopDelay = 1500;
            toolTip21.InitialDelay = 750;
            toolTip21.ReshowDelay = 500;
            toolTip21.ShowAlways = true;
            toolTip21.SetToolTip(this.btn_update, FFBatch.Properties.Strings.Check_for_updates);

            toolTip22.AutoPopDelay = 1500;
            toolTip22.InitialDelay = 750;
            toolTip22.ReshowDelay = 500;
            toolTip22.ShowAlways = true;
            toolTip22.SetToolTip(this.txt_track_param, FFBatch.Properties.Strings.not_include + " " + "-c:v / -c:a / -c:s");

            toolTip24.AutoPopDelay = 1500;
            toolTip24.InitialDelay = 750;
            toolTip24.ReshowDelay = 500;
            toolTip24.ShowAlways = true;
            toolTip24.SetToolTip(this.btn_save_preset, FFBatch.Properties.Strings.save_pres);

            toolTip25.AutoPopDelay = 1500;
            toolTip25.InitialDelay = 750;
            toolTip25.ReshowDelay = 500;
            toolTip25.ShowAlways = true;
            toolTip25.SetToolTip(this.btn_add_tracks, FFBatch.Properties.Strings.add_track_l);

            toolTip26.AutoPopDelay = 3500;
            toolTip26.InitialDelay = 750;
            toolTip26.ReshowDelay = 500;
            toolTip26.ShowAlways = true;
            toolTip26.SetToolTip(this.btn_capture, FFBatch.Properties.Strings.rec_screen);

            toolTip27.AutoPopDelay = 3500;
            toolTip27.InitialDelay = 750;
            toolTip27.ReshowDelay = 500;
            toolTip27.ShowAlways = true;
            toolTip27.SetToolTip(this.chk_suffix, FFBatch.Properties.Strings.add_txt_out);

            toolTip30.AutoPopDelay = 3500;
            toolTip30.InitialDelay = 750;
            toolTip30.ReshowDelay = 500;
            toolTip30.ShowAlways = true;
            toolTip30.SetToolTip(this.chk_subfolders, FFBatch.Properties.Strings.add_subfolders);

            toolTip32.AutoPopDelay = 3500;
            toolTip32.InitialDelay = 750;
            toolTip32.ReshowDelay = 500;
            toolTip32.ShowAlways = true;
            toolTip32.SetToolTip(this.btn_refresh, FFBatch.Properties.Strings.Refresh_list);

            toolTip33.AutoPopDelay = 3500;
            toolTip33.InitialDelay = 750;
            toolTip33.ReshowDelay = 500;
            toolTip33.ShowAlways = true;
            toolTip33.SetToolTip(this.label2, FFBatch.Properties.Strings.out_ext);

            toolTip34.AutoPopDelay = 3500;
            toolTip34.InitialDelay = 750;
            toolTip34.ReshowDelay = 500;
            toolTip34.ShowAlways = true;
            toolTip34.SetToolTip(this.txt_format, FFBatch.Properties.Strings.out_ext);

            toolTip35.AutoPopDelay = 3500;
            toolTip35.InitialDelay = 750;
            toolTip35.ReshowDelay = 500;
            toolTip35.ShowAlways = true;
            toolTip35.SetToolTip(this.btn_start_m3u, FFBatch.Properties.Strings.start_one);

            toolTip36.AutoPopDelay = 3500;
            toolTip36.InitialDelay = 750;
            toolTip36.ReshowDelay = 500;
            toolTip36.ShowAlways = true;
            toolTip36.SetToolTip(this.btn_n_urls, FFBatch.Properties.Strings.down_multi);

            toolTip37.AutoPopDelay = 3500;
            toolTip37.InitialDelay = 750;
            toolTip37.ReshowDelay = 500;
            toolTip37.ShowAlways = true;
            toolTip37.SetToolTip(this.btn_validate_url, FFBatch.Properties.Strings.check_urls);

            toolTip38.AutoPopDelay = 3500;
            toolTip38.InitialDelay = 750;
            toolTip38.ReshowDelay = 500;
            toolTip38.ShowAlways = true;
            toolTip38.SetToolTip(this.btn_url_info, FFBatch.Properties.Strings.multimedia_i);

            toolTip39.AutoPopDelay = 3500;
            toolTip39.InitialDelay = 750;
            toolTip39.ReshowDelay = 500;
            toolTip39.ShowAlways = true;
            toolTip39.SetToolTip(this.btn_multi_m, FFBatch.Properties.Strings.multi_proc);

            toolTip40.AutoPopDelay = 3500;
            toolTip40.InitialDelay = 750;
            toolTip40.ReshowDelay = 500;
            toolTip40.ShowAlways = true;
            toolTip40.SetToolTip(this.btn_save_path, FFBatch.Properties.Strings.path_def);

            toolTip41.AutoPopDelay = 3500;
            toolTip41.InitialDelay = 750;
            toolTip41.ReshowDelay = 500;
            toolTip41.ShowAlways = true;
            toolTip41.SetToolTip(this.btn_save_prio, FFBatch.Properties.Strings.save_prio);

            toolTip42.AutoPopDelay = 3500;
            toolTip42.InitialDelay = 750;
            toolTip42.ReshowDelay = 500;
            toolTip42.ShowAlways = true;
            toolTip42.SetToolTip(this.btn_pause, FFBatch.Properties.Strings.pause1);

            toolTip43.AutoPopDelay = 3500;
            toolTip43.InitialDelay = 750;
            toolTip43.ReshowDelay = 500;
            toolTip43.ShowAlways = true;
            toolTip43.SetToolTip(this.btn_skip_main, FFBatch.Properties.Strings.abort_current);

            toolTip17.AutoPopDelay = 3500;
            toolTip17.InitialDelay = 750;
            toolTip17.ReshowDelay = 500;
            toolTip17.ShowAlways = true;
            toolTip17.SetToolTip(this.btn_help, FFBatch.Properties.Strings.open_user_guide);

            toolTip45.AutoPopDelay = 3500;
            toolTip45.InitialDelay = 750;
            toolTip45.ReshowDelay = 500;
            toolTip45.ShowAlways = true;
            toolTip45.SetToolTip(this.btn_multiple_presets, FFBatch.Properties.Strings.three_pres);
        }

        private void button21_Click_1(object sender, EventArgs e)
        {
            folderBrowserDialog1.ShowNewFolderButton = true;

            if (folderBrowserDialog1.ShowDialog() == DialogResult.OK)
            {
                txt_path_main.Text = folderBrowserDialog1.SelectedPath;
                txt_path_main.BackColor = txt_parameters.BackColor;
                txt_path_mux.Text = folderBrowserDialog1.SelectedPath;
                txt_path_mux.BackColor = txt_parameters.BackColor;
                btn_reset_path.BackColor = txt_parameters.BackColor;
                btn_save_path.Enabled = true;
                if (listView1.Items.Count == 0) return;

                try
                {
                    File.WriteAllText(folderBrowserDialog1.SelectedPath + "\\" + "FFBatch_test.txt", "FFBatch_test");
                    System.Threading.Thread.Sleep(10);
                    File.Delete(folderBrowserDialog1.SelectedPath + "\\" + "FFBatch_test.txt");
                }
                catch (System.Exception excpt)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.write_error1 + " " + Environment.NewLine + excpt.Message, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                    return;
                }
            }
        }

        private void textBox3_DoubleClick(object sender, EventArgs e)
        {
            txt_path_main.Text = ".\\FFBatch";
            txt_path_main.BackColor = this.BackColor;
            txt_path_mux.Text = ".\\FFBatch";
            txt_path_mux.BackColor = this.BackColor;
            btn_save_path.Enabled = true;
        }

        private void chk_vol_CheckedChanged(object sender, EventArgs e)
        {
            if (chk_vol.Checked == true)
            {
                vol_ch.Enabled = true;
                vol_ch.BackColor = Color.LightYellow;
            }
            else
            {
                vol_ch.Enabled = false;
                vol_ch.BackColor = Color.White;
            }
        }

        private void chk_shift_CheckedChanged(object sender, EventArgs e)
        {
            Num_Shift.Enabled = chk_shift.Checked;
        }

        private void button22_Click(object sender, EventArgs e)
        {
            if (listView1.Items.Count == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.list_empty, FFBatch.Properties.Strings.no_files, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            //Validated list, start processing

            if (listView1.SelectedIndices.Count == 0)
            {
                listView1.Items[0].Selected = true;
                listView1.Items[0].Focused = true;
                listView1.Focus();
            }

            if (!File.Exists(listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text))
            {
                MessageBox.Show(FFBatch.Properties.Strings.file_not_found + " " + listView1.SelectedItems[0].Text, Properties.Strings.file_not_f, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            //Try preset

            String sel_test = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
            this.Cursor = Cursors.WaitCursor;

            String file_prueba = "";

            file_prueba = sel_test;
            String fichero = Path.GetFileName(file_prueba);

            String destino_test = file_prueba.Substring(0, file_prueba.LastIndexOf('\\')) + "\\" + "FFBatch_wave";
            if (!Directory.Exists(destino_test))
            {
                Directory.CreateDirectory(destino_test);
            }

            Form frmAWait_Wave = new Form();
            frmAWait_Wave.Name = FFBatch.Properties.Strings.proc_aud;
            frmAWait_Wave.Text = FFBatch.Properties.Strings.proc_aud;
            frmAWait_Wave.Height = 100;
            frmAWait_Wave.Width = 340;
            frmAWait_Wave.MinimizeBox = false;
            frmAWait_Wave.MaximizeBox = false;
            frmAWait_Wave.Icon = this.Icon;
            frmAWait_Wave.ControlBox = false;

            frmAWait_Wave.BackColor = this.BackColor;
            Button boton_cancel_wav = new Button();
            boton_cancel_wav.Parent = frmAWait_Wave;
            boton_cancel_wav.Left = 40;
            boton_cancel_wav.Top = 20;
            boton_cancel_wav.Width = 250;
            boton_cancel_wav.Height = 27;
            boton_cancel_wav.Text = FFBatch.Properties.Strings.cancel_wav;
            boton_cancel_wav.BackColor = frmAWait_Wave.BackColor;
            boton_cancel_wav.TextAlign = ContentAlignment.MiddleCenter;
            boton_cancel_wav.Click += new EventHandler(boton_cancel_wav_Click);
            frmAWait_Wave.StartPosition = FormStartPosition.CenterScreen;
            frmAWait_Wave.Show();

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;
                /* run your code here */

                Process consola_pre = new Process();
                consola_pre.StartInfo.FileName = "ffmpeg.exe";
                consola_pre.StartInfo.Arguments = " -i " + "" + '\u0022' + file_prueba + '\u0022' + " -y " + "-filter_complex " + '\u0022' + "showwavespic=colors=#0000A0:s=800x180" + '\u0022' + " -frames:v 1" + " " + '\u0022' + destino_test + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + "png" + '\u0022';
                consola_pre.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;

                consola_pre.Start();
                consola_pre.WaitForExit();
                this.InvokeEx(f => frmAWait_Wave.Close());

                if (consola_pre.ExitCode != 0)
                {
                    this.InvokeEx(f => f.Cursor = Cursors.Arrow);

                    MessageBox.Show(FFBatch.Properties.Strings.wave_abort, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    this.InvokeEx(f => f.Cursor = Cursors.Arrow);

                    if (Directory.GetFiles(destino_test).Length == 0)
                    {
                        System.IO.Directory.Delete(destino_test);
                    }

                    return;
                }
                else
                {
                    this.InvokeEx(f => f.Cursor = Cursors.Arrow);
                    //Form wave image
                    Form frmAddWave = new Form();
                    frmAddWave.Name = FFBatch.Properties.Strings.file_wave;
                    frmAddWave.Text = FFBatch.Properties.Strings.wavef;
                    frmAddWave.Icon = this.Icon;
                    frmAddWave.Height = 280;
                    frmAddWave.Width = 810;
                    frmAddWave.FormBorderStyle = FormBorderStyle.Fixed3D;
                    frmAddWave.MaximizeBox = false;
                    frmAddWave.MinimizeBox = false;
                    frmAddWave.BackColor = this.BackColor;

                    TextBox txt_titulo = new TextBox();
                    txt_titulo.Parent = frmAddWave;
                    txt_titulo.Top = 5;
                    txt_titulo.Left = 5;
                    txt_titulo.Width = 800;
                    txt_titulo.TextAlign = HorizontalAlignment.Center;
                    txt_titulo.BorderStyle = BorderStyle.None;
                    this.InvokeEx(f => txt_titulo.Text = listView1.SelectedItems[0].Text);
                    txt_titulo.BackColor = Control.DefaultBackColor;
                    txt_titulo.Enabled = false;
                    txt_titulo.BackColor = this.BackColor;

                    PictureBox pic_wave = new PictureBox();
                    pic_wave.SizeMode = PictureBoxSizeMode.Zoom;
                    pic_wave.Parent = frmAddWave;
                    pic_wave.Left = 0;
                    pic_wave.Top = 20;
                    pic_wave.BackColor = this.BackColor;
                    String pic_file = destino_test + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + "png";
                    Image img;
                    using (var bmpTemp = new Bitmap(pic_file))
                    {
                        img = new Bitmap(bmpTemp);
                    }
                    pic_wave.Image = img;
                    if (File.Exists(pic_file))
                    {
                        File.Delete(pic_file);
                    }
                    if (Directory.Exists(destino_test))
                    {
                        int num = Directory.EnumerateFiles(destino_test, "*.*").Count();
                        if (num == 0)
                        {
                            Directory.Delete(destino_test);
                        }
                    }

                    pic_wave.Width = 800;
                    pic_wave.Height = 180;
                    pic_wave.BorderStyle = BorderStyle.FixedSingle;

                    Button boton_ok_wave = new Button();
                    boton_ok_wave.Parent = frmAddWave;
                    boton_ok_wave.Left = 330;
                    boton_ok_wave.Top = 205;
                    boton_ok_wave.Width = 120;
                    boton_ok_wave.Height = 27;
                    boton_ok_wave.Text = FFBatch.Properties.Strings.close_win;
                    boton_ok_wave.BackColor = this.BackColor;
                    boton_ok_wave.Click += new EventHandler(boton_ok_wave_Click);

                    frmAddWave.StartPosition = FormStartPosition.CenterScreen;
                    frmAddWave.ShowDialog();
                    frmAddWave.Disposed += new EventHandler(frmAddWave_Disposed);
                }
            }).Start();
            //END try preset
        }

        private void boton_cancel_wav_Click(object sender, EventArgs e)
        {
            Process[] localByName = Process.GetProcessesByName("ffmpeg");
            foreach (Process p in localByName)
                p.Kill();
            System.Threading.Thread.Sleep(500);
            Process[] localByName2 = Process.GetProcessesByName("ffmpeg");
            foreach (Process p2 in localByName2)
                p2.Kill();

            //throw new NotImplementedException();
        }

        private void frmAddWave_Disposed(object sender, EventArgs e)
        {
            //throw new NotImplementedException();
        }

        private void Form1_FormClosing(object sender, FormClosingEventArgs e)
        {
            String f_autorun = String.Empty;
            String f_multi = String.Empty;
            if (is_portable == false)
            {
                f_autorun = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_autorun.ini";
                f_multi = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_autorun_m.ini";
            }
            else
            {
                f_autorun = port_path + "ff_autorun_portable.ini";
                f_multi = port_path + "ff_autorun_m_portable.ini";
            }
            if (start_seq == true)
            {
                DialogResult a;
                if (start_multi == false)
                {
                    a = MessageBox.Show(FFBatch.Properties.Strings2.auto_ask, FFBatch.Properties.Strings.question, MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                }
                else
                {
                    a = MessageBox.Show(FFBatch.Properties.Strings2.auto_ask2, FFBatch.Properties.Strings.question, MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                }
                if (a == DialogResult.No)
                {
                    try
                    {
                        File.Delete(f_autorun);
                        File.Delete(f_multi);
                    }
                    catch
                    {
                    }
                }
            }

            System.Drawing.Rectangle bounds = this.WindowState != FormWindowState.Normal ? this.RestoreBounds : this.DesktopBounds;
            Properties.Settings.Default.wLocation = bounds.Location;
            Properties.Settings.Default.Save();

            //Remember window and size

            String f_remember_w = String.Empty;
            if (is_portable == false)
            {
                f_remember_w = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_remember_w.ini";
            }
            else
            {
                f_remember_w = port_path + "ff_remember_w_portable.ini";
            }
            try
            {
                if (remember_w == false)
                {
                    if (File.Exists(f_remember_w)) File.Delete(f_remember_w);
                }
                else
                {
                    File.WriteAllText(f_remember_w, this.Height.ToString() + Environment.NewLine + this.Width.ToString());
                }
            }
            catch
            {
                MessageBox.Show(FFBatch.Properties.Strings.un_err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            //End remember window

            if (remember_last_tab == true)
            {
                String f_remember = String.Empty;
                if (is_portable == false)
                {
                    f_remember = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_remember.ini";
                }
                else
                {
                    f_remember = port_path + "ff_remember_portable.ini";
                }

                System.IO.File.WriteAllText(f_remember, tabControl1.SelectedIndex.ToString());
            }

            if (btn_save_config.ImageKey != "Save_settings_39.png")
            {
                String messg = FFBatch.Properties.Strings.setting_c;
                if (combo_presets.Text == FFBatch.Properties.Strings.new_preset) messg = FFBatch.Properties.Strings.setting_pr_c;
                var a = MessageBox.Show(messg, FFBatch.Properties.Strings.sett_not_s, MessageBoxButtons.YesNoCancel, MessageBoxIcon.Question);
                if (a == DialogResult.Cancel) e.Cancel = true;
                else if (a == DialogResult.Yes)
                {
                    if (combo_presets.Text == FFBatch.Properties.Strings.new_preset)
                    {
                        combo_presets.Text = FFBatch.Properties.Strings.latest_preset;
                        save_preset();
                        Thread.Sleep(150);
                    }
                    btn_save_config.PerformClick();
                }
            }

            String save_path_queue = Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "saved_queue_temp.ffq";
            if (is_portable == true) save_path_queue = port_path + "saved_queue_temp.ffq";

            if (File.Exists(save_path_queue))
            {
                try
                {
                    File.Delete(save_path_queue);
                }
                catch { }
            }

            String temp_file = Path.Combine(Path.GetTempPath(), "temp_copy_clp.ff");
            if (File.Exists(temp_file))
            {
                try
                {
                    File.Delete(temp_file);
                }
                catch { }
            }
            String temp_concat = Path.Combine(Path.GetTempPath(), "concat.txt");
            if (File.Exists(temp_concat))
            {
                try
                {
                    File.Delete(temp_concat);
                }
                catch { }
            }

            if (working == true)
            {
                if (paused == false)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.q_abort, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    e.Cancel = true;
                    return;
                }
                else
                {
                    DialogResult a = MessageBox.Show(FFBatch.Properties.Strings.q_paused, FFBatch.Properties.Strings.warning, MessageBoxButtons.YesNoCancel, MessageBoxIcon.Warning);
                    if (a == DialogResult.No || a == DialogResult.Cancel)
                    {
                        e.Cancel = true;
                        return;
                    }
                    else
                    {
                        btn_pause.PerformClick();
                        this.Cursor = Cursors.WaitCursor;
                        Thread.Sleep(750);
                        //Abort
                        if (recording_scr == true)
                        {
                            Enable_Controls();
                            working = false;
                            recording_scr = false;

                            StreamWriter write_q = process_glob.StandardInput;
                            write_q.Write("q");
                            this.Cursor = Cursors.Arrow;
                            return;
                        }

                        if (multi_running == true)
                        {
                            working = false;
                            multi_running = false;
                            aborted = true;
                            cancelados_paralelos = true;

                            foreach (ListViewItem item in listView1.Items)
                            {
                                if (item.SubItems[5].Text != FFBatch.Properties.Strings.success && item.SubItems[5].Text != FFBatch.Properties.Strings.ready && item.SubItems[5].Text != FFBatch.Properties.Strings.queued && item.SubItems[5].Text != FFBatch.Properties.Strings.replaced && item.SubItems[5].Text != FFBatch.Properties.Strings.renamed && item.SubItems[5].Text != FFBatch.Properties.Strings.deleted && item.SubItems[5].Text != FFBatch.Properties.Strings.not_renamed && item.SubItems[5].Text != FFBatch.Properties.Strings.recycled && item.SubItems[5].Text != FFBatch.Properties.Strings.not_recycled && item.SubItems[5].Text != FFBatch.Properties.Strings.not_deleted)
                                {
                                    item.SubItems[5].Text = FFBatch.Properties.Strings.aborting;
                                }
                            }

                            foreach (Process proc in procs.Values)
                            {
                                cancelados_paralelos = true;
                                if (proc.StartInfo.Arguments != String.Empty)

                                {
                                    try
                                    {
                                        StreamWriter write_q = proc.StandardInput;
                                        write_q.Write("q");
                                    }
                                    catch (Exception exc)
                                    {
                                        MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + exc.Message + " " + FFBatch.Properties.Strings.some_procs, FFBatch.Properties.Strings.abort_inc, MessageBoxButtons.OK, MessageBoxIcon.Error);
                                    }
                                }
                            }
                            return;
                        }

                        if (process_glob.StartInfo.Arguments != String.Empty)
                        {
                            try
                            {
                                process_glob.Kill();
                                working = false;
                            }
                            catch { }
                        }
                        else
                        {
                            int num1 = 0;
                            Process[] localByName1 = Process.GetProcessesByName("ffmpeg");
                            num1 = localByName1.Length;
                            if (num1 == 1 && localByName1[0].Id == ff_ver_proc) return;

                            if (num1 > 0)
                            {
                                this.Cursor = Cursors.Arrow;
                                MessageBox.Show(FFBatch.Properties.Strings.ffs, FFBatch.Properties.Strings.warning, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                            }
                        }
                        cancel_queue = true;
                        cancelados_paralelos = true;

                        if (process_glob.StartInfo.Arguments != String.Empty)
                        {
                            StreamWriter write_q = process_glob.StandardInput;
                            write_q.Write("q");
                            this.Cursor = Cursors.Arrow;
                            return;
                        }
                        //End abort
                    }
                }
                this.Cursor = Cursors.Arrow;
            }

            //Child processes
            //List<Process> proc_child = new List<Process>();
            Boolean cleaned = true;
            foreach (Process proc in ProcessExtensions.GetChildProcesses(Process.GetCurrentProcess()))
            {
                try
                {
                    proc.Kill();
                }
                catch
                {
                    try
                    {
                        Thread.Sleep(10);
                        proc.Kill();
                    }
                    catch { cleaned = false; }
                }
            }
            if (cleaned == false) MessageBox.Show(FFBatch.Properties.Strings.orphan, FFBatch.Properties.Strings.orphan2, MessageBoxButtons.OK, MessageBoxIcon.Warning);

            //Remaining ffmpeg
            int num = 0;
            Process[] localByName = Process.GetProcessesByName("ffmpeg");
            num = localByName.Length;
            if (num == 1 && localByName[0].Id == ff_ver_proc) return;

            if (num > 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.ffs, FFBatch.Properties.Strings.warning, MessageBoxButtons.OK, MessageBoxIcon.Warning);
            }
            notifyIcon1.Dispose();
        }

        private void notifyIcon1_BalloonTipClicked(object sender, EventArgs e)
        {
            this.TopMost = true;
            this.TopMost = false;
            this.BringToFront();
            this.Focus();
            notifyIcon1.Visible = false;
        }

        private void label13_DoubleClick(object sender, EventArgs e)
        {
            txt_path_main.Text = ".\\FFBatch";
            txt_path_main.BackColor = Control.DefaultBackColor;
        }

        private void label13_Click(object sender, EventArgs e)
        {
            txt_path_main.Text = ".\\FFBatch";
            txt_path_main.BackColor = Control.DefaultBackColor;
        }

        private void tabControl1_SelectedIndexChanged(object sender, EventArgs e)
        {
            listView1.SelectedIndices.Clear();
            listView2.SelectedIndices.Clear();
            listView3.SelectedIndices.Clear();

            if (tabControl1.SelectedIndex == 0)
            {
                btn_add_col.Visible = true;
                btn_filter.Visible = true;
                btn_undo_filter.Visible = true;
                lbl_size.Visible = true;
                lbl_dur_list.Visible = true;
                lbl_items.Visible = true;
                lbl_urls_time.Visible = false;
                lbl_search_url.Visible = false;
                txt_search_url.Visible = false;
                lbl_n_urls.Visible = false;

                groupBox_m3u.Visible = false;
                groupBox9.Visible = false;
                groupBox2.Visible = false;
                list_tracks.Visible = false;
                chk_open_compl.Visible = true;
                chkshut.Visible = true;
                combo_ext.Visible = false;
                label19.Visible = false;
                btn_set_mux_def.Visible = false;
                lbl_tr_n.Visible = false;

                group_subs.Visible = false;
                label17.Visible = false;
                combo_item_lang_2.Visible = false;

                btn_clean_list.Visible = true;
                label13.Visible = true;
                txt_path_main.Visible = true;
                button21.Visible = true;
                chkshut.Visible = true;
                btn_pause.Visible = true;
                btn_mux.Visible = false;
                btn_extract.Visible = false;
                txt_track_format.Visible = false;
                //btn_mux_cancel.Visible = false;
                btn_del_track.Visible = false;
                btn_default_track.Visible = false;
                button23.Visible = false;
                pic_encode_param.Visible = false;
                lbl_mux_par.Visible = false;
                txt_track_param.Visible = false;
                btn_set_track_param.Visible = false;
                groupBox1.Visible = true;
                panel1.Visible = true;
                list_tracks.Visible = false;
                btn_add_tracks.Visible = false;
                btn_mux_job.Visible = false;
                btn_mux_show_jobs.Visible = false;
                lbl_mux_jobs.Visible = false;

                return;
            }
            else if (tabControl1.SelectedIndex == 1)
            {
                listView1.SelectedIndices.Clear();
                btn_add_col.Visible = false;
                btn_filter.Visible = false;
                btn_undo_filter.Visible = false;
                lbl_size.Visible = true;
                lbl_tr_n.Visible = true;
                lbl_dur_list.Visible = true;
                lbl_items.Visible = true;
                lbl_urls_time.Visible = false;
                lbl_search_url.Visible = false;
                txt_search_url.Visible = false;
                lbl_n_urls.Visible = false;
                txt_search_url.Visible = false;
                groupBox_m3u.Visible = false;
                groupBox9.Visible = true;
                groupBox2.Visible = true;
                list_tracks.Visible = true;
                chkshut.Visible = true;
                btn_pause.Visible = true;

                chk_open_compl.Visible = false;
                btn_set_mux_def.Visible = true;
                btn_set_track_param.Visible = true;

                combo_ext.Visible = true;
                label19.Visible = true;
                group_subs.Visible = false;
                label17.Visible = true;
                combo_item_lang_2.Visible = true;

                label13.Visible = false;
                txt_path_main.Visible = false;
                button21.Visible = false;

                lbl_mux_jobs.Visible = true;
                btn_mux.Visible = true;
                btn_add_tracks.Visible = true;
                btn_mux_job.Visible = true;
                btn_mux_show_jobs.Visible = true;
                btn_extract.Visible = true;
                txt_track_format.Visible = true;
                btn_del_track.Visible = true;
                btn_default_track.Visible = true;
                //btn_mux_cancel.Visible = true;
                btn_mux.Refresh();
                button23.Visible = true;
                pic_encode_param.Visible = true;
                lbl_mux_par.Visible = true;
                txt_track_param.Visible = true;
                btn_set_track_param.Visible = true;
                groupBox1.Visible = false;
                panel1.Visible = false;
                list_tracks.Visible = true;
                list_tracks.Refresh();
                txt_path_mux.Text = txt_path_main.Text;
                txt_path_mux.BackColor = txt_path_main.BackColor;

                int list_int = 0;
                if (listView1.Items.Count == listView2.Items.Count)
                {
                    foreach (ListViewItem item in listView1.Items)
                    {
                        if (listView2.Items[list_int].Text == item.SubItems[1].Text + "\\" + item.Text)
                        {
                            list_int = list_int + 1;
                        }
                    }

                    if (list_int == listView1.Items.Count)
                    {
                        return;
                    }
                }
                else
                {
                    if (listView1.Items.Count > 20)
                    {
                        var a = MessageBox.Show(FFBatch.Properties.Strings.streams_f + " " + listView1.Items.Count + " " + Properties.Strings2.files_long_t, Properties.Strings2.too_many_files, MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                        if (a == DialogResult.No)
                        {
                            tabControl1.SelectedIndex = 0;

                            return;
                        }
                        listView2.Clear();
                        add_to_tab_2();
                    }
                    else
                    {
                        listView2.Clear();
                        add_to_tab_2();
                        return;
                    }
                }

                listView2.Clear();
                add_to_tab_2();
            }
            else if (tabControl1.SelectedIndex == 2)
            {
                listView1.SelectedIndices.Clear();
                btn_add_col.Visible = false;
                btn_filter.Visible = false;
                btn_undo_filter.Visible = false;
                lbl_mux_jobs.Visible = false;
                btn_add_tracks.Visible = false;
                btn_mux_job.Visible = false;
                btn_mux_show_jobs.Visible = false;
                lbl_tr_n.Visible = false;
                lbl_size.Visible = true;
                lbl_dur_list.Visible = true;
                lbl_items.Visible = true;
                lbl_urls_time.Visible = false;
                lbl_search_url.Visible = false;
                txt_search_url.Visible = false;
                lbl_n_urls.Visible = false;

                groupBox_m3u.Visible = false;
                groupBox9.Visible = false;
                groupBox2.Visible = false;
                list_tracks.Visible = false;
                group_subs.Visible = true;
                chkshut.Visible = true;
                btn_pause.Visible = true;
                btn_set_mux_def.Visible = false;
                btn_extract.Visible = false;
                txt_track_format.Visible = false;
                btn_del_track.Visible = false;
                btn_default_track.Visible = false;
                btn_set_track_param.Visible = false;

                group_subs.Visible = true;

                TB1.Visible = false;
                txt_hard_subs.Text = txt_parameters.Text;

                int list_int = 0;

                if (listView1.Items.Count == listView3.Items.Count)
                {
                    foreach (ListViewItem item in listView1.Items)
                    {
                        if (listView3.Items[list_int].Text == item.SubItems[1].Text + "\\" + item.Text)
                        {
                            list_int = list_int + 1;
                        }
                    }

                    if (list_int == listView1.Items.Count)
                    {
                        return;
                    }
                }
                else
                {
                    if (listView1.Items.Count > 1000)
                    {
                        var a = MessageBox.Show(FFBatch.Properties.Strings.adding + " " + listView1.Items.Count + " " + FFBatch.Properties.Strings.some_time, FFBatch.Properties.Strings.many_parsed, MessageBoxButtons.OKCancel, MessageBoxIcon.Question);
                        if (a == DialogResult.Cancel)
                        {
                            tabControl1.SelectedIndex = 0;

                            return;
                        }
                        listView3.Items.Clear();
                        add_to_tab_3();
                    }
                    else
                    {
                        listView3.Items.Clear();
                        add_to_tab_3();
                        return;
                    }
                }

                listView3.Items.Clear();
                add_to_tab_3();
            }
            else if (tabControl1.SelectedIndex == 3)
            {
                listView1.SelectedIndices.Clear();
                btn_add_col.Visible = false;
                btn_filter.Visible = false;
                btn_undo_filter.Visible = false;
                lbl_mux_jobs.Visible = false;
                btn_add_tracks.Visible = false;
                btn_mux_job.Visible = false;
                btn_mux_show_jobs.Visible = false;
                lbl_size.Visible = false;
                lbl_tr_n.Visible = false;
                lbl_dur_list.Visible = false;
                lbl_items.Visible = false;
                group_subs.Visible = false;
                list_tracks.Visible = false;
                groupBox_m3u.Visible = true;
                groupBox9.Visible = false;
                groupBox2.Visible = false;
                chkshut.Visible = true;
                btn_pause.Visible = true;
                lbl_urls_time.Visible = true;
                lbl_search_url.Visible = true;
                txt_search_url.Visible = true;
                lbl_n_urls.Visible = true;
                if (yt_chk == false)
                {
                    yt_chk = true;
                    youtube_dl_ver(); //youtube-dl version
                }
                if (txt_path_m3u.Text == FFBatch.Properties.Strings.no_path2 || txt_path_m3u.Text.Length == 0)
                {
                    txt_path_m3u.Text = System.IO.Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyVideos), "M3u8");
                }
            }
        }

        private void add_to_tab_3()

        {
            listView3.SmallImageList = listView1.SmallImageList;
            foreach (ListViewItem item in listView1.Items)
            {
                this.Cursor = Cursors.WaitCursor;
                ListViewItem elemento = new ListViewItem(item.SubItems[1].Text + "\\" + item.Text, 1);
                //Begin get file icon
                Icon iconForFile = SystemIcons.WinLogo;

                if (!elemento.Text.Contains("\\\\") && 
                    !imageList2.Images.ContainsKey(System.IO.Path.GetExtension(elemento.Text)))
                {
                    iconForFile = System.Drawing.Icon.ExtractAssociatedIcon(elemento.Text);
                    this.InvokeEx(f => f.imageList2.Images.Add(System.IO.Path.GetExtension(elemento.Text), iconForFile));
                }

                if (!elemento.Text.Contains("\\\\"))
                {
                    elemento.ImageKey = System.IO.Path.GetExtension(elemento.Text);
                }
                else
                {
                    elemento.ImageIndex = 0;
                }
                listView3.Items.Add(elemento);
            }

            foreach (ListViewItem item in listView3.Items)
            {
                String is_srt = "";
                try
                {
                    is_srt = item.Text.Substring(item.Text.LastIndexOf("."));
                }
                catch { }

                if (is_srt == ".srt")
                {
                    listView3.Items.RemoveAt(item.Index);
                }

                String is_Vobsub = "";
                try
                {
                    is_Vobsub = item.Text.Substring(item.Text.LastIndexOf("."));
                }
                catch { }

                if (is_Vobsub == ".idx" || is_Vobsub == ".sub")
                {
                    listView3.Items.RemoveAt(item.Index);
                }

                String is_ass = "";
                try { is_ass = item.Text.Substring(item.Text.LastIndexOf(".")); }
                catch { }

                if (is_srt == ".ass")
                {
                    listView3.Items.RemoveAt(item.Index);
                }

                String subs_path = String.Empty;
                String Sub_File_SRT = String.Empty;
                String Sub_File_Vobsub = String.Empty;
                String Sub_File_ASS = String.Empty;

                try
                {
                    if (txt_folder_subs.Text == String.Empty)
                    {
                        Sub_File_SRT = item.Text.Substring(0, item.Text.LastIndexOf(".")) + ".srt";
                        Sub_File_Vobsub = item.Text.Substring(0, item.Text.LastIndexOf(".")) + ".idx";
                        Sub_File_ASS = item.Text.Substring(0, item.Text.LastIndexOf(".")) + ".ass";
                    }
                    else
                    {
                        String path_sub = txt_folder_subs.Text;
                        Path.GetFileName(item.Text);
                        Sub_File_SRT = path_sub + "\\" + Path.GetFileName(item.Text).Substring(0, Path.GetFileName(item.Text).LastIndexOf(".")) + ".srt";
                        Sub_File_Vobsub = path_sub + "\\" + Path.GetFileName(item.Text).Substring(0, Path.GetFileName(item.Text).LastIndexOf(".")) + ".idx";
                        Sub_File_ASS = path_sub + "\\" + Path.GetFileName(item.Text).Substring(0, Path.GetFileName(item.Text).LastIndexOf(".")) + ".ass";
                    }
                }
                catch { }

                if (item.SubItems[0].Text.Contains(FFBatch.Properties.Strings.no_sub_file) == false)
                {
                    if (File.Exists(Sub_File_SRT))
                    {
                        item.SubItems.Add(FFBatch.Properties.Strings.srt_sub);
                        item.SubItems.Add("und");

                        var a = TextFileEncodingDetector.DetectTextFileEncoding(Sub_File_SRT);
                        if (a != null)
                        {
                            String txt_enc = a.ToString().Replace("System.Text.", "");
                            item.SubItems.Add(txt_enc.Replace(FFBatch.Properties.Strings.Encoding, ""));
                        }
                        else
                        {
                            item.SubItems.Add(FFBatch.Properties.Strings.unknown);
                        }
                        item.SubItems.Add(FFBatch.Properties.Strings.yes);
                        item.SubItems.Add(FFBatch.Properties.Strings.ready);
                    }

                    if (File.Exists(Sub_File_Vobsub))
                    {
                        item.SubItems.Add(FFBatch.Properties.Strings.vob_sub);
                        item.SubItems.Add("und");

                        item.SubItems.Add("-");
                        item.SubItems.Add(FFBatch.Properties.Strings.yes);
                        item.SubItems.Add(FFBatch.Properties.Strings.ready);
                    }
                    if (File.Exists(Sub_File_ASS))
                    {
                        item.SubItems.Add(FFBatch.Properties.Strings.as_sub);
                        item.SubItems.Add("und");

                        var a = TextFileEncodingDetector.DetectTextFileEncoding(Sub_File_ASS);
                        if (a != null)
                        {
                            String txt_enc = a.ToString().Replace("System.Text.", "");
                            item.SubItems.Add(txt_enc.Replace(FFBatch.Properties.Strings.Encoding, ""));
                        }
                        else
                        {
                            item.SubItems.Add(FFBatch.Properties.Strings.unknown);
                        }
                        item.SubItems.Add(FFBatch.Properties.Strings.yes);
                        item.SubItems.Add(FFBatch.Properties.Strings.ready);
                    }
                }

                if (!File.Exists(Sub_File_Vobsub) && !File.Exists(Sub_File_SRT) && !File.Exists(Sub_File_ASS))
                {
                    item.SubItems.Add(FFBatch.Properties.Strings.no_sub2);
                    item.SubItems.Add("-");
                    item.SubItems.Add("-");
                    item.SubItems.Add("-");
                    item.SubItems.Add("No Sub");
                }
            }
            Combo_sub_lang_mux.Text = "";
            this.Cursor = Cursors.Arrow;
        }

        private void ctm2_Opening_1(object sender, CancelEventArgs e)
        {
            if (Properties.Settings.Default.dark_mode == true)
            {
                ctm2.BackColor = Color.FromArgb(255, 64, 64, 64);
                ctm2.ForeColor = Color.White;
            }
            else
            {
                ctm2.BackColor = SystemColors.InactiveBorder;
                ctm2.ForeColor = Control.DefaultForeColor;
            }

            if (listView2.SelectedItems.Count == 0)
            {
                e.Cancel = true;
                ct2_a.Enabled = false;
                ct2_v.Enabled = false;
                ct2_s.Enabled = false;
            }
            else
            {
                ct2_a.Enabled = true;
                ct2_v.Enabled = true;
                ct2_s.Enabled = true;
                combo_def_und_lang.Text = FFBatch.Properties.Strings.lang_tracks;
            }
        }

        private void ct2_v_Click(object sender, EventArgs e)
        {
            Boolean has_video = false;
            Boolean stream_found = false;
            foreach (ListViewItem track_item in list_tracks.Items)
            {
                if (track_item.SubItems[2].Text.Contains("Video"))
                {
                    has_video = true;
                    MessageBox.Show(FFBatch.Properties.Strings.alr_track, FFBatch.Properties.Strings.information, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }
            }

            foreach (ListViewItem item in listView2.SelectedItems)
            {
                for (int i = 1; i < item.SubItems.Count; i++)
                {
                    if (item.SubItems[i].Text.Contains("Video"))
                    {
                        stream_found = true;

                        list_tracks.Items.Add(listView2.SelectedItems[0].Text, 0);
                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add((i - 1).ToString());

                        if (listView2.SelectedItems[0].SubItems[i].Text.Substring(0, 1) == "(")
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(listView2.SelectedItems[0].SubItems[i].Text.Substring(7, listView2.SelectedItems[0].SubItems[i].Text.Length - 7));
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(listView2.SelectedItems[0].SubItems[i].Text);
                        }

                        if (listView2.SelectedItems[0].SubItems[i].Text.Substring(0, 1) == "(")
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(listView2.SelectedItems[0].SubItems[i].Text.Substring(1, 3));
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(def_lang_und_tracks);
                        }

                        if (has_video == false)
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(FFBatch.Properties.Strings.yes);
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(FFBatch.Properties.Strings.no);
                        }

                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(def_mux_video_enc);

                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text = Regex.Replace(list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text, @"\([^()]*\)", string.Empty);
                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text = Regex.Replace(list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text, @"\[[^()]*\]", string.Empty);
                        RegexOptions options = RegexOptions.None;
                        Regex regex = new Regex("[ ]{2,}", options);
                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text = regex.Replace(list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text, " ");
                    }
                    tracks_background();
                }

                foreach (ListViewItem track_item in list_tracks.Items)
                {
                    if (track_item.SubItems[3].Text.Contains("Video"))
                    {
                        list_tracks.Items.RemoveAt(track_item.Index);
                        list_tracks.Items.Insert(0, track_item);
                    }
                }

                if (stream_found == false)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.no_video, FFBatch.Properties.Strings.no_video2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        private void ct2_a_Click(object sender, EventArgs e)
        {
            Boolean has_audio = false;
            foreach (ListViewItem track_item in list_tracks.Items)
            {
                if (track_item.SubItems[2].Text.Contains("Audio"))
                {
                    has_audio = true;
                    break;
                }
            }

            foreach (ListViewItem item in listView2.SelectedItems)
            {
                Boolean stream_found = false;
                for (int i = 1; i < item.SubItems.Count; i++)
                {
                    if (item.SubItems[i].Text.Contains("Audio"))
                    {
                        stream_found = true;

                        list_tracks.Items.Add(listView2.SelectedItems[0].Text, 1);
                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add((i - 1).ToString());

                        if (listView2.SelectedItems[0].SubItems[i].Text.Substring(0, 1) == "(")
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(listView2.SelectedItems[0].SubItems[i].Text.Substring(7, listView2.SelectedItems[0].SubItems[i].Text.Length - 7));
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(listView2.SelectedItems[0].SubItems[i].Text);
                        }

                        if (listView2.SelectedItems[0].SubItems[i].Text.Substring(0, 1) == "(")
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(listView2.SelectedItems[0].SubItems[i].Text.Substring(1, 3));
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(def_lang_und_tracks);
                        }

                        if (has_audio == false)
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(FFBatch.Properties.Strings.yes);
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(FFBatch.Properties.Strings.no);
                        }

                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(def_mux_audio_enc);
                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text = Regex.Replace(list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text, @"\([^()]*\)", string.Empty);
                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text = Regex.Replace(list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text, @"\[[^()]*\]", string.Empty);
                        RegexOptions options = RegexOptions.None;
                        Regex regex = new Regex("[ ]{2,}", options);
                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text = regex.Replace(list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text, " ");
                    }
                }

                if (stream_found == false)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.no_audio, FFBatch.Properties.Strings.no_audio2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
            tracks_background();
        }

        private void ct2_s_Click(object sender, EventArgs e)
        {
            if (notifyIcon1 != null)
            {
                notifyIcon1.Dispose();
            }

            Boolean has_subs = false;
            foreach (ListViewItem track_item in list_tracks.Items)
            {
                if (track_item.SubItems[2].Text.Contains("Subtitle"))
                {
                    has_subs = true;
                    break;
                }
            }

            foreach (ListViewItem item in listView2.SelectedItems)
            {
                Boolean stream_found = false;
                for (int i = 1; i < item.SubItems.Count; i++)
                {
                    if (item.SubItems[i].Text.Contains("Subtitle"))
                    {
                        stream_found = true;
                        list_tracks.Items.Add(listView2.SelectedItems[0].Text, 2);
                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add((i - 1).ToString());

                        if (listView2.SelectedItems[0].SubItems[i].Text.Substring(0, 1) == "(")
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(listView2.SelectedItems[0].SubItems[i].Text.Substring(7, listView2.SelectedItems[0].SubItems[i].Text.Length - 7));
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(listView2.SelectedItems[0].SubItems[i].Text);
                        }

                        if (listView2.SelectedItems[0].SubItems[i].Text.Substring(0, 1) == "(")
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(listView2.SelectedItems[0].SubItems[i].Text.Substring(1, 3));
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(def_lang_und_tracks);
                        }

                        if (has_subs == false)
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(FFBatch.Properties.Strings.yes);
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(FFBatch.Properties.Strings.no);
                        }
                        if (item.SubItems[i].Text.Contains("dvd_subtitle") || item.SubItems[i].Text.Contains("hdmv_pgs_subtitle"))

                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add("copy");
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(def_mux_subs_enc);
                        }
                    }

                    foreach (ListViewItem track_item in list_tracks.Items)
                    {
                        if (track_item.SubItems[2].Text.Contains("Subtitle"))
                        {
                            list_tracks.Items.RemoveAt(track_item.Index);
                            list_tracks.Items.Insert(list_tracks.Items.Count, track_item);
                        }
                    }
                }

                if (stream_found == false)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.no_subs1, FFBatch.Properties.Strings.no_subs2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
            tracks_background();
        }

        private void btn_mux_Click(object sender, EventArgs e)
        {
            Pg1.Focus();

            if (!File.Exists(Path.Combine(Application.StartupPath, "ffmpeg.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_ffmpeg, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }
            if (check_ff_md5() == false)
            {
                Form25 frm25 = new Form25();
                frm25.ShowDialog();
                return;
            }

            cancel_queue = false;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";

            foreach (ListViewItem file in list_tracks.Items)
            {
                if (!File.Exists(file.Text))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file_not_found + " " + file.Text, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }

            if (list_tracks.Items.Count == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.tracks_empty, FFBatch.Properties.Strings.no_files, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }

            Boolean video_track_in = false;
            foreach (ListViewItem tracks_item in list_tracks.Items)
            {
                if (tracks_item.SubItems[2].Text.Contains("Video"))
                {
                    video_track_in = true;
                    break;
                }
            }

            if (video_track_in == false)
            {
                MessageBox.Show(FFBatch.Properties.Strings.vid_req, FFBatch.Properties.Strings.no_video2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            String is_overw = String.Empty;
            if (txt_path_main.Text.Contains(".\\"))
            {
                if (txt_path_main.Text == ".\\")
                {
                    is_overw = Path.GetDirectoryName(list_tracks.Items[0].Text) + "\\" + Path.GetFileNameWithoutExtension(list_tracks.Items[0].Text) + "." + combo_ext.SelectedItem.ToString();
                }
                else
                {
                    is_overw = Path.GetDirectoryName(list_tracks.Items[0].Text) + txt_path_main.Text.Replace(".", String.Empty) + "\\" + Path.GetFileNameWithoutExtension(list_tracks.Items[0].Text) + "." + combo_ext.SelectedItem.ToString();
                }
            }

            if (is_overw == list_tracks.Items[0].Text)
            {
                MessageBox.Show(FFBatch.Properties.Strings.overw_not2, FFBatch.Properties.Strings.overw_not_all, MessageBoxButtons.OK, MessageBoxIcon.Error);

                return;
            }

            DateTime time2;
            if (!DateTime.TryParse(ss_time_input.Text, out time2))
            {
                MessageBox.Show(FFBatch.Properties.Strings.pre_input4, FFBatch.Properties.Strings.pre_input2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (txt_path_mux.Text.Length < 2)
            {
                MessageBox.Show(Properties.Strings.invalid_path);
                return;
            }

            //Validated list, start processing
            //Pending duration

            if (dur_ok == false)
            {
                list_pending_dur.Items.Clear();
                foreach (ListViewItem item in listView1.Items)
                {
                    list_pending_dur.Items.Add((ListViewItem)item.Clone());
                }
                BG_Dur.RunWorkerAsync();
                return;
            }

            Disable_Controls();
            txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + "00h:00m:00s";
            time_n_tasks = 0;
            timer_tasks.Start();
            timer_est_size.Start();

            cancel_queue = false;
            Pg1.Value = 0;

            pic_no_errors.Visible = false;
            pic_recording.Visible = false;
            pic_warnings.Visible = false;

            working = true;

            //Copy list of tracks for thread processing
            ListView list_proc = new ListView();
            foreach (ListViewItem item in list_tracks.Items)
            {
                list_proc.Items.Add((ListViewItem)item.Clone());
            }
            //End of copy list of tracks for thread processing

            Pg1.Maximum = list_proc.Items.Count;

            Double total_duration = 0;
            Double total_prog = 0;

            //Get specific track list video duration
            //Duration
            Boolean has_audio_for_image = false;
            Process probe = new Process();
            probe.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
            String ffprobe_frames = " " + '\u0022' + "--Inform=General;%Duration/String3%" + '\u0022';
            probe.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + list_proc.Items[1].Text + '\u0022';

            probe.StartInfo.RedirectStandardOutput = true;
            probe.StartInfo.UseShellExecute = false;
            probe.StartInfo.CreateNoWindow = true;
            probe.EnableRaisingEvents = true;
            probe.Start();

            String duracion = probe.StandardOutput.ReadLine();

            probe.WaitForExit();

            if (duracion != null)
            {
                TimeSpan time0;
                if (TimeSpan.TryParse(duracion, out time0))
                {
                    //total_duration = Convert.ToDouble(duracion.Substring(0, 7));
                    durat_n = TimeSpan.Parse(duracion).TotalSeconds;
                    total_duration = durat_n;
                }
            }
            else
            {
                durat_n = 0;
                total_duration = 0;
            }

            //End duration

            //End

            Pg1.Minimum = 0;
            Pg1.Maximum = 100;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            lbl_speed.Text = String.Empty;
            lbl_elapsed.Text = FFBatch.Properties.Strings.time_elapsed + " " + "00h:00m:00s";

            List<string> list_lines = new List<string>();
            String mux_ext = combo_ext.Text;

            String hw_decode = String.Empty;
            if (cb_hwdecode.SelectedItem.ToString() != "none")
            {
                hw_decode = "-hwaccel " + cb_hwdecode.SelectedItem.ToString();
            }

            //Save selected hw decoder

            String path2 = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_hw_dcd.ini";
            String txt_hw_dcd = cb_hwdecode.SelectedItem.ToString();
            if (txt_hw_dcd != "none")
            {
                File.WriteAllText(path2, txt_hw_dcd);
            }
            else
            {
                if (File.Exists(path2)) File.Delete(path2);
            }

            //End save hw decoder

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;
                /* run your code here */

                String remain_time = "0";

                //this.InvokeEx(f => f.pg_current.Value = 0);
                //this.InvokeEx(f => f.pg_current.Refresh());

                String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");

                String file = list_proc.Items[0].Text;
                String fullPath = file;
                String destino = "";

                if (txt_path_main.Text.Contains(".\\"))
                {
                    destino = file.Substring(0, fullPath.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
                }
                else
                {
                    destino = txt_path_main.Text;
                }

                if (!Directory.Exists(destino))
                {
                    Directory.CreateDirectory(destino);
                }

                //Create joint inputs variable
                String inputs = String.Empty;
                foreach (ListViewItem input_item in list_proc.Items)
                {
                    if (input_item.SubItems[2].Text.Contains("Subtitle") && !input_item.SubItems[2].Text.Contains("hdmv_pgs") && !input_item.SubItems[2].Text.Contains("dvd_subtitle"))
                    {
                        inputs = inputs + " -sub_charenc UTF-8" + " -i " + '\u0022' + input_item.Text + '\u0022';
                    }
                    else
                    {
                        if (input_item.BackColor != Color.LightYellow)
                        {
                            inputs = inputs + " -i " + '\u0022' + input_item.Text + '\u0022';
                        }
                        else
                        {
                            String ext_image = Path.GetExtension(list_proc.Items[0].Text);

                            //Attempt to extract frame as image
                            Process proc_img = new System.Diagnostics.Process();
                            String ffm_img = Path.Combine(Application.StartupPath, "ffmpeg.exe");

                            String file_img = Path.GetFullPath(list_proc.Items[0].Text);
                            String fullPath_img = file_img;
                            String AppParam_img = "";

                            if (ext_image != ".jpg" && ext_image != ".jpeg" && ext_image != ".png" && ext_image != ".gif" && ext_image != ".bmp" && ext_image != ".tiff" && ext_image != ".psd")
                            {
                                AppParam_img = " -ss " + ss_time_input.Text + " -i " + "" + '\u0022' + file_img + '\u0022' + " -vframes 1 -f image2" + " -qscale:v 2" + " -vf scale=1280:-2" + " -y " + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_img) + "." + "jpg" + '\u0022';
                            }
                            else
                            {
                                AppParam_img = " -i " + "" + '\u0022' + file_img + '\u0022' + " -qscale:v 2" + " -vf scale=1280:-2" + " -y " + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_img) + "." + "jpg" + '\u0022';
                            }
                            proc_img.StartInfo.RedirectStandardOutput = false;
                            proc_img.StartInfo.RedirectStandardError = false;
                            proc_img.StartInfo.UseShellExecute = true;
                            proc_img.StartInfo.CreateNoWindow = false;
                            proc_img.EnableRaisingEvents = false;
                            proc_img.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;

                            proc_img.StartInfo.FileName = ffm_img;
                            proc_img.StartInfo.Arguments = AppParam_img;

                            proc_img.Start();
                            proc_img.WaitForExit();
                            if (proc_img.ExitCode == 0)
                            {
                                String extracted_img = "" + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_img) + ".jpg" + '\u0022' + "";
                                inputs = inputs + " -i " + extracted_img;
                            }
                            else
                            {
                                MessageBox.Show(FFBatch.Properties.Strings.err_ext_vid, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                                Enable_Controls();
                                working = false;
                                return;
                            }
                            //End extract frame as image
                        }
                    }
                }
                //End create joint inputs variable

                //Create mapping inputs variable
                String input_map = String.Empty;
                //Add video track, it must be first
                if (list_proc.Items[0].BackColor == Color.LightYellow)
                {
                    //Video track is an still image

                    //Attempt to extract first frame from video track as image

                    input_map = input_map + " -map 0:0" + " -c:v libx264 -r 1 -crf 29 -preset veryfast -x264-params keyint=1 -pix_fmt yuv420p";
                }
                else
                {
                    input_map = input_map + " -map 0:" + list_proc.Items[0].SubItems[1].Text + " -c:v " + list_proc.Items[0].SubItems[5].Text + " -metadata:s:v:0 language=" + list_proc.Items[0].SubItems[3].Text;
                }

                int int_auds = 0;
                int i_subs = 0;

                for (int i = 1; i < list_tracks.Items.Count; i++)

                {
                    //Audio tracks
                    if (list_proc.Items[i].SubItems[2].Text.Contains("Audio"))
                    {
                        String is_default = String.Empty;
                        if (list_proc.Items[i].SubItems[4].Text == FFBatch.Properties.Strings.yes)
                        {
                            is_default = "-disposition:a:" + (int_auds).ToString() + " default";
                        }
                        else
                        {
                            is_default = "-disposition:a:" + (int_auds).ToString() + " 0";
                        }
                        String track_codec = " -c:a copy ";
                        if (list_proc.Items[i].SubItems[5].Text != "copy")
                        {
                            track_codec = " -c:a:" + int_auds + " " + list_proc.Items[i].SubItems[5].Text;
                        }
                        input_map = input_map + " -map " + (i).ToString() + ":" + list_proc.Items[i].SubItems[1].Text + track_codec + " -metadata:s:a:" + (int_auds).ToString() + " language=" + list_proc.Items[i].SubItems[3].Text + " " + is_default;
                        int_auds = int_auds + 1;
                    }
                }

                for (int i = 1; i < list_tracks.Items.Count; i++)

                {
                    //Subtitle tracks
                    if (list_proc.Items[i].SubItems[2].Text.Contains("Subtitle"))
                    {
                        String is_default = String.Empty;
                        if (list_proc.Items[i].SubItems[4].Text == FFBatch.Properties.Strings.yes)
                        {
                            is_default = "-disposition:s:" + (i_subs).ToString() + " default";
                        }
                        else
                        {
                            is_default = "-disposition:s:" + (i_subs).ToString() + " 0";
                        }

                        input_map = input_map + " -map " + (i).ToString() + ":" + list_proc.Items[i].SubItems[1].Text + " -c:s " + list_proc.Items[i].SubItems[5].Text + " -metadata:s:s:" + (i_subs).ToString() + " language=" + list_proc.Items[i].SubItems[3].Text + " " + is_default;

                        i_subs = i_subs + 1;
                    }
                }

                // Average frames
                int fframes = 0;
                Decimal dec = 0;
                Decimal tot_frames2 = 0;

                try
                {
                    String ff_frames = String.Empty;

                    Process get_frames = new Process();
                    get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "mediainfo.exe");
                    String ffprobe_frames1 = "--Output=" + '\u0022' + "Video;%FrameCount%" + '\u0022';
                    get_frames.StartInfo.Arguments = ffprobe_frames1 + " " + '\u0022' + file + '\u0022';
                    get_frames.StartInfo.RedirectStandardOutput = true;
                    get_frames.StartInfo.RedirectStandardError = true;
                    get_frames.StartInfo.UseShellExecute = false;
                    get_frames.StartInfo.CreateNoWindow = true;
                    get_frames.EnableRaisingEvents = true;
                    get_frames.Start();

                    ff_frames = get_frames.StandardOutput.ReadLine();
                    get_frames.WaitForExit();

                    if (get_frames.ExitCode == 0)
                    {
                        if (ff_frames != null)
                        {
                            dec = decimal.Parse(ff_frames);
                            if (dec.ToString().Substring(dec.ToString().Length - 1, 1) == "0") dec = dec / 10;
                        }
                        else
                        {
                            dec = 0;
                        }

                        get_frames.Dispose();
                        tot_frames2 = tot_frames2 + dec;
                    }
                }
                catch
                {
                    dec = 0;
                }

                // End average frames

                String AppParam = String.Empty;

                if (list_proc.Items[0].BackColor == Color.LightYellow)
                {
                    AppParam = hw_decode + " -loop 1 -r 6 " + inputs + input_map + " -shortest " + "-y " + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + "." + mux_ext + '\u0022';
                }
                else
                {
                    AppParam = hw_decode + " " + inputs + input_map + " -y " + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + "." + mux_ext + '\u0022';
                }

                if (!Directory.Exists(destino))
                {
                    Directory.CreateDirectory(destino);
                }

                process_glob.StartInfo.FileName = ffm;
                process_glob.StartInfo.Arguments = AppParam + " -hide_banner";

                valid_prog = false;

                //this.InvokeEx(f => f.pg_current.Value = 0);
                //this.InvokeEx(f => f.pg_current.Refresh());

                process_glob.StartInfo.RedirectStandardOutput = true;
                process_glob.StartInfo.RedirectStandardError = true;
                process_glob.StartInfo.RedirectStandardInput = true;
                process_glob.StartInfo.UseShellExecute = false;
                process_glob.StartInfo.CreateNoWindow = true;
                process_glob.EnableRaisingEvents = true;
                process_glob.Start();

                System.Threading.Thread.Sleep(50);
                combo_prio.Invoke(new MethodInvoker(delegate
                {
                    if (combo_prio.SelectedIndex != 2)
                    {
                        Change_mem_prio();
                    }
                }));

                valid_prog = true;

                String err_txt = "";
                Double interval = 0;
                try
                {
                    while (!process_glob.StandardError.EndOfStream)
                    {
                        err_txt = process_glob.StandardError.ReadLine();
                        list_lines.Add(err_txt);

                        Decimal est_bitrate = 0;
                        Decimal est_size = 0;

                        if (err_txt.Contains("time=") && err_txt.Contains("time=-") == false)
                        {
                            total_prog = durat_n;
                            int start_time_index = err_txt.IndexOf("time=") + 5;
                            Double sec_prog = TimeSpan.Parse(err_txt.Substring(start_time_index, 8)).TotalSeconds;
                            Double percent = (sec_prog * 100 / durat_n);

                            total_prog = total_prog + (sec_prog - interval);
                            interval = sec_prog;
                            int percent2 = Convert.ToInt32(percent);

                            if (percent2 <= 100)
                            {
                                //this.InvokeEx(f => f.pg_current.Value = percent2);

                                //this.InvokeEx(f => f.//textBox4.Text = (percent2).ToString() + "%");

                                this.InvokeEx(f => f.Pg1.Value = percent2);
                                this.InvokeEx(f => f.Pg1.Refresh());
                                if (Math.Round(percent, 1).ToString().Contains(".") || Math.Round(percent, 1).ToString().Contains(","))
                                {
                                    this.InvokeEx(f => f.Pg1.Text = Math.Round(percent, 1).ToString() + "%");
                                }
                                else
                                {
                                    this.InvokeEx(f => f.Pg1.Text = Math.Round(percent, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0" + "%");
                                }
                                //this.InvokeEx(f => f.textBox5.Text = (percent2).ToString() + "%");

                                this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, Pg1.Value, Pg1.Maximum));
                            }

                            //Estimated remaining time

                            remain_time = err_txt.Substring(err_txt.LastIndexOf("speed=") + 6, err_txt.Length - err_txt.LastIndexOf("speed=") - 6);
                            if (time_est_size % 3 == 0) this.InvokeEx(f => f.lbl_speed.Text = FFBatch.Properties.Strings.speed + " " + remain_time);
                            remain_time = remain_time.Replace("x", String.Empty);
                            Double timing1 = 0;

                            if (System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator == ",")
                            {
                                timing1 = Math.Round(Double.Parse(remain_time.Replace(".", ",")), 2);
                            }
                            else
                            {
                                timing1 = Math.Round(Double.Parse(remain_time), 2);
                            }
                            Decimal timing = (decimal)timing1;
                            Decimal total_dur_dec = Convert.ToDecimal(interval);
                            Decimal total_prog_dec = Convert.ToDecimal(total_prog);

                            Decimal remain_secs = 0;
                            if (timing > 0)
                            {
                                remain_secs = (decimal)(total_prog_dec - total_dur_dec) / timing;
                            }

                            if (remain_secs > 60)
                            {
                                remain_secs = remain_secs + 60;
                            }
                            String remain_from_secs = "";

                            TimeSpan t = TimeSpan.FromSeconds(Convert.ToDouble(remain_secs));
                            remain_from_secs = string.Format("{0:D2}h:{1:D2}",
                               t.Hours,
                              t.Minutes);

                            if (remain_secs >= 3600)
                            {
                                this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs + " " + FFBatch.Properties.Strings.minutes_abrev);
                            }

                            if (remain_secs < 3600 && remain_secs >= 600)
                            {
                                this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes);
                            }
                            if (remain_secs < 600 && remain_secs >= 120)
                            {
                                this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes);
                            }

                            if (remain_secs <= 59)
                            {
                                this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Convert.ToInt16(Math.Abs(remain_secs)) + " " + FFBatch.Properties.Strings.seconds);
                            }

                            //End remaining time

                            //Estimated size and bitrate

                            String read_size = String.Empty;
                            if (err_txt.Contains("size=") && (time_est_size % 2 == 0))
                            {
                                int size_index = err_txt.IndexOf("size=") + 5;
                                read_size = err_txt.Substring(size_index, 8);
                                //est_bitrate = (Math.Round(Convert.ToDecimal(read_size) * 8 / Convert.ToDecimal(sec_prog), 0));
                                if (Convert.ToDecimal(sec_prog) != 0)
                                {
                                    est_bitrate = (Math.Round(Convert.ToDecimal(read_size) * 8 / Convert.ToDecimal(sec_prog), 0));
                                }
                                else
                                {
                                    est_bitrate = 0;
                                }

                                if (Convert.ToDecimal(read_size) > 1 && time_n_tasks > 1)
                                {
                                    if (est_bitrate < 9999)
                                    {
                                        this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " " + est_bitrate + " " + "Kb/s");
                                    }
                                    else
                                    {
                                        this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " " + (Math.Round(est_bitrate / 1000, 0)) + " " + "Mb/s");
                                    }
                                    //Estimated size
                                    est_size = Convert.ToDecimal(durat_n) * est_bitrate / 8;

                                    if (est_size > 1000000)
                                    {
                                        this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " " + (Math.Round(est_size / 1000000, 1)).ToString() + " " + "GB");
                                    }
                                    else
                                    {
                                        if (est_size > 0) this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " " + (Math.Round(est_size / 1000, 0)).ToString() + " " + "MB");
                                    }
                                }
                            }
                        }
                    }
                }
                catch { }

                process_glob.WaitForExit();
                this.InvokeEx(f => f.Pg1.Value = 100);
                this.InvokeEx(f => f.Pg1.Text = "100%");
                this.InvokeEx(f => f.Pg1.Refresh());

                process_glob.StartInfo.Arguments = String.Empty;
                this.InvokeEx(f => f.lbl_speed.Text = String.Empty);
                this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                this.InvokeEx(f => f.lbl_est_size.Text = String.Empty);
                this.InvokeEx(f => f.lbl_bitrate.Text = String.Empty);

                list_lines.Add("");
                list_lines.Add("---------------------End of " + Path.GetFileName(file) + " log-------------------------------");
                list_lines.Add("");

                working = false;

                //Averages
                if (time_n_tasks == 0) time_n_tasks = 1;
                Double avg_enc = Math.Round((total_duration / time_n_tasks), 1);
                Decimal deci = Convert.ToDecimal(time_n_tasks, CultureInfo.CurrentUICulture);

                try
                {
                    if (cancel_queue == false)
                    {
                        if (tot_frames2 != 0)
                        {
                            list_lines.Add(Environment.NewLine + (FFBatch.Properties.Strings.avg_perf + " " + avg_enc.ToString() + "x" + "  |  " + Math.Round(tot_frames2 / time_n_tasks, 1)).ToString() + " fps");
                            this.InvokeEx(f => f.lbl_speed.Text = ("AVG: " + avg_enc.ToString() + "x" + "  |  " + Math.Round(tot_frames2 / time_n_tasks, 1)).ToString() + " fps");
                        }
                        else
                        {
                            list_lines.Add(Environment.NewLine + FFBatch.Properties.Strings.avg_perf + " " + avg_enc.ToString() + "x");
                            this.InvokeEx(f => f.lbl_speed.Text = "AVG: " + avg_enc.ToString() + "x");
                        }
                    }
                }
                catch { }

                //End averages

                if (no_save_logs == false)
                {
                    string[] array_err = list_lines.ToArray();
                    String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                    if (is_portable == true) path = port_path + "ff_batch_portable.log";

                    System.IO.StreamWriter SaveFile = new System.IO.StreamWriter(path);
                    SaveFile.WriteLine("FFmpeg log sesion: " + System.DateTime.Now);
                    SaveFile.WriteLine("-------------------------------");
                    foreach (String item in array_err)
                    {
                        SaveFile.WriteLine(item);
                    }
                    SaveFile.Close();

                    File.AppendAllText(path, "-----------------------");
                    File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.end_log);
                    System.IO.FileInfo fileInfo = new System.IO.FileInfo(path);

                    var bytes = fileInfo.Length;

                    var kilobytes = (double)bytes / 1024;
                    var megabytes = kilobytes / 1024;
                    var gigabytes = megabytes / 1024;

                    //Format size view
                    String size = "";
                    String separator = ".";

                    if (bytes > 1000000000)
                    {
                        if (gigabytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }

                        String gigas = gigabytes.ToString();
                        if (gigas.Length >= 5)
                        {
                            gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                            size = (gigas + " " + "GB");
                        }
                        else
                        {
                            size = (gigas + " " + "GB");
                        }
                    }

                    if (bytes >= 1048576 && bytes <= 1000000000)
                    {
                        if (megabytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }
                        String megas = megabytes.ToString();
                        if (megas.Length > 5)
                        {
                            megas = megas.Substring(0, megas.LastIndexOf(separator));
                            size = (megas + " " + "MB");
                        }
                        else
                        {
                            size = (megas + " " + "MB");
                        }
                    }

                    if (bytes >= 1024 && bytes < 1048576)

                    {
                        if (kilobytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }

                        String kbs = kilobytes.ToString();
                        if (kbs.Length >= 5)
                        {
                            kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                            size = (kbs + " " + "KB");
                        }
                        else
                        {
                            size = (kbs + " " + "KB");
                        }
                    }
                    if (bytes > -1 && bytes < 1024)
                    {
                        String bits = bytes.ToString();
                        size = (bits + " Bytes");
                    }

                    //End Format size view
                    File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.log_size + " " + size);

                    //End save log
                }

                Enable_Controls();
                timer_est_size.Stop();
                time_est_size = 0;

                if (process_glob.ExitCode == 0 && cancel_queue == false)
                {
                    if (chkshut.Checked)
                    {
                        this.InvokeEx(f => f.groupBox2.Enabled = true);
                        foreach (Control ct in groupBox2.Controls)
                        {
                            this.InvokeEx(f => ct.Enabled = false);
                        }
                        auto_shut();
                        return;
                    }

                    //End shutdown check
                    else
                    {
                        if (play_on_end == true) play_end();
                        if (Form.ActiveForm == null)
                        {
                            notifyIcon1.Visible = true;
                            notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.mux_ok;
                            notifyIcon1.BalloonTipIcon = ToolTipIcon.Info;
                            notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.mux_ok2;
                            notifyIcon1.ShowBalloonTip(0);
                        }

                        if (chk_open_compl.Checked)
                        {
                            if (Directory.GetFiles(destino).Length != 0)
                            {
                                destino = destino.Replace("\\\\", "\\");
                                Process open_processed = new Process();
                                open_processed.StartInfo.FileName = "explorer.exe";
                                open_processed.StartInfo.Arguments = '\u0022' + destino + '\u0022';
                                open_processed.Start();
                            }
                            else
                            {
                                if (Directory.Exists(destino))
                                {
                                    System.IO.Directory.Delete(destino);
                                }
                            }
                        }
                    }
                }
                else
                {
                    if (process_glob.ExitCode == 0)
                    {
                        this.InvokeEx(f => f.Pg1.Text = "100%");
                        this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.mux_abort1, FFBatch.Properties.Strings.aborted, MessageBoxButtons.OK, MessageBoxIcon.Error));
                    }
                    else
                    {
                        this.InvokeEx(f => f.Pg1.Text = "100%");
                        Boolean unsupported = false;
                        foreach (String lin in list_lines)
                        {
                            if (lin.Contains("Could not write header")) unsupported = true;
                        }
                        if (unsupported == true) this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.mux_fail1 + " " + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.unsupported1 + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.check_log, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error));
                        else this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.mux_fail1 + " " + Environment.NewLine + Environment.NewLine + err_txt.TrimStart() + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.check_log, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error));
                    }
                }
            }).Start();
        }

        private void ct2_all_Click(object sender, EventArgs e)
        {
            foreach (ListViewItem item in listView2.SelectedItems)
            {
                if (list_tracks.Items.Count == 0)
                {
                    tracks_empty = true;
                }
                else
                {
                    tracks_empty = false;
                }

                if (item.SubItems[1].Text == FFBatch.Properties.Strings.no_streams1)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.no_streams2, FFBatch.Properties.Strings.no_streams1, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                for (int i = 1; i < item.SubItems.Count; i++)
                {
                    //Video
                    Boolean has_video = false;
                    foreach (ListViewItem track_item in list_tracks.Items)
                    {
                        if (track_item.SubItems[2].Text.Contains("Video"))
                        {
                            has_video = true;
                        }
                    }

                    if (item.SubItems[i].Text.Contains("Video") && has_video == false)
                    {
                        list_tracks.Items.Add(item.Text, 0);
                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add((i - 1).ToString());

                        if (item.SubItems[i].Text.Substring(0, 1) == "(")
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(item.SubItems[i].Text.Substring(7, item.SubItems[i].Text.Length - 7));
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(item.SubItems[i].Text);
                        }

                        if (item.SubItems[i].Text.Substring(0, 1) == "(")
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(item.SubItems[i].Text.Substring(1, 3));
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(def_lang_und_tracks);
                        }

                        if (has_video == false)
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(FFBatch.Properties.Strings.yes);
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(FFBatch.Properties.Strings.no);
                        }

                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(def_mux_video_enc);

                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text = Regex.Replace(list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text, @"\([^()]*\)", string.Empty);
                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text = Regex.Replace(list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text, @"\[[^()]*\]", string.Empty);
                        RegexOptions options = RegexOptions.None;
                        Regex regex = new Regex("[ ]{2,}", options);
                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text = regex.Replace(list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text, " ");
                    }

                    foreach (ListViewItem track_item in list_tracks.Items)
                    {
                        if (track_item.SubItems[2].Text.Contains("Video"))
                        {
                            list_tracks.Items.RemoveAt(track_item.Index);
                            list_tracks.Items.Insert(0, track_item);
                        }
                    }

                    // Audio

                    Boolean has_audio = false;
                    foreach (ListViewItem track_item in list_tracks.Items)
                    {
                        if (track_item.SubItems[2].Text.Contains("Audio"))
                        {
                            has_audio = true;
                            break;
                        }
                    }

                    if (item.SubItems[i].Text.Contains("Audio"))
                    {
                        list_tracks.Items.Add(item.Text, 1);
                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add((i - 1).ToString());

                        if (item.SubItems[i].Text.Substring(0, 1) == "(")
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(item.SubItems[i].Text.Substring(7, item.SubItems[i].Text.Length - 7));
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(item.SubItems[i].Text);
                        }

                        if (item.SubItems[i].Text.Substring(0, 1) == "(")
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(item.SubItems[i].Text.Substring(1, 3));
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(def_lang_und_tracks);
                        }

                        if (has_audio == false)
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(FFBatch.Properties.Strings.yes);
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(FFBatch.Properties.Strings.no);
                        }
                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(def_mux_audio_enc);

                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text = Regex.Replace(list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text, @"\([^()]*\)", string.Empty);
                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text = Regex.Replace(list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text, @"\[[^()]*\]", string.Empty);
                        RegexOptions options = RegexOptions.None;
                        Regex regex = new Regex("[ ]{2,}", options);
                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text = regex.Replace(list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text, " ");
                    }

                    //Subtitles

                    Boolean has_subs = false;
                    foreach (ListViewItem track_item in list_tracks.Items)
                    {
                        if (track_item.SubItems[2].Text.Contains("Subtitle"))
                        {
                            has_subs = true;
                            break;
                        }
                    }

                    if (item.SubItems[i].Text.Contains("Subtitle"))
                    {
                        list_tracks.Items.Add(item.Text, 2);
                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add((i - 1).ToString());

                        if (item.SubItems[i].Text.Substring(0, 1) == "(")
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(item.SubItems[i].Text.Substring(7, item.SubItems[i].Text.Length - 7));
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(item.SubItems[i].Text);
                        }

                        if (item.SubItems[i].Text.Substring(0, 1) == "(")
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(item.SubItems[i].Text.Substring(1, 3));
                        }
                        else if (item.SubItems[i].Text.Substring(3, 1) == ")")
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(item.SubItems[i].Text.Substring(0, 3));
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(def_lang_und_tracks);
                        }

                        if (has_subs == false)
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(FFBatch.Properties.Strings.yes);
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(FFBatch.Properties.Strings.no);
                        }
                        if (item.SubItems[i].Text.Contains("dvd_subtitle") || item.SubItems[i].Text.Contains("hdmv_pgs_subtitle"))

                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add("copy");
                        }
                        else
                        {
                            list_tracks.Items[list_tracks.Items.Count - 1].SubItems.Add(def_mux_subs_enc);
                        }
                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text = Regex.Replace(list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text, @"\([^()]*\)", string.Empty);
                        RegexOptions options = RegexOptions.None;
                        Regex regex = new Regex("[ ]{2,}", options);
                        list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text = regex.Replace(list_tracks.Items[list_tracks.Items.Count - 1].SubItems[2].Text, " ");
                    }

                    foreach (ListViewItem track_item in list_tracks.Items)
                    {
                        if (track_item.SubItems[2].Text.Contains("Subtitle"))
                        {
                            list_tracks.Items.RemoveAt(track_item.Index);
                            list_tracks.Items.Insert(list_tracks.Items.Count, track_item);
                        }
                    }
                }
            }

            lbl_tr_n.Text = FFBatch.Properties.Strings.tracks + " " + list_tracks.Items.Count.ToString();
            tracks_background();
        }

        private void listView2_DoubleClick(object sender, EventArgs e)
        {
            ct2_all.PerformClick();
        }

        private void list_tracks_KeyUp(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Delete)
            {
                foreach (ListViewItem elemento in list_tracks.SelectedItems)
                {
                    list_tracks.Items.Remove(elemento);
                    pic_encode_param.Image = null;
                }
            }
            lbl_tr_n.Text = FFBatch.Properties.Strings.tracks + " " + list_tracks.Items.Count.ToString();
            //Review audio track defaults
            Boolean has_default = false;
            foreach (ListViewItem audio_item in list_tracks.Items)
            {
                if (audio_item.SubItems[2].Text.Contains("Audio") &&
                    audio_item.SubItems[4].Text == FFBatch.Properties.Strings.yes)
                {
                    has_default = true;
                    break;
                }
            }
            if (has_default == false)
            {
                foreach (ListViewItem audio_item in list_tracks.Items)
                {
                    if (audio_item.SubItems[2].Text.Contains("Audio"))
                    {
                        audio_item.SubItems[4].Text = FFBatch.Properties.Strings.yes;
                        return;
                    }
                }
            }
            //End review audio track defaults
        }

        private void ctm3_Opening(object sender, CancelEventArgs e)
        {
            if (Properties.Settings.Default.dark_mode == true)
            {
                ctm3.BackColor = Color.FromArgb(255, 64, 64, 64);
                ctm3.ForeColor = Color.White;
            }
            else
            {
                ctm3.BackColor = SystemColors.InactiveBorder;
                ctm3.ForeColor = Control.DefaultForeColor;
            }

            if (list_tracks.Items.Count > 1 && list_tracks.SelectedItems.Count > 1)
            {
                foreach (ToolStripItem ct in ctm3.Items)
                {
                    ct.Visible = false;
                }
                ct3_save_track.Visible = true;
                ct3_del.Visible = true;
                return;
            }

            foreach (ToolStripItem ct in ctm3.Items)
            {
                ct.Visible = true;
            }

            if (list_tracks.Items.Count == 0 || list_tracks.SelectedIndices.Count == 0)
            {
                ct3_combo_language.Text = FFBatch.Properties.Strings.Language;
                e.Cancel = true;
            }

            if (list_tracks.SelectedIndices.Count > 1)
            {
                foreach (ToolStripItem ct in ctm3.Items)
                {
                    ct.Visible = false;
                    ct3_del.Visible = true;
                }
            }
            if (list_tracks.SelectedIndices.Count == 1) ct3_combo_language.Text = FFBatch.Properties.Strings.Language;
        }

        private void ct3_combo_language_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (list_tracks.SelectedIndices.Count > 0)
            {
                foreach (ListViewItem item in list_tracks.SelectedItems)
                {
                    item.SubItems[3].Text = ct3_combo_language.SelectedItem.ToString().Substring(ct3_combo_language.SelectedItem.ToString().Length - 4, 3);
                }
                ctm3.Close();
            }
        }

        private void ct3_default_Click(object sender, EventArgs e)
        {
            if (list_tracks.SelectedIndices.Count == 0 || list_tracks.SelectedItems[0].SubItems[3].Text.Contains("Video"))
            {
                return;
            }

            if (list_tracks.SelectedItems[0].SubItems[4].Text == FFBatch.Properties.Strings.yes)
            {
                list_tracks.SelectedItems[0].SubItems[4].Text = FFBatch.Properties.Strings.no;
            }
            else
            {
                list_tracks.SelectedItems[0].SubItems[4].Text = FFBatch.Properties.Strings.yes;
            }

            //Review audio defaults
            int default_items = 0;

            for (int i = 0; i < list_tracks.Items.Count; i++)
            {
                if (list_tracks.Items[i].SubItems[2].Text.Contains("Audio") && 
                    list_tracks.Items[i].SubItems[4].Text == FFBatch.Properties.Strings.yes)
                {
                    default_items = default_items + 1;
                }
            }

            if (default_items > 1)
            {
                foreach (ListViewItem audio_item in list_tracks.Items)
                {
                    if (audio_item.SubItems[2].Text.Contains("Audio") && 
                        audio_item.Text != list_tracks.SelectedItems[0].Text)
                    {
                        audio_item.SubItems[2].Text = FFBatch.Properties.Strings.no;
                    }
                }
            }
            else
            {
                foreach (ListViewItem audio_item in list_tracks.Items)
                {
                    if (audio_item.SubItems[2].Text.Contains("Audio") &&
                        audio_item.Text != list_tracks.SelectedItems[0].Text)
                    {
                        audio_item.SubItems[4].Text = FFBatch.Properties.Strings.yes;
                        return;
                    }
                }
            }

            //End review audio track defaults

            //Begin subtitle defaults

            //Review audio defaults
            int default_subs = 0;
            for (int i = 0; i < list_tracks.Items.Count; i++)
            {
                if (list_tracks.Items[i].SubItems[2].Text.Contains("Subtitle") &&
                    list_tracks.Items[i].SubItems[4].Text == FFBatch.Properties.Strings.yes)
                {
                    default_subs = default_subs + 1;
                }
            }

            if (default_subs > 1)
            {
                foreach (ListViewItem audio_item in list_tracks.Items)
                {
                    if (audio_item.SubItems[2].Text.Contains("Subtitle") &&
                        audio_item != list_tracks.SelectedItems[0])
                    {
                        audio_item.SubItems[4].Text = FFBatch.Properties.Strings.no;
                    }
                }
            }
            //End subtitle defaults
        }

        private void ct3_del_Click(object sender, EventArgs e)
        {
            foreach (ListViewItem elemento in list_tracks.SelectedItems)
            {
                list_tracks.Items.Remove(elemento);
                pic_encode_param.Image = null;
            }
            lbl_tr_n.Text = FFBatch.Properties.Strings.tracks + " " + list_tracks.Items.Count.ToString();
            //Review audio track defaults

            Boolean has_default = false;
            foreach (ListViewItem audio_item in list_tracks.Items)
            {
                if (audio_item.SubItems[3].Text.Contains("Audio") &&
                    audio_item.SubItems[5].Text == FFBatch.Properties.Strings.yes)
                {
                    has_default = true;
                    break;
                }
            }

            if (has_default == false)
            {
                foreach (ListViewItem audio_item in list_tracks.Items)
                {
                    if (audio_item.SubItems[3].Text.Contains("Audio"))
                    {
                        audio_item.SubItems[5].Text = FFBatch.Properties.Strings.yes;
                        return;
                    }
                }
            }
            //End review audio track defaults
        }

        private void button23_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            list_tracks.Items.Clear();
            txt_track_param.Text = String.Empty;
            pic_encode_param.Image = null;
            combo_item_lang_2.SelectedIndex = -1;
            txt_track_format.Text = String.Empty;
            lbl_tr_n.Text = FFBatch.Properties.Strings.tracks + " " + "0";
            txt_mux_type.Text = String.Empty;
        }

        private void list_tracks_DoubleClick(object sender, EventArgs e)
        {
            ct3_default.PerformClick();
        }

        private void list_tracks_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (list_tracks.SelectedIndices.Count > 0)
            {
                txt_track_param.Text = list_tracks.SelectedItems[0].SubItems[5].Text;
                combo_item_lang_2.Text = list_tracks.SelectedItems[0].SubItems[3].Text;

                // -c reminder
                if (list_tracks.SelectedItems[0].SubItems[2].Text.ToLower().Contains("video")) txt_mux_type.Text = "-c:v";
                if (list_tracks.SelectedItems[0].SubItems[2].Text.ToLower().Contains("audio")) txt_mux_type.Text = "-c:a";
                if (list_tracks.SelectedItems[0].SubItems[2].Text.ToLower().Contains("subtitle")) txt_mux_type.Text = "-c:s";

                //Track extension
                string ext_track = list_tracks.SelectedItems[0].SubItems[2].Text.ToLower();

                if (ext_track.Contains("h264")) txt_track_format.Text = "m4v";
                else if (ext_track.Contains("h265")) txt_track_format.Text = "mkv";
                else if (ext_track.Contains("hevc")) txt_track_format.Text = "mkv";
                else if (ext_track.Contains("webm")) txt_track_format.Text = "webm";
                else if (ext_track.Contains("rawvideo")) txt_track_format.Text = "avi";
                else if (ext_track.Contains("divx")) txt_track_format.Text = "avi";
                else if (ext_track.Contains("xvid")) txt_track_format.Text = "avi";
                else if (ext_track.Contains("mov")) txt_track_format.Text = "mov";
                else if (ext_track.Contains("aac")) txt_track_format.Text = "aac";
                else if (ext_track.Contains("m4a")) txt_track_format.Text = "m4a";
                else if (ext_track.Contains("ac3")) txt_track_format.Text = "ac3";
                else if (ext_track.Contains("mp3")) txt_track_format.Text = "mp3";
                else if (ext_track.Contains("pcm")) txt_track_format.Text = "wav";
                else if (ext_track.Contains("flac")) txt_track_format.Text = "flac";
                else if (ext_track.Contains("truehd")) txt_track_format.Text = "thd";
                else if (ext_track.Contains("dts")) txt_track_format.Text = "dts";
                else if (ext_track.Contains("vp7")) txt_track_format.Text = "webm";
                else if (ext_track.Contains("vp8")) txt_track_format.Text = "webm";
                else if (ext_track.Contains("vp9")) txt_track_format.Text = "webm";
                else if (ext_track.Contains("wma")) txt_track_format.Text = "wma";
                else if (ext_track.Contains("wvc1")) txt_track_format.Text = "wmv";
                else if (ext_track.Contains("vorbis")) txt_track_format.Text = "ogg";
                else if (ext_track.Contains("theora")) txt_track_format.Text = "ogv";
                else if (ext_track.Contains("mjpeg")) txt_track_format.Text = "jpg";
                else if (ext_track.Contains("subrip")) txt_track_format.Text = "srt";
                else if (ext_track.Contains("ass")) txt_track_format.Text = "ass";
                else txt_track_format.Text = "mkv";

                //End track extension

                if (list_tracks.SelectedItems[0].SubItems[5].Text == FFBatch.Properties.Strings.image_audio)
                {
                    pic_encode_param.Image = img_streams.Images[4];
                }
                else
                {
                    pic_encode_param.Image = img_streams.Images[list_tracks.SelectedItems[0].ImageIndex];
                }
            }
            else
            {
                txt_track_param.Text = String.Empty;
                combo_item_lang_2.Text = String.Empty;
                pic_encode_param.Image = null;
                txt_mux_type.Text = String.Empty;
                txt_track_format.Text = String.Empty;
            }

            if (list_tracks.SelectedIndices.Count > 1)
            {
                txt_track_format.Text = String.Empty;
                txt_mux_type.Text = String.Empty;
            }
        }

        private void btn_set_track_param_Click(object sender, EventArgs e)
        {
            ct3_encode_default.PerformClick();
        }

        private void ct3_encode_default_Click(object sender, EventArgs e)
        {
            if (list_tracks.SelectedIndices.Count > 0)
            {
                if (list_tracks.SelectedItems[0].SubItems[2].Text.Contains("Subtitle"))

                {
                    if (list_tracks.SelectedItems[0].SubItems[2].Text.Contains("dvd_subtitle") || (list_tracks.SelectedItems[0].SubItems[3].Text.Contains("hdmv_pgs_subtitle")))

                    {
                        list_tracks.SelectedItems[0].SubItems[5].Text = "copy";
                    }
                    else
                    {
                        def_mux_subs_enc = "copy";
                        list_tracks.SelectedItems[0].SubItems[5].Text = "copy"; ;
                    }
                }
                else
                {
                    list_tracks.SelectedItems[0].SubItems[5].Text = "copy";
                    if (list_tracks.SelectedItems[0].BackColor == Color.LightYellow)
                    {
                        list_tracks.SelectedItems[0].BackColor = Color.White;
                    }

                    def_mux_audio_enc = "copy";
                    def_mux_video_enc = "copy";
                }
                txt_track_param.Text = "copy";
            }
        }

        private void txt_track_param_TextChanged(object sender, EventArgs e)
        {
            if (list_tracks.SelectedIndices.Count > 0)
            {
                if (txt_track_param.Text != String.Empty && list_tracks.SelectedItems[0].SubItems[5].Text != FFBatch.Properties.Strings.image_audio)
                {
                    list_tracks.SelectedItems[0].SubItems[5].Text = txt_track_param.Text;
                }
            }

            if (txt_track_param.Text.Contains("-c:") || txt_track_param.Text.Contains("acodec") || txt_track_param.Text.Contains("acodec") || txt_track_param.Text.Contains("vcodec"))
            {
                MessageBox.Show(FFBatch.Properties.Strings.codec_params + " " + '\u0022' + "-c:v" + '\u0022' + ", " + '\u0022' + "-c:a" + '\u0022' + ",-acodec, -vcodec" + " " + FFBatch.Properties.Strings.not_requ, FFBatch.Properties.Strings.param_in, MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
        }

        private void combo_item_lang_2_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (list_tracks.Items.Count > 0)
            {
                foreach (ListViewItem item in list_tracks.Items)
                {
                    item.SubItems[3].Text = combo_item_lang_2.SelectedItem.ToString().Substring(combo_item_lang_2.SelectedItem.ToString().Length - 4, 3);
                }
            }
        }

        private void listView2_DragEnter(object sender, DragEventArgs e)
        {
            if (e.Data.GetDataPresent(DataFormats.FileDrop, false))
            {
                e.Effect = DragDropEffects.All;
                if (Properties.Settings.Default.dark_mode == false)

                {
                    using (var bmp1 = new Bitmap(listView2.ClientSize.Width, listView2.ClientSize.Height - 24))
                    {
                        using (var g1 = Graphics.FromImage(bmp1))
                        {
                            g1.DrawImage(pic_drag.Image, 0, 0, bmp1.Width, bmp1.Height);
                            listView2.BackgroundImage = bmp1;
                        }
                    }
                }
            }
            else e.Effect = DragDropEffects.None;
        }

        private void listView2_DragDrop(object sender, DragEventArgs e)
        {
            listView2.BackgroundImage = null;
            change_tab_1 = false;
            change_tab_2 = false;

            if (tabControl1.SelectedIndex == 1)
            {
                change_tab_1 = true;
            }
            else if (tabControl1.SelectedIndex == 2)
            {
                change_tab_2 = true;
            }

            tabControl1.SelectedIndex = 0;

            string[] file_drop = (string[])e.Data.GetData(DataFormats.FileDrop);

            List<string> files2 = new List<string>();

            int num_drop = 0;

            foreach (String dropped in file_drop)
            {
                if (File.Exists(dropped))
                {
                    files2.Add(dropped);
                    num_drop = files2.Count();
                }
                else
                {
                    if (Directory.Exists(dropped))
                    {
                        if (add_subfs == false)
                        {
                            foreach (String file in Directory.GetFiles(dropped))
                            {
                                if (!File.GetAttributes(file).HasFlag(FileAttributes.Hidden))
                                {
                                    files2.Add(file);
                                    num_drop = num_drop + 1;
                                }
                            }
                        }
                        else
                        {
                            try
                            {
                                foreach (string f in Directory.GetFiles(dropped, "*.*", System.IO.SearchOption.AllDirectories))
                                {
                                    if (!File.GetAttributes(f).HasFlag(FileAttributes.Hidden))
                                    {
                                        files2.Add(f);
                                        num_drop = num_drop + 1;
                                    }
                                }
                            }
                            catch (System.Exception excpt)
                            {
                                var a = MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message, FFBatch.Properties.Strings.error3, MessageBoxButtons.OK, MessageBoxIcon.Error);
                                return;
                            }
                        }
                    }
                }
            }

            if (num_drop >= 5000)
            {
                var a = MessageBox.Show(FFBatch.Properties.Strings.adding + " " + num_drop + " " + FFBatch.Properties.Strings.files_time, FFBatch.Properties.Strings.many_files, MessageBoxButtons.OKCancel, MessageBoxIcon.Question);
                if (a == DialogResult.Cancel)
                {
                    return;
                }
            }

            files_to_add = files2;
            canceled_file_adding = false;
            btn_cancel_add.Enabled = true;
            btn_cancel_add.Visible = true;
            btn_cancel_add.Refresh();
            BG_Files.RunWorkerAsync();
        }

        private void listView3_ColumnClick(object sender, ColumnClickEventArgs e)
        {
            if (e.Column == 0)
            {
                if (e.Column == lvwColumnSorter3.SortColumn)
                {
                    // Reverse the current sort direction for this column.
                    if (lvwColumnSorter3.Order == SortOrder.Ascending)
                    {
                        lvwColumnSorter3.Order = SortOrder.Descending;
                    }
                    else
                    {
                        lvwColumnSorter3.Order = SortOrder.Ascending;
                    }
                }
                else
                {
                    // Set the column number that is to be sorted; default to ascending.
                    lvwColumnSorter3.SortColumn = e.Column;
                    lvwColumnSorter3.Order = SortOrder.Ascending;
                }

                // Perform the sort with these new sort options.
                this.listView3.Sort();
            }
        }

        private void Combo_sub_lang_mux_SelectedIndexChanged(object sender, EventArgs e)
        {
            foreach (ListViewItem item in listView3.Items)
            {
                if (item.SubItems[1].Text.Contains(FFBatch.Properties.Strings.no_sub_file) == false)
                {
                    item.SubItems[2].Text = Combo_sub_lang_mux.SelectedItem.ToString().Substring(Combo_sub_lang_mux.SelectedItem.ToString().LastIndexOf("(") + 1, 3);
                }
            }
        }

        private void Combo_def_sub_mux_SelectedIndexChanged(object sender, EventArgs e)
        {
            foreach (ListViewItem item in listView3.Items)
            {
                if (item.SubItems[1].Text.Contains(FFBatch.Properties.Strings.no_sub_file) == false)
                {
                    item.SubItems[4].Text = Combo_def_sub_mux.SelectedItem.ToString();
                }
            }
        }

        private void ct3_default_enc_Click(object sender, EventArgs e)
        {
            if (list_tracks.SelectedIndices.Count > 0)
            {
                if (list_tracks.SelectedItems[0].SubItems[5].Text.Contains(FFBatch.Properties.Strings.image_audio))
                {
                    return;
                }

                if (list_tracks.SelectedItems[0].SubItems[2].Text.Contains("Subtitle"))

                {
                    def_mux_subs_enc = list_tracks.SelectedItems[0].SubItems[5].Text;
                }

                if (list_tracks.SelectedItems[0].SubItems[2].Text.Contains("Audio"))

                {
                    def_mux_audio_enc = list_tracks.SelectedItems[0].SubItems[5].Text;
                }

                if (list_tracks.SelectedItems[0].SubItems[2].Text.Contains("Video"))

                {
                    def_mux_video_enc = list_tracks.SelectedItems[0].SubItems[5].Text;
                }
            }
        }

        private void combo_def_und_lang_Click(object sender, EventArgs e)
        {
        }

        private void combo_def_und_lang_SelectedIndexChanged(object sender, EventArgs e)
        {
            def_lang_und_tracks = combo_def_und_lang.SelectedItem.ToString().Substring(combo_def_und_lang.SelectedItem.ToString().Length - 4, 3);

            ctm2.Close();
        }

        private void button24_Click_1(object sender, EventArgs e)
        {
            folderBrowserDialog1.ShowNewFolderButton = false;

            if (folderBrowserDialog1.ShowDialog() == DialogResult.OK)
            {
                txt_folder_subs.Text = folderBrowserDialog1.SelectedPath;
                txt_folder_subs.BackColor = txt_parameters.BackColor;
                listView3.Items.Clear();
                tabControl1.SelectedIndex = 0;
                tabControl1.SelectedIndex = 2;
            }
        }

        private void ctm4_Opening(object sender, CancelEventArgs e)
        {
            if (Properties.Settings.Default.dark_mode == true)
            {
                ctm4.BackColor = Color.FromArgb(255, 64, 64, 64);
                ctm4.ForeColor = Color.White;
            }
            else
            {
                ctm4.BackColor = SystemColors.InactiveBorder;
                ctm4.ForeColor = Control.DefaultForeColor;
            }

            if (listView3.SelectedIndices.Count == 0)
            {
                e.Cancel = true;
                return;
            }
            if (listView3.SelectedItems[0].SubItems[1].Text == FFBatch.Properties.Strings.no_sub2)
            {
                Combo_single_subs_lang.Enabled = false;
                ct4_conv.Enabled = false;
            }
            else
            {
                Combo_single_subs_lang.Enabled = true;
                ct4_conv.Enabled = true;
            }
        }

        private void ct4_browse_Click(object sender, EventArgs e)
        {
            openFileDialog2.Filter = FFBatch.Properties.Strings2.subtitles + " |*.srt;*.idx;*.ass| " + FFBatch.Properties.Strings.all_files + " " + "(*.*) | *.*";
            openFileDialog2.ShowDialog();
        }

        private void openFileDialog2_FileOk_1(object sender, CancelEventArgs e)
        {
            listView3.SelectedItems[0].SubItems[1].Text = openFileDialog2.FileName;
            listView3.SelectedItems[0].SubItems[3].Text = "und";

            var a = TextFileEncodingDetector.DetectTextFileEncoding(openFileDialog2.FileName);
            if (a != null)
            {
                String txt_enc = a.ToString().Replace("System.Text.", "");
                listView3.SelectedItems[0].SubItems[3].Text = txt_enc.Replace(FFBatch.Properties.Strings.Encoding, "");
            }
            else
            {
                listView3.SelectedItems[0].SubItems[3].Text = FFBatch.Properties.Strings.unknown;
            }

            listView3.SelectedItems[0].SubItems[5].Text = FFBatch.Properties.Strings.yes;
            listView3.SelectedItems[0].SubItems[5].Text = FFBatch.Properties.Strings.ready;
        }

        private void listView3_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (working == true)
            {
                listView3.SelectedIndices.Clear();
                return;
            }

            if (listView3.SelectedIndices.Count == 0)
            {
                Combo_sub_lang_mux.Text = "";
                Combo_def_sub_mux.Text = "";
            }
        }

        private void Combo_single_subs_lang_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (listView3.SelectedIndices.Count > 0)
            {
                foreach (ListViewItem item in listView3.SelectedItems)
                {
                    item.SubItems[2].Text = Combo_single_subs_lang.SelectedItem.ToString().Substring(Combo_single_subs_lang.SelectedItem.ToString().Length - 4, 3);
                }
                ctm4.Close();
            }
        }

        private void btn_sub_mux_Click(object sender, EventArgs e)
        {
            cancel_queue = false;

            if (!File.Exists(Path.Combine(Application.StartupPath, "ffmpeg.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_ffmpeg, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }
            if (check_ff_md5() == false)
            {
                Form25 frm25 = new Form25();
                frm25.ShowDialog();
                return;
            }

            notifyIcon1.Visible = true;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            foreach (ListViewItem file in listView3.Items)
            {
                if (!File.Exists(file.Text))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file_not_found + " " + file.Text, FFBatch.Properties.Strings.file_not_found2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }

            foreach (ListViewItem item in listView3.Items)
            {
                if (item.SubItems[1].Text == FFBatch.Properties.Strings.no_sub2)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.no_subs3, FFBatch.Properties.Strings.information, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }

            if (listView3.Items.Count == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.list_empty, FFBatch.Properties.Strings.information, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }

            String is_overw = txt_output_subs.Text + "\\" + Path.GetFileNameWithoutExtension(listView3.Items[0].Text) + "." + Combo_ext_sub_mux.SelectedItem.ToString();
            if (is_overw == listView3.Items[0].Text && chk_suffix.Checked == false)
            {
                MessageBox.Show(FFBatch.Properties.Strings.overw_not_en + " " + '\u0022' + FFBatch.Properties.Strings.ren_out + '\u0022' + " " + FFBatch.Properties.Strings.checkb, FFBatch.Properties.Strings.overw_not_all, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (Combo_ext_sub_mux.SelectedIndex == 1)
            {
                foreach (ListViewItem item in listView3.Items)
                {
                    if (item.SubItems[1].Text.ToLower().Contains("idx"))
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.vob_unsupport, FFBatch.Properties.Strings.container1, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }
                }
            }

            //Validate subs encoding
            Boolean non_eng = false;
            Boolean non_utf = false;

            foreach (ListViewItem item in listView3.Items)
            {
                if (item.SubItems[2].Text != "eng")
                {
                    non_eng = true;
                }
                if (item.SubItems[3].Text.Contains("UTF") == false && item.SubItems[3].Text.Contains("Unicode") == false)
                {
                    non_utf = true;
                }
            }

            if (non_utf == true && (Combo_sub_lang_mux.SelectedIndex != 0 || non_eng == true) && chk_burn.CheckState == CheckState.Unchecked)
            {
                var a = MessageBox.Show(FFBatch.Properties.Strings.non_utf1, FFBatch.Properties.Strings.warning, MessageBoxButtons.OKCancel, MessageBoxIcon.Warning);
                if (a == DialogResult.Cancel)
                {
                    return;
                }
            }

            if (chk_burn.CheckState == CheckState.Checked)
            {
                foreach (ListViewItem item in listView3.Items)
                {
                    if (item.SubItems[1].Text.Contains("[") || item.SubItems[1].Text.Contains("]") || ((item.Text.Contains("[") || item.Text.Contains("]")) && item.SubItems[1].Text.Contains(FFBatch.Properties.Strings.available)))
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.subs_wrong1, FFBatch.Properties.Strings.warning, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                        return;
                    }
                }
            }

            //Validated list, start processing

            txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + "00h:00m:00s";
            cancel_queue = false;
            Pg1.Value = 0;
            //pg_current.Value = 0;
            Disable_Controls();

            time_n_tasks = 0;
            timer_tasks.Start();

            //textBox4.Text = "0%";

            working = true;

            ListView list_proc = new ListView();
            foreach (ListViewItem item in listView3.Items)
            {
                list_proc.Items.Add((ListViewItem)item.Clone());
                item.BackColor = Color.White;
                item.SubItems[5].Text = FFBatch.Properties.Strings.queued;
            }

            Pg1.Maximum = list_proc.Items.Count;
            listView3.SelectedIndices.Clear();

            Double total_duration = 0;
            Double total_prog = 0;

            //Get total duration of files
            //Pending duration

            if (dur_ok == false)
            {
                list_pending_dur.Items.Clear();
                foreach (ListViewItem item in listView1.Items)
                {
                    list_pending_dur.Items.Add((ListViewItem)item.Clone());
                }
                BG_Dur.RunWorkerAsync();
                return;
            }

            total_duration = Convert.ToInt32(lbl_dur_list.Text.Substring(0, 2)) * 3600;
            total_duration = total_duration + Convert.ToInt32(lbl_dur_list.Text.Substring(4, 2)) * 60;
            total_duration = total_duration + Convert.ToInt32(lbl_dur_list.Text.Substring(8, 2));

            Pg1.Minimum = 0;
            Pg1.Maximum = 100;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";

            //End get total duration of files

            List<string> list_lines = new List<string>();
            String sub_mux_ext = Combo_ext_sub_mux.SelectedItem.ToString();
            String path_sub = txt_folder_subs.Text;

            String prev_subs_mp4 = String.Empty;
            Boolean mkv_selected = true;

            if (Combo_ext_sub_mux.SelectedIndex == 1)
            {
                prev_subs_mp4 = "-c:s mov_text ";
                mkv_selected = false;
            }
            else
            {
                prev_subs_mp4 = "-c:s copy ";
            }

            if (hard_sub == true)
            {
                prev_subs_mp4 = String.Empty;
            }

            String hw_decode = String.Empty;
            if (cb_hwdecode.SelectedItem.ToString() != "none")
            {
                hw_decode = "-hwaccel " + cb_hwdecode.SelectedItem.ToString();
            }

            //Save selected hw decoder

            String path2 = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_hw_dcd.ini";
            String txt_hw_dcd = cb_hwdecode.SelectedItem.ToString();
            if (txt_hw_dcd != "none")
            {
                File.WriteAllText(path2, txt_hw_dcd);
            }
            else
            {
                if (File.Exists(path2)) File.Delete(path2);
            }

            //End save hw decoder

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;
                /* run your code here */

                String remain_time = "0";

                //int list_index = 0;
                //foreach (ListViewItem file in list_proc.Items)
                for (int list_index = 0; list_index < list_proc.Items.Count; list_index++)
                {
                    String file = list_proc.Items[list_index].Text;
                    // Get specific tack list video duration
                    Process probe = new Process();
                    probe.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
                    String ffprobe_frames = " " + '\u0022' + "--Inform=General;%Duration/String3%" + '\u0022';
                    probe.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + file + '\u0022';

                    probe.StartInfo.RedirectStandardOutput = true;
                    probe.StartInfo.UseShellExecute = false;
                    probe.StartInfo.CreateNoWindow = true;
                    probe.EnableRaisingEvents = true;
                    probe.Start();

                    String duracion = probe.StandardOutput.ReadLine();

                    probe.WaitForExit();

                    if (duracion != null)
                    {
                        TimeSpan time;
                        if (TimeSpan.TryParse(duracion, out time))
                        {
                            durat_n = TimeSpan.Parse(duracion).TotalSeconds;
                        }
                        else durat_n = 0;
                    }
                    else
                    {
                        durat_n = 0;
                    }

                    //End duration

                    //Get number of source file subtitle tracks
                    Process ff_str = new Process();
                    ff_str.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");
                    ff_str.StartInfo.Arguments = " -i " + '\u0022' + file + '\u0022';
                    ff_str.StartInfo.RedirectStandardOutput = true;
                    ff_str.StartInfo.RedirectStandardError = true;
                    ff_str.StartInfo.UseShellExecute = false;
                    ff_str.StartInfo.CreateNoWindow = true;
                    ff_str.EnableRaisingEvents = true;
                    ff_str.Start();

                    String stream = "";
                    int source_subs = 0;
                    String is_default = String.Empty;

                    while (!ff_str.StandardError.EndOfStream)
                    {
                        stream = ff_str.StandardError.ReadLine();

                        if (stream.Contains("Stream #0:"))
                        {
                            if (stream.Contains("Subtitle"))
                            {
                                source_subs = source_subs + 1;
                                if (stream.Contains("mov_text") && mkv_selected == true)
                                {
                                    MessageBox.Show(FFBatch.Properties.Strings.source_mov_text, FFBatch.Properties.Strings.mp4_subs, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                    Enable_Controls();
                                    return;
                                }
                                else
                                {
                                    prev_subs_mp4 = "-c:s copy ";
                                }

                                if (list_proc.Items[list_index].SubItems[4].Text == FFBatch.Properties.Strings.yes)
                                {
                                    is_default = is_default + " -disposition:s:" + (source_subs + 1).ToString() + " 0";
                                }
                            }
                        }
                    }

                    //End get number of subtitle tracks

                    if (cancel_queue == true)
                    {
                        working = false;

                        //this.InvokeEx(f => f.Pg1.Value = 0);
                        //this.InvokeEx(f => f.pg_current.Value = 0);
                        this.InvokeEx(f => f.btn_seq.Enabled = true);
                        Enable_Controls();
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.task_abort, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                        return;
                    }

                    String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");
                    String fullPath = file;
                    String destino = "";

                    if (txt_output_subs.Text == ".\\FFBatch")
                    {
                        destino = file.Substring(0, fullPath.LastIndexOf('\\')) + "\\" + "FFBatch";
                    }
                    else
                    {
                        destino = txt_output_subs.Text;
                    }
                    String link_sub = list_proc.Items[list_index].SubItems[1].Text;

                    if (txt_folder_subs.Text == String.Empty)
                    {
                        if (list_proc.Items[list_index].SubItems[1].Text == FFBatch.Properties.Strings.srt_sub)
                        {
                            link_sub = file.Substring(0, file.LastIndexOf(".")) + ".srt";
                        }
                        else if (list_proc.Items[list_index].SubItems[1].Text == FFBatch.Properties.Strings.vob_sub)
                        {
                            link_sub = file.Substring(0, file.LastIndexOf(".")) + ".idx";
                        }
                        else if (list_proc.Items[list_index].SubItems[1].Text == FFBatch.Properties.Strings.as_sub)
                        {
                            link_sub = file.Substring(0, file.LastIndexOf(".")) + ".ass";
                        }
                    }
                    else
                    {
                        if (list_proc.Items[list_index].SubItems[1].Text == FFBatch.Properties.Strings.srt_sub)
                        {
                            link_sub = path_sub + "\\" + Path.GetFileNameWithoutExtension(file) + ".srt";
                        }
                        else if (list_proc.Items[list_index].SubItems[1].Text == FFBatch.Properties.Strings.vob_sub)
                        {
                            link_sub = path_sub + "\\" + Path.GetFileNameWithoutExtension(file) + ".idx";
                        }
                        else if (list_proc.Items[list_index].SubItems[1].Text == FFBatch.Properties.Strings.as_sub)
                        {
                            link_sub = path_sub + "\\" + Path.GetFileNameWithoutExtension(file) + ".ass";
                        }
                    }
                    if (list_proc.Items[list_index].SubItems[1].Text == FFBatch.Properties.Strings.no_sub2)
                    {
                        link_sub = String.Empty;
                    }

                    if (list_proc.Items[list_index].SubItems[4].Text == FFBatch.Properties.Strings.yes)
                    {
                        is_default = is_default + " -disposition:s:" + (source_subs).ToString() + " default";
                    }

                    String sub_enc = "-c:s copy";

                    if (sub_mux_ext == "mp4")
                    {
                        sub_enc = "-c:s mov_text";
                    }
                    if (mkv_selected == true)
                    {
                        sub_enc = prev_subs_mp4;
                    }
                    add_suffix = "";
                    if (chk_suffix.Checked == true)
                    {
                        add_suffix = "_FFB";
                    }

                    String AppParam = "";
                    if (hard_sub == true)
                    {
                        link_sub = link_sub.Replace("\\", "\\\\\\\\");
                        link_sub = link_sub.Replace(":", "\\\\" + ":" + "\\\\");

                        AppParam = hw_decode + " -i " + "" + '\u0022' + file + '\u0022' + " -vf subtitles=" + '\u0022' + link_sub + '\u0022' + " " + txt_hard_subs.Text + " -y " + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + add_suffix + "." + sub_mux_ext + '\u0022';
                    }
                    else
                    {
                        AppParam = hw_decode + " -i " + "" + '\u0022' + file + '\u0022' + " -sub_charenc UTF-8 " + "-i " + '\u0022' + link_sub + '\u0022' + " -map 0 -c:v copy -c:a copy " + prev_subs_mp4 + "-map 1:0 " + sub_enc + " " + "-metadata:s:s:" + source_subs + " language=" + list_proc.Items[list_index].SubItems[2].Text + " " + is_default + " -y " + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + add_suffix + "." + sub_mux_ext + '\u0022';
                    }

                    if (!Directory.Exists(destino))
                    {
                        try
                        {
                            Directory.CreateDirectory(destino);
                        }
                        catch (System.Exception excpt)
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                            Enable_Controls();
                            return;
                        }
                    }

                    process_glob.StartInfo.FileName = ffm;
                    process_glob.StartInfo.Arguments = AppParam + " -hide_banner";

                    valid_prog = false;
                    this.InvokeEx(f => f.listView3.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.processing);
                    //this.InvokeEx(f => f.pg_current.Value = 0);
                    //this.InvokeEx(f => f.pg_current.Refresh());

                    process_glob.StartInfo.RedirectStandardOutput = true;
                    process_glob.StartInfo.RedirectStandardError = true;
                    process_glob.StartInfo.RedirectStandardInput = true;
                    process_glob.StartInfo.UseShellExecute = false;
                    process_glob.StartInfo.CreateNoWindow = true;
                    process_glob.EnableRaisingEvents = true;
                    process_glob.Start();
                    System.Threading.Thread.Sleep(50);
                    combo_prio.Invoke(new MethodInvoker(delegate
                    {
                        if (combo_prio.SelectedIndex != 2)
                        {
                            Change_mem_prio();
                        }
                    }));

                    valid_prog = true;

                    String err_txt = "";
                    Double interval = 0;

                    while (!process_glob.StandardError.EndOfStream)
                    {
                        err_txt = process_glob.StandardError.ReadLine();
                        list_lines.Add(err_txt);

                        if (err_txt.Contains("time=") && err_txt.Contains("time=-") == false)
                        {
                            if (valid_prog == true)
                            {
                                int start_time_index = err_txt.IndexOf("time=") + 5;
                                Double sec_prog = TimeSpan.Parse(err_txt.Substring(start_time_index, 8)).TotalSeconds;
                                Double percent = (sec_prog * 100 / durat_n);

                                total_prog = total_prog + (sec_prog - interval);
                                interval = sec_prog;
                                int percent2 = Convert.ToInt32(percent);

                                Double percent_tot = total_prog * 100 / total_duration;
                                int percent_tot_2 = Convert.ToInt32(percent_tot);

                                if (percent_tot_2 <= 100)
                                {
                                    this.InvokeEx(f => f.Pg1.Value = percent_tot_2);
                                    this.InvokeEx(f => f.Pg1.Refresh());
                                    if (Math.Round(percent_tot, 1).ToString().Contains(".") || Math.Round(percent_tot, 1).ToString().Contains(","))
                                    {
                                        this.InvokeEx(f => f.Pg1.Text = Math.Round(percent_tot, 1).ToString() + "%");
                                    }
                                    else
                                    {
                                        this.InvokeEx(f => f.Pg1.Text = Math.Round(percent_tot, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0" + "%");
                                    }

                                    this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, percent_tot, Pg1.Maximum));
                                }
                                if (percent2 <= 100)
                                {
                                    int progg = Convert.ToInt16(percent2);

                                    if (Math.Round(percent, 1).ToString().Contains(".") || Math.Round(percent, 1).ToString().Contains(","))
                                    {
                                        this.InvokeEx(f => f.listView3.Items[list_index].SubItems[5].Text = Math.Round(percent, 1).ToString() + "%");
                                    }
                                    else
                                    {
                                        this.InvokeEx(f => f.listView3.Items[list_index].SubItems[5].Text = Math.Round(percent, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0" + "%");
                                    }
                                }
                                //Estimated remaining time

                                remain_time = err_txt.Substring(err_txt.LastIndexOf("speed=") + 6, err_txt.Length - err_txt.LastIndexOf("speed=") - 6);
                                remain_time = remain_time.Replace("x", String.Empty);
                                Double timing1 = 0;

                                if (System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator == ",")
                                {
                                    timing1 = Math.Round(Double.Parse(remain_time.Replace(".", ",")), 2);
                                }
                                else
                                {
                                    timing1 = Math.Round(Double.Parse(remain_time), 2);
                                }
                                Decimal timing = (decimal)timing1;
                                Decimal total_dur_dec = Convert.ToDecimal(total_duration);
                                Decimal total_prog_dec = Convert.ToDecimal(total_prog);

                                Decimal remain_secs = 0;
                                if (timing > 0)
                                {
                                    remain_secs = (decimal)(total_dur_dec - total_prog_dec) / timing;
                                }

                                if (remain_secs > 60)
                                {
                                    remain_secs = remain_secs + 60;
                                }
                                String remain_from_secs = "";

                                TimeSpan t = TimeSpan.FromSeconds(Convert.ToDouble(remain_secs));
                                remain_from_secs = string.Format("{0:D2}h:{1:D2}",
                                   t.Hours,
                                  t.Minutes);

                                if (remain_secs >= 3600)
                                {
                                    this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs + " " + FFBatch.Properties.Strings.minutes_abrev);
                                }

                                if (remain_secs < 3600 && remain_secs >= 600)
                                {
                                    this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes);
                                }
                                if (remain_secs < 600 && remain_secs >= 120)
                                {
                                    this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes);
                                }

                                if (remain_secs <= 59)
                                {
                                    this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Convert.ToInt16(remain_secs) + " " + FFBatch.Properties.Strings.seconds);
                                }

                                //End remaining time
                            }
                        }
                        //Read output, get progress
                    }
                    process_glob.WaitForExit();
                    process_glob.StartInfo.Arguments = String.Empty;

                    //this.InvokeEx(f => f.pg_current.Value = 100);
                    //this.InvokeEx(f => f.//textBox4.Text = "100%");
                    list_lines.Add("");
                    list_lines.Add("---------------------End of " + Path.GetFileName(file) + " log-------------------------------");
                    list_lines.Add("");

                    //this.InvokeEx(f => f.Pg1.Value = Pg1.Value + 1);
                    //this.InvokeEx(f => f.Pg1.Refresh());

                    Boolean single_error = false;

                    if (process_glob.ExitCode == 0)
                    {
                        this.InvokeEx(f => f.listView3.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.success);
                    }
                    else
                    {
                        listView3.Invoke(new MethodInvoker(delegate
                        {
                            if (listView3.Items[list_index].SubItems[1].Text == FFBatch.Properties.Strings.no_sub2)
                            {
                                this.InvokeEx(f => f.listView3.Items[list_index].SubItems[5].Text = "No Sub");
                            }
                            else
                            {
                                this.InvokeEx(f => f.listView3.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.error);
                            }
                        }));

                        if (listView3.Items.Count == 1)
                        {
                            single_error = true;
                            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                            MessageBox.Show(FFBatch.Properties.Strings.error_subx + " " + Environment.NewLine + Environment.NewLine + list_lines[list_lines.Count - 5].ToString() + list_lines[list_lines.Count - 4].ToString(), FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            cancel_queue = true;
                        }
                    }

                    //prog = (Pg1.Value * 100 / list_proc.Items.Count);

                    if (list_index == list_proc.Items.Count - 1)
                    {
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        this.InvokeEx(f => f.Pg1.Value = 100);
                        this.InvokeEx(f => f.Pg1.Text = "100%");
                        working = false;
                        //Save log
                        if (no_save_logs == false)
                        {
                            string[] array_err = list_lines.ToArray();
                            String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                            if (is_portable == true) path = port_path + "ff_batch_portable.log";

                            System.IO.StreamWriter SaveFile = new System.IO.StreamWriter(path);
                            SaveFile.WriteLine("FFmpeg log sesion: " + System.DateTime.Now);
                            SaveFile.WriteLine("-------------------------------");
                            foreach (String item in array_err)
                            {
                                SaveFile.WriteLine(item);
                            }
                            SaveFile.Close();

                            File.AppendAllText(path, "-----------------------");
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.end_log);
                            System.IO.FileInfo fileInfo = new System.IO.FileInfo(path);

                            var bytes = fileInfo.Length;

                            var kilobytes = (double)bytes / 1024;
                            var megabytes = kilobytes / 1024;
                            var gigabytes = megabytes / 1024;

                            //Format size view
                            String size = "";
                            String separator = ".";

                            if (bytes > 1000000000)
                            {
                                if (gigabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String gigas = gigabytes.ToString();
                                if (gigas.Length >= 5)
                                {
                                    gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                                    size = (gigas + " " + "GB");
                                }
                                else
                                {
                                    size = (gigas + " " + "GB");
                                }
                            }

                            if (bytes >= 1048576 && bytes <= 1000000000)
                            {
                                if (megabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }
                                String megas = megabytes.ToString();
                                if (megas.Length > 5)
                                {
                                    megas = megas.Substring(0, megas.LastIndexOf(separator));
                                    size = (megas + " " + "MB");
                                }
                                else
                                {
                                    size = (megas + " " + "MB");
                                }
                            }

                            if (bytes >= 1024 && bytes < 1048576)

                            {
                                if (kilobytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String kbs = kilobytes.ToString();
                                if (kbs.Length >= 5)
                                {
                                    kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                                    size = (kbs + " " + "KB");
                                }
                                else
                                {
                                    size = (kbs + " " + "KB");
                                }
                            }
                            if (bytes > -1 && bytes < 1024)
                            {
                                String bits = bytes.ToString();
                                size = (bits + " Bytes");
                            }

                            //End Format size view
                            TimeSpan t = TimeSpan.FromSeconds(time_n_tasks);
                            String tx_elapsed = string.Format("{0:D2}h:{1:D2}m:{2:D2}s",
                                t.Hours,
                                t.Minutes,
                                t.Seconds);
                            File.AppendAllText(path, Environment.NewLine);
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.total_time + " " + tx_elapsed);
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.log_size + " " + size);

                            //End save log
                        }
                        //Automatic shutdown check

                        if (chkshut.Checked && cancel_queue == false)
                        {
                            auto_shut();
                            return;
                        }
                        //End shutdown check
                        else
                        {
                            //End shutdown check
                            if (cancel_queue == false)
                            {
                                if (play_on_end == true) play_end();
                                if (Form.ActiveForm == null)
                                {
                                    notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.enc_comp;
                                    notifyIcon1.BalloonTipIcon = ToolTipIcon.Info;
                                    notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.enc_comp2;
                                    notifyIcon1.ShowBalloonTip(0);
                                }
                                if (chk_open_compl.Checked)
                                {
                                    if (Directory.GetFiles(destino).Length != 0 && single_error == false)
                                    {
                                        Process open_processed = new Process();
                                        open_processed.StartInfo.FileName = "explorer.exe";
                                        open_processed.StartInfo.Arguments = '\u0022' + destino + '\u0022';
                                        open_processed.Start();
                                    }
                                    else
                                    {
                                        if (Directory.Exists(destino) && Directory.GetFiles(destino).Length == 0)
                                        {
                                            System.IO.Directory.Delete(destino);
                                        }
                                    }
                                }
                            }
                            else
                            {
                                if (single_error == false)
                                {
                                    Pg1.Text = "100%";
                                    this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.aborted, MessageBoxButtons.OK, MessageBoxIcon.Error));
                                }
                            }
                        }
                    }
                }

                Enable_Controls();

                if (sub_mux_ext == "mp4")
                {
                    this.InvokeEx(f => f.Combo_def_sub_mux.Enabled = false);
                }
                else
                {
                    this.InvokeEx(f => f.Combo_def_sub_mux.Enabled = true);
                }
            }).Start();
        }

        private void textBox8_TextChanged(object sender, EventArgs e)
        {
        }

        private void button25_Click(object sender, EventArgs e)
        {
            folderBrowserDialog1.ShowNewFolderButton = true;

            if (folderBrowserDialog1.ShowDialog() == DialogResult.OK)
            {
                txt_output_subs.Text = folderBrowserDialog1.SelectedPath;
                txt_output_subs.BackColor = txt_parameters.BackColor;
            }
        }

        private void textBox8_DoubleClick(object sender, EventArgs e)
        {
            txt_output_subs.Text = ".\\FFBatch";
            txt_output_subs.BackColor = Control.DefaultBackColor;
        }

        private void button26_Click(object sender, EventArgs e)
        {
            btn_clear_list.PerformClick();
        }

        private void Combo_ext_sub_mux_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (Combo_ext_sub_mux.SelectedIndex == 1)
            {
                Combo_def_sub_mux.Enabled = false;
                Combo_def_sub_mux.SelectedIndex = 1;
                foreach (ListViewItem item in listView3.Items)
                {
                    if (item.SubItems[5].Text != "No Sub")
                    {
                        item.SubItems[5].Text = FFBatch.Properties.Strings.no;
                    }
                }
            }
            else
            {
                Combo_def_sub_mux.Enabled = true;
                Combo_def_sub_mux.SelectedIndex = 0;
                foreach (ListViewItem item in listView3.Items)
                {
                    if (item.SubItems[5].Text != "No Sub")
                    {
                        item.SubItems[5].Text = FFBatch.Properties.Strings.yes;
                    }
                }
            }
        }

        private void combo_ext_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (combo_ext.SelectedIndex == 0) return;
            if (combo_ext.SelectedIndex == 1)
            {
                if (list_tracks.Items.Count != 0 && list_tracks.Items[0].BackColor == Color.LightYellow)
                {
                    return;
                }
                else
                {
                    if (select_mp4 == false)
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.mp4_warn, FFBatch.Properties.Strings.mp4_warn2, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        select_mp4 = true;
                    }

                    //|| combo_ext.SelectedIndex == 2
                }
            }

            if (combo_ext.SelectedIndex == 2 && warn_mux_mov == false)
            {
                MessageBox.Show(FFBatch.Properties.Strings.mov_warn, FFBatch.Properties.Strings.mov_warn2, MessageBoxButtons.OK, MessageBoxIcon.Information);
                warn_mux_mov = true;
            }

            else if (combo_ext.SelectedIndex == 7 && warn_mux_webm == false)
            {
                MessageBox.Show(FFBatch.Properties.Strings.webm_warn, FFBatch.Properties.Strings.webm_warn2, MessageBoxButtons.OK, MessageBoxIcon.Information);
                warn_mux_webm = true;
            }
        }

        private void listView3_DragDrop(object sender, DragEventArgs e)
        {
            change_tab_1 = false;
            change_tab_2 = false;

            if (tabControl1.SelectedIndex == 1)
            {
                change_tab_1 = true;
            }
            else if (tabControl1.SelectedIndex == 2)
            {
                change_tab_2 = true;
            }

            tabControl1.SelectedIndex = 0;

            string[] file_drop = (string[])e.Data.GetData(DataFormats.FileDrop);

            List<string> files2 = new List<string>();

            int num_drop = 0;

            foreach (String dropped in file_drop)
            {
                if (File.Exists(dropped))
                {
                    files2.Add(dropped);
                    num_drop = files2.Count();
                }
                else
                {
                    if (Directory.Exists(dropped))
                    {
                        if (add_subfs == false)
                        {
                            foreach (String file in Directory.GetFiles(dropped))
                            {
                                if (!File.GetAttributes(file).HasFlag(FileAttributes.Hidden))
                                {
                                    files2.Add(file);
                                    num_drop = num_drop + 1;
                                }
                            }
                        }
                        else
                        {
                            try
                            {
                                foreach (string f in Directory.GetFiles(dropped, "*.*", System.IO.SearchOption.AllDirectories))
                                {
                                    if (!File.GetAttributes(f).HasFlag(FileAttributes.Hidden))
                                    {
                                        files2.Add(f);
                                        num_drop = num_drop + 1;
                                    }
                                }
                            }
                            catch (System.Exception excpt)
                            {
                                var a = MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message, FFBatch.Properties.Strings.error3, MessageBoxButtons.OK, MessageBoxIcon.Error);
                                return;
                            }
                        }
                    }
                }
            }

            if (num_drop >= 5000)
            {
                var a = MessageBox.Show(FFBatch.Properties.Strings.adding + " " + num_drop + " " + FFBatch.Properties.Strings.files_time, FFBatch.Properties.Strings.many_files, MessageBoxButtons.OKCancel, MessageBoxIcon.Question);
                if (a == DialogResult.Cancel)
                {
                    return;
                }
            }

            files_to_add = files2;
            canceled_file_adding = false;
            btn_cancel_add.Enabled = true;
            btn_cancel_add.Visible = true;
            btn_cancel_add.Refresh();
            BG_Files.RunWorkerAsync();
        }

        private void listView3_DragEnter(object sender, DragEventArgs e)
        {
            if (e.Data.GetDataPresent(DataFormats.FileDrop, false))
                e.Effect = DragDropEffects.All;
            else
                e.Effect = DragDropEffects.None;
        }

        private void listView3_DoubleClick(object sender, EventArgs e)
        {
            if (listView3.SelectedIndices.Count > 0)
            {
                if (listView3.SelectedItems[0].SubItems[1].Text == FFBatch.Properties.Strings.no_sub2)
                {
                    ct4_browse.PerformClick();
                }
            }
        }

        private void ct4_del_Click(object sender, EventArgs e)
        {
            if (listView3.SelectedIndices.Count > 0)
            {
                foreach (ListViewItem item in listView3.SelectedItems)
                {
                    listView3.Items.RemoveAt(item.Index);
                    foreach (ListViewItem item2 in listView1.Items)
                    {
                        if (item2.Text == item.Text)
                        {
                            listView1.Items.RemoveAt(item2.Index);
                        }
                    }
                    foreach (ListViewItem item3 in listView2.Items)
                    {
                        if (item3.Text == item.Text)
                        {
                            listView2.Items.RemoveAt(item3.Index);
                        }
                    }
                }

                lbl_items.Text = listView1.Items.Count + " " + FFBatch.Properties.Strings.files;

                Double new_dur = 0;
                Double current_dur = 0;

                for (int i = 0; i < listView1.Items.Count; i++)
                {
                    if (listView1.Items[i].SubItems[3].Text != FFBatch.Properties.Strings.n_a && listView1.Items[i].SubItems[3].Text != FFBatch.Properties.Strings.pending)
                    {
                        current_dur = TimeSpan.Parse(listView1.Items[i].SubItems[3].Text).TotalSeconds;
                        new_dur = new_dur + current_dur;
                    }
                }
                TimeSpan t = TimeSpan.FromSeconds(new_dur);
                String dur = string.Format("{0:D2}h:{1:D2}m:{2:D2}s.{3:D3}ms",
                             (int)t.TotalHours,
                             t.Minutes,
                             t.Seconds,
                             t.Milliseconds);
                lbl_dur_list.Text = dur.Substring(0, 11);
                calc_list_size();
            }
        }

        private void listView3_KeyUp(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Delete)
            {
                ct4_del.PerformClick();
            }
        }

        private void listView3_Click(object sender, EventArgs e)
        {
            if (working == true)
            {
                listView3.SelectedIndices.Clear();
                return;
            }
        }

        private void ct3_image_aud_Click(object sender, EventArgs e)
        {
            if (list_tracks.SelectedItems[0].SubItems[2].Text.Contains("Video"))
            {
                list_tracks.SelectedItems[0].BackColor = Color.LightYellow;
                list_tracks.SelectedItems[0].SubItems[5].Text = FFBatch.Properties.Strings.image_audio;

                String ext_image = Path.GetExtension(list_tracks.SelectedItems[0].Text);

                if (ext_image != ".jpg" && ext_image != ".jpeg" && ext_image != ".png" && ext_image != ".gif" && ext_image != ".bmp" && ext_image != ".tiff" && ext_image != ".psd")
                {
                    if (Extract_img == false)
                    {
                        if (ss_time_input.Text == "0:00:00")
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.first_frame, FFBatch.Properties.Strings.image_audio, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        }

                        Extract_img = true;
                    }
                }
                combo_ext.SelectedIndex = 1;
                pic_encode_param.Image = img_streams.Images[4];
            }
            else
            {
                MessageBox.Show(FFBatch.Properties.Strings.track_img, FFBatch.Properties.Strings.image_audio, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }
        }

        private void notifyIcon1_Click(object sender, EventArgs e)
        {
            this.TopMost = true;
            this.TopMost = false;
            this.BringToFront();
            this.Focus();
            notifyIcon1.Visible = false;
        }

        private void txt_pre_input_Click(object sender, EventArgs e)
        {
            txt_pre_input.BackColor = Color.LightYellow;
        }

        private void txt_pre_input_TextChanged(object sender, EventArgs e)
        {
            btn_fix_pre.Enabled = true;
            if (txt_pre_input.Text.Length == 0)
            {
                txt_pre_input.BackColor = txt_parameters.BackColor;
            }
            else
            {
                txt_pre_input.BackColor = Color.LightYellow;
                if (combo_presets.SelectedIndex == 0) btn_save_preset.Enabled = true;
            }
        }

        private void textBox2_Click(object sender, EventArgs e)
        {
            txt_format.BackColor = Color.LightYellow;
        }

        private void button27_Click(object sender, EventArgs e)
        {
            if (list_tracks.SelectedIndices.Count > 0)
            {
                if (list_tracks.SelectedItems[0].SubItems[5].Text.Contains(FFBatch.Properties.Strings.image_audio))
                {
                    return;
                }

                if (list_tracks.SelectedItems[0].SubItems[3].Text.Contains("Subtitle"))

                {
                    def_mux_subs_enc = list_tracks.SelectedItems[0].SubItems[5].Text;
                }

                if (list_tracks.SelectedItems[0].SubItems[3].Text.Contains("Audio"))

                {
                    def_mux_audio_enc = list_tracks.SelectedItems[0].SubItems[5].Text;
                }

                if (list_tracks.SelectedItems[0].SubItems[3].Text.Contains("Video"))

                {
                    def_mux_video_enc = list_tracks.SelectedItems[0].SubItems[5].Text;
                }
            }
        }

        private void txt_pre_input_Leave(object sender, EventArgs e)
        {
            if (txt_pre_input.Text == "")
            {
                txt_pre_input.BackColor = txt_parameters.BackColor;
            }
            else
            {
                txt_pre_input.BackColor = Color.LightYellow;
            }
        }

        private void button14_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            if (!File.Exists(Path.Combine(Application.StartupPath, "ffmpeg.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_ffmpeg, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            was_started.Text = btn_trim.Text;
            foreach (ListViewItem file in listView1.Items)
            {
                if (!File.Exists(file.SubItems[1].Text + "\\" + file.Text))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file_not_found + " " + file.Text, FFBatch.Properties.Strings.file_not_found2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }

            if (listView1.Items.Count == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.list_empty, FFBatch.Properties.Strings.no_files, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }
            if (txt_parameters.Text == "")
            {
                MessageBox.Show(FFBatch.Properties.Strings.params_bl, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (txt_ini.Text == "0:00:00.000" && txt_fin.Text == "0:00:00.000" && chk_trim2.Checked == false)
            {
                MessageBox.Show(FFBatch.Properties.Strings.trim_zero, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (txt_ini.BackColor == Color.Orange || txt_fin.BackColor == Color.Orange)
            {
                MessageBox.Show(FFBatch.Properties.Strings.time_wrong, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (TimeSpan.Parse(txt_ini.Text).TotalSeconds >= TimeSpan.Parse(txt_fin.Text).TotalSeconds && chk_trim2.Checked == false)
            {
                MessageBox.Show(FFBatch.Properties.Strings.end_short, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (listView1.Items.Count > 1 && chk_trim2.Checked == false)
            {
                var a = MessageBox.Show(FFBatch.Properties.Strings.trim1 + " " + FFBatch.Properties.Strings.all_files + " " + FFBatch.Properties.Strings.trim2, FFBatch.Properties.Strings.trim3, MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                if (a == DialogResult.No)
                {
                    return;
                }

                avoid_overw();
            }

            if (txt_format.Text == "")
            {
                var a = MessageBox.Show(FFBatch.Properties.Strings.format_no, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }

            //Check path is writable
            String destino1 = String.Empty;
            Boolean rel_path = false;
            String element1 = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text;
            if (txt_path_main.Text.Contains(".\\"))
            {
                destino1 = element1.Substring(0, element1.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
                rel_path = true;
            }
            else
            {
                if (checkBox1.CheckState == CheckState.Checked)
                {
                    String pre_dest = Path.GetDirectoryName(element1);
                    destino1 = Path.Combine(txt_path_main.Text, pre_dest.Substring(3, pre_dest.Length - 3));
                    rel_path = true;
                }
                else
                {
                    destino1 = txt_path_main.Text;
                }
            }

            try
            {
                if (rel_path == true)
                {
                    Directory.CreateDirectory(destino1);
                    System.Threading.Thread.Sleep(10);
                }
                else
                {
                    if (!Directory.Exists(destino1)) Directory.CreateDirectory(destino1);
                    File.WriteAllText(destino1 + "\\" + "FFBatch_test.txt", "FFBatch_test");
                    System.Threading.Thread.Sleep(10);
                    File.Delete(destino1 + "\\" + "FFBatch_test.txt");
                }
            }
            catch (System.Exception excpt)
            {
                MessageBox.Show(FFBatch.Properties.Strings.write_error1 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            //End path is writable

            //Pending duration

            if (dur_ok == false)
            {
                list_pending_dur.Items.Clear();
                foreach (ListViewItem item in listView1.Items)
                {
                    list_pending_dur.Items.Add((ListViewItem)item.Clone());
                }
                BG_Dur.RunWorkerAsync();
                return;
            }

            //Check queued items

            if (warn_success_items == true)
            {
                Boolean no_queued = true;
                Boolean has_complete = false;
                foreach (ListViewItem item in listView1.Items)
                {
                    if (item.SubItems[5].Text == FFBatch.Properties.Strings.queued)
                    {
                        no_queued = false;
                    }
                    if (item.SubItems[5].Text == FFBatch.Properties.Strings.success || item.SubItems[5].Text == FFBatch.Properties.Strings.replaced)
                    {
                        has_complete = true;
                    }
                }

                if (no_queued == true && listView1.Items.Count > 1)
                {
                    var a = MessageBox.Show(FFBatch.Properties.Strings.items_q + " " + '\u0022' + FFBatch.Properties.Strings.queued + '\u0022' + ". " + FFBatch.Properties.Strings.all_files + " " + FFBatch.Properties.Strings.already_proc, FFBatch.Properties.Strings.not_queued, MessageBoxButtons.OKCancel, MessageBoxIcon.Question);
                    if (a == DialogResult.Cancel) return;
                }

                if (no_queued == false && has_complete == true)
                {
                    var a = MessageBox.Show(FFBatch.Properties.Strings.already_encoded + " " + '\u0022' + FFBatch.Properties.Strings.queued + '\u0022' + FFBatch.Properties.Strings.continu, FFBatch.Properties.Strings.some_q, MessageBoxButtons.OKCancel, MessageBoxIcon.Question);
                    if (a == DialogResult.Cancel) return;
                }
                //End check queued items
            }

            listBox4.Items.Clear();
            Disable_Controls();
            txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + "00h:00m:00s";

            String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");

            Pg1.Value = 0;
            Pg1.Maximum = listView1.Items.Count;

            foreach (ListViewItem file in listView1.Items)
            {
                if (TimeSpan.Parse(file.SubItems[3].Text).TotalSeconds < (TimeSpan.Parse(txt_fin.Text).TotalSeconds - TimeSpan.Parse(txt_ini.Text).TotalSeconds))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.trim_ex, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    foreach (Control p in groupBox1.Controls)
                    {
                        p.Enabled = true;
                    }

                    Enable_Controls();
                    return;
                }

                if (TimeSpan.Parse(file.SubItems[3].Text).TotalSeconds == (TimeSpan.Parse(txt_fin.Text).TotalSeconds - TimeSpan.Parse(txt_ini.Text).TotalSeconds))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.trim_z, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    foreach (Control p in groupBox1.Controls)
                    {
                        p.Enabled = true;
                    }

                    Enable_Controls();
                    return;
                }

                if (TimeSpan.Parse(file.SubItems[3].Text).TotalSeconds < TimeSpan.Parse(txt_fin.Text).TotalSeconds)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.trim_f, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    foreach (Control p in groupBox1.Controls)
                    {
                        p.Enabled = true;
                    }

                    Enable_Controls();
                    return;
                }

                if (TimeSpan.Parse(file.SubItems[3].Text).TotalSeconds < TimeSpan.Parse(txt_ini.Text).TotalSeconds)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.trim_i, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    foreach (Control p in groupBox1.Controls)
                    {
                        p.Enabled = true;
                    }

                    Enable_Controls();
                    return;
                }
            }

            if (avoid_overwriting == true && txt_path_main.Text.Contains(".\\") == false && txt_path_main.Text.Length < 4 && checkBox1.CheckState != CheckState.Checked)
            {
                avoid_overwriting = false;
                DialogResult a2 = MessageBox.Show(FFBatch.Properties.Strings.multiple_folders + " " + '\u0022' + FFBatch.Properties.Strings.recreate_path + '\u0022' + " " + Properties.Strings2.avoid_overw + ". " + Properties.Strings.continu, Properties.Strings.warning, MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2);
                if (a2 == DialogResult.No) return;
            }

            //Validated list, start processing
            if (listView1.SelectedIndices.Count == 0)
            {
                listView1.Items[0].Selected = true;
                listView1.Items[0].Focused = true;
                listView1.Focus();
            }
            //Try preset
            String sel_test = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
            this.Cursor = Cursors.WaitCursor;

            String file_prueba = "";

            file_prueba = sel_test;
            String fichero = Path.GetFileName(file_prueba);

            String destino_test = Path.Combine(Path.GetTempPath(), "FFBatch_test");
            if (!Directory.Exists(destino_test))
            {
                try
                {
                    Directory.CreateDirectory(destino_test);
                }
                catch (System.Exception excpt)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    this.Cursor = Cursors.Arrow;
                    return;
                }
            }
            if (chk_try.CheckState == CheckState.Unchecked)
            {
                Process consola_pre = new Process();
                consola_pre.StartInfo.FileName = "ffmpeg.exe";
                consola_pre.StartInfo.Arguments = " -i " + "" + '\u0022' + file_prueba + '\u0022' + "" + " " + "-ss 0 -t 1 " + " -y " + txt_parameters.Text + " " + '\u0022' + destino_test + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + txt_format.Text + '\u0022';
                consola_pre.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;
                consola_pre.Start();
                System.Threading.Thread.Sleep(50);
                combo_prio.Invoke(new MethodInvoker(delegate
                {
                    if (combo_prio.SelectedIndex != 2)
                    {
                        Change_mem_prio();
                    }
                }));

                consola_pre.WaitForExit();

                if (consola_pre.ExitCode != 0)
                {
                    Enable_Controls();
                    this.Cursor = Cursors.Arrow;
                    MessageBox.Show(FFBatch.Properties.Strings.test_err, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    this.Cursor = Cursors.Arrow;

                    if (Directory.GetFiles(destino_test).Length == 0)
                    {
                        System.IO.Directory.Delete(destino_test);
                    }

                    return;
                }
            }
            //END try preset

            for (int i = 0; i < listView1.Items.Count; i++)
            {
                for (int j = i + 1; j < listView1.Items.Count; j++)
                {
                    String elem = listView1.Items[i].SubItems[1].Text + "\\" + listView1.Items[i].Text;
                    String elem2 = listView1.Items[j].SubItems[1].Text + "\\" + listView1.Items[j].Text;
                    if (Path.GetFileNameWithoutExtension(elem) == Path.GetFileNameWithoutExtension(elem2) && (checkBox1.CheckState != CheckState.Checked))
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.the_files + " " + Environment.NewLine + Environment.NewLine + Path.GetFileName(listView1.Items[i].Text) + Environment.NewLine + Path.GetFileName(listView1.Items[j].Text) + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.same_out + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.remove_inv, FFBatch.Properties.Strings.same_name, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                        Enable_Controls();
                        this.Cursor = Cursors.Arrow;
                        return;
                    }
                }
            }

            this.Cursor = Cursors.Arrow;
            cancel_queue = false;
            Pg1.Value = 0;
            //pg_current.Value = 0;
            Disable_Controls();
            //textBox4.Text = "0%";

            working = true;
            notifyIcon1.Visible = true;

            ListView list_proc = new ListView();
            foreach (ListViewItem item in listView1.Items)
            {
                list_proc.Items.Add((ListViewItem)item.Clone());
                item.SubItems[5].Text = FFBatch.Properties.Strings.queued;
                //item.UseItemStyleForSubItems = true;
                //item.BackColor = Color.White;
                //item.SubItems[5].BackColor = Color.White;
            }

            Pg1.Maximum = list_proc.Items.Count;
            listView1.SelectedIndices.Clear();

            Double dura2 = 0;
            time_n_tasks = 0;
            timer_tasks.Start();

            List<string> list_lines = new List<string>();
            //End new pre-thread code
            process_glob.StartInfo.Arguments = String.Empty;

            //Begin new thread code for trimming
            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;
                String remain_time = "";

                //foreach (ListViewItem file in list_proc.Items)
                for (int list_index = 0; list_index < listView1.Items.Count; list_index++)
                {
                    String file = list_proc.Items[list_index].SubItems[1].Text + "\\" + list_proc.Items[list_index].Text;

                    if (cancel_queue == true)
                    {
                        working = false;
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        this.InvokeEx(f => f.Pg1.Value = 0);
                        //this.InvokeEx(f => f.pg_current.Value = 0);
                        this.InvokeEx(f => f.btn_seq.Enabled = true);
                        Enable_Controls();
                        MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.task_abort, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                        return;
                    }

                    int prog = (Pg1.Value * 100 / list_proc.Items.Count);
                    this.InvokeEx(f => f.Pg1.Text = (prog.ToString() + "%"));

                    this.InvokeEx(f => dura2 = TimeSpan.Parse(listView1.Items[list_index].SubItems[3].Text).TotalSeconds);

                    String ffm2 = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");
                    String fullPath = file;

                    //Begin Shifting
                    String shifting = "";
                    if (chk_shift.Checked)
                    {
                        shifting = " -itsoffset " + Num_Shift.Value.ToString().Replace(",", ".") + " -i " + '\u0022' + file + '\u0022' + " -map 1:v -map 0:a ";
                    }

                    //End Shifting

                    //Change Volume
                    String change_vol = "";
                    if (chk_vol.Checked)
                    {
                        change_vol = "-filter:a " + '\u0022' + "volume=" + vol_ch.Value.ToString() + "dB " + '\u0022' + " ";
                    }
                    //End change volume

                    String destino = "";
                    if (txt_path_main.Text.Contains(".\\"))
                    {
                        destino = file.Substring(0, fullPath.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
                    }
                    else
                    {
                        if (checkBox1.CheckState == CheckState.Checked)
                        {
                            String pre_dest = Path.GetDirectoryName(file);
                            destino = Path.Combine(txt_path_main.Text, pre_dest.Substring(3, pre_dest.Length - 3));
                        }
                        else
                        {
                            destino = txt_path_main.Text;
                        }
                    }

                    add_suffix = "";
                    if (chk_suffix.Checked == true && txt_suffix.Text != String.Empty)
                    {
                        add_suffix = txt_suffix.Text;
                    }

                    String ext_output1 = txt_format.Text;
                    if (txt_format.Text == String.Empty)
                    {
                        ext_output1 = Path.GetExtension(file);
                    }
                    else
                    {
                        ext_output1 = "." + txt_format.Text;
                    }
                    String AppParam = String.Empty;

                    if (chk_trim2.Checked == false)
                    {
                        AppParam = " -i " + "" + '\u0022' + file + '\u0022' + shifting + " " + " -ss " + txt_ini.Text + " -to " + txt_fin.Text + " -y " + txt_parameters.Text + " " + change_vol + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + add_suffix + ext_output1 + '\u0022';
                    }
                    else
                    {
                        Process tmp = new Process();
                        tmp.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
                        String ffprobe_frames = " " + '\u0022' + "--Inform=General;%Duration/String3%" + '\u0022';
                        tmp.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + file + '\u0022';

                        tmp.StartInfo.RedirectStandardOutput = true;
                        tmp.StartInfo.UseShellExecute = false;
                        tmp.StartInfo.CreateNoWindow = true;
                        tmp.EnableRaisingEvents = true;
                        tmp.Start();

                        String duracion = tmp.StandardOutput.ReadToEnd();
                        tmp.WaitForExit();

                        if (duracion == null) duracion = "0";
                        TimeSpan time;
                        if (!TimeSpan.TryParse(duracion, out time))
                        {
                            duracion = "0";
                        }
                        String trim_end_2 = duracion.Substring(0, duracion.LastIndexOf("0"));
                        DateTime init_trim = Convert.ToDateTime(txt_ini.Text);
                        DateTime final_trim = Convert.ToDateTime(txt_fin.Text);
                        DateTime dur_date = Convert.ToDateTime(trim_end_2);
                        var trim_to = dur_date.Subtract(final_trim);
                        if (txt_fin.Text == "0:00:00.000" || txt_fin.Text == "00:00:00.000")
                        {
                            AppParam = " -ss " + txt_ini.Text + " -i " + "" + '\u0022' + file + '\u0022' + shifting + " -y " + txt_parameters.Text + " " + change_vol + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + add_suffix + ext_output1 + '\u0022';
                        }
                        else
                        {
                            AppParam = " -i " + "" + '\u0022' + file + '\u0022' + shifting + " " + " -ss " + txt_ini.Text + " -to " + trim_to + " -y " + txt_parameters.Text + " " + change_vol + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + add_suffix + ext_output1 + '\u0022';
                        }
                    }

                    if (!Directory.Exists(destino))
                    {
                        Directory.CreateDirectory(destino);
                    }
                    process_glob.StartInfo.FileName = ffm2;
                    process_glob.StartInfo.Arguments = AppParam;
                    process_glob.StartInfo.RedirectStandardOutput = true;
                    process_glob.StartInfo.RedirectStandardInput = true;
                    process_glob.StartInfo.RedirectStandardError = true;
                    process_glob.StartInfo.UseShellExecute = false;
                    process_glob.StartInfo.CreateNoWindow = true;
                    process_glob.EnableRaisingEvents = true;

                    valid_prog = false;
                    this.InvokeEx(f => f.listView1.Items[Pg1.Value].SubItems[5].Text = FFBatch.Properties.Strings.processing);

                    process_glob.Start();
                    System.Threading.Thread.Sleep(50);

                    combo_prio.Invoke(new MethodInvoker(delegate
                    {
                        if (combo_prio.SelectedIndex != 2)
                        {
                            Change_mem_prio();
                        }
                    }));

                    this.InvokeEx(f => validate_duration = listView1.Items[list_index].SubItems[3].Text);
                    if (validate_duration != FFBatch.Properties.Strings.n_a && validate_duration != "0:00:00" && validate_duration != "00:00:00" && validate_duration != FFBatch.Properties.Strings.pending)
                    {
                        valid_prog = true;
                    }
                    String err_txt = "";

                    while (!process_glob.StandardError.EndOfStream)
                    {
                        err_txt = process_glob.StandardError.ReadLine();
                        list_lines.Add(err_txt);
                        try
                        {
                            if (err_txt.Contains("time=") && err_txt.Contains("time=-") == false)
                            {
                                if (valid_prog == true)
                                {
                                    this.InvokeEx(f => durat_n = TimeSpan.Parse(listView1.Items[list_index].SubItems[3].Text).TotalSeconds);
                                    durat_n = durat_n - Convert.ToDouble(TimeSpan.Parse(txt_fin.Text).TotalSeconds - Convert.ToDouble(TimeSpan.Parse(txt_ini.Text).TotalSeconds));
                                    int start_time_index = err_txt.IndexOf("time=") + 5;
                                    Double sec_prog = TimeSpan.Parse(err_txt.Substring(start_time_index, 8)).TotalSeconds;
                                    Double percent = (sec_prog * 100 / durat_n);
                                    int percent2 = Convert.ToInt32(percent);
                                    if (percent2 <= 100)
                                    {
                                    }
                                    //Estimated remaining time

                                    remain_time = err_txt.Substring(err_txt.LastIndexOf("speed=") + 6, err_txt.Length - err_txt.LastIndexOf("speed=") - 6);
                                    remain_time = remain_time.Replace("x", String.Empty);
                                    Double timing1 = 0;

                                    if (System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator == ",")
                                    {
                                        timing1 = Math.Round(Double.Parse(remain_time.Replace(".", ",")), 2);
                                    }
                                    else
                                    {
                                        timing1 = Math.Round(Double.Parse(remain_time), 2);
                                    }
                                    Decimal timing = (decimal)timing1;
                                    Decimal total_dur_dec = Convert.ToDecimal(durat_n);
                                    Decimal total_prog_dec = Convert.ToDecimal(sec_prog);
                                    Decimal remain_secs = 0;
                                    if (timing > 0)
                                    {
                                        remain_secs = (decimal)(total_dur_dec - total_prog_dec) / timing;
                                    }

                                    if (remain_secs > 60)
                                    {
                                        remain_secs = remain_secs + 60;
                                    }
                                    String remain_from_secs = "";

                                    TimeSpan t = TimeSpan.FromSeconds(Convert.ToDouble(remain_secs));
                                    remain_from_secs = string.Format("{0:D2}h:{1:D2}",
                                       t.Hours,
                                      t.Minutes);

                                    if (remain_secs >= 3600)
                                    {
                                        //this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " "  + remain_from_secs + " " + FFBatch.Properties.Strings.minutes_abrev);
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " ");
                                    }

                                    if (remain_secs < 3600 && remain_secs >= 600)
                                    {
                                        //this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " "  + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes);
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " ");
                                    }
                                    if (remain_secs < 600 && remain_secs >= 120)
                                    {
                                        //this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " "  + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes);
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " ");
                                    }

                                    if (remain_secs <= 59)
                                    {
                                        //this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " "  + Convert.ToInt16(remain_secs) + " " + FFBatch.Properties.Strings.seconds);
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " ");
                                    }
                                    if (remain_secs <= 0)
                                    {
                                        //this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.about_finish);
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " ");
                                    }

                                    //End remaining time
                                }
                            }
                        }
                        catch { }

                        //Read output, get progress
                    }
                    process_glob.WaitForExit();

                    //this.InvokeEx(f => f.pg_current.Value = 100);
                    //this.InvokeEx(f => f.//textBox4.Text = "100%");
                    list_lines.Add("");
                    list_lines.Add("---------------------End of " + Path.GetFileName(file) + " log-------------------------------");
                    list_lines.Add("");

                    this.InvokeEx(f => f.Pg1.Value = Pg1.Value + 1);
                    this.InvokeEx(f => f.Pg1.Refresh());

                    process_glob.StartInfo.Arguments = String.Empty;

                    if (process_glob.ExitCode == 0)
                    {
                        this.InvokeEx(f => f.listView1.Items[Pg1.Value - 1].SubItems[5].Text = FFBatch.Properties.Strings.success);
                        this.InvokeEx(f => f.listView1.Items[Pg1.Value - 1].EnsureVisible());
                    }
                    else
                    {
                        this.InvokeEx(f => f.listView1.Items[Pg1.Value - 1].SubItems[5].Text = FFBatch.Properties.Strings.error);
                        this.InvokeEx(f => f.listView1.Items[Pg1.Value - 1].BackColor = Color.PaleGoldenrod);
                    }

                    prog = (Pg1.Value * 100 / list_proc.Items.Count);
                    this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, Pg1.Value, Pg1.Maximum));

                    this.InvokeEx(f => f.Pg1.Text = (prog.ToString() + "%"));

                    if (Pg1.Value == Pg1.Maximum)
                    {
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        working = false;
                        //Save log
                        if (no_save_logs == false)
                        {
                            string[] array_err = list_lines.ToArray();
                            String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                            if (is_portable == true) path = port_path + "ff_batch_portable.log";

                            System.IO.StreamWriter SaveFile = new System.IO.StreamWriter(path);
                            SaveFile.WriteLine("FFmpeg log sesion: " + System.DateTime.Now);
                            SaveFile.WriteLine("-------------------------------");
                            foreach (String item in array_err)
                            {
                                SaveFile.WriteLine(item);
                            }
                            SaveFile.Close();

                            File.AppendAllText(path, "-----------------------");
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.end_log);
                            System.IO.FileInfo fileInfo = new System.IO.FileInfo(path);

                            var bytes = fileInfo.Length;

                            var kilobytes = (double)bytes / 1024;
                            var megabytes = kilobytes / 1024;
                            var gigabytes = megabytes / 1024;

                            //Format size view
                            String size = "";
                            String separator = ".";

                            if (bytes > 1000000000)
                            {
                                if (gigabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String gigas = gigabytes.ToString();
                                if (gigas.Length >= 5)
                                {
                                    gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                                    size = (gigas + " " + "GB");
                                }
                                else
                                {
                                    size = (gigas + " " + "GB");
                                }
                            }

                            if (bytes >= 1048576 && bytes <= 1000000000)
                            {
                                if (megabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }
                                String megas = megabytes.ToString();
                                if (megas.Length > 5)
                                {
                                    megas = megas.Substring(0, megas.LastIndexOf(separator));
                                    size = (megas + " " + "MB");
                                }
                                else
                                {
                                    size = (megas + " " + "MB");
                                }
                            }

                            if (bytes >= 1024 && bytes < 1048576)

                            {
                                if (kilobytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String kbs = kilobytes.ToString();
                                if (kbs.Length >= 5)
                                {
                                    kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                                    size = (kbs + " " + "KB");
                                }
                                else
                                {
                                    size = (kbs + " " + "KB");
                                }
                            }
                            if (bytes > -1 && bytes < 1024)
                            {
                                String bits = bytes.ToString();
                                size = (bits + " Bytes");
                            }

                            //End Format size view
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.log_size + " " + size);

                            //End save log
                        }

                        //Automatic shutdown check
                        if (chkshut.Checked && cancel_queue == false)
                        {
                            try
                            {
                                String borrar_s = destino_test + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + txt_format.Text;

                                foreach (string file_s in Directory.GetFiles(destino_test))
                                {
                                    File.Delete(file_s);
                                }
                                System.IO.Directory.Delete(destino_test);
                            }
                            catch { }

                            auto_shut();
                            return;
                        }
                        //End shutdown check
                        else
                        {
                            if (cancel_queue == false)
                            {
                                if (play_on_end == true) play_end();
                                if (Form.ActiveForm == null)
                                {
                                    notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.trim_compl;
                                    notifyIcon1.BalloonTipIcon = ToolTipIcon.Info;
                                    notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.trim_comp2;
                                    notifyIcon1.ShowBalloonTip(1000);
                                }

                                if (chk_open_compl.Checked)
                                {
                                    if (Directory.GetFiles(destino).Length != 0)
                                    {
                                        Process open_processed = new Process();
                                        open_processed.StartInfo.FileName = "explorer.exe";
                                        open_processed.StartInfo.Arguments = '\u0022' + destino + '\u0022';
                                        open_processed.Start();
                                    }
                                    else
                                    {
                                        if (Directory.Exists(destino))
                                        {
                                            System.IO.Directory.Delete(destino);
                                        }
                                    }
                                }
                            }
                            else
                            {
                                this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                                this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.aborted, MessageBoxButtons.OK, MessageBoxIcon.Error));
                            }
                        }
                    }
                }
                Enable_Controls();

                String borrar = destino_test + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + txt_format.Text;

                foreach (string file in Directory.GetFiles(destino_test))
                {
                    File.Delete(file);
                }
                System.IO.Directory.Delete(destino_test);
            }).Start();
        }

        private void timer_tasks_Tick(object sender, EventArgs e)
        {
            if (paused == true) return;

            time_n_tasks = time_n_tasks + 1;

            TimeSpan t9 = TimeSpan.FromSeconds(time_n_tasks);
            String tx_elapsed1 = string.Format("{0:D2}h:{1:D2}m:{2:D2}s",
                t9.Hours,
                t9.Minutes,
                t9.Seconds);
            lbl_elapsed.Text = FFBatch.Properties.Strings.time_elapsed + " " + tx_elapsed1;

            if (total_time == true)
            {
                TimeSpan t = TimeSpan.FromSeconds(time_n_tasks);
                String tx_elapsed = string.Format("{0:D2}h:{1:D2}m:{2:D2}s",
                    t.Hours,
                    t.Minutes,
                    t.Seconds);
                txt_remain.Text = FFBatch.Properties.Strings.time_elapsed + " " + tx_elapsed;
            }
        }

        private void ss_time_input_TextChanged(object sender, EventArgs e)
        {
            if (ss_time_input.Text == "0:00:00.000")
            {
                ss_time_input.BackColor = groupBox1.BackColor;
                return;
            }

            DateTime time;
            if (!DateTime.TryParse(ss_time_input.Text, out time))
            {
                ss_time_input.BackColor = Color.Orange;
            }
            else
            {
                ss_time_input.BackColor = Color.White;
            }

            if (ss_time_input.Text.Length > 14)
            {
                MessageBox.Show(FFBatch.Properties.Strings.time_bad, FFBatch.Properties.Strings.time_err, MessageBoxButtons.OK, MessageBoxIcon.Warning);
            }
        }

        private void ss_time_input_Leave(object sender, EventArgs e)
        {
            if (ss_time_input.Text == "0:00:00.000")
            {
                ss_time_input.BackColor = Control.DefaultBackColor;
                return;
            }

            DateTime time2;
            if (!DateTime.TryParse(ss_time_input.Text, out time2))
            {
                ss_time_input.BackColor = Color.Orange;
            }
            else
            {
                ss_time_input.BackColor = Color.White;
            }
        }

        private void ss_time_input_DoubleClick(object sender, EventArgs e)
        {
            ss_time_input.Text = "0:00:00.000";
        }

        private void btn_add_tracks_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            if (listView2.Items.Count == 1)
            {
                listView2.Items[0].Selected = true;
            }
            if (listView2.SelectedItems.Count > 1)
            {
                MessageBox.Show(FFBatch.Properties.Strings2.one_track, FFBatch.Properties.Strings.information, MessageBoxButtons.OK);
                return;
            }
            ct2_all.PerformClick();
            tracks_background();

            if (listView2.Items.Count > 1 && listView2.SelectedIndices.Count == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_file_str, FFBatch.Properties.Strings.no_file, MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
        }

        private void calc_list_size()
        {
            tot_size = 0;

            foreach (ListViewItem file in listView1.Items)
            {
                String filename = file.SubItems[1].Text + "\\" + file.Text;
                System.IO.FileInfo fileInfo = new System.IO.FileInfo(filename);
                if (File.Exists(filename))
                    tot_size = tot_size + fileInfo.Length;
            }

            var bytes = tot_size;
            var kilobytes = (double)bytes / 1024;
            var megabytes = kilobytes / 1024;
            var gigabytes = megabytes / 1024;

            //Format size view

            //Get separator
            String separator = ".";

            if (bytes > 1000000000)
            {
                if (gigabytes.ToString().Contains("."))
                {
                    separator = ".";
                }
                else
                {
                    separator = ",";
                }

                String gigas = gigabytes.ToString();
                if (gigas.Length >= 5)
                {
                    gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                    this.InvokeEx(f => f.lbl_size.Text = gigas + " " + "GB");
                }
                else
                {
                    this.InvokeEx(f => f.lbl_size.Text = gigas + " " + "GB");
                }
            }

            if (bytes >= 1048576 && bytes < 1000000000)
            {
                if (megabytes.ToString().Contains("."))
                {
                    separator = ".";
                }
                else
                {
                    separator = ",";
                }
                String megas = megabytes.ToString();
                if (megas.Length > 5)
                {
                    megas = megas.Substring(0, megas.LastIndexOf(separator));
                    this.InvokeEx(f => f.lbl_size.Text = megas + " " + "MB");
                }
                else
                {
                    this.InvokeEx(f => f.lbl_size.Text = megas + " " + "MB");
                }
            }

            if (bytes >= 1024 && bytes < 1048576)
            {
                if (kilobytes.ToString().Contains("."))
                {
                    separator = ".";
                }
                else
                {
                    separator = ",";
                }
                String kbs = kilobytes.ToString();
                if (kbs.Length >= 5)
                {
                    kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                    this.InvokeEx(f => f.lbl_size.Text = kbs + " " + "KB");
                }
                else
                {
                    this.InvokeEx(f => f.lbl_size.Text = kbs + " " + "KB");
                }
            }
            if (bytes > -1 && bytes < 1024)
            {
                String bits = bytes.ToString();
                this.InvokeEx(f => f.lbl_size.Text = bits + " Bytes");
            }

            //End Format size view
        }

        private void calc_list_dur()

        {
            //Show total duration
            Double Total_dur = 0;

            foreach (ListViewItem item in listView1.Items)
            {
                String filename = item.SubItems[1].Text + "\\" + item.Text;

                if (item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != FFBatch.Properties.Strings.pending && item.SubItems[3].Text != "00:00:00")
                {
                    Total_dur = Total_dur + TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds;
                }
            }

            TimeSpan t = TimeSpan.FromSeconds(Total_dur);
            String dur = string.Format("{0:D2}h:{1:D2}m:{2:D2}s.{3:D3}ms",
                     (int)t.TotalHours,
                     t.Minutes,
                     t.Seconds,
                     t.Milliseconds);
            lbl_dur_list.Text = dur.Substring(0, 11);

            //End show total duration
        }

        private void btn_capture_Click(object sender, EventArgs e)
        {
            cancel_queue = false;
            notifyIcon1.Visible = true;

            //Try preset

            this.Cursor = Cursors.WaitCursor;

            String destino_test = "";

            if (txt_path_main.Text.Contains(".\\"))
            {
                if (txt_path_main.Text == (".\\"))
                {
                    destino_test = System.IO.Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyVideos));
                }
                else
                {
                    destino_test = System.IO.Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyVideos), txt_path_main.Text.Replace("..\\", String.Empty));
                }
            }
            else
            {
                destino_test = txt_path_main.Text;
            }

            if (!Directory.Exists(destino_test))
            {
                try
                {
                    Directory.CreateDirectory(destino_test);
                }
                catch
                {
                    MessageBox.Show(Properties.Strings2.error_writing, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }
            Process consola_pre = new Process();
            consola_pre.StartInfo.FileName = "ffmpeg.exe";
            consola_pre.StartInfo.Arguments = " -f gdigrab " + txt_pre_input.Text + " -i desktop" + " -t 00:00:00.000 " + " -y " + txt_parameters.Text + " -y " + '\u0022' + destino_test + "\\" + "Rec_Screen_test" + "." + txt_format.Text + '\u0022';
            consola_pre.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;
            consola_pre.Start();
            consola_pre.WaitForExit();
            String test = destino_test + "\\" + "Rec_Screen_test" + "." + txt_format.Text;
            if (File.Exists(destino_test + "\\" + "Rec_Screen_test" + "." + txt_format.Text))
            {
                try
                {
                    File.Delete(destino_test + "\\" + "Rec_Screen_test" + "." + txt_format.Text);
                }
                catch { }
            }
            if (consola_pre.ExitCode != 0)
            {
                this.Cursor = Cursors.Arrow;
                MessageBox.Show(Properties.Strings2.scr_fail + Environment.NewLine + Environment.NewLine + Properties.Strings2.try_scr_pr, Properties.Strings2.rec_fail, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }
            this.Cursor = Cursors.Arrow;

            //END try preset

            //SELECT AUDIO
            abort_capture = true;
            Form frm_audio_input = new Form();
            frm_audio_input.Icon = this.Icon;

            frm_audio_input.Height = 303;
            frm_audio_input.Width = 477;
            frm_audio_input.FormBorderStyle = FormBorderStyle.Fixed3D;
            frm_audio_input.MaximizeBox = false;
            frm_audio_input.MinimizeBox = false;
            frm_audio_input.Text = Properties.Strings2.scr_cap;

            Label lbl_11 = new Label();
            lbl_11.Left = 15;
            lbl_11.Top = 213;
            lbl_11.Width = 440;
            lbl_11.Text = Properties.Strings2.app_min_1;
            lbl_11.Parent = frm_audio_input;

            Label lbl_12 = new Label();
            lbl_12.Left = 15;
            lbl_12.Top = 234;
            lbl_12.Width = 440;
            lbl_12.Text = Properties.Strings2.stop_any;
            lbl_12.Parent = frm_audio_input;

            CB1_o.Items.Clear();
            CB1_o.Parent = frm_audio_input;
            CB1_o.Left = 15;
            CB1_o.Top = 42;
            CB1_o.Height = 235;
            CB1_o.Width = 429;
            CB1_o.DropDownStyle = ComboBoxStyle.DropDownList;
            CB1_o.SelectedIndexChanged += new EventHandler(CB1_o_SelectedIndexChanged);

            Label lbl_driver = new Label();
            lbl_driver.Left = 15;
            lbl_driver.Top = 72;
            lbl_driver.Width = 360;
            lbl_driver.Text = Properties.Strings2.capt_virtual;
            lbl_driver.Parent = frm_audio_input;

            LinkLabel boton_driver = new LinkLabel();
            boton_driver.Parent = frm_audio_input;
            boton_driver.Left = 381;
            boton_driver.Top = 72;
            boton_driver.Width = 159;
            boton_driver.Height = 20;
            boton_driver.Text = Properties.Strings2.download;
            boton_driver.Click += new EventHandler(boton_driver_Click);

            TextBox titulo = new TextBox();
            titulo.Parent = frm_audio_input;
            titulo.Top = 10;
            titulo.Left = 15;
            titulo.Width = 415;

            var fuente = new System.Drawing.Font("Microsoft Sans Serif", 11, FontStyle.Regular);
            titulo.Font = fuente;
            titulo.BorderStyle = BorderStyle.Fixed3D;
            titulo.TextAlign = HorizontalAlignment.Left;
            titulo.ReadOnly = true;
            titulo.Text = Properties.Strings2.selc_dev;
            titulo.ForeColor = Color.SteelBlue;
            titulo.BorderStyle = BorderStyle.None;
            titulo.Refresh();

            Button boton_ok_audio = new Button();
            boton_ok_audio.Parent = frm_audio_input;
            boton_ok_audio.Left = 15;
            boton_ok_audio.Top = 98;
            boton_ok_audio.Width = 429;
            boton_ok_audio.Height = 68;
            boton_ok_audio.Text = Properties.Strings2.start_cap;
            boton_ok_audio.TabIndex = 0;
            boton_ok_audio.TextAlign = ContentAlignment.BottomCenter;
            boton_ok_audio.Image = btn_capture.Image;
            boton_ok_audio.ImageAlign = ContentAlignment.TopCenter;
            boton_ok_audio.Click += new EventHandler(boton_ok_audio_Click);

            Button boton_cancel_audio = new Button();
            boton_cancel_audio.Parent = frm_audio_input;
            boton_cancel_audio.Left = 259;
            boton_cancel_audio.Top = 174;
            boton_cancel_audio.Width = 185;
            boton_cancel_audio.Height = 27;
            boton_cancel_audio.Text = Properties.Strings2.abort_cap;
            boton_cancel_audio.TextAlign = ContentAlignment.MiddleCenter;
            boton_cancel_audio.ImageList = img_abort;
            boton_cancel_audio.Image = img_abort.Images[0];
            boton_cancel_audio.ImageAlign = ContentAlignment.MiddleRight;
            boton_cancel_audio.Click += new EventHandler(boton_cancel_audio_Click);

            Button boton_refresh_audio = new Button();
            boton_refresh_audio.Parent = frm_audio_input;
            boton_refresh_audio.Left = 15;
            boton_refresh_audio.Top = 174;
            boton_refresh_audio.Width = 185;
            boton_refresh_audio.Height = 27;
            boton_refresh_audio.Text = Properties.Strings.Refresh_list;
            boton_refresh_audio.TextAlign = ContentAlignment.MiddleCenter;
            boton_refresh_audio.Image = btn_refresh.Image;
            boton_refresh_audio.ImageAlign = ContentAlignment.MiddleLeft;
            boton_refresh_audio.Click += new EventHandler(boton_refresh_audio_Click);

            Button boton_show_rec = new Button();
            boton_show_rec.Parent = frm_audio_input;
            boton_show_rec.Left = 211;
            boton_show_rec.Top = 174;
            boton_show_rec.Width = 36;
            boton_show_rec.Height = 27;
            boton_show_rec.ImageList = img_abort;
            boton_show_rec.Image = img_abort.Images[1];
            boton_show_rec.ImageAlign = ContentAlignment.MiddleCenter;
            boton_show_rec.Click += new EventHandler(boton_show_rec_Click);

            Process consola = new Process();

            consola.StartInfo.FileName = "ffmpeg.exe";

            frm_audio_input.StartPosition = FormStartPosition.CenterScreen;

            consola.StartInfo.Arguments = " -list_devices true -f dshow -i dummy";

            consola.StartInfo.RedirectStandardOutput = true;
            consola.StartInfo.RedirectStandardError = true;
            consola.StartInfo.UseShellExecute = false;
            consola.StartInfo.CreateNoWindow = true;
            consola.StartInfo.StandardErrorEncoding = Encoding.UTF8;
            consola.EnableRaisingEvents = true;

            consola.Start();

            CB1_o.Items.Add(Properties.Strings2.none);
            String out_ff = String.Empty;
            Boolean start_audio_sources = false;
            while (!consola.StandardError.EndOfStream)
            {
                out_ff = consola.StandardError.ReadLine();
                if (out_ff.Contains("DirectShow audio devices"))
                {
                    start_audio_sources = true;
                }

                if (start_audio_sources == true)
                {
                    if (out_ff.Substring(out_ff.Length - 2, 2) != "}" + "\u0022" && out_ff.Contains("DirectShow audio devices") == false && out_ff.Contains("Alternative name") == false && out_ff.Contains("dummy") == false)
                    {
                        //if (out_ff.Contains("Ã³")) out_ff = out_ff.Replace("Ã³", "ó");
                        int trim1 = out_ff.IndexOf("\u0022") + "\u0022".Length;
                        int trim2 = out_ff.LastIndexOf("\u0022");
                        if (trim2 - trim1 > 0) this.InvokeEx(f => CB1_o.Items.Add(out_ff.Substring(trim1, trim2 - trim1)));
                    }
                }
            }
            consola.StartInfo.Arguments = String.Empty;
            CB1_o.Refresh();
            CB1_o.SelectedIndex = 0;
            if (CB1_o.Items.Count == 1) CB1_o.Enabled = false;

            for (int i = 0; i < CB1_o.Items.Count; i++)
            {
                if (CB1_o.Items[i].ToString() == prev_dev_audio)
                {
                    CB1_o.SelectedIndex = i;
                    break;
                }
            }

            this.Cursor = Cursors.Arrow;
            frm_audio_input.ShowDialog();

            //END AUDIO SELECT
            if (abort_capture == true) return;

            //Validated list, start processing
            recording_scr = true;
            txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + "00h:00m:00s";

            cancel_queue = false;
            Pg1.Value = 0;
            //pg_current.Value = 0;
            Disable_Controls();
            chk_delete_source.Enabled = false;

            //textBox4.Text = "0%";

            working = true;

            ListView list_proc = new ListView();
            foreach (ListViewItem item in listView1.Items)
            {
                list_proc.Items.Add(item.Text);
                item.BackColor = Color.White;
            }

            Pg1.Maximum = list_proc.Items.Count;
            listView1.SelectedIndices.Clear();
            lbl_elapsed.Text = FFBatch.Properties.Strings.time_elapsed + " " + "00h:00m:00s";
            time_n_tasks = 0;

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;

                String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");

                String destino = "";

                if (txt_path_main.Text.Contains(".\\"))
                {
                    if (txt_path_main.Text == (".\\"))
                    {
                        destino = System.IO.Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyVideos));
                    }
                    else
                    {
                        destino = System.IO.Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyVideos), txt_path_main.Text.Replace("..\\", String.Empty));
                    }
                }
                else
                {
                    destino = txt_path_main.Text;
                }
                capture_count = capture_count + 1;

                if (File.Exists(destino + "\\" + "Rec_Screen_" + capture_count.ToString() + "." + txt_format.Text) == true)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file + " " + destino + "\\" + "Rec_Screen_" + capture_count.ToString() + "." + txt_format.Text + " exits", "Destination file exists", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    Enable_Controls();
                    working = false;
                    return;
                }

                this.InvokeEx(f => f.btn_abort_all.Enabled = false);
                //Recording countdown
                this.InvokeEx(f => f.lbl_capture.Enabled = true);
                this.InvokeEx(f => f.lbl_capture.Text = "");
                this.InvokeEx(f => f.lbl_capture.Visible = true);

                this.InvokeEx(f => f.lbl_capture.Text = (Properties.Strings2.capt_3));
                this.InvokeEx(f => f.lbl_capture.Refresh());
                Thread.Sleep(1000);
                this.InvokeEx(f => f.lbl_capture.Text = (Properties.Strings2.capt_2));
                this.InvokeEx(f => f.lbl_capture.Refresh());
                Thread.Sleep(1000);
                this.InvokeEx(f => f.lbl_capture.Text = (Properties.Strings2.capt_1));
                this.InvokeEx(f => f.lbl_capture.Refresh());
                this.InvokeEx(f => this.WindowState = FormWindowState.Minimized);
                Thread.Sleep(1000);
                this.InvokeEx(f => f.timer_tasks.Start());
                this.InvokeEx(f => f.lbl_capture.Text = "");
                this.InvokeEx(f => f.lbl_capture.Visible = false);
                //End recording countdown
                this.InvokeEx(f => f.btn_abort_all.Enabled = true);
                String pre_input_var = "";
                if (txt_pre_input.Text != "")
                {
                    pre_input_var = txt_pre_input.Text;
                }
                String AppParam = String.Empty;
                if (audio_capture_device == Properties.Strings2.none)
                {
                    AppParam = " -f gdigrab " + pre_input_var + " -i desktop " + txt_parameters.Text + " -y " + '\u0022' + destino + "\\" + "Rec_Screen_" + capture_count.ToString() + "." + txt_format.Text + '\u0022';
                }
                else
                {
                    AppParam = " -f dshow -i audio=" + '\u0022' + audio_capture_device + '\u0022' + " -f gdigrab " + pre_input_var + " -i desktop " + txt_parameters.Text + " -y " + '\u0022' + destino + "\\" + "Rec_Screen_" + capture_count.ToString() + "." + txt_format.Text + '\u0022';
                }

                if (!Directory.Exists(destino))
                {
                    Directory.CreateDirectory(destino);
                }

                process_glob.StartInfo.FileName = ffm;
                process_glob.StartInfo.Arguments = AppParam;

                valid_prog = false;

                process_glob.StartInfo.RedirectStandardOutput = false;
                process_glob.StartInfo.RedirectStandardError = false;
                process_glob.StartInfo.RedirectStandardInput = true;
                process_glob.StartInfo.UseShellExecute = false;
                process_glob.StartInfo.CreateNoWindow = true;
                process_glob.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;
                this.InvokeEx(f => f.pic_recording.Visible = true);
                process_glob.Start();
                capture_handle = process_glob.Id;
                process_glob.WaitForExit();
                recording_scr = false;
                timer1.Stop();
                this.InvokeEx(f => f.pic_recording.Visible = false);
                Enable_Controls();
                working = false;

                if (process_glob.ExitCode == 1)
                {
                    MessageBox.Show(Properties.Strings2.invalid_param, Properties.Strings2.invalid_p_2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                }

                if (process_glob.ExitCode != -1073741510 && process_glob.ExitCode != 1 && process_glob.ExitCode != 0)
                {
                    MessageBox.Show(Properties.Strings2.scsr_term, Properties.Strings2.capt_term, MessageBoxButtons.OK, MessageBoxIcon.Error);
                }

                timer_tasks.Stop();
                TimeSpan t = TimeSpan.FromSeconds(time_n_tasks);
                String tx_elapsed = string.Format("{0:D2}h:{1:D2}m:{2:D2}s",
                    t.Hours,
                    t.Minutes,
                    t.Seconds);
                this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + "00h:00m:00s");

                if (chk_open_compl.Checked)
                {
                    if (Directory.GetFiles(destino).Length != 0 && process_glob.ExitCode == 0)
                    {
                        Process open_processed = new Process();
                        open_processed.StartInfo.FileName = "explorer.exe";
                        open_processed.StartInfo.Arguments = '\u0022' + destino + '\u0022';
                        open_processed.Start();
                    }
                }
            }).Start();
        }

        private void boton_driver_Click(object sender, EventArgs e)
        {
            Process.Start("https://github.com/rdp/screen-capture-recorder-to-video-windows-free/releases/tag/v0.12.11");
        }

        private void boton_show_rec_Click(object sender, EventArgs e)
        {
            Process.Start("control", "mmsys.cpl,,1");
        }

        private void boton_refresh_audio_Click(object sender, EventArgs e)
        {
            Process consola = new Process();

            consola.StartInfo.FileName = "ffmpeg.exe";
            consola.StartInfo.Arguments = " -list_devices true -f dshow -i dummy";

            consola.StartInfo.RedirectStandardOutput = true;
            consola.StartInfo.RedirectStandardError = true;
            consola.StartInfo.UseShellExecute = false;
            consola.StartInfo.CreateNoWindow = true;
            consola.StartInfo.StandardErrorEncoding = Encoding.UTF8;
            consola.EnableRaisingEvents = true;

            consola.Start();

            CB1_o.Items.Clear();
            CB1_o.Items.Add(Properties.Strings2.none);
            String out_ff = String.Empty;
            Boolean start_audio_sources = false;
            while (!consola.StandardError.EndOfStream)
            {
                out_ff = consola.StandardError.ReadLine();
                if (out_ff.Contains("DirectShow audio devices"))
                {
                    start_audio_sources = true;
                }

                if (start_audio_sources == true)
                {
                    if (out_ff.Substring(out_ff.Length - 2, 2) != "}" + "\u0022" && out_ff.Contains("DirectShow audio devices") == false && out_ff.Contains("Alternative name") == false && out_ff.Contains("dummy") == false)
                    {
                        //if (out_ff.Contains("Ã³")) out_ff = out_ff.Replace("Ã³", "ó");
                        int trim1 = out_ff.IndexOf("\u0022") + "\u0022".Length;
                        int trim2 = out_ff.LastIndexOf("\u0022");
                        if (trim2 - trim1 > 0) this.InvokeEx(f => CB1_o.Items.Add(out_ff.Substring(trim1, trim2 - trim1)));
                    }
                }
            }
            CB1_o.Refresh();
            CB1_o.SelectedIndex = 0;
            if (CB1_o.Items.Count > 1)
            {
                CB1_o.Enabled = true;
                CB1_o.DroppedDown = true;
            }
            else
            {
                CB1_o.Enabled = false;
            }

            consola.StartInfo.Arguments = String.Empty;
            this.Cursor = Cursors.Arrow;
        }

        private void boton_cancel_path_Click(object sender, EventArgs e)
        {
            ActiveForm.Close();
        }

        private void boton_cancel_audio_Click(object sender, EventArgs e)
        {
            ActiveForm.Close();
        }

        private void chk_burn_CheckedChanged(object sender, EventArgs e)
        {
            if (chk_burn.CheckState == CheckState.Checked)
            {
                hard_sub = true;
                txt_hard_subs.Enabled = true;
                Enable_txt_hard_Subs = true;
                Combo_def_sub_mux.Enabled = false;
                Combo_sub_lang_mux.Enabled = false;
            }
            else
            {
                hard_sub = false;
                txt_hard_subs.Enabled = false;
                Enable_txt_hard_Subs = false;
                Combo_def_sub_mux.Enabled = true;
                Combo_sub_lang_mux.Enabled = true;
            }
        }

        private void txt_fin_TextChanged(object sender, EventArgs e)
        {
            DateTime time;
            if (!DateTime.TryParse(txt_fin.Text, out time))
            {
                txt_fin.BackColor = Color.Orange;
            }
            else
            {
                txt_fin.BackColor = Color.White;
            }

            if (txt_fin.Text.Length > 12)
            {
                MessageBox.Show(FFBatch.Properties.Strings.time_bad, FFBatch.Properties.Strings.time_err, MessageBoxButtons.OK, MessageBoxIcon.Warning);
            }
        }

        private void txt_fin_DoubleClick_1(object sender, EventArgs e)
        {
            if (listView1.SelectedIndices.Count > 0)
            {
                txt_fin.Text = listView1.SelectedItems[0].SubItems[3].Text;
            }
            else
            {
                txt_fin.Text = "0:00:00.000";
            }
        }

        private void txt_ini_TextChanged(object sender, EventArgs e)
        {
            DateTime time;
            if (!DateTime.TryParse(txt_ini.Text, out time))
            {
                txt_ini.BackColor = Color.Orange;
            }
            else
            {
                txt_ini.BackColor = Color.White;
            }

            if (txt_ini.Text.Length > 12)
            {
                MessageBox.Show(FFBatch.Properties.Strings.time_bad, FFBatch.Properties.Strings.time_err, MessageBoxButtons.OK, MessageBoxIcon.Warning);
            }
        }

        private void txt_ini_Leave(object sender, EventArgs e)
        {
            if (txt_ini.Text == "0:00:00.000")
            {
                txt_ini.BackColor = groupBox1.BackColor;
                return;
            }

            DateTime time2;
            if (!DateTime.TryParse(txt_ini.Text, out time2))
            {
                txt_ini.BackColor = Color.Orange;
            }
            else
            {
                txt_ini.BackColor = Color.White;
            }
        }

        private void txt_ini_DoubleClick(object sender, EventArgs e)
        {
            txt_ini.Text = "0:00:00.000";
        }

        private void txt_fin_Leave(object sender, EventArgs e)
        {
            if (txt_fin.Text == "0:00:00.000")
            {
                txt_fin.BackColor = groupBox1.BackColor;
                return;
            }

            DateTime time2;
            if (!DateTime.TryParse(txt_fin.Text, out time2))
            {
                txt_fin.BackColor = Color.Orange;
            }
            else
            {
                txt_fin.BackColor = Color.White;
            }
        }

        private void cti5_Click(object sender, EventArgs e)
        {
            if (listView1.SelectedItems.Count > 0)
            {
                String fullPath = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
                if (File.Exists(fullPath))
                {
                    if (listView1.SelectedItems[0].SubItems[3].Text != FFBatch.Properties.Strings.pending && listView1.SelectedItems[0].SubItems[3].Text != FFBatch.Properties.Strings.n_a)
                    {
                        txt_fin.Text = listView1.SelectedItems[0].SubItems[3].Text;
                        txt_fin.BackColor = Color.LightYellow;
                        return;
                    }
                }
                else
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file_not_found, FFBatch.Properties.Strings.file_miss, MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        private void ct4_conv_Click(object sender, EventArgs e)
        {
            if (listView3.SelectedItems[0].SubItems[1].Text == FFBatch.Properties.Strings.vob_sub)
            {
                MessageBox.Show(FFBatch.Properties.Strings.vob_conv, FFBatch.Properties.Strings.information, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            String dest;
            String sub_ext;
            String source_sub;

            if (listView3.SelectedItems[0].SubItems[1].Text == FFBatch.Properties.Strings.srt_sub)
            {
                sub_ext = listView3.SelectedItems[0].SubItems[1].Text.Substring(0, 3).ToLower();
                source_sub = Path.Combine(Path.GetDirectoryName(listView3.SelectedItems[0].Text), Path.GetFileNameWithoutExtension(listView3.SelectedItems[0].Text) + "." + sub_ext);
                dest = Path.Combine(Path.GetDirectoryName(listView3.SelectedItems[0].Text), Path.GetFileNameWithoutExtension(listView3.SelectedItems[0].Text) + "_utf8." + sub_ext);
            }
            else if (listView3.SelectedItems[0].SubItems[1].Text == FFBatch.Properties.Strings.as_sub)
            {
                sub_ext = listView3.SelectedItems[0].SubItems[1].Text.Substring(0, 3).ToLower();
                source_sub = Path.Combine(Path.GetDirectoryName(listView3.SelectedItems[0].Text), Path.GetFileNameWithoutExtension(listView3.SelectedItems[0].Text) + "." + sub_ext);
                dest = Path.Combine(Path.GetDirectoryName(listView3.SelectedItems[0].Text), Path.GetFileNameWithoutExtension(listView3.SelectedItems[0].Text) + "_utf8." + sub_ext);
            }
            else
            {
                sub_ext = listView3.SelectedItems[0].SubItems[1].Text;
                source_sub = listView3.SelectedItems[0].SubItems[1].Text;
                dest = Path.Combine(Path.GetDirectoryName(listView3.SelectedItems[0].SubItems[1].Text), Path.GetFileNameWithoutExtension(listView3.SelectedItems[0].SubItems[1].Text) + "_utf8" + Path.GetExtension(listView3.SelectedItems[0].SubItems[1].Text));
            }

            String f1 = File.ReadAllText(source_sub, Encoding.Default);

            File.WriteAllText(Path.Combine(Path.GetDirectoryName(listView3.SelectedItems[0].Text), dest), f1, Encoding.UTF8);
            listView3.SelectedItems[0].SubItems[1].Text = dest;

            var a = TextFileEncodingDetector.DetectTextFileEncoding(dest);
            if (a != null)
            {
                String txt_enc = a.ToString().Replace("System.Text.", "");
                listView3.SelectedItems[0].SubItems[3].Text = txt_enc.Replace(FFBatch.Properties.Strings.Encoding, "");
            }
            else
            {
                listView3.SelectedItems[0].SubItems[3].Text = FFBatch.Properties.Strings.unknown;
            }
        }

        private void refresh_full()
        {
            List<string> files2 = new List<string>();
            int num_drop = 0;

            foreach (ListViewItem item in listView1.Items)
            {
                String filename = item.SubItems[1].Text + "\\" + item.Text;
                if (File.Exists(filename))
                {
                    files2.Add(filename);
                }
            }
            num_drop = files2.Count();

            files_to_add = files2;
            listView1.Items.Clear();

            canceled_file_adding = false;

            btn_cancel_add.Enabled = true;
            btn_cancel_add.Visible = true;
            btn_cancel_add.Refresh();

            BG_Files.RunWorkerAsync();
        }

        private void clean_cols()
        {
            listView1.Invoke(new MethodInvoker(delegate
            {
                foreach (ColumnHeader col in listView1.Columns)
                {
                    if (col.Text.Contains(FFBatch.Properties.Strings.width) ||
                        col.Text.Contains(FFBatch.Properties.Strings.height) ||
                        col.Text.Contains(FFBatch.Properties.Strings.Video_codec) ||
                        col.Text.Contains(FFBatch.Properties.Strings.Audio_codec))
                        listView1.Columns.Remove(col);
                }
            }));
        }

        private void btn_refresh_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            if (tabControl1.SelectedIndex == 3)
            {
                btn_validate_url.PerformClick();
                return;
            }

            if (listView1.Items.Count == 0)
            {
                return;
            }
            //Clean file thumbs
            String destino_test = Path.GetTempPath() + "\\" + "FFBatch_test";
            try
            {
                if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length > 0)
                {
                    foreach (String file in Directory.GetFiles(destino_test))
                    {
                        try
                        {
                            File.Delete(file);
                        }
                        catch { }
                    }
                }
            }
            catch { }

            refresh_full();
            calc_list_dur();

            lbl_items.Text = listView1.Items.Count + " " + FFBatch.Properties.Strings.files;

            if (tabControl1.SelectedIndex == 0 || tabControl1.SelectedIndex == 1)
            {
                chk_open_compl.Visible = true;
                combo_ext.Visible = false;
                label19.Visible = false;
                btn_set_mux_def.Visible = false;

                group_subs.Visible = false;
                label17.Visible = false;
                combo_item_lang_2.Visible = false;
                btn_clean_list.Visible = true;

                label13.Visible = true;
                txt_path_main.Visible = true;
                button21.Visible = true;
                chkshut.Visible = true;
                btn_mux.Visible = false;

                button23.Visible = false;
                pic_encode_param.Visible = false;
                lbl_mux_par.Visible = false;
                txt_track_param.Visible = false;
                btn_set_track_param.Visible = false;
                groupBox1.Visible = true;
                panel1.Visible = true;
                list_tracks.Visible = false;

                return;
            }
            if (tabControl1.SelectedIndex == 1)
            {
                add_to_tab_2();
            }

            else if (tabControl1.SelectedIndex == 2)
            {
                btn_set_mux_def.Visible = false;
                btn_set_track_param.Visible = false;

                group_subs.Visible = true;

                TB1.Visible = false;
                txt_hard_subs.Text = txt_parameters.Text;
                //Check listview1 vs listview2
                int list_int = 0;
                if (listView1.Items.Count == listView3.Items.Count)
                {
                    foreach (ListViewItem item in listView1.Items)
                    {
                        if (listView3.Items[list_int].Text == item.Text)
                        {
                            list_int = list_int + 1;
                        }
                    }
                }
                if (list_int == listView1.Items.Count)
                {
                    return;
                }
                else
                {
                    listView3.Items.Clear();
                }

                listView3.SmallImageList = listView1.SmallImageList;
                foreach (ListViewItem item in listView1.Items)
                {
                    this.Cursor = Cursors.WaitCursor;
                    ListViewItem elemento = new ListViewItem(item.Text, 1);
                    //Begin get file icon
                    Icon iconForFile = SystemIcons.WinLogo;

                    // Check to see if the image collection contains an image
                    // for this extension, using the extension as a key.
                    if (!imageList2.Images.ContainsKey(System.IO.Path.GetExtension(item.Text)))
                    {
                        // If not, add the image to the image list.
                        iconForFile = System.Drawing.Icon.ExtractAssociatedIcon(item.Text);
                        imageList2.Images.Add(System.IO.Path.GetExtension(item.Text), iconForFile);
                    }

                    elemento.ImageKey = System.IO.Path.GetExtension(item.Text);
                    //End get file icon

                    listView3.Items.Add(elemento);
                }

                foreach (ListViewItem item in listView3.Items)
                {
                    String extension = item.Text.Substring(item.Text.LastIndexOf("."));

                    if (extension == ".srt" || extension == ".idx" || extension == ".sub" || extension == ".ass")
                    {
                        listView3.Items.RemoveAt(item.Index);
                    }

                    String subs_path = String.Empty;
                    String Sub_File_SRT = String.Empty;
                    String Sub_File_Vobsub = String.Empty;
                    String Sub_File_ASS = String.Empty;

                    if (txt_folder_subs.Text == String.Empty)
                    {
                        Sub_File_SRT = item.Text.Substring(0, item.Text.LastIndexOf(".")) + ".srt";
                        Sub_File_Vobsub = item.Text.Substring(0, item.Text.LastIndexOf(".")) + ".idx";
                        Sub_File_ASS = item.Text.Substring(0, item.Text.LastIndexOf(".")) + ".ass";
                    }
                    else
                    {
                        String path_sub = txt_folder_subs.Text;
                        Path.GetFileName(item.Text);
                        Sub_File_SRT = path_sub + "\\" + Path.GetFileName(item.Text).Substring(0, Path.GetFileName(item.Text).LastIndexOf(".")) + ".srt";
                        Sub_File_Vobsub = path_sub + "\\" + Path.GetFileName(item.Text).Substring(0, Path.GetFileName(item.Text).LastIndexOf(".")) + ".idx";
                        Sub_File_ASS = path_sub + "\\" + Path.GetFileName(item.Text).Substring(0, Path.GetFileName(item.Text).LastIndexOf(".")) + ".ass";
                    }

                    if (item.SubItems[1].Text.Contains(FFBatch.Properties.Strings.no_sub_file) == false)
                    {
                        if (File.Exists(Sub_File_SRT))
                        {
                            item.SubItems.Add(FFBatch.Properties.Strings.srt_sub);
                            item.SubItems.Add("und");

                            var a = TextFileEncodingDetector.DetectTextFileEncoding(Sub_File_SRT);
                            if (a != null)
                            {
                                String txt_enc = a.ToString().Replace("System.Text.", "");
                                item.SubItems.Add(txt_enc.Replace(FFBatch.Properties.Strings.Encoding, ""));
                            }
                            else
                            {
                                item.SubItems.Add(FFBatch.Properties.Strings.unknown);
                            }
                            item.SubItems.Add(FFBatch.Properties.Strings.yes);
                            item.SubItems.Add(FFBatch.Properties.Strings.ready);
                        }

                        if (File.Exists(Sub_File_Vobsub))
                        {
                            item.SubItems.Add(FFBatch.Properties.Strings.vob_sub);
                            item.SubItems.Add("und");

                            item.SubItems.Add("-");
                            item.SubItems.Add(FFBatch.Properties.Strings.yes);
                            item.SubItems.Add(FFBatch.Properties.Strings.ready);
                        }
                        if (File.Exists(Sub_File_ASS))
                        {
                            item.SubItems.Add(FFBatch.Properties.Strings.as_sub);
                            item.SubItems.Add("und");

                            var a = TextFileEncodingDetector.DetectTextFileEncoding(Sub_File_ASS);
                            if (a != null)
                            {
                                String txt_enc = a.ToString().Replace("System.Text.", "");
                                item.SubItems.Add(txt_enc.Replace(FFBatch.Properties.Strings.Encoding, ""));
                            }
                            else
                            {
                                item.SubItems.Add(FFBatch.Properties.Strings.unknown);
                            }
                            item.SubItems.Add(FFBatch.Properties.Strings.yes);
                            item.SubItems.Add(FFBatch.Properties.Strings.ready);
                        }
                    }

                    if (!File.Exists(Sub_File_Vobsub) && !File.Exists(Sub_File_SRT) && !File.Exists(Sub_File_ASS))
                    {
                        item.SubItems.Add(FFBatch.Properties.Strings.no_sub2);
                        item.SubItems.Add("-");
                        item.SubItems.Add("-");
                        item.SubItems.Add("-");
                        item.SubItems.Add("No Sub");
                    }
                }
                Combo_sub_lang_mux.Text = "";
                this.Cursor = Cursors.Arrow;
            }
        }

        private void Refresh_lists()
        {
            if (tabControl1.SelectedIndex == 0)
            {
                listView1.BeginUpdate();
                foreach (ListViewItem item in listView1.Items)
                {
                    if (!File.Exists(item.Text))
                    {
                        item.Remove();
                    }
                }
                listView1.EndUpdate();
                return;
            }

            if (tabControl1.SelectedIndex == 1)
            {
                listView2.BeginUpdate();
                foreach (ListViewItem item in listView2.Items)
                {
                    if (!File.Exists(item.Text))
                    {
                        item.Remove();
                    }
                }
                listView2.EndUpdate();
                return;
            }
            if (tabControl1.SelectedIndex == 2)
            {
                listView3.BeginUpdate();
                foreach (ListViewItem item in listView3.Items)
                {
                    if (!File.Exists(item.Text))
                    {
                        item.Remove();
                    }
                }
                listView3.EndUpdate();
                return;
            }
        }

        private void chk_subfolders_CheckedChanged(object sender, EventArgs e)
        {
            add_subfs = chk_subfolders.Checked;
            Boolean prev_state = chk_subfolders.CheckState == CheckState.Unchecked;

            String path = String.Empty;
            if (is_portable == false)
            {
                path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.ini";
            }
            else
            {
                path = port_path + "ff_batch_portable.ini";
            }

            int linea = 0;

            foreach (string line in File.ReadLines(path))
            {
                linea = linea + 1;

                if (linea == 7)
                {
                    if (line == "subf_yes")
                    {
                        if (prev_state == false)
                        {
                            btn_save_config.ImageKey = "Save_settings_39.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.params_def);
                        }
                        else
                        {
                            btn_save_config.ImageKey = "save_pending.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.setting_mod);
                        }
                    }

                    else if (line == "subf_no")
                    {
                        if (prev_state == true)
                        {
                            btn_save_config.ImageKey = "Save_settings_39.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.params_def);
                        }
                        else
                        {
                            btn_save_config.ImageKey = "save_pending.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.setting_mod);
                        }
                    }
                }
            }
        }

        private void textBox2_Leave(object sender, EventArgs e)
        {
            txt_format.BackColor = txt_parameters.BackColor;
        }

        private void chk_suffix_CheckedChanged(object sender, EventArgs e)
        {
            if (chk_suffix.CheckState == CheckState.Checked)
            {
                txt_suffix.Enabled = true;
                txt_suffix.BackColor = Color.White;
            }
            else
            {
                txt_suffix.Enabled = false;
                txt_suffix.BackColor = SystemColors.InactiveBorder;
            }

            Boolean prev_state = chk_suffix.CheckState == CheckState.Unchecked;

            String path = String.Empty;
            if (is_portable == false)
            {
                path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.ini";
            }
            else
            {
                path = port_path + "ff_batch_portable.ini";
            }

            int linea = 0;

            foreach (string line in File.ReadLines(path))
            {
                linea = linea + 1;

                if (linea == 4)
                {
                    if (line != "Vn")
                    {
                        if (prev_state == false)
                        {
                            btn_save_config.ImageKey = "Save_settings_39.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.params_def);
                        }
                        else
                        {
                            btn_save_config.ImageKey = "save_pending.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.setting_mod);
                        }
                    }
                    else
                    {
                        if (prev_state == true)
                        {
                            btn_save_config.ImageKey = "Save_settings_39.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.params_def);
                        }
                        else
                        {
                            btn_save_config.ImageKey = "save_pending.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.setting_mod);
                        }
                    }
                    break;
                }
            }
        }

        private void txt_suffix_TextChanged(object sender, EventArgs e)
        {
            if (txt_suffix.Text.Contains("/") || txt_suffix.Text.Contains(":") || txt_suffix.Text.Contains("*") || txt_suffix.Text.Contains("?") || txt_suffix.Text.Contains("¿") || txt_suffix.Text.Contains('\u0022') || txt_suffix.Text.Contains("<") || txt_suffix.Text.Contains(">") || txt_suffix.Text.Contains("|") || txt_suffix.Text.Contains("\\"))
            {
                MessageBox.Show(FFBatch.Properties.Strings.invalid_char + " " + "(\\/:*?'\u0022'<>|", FFBatch.Properties.Strings.invalid_ch2, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                txt_suffix.Text = txt_suffix.Text.Replace("/", "");
                txt_suffix.Text = txt_suffix.Text.Replace(":", "");
                txt_suffix.Text = txt_suffix.Text.Replace("*", "");
                txt_suffix.Text = txt_suffix.Text.Replace("?", "");
                txt_suffix.Text = txt_suffix.Text.Replace("¿", "");
                txt_suffix.Text = txt_suffix.Text.Replace("\u0022", "");
                txt_suffix.Text = txt_suffix.Text.Replace("<", "");
                txt_suffix.Text = txt_suffix.Text.Replace(">", "");
                txt_suffix.Text = txt_suffix.Text.Replace("|", "");
                txt_suffix.Text = txt_suffix.Text.Replace("\\", "");
            }
        }

        private void txt_suffix_Leave(object sender, EventArgs e)
        {
            if (txt_suffix.Text == String.Empty)
            {
                txt_suffix.Text = "_FFB";
            }
        }

        private void btn_cancel_add_Click(object sender, EventArgs e)
        {
            canceled_add = true;
            canceled_file_adding = true;
            btn_cancel_add.Visible = false;
            dur_ok = false;
            group_prog.Focus();

            if (working == true)
            {
                wc.CancelAsync();
                cancel_cache = true;
            }
            else
            {
                try
                {
                    wc2.CancelAsync();
                }
                catch { }
            }
        }

        private void BG_Dur_DoWork(object sender, DoWorkEventArgs e)
        {
            dur_ok = false;
            canceled_add = false;
            this.InvokeEx(f => f.listView1.BeginUpdate());
            this.InvokeEx(f => f.Disable_Controls());
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.btn_cancel_add.Enabled = true);
            this.InvokeEx(f => f.btn_cancel_add.Visible = true);
            this.InvokeEx(f => f.btn_cancel_add.Refresh());
            this.InvokeEx(f => f.LB_Wait.Visible = true);
            this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.parsing);
            this.InvokeEx(f => f.LB_Wait.Refresh());
            this.InvokeEx(f => f.pg_adding.Visible = true);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.txt_adding_p.Visible = true);
            this.InvokeEx(f => f.txt_adding_p.Refresh());
            this.InvokeEx(f => f.pg_adding.Maximum = list_pending_dur.Items.Count);
            int invalids = 0;

            procs.Clear();

            for (int ii = 0; ii < list_pending_dur.Items.Count; ii++)
            {
                procs.Add("proc_urls_" + ii.ToString(), new Process());
            }

            ParallelOptions par_op = new ParallelOptions();
            CancellationTokenSource cts = new System.Threading.CancellationTokenSource();
            par_op.CancellationToken = cts.Token;
            par_op.MaxDegreeOfParallelism = Convert.ToInt16(n_threads.Value);
            fatal_parallel = false;

            IEnumerable<int> items_lv = Enumerable.Range(0, list_pending_dur.Items.Count);

            ParallelLoopResult result = new ParallelLoopResult();
            try
            {
                result = Parallel.ForEach(items_lv.AsParallel().AsOrdered(), par_op, (i) =>
                {
                    Task
                        .Factory
                        .StartNew(() =>
                        {
                            this.InvokeEx(f => f.pg_adding.Value = pg_adding.Value + 1);
                            this.InvokeEx(f => f.txt_adding_p.Text = (pg_adding.Value * 100 / list_pending_dur.Items.Count + "%"));
                            this.InvokeEx(f => f.txt_adding_p.Refresh());
                            var tmp = procs["proc_urls_" + i.ToString()];

                            if (canceled_add == false)
                            {
                                if (list_pending_dur.Items[i].SubItems[3].Text == FFBatch.Properties.Strings.pending)
                                {
                                    tmp.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
                                    String ffprobe_frames = " " + '\u0022' + "--Inform=General;%Duration/String3%" + '\u0022';
                                    tmp.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + list_pending_dur.Items[i].SubItems[1].Text + "\\" + list_pending_dur.Items[i].Text + '\u0022';

                                    tmp.StartInfo.RedirectStandardOutput = true;
                                    tmp.StartInfo.UseShellExecute = false;
                                    tmp.StartInfo.CreateNoWindow = true;
                                    tmp.EnableRaisingEvents = true;
                                    tmp.Start();

                                    String duracion = tmp.StandardOutput.ReadToEnd();
                                    tmp.WaitForExit();

                                    if (duracion != null)
                                    {
                                        TimeSpan time = new TimeSpan();
                                        if (TimeSpan.TryParse(duracion, out time))
                                        {
                                            this.InvokeEx(f => f.listView1.Items[i].SubItems[3].Text = duracion.Substring(0, 12));

                                            if (duracion.Length >= 12)
                                            {
                                                if (duracion.Substring(0, 11) == "0:00:00.000" || duracion.Substring(0, 12) == "00:00:00.000")
                                                {
                                                    invalids = invalids + 1;
                                                    this.InvokeEx(f => f.listView1.Items[i].BackColor = Color.LightGoldenrodYellow);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            this.InvokeEx(f => f.listView1.Items[i].SubItems[3].Text = FFBatch.Properties.Strings.n_a);
                                            invalids = invalids + 1;
                                            this.InvokeEx(f => f.listView1.Items[i].BackColor = Color.LightGoldenrodYellow);
                                        }
                                    }
                                    else
                                    {
                                        this.InvokeEx(f => f.listView1.Items[i].SubItems[3].Text = FFBatch.Properties.Strings.n_a);
                                        invalids = invalids + 1;
                                        this.InvokeEx(f => f.listView1.Items[i].BackColor = Color.LightGoldenrodYellow);
                                    }
                                }
                            }
                            else { cts.Cancel(); }
                        }).Wait();
                    i++;
                });
            }
            catch (Exception exc)
            {
                fatal_parallel_msg = exc.Message;
                fatal_parallel = true;
            }

            if (result.IsCompleted == true) fatal_parallel = false;
            else if (cts.IsCancellationRequested == false) fatal_parallel = true;
            else fatal_parallel = false;
            //End parallel
            if (invalids > 0)
            {
                this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                Form7 form_added = new Form7();
                form_added.pic_clean.Image = btn_clean_list.Image;
                form_added.label1.Text = listView1.Items.Count + " " + FFBatch.Properties.Strings.files;
                form_added.label2.Text = invalids + " " + FFBatch.Properties.Strings.files;
                if (listView1.Items.Count < 10) {}
                else if (listView1.Items.Count < 100)
                {
                    form_added.label4.Left = form_added.label4.Left + 8;
                }
                else if ( listView1.Items.Count < 1000)
                {
                    form_added.label4.Left = form_added.label4.Left + 18;
                }

                else if (listView1.Items.Count < 10000)
                {
                    form_added.label4.Left = form_added.label4.Left + 27;
                }
                else
                {
                    form_added.label4.Left = form_added.label4.Left + 36;
                }

                if (invalids < 10) {}
                else if (invalids < 100)
                {
                    form_added.label5.Left = form_added.label5.Left + 8;
                }
                else if (invalids < 1000)
                {
                    form_added.label5.Left = form_added.label5.Left + 18;
                }
                else if (invalids < 10000)
                {
                    form_added.label5.Left = form_added.label5.Left + 27;
                }
                else
                {
                    form_added.label5.Left = form_added.label5.Left + 36;
                }

                form_added.ShowDialog();
                form_added.Refresh();
            }

            dur_ok = !canceled_add;
        }

        private void BG_Dur_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            lbl_items.Text = listView1.Items.Count + " " + FFBatch.Properties.Strings.files;
            LB_Wait.Text = "";
            txt_adding_p.Visible = false;
            listView1.EndUpdate();
            Enable_Controls();
            chkshut.Enabled = true;
            btn_pause.Enabled = true;
            btn_cancel_add.Visible = false;
            txt_adding_p.Text = "";
            txt_adding_p.Visible = false;
            lbl_items.Visible = true;
            lbl_dur_list.Visible = true;
            lbl_size.Visible = true;
            pg_adding.Visible = false;
            LB_Wait.Visible = false;
            tabControl1.Enabled = true;

            tried_params.Clear();
            btn_cancel_add.Visible = false;
            if (canceled_add == true)
            {
                MessageBox.Show(FFBatch.Properties.Strings.dur_comp, FFBatch.Properties.Strings.pars_inc, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }
            else
            {
                if (tabControl1.SelectedIndex == 0)
                {
                    if (was_started.Text == btn_seq.Text)
                    {
                        btn_seq.PerformClick();
                    }
                    else if (was_started.Text == btn_multiple_presets.Text)
                    {
                        start_multiple();
                    }
                    else if (was_started.Text == btn_multi_m.Text)
                    {
                        btn_multi_m.PerformClick();
                    }
                    else if (was_started.Text == btn_concat.Text)
                    {
                        btn_concat.PerformClick();
                    }
                    else if (was_started.Text == btn_trim.Text)
                    {
                        btn_trim.PerformClick();
                    }
                }
                else if (tabControl1.SelectedIndex == 1)
                {
                    btn_mux.PerformClick();
                }
                else if (tabControl1.SelectedIndex == 2)
                {
                    btn_sub_mux.PerformClick();
                }
            }
        }

        private void create_temp()
        {
            String temp_ = Path.Combine(Path.GetTempPath(), "FFBatch_test");
            if (!Directory.Exists(temp_)) Directory.CreateDirectory(temp_);
        }

        private void BG_Files_DoWork(object sender, DoWorkEventArgs e)
        {
            if (listView1.Items.Count > 0)
            {
                List<string> files_already = new List<string>();
                listView1.Invoke(new MethodInvoker(delegate
                {
                    foreach (ListViewItem item in listView1.Items) files_already.Add(item.SubItems[1].Text + "\\" + item.Text);
                }));

                files_to_add = files_to_add.Except(files_already).ToList();
            }

            this.InvokeEx(f => f.listView1.SmallImageList = imageList2);

            Disable_Controls();
            this.InvokeEx(f => f.group_prog.Focus());
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.chkshut.Enabled = false);
            this.InvokeEx(f => f.btn_pause.Enabled = false);
            this.InvokeEx(f => f.tabControl1.Enabled = false);
            this.InvokeEx(f => f.LB_Wait.Visible = true);
            this.InvokeEx(f => f.btn_cancel_add.Enabled = true);

            create_temp();

            Type ts = Type.GetTypeFromProgID("Shell.Application");
            dynamic shell = Activator.CreateInstance(ts);

            //Es carpeta

            int i = 0;
            invalids = 0;
            pending_dur = 0;

            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = files_to_add.Count);
            this.InvokeEx(f => f.txt_adding_p.Visible = true);
            this.InvokeEx(f => f.txt_adding_p.Refresh());
            this.InvokeEx(f => f.lbl_items.Visible = false);
            this.InvokeEx(f => f.lbl_items.Refresh());
            this.InvokeEx(f => f.lbl_dur_list.Visible = false);
            this.InvokeEx(f => f.lbl_dur_list.Refresh());
            this.InvokeEx(f => f.lbl_size.Visible = false);
            this.InvokeEx(f => f.lbl_size.Refresh());

            this.InvokeEx(f => f.pg_adding.Visible = true);
            if (files_to_add.Count > 0) this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.adding + " " + files_to_add.Count + " " + FFBatch.Properties.Strings.files);
            else this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.find_dups);
            this.InvokeEx(f => f.LB_Wait.Refresh());

            this.InvokeEx(f => f.txt_adding_p.Text = "");

            this.InvokeEx(f => f.listView1.BeginUpdate());

            ListViewItem[] itemsToAdd = new ListViewItem[files_to_add.Count];
            String[] ext_nodur = new string[] { ".jpg", ".gif", ".bmp", ".png", ".tif", ".psd", ".txt", ".ini", ".zip", ".htm", ".html", ".css", ".js", ".rar", ".doc", ".docx", ".xls", ".xlsx", ".dll", ".exe", ".ico", ".pdf", ".log", ".cat", "mui", ".xml" };

            for (int n = 0; n < files_to_add.Count; n++)
            {
                itemsToAdd[n] = new ListViewItem(Path.GetFileName(files_to_add[n]));

                if (canceled_file_adding == false)
                {
                    i = i + 1;
                    if (i <= pg_adding.Maximum)
                    {
                        this.InvokeEx(f => f.pg_adding.Value = i);
                        this.InvokeEx(f => f.txt_adding_p.Text = (i * 100 / files_to_add.Count).ToString() + "%");
                        this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, i * 100 / files_to_add.Count, 100));
                    }
                    else
                    {
                        this.InvokeEx(f => f.pg_adding.Value = pg_adding.Maximum);
                        this.InvokeEx(f => f.txt_adding_p.Text = "100%");
                    }

                    Icon iconForFile = SystemIcons.WinLogo;

                    if (!files_to_add[n].Contains("\\\\"))
                    {
                        if (!imageList2.Images.ContainsKey(System.IO.Path.GetExtension(files_to_add[n])))
                        {
                            iconForFile = System.Drawing.Icon.ExtractAssociatedIcon(files_to_add[n]);
                            this.InvokeEx(f => f.imageList2.Images.Add(System.IO.Path.GetExtension(files_to_add[n]), iconForFile));
                        }
                    }

                    if (!files_to_add[n].Contains("\\\\"))
                    {
                        itemsToAdd[n].ImageKey = System.IO.Path.GetExtension(files_to_add[n]);
                    }
                    else
                    {
                        itemsToAdd[n].ImageIndex = 0;
                    }
                    itemsToAdd[n].SubItems.Add(Path.GetDirectoryName(files_to_add[n]));
                   
                    Boolean no_av = false;
                    String videosLength = String.Empty;

                    Folder rFolder = shell.NameSpace(Path.GetDirectoryName(files_to_add[n]));
                    FolderItem rFiles = rFolder.ParseName(System.IO.Path.GetFileName(files_to_add[n]));
                    String videostype = rFolder.GetDetailsOf(rFiles, 2).Trim();
                    String videoSize = rFolder.GetDetailsOf(rFiles, 1).Trim();
                    itemsToAdd[n].SubItems.Add(videostype);
                    String f_ext = Path.GetExtension(files_to_add[n]).ToLower();
                    foreach (String no_ext in ext_nodur)
                    {
                        if (f_ext == no_ext)
                        {
                            itemsToAdd[n].SubItems.Add("00:00:00");
                            if (Properties.Settings.Default.dark_mode == true)
                            {
                                itemsToAdd[n].BackColor = Color.FromArgb(255, 128, 128, 128);
                            }
                            else itemsToAdd[n].BackColor = Color.LightGoldenrodYellow;

                            no_av = true;
                            invalids = invalids + 1;
                            break;
                        }
                    }

                    if (no_av == false)
                    {
                        DateTime time;
                        videosLength = rFolder.GetDetailsOf(rFiles, 27).Trim();

                        if ((!DateTime.TryParse(videosLength, out time)))
                        {
                            itemsToAdd[n].SubItems.Add(FFBatch.Properties.Strings.pending);
                            pending_dur = pending_dur + 1;
                        }
                        else
                        {
                            itemsToAdd[n].SubItems.Add(videosLength);
                        }
                    }

                    //End testing

                    itemsToAdd[n].SubItems.Add(videoSize);
                    itemsToAdd[n].SubItems.Add(FFBatch.Properties.Strings.queued);

                    Boolean has_tbit = false;
                    foreach (ColumnHeader col in listView1.Columns)
                    {
                        if (col.Text.Contains(Properties.Strings2.bitrate))
                        {
                            has_tbit = true;
                            break;
                        }
                    }


                        if (listView1.Columns.Count > 6)
                    {
                        if (listView1.Columns.Count == 7 && has_tbit == true)
                        {
                            itemsToAdd[n].SubItems.Add(Properties.Strings.pending);
                        }
                        
                        else { 
                        Process get_frames = new Process();
                        get_frames.StartInfo.RedirectStandardOutput = true;
                        get_frames.StartInfo.RedirectStandardError = true;
                        get_frames.StartInfo.UseShellExecute = false;
                        get_frames.StartInfo.CreateNoWindow = true;
                        get_frames.EnableRaisingEvents = true;
                        get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "Mediainfo.exe");

                        String itfull = itemsToAdd[n].SubItems[1].Text + "\\" + itemsToAdd[n].Text;
                        String config_info = Path.Combine(Path.GetTempPath(), "FFBatch_Test") + "\\" + "columns.txt";
                        List<string> lines_ouput = new List<string>();

                        String[] config_lines = new String[2];
                        config_lines[0] = "Video;%Width%" + "\\n" + "%Height%" + "\\n" + "%Format%" + "\\n" + "%Format_Profile%" + "\\n" + "%BitRate/String%" + "\\n";
                        config_lines[1] = "Audio;%Format%" + "\\n" + "%BitRate/String%" + "\\n";
                        File.WriteAllLines(config_info, config_lines);

                        String ffprobe_frames = " " + "--Inform=file://" + config_info;
                        get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + itfull + '\u0022';

                        get_frames.Start();

                        while (!get_frames.StandardOutput.EndOfStream)
                        {
                            lines_ouput.Add(get_frames.StandardOutput.ReadLine());
                        }
                            //foreach (string str in lines_ouput) MessageBox.Show(str);
                            foreach (ColumnHeader col in listView1.Columns)
                            {
                                if (canceled_file_adding) break;

                                Boolean is_v = false;
                                Boolean is_a = false;

                                if (lines_ouput.Count > 3) is_v = true;
                                else is_a = true;
                                get_frames.WaitForExit();

                                if (col.Text.Contains(FFBatch.Properties.Strings.width))
                                {
                                    i--;
                                    if (is_v == true)
                                    {
                                        if (lines_ouput[0].Length > 0) itemsToAdd[n].SubItems.Add(lines_ouput[0]);
                                        else itemsToAdd[n].SubItems.Add("-");
                                        if (lines_ouput[1].Length > 0) itemsToAdd[n].SubItems.Add(lines_ouput[1]);
                                        else itemsToAdd[n].SubItems.Add("-");
                                    }
                                    else
                                    {
                                        itemsToAdd[n].SubItems.Add("-");
                                        itemsToAdd[n].SubItems.Add("-");
                                    }
                                    i++;
                                }

                                if (col.Text.Contains(FFBatch.Properties.Strings.Video_codec))
                                {
                                    i--;
                                    if (is_v == true && lines_ouput[2].Length > 0)
                                    {
                                        if (lines_ouput[2].Length >= 3)
                                        {
                                            if (lines_ouput[2].Length > 3)
                                            {
                                                if (lines_ouput[2].Substring(0, 4) == "AVC1")
                                                {
                                                    itemsToAdd[n].SubItems.Add(lines_ouput[2].ToLower().Replace("avc1", "h264") + " " + lines_ouput[3]);
                                                }
                                                else itemsToAdd[n].SubItems.Add(lines_ouput[2].ToLower() + " " + lines_ouput[3]);
                                            }
                                            else
                                            {
                                                if (lines_ouput[2].Substring(0, 3) == "AVC")
                                                {
                                                    itemsToAdd[n].SubItems.Add(lines_ouput[2].ToLower().Replace("avc", "h264") + " " + lines_ouput[3]);
                                                }
                                                else itemsToAdd[n].SubItems.Add(lines_ouput[2].ToLower() + " " + lines_ouput[3]);
                                            }
                                        }
                                        else itemsToAdd[n].SubItems.Add(lines_ouput[2].ToLower() + " " + lines_ouput[3]);
                                    }
                                    else
                                    {
                                        itemsToAdd[n].SubItems.Add("-");
                                    }
                                    i++;
                                }
                                if (col.Text.Contains(FFBatch.Properties.Strings.Audio_codec))
                                {
                                    i--;
                                    if (is_v)
                                    {
                                        if (lines_ouput[5].Length > 0)
                                        {
                                            lines_ouput[5] = lines_ouput[5].ToLower();
                                            if (lines_ouput[5].ToLower().Contains("mpeg audio"))
                                            {
                                                lines_ouput[5] = "MPEG Layer 3";
                                            }
                                            itemsToAdd[n].SubItems.Add(lines_ouput[5]);
                                        }
                                        else itemsToAdd[n].SubItems.Add("-");
                                    }
                                    else if (is_a)
                                    {
                                        if (lines_ouput[0].Length > 1)
                                        {
                                            lines_ouput[0] = lines_ouput[0].ToLower();
                                            if (lines_ouput[0].ToLower().Contains("mpeg audio") && Path.GetExtension(itfull) == ".mp3")
                                            {
                                                lines_ouput[0] = "MPEG Layer 3";
                                            }
                                            itemsToAdd[n].SubItems.Add(lines_ouput[0]);
                                        }
                                        else itemsToAdd[n].SubItems.Add("-");
                                    }
                                    else itemsToAdd[n].SubItems.Add("-");
                                    i++;
                                }

                                if (col.Text.Contains(FFBatch.Properties.Strings.v_bitr))
                                {
                                    i--;
                                    if (is_v == true && lines_ouput[4].Length > 0)
                                    {
                                        itemsToAdd[n].SubItems.Add(lines_ouput[4]);
                                    }
                                    else
                                    {
                                        itemsToAdd[n].SubItems.Add("-");
                                    }
                                    i++;
                                }

                                if (col.Text.Contains(FFBatch.Properties.Strings2.a_bitr))
                                {
                                    i--;
                                    if (is_v == true)
                                    {
                                        if (lines_ouput.Count > 6)
                                        {
                                            if (is_v == true && lines_ouput[6].Length > 0)
                                            {
                                                itemsToAdd[n].SubItems.Add(lines_ouput[6]);
                                            }
                                            else itemsToAdd[n].SubItems.Add("-");
                                        }
                                        else itemsToAdd[n].SubItems.Add("-");
                                    }
                                    else if (is_a == true)
                                    {
                                        if (lines_ouput.Count > 1)
                                        {
                                            if (lines_ouput[1] != null)
                                            {
                                                if (lines_ouput[1].Length > 0)
                                                {
                                                    itemsToAdd[n].SubItems.Add(lines_ouput[1]);
                                                }
                                                else itemsToAdd[n].SubItems.Add("-");
                                            }
                                            else itemsToAdd[n].SubItems.Add("-");
                                        }
                                        else itemsToAdd[n].SubItems.Add("-");
                                    }
                                    else itemsToAdd[n].SubItems.Add("-");

                                    i++;
                                }

                                if (col.Text.Contains(FFBatch.Properties.Strings2.bitrate))
                                {
                                    i--;
                                    itemsToAdd[n].SubItems.Add(Properties.Strings.pending);
                                    i++;
                                }                           
                            }
                        }
                    }
                }
            }
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
            if (canceled_file_adding == true)
            {
                this.InvokeEx(f => f.pg_adding.Value = 0);
                this.InvokeEx(f => f.pg_adding.Maximum = i);
                this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.cancelling);
                ListViewItem[] itemsToAdd2 = new ListViewItem[i];
                for (int n2 = 0; n2 < i; n2++)
                {
                    this.InvokeEx(f => f.pg_adding.Value = n2);
                    itemsToAdd2[n2] = itemsToAdd[n2];
                }
                this.InvokeEx(f => f.listView1.Items.AddRange(itemsToAdd2));
            }
            else
            {
                this.InvokeEx(f => f.listView1.Items.AddRange(itemsToAdd.ToArray()));
            }            
        }

        public string av_col(string key)
        {
            if (key.Contains("mp3")) key = "mp3";
            if (key.ToLower().Contains("eac3")) key = "EAC3";
            else
            {
                if (key.Contains("ac3")) key = "ac3";
            }
            if (key.Contains("aac (LC)")) key = "aac (LC)";
            if (key.Contains("alac")) key = "ALAC";
            if (key.Contains("aac (HE-AAC)")) key = "aac (HE-AAC)";
            if (key.Contains("pcm_f16le")) key = "pcm_f16le";
            if (key.Contains("pcm_f32le")) key = "pcm_f32le";
            if (key.Contains("pcm_f24le")) key = "pcm_f24le";
            if (key.Contains("pcm_s16le")) key = "pcm_s16le";
            if (key.Contains("pcm_s32le")) key = "pcm_s32le";
            if (key.Contains("pcm_s24le")) key = "pcm_s24le";
            if (key.Contains("pcm_u8")) key = "pcm_u8";
            return key;
        }

        public string av_col_v(string key)
        {
            if (key.Contains("mpeg4 (Simple Profile) (XVID")) key = "mpeg4 (Simple Profile) (XVID)";
            if (key.Contains("mpeg4 (Advanced Simple Profile) (XVID")) key = "mpeg4 (Advanced Simple Profile) (XVID)";
            if (key.Contains("mpeg4 (XVID")) key = "mpeg4 (XVID)";
            if (key.Contains("mpeg4 (Simple Profile) (DX50")) key = "mpeg4 (Simple Profile) (DX50)";
            if (key.Contains("mpeg4 (Advanced Simple Profile) (DX50")) key = "mpeg4 (Advanced Simple Profile) (DX50)";
            if (key.Contains("mpeg4 (Advanced Coding Profile)")) key = "mpeg4 (Advanced Coding Profile)";
            if (key.Contains("mpeg4 (DX50")) key = "mpeg4 (DX50)";
            if (key.Contains("(avc1 / 0x31637661)")) key = key.Replace("(avc1 / 0x31637661)", String.Empty);
            if (key.Contains("h264 (High)")) key = "h264 (High)";
            if (key.Contains("h264 (Main)")) key = "h264 (Main)";
            return key;
        }

        private void BG_Files_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            calc_list_size();
            calc_total_dur();

            total_multi_duration = 0;

            String other_file = Path.Combine(Path.GetTempPath(), "FFBatch_test") + "\\" + "Other_instance.fftmp";
            if (File.Exists(other_file))
            {
                try
                {
                    File.Delete(other_file);
                }
                catch { }
            }

            calc_total_dur();
            calc_list_size();

            group_prog.Focus();
            btn_cancel_add.Enabled = true;
            btn_cancel_add.Visible = true;
            btn_cancel_add.Refresh();

            if (canceled_file_adding == false)
            {
                canceled_add = false;
                if (change_tab_1 == true)
                {
                    change_tab_1 = false;
                    tabControl1.SelectedIndex = 0;
                    tabControl1.SelectedIndex = 1;
                }
            }
            else
            {
                canceled_add = true;

                if (change_tab_1 == true)
                {
                    change_tab_1 = false;
                    tabControl1.SelectedIndex = 0;
                }
            }

            BG_P_Dur.RunWorkerAsync();            

            listView1.EndUpdate();
            btn_undo_filter.Enabled = false;
            Boolean has_vcodec = false;
            if (from_wizard == true)
            {
                btn_wizard.Enabled = true;
                btn_wizard.PerformClick();
                from_wizard = false;
            }
        }

        private void change_tab()
        {
            if (change_tab_1 == true)
            {
                tabControl1.SelectedIndex = 0;
                tabControl1.SelectedIndex = 1;
            }
            if (change_tab_2 == true)
            {
                tabControl1.SelectedIndex = 0;
                tabControl1.SelectedIndex = 2;
            }
        }

        private void calc_total_dur()
        {
            Double Total_dur = 0;
            foreach (ListViewItem item in listView1.Items)

                if (item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                {
                    try
                    {
                        Total_dur = Total_dur + TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds;
                    }
                    catch (System.Exception)
                    {
                        item.SubItems[3].Text = FFBatch.Properties.Strings.n_a;
                        if (Properties.Settings.Default.dark_mode == true)
                        {
                            item.BackColor = Color.FromArgb(255, 128, 128, 128);
                        }
                        else item.BackColor = Color.LightGoldenrodYellow;
                    }
                }

            TimeSpan t = TimeSpan.FromSeconds(Total_dur);
            String dur = string.Format("{0:D2}h:{1:D2}m:{2:D2}s.{3:D3}ms",
                     (int)t.TotalHours,
                     t.Minutes,
                     t.Seconds,
                     t.Milliseconds);
            lbl_dur_list.Text = dur.Substring(0, 11);
        }

        private void BG_P_Dur_DoWork(object sender, DoWorkEventArgs e)
        {
            //PAUSE while parsing

            if (working == true)
            {
                paused = true;
                int tab = 0;
                tabControl1.Invoke(new MethodInvoker(delegate
                {
                    tab = tabControl1.SelectedIndex;
                }));

                if (tab == 0)
                {
                    listView1.Invoke(new MethodInvoker(delegate
                    {
                        foreach (ListViewItem item in listView1.Items)
                        {
                            if (working == true && multi_running == false)
                            {
                                process_glob.Suspend();
                            }
                        }
                    }));

                    if (working == true && multi_running == true)
                    {
                        foreach (Process proc in procs.Values)
                        {
                            try
                            {
                                proc.Suspend();
                            }
                            catch { }
                        }
                    }
                }

                if (tab == 1)
                {
                    if (working == true && multi_running == false) process_glob.Suspend();
                }
                else if (tab == 2)
                {
                    foreach (ListViewItem item in listView3.Items)
                    {
                        if (working == true) process_glob.Suspend();
                    }
                }
                else if (tab == 3)
                {
                    foreach (DataGridViewRow row in dg1.Rows)
                    {
                        if (m3u_running == true && m3u_single_running == true)
                        {
                            process_glob.Suspend();
                        }
                    }

                    if (m3u_running == true && m3u_single_running == false)
                    {
                        foreach (Process proc in procs.Values)
                        {
                            try
                            {
                                proc.Suspend();
                            }
                            catch
                            {
                            }
                        }
                    }
                }

                this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.Paused));
            }

            //END PAUSE ENCODING, PENDING RESUME
            tried_params.Clear();
            list_not_empty = listView1.Items.Count > 0;

            if (list_not_empty == true)
            {
                pending_dur = 0;
                listView1.Invoke(new MethodInvoker(delegate
                {
                    foreach (ListViewItem item in listView1.Items)
                    {
                        if (item.SubItems[3].Text == FFBatch.Properties.Strings.pending)
                        {
                            pending_dur = pending_dur + 1;
                        }
                    }
                }));
            }

            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.parsing2 + " " + pending_dur + " " + FFBatch.Properties.Strings.files);
            this.InvokeEx(f => f.LB_Wait.Refresh());
            this.InvokeEx(f => f.pg_adding.Maximum = pending_dur);
            Process probe = new Process();

            int tbit_col = 0;

            foreach (ColumnHeader col in listView1.Columns)
            {
                if (col.Text.Contains(Properties.Strings2.bitrate))
                {
                    listView1.Invoke(new MethodInvoker(delegate
                    {
                        tbit_col = col.Index;
                    }));
                }
            }

                    this.InvokeEx(f => f.listView1.BeginUpdate());

            for (int i = 0; i < listView1.Items.Count; i++)
            {
                if (canceled_add == false)
                {
                    listView1.Invoke(new MethodInvoker(delegate
                    {
                        if (listView1.Items[i].SubItems[3].Text == FFBatch.Properties.Strings.pending)
                        {
                            this.InvokeEx(f => f.pg_adding.Value = pg_adding.Value + 1);
                            this.InvokeEx(f => f.txt_adding_p.Text = (pg_adding.Value * 100 / pending_dur + "%"));
                            this.InvokeEx(f => f.txt_adding_p.Refresh());
                            this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, pg_adding.Value * 100 / pending_dur, 100));

                            probe.StartInfo.RedirectStandardOutput = true;
                            probe.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
                            String ffprobe_frames = " " + '\u0022' + "--Inform=General;%Duration/String3%" + '\u0022';
                            probe.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + listView1.Items[i].SubItems[1].Text + "\\" + listView1.Items[i].Text + '\u0022';
                            probe.StartInfo.UseShellExecute = false;
                            probe.StartInfo.CreateNoWindow = true;
                            probe.EnableRaisingEvents = true;
                            probe.Start();

                            String duracion = probe.StandardOutput.ReadLine();
                            probe.WaitForExit();

                            if (duracion != null)
                            {
                                TimeSpan time = new TimeSpan();
                                if (TimeSpan.TryParse(duracion, out time))
                                {
                                    this.InvokeEx(f => f.listView1.Items[i].SubItems[3].Text = duracion.Substring(0, 12));

                                    if (duracion.Length >= 12)
                                    {
                                        if (duracion.Substring(0, 11) == "0:00:00.000" || duracion.Substring(0, 12) == "00:00:00.000")
                                        {
                                            invalids = invalids + 1;
                                            listView1.Items[i].BackColor = Color.LightGoldenrodYellow;
                                        }
                                    }
                                }
                                else
                                {
                                    invalids = invalids + 1;
                                    listView1.Items[i].SubItems[3].Text = FFBatch.Properties.Strings.n_a;
                                    listView1.Items[i].BackColor = Color.LightGoldenrodYellow;
                                }
                            }
                            else
                            {
                                invalids = invalids + 1;
                                listView1.Items[i].SubItems[3].Text = FFBatch.Properties.Strings.n_a;
                                listView1.Items[i].BackColor = Color.LightGoldenrodYellow;
                            }
                        }                        
                            if (tbit_col != 0)
                            {
                            Double bytes = 0;
                            try
                            {                            
                                 FileInfo fi = new FileInfo(listView1.Items[i].SubItems[1].Text + "\\" + listView1.Items[i].Text);
                                 Double size = fi.Length;
                                 Double dur = 0;

                                    TimeSpan time;
                                if (TimeSpan.TryParse(listView1.Items[i].SubItems[3].Text, out time))
                                {
                                    dur = TimeSpan.Parse(listView1.Items[i].SubItems[3].Text).TotalSeconds;
                                    if (dur > 0) bytes = Math.Round((size / dur * 8 / 1000), 0);
                                    else bytes = 0;
                                }  

                                    String subit = "";
                                    if (bytes >= 1000000) subit = (bytes / 1000000).ToString("#,##0.0") + " " + "Gb/s";
                                    else if (bytes >= 10000 && bytes < 1000000)
                                    subit = (bytes / 1000).ToString("#,##0.0") + " " + "Mb/s";
                                    else if (bytes < 10000) subit = bytes.ToString("#,##0") + " " + "Kb/s";
                                    else if (bytes == 0 || bytes > 100000000000000) subit = "0 Kb/s";
                                listView1.Items[i].SubItems[tbit_col].Text = subit;
                            }
                            catch { listView1.Items[i].SubItems[tbit_col].Text = "0 Kb/s"; }
                        }
                     
                    }));                    
                }
            }
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
            Boolean is_LV1 = false;
            tabControl1.Invoke(new MethodInvoker(delegate
            {
                if (tabControl1.SelectedIndex == 0) is_LV1 = true;
            }));

            dur_ok = !canceled_add;

            this.InvokeEx(f => f.lbl_items.Text = listView1.Items.Count + " " + FFBatch.Properties.Strings.files);
            this.InvokeEx(f => f.LB_Wait.Text = "");
            this.InvokeEx(f => f.txt_adding_p.Visible = false);

            this.InvokeEx(f => f.lbl_dur_list.Refresh());

            this.InvokeEx(f => f.listView1.EndUpdate());
            this.InvokeEx(f => f.Enable_Controls());
            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + "00h:00m:00s");
            this.InvokeEx(f => f.chkshut.Enabled = true);
            this.InvokeEx(f => f.btn_pause.Enabled = true);
            this.InvokeEx(f => f.btn_pause.Enabled = true);
            this.InvokeEx(f => f.btn_abort_all.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Text = "");
            this.InvokeEx(f => f.txt_adding_p.Visible = false);
            this.InvokeEx(f => f.lbl_items.Visible = true);
            this.InvokeEx(f => f.lbl_dur_list.Visible = true);
            this.InvokeEx(f => f.lbl_size.Visible = true);
            this.InvokeEx(f => f.pg_adding.Visible = false);
            this.InvokeEx(f => f.LB_Wait.Visible = false);

            this.InvokeEx(f => f.tabControl1.Enabled = true);
            this.InvokeEx(f => f.listView1.EndUpdate());
            pop_invalids = false;
            if (invalids > 0 && is_LV1 == true && initial_tab != 2)
            {
                pop_invalids = true;
            }
        }

        private void BG_P_Dur_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            //RESUME

            int tab = 0;
            this.InvokeEx(f => f.btn_cancel_add.Visible = false);

            //listView1.Invoke(new MethodInvoker(delegate
            //{
            //    foreach (ListViewItem item in listView1.Items)
            //    {
            //    foreach (ColumnHeader col in listView1.Columns)
            //    {
            //        if (col.Text.Contains(Properties.Strings2.bitrate))
            //        {
            //                try
            //                {
            //                    FileInfo fi = new FileInfo(item.SubItems[1].Text + "\\" + item.Text);
            //                    Double size = fi.Length;
            //                    //String size = fi.Length.ToString("D13");
            //                    Double dur = TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds;
            //                    String bitr = Math.Round((size / dur * 8 / 1000), 0).ToString();
            //                    item.SubItems[col.Index].Text = bitr + " Kb/s";
            //                }
            //                catch { item.SubItems[col.Index].Text = "-"; }
            //        }
            //    }
            //}
            //}));

            tabControl1.Invoke(new MethodInvoker(delegate
            {
                tab = tabControl1.SelectedIndex;
            }));

            paused = false;
            if (tab == 0)
            {
                foreach (ListViewItem item in listView1.Items)
                {
                    if (working == true && multi_running == false)
                    {
                        process_glob.Resume();
                    }
                }
                if (working == true && multi_running == true)
                {
                    foreach (Process proc in procs.Values)
                    {
                        try
                        {
                            proc.Resume();
                        }
                        catch { }
                    }
                }
            }

            if (tabControl1.SelectedIndex == 1)
            {
                if (working == true) process_glob.Resume();
            }
            else if (tabControl1.SelectedIndex == 2)
            {
                foreach (ListViewItem item in listView3.Items)
                {
                    if (working == true) process_glob.Resume();
                }
            }
            else if (tabControl1.SelectedIndex == 3)
            {
                foreach (DataGridViewRow row in dg1.Rows)
                {
                    if (m3u_single_running == true && m3u_running == true)
                    {
                        process_glob.Resume();
                    }
                }

                if (m3u_single_running == false && m3u_running == true)
                {
                    foreach (Process proc in procs.Values)
                    {
                        try
                        {
                            proc.Resume();
                        }
                        catch { }
                    }
                }
            }

            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.Normal));

            //END RESUME
            calc_total_dur();
            this.InvokeEx(f => this.Cursor = Cursors.Arrow);
            if (pop_invalids == true && no_warn_0_dur == false)
            {
                Form7 form_added = new Form7();
                form_added.pic_clean.Image = btn_clean_list.Image;
                form_added.label1.Text = listView1.Items.Count + " " + FFBatch.Properties.Strings.files;
                form_added.label2.Text = invalids + " " + FFBatch.Properties.Strings.files;

                if (listView1.Items.Count > 10 && listView1.Items.Count < 100)
                {
                    form_added.label4.Left = form_added.label4.Left + 8;
                }

                if (listView1.Items.Count >= 100 && listView1.Items.Count < 1000)
                {
                    form_added.label4.Left = form_added.label4.Left + 18;
                }

                if (listView1.Items.Count >= 1000 && listView1.Items.Count < 10000)
                {
                    form_added.label4.Left = form_added.label4.Left + 27;
                }
                if (listView1.Items.Count > 10000)
                {
                    form_added.label4.Left = form_added.label4.Left + 36;
                }

                if (invalids > 10 && invalids < 100)
                {
                    form_added.label5.Left = form_added.label5.Left + 8;
                }

                if (invalids >= 100 && invalids < 1000)
                {
                    form_added.label5.Left = form_added.label5.Left + 18;
                }

                if (invalids >= 1000 && invalids < 10000)
                {
                    form_added.label5.Left = form_added.label5.Left + 27;
                }
                if (invalids > 10000)
                {
                    form_added.label5.Left = form_added.label5.Left + 36;
                }

                form_added.ShowDialog();
                form_added.Refresh();
            }

            if (change_tab_1 == true)
            {
                if (listView1.Items.Count > 200)
                {
                    var a = MessageBox.Show(FFBatch.Properties.Strings.streams_f + " " + listView1.Items.Count + " " + FFBatch.Properties.Strings.some_time, FFBatch.Properties.Strings.many_parsed, MessageBoxButtons.OKCancel, MessageBoxIcon.Question);
                    if (a == DialogResult.Cancel)
                    {
                        tabControl1.SelectedIndex = 0;
                        return;
                    }
                }
                add_to_tab_2();
            }

            if (change_tab_2 == true)
            {
                tabControl1.SelectedIndex = 0;
                tabControl1.SelectedIndex = 2;
            }

            if (working == true)
            {
                Disable_Controls();
                timer_tasks.Start();
                btn_add_files.Enabled = true;
                btn_add_folders.Enabled = true;
                btn_skip_main.Enabled = true;
                chk_subfolders.Enabled = true;

                if (runnin_n_presets == true)
                {
                    btn_add_files.Enabled = true;
                    btn_add_folders.Enabled = true;
                    btn_skip_main.Enabled = true;
                }

                panel2.Enabled = true;
                chk_delete_source.Enabled = true;
                foreach (Control ct in panel2.Controls)
                {
                    if (ct.Name != chk_delete_source.Name)
                    {
                        this.InvokeEx(f => ct.Enabled = false);
                    }
                }
                total_duration = 0;

                foreach (ListViewItem item in listView1.Items)
                {
                    if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                    {
                        total_duration = total_duration + TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds - TimeSpan.Parse(ss_time_input.Text).TotalSeconds;
                    }
                    else
                    {
                        total_duration = total_duration + 0;
                    }
                }
            }
            btn_undo_filter.Enabled = false;
            if (tab == 0 && listView1.Items.Count == 1)
            {
                listView1.Items[0].Selected = true;
            }
            if (tab == 0 && listView1.Items.Count > 1)
            {
                get_all_thumbs();
            }
            if (start_seq == true) btn_seq.PerformClick();
            if (start_multi == true) btn_multi_m.PerformClick();
        }

        private void add_to_tab_2()
        {
            listView2.Clear();            
            listView2.BeginUpdate();
            listView2.Columns.Add(FFBatch.Properties.Strings.filename, 450);
            listView2.SmallImageList = listView1.SmallImageList;
            foreach (ListViewItem item in listView1.Items)
            {
                //Bad
                this.Cursor = Cursors.WaitCursor;
                ListViewItem elemento = new ListViewItem(item.SubItems[1].Text + "\\" + item.Text, 1);
                //Begin get file icon
                Icon iconForFile = SystemIcons.WinLogo;

                if (!elemento.Text.Contains("\\\\"))
                {
                    if (!imageList2.Images.ContainsKey(System.IO.Path.GetExtension(elemento.Text)))
                    {
                        iconForFile = System.Drawing.Icon.ExtractAssociatedIcon(elemento.Text);
                        this.InvokeEx(f => f.imageList2.Images.Add(System.IO.Path.GetExtension(elemento.Text), iconForFile));
                    }
                }

                if (!elemento.Text.Contains("\\\\"))
                {
                    elemento.ImageKey = System.IO.Path.GetExtension(elemento.Text);
                }
                else
                {
                    elemento.ImageIndex = 0;
                }

                listView2.Items.Add(elemento);               
            }

            foreach (ListViewItem item in listView2.Items)
            {
                Process ff_str = new Process();
                ff_str.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");
                ff_str.StartInfo.Arguments = " -i " + '\u0022' + item.Text + '\u0022';
                ff_str.StartInfo.RedirectStandardOutput = true;
                ff_str.StartInfo.RedirectStandardError = true;
                ff_str.StartInfo.UseShellExecute = false;
                ff_str.StartInfo.CreateNoWindow = true;
                ff_str.EnableRaisingEvents = true;
                ff_str.Start();
                String stream = "";
                String sub_str = "";
                int c = 0;
                Boolean has_stream = false;
                while (!ff_str.StandardError.EndOfStream)
                {
                    stream = ff_str.StandardError.ReadLine();

                    if (stream.Contains("Stream #0:"))
                    {
                        has_stream = true;
                        c = c + 1;
                        if (listView2.Columns.Count <= c)
                        {
                            listView2.Columns.Add(FFBatch.Properties.Strings.stream + " " + c, 150);
                        }

                        if (stream.Substring(stream.IndexOf("#0:") + 4, 1) == "(")
                        {
                            if (stream.Substring(stream.IndexOf("#0:") + 4, 5) == "(und)" || stream.Substring(stream.IndexOf("#0:") + 4, 5) == "(unk)")
                            {
                                sub_str = stream.Substring(0, stream.LastIndexOf("#0:") + 11);
                                item.SubItems.Add(stream.Substring((stream.LastIndexOf("#0:") + 11), (stream.Length - sub_str.Length)));
                            }
                            else
                            {
                                sub_str = stream.Substring(0, stream.LastIndexOf("#0:") + 4);
                                item.SubItems.Add(stream.Substring((stream.LastIndexOf("#0:") + 4), (stream.Length - sub_str.Length)));
                            }
                        }
                        else
                        {
                            if (stream.Contains("Video"))
                            {
                                sub_str = stream.Substring(0, stream.LastIndexOf("#0:") + 6);
                                item.SubItems.Add(stream.Substring((stream.LastIndexOf("#0:") + 6), (stream.Length - sub_str.Length)));
                            }
                            if (stream.Contains("Audio"))
                            {
                                sub_str = stream.Substring(0, stream.LastIndexOf("#0:") + 6);
                                item.SubItems.Add(stream.Substring((stream.LastIndexOf("#0:") + 6), (stream.Length - sub_str.Length)));
                            }
                            if (stream.Contains("Subtitle"))
                            {
                                sub_str = stream.Substring(0, stream.LastIndexOf("#0:") + 6);
                                item.SubItems.Add(stream.Substring((stream.LastIndexOf("#0:") + 6), (stream.Length - sub_str.Length)));
                            }
                        }
                    }
                }

                ff_str.WaitForExit();
                if (has_stream == false)
                {
                    item.SubItems.Add(FFBatch.Properties.Strings.no_streams1);
                }
            }           

            listView2.EndUpdate();            
            this.Cursor = Cursors.Arrow;
            
            if (listView2.Items.Count == 1)
            {
                listView2.Items[0].Selected = true;
                ct2_all.PerformClick();
                tracks_background();
            }
        }

        private void avoid_overw()
        {
            avoid_overwriting = false;
            if (listView1.Items.Count < 2) return;
            int i = 0;
            foreach (ListViewItem item in listView1.Items)
            {
                if (Path.GetDirectoryName(item.Text) != Path.GetDirectoryName(listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text))
                {
                    avoid_overwriting = true;
                    return;
                }
                i = i + 1;
            }
        }

        private void button19_Click_1(object sender, EventArgs e)
        {
            Pg1.Focus();
            dg1.Rows.Clear();
            pic_frame.Image = pic_frame.InitialImage;
            lbl_urls_time.Text = "";
        }

        private void open_file_m3u_FileOk(object sender, CancelEventArgs e)
        {
            FileInfo fl = new FileInfo(open_file_m3u.FileName);
            if (fl.Length > 10485760)
            {
                MessageBox.Show(FFBatch.Properties.Strings.file_big, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            dg1.Rows.Clear();
            Array.Clear(lines_txt_m3u, 0, lines_txt_m3u.Length);
            stop_validating_url = false;
            opening_youtubes = false;
            String[] lines = File.ReadAllLines(open_file_m3u.FileName);
            lines_txt_m3u = lines;
            dg1.SuspendLayout();
            BG_pre_validate_url_txt.RunWorkerAsync();
        }

        private void post_file_url()
        {
            if (adding_youtube == false)
            {
                //String[] lines = File.ReadAllLines(open_file_m3u.FileName);

                if (lines_txt_m3u.Length > 4000)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.max_links, FFBatch.Properties.Strings.max_list, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                List<Image> images = new List<Image>();
                Boolean has_img = false;
                Boolean has_m3u = false;

                for (int i = 0; i <= lines_txt_m3u.Count() - 1; i++)
                {
                    if (lines_txt_m3u[i].ToLower().Contains("youtu.be") || lines_txt_m3u[i].ToLower().Contains("youtube.com"))
                    {
                        adding_youtube = true;
                    }
                    else
                    {
                        has_m3u = true;
                    }
                    if (adding_youtube == true && has_m3u == true)
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.mix_urls2, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                        return;
                    }
                }

                for (int i = 0; i <= lines_txt_m3u.Count() - 1; i++)
                {
                    String out_file = String.Empty;
                    lines_txt_m3u[i] = lines_txt_m3u[i].Trim();
                    if (lines_txt_m3u[i] == String.Empty) continue;

                    if (lines_txt_m3u[i].ToLower().Contains("youtu.be") || lines_txt_m3u[i].ToLower().Contains("youtube.com"))
                    {
                        adding_youtube = true;
                        break;
                    }

                    PictureBox pic = new PictureBox();
                    int l = 0;
                    String img_m3u = String.Empty;

                    if (lines_txt_m3u[i].Contains("tvg-logo=") && has_img == false)
                    {
                        l = lines_txt_m3u[i].Substring(0, lines_txt_m3u[i].IndexOf("tvg-logo=")).Length;
                        img_m3u = lines_txt_m3u[i].Substring(l + 10, lines_txt_m3u[i].Length - l - 10);
                        img_m3u = img_m3u.Substring(0, img_m3u.IndexOf('\u0022'));

                        try
                        {
                            pic.Load(img_m3u);
                            images.Add(pic.Image);
                            has_img = true;
                            continue;
                        }
                        catch
                        {
                            images.Clear();
                            has_img = false;
                            continue;
                        }
                    }
                    else
                    {
                    }

                    if (!lines_txt_m3u[i].ToString().Contains("#EXTM3U") && !lines_txt_m3u[i].ToString().Contains("#EXTINF") && (lines_txt_m3u[i].Substring(0, 4).ToLower() == "http" || lines_txt_m3u[i].Substring(0, 5).ToLower() == "https"))
                    {
                        if (i >= 0)
                        {
                            out_file = Path.GetFileNameWithoutExtension(lines_txt_m3u[i]);
                            if (has_img == true)
                            {
                                dg1.Rows.Add(images[0], lines_txt_m3u[i], "", "", out_file, "");
                                dg_thumbs[dg1.RowCount - 1] = images[0];
                                has_img = false;
                                images.Clear();
                            }
                            else
                            {
                                dg1.Rows.Add(pic_noimg.Image, lines_txt_m3u[i], "", "", out_file, "");
                                dg_thumbs[dg1.RowCount - 1] = pic_noimg.Image;
                            }
                        }
                    }
                }
            }

            if (adding_youtube == true)
            {
                //String[] lines_txt_m3u = File.ReadAlllines_txt_m3u(open_file_m3u.FileName);
                if (lines_txt_m3u.Length > 2000)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.max_links, FFBatch.Properties.Strings.max_list, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                for (int i = 0; i <= lines_txt_m3u.Count() - 1; i++)
                {
                    String out_file = String.Empty;

                    lines_txt_m3u[i] = lines_txt_m3u[i].Trim();
                    if (lines_txt_m3u[i] == "") continue;

                    if (lines_txt_m3u[i].ToLower().Contains("youtu.be") || lines_txt_m3u[i].ToLower().Contains("youtube.com"))
                    {
                        if (i >= 0)
                        {
                            out_file = Path.GetFileNameWithoutExtension(lines_txt_m3u[i]);
                            dg1.Rows.Add(pic_noimg.Image, lines_txt_m3u[i], "", "", out_file, "");
                        }
                    }
                }
            }

            foreach (DataGridViewRow row in dg1.Rows)
            {
                row.ReadOnly = true;
            }
            foreach (Control ct in groupBox_m3u.Controls)
            {
                ct.Enabled = false;
            }
            btn_cancel_validate.Enabled = true;
            Boolean has_playlist = false;
            foreach (DataGridViewRow row in dg1.Rows)
            {
                if (row.Cells[1].Value.ToString().ToLower().Contains("playlist"))
                {
                    has_playlist = true;
                    break;
                }
            }

            clean_imgs();

            if (adding_youtube == false)
            {
                BG_Validate_URLs.RunWorkerAsync();
            }
            else
            {
                if (has_playlist == true)
                {
                    foreach (DataGridViewRow row in dg1.Rows)
                    {
                        row.ReadOnly = false;
                    }
                    foreach (Control ct in groupBox_m3u.Controls)
                    {
                        ct.Enabled = true;
                    }

                    BG_Validate_PLSS.RunWorkerAsync();
                }
                else
                {
                    BG_Validate_URLs_YT.RunWorkerAsync();
                }
            }
        }

        private void clean_imgs()
        {
            for (int i = 0; i == 1000; i++) dg_thumbs[i] = null;
        }

        private void button31_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            adding_youtube = false;
            open_file_m3u.Filter = FFBatch.Properties.Strings.links + " " + " | *.m3u; *.m3u8; *.txt| " + FFBatch.Properties.Strings.all_files + "  (*.*) | *.*";
            open_file_m3u.ShowDialog();
        }

        private void validate_gen_link()
        {
            Boolean one_ok = false;

            dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.var_url;

            if (dg1.Rows[dg1.RowCount - 1].Cells[1].Value == null)
            {
                dg1.Rows[dg1.RowCount - 1].Cells[5].Value = String.Empty;
                dg1.Rows[dg1.RowCount - 1].Cells[4].Value = String.Empty;
                dg1.Rows[dg1.RowCount - 1].Cells[3].Value = String.Empty;
                dg1.Rows[dg1.RowCount - 1].Cells[2].Value = String.Empty;
                //dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor;
                return;
            }

            if (dg1.Rows[dg1.RowCount - 1].Cells[1].Value.ToString().Contains("http") == false)
            {
                dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.error;
                dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = Color.LightGoldenrodYellow;
                return;
            }

            dg1.Refresh();
            cell_zoom();

            Process probe = new Process();
            probe.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe");
            if (!File.Exists(System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.yt_not, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                release_datagrid();
                return;
            }
            probe.StartInfo.WorkingDirectory = Application.StartupPath;
            probe.StartInfo.Arguments = "--get-duration --get-title --get-thumbnail " + dg1.Rows[dg1.RowCount - 1].Cells[1].Value.ToString();
            probe.StartInfo.RedirectStandardOutput = true;
            probe.StartInfo.UseShellExecute = false;
            probe.StartInfo.CreateNoWindow = true;
            probe.EnableRaisingEvents = true;
            probe.Start();

            String filename = "";
            String out_thumb = "";
            String duracion = "";

            while (!probe.StandardOutput.EndOfStream)
            {
                filename = probe.StandardOutput.ReadLine();
                out_thumb = probe.StandardOutput.ReadLine();
                duracion = probe.StandardOutput.ReadLine();
            }

            PictureBox pic = new PictureBox();
            if (out_thumb != null)
            {
                if (out_thumb.Contains("http"))
                {
                    try
                    {
                        if (out_thumb.Contains("?")) out_thumb = out_thumb.Substring(0, out_thumb.IndexOf("?"));
                        new System.Threading.Thread(() =>
                        {
                            System.Threading.Thread.CurrentThread.IsBackground = true;
                            pic.Load(out_thumb);
                            dg_thumbs[dg1.RowCount - 1] = pic.Image;
                            dg1.Invoke(new MethodInvoker(delegate
                            {
                                dg1.Rows[dg1.RowCount - 1].Cells[0].Value = pic.Image;
                                pic_frame.Image = dg_thumbs[dg1.RowCount - 1];
                                if (pic_frame.Image == null) pic_frame.Image = pic_frame.InitialImage;
                                lbl_a_th.Text = "-";
                                lbl_s_th.Text = "-";
                                lbl_v_th.Text = "-";
                                lbl_gb_th.Text = "-";
                            }));
                        }).Start();
                    }
                    catch
                    {
                        dg_thumbs[dg1.RowCount - 1] = pic_noimg.Image;
                    }
                }
            }
            else
            {
                dg_thumbs[dg1.RowCount - 1] = pic_noimg.Image;
            }
            //cell_stretch();

            probe.WaitForExit(10000);
            probe.StartInfo.Arguments = "";

            if (duracion == null || duracion == string.Empty)
            {
                dg1.Invoke(new MethodInvoker(delegate
                {
                    dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = Color.LightGoldenrodYellow;
                    dg1.Rows[dg1.RowCount - 1].Cells[2].Value = Properties.Strings.n_a;
                    dg1.Rows[dg1.RowCount - 1].Cells[3].Value = "\u221E";
                    int index_length = dg1.Rows[dg1.RowCount - 1].Cells[1].Value.ToString().Length;

                    if (dg1.Rows[dg1.RowCount - 1].Cells[1].Value.ToString().Substring(index_length - 1, 1) == "/")
                    {
                        dg1.Rows[dg1.RowCount - 1].Cells[1].Value = dg1.Rows[dg1.RowCount - 1].Cells[1].Value.ToString().Substring(0, index_length - 1);
                        index_length = index_length - 1;
                    }

                    int index_fn = dg1.Rows[dg1.RowCount - 1].Cells[1].Value.ToString().LastIndexOf("/");
                    int ind_final = index_length - index_fn;
                    String dest = dg1.Rows[dg1.RowCount - 1].Cells[1].Value.ToString().Substring(index_fn + 1, ind_final - 1);
                    dg1.Rows[dg1.RowCount - 1].Cells[4].Value = dest;
                    if (Properties.Settings.Default.dark_mode == false)
                    {
                        dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor;
                    }
                    else dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = Color.FromArgb(255, 96, 96, 96);
                    dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.ready;
                }));
            }

            if (duracion != null && filename != "")
            {
                dg1.Invoke(new MethodInvoker(delegate
                {
                    if (duracion == "0")
                    {
                        dg1.Rows[dg1.RowCount - 1].Cells[2].Value = duracion;
                        dg1.Rows[dg1.RowCount - 1].Cells[3].Value = "Live";
                    }
                    else
                    {
                        if (duracion.Length < 6) duracion = "00:" + duracion;
                        dg1.Rows[dg1.RowCount - 1].Cells[2].Value = duracion;
                        dg1.Rows[dg1.RowCount - 1].Cells[3].Value = duracion;
                    }
                    dg1.Rows[dg1.RowCount - 1].Cells[4].Value = filename;
                    if (Properties.Settings.Default.dark_mode == false)
                    {
                        dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor;
                    }
                    else dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = Color.FromArgb(255, 96, 96, 96);
                    one_ok = true;
                    dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.ready;
                    this.InvokeEx(f => f.dg1.Rows[dg1.RowCount - 1].Cells[5].Style.BackColor = Color.LightGreen);
                }));
            }

            if (dg1.RowCount > 1)
            {
                dg1.ClearSelection();
                dg1.Rows[dg1.RowCount - 1].Cells[1].Selected = true;
                dg1.CurrentCell = dg1.Rows[dg1.RowCount - 1].Cells[1];
            }
            urls_duration();
            if (one_ok == true)
            {
                chk_m3u_params.Left = 14;
                chk_output_server.Enabled = false;
                chk_m3u_params.Text = FFBatch.Properties.Strings.yt_params;
            }
            this.Enabled = true; release_datagrid();
            dg1.Rows[dg1.RowCount - 1].Cells[1].Selected = true;
        }

        private void Validate_added_row()
        {
            if (dg1.Rows[dg1.RowCount - 1].Cells[1].Value.ToString().ToLower().Contains("m3u") == false)
            {
                validate_gen_link();
                return;
            }

            dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.var_url;

            if (dg1.Rows[dg1.RowCount - 1].Cells[1].Value == null)
            {
                dg1.Rows[dg1.RowCount - 1].Cells[5].Value = String.Empty;
                dg1.Rows[dg1.RowCount - 1].Cells[4].Value = String.Empty;
                dg1.Rows[dg1.RowCount - 1].Cells[3].Value = String.Empty;
                dg1.Rows[dg1.RowCount - 1].Cells[2].Value = String.Empty;
                //dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor;
                return;
            }

            if (dg1.Rows[dg1.RowCount - 1].Cells[1].Value.ToString().Contains("http") == false)
            {
                dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.error;
                dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = Color.LightGoldenrodYellow;
                return;
            }

            dg1.Refresh();

            Process probe = new Process();
            List<string> lines_ouput = new List<string>();
            String duracion = "00:00:00";
            probe.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");
            probe.StartInfo.Arguments = "-i " + " " + '\u0022' + dg1.Rows[dg1.RowCount - 1].Cells[1].Value.ToString() + '\u0022';

            probe.StartInfo.RedirectStandardError = true;
            probe.StartInfo.UseShellExecute = false;
            probe.StartInfo.CreateNoWindow = true;
            probe.EnableRaisingEvents = true;

            probe.Start();

            while (!probe.StandardError.EndOfStream)
            {
                lines_ouput.Add(probe.StandardError.ReadLine());
            }
            foreach (string str in lines_ouput)
            {
                if (str.ToLower().Contains("duration:"))
                {
                    duracion = str.ToLower().Trim();
                    break;
                }
            }
            int dur_start = duracion.IndexOf("duration: ") + 10;
            int dur_end = duracion.IndexOf(",") - 10;
            duracion = duracion.Substring(dur_start, dur_end);
            //MessageBox.Show(duracion);

            probe.WaitForExit(10000);

            if (duracion == null)
            {
                dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.error;
                dg1.Rows[dg1.RowCount - 1].Cells[5].Style.BackColor = Color.LightGoldenrodYellow;
                return;
            }

            if (duracion != null)
            {
                TimeSpan time;
                if (TimeSpan.TryParse(duracion, out time))
                {
                    dg1.Rows[dg1.RowCount - 1].Cells[2].Value = duracion;
                    dg1.Rows[dg1.RowCount - 1].Cells[3].Value = duracion;
                    dg1.Rows[dg1.RowCount - 1].Cells[4].Value = Path.GetFileNameWithoutExtension(dg1.Rows[dg1.RowCount - 1].Cells[1].Value.ToString()) + "_FF" + (dg1.RowCount).ToString();
                    dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.ready;
                    //dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor;

                    if (duracion.Length >= 12)
                    {
                        if (duracion.Substring(0, 11) == "0:00:00.000" || duracion.Substring(0, 12) == "00:00:00.000")
                        {
                            //dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor;
                            dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.ready;
                        }
                    }
                }

                if (duracion == FFBatch.Properties.Strings.n_a)
                {
                    dg1.Rows[dg1.RowCount - 1].Cells[2].Value = FFBatch.Properties.Strings.n_a;
                    dg1.Rows[dg1.RowCount - 1].Cells[3].Value = "\u221E";
                    dg1.Rows[dg1.RowCount - 1].Cells[4].Value = Path.GetFileNameWithoutExtension(dg1.Rows[dg1.RowCount - 1].Cells[1].Value.ToString()) + "_FF" + (dg1.RowCount - 1).ToString();
                    //dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor;
                    dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.ready;
                }
            }
            urls_duration();
        }

        private void Validate_added_row_YT_PL()
        {
            if (!File.Exists(System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.yt_not, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                release_datagrid();
                return;
            }
            this.Enabled = false;
            List<string> list_lines = new List<string>();
            Form11 frm_prog = new Form11();

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;
                frm_prog.ShowDialog();
                frm_prog.Refresh();
            }).Start();

            Task t2 = Task.Run(() =>
            {
                Process probe = new Process();
                probe.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe");
                probe.StartInfo.WorkingDirectory = Application.StartupPath;
                probe.StartInfo.Arguments = "--flat-playlist --dump-json " + pl_url;
                probe.StartInfo.RedirectStandardOutput = true;
                probe.StartInfo.UseShellExecute = false;
                probe.StartInfo.StandardOutputEncoding = Encoding.UTF8;
                probe.StartInfo.CreateNoWindow = true;
                probe.EnableRaisingEvents = true;

                probe.Start();

                while (!probe.StandardOutput.EndOfStream)
                {
                    if (frm_prog.abort_validate == false)
                    {
                        list_lines.Add(probe.StandardOutput.ReadLine());
                    }
                    else
                    {
                        probe.StandardOutput.ReadToEnd();
                    }
                }
                //foreach (String str in list_lines) MessageBox.Show(str);
                probe.WaitForExit();
                try
                {
                    frm_prog.Invoke(new MethodInvoker(delegate
                    {
                        frm_prog.Dispose();
                    }));
                }
                catch { }
            });

            t2.Wait();

            if (frm_prog.abort_validate == false)
            {
                if (list_lines.Count > 2000)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.max_links, FFBatch.Properties.Strings.max_list, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    release_datagrid();
                    this.Enabled = true;
                    return;
                }

                foreach (String lin in list_lines)
                {
                    //if (lin != null && lin != "") dg1.Rows.Add(pic_noimg.Image, "https://www.youtube.com/watch?v=" + lin.Substring(lin.IndexOf('\u0022' + "url" + '\u0022' + ": " + '\u0022') + 8, 11), "-", "-", "", "");
                    if (lin != null && lin != "")
                    {
                        int start = lin.IndexOf('\u0022' + "url" + '\u0022' + ": ");
                        int end = lin.IndexOf(", " + '\u0022' + "title" + '\u0022' + ": ");
                        String url = lin.Substring(start + 8, 43);

                        dg1.Rows.Add(pic_noimg.Image, url, "-", "-", "", "");
                    }
                }
                this.Focus();

                //this.Enabled = false;
                BG_Validate_URLs_YT.RunWorkerAsync();
                this.TopMost = true;
                this.TopMost = false;
            }
            else
            {
                this.Enabled = true;
                release_datagrid();
                this.Focus();
            }
        }

        private void cell_zoom()
        {
            dg1.Invoke(new MethodInvoker(delegate
            {
                for (int i = 0; i < dg1.Columns.Count; i++)
                    if (dg1.Columns[i] is DataGridViewImageColumn)
                    {
                        ((DataGridViewImageColumn)dg1.Columns[i]).ImageLayout = DataGridViewImageCellLayout.Zoom;
                        dg1.Refresh();
                        break;
                    }
                dg1.Refresh();
            }));
        }

        private void Validate_added_row_YT()
        {
            Boolean one_ok = false;

            dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.var_url;

            if (dg1.Rows[dg1.RowCount - 1].Cells[1].Value == null)
            {
                dg1.Rows[dg1.RowCount - 1].Cells[5].Value = String.Empty;
                dg1.Rows[dg1.RowCount - 1].Cells[4].Value = String.Empty;
                dg1.Rows[dg1.RowCount - 1].Cells[3].Value = String.Empty;
                dg1.Rows[dg1.RowCount - 1].Cells[2].Value = String.Empty;
                //dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor;
                return;
            }

            if (dg1.Rows[dg1.RowCount - 1].Cells[1].Value.ToString().Contains("http") == false)
            {
                dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.error;
                dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = Color.LightGoldenrodYellow;
                return;
            }

            dg1.Refresh();
            cell_zoom();

            Process probe = new Process();
            probe.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe");
            if (!File.Exists(System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.yt_not, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                release_datagrid();
                return;
            }
            probe.StartInfo.WorkingDirectory = Application.StartupPath;
            probe.StartInfo.Arguments = "--get-duration --get-title --get-thumbnail " + dg1.Rows[dg1.RowCount - 1].Cells[1].Value.ToString();
            probe.StartInfo.RedirectStandardOutput = true;
            probe.StartInfo.UseShellExecute = false;
            probe.StartInfo.CreateNoWindow = true;
            probe.EnableRaisingEvents = true;
            probe.Start();

            String filename = "";
            String out_thumb = "";
            String duracion = "";

            while (!probe.StandardOutput.EndOfStream)
            {
                filename = probe.StandardOutput.ReadLine();
                out_thumb = probe.StandardOutput.ReadLine();
                duracion = probe.StandardOutput.ReadLine();
            }

            PictureBox pic = new PictureBox();

            if (out_thumb.Contains("http"))
            {
                try
                {
                    if (out_thumb.Contains("?")) out_thumb = out_thumb.Substring(0, out_thumb.IndexOf("?"));
                    new System.Threading.Thread(() =>
                    {
                        System.Threading.Thread.CurrentThread.IsBackground = true;
                        pic.Load(out_thumb);
                        dg_thumbs[dg1.RowCount - 1] = pic.Image;
                        dg1.Invoke(new MethodInvoker(delegate
                        {
                            dg1.Rows[dg1.RowCount - 1].Cells[0].Value = pic.Image;
                            pic_frame.Image = pic.Image;
                            if (pic_frame.Image == null) pic_frame.Image = pic_frame.InitialImage;
                            lbl_a_th.Text = "-";
                            lbl_s_th.Text = "-";
                            lbl_v_th.Text = "-";
                            lbl_gb_th.Text = "-";
                        }));
                    }).Start();
                }
                catch
                {
                    dg_thumbs[dg1.RowCount - 1] = pic_noimg.Image;
                }
            }
            else
            {
                dg_thumbs[dg1.RowCount - 1] = pic_noimg.Image;
            }
            //cell_stretch();

            probe.WaitForExit(10000);
            probe.StartInfo.Arguments = "";

            if (duracion == null || duracion == string.Empty)
            {
                dg1.Invoke(new MethodInvoker(delegate
                {
                    dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = Color.LightGoldenrodYellow;
                    dg1.Rows[dg1.RowCount - 1].Cells[2].Value = "";
                    dg1.Rows[dg1.RowCount - 1].Cells[3].Value = "";
                    //dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor;
                    dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.error;
                    this.InvokeEx(f => f.dg1.Rows[dg1.RowCount - 1].Cells[5].Style.BackColor = Color.LightGoldenrodYellow);
                }));
            }

            if (duracion != null && filename != "")
            {
                dg1.Invoke(new MethodInvoker(delegate
                {
                    if (duracion == "0")
                    {
                        dg1.Rows[dg1.RowCount - 1].Cells[2].Value = duracion;
                        dg1.Rows[dg1.RowCount - 1].Cells[3].Value = "Live";
                    }
                    else
                    {
                        if (duracion.Length < 6) duracion = "00:" + duracion;
                        dg1.Rows[dg1.RowCount - 1].Cells[2].Value = duracion;
                        dg1.Rows[dg1.RowCount - 1].Cells[3].Value = duracion;
                    }
                    dg1.Rows[dg1.RowCount - 1].Cells[4].Value = filename;
                    //dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor;
                    one_ok = true;
                    dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.ready;
                    this.InvokeEx(f => f.dg1.Rows[dg1.RowCount - 1].Cells[5].Style.BackColor = Color.LightGreen);
                }));
            }

            if (dg1.RowCount > 1)
            {
                dg1.ClearSelection();
                dg1.Rows[dg1.RowCount - 1].Cells[1].Selected = true;
                dg1.CurrentCell = dg1.Rows[dg1.RowCount - 1].Cells[1];
            }
            urls_duration();
            if (one_ok == true)
            {
                chk_m3u_params.Left = 14;
                chk_output_server.Enabled = false;
                chk_m3u_params.Text = FFBatch.Properties.Strings.yt_params;
            }
            this.Enabled = true; release_datagrid();
        }

        private void BG_Validate_URLs_DoWork(object sender, DoWorkEventArgs e)
        {
            this.InvokeEx(f => this.Enabled = false);
            cell_zoom();

            dg1.ReadOnly = false;
            m3u_params_checked = chk_m3u_params.Checked;
            output_server_checked = chk_output_server.Checked;
            groupBox_m3u.Invoke(new MethodInvoker(delegate
            {
                foreach (Control ct in groupBox_m3u.Controls)
                {
                    ct.Enabled = true;
                }
            }));

            chk_m3u_params.Invoke(new MethodInvoker(delegate
            {
                if (chk_m3u_params.CheckState == CheckState.Checked)
                {
                    txt_m3u_params.Enabled = true;
                }
                else
                {
                    txt_m3u_params.Enabled = false;
                }
            }));

            chk_output_server.Invoke(new MethodInvoker(delegate
            {
                if (chk_output_server.CheckState == CheckState.Checked)
                {
                    txt_output_server.Enabled = true;
                }
                else
                {
                    txt_output_server.Enabled = false;
                }
            }));

            foreach (DataGridViewRow row in dg1.Rows)
            {
                this.InvokeEx(f => row.ReadOnly = false);
            }

            foreach (Control ct in groupBox_m3u.Controls)
            {
                this.InvokeEx(f => ct.Enabled = false);
            }

            this.InvokeEx(f => f.btn_cancel_validate.Enabled = true);

            procs.Clear();
            for (int ii = 0; ii < dg1.RowCount; ii++)
            {
                procs.Add("proc_urls_" + ii.ToString(), new Process());
            }
            clean_imgs();

            int prog = 0;

            Form9 form_prog2 = new Form9();
            form_prog2.abort_validate = false;

            ParallelOptions par_op = new ParallelOptions();
            System.Threading.CancellationTokenSource cts = new System.Threading.CancellationTokenSource();
            par_op.CancellationToken = cts.Token;
            par_op.MaxDegreeOfParallelism = (int)n_downs.Value;

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;
                form_prog2.StartPosition = FormStartPosition.CenterScreen;
                form_prog2.progressBar1.Style = ProgressBarStyle.Continuous;
                form_prog2.progressBar1.Maximum = dg1.RowCount + 1;
                form_prog2.progressBar1.Value = 1;
                form_prog2.Refresh();
                form_prog2.label1.Text = FFBatch.Properties.Strings.val_m3u;
                form_prog2.lab_count.Text = "1/" + dg1.RowCount;
                form_prog2.lab_count.Refresh();
                form_prog2.Refresh();
                form_prog2.ShowDialog();
                form_prog2.Refresh();
            }).Start();

            var workItems = Enumerable.Range(0, dg1.RowCount);
            int errors = 0;
            fatal_parallel = false;

            ParallelLoopResult result = new ParallelLoopResult();
            try
            {
                result = Parallel.ForEach(workItems.AsParallel().AsOrdered(), par_op, (i) =>
                {
                    if (form_prog2.abort_validate == true)
                    {
                        cancelados_paralelos = true;
                        cts.Cancel();
                    }
                    if (cts.IsCancellationRequested == true) form_prog2.abort_validate = true;

                    if (dg1.Rows[i].Cells[1].Value == null) form_prog2.abort_validate = true;

                    if (stop_validating_url == true) form_prog2.abort_validate = true;

                    if (dg1.Rows[i].Cells[5].Value.ToString() == FFBatch.Properties.Strings.ready || dg1.Rows[i].Cells[5].Value.ToString() == FFBatch.Properties.Strings.processing || dg1.Rows[i].Cells[5].Value.ToString() == FFBatch.Properties.Strings.success)
                    {
                        prog = prog + 1;
                        try
                        {
                            form_prog2.Invoke(new MethodInvoker(delegate
                            {
                                if (form_prog2.progressBar1.Value < form_prog2.progressBar1.Maximum)
                                {
                                    form_prog2.progressBar1.Value = form_prog2.progressBar1.Value + 1;
                                    this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, form_prog2.progressBar1.Value, form_prog2.progressBar1.Maximum));
                                }
                                form_prog2.progressBar1.Refresh();
                                form_prog2.lab_count.Text = (prog).ToString() + "/" + dg1.Rows.Count;
                                form_prog2.lab_count.Refresh();
                            }));
                        }
                        catch { }
                        return;
                    }

                    this.InvokeEx(f => f.dg1.Rows[i].Cells[5].Value = FFBatch.Properties.Strings.var_url);
                    this.InvokeEx(f => f.dg1.Refresh());
                    var tmp = procs["proc_urls_" + i.ToString()];

                    if (dg1.Rows[i].Cells[1].Value.ToString().ToLower().Contains("m3u"))
                    {
                        tmp.StartInfo.RedirectStandardOutput = true;
                        tmp.StartInfo.FileName = Path.Combine(Application.StartupPath, "ffmpeg.exe");
                        tmp.StartInfo.Arguments = "-i " + '\u0022' + dg1.Rows[i].Cells[1].Value.ToString() + '\u0022';
                        tmp.StartInfo.RedirectStandardOutput = true;
                        tmp.StartInfo.RedirectStandardError = true;
                        tmp.StartInfo.UseShellExecute = false;
                        tmp.StartInfo.CreateNoWindow = true;
                        tmp.EnableRaisingEvents = true;

                        String duracion = String.Empty;
                        String std_out = String.Empty;
                        List<string> lines_ouput = new List<string>();

                        if (cts.IsCancellationRequested == false)
                        {
                            tmp.Start();

                            //Check
                            while (!tmp.StandardError.EndOfStream)
                            {
                                lines_ouput.Add(tmp.StandardError.ReadLine());
                            }
                            foreach (string str in lines_ouput)
                            {
                                if (str.ToLower().Contains("duration:"))
                                {
                                    duracion = str.ToLower().Trim();
                                    break;
                                }
                            }
                            int dur_start = duracion.IndexOf("duration: ") + 10;
                            int dur_end = duracion.IndexOf(",") - 10;
                            duracion = duracion.Substring(dur_start, dur_end);

                            tmp.WaitForExit(10000);

                            if (duracion == null) duracion = FFBatch.Properties.Strings.n_a;
                            else
                            {
                                TimeSpan time = new TimeSpan();
                                if (!TimeSpan.TryParse(duracion, out time))
                                {
                                    duracion = FFBatch.Properties.Strings.n_a;
                                }
                            }
                            tmp.StartInfo.Arguments = String.Empty;
                        }
                        else return;

                        prog = prog + 1;

                        form_prog2.Invoke(new MethodInvoker(delegate
                        {
                            if (form_prog2.progressBar1.Value < form_prog2.progressBar1.Maximum)
                            {
                                form_prog2.progressBar1.Value = form_prog2.progressBar1.Value + 1;
                                this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, form_prog2.progressBar1.Value, form_prog2.progressBar1.Maximum));
                            }
                            form_prog2.progressBar1.Refresh();
                            form_prog2.lab_count.Text = (prog).ToString() + "/" + dg1.Rows.Count;
                            form_prog2.lab_count.Refresh();
                        }));

                        if (duracion == null || duracion == string.Empty)
                        {
                            this.InvokeEx(f => f.dg1.Rows[i].Cells[5].Value = FFBatch.Properties.Strings.error);
                            this.InvokeEx(f => f.dg1.Rows[i].Cells[5].Style.BackColor = Color.LightGoldenrodYellow);
                            errors = errors + 1;
                        }

                        if (duracion != null && cts.IsCancellationRequested == false)
                        {
                            TimeSpan time;
                            if (TimeSpan.TryParse(duracion, out time))
                            {
                                this.InvokeEx(f => f.dg1.Rows[i].Cells[2].Value = duracion);
                                this.InvokeEx(f => f.dg1.Rows[i].Cells[3].Value = duracion);
                                this.InvokeEx(f => f.dg1.Rows[i].Cells[4].Value = dg1.Rows[i].Cells[4].Value.ToString() + "_FF" + (i + 1).ToString());
                                this.InvokeEx(f => f.dg1.Rows[i].Cells[5].Value = FFBatch.Properties.Strings.ready);
                                this.InvokeEx(f => f.dg1.Rows[i].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor);
                                this.InvokeEx(f => f.dg1.Rows[i].Cells[5].Style.BackColor = Color.LightGreen);

                                if (duracion.Length >= 12)
                                {
                                    if (duracion.Substring(0, 11) == "0:00:00.000" || duracion.Substring(0, 12) == "00:00:00.000")
                                    {
                                        this.InvokeEx(f => f.dg1.Rows[i].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor);
                                        this.InvokeEx(f => f.dg1.Rows[i].Cells[5].Value = FFBatch.Properties.Strings.ready);
                                        Total_dur_urls = Total_dur_urls + TimeSpan.Parse(dg1.Rows[i].Cells[3].Value.ToString()).TotalSeconds;
                                        this.InvokeEx(f => f.dg1.Rows[i].Cells[5].Style.BackColor = Color.LightGreen);
                                    }
                                }
                            }

                            if (duracion == FFBatch.Properties.Strings.n_a)
                            {
                                this.InvokeEx(f => f.dg1.Rows[i].Cells[2].Value = FFBatch.Properties.Strings.n_a);
                                this.InvokeEx(f => f.dg1.Rows[i].Cells[3].Value = "\u221E");
                                this.InvokeEx(f => f.dg1.Rows[i].Cells[4].Value = dg1.Rows[i].Cells[4].Value.ToString() + "_FF" + (i + 1).ToString());
                                this.InvokeEx(f => f.dg1.Rows[i].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor);
                                this.InvokeEx(f => f.dg1.Rows[i].Cells[5].Value = FFBatch.Properties.Strings.ready);
                                try
                                {
                                    Total_dur_urls = Total_dur_urls + TimeSpan.Parse(dg1.Rows[i].Cells[3].Value.ToString()).TotalSeconds;
                                }
                                catch { }
                            }
                        }

                        form_prog2.Invoke(new MethodInvoker(delegate
                        {
                            if (errors > 0 && form_prog2.abort_validate == false)
                            {
                                form_prog2.lab_err.Text = FFBatch.Properties.Strings.errors + " " + errors.ToString();
                                form_prog2.lab_err.Refresh();
                                form_prog2.pictureBox1.Visible = true;
                                form_prog2.pictureBox1.Refresh();
                            }
                        }));
                    }
                    else
                    {
                        //Generic link
                        String filename = "";
                        String out_thumb = "";
                        String duracion2 = "";

                        tmp.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe");
                        if (!File.Exists(System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe")))
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.yt_not, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            release_datagrid();
                            return;
                        }
                        tmp.StartInfo.WorkingDirectory = Application.StartupPath;
                        tmp.StartInfo.Arguments = "--get-duration --get-title --get-thumbnail " + dg1.Rows[i].Cells[1].Value.ToString();
                        tmp.StartInfo.RedirectStandardOutput = true;
                        tmp.StartInfo.UseShellExecute = false;
                        tmp.StartInfo.CreateNoWindow = true;
                        tmp.EnableRaisingEvents = true;
                        if (cts.IsCancellationRequested == false)
                        {
                            tmp.Start();

                            while (!tmp.StandardOutput.EndOfStream)
                            {
                                filename = tmp.StandardOutput.ReadLine();
                                out_thumb = tmp.StandardOutput.ReadLine();
                                duracion2 = tmp.StandardOutput.ReadLine();
                            }

                            PictureBox pic = new PictureBox();

                            if (out_thumb.Contains("http"))
                            {
                                try
                                {
                                    if (out_thumb.Contains("?")) out_thumb = out_thumb.Substring(0, out_thumb.IndexOf("?"));
                                    new System.Threading.Thread(() =>
                                    {
                                        System.Threading.Thread.CurrentThread.IsBackground = true;
                                        pic.Load(out_thumb);
                                        dg_thumbs[i] = pic.Image;
                                        dg1.Invoke(new MethodInvoker(delegate
                                        {
                                            dg1.Rows[i].Cells[0].Value = pic.Image;
                                        }));
                                    }).Start();
                                }
                                catch
                                {
                                    dg_thumbs[i] = pic_noimg.Image;
                                }
                            }
                            else
                            {
                                dg_thumbs[i] = pic_noimg.Image;
                            }
                            //cell_stretch();
                        }
                        else return;

                        tmp.WaitForExit(10000);
                        tmp.StartInfo.Arguments = "";

                        if (duracion2 == null || duracion2 == string.Empty)
                        {
                            dg1.Invoke(new MethodInvoker(delegate
                            {
                                dg1.Rows[i].DefaultCellStyle.BackColor = Color.LightGoldenrodYellow;
                                dg1.Rows[i].Cells[2].Value = Properties.Strings.n_a;
                                dg1.Rows[i].Cells[3].Value = "\u221E";
                                int index_length = dg1.Rows[i].Cells[1].Value.ToString().Length;

                                if (dg1.Rows[i].Cells[1].Value.ToString().Substring(index_length - 1, 1) == "/")
                                {
                                    dg1.Rows[i].Cells[1].Value = dg1.Rows[i].Cells[1].Value.ToString().Substring(0, index_length - 1);
                                    index_length = index_length - 1;
                                }

                                int index_fn = dg1.Rows[i].Cells[1].Value.ToString().LastIndexOf("/");
                                int ind_final = index_length - index_fn;
                                String dest = dg1.Rows[i].Cells[1].Value.ToString().Substring(index_fn + 1, ind_final - 1);
                                dg1.Rows[i].Cells[4].Value = dest;
                                if (Properties.Settings.Default.dark_mode == false)
                                {
                                    dg1.Rows[i].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor;
                                }
                                else dg1.Rows[i].DefaultCellStyle.BackColor = Color.FromArgb(255, 96, 96, 96);
                                dg1.Rows[i].Cells[5].Value = FFBatch.Properties.Strings.ready;
                                //this.InvokeEx(f => f.dg1.Rows[dg1.RowCount - 1].Cells[5].Style.BackColor = Color.LightGoldenrodYellow);
                            }));
                        }

                        if (duracion2 != null && filename != "")
                        {
                            dg1.Invoke(new MethodInvoker(delegate
                            {
                                if (duracion2 == "0")
                                {
                                    dg1.Rows[dg1.RowCount - 1].Cells[2].Value = duracion2;
                                    dg1.Rows[dg1.RowCount - 1].Cells[3].Value = "Live";
                                }
                                else
                                {
                                    if (duracion2.Length < 6) duracion2 = "00:" + duracion2;
                                    dg1.Rows[dg1.RowCount - 1].Cells[2].Value = duracion2;
                                    dg1.Rows[dg1.RowCount - 1].Cells[3].Value = duracion2;
                                }
                                dg1.Rows[dg1.RowCount - 1].Cells[4].Value = filename;
                                if (Properties.Settings.Default.dark_mode == false)
                                {
                                    dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor;
                                }
                                else dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = Color.FromArgb(255, 96, 96, 96);
                                one_ok = true;
                                dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.ready;
                                this.InvokeEx(f => f.dg1.Rows[dg1.RowCount - 1].Cells[5].Style.BackColor = Color.LightGreen);
                            }));
                        }
                    }
                });

                try
                {
                    form_prog2.Invoke(new MethodInvoker(delegate
                    { form_prog2.Close(); }));
                }
                catch
                {
                    try
                    {
                        form_prog2.Invoke(new MethodInvoker(delegate
                        { form_prog2.Close(); }));
                    }
                    catch { }
                    form_prog2.abort_validate = true;
                }
            }
            catch (Exception exc)
            {
                fatal_parallel_msg = exc.Message;
                fatal_parallel = true;

                try
                {
                    form_prog2.Invoke(new MethodInvoker(delegate
                    { form_prog2.Close(); }));
                }
                catch
                {
                    form_prog2.abort_validate = true;
                }
            }
            if (result.IsCompleted == true) fatal_parallel = false;
            else
            {
                if (cts.IsCancellationRequested == false) fatal_parallel = true;
                else fatal_parallel = false;
            }
        }

        private void BG_Validate_URLs_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            this.Enabled = true;
            chk_m3u_params.Text = FFBatch.Properties.Strings.m3u_params;
            chk_m3u_params.Left = 22;
            chk_m3u_params.Checked = m3u_params_checked;
            chk_output_server.Checked = output_server_checked;
            if (m3u_params_checked == false) txt_m3u_params.Enabled = false;
            if (output_server_checked == false) txt_output_server.Enabled = false;
            for (int i = Application.OpenForms.Count - 1; i >= 0; i--)
            {
                if (Application.OpenForms[i].Name == "Form9")
                    try { Application.OpenForms[i].Close(); } catch { }
            }

            foreach (DataGridViewRow row in dg1.Rows)
            {
                row.Cells[0].Value = dg_thumbs[row.Index];
                if (row.Cells[3].Value == null) continue;
                if (row.Cells[3].Value.ToString() != "" && row.Cells[3].Value.ToString() != "-" && row.Cells[3].Value.ToString() != FFBatch.Properties.Strings.n_a && row.Cells[3].Value.ToString() != "\u221E")
                {
                    Total_dur_urls = Total_dur_urls + TimeSpan.Parse(row.Cells[3].Value.ToString()).TotalSeconds;
                }
            }

            TimeSpan t = TimeSpan.FromSeconds(Total_dur_urls);
            String dur = string.Format("{0:D2}h:{1:D2}m:{2:D2}s.{3:D3}ms",
                 (int)t.TotalHours,
                 t.Minutes,
                 t.Seconds,
                 t.Milliseconds);

            this.InvokeEx(f => f.lbl_urls_time.Visible = true);
            this.InvokeEx(f => f.lbl_urls_time.Text = dur.Substring(0, 11));
            if (dur.Substring(0, 11) == "00h:00m:00s")
            { this.InvokeEx(f => f.lbl_urls_time.Text = ""); }
            //cell_stretch();
            urls_duration();
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
        }

        private void chk_m3u_params_CheckedChanged(object sender, EventArgs e)
        {
            if (chk_m3u_params.CheckState == CheckState.Checked)
            {
                txt_m3u_params.Enabled = true;
            }
            else
            {
                txt_m3u_params.Enabled = false;
            }
        }

        private void button16_Click_1(object sender, EventArgs e)
        {
            if (folderBrowser_m3u.ShowDialog() == DialogResult.OK)
            {
                if (folderBrowser_m3u.SelectedPath != txt_path_m3u.Text) btn_save_path_url.Enabled = true;
                txt_path_m3u.Text = folderBrowser_m3u.SelectedPath;
                txt_path_m3u.BackColor = Color.White;

                try
                {
                    File.WriteAllText(folderBrowser_m3u.SelectedPath + "\\" + "FFBatch_test.txt", "FFBatch_test");
                    System.Threading.Thread.Sleep(10);
                    File.Delete(folderBrowser_m3u.SelectedPath + "\\" + "FFBatch_test.txt");
                }
                catch (System.Exception excpt)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.write_error1 + " " + Environment.NewLine + excpt.Message, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                    return;
                }
            }
        }

        private void ct_validate_url_Click(object sender, EventArgs e)
        {
            dg1.EndEdit();
            dg1.ClearSelection();

            for (int i = 1; i < dg1.RowCount; i++)

            {
                if (dg1.Rows[i].Cells[5].Value.ToString() == FFBatch.Properties.Strings.error || dg1.Rows[i].Cells[5].Value.ToString() == FFBatch.Properties.Strings.failed)

                {
                    dg1.Rows.RemoveAt(i);
                    i--;
                }
            }

            if (dg1.Rows[0].Cells[1] != null && dg1.Rows[0].Cells[5].Value.ToString() == FFBatch.Properties.Strings.error)
            {
                dg1.Rows.RemoveAt(0);
                return;
            }
            dg1.Refresh();
        }

        private void ct_del_m3u_Click(object sender, EventArgs e)
        {
            dg1.EndEdit();
            dg1.ClearSelection();

            for (int i = 1; i < dg1.RowCount; i++)

            {
                if (dg1.RowCount == 1 && dg1.Rows[0].Cells[1].Value == null)
                {
                    dg1.Rows.Clear();
                    return;
                }

                if (dg1.Rows[i].Cells[1].Value == null)

                {
                    dg1.Rows.RemoveAt(i);
                    i--;
                }
            }
        }

        private void ct_paste_m3u_Click(object sender, EventArgs e)
        {
            check_internet(); if (internet_up == false) return;
            if (Clipboard.GetText().Length > 1024) return;

            if (has_you_row() == true)
            {
                MessageBox.Show(FFBatch.Properties.Strings.mix_urls, FFBatch.Properties.Strings.information, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (Clipboard.GetText() != String.Empty && Clipboard.GetText().ToLower().Contains("http"))
            {
                dg1.Rows.Add(pic_noimg.Image, Clipboard.GetText(), "", "", "", "");
                foreach (DataGridViewRow row in dg1.Rows)
                {
                    row.ReadOnly = true;
                }
                foreach (Control ct in groupBox_m3u.Controls)
                {
                    ct.Enabled = false;
                }

                Validate_added_row();

                foreach (DataGridViewRow row in dg1.Rows)
                {
                    row.ReadOnly = false;
                }
                foreach (Control ct in groupBox_m3u.Controls)
                {
                    ct.Enabled = true;
                }

                if (chk_m3u_params.CheckState == CheckState.Checked)
                {
                    txt_m3u_params.Enabled = true;
                }
                else
                {
                    txt_m3u_params.Enabled = false;
                }

                if (chk_output_server.CheckState == CheckState.Checked)
                {
                    txt_output_server.Enabled = true;
                }
                else
                {
                    txt_output_server.Enabled = false;
                }
            }
        }

        private void release_datagrid()
        {
            this.InvokeEx(f => this.Enabled = true);

            dg1.Invoke(new MethodInvoker(delegate
            {
                ((DataGridViewImageColumn)dg1.Columns[0]).ImageLayout = DataGridViewImageCellLayout.Stretch;
            }));

            this.Invoke(new MethodInvoker(delegate
            {
                dg1.ReadOnly = false;

                foreach (Control ct in groupBox_m3u.Controls)
                {
                    ct.Enabled = true;
                }

                if (chk_m3u_params.CheckState == CheckState.Checked)
                {
                    txt_m3u_params.Enabled = true;
                }
                else
                {
                    txt_m3u_params.Enabled = false;
                }

                if (chk_output_server.CheckState == CheckState.Checked)
                {
                    txt_output_server.Enabled = true;
                }
                else
                {
                    txt_output_server.Enabled = false;
                }

                foreach (DataGridViewRow row in dg1.Rows)
                {
                    row.ReadOnly = false;
                }
            }));
        }

        private void get_mixed_urls()
        {
            Boolean has_youtube = false;
            Boolean has_m3u = false;
            foreach (DataGridViewRow row in dg1.Rows)
            {
                if (row.Cells[1].Value.ToString().ToLower().Contains("youtu.be") || row.Cells[1].Value.ToString().ToLower().Contains("youtube.com"))
                {
                    has_youtube = true;
                }
                else
                {
                    has_m3u = true;
                }
            }
            if (has_m3u == true && has_youtube == true)
            {
                mixed_urls = true;
                MessageBox.Show(FFBatch.Properties.Strings.mix_urls, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            else mixed_urls = false;
        }

        private Boolean url_repeat()
        {
            Boolean remove_dups = false;
            Boolean dups = false;

            for (int i = 0; i < dg1.RowCount - 1; i++) //compare data
            {
                var Row = dg1.Rows[i];
                string abc = Row.Cells[4].Value.ToString();

                for (int j = i + 1; j < dg1.RowCount; j++)
                {
                    var Row2 = dg1.Rows[j];
                    string def = Row2.Cells[4].Value.ToString();
                    if (abc == def)
                    {
                        dups = true;
                        if (remove_dups == false)
                        {
                            DialogResult a = MessageBox.Show(FFBatch.Properties.Strings.dup_url + " " + Environment.NewLine + Environment.NewLine + '\u0022' + abc + '\u0022' + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.remove_dup, FFBatch.Properties.Strings.out_dup, MessageBoxButtons.YesNoCancel, MessageBoxIcon.Question);
                            if (a == DialogResult.Yes)
                            {
                                remove_dups = true;
                            }
                            else
                            {
                                remove_dups = false;
                                return true;
                            }
                        }
                        if (remove_dups == true)
                        {
                            Row.Cells[4].Value = Row2.Cells[4].Value;
                            dg1.Rows.Remove(Row2);
                            j--;
                        }
                    }
                }
            }
            if (dups == true && remove_dups == false) return true;
            else return false;
        }

        private void download_any()
        {
            List<string> list_lines = new List<string>();
            List<string> list_err = new List<string>();
            List<string> er = new List<string>();
            pic_warnings.Visible = false;
            pic_no_errors.Visible = false;
            int total_videos = dg1.RowCount;
            int pending_urls = total_videos;
            aborted_url = false;
            Boolean killed = false;
            Pg1.Value = 0;
            Pg1.Maximum = 100;
            Pg1.Text = "0%";
            int pg2 = 0;
            Pg1.Refresh();

            working = true;
            m3u_single_running = true;
            cancelados_paralelos = false;
            aborted_url = false;
            errors_enc = 0;
            pic_no_errors.Visible = false;
            pic_warnings.Visible = false;
            pic_recording.Visible = false;

            //Disable Datagrid edition
            foreach (DataGridViewRow row in dg1.Rows)
            {
                row.ReadOnly = true;
                row.Cells[5].Value = FFBatch.Properties.Strings.ready;
            }

            String format_out = combo_ext_m3u.SelectedItem.ToString();
            String down_speed = "";

            if (chk_best_yt.Checked) bestv_a = "-f bestvideo[ext=mp4]+bestaudio[ext=m4a]/bestvideo+bestaudio";
            else bestv_a = String.Empty;

            if (chk_down_limit.Checked == true) down_speed = "-r " + Convert.ToInt32(n_down_speed.Value).ToString() + "M";
            String embed_subs = "";
            if (chk_yout_subs.Checked == true) embed_subs = "--embed-subs --all-subs";
            String auto_subs = "";
            if (chk_auto_subs.Checked == true)
            {
                auto_subs = "--write-auto-sub --sub-lang en,es,it,pt,de,hi,ar,cn";
                if (chk_yout_subs.Checked == true) embed_subs = "--embed-subs";
            }
            String embed_meta = "";
            if (chk_embed_meta.Checked == true) embed_meta = "--add-metadata";
            String write_subs = "";
            if (chk_save_subtitles.Checked == true) embed_meta = "--write-sub";

            String convert_subs = "";
            if (chk_convert_srt.Checked == true) embed_meta = "--convert-subs=srt";
            String m3u_params = txt_m3u_params.Text;

            foreach (DataGridViewRow row in dg1.Rows)
            {
                if (row.Cells[4].Value.ToString().Contains("/") || row.Cells[4].Value.ToString().Contains(":") || row.Cells[4].Value.ToString().Contains("*") || row.Cells[4].Value.ToString().Contains("?") || row.Cells[4].Value.ToString().Contains("¿") || row.Cells[4].Value.ToString().Contains('\u0022') || row.Cells[4].Value.ToString().Contains("<") || row.Cells[4].Value.ToString().Contains(">") || row.Cells[4].Value.ToString().Contains("|") || row.Cells[4].Value.ToString().Contains("\\"))
                {
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("/", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace(":", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("*", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("?", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("¿", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("\u0022", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("<", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace(">", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("|", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("\\", "");
                }
            }

            Disable_Controls();
            time_n_tasks = 0;
            lbl_elapsed.Text = Properties.Strings.total_time + " " + "00h:00m:00s";
            timer_tasks.Start();

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;

                for (int list_index = 0; list_index < dg1.RowCount; list_index++)
                {
                    System.Threading.Thread.Sleep(50); //Allow kill process to send cancel_queue
                    Boolean quit = false;

                    if (cancel_queue == true)
                    {
                        working = false;
                        m3u_running = false;
                        m3u_single_running = false;
                        timer_tasks.Stop();
                        timer2.Stop();
                        cancelados_paralelos = false;
                        aborted_url = false;
                        Timer_display.Enabled = false;
                        release_datagrid();

                        this.InvokeEx(f => f.lbl_dw_speed.Text = "");
                        Enable_Controls();
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));

                        MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.task_abort, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);

                        return;
                    }

                    //Skip current
                    if (skip_current_url == true)
                    {
                        skip_current_url = false;

                        continue;
                    }

                    String file = "";
                    dg1.Invoke(new MethodInvoker(delegate
                    {
                        file = dg1.Rows[list_index].Cells[1].Value.ToString();
                    }));

                    String ffm = System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe");
                    String destino = txt_path_m3u.Text;

                    if (!Directory.Exists(destino))
                    {
                        try
                        {
                            Directory.CreateDirectory(destino);
                        }
                        catch (System.Exception excpt)
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.write_error2 + " " + excpt.Message, FFBatch.Properties.Strings.write_error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                            //this.InvokeEx(f => f.lbl_d_v.Text = "");
                            return;
                        }
                    }

                    process_glob.StartInfo.FileName = ffm;
                    string replace_m3u_param = "-bsf:a aac_adtstoasc -c copy";
                    if (m3u_params.Contains("-f "))
                    {
                        process_glob.StartInfo.Arguments = bestv_a + " " + Clear_cache + " " + m3u_params.Replace(replace_m3u_param, "") + " " + down_speed + " " + embed_subs + " " + auto_subs + " " + embed_meta + " " + write_subs + " " + convert_subs + " -o " + '\u0022' + destino + "\\" + dg1.Rows[list_index].Cells[4].Value.ToString() + "." + format_out + '\u0022' + " " + file;
                    }
                    else
                    {
                        if (bestv_a.Length == 0)
                        {
                            process_glob.StartInfo.Arguments = Clear_cache + " -f " + format_out + " " + m3u_params.Replace(replace_m3u_param, "") + " " + down_speed + " " + embed_subs + " " + auto_subs + " " + embed_meta + " -o " + '\u0022' + destino + "\\" + dg1.Rows[list_index].Cells[4].Value.ToString() + "." + format_out + '\u0022' + " " + file;
                        }
                        else
                        {
                            process_glob.StartInfo.Arguments = bestv_a + " " + Clear_cache + " " + m3u_params.Replace(replace_m3u_param, "") + " " + down_speed + " " + embed_subs + " " + auto_subs + " " + embed_meta + " -o " + '\u0022' + destino + "\\" + dg1.Rows[list_index].Cells[4].Value.ToString() + "." + format_out + '\u0022' + " " + file;
                        }
                    }
                    //MessageBox.Show(process_glob.StartInfo.Arguments );
                    process_glob.StartInfo.WorkingDirectory = Application.StartupPath;

                    if (!File.Exists(System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe")))
                    {
                        cancel_queue = true;
                        working = false;
                        timer_tasks.Stop();
                        Enable_Controls();
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        this.InvokeEx(f => timer_yt.Stop());
                        //this.InvokeEx(f => f.lbl_down_time.Text = "");
                        MessageBox.Show(FFBatch.Properties.Strings.yt_not, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }

                    //this.InvokeEx(f => f.lbl_d_v.Text = FFBatch.Properties.Strings2.init_wait);
                    this.InvokeEx(f => timer_yt.Start());

                    process_glob.StartInfo.RedirectStandardOutput = true;
                    process_glob.StartInfo.StandardOutputEncoding = Encoding.UTF8;
                    process_glob.StartInfo.RedirectStandardInput = true;
                    process_glob.StartInfo.RedirectStandardError = true;
                    process_glob.StartInfo.StandardErrorEncoding = Encoding.UTF8;
                    process_glob.StartInfo.UseShellExecute = false;
                    process_glob.StartInfo.CreateNoWindow = true;
                    process_glob.EnableRaisingEvents = true;

                    process_glob.Start();

                    String err_txt = "";
                    String error_out = "";
                    String tr_speed = "";
                    Double interval = 0;
                    Decimal est_bitrate = 0;
                    Decimal est_size = 0;
                    Double sec_prog = 0;
                    int progress = 0;
                    //this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.Normal));
                    String pl_title = "";

                    while (!process_glob.StandardOutput.EndOfStream)
                    {
                        err_txt = process_glob.StandardOutput.ReadLine();
                        list_lines.Add(err_txt);

                        if (err_txt.Contains("[download] Downloading playlist: ")) pl_title = err_txt.Replace("[download] Downloading playlist: ", "");

                        if (err_txt.Contains("[youtube:tab] Downloading page "))
                        {
                            lbl_speed.Invoke(new MethodInvoker(delegate
                            {
                                if (pl_title.Length == 0) lbl_speed.Text = FFBatch.Properties.Strings2.brow_page + " " + err_txt.Replace("[youtube:tab] Downloading page ", "");
                                else lbl_speed.Text = FFBatch.Properties.Strings2.browsing + " " + "\u0022" + pl_title + "\u0022" + " Page " + err_txt.Replace("[youtube:tab] Downloading page ", "");
                            }));
                        }

                        if (err_txt.Contains("[youtube:tab] playlist ") && err_txt.Contains("Downloading ") && err_txt.Contains("videos"))
                        {
                            int ind1 = err_txt.LastIndexOf("Downloading ");
                            int ind2 = err_txt.Length;
                            String n_vs = err_txt.Substring(ind1, ind2 - ind1).Replace("Downloading ", "").Replace("videos", "").Trim(); ;
                            lbl_speed.Invoke(new MethodInvoker(delegate
                            {
                                lbl_speed.Text = FFBatch.Properties.Strings2.total + ": " + n_vs.Replace("Videos: Downloading ", "").Replace("videos", "").Trim();
                                //lbl_d_v.Visible = true;
                                //lbl_d_v.Text = "Starting downloads...";
                                total_videos = Convert.ToInt32(n_vs.Replace("Videos: Downloading ", "").Replace("videos", "").Trim());
                                Pg1.Maximum = total_videos * 100;
                                this.InvokeEx(f => f.Pg1.Text = "0 of " + total_videos.ToString());
                            }));
                        }
                        if (err_txt.Contains("[download] Destination: "))
                        {
                            lbl_speed.Invoke(new MethodInvoker(delegate
                            {
                                lbl_speed.Text = Path.GetFileName(err_txt.Replace("Downloading video: ", ""));
                            }));
                        }

                        String prog_cell = "";

                        if (err_txt.Contains("%"))
                        {
                            try
                            {
                                this.InvokeEx(f => f.lbl_speed.TextAlign = ContentAlignment.MiddleLeft);
                                this.InvokeEx(f => f.lbl_speed.Width = 349);
                                Double prog_y = Double.Parse(err_txt.Substring(err_txt.IndexOf("%") - 4, 4));
                                prog_y = prog_y / 10;
                                progress = Convert.ToInt32(prog_y);
                                pg2 = progress;
                                this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Value = progress.ToString() + "%");
                                prog_cell = progress.ToString() + "%";
                            }
                            catch { }
                        }
                        if (err_txt.Contains("ETA") && show_est == true)
                        {
                            try
                            {
                                int ind1 = err_txt.LastIndexOf("ETA");
                                String unit = "";
                                String est_time = err_txt.Substring(ind1, err_txt.Length - ind1).Replace("ETA", "").Trim();
                                if (err_txt.ToLower().Contains("mib/s")) unit = " MB/s";
                                if (err_txt.ToLower().Contains("kib/s")) unit = " KB/s";
                                this.InvokeEx(f => f.txt_remain.Text = err_txt.Substring(err_txt.IndexOf("at ") + 3, 5) + " " + unit + " - " + est_time);
                            }
                            catch { }
                        }

                        try
                        {
                            if ((progress / pending_urls) > Pg1.Value)
                            {
                                this.InvokeEx(f => f.Pg1.Value = progress / pending_urls);
                                this.InvokeEx(f => f.Pg1.Text = Pg1.Value.ToString() + "%");
                                this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, Pg1.Value, Pg1.Maximum));
                            }
                        }
                        catch { }
                    }

                    while (!process_glob.StandardError.EndOfStream)
                    {
                        error_out = process_glob.StandardError.ReadLine();
                    }
                    process_glob.WaitForExit();

                    pending_urls = pending_urls - 1;

                    process_glob.StartInfo.Arguments = String.Empty;
                    this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                    this.InvokeEx(f => timer_yt.Stop());

                    this.InvokeEx(f => f.lbl_speed.Text = "");
                    this.InvokeEx(f => f.txt_remain.Text = "");

                    list_lines.Add("");
                    list_lines.Add("---------End of download log---------");
                    list_lines.Add("");

                    if (process_glob.ExitCode == 0)

                    {
                        if (skipped == false && aborted_url == false)
                        {
                            this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Value = FFBatch.Properties.Strings.success);
                            //this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Style.BackColor = Color.PaleGreen);
                        }
                        else
                        {
                            this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Value = FFBatch.Properties.Strings.skipped);
                            skipped = false;
                        }
                        if (aborted_url == true)
                        {
                            this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Value = FFBatch.Properties.Strings.aborted);
                            //this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Style.BackColor = Color.PaleGoldenrod);
                            aborted_url = false;
                        }
                        if (stopped_recording == true)
                        {
                            this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Value = Properties.Strings2.finish);
                            this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Style.BackColor = Color.White);
                        }
                    }
                    else
                    {
                        if (skipped == true)
                        {
                            this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Value = FFBatch.Properties.Strings.skipped);
                            skipped = false;
                        }
                        else
                        {
                            this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Value = FFBatch.Properties.Strings.failed);
                            errors_enc = errors_enc + 1;
                            //this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Style.BackColor = Color.PaleGoldenrod);
                        }
                    }

                    if (list_index + 1 == total_videos || quit == true)
                    {
                        this.InvokeEx(f => f.Pg1.Style = ProgressBarStyle.Continuous);
                        this.InvokeEx(f => f.pic_recording.Visible = false);
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        this.InvokeEx(f => f.Pg1.Value = Pg1.Maximum);
                        this.InvokeEx(f => f.Pg1.Text = "100%");
                        timer2.Stop();
                        this.InvokeEx(f => f.lbl_dw_speed.Text = "");
                        this.InvokeEx(f => f.Timer_display.Enabled = false);

                        m3u_single_running = false;
                        working = false;
                        m3u_running = false;
                        cancelados_paralelos = false;
                        timer_tasks.Stop();
                        release_datagrid();
                        //Save log
                        if (no_save_logs == false)
                        {
                            string[] array_err = list_lines.ToArray();

                            String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                            if (is_portable == true) path = port_path + "ff_batch_portable.log";

                            System.IO.StreamWriter SaveFile = new System.IO.StreamWriter(path);
                            SaveFile.WriteLine("Batch log sesion: " + System.DateTime.Now);
                            SaveFile.WriteLine("-----------------------");
                            foreach (String item in array_err)
                            {
                                SaveFile.WriteLine(item);
                            }
                            String msg_er = String.Empty;
                            if (er.Count > 0) SaveFile.WriteLine(msg_er);
                            SaveFile.Close();

                            File.AppendAllText(path, "-----------------------");
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.end_log);
                            System.IO.FileInfo fileInfo = new System.IO.FileInfo(path);

                            var bytes = fileInfo.Length;

                            var kilobytes = (double)bytes / 1024;
                            var megabytes = kilobytes / 1024;
                            var gigabytes = megabytes / 1024;

                            //Format size view
                            String size = "";
                            String separator = ".";

                            if (bytes > 1000000000)
                            {
                                if (gigabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String gigas = gigabytes.ToString();
                                if (gigas.Length >= 5)
                                {
                                    gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                                    size = (gigas + " " + "GB");
                                }
                                else
                                {
                                    size = (gigas + " " + "GB");
                                }
                            }

                            if (bytes >= 1048576 && bytes <= 1000000000)
                            {
                                if (megabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }
                                String megas = megabytes.ToString();
                                if (megas.Length > 5)
                                {
                                    megas = megas.Substring(0, megas.LastIndexOf(separator));
                                    size = (megas + " " + "MB");
                                }
                                else
                                {
                                    size = (megas + " " + "MB");
                                }
                            }

                            if (bytes >= 1024 && bytes < 1048576)

                            {
                                if (kilobytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String kbs = kilobytes.ToString();
                                if (kbs.Length >= 5)
                                {
                                    kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                                    size = (kbs + " " + "KB");
                                }
                                else
                                {
                                    size = (kbs + " " + "KB");
                                }
                            }
                            if (bytes > -1 && bytes < 1024)
                            {
                                String bits = bytes.ToString();
                                size = (bits + " Bytes");
                            }

                            //End Format size view
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.log_size + " " + size);

                            //End save log
                        }
                        this.Invoke(new MethodInvoker(delegate
                        {
                            toolT002.RemoveAll();
                            if (errors_enc == 0) pic_no_errors.Visible = true;
                            else
                            {
                                pic_no_errors.Visible = false;
                                pic_recording.Visible = false;
                                toolT002.SetToolTip(this.pic_warnings, FFBatch.Properties.Strings.there_w + " " + errors_enc.ToString() + " " + FFBatch.Properties.Strings.errors_se);
                                pic_warnings.Visible = true;
                            }
                        }));

                        //Automatic shutdown check
                        if (chkshut.Checked && cancel_queue == false)
                        {
                            auto_shut();
                            return;
                        }
                        //End shutdown check
                        else
                        {
                            if (cancel_queue == false)
                            {
                                if (Form.ActiveForm == null)
                                {
                                    notifyIcon1.BalloonTipText = "FFmpeg Batch" + " - " + Properties.Strings2.url_down_c;
                                    notifyIcon1.BalloonTipIcon = ToolTipIcon.Info;
                                    notifyIcon1.BalloonTipTitle = Properties.Strings2.url_down_c2;
                                    notifyIcon1.ShowBalloonTip(0);
                                    if (play_on_end == true && er.Count == 0) play_end();
                                    if (er.Count > 0)
                                    {
                                        String warnings = "";
                                        foreach (String st in er) warnings = warnings + st;
                                        MessageBox.Show(Properties.Strings2.warn_down + " " + Environment.NewLine + Environment.NewLine + warnings + Environment.NewLine + Environment.NewLine + Properties.Strings.check_log, Properties.Strings.warning, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                                    }
                                }

                                if (chk_open_compl.Checked)
                                {
                                    if (Directory.GetFiles(destino).Length != 0)
                                    {
                                        Process open_processed = new Process();
                                        open_processed.StartInfo.FileName = "explorer.exe";
                                        open_processed.StartInfo.Arguments = '\u0022' + destino + '\u0022';
                                        open_processed.Start();
                                    }
                                    else
                                    {
                                        //if (Directory.Exists(destino))
                                        //{
                                        //    System.IO.Directory.Delete(destino);
                                        //}
                                    }
                                }
                            }
                            else
                            {
                                this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                                m3u_single_running = false;
                                cancelados_paralelos = false;
                                this.InvokeEx(f => f.Pg1.Value = Pg1.Maximum);
                                this.InvokeEx(f => f.Pg1.Text = "100%");
                                this.InvokeEx(f => f.lbl_dw_speed.Text = "");
                                if (quit == false && stopped_recording == false) this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.aborted, MessageBoxButtons.OK, MessageBoxIcon.Error));
                                //if (stopped_recording == true) this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.queue_abort, "Stopped", MessageBoxButtons.OK, MessageBoxIcon.Error));
                            }
                        }
                    }
                }

                Enable_Controls();
                //String borrar = destino_test + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + txt_format.Text;
            }).Start();
        }

        private void btn_start_m3u_Click(object sender, EventArgs e)
        {
            cancel_queue = false;
            notifyIcon1.Visible = true;
            if (m3u_single_running == true) return;
            Boolean unknown_link = false;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            foreach (DataGridViewRow row in dg1.Rows)
            {
                if (row.Cells[5].Value.ToString() == FFBatch.Properties.Strings.error || row.Cells[5].Value.ToString() == FFBatch.Properties.Strings.unknown)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.errors_list, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }

            if (dg1.RowCount == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.down_empty, FFBatch.Properties.Strings.no_files, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (txt_m3u_params.Text == String.Empty)
            {
                MessageBox.Show(FFBatch.Properties.Strings.params_empty2, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (txt_path_m3u.Text == FFBatch.Properties.Strings.no_path2 && chk_output_server.CheckState == CheckState.Unchecked)
            {
                MessageBox.Show(FFBatch.Properties.Strings.select_out, FFBatch.Properties.Strings.out_conf, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }
            String output_server = String.Empty;

            if (chk_output_server.CheckState == CheckState.Checked && txt_output_server.Text == String.Empty)
            {
                MessageBox.Show(FFBatch.Properties.Strings.out_serv1, FFBatch.Properties.Strings.warning, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }
            else
            {
                output_server = txt_output_server.Text;
            }

            get_mixed_urls();
            if (mixed_urls == true) return;

            foreach (DataGridViewRow row in dg1.Rows)
            {
                if (!row.Cells[1].Value.ToString().ToLower().Contains("youtu.be") && !row.Cells[1].Value.ToString().ToLower().Contains("youtube") && !row.Cells[1].Value.ToString().ToLower().Contains("m3u"))
                {
                    unknown_link = true;
                    break;
                }
            }

            if (unknown_link == true)
            {
                download_any();
                return;
            }

            if (!dg1.Rows[0].Cells[1].Value.ToString().ToLower().Contains("youtu.be") && !dg1.Rows[0].Cells[1].Value.ToString().ToLower().Contains("youtube.com"))
            {
                foreach (DataGridViewRow row in dg1.Rows)
                {
                    if (row.Cells[5].Value.ToString() == FFBatch.Properties.Strings.ready && row.Cells[2].Value.ToString() != FFBatch.Properties.Strings.n_a)
                    {
                        if (TimeSpan.Parse(row.Cells[3].Value.ToString()).TotalSeconds > TimeSpan.Parse(row.Cells[2].Value.ToString()).TotalSeconds)
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.capture_time2 + " " + row.Cells[4].Value.ToString() + " " + Properties.Strings2.exc_dur, Properties.Strings2.wrong_c_dur, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            return;
                        }
                    }
                }
            }
            foreach (DataGridViewRow row in dg1.Rows)
            {
                if (row.Cells[4].Value.ToString().Contains("/") || row.Cells[4].Value.ToString().Contains(":") || row.Cells[4].Value.ToString().Contains("*") || row.Cells[4].Value.ToString().Contains("?") || row.Cells[4].Value.ToString().Contains("¿") || row.Cells[4].Value.ToString().Contains('\u0022') || row.Cells[4].Value.ToString().Contains("<") || row.Cells[4].Value.ToString().Contains(">") || row.Cells[4].Value.ToString().Contains("|") || row.Cells[4].Value.ToString().Contains("\\"))
                {
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("/", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace(":", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("*", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("?", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("¿", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("\u0022", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("<", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace(">", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("|", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("\\", "");
                }
            }

            //Pending validation
            Boolean pre_validate = false;

            foreach (DataGridViewRow row in dg1.Rows)
            {
                if (row.Cells[5].Value.ToString() == String.Empty)
                {
                    pre_validate = true;
                }
            }
            if (pre_validate == true)
            {
                var a = MessageBox.Show(FFBatch.Properties.Strings.val_urls, FFBatch.Properties.Strings.val_pending, MessageBoxButtons.OKCancel, MessageBoxIcon.Question);
                if (a == DialogResult.OK)
                {
                    was_started.Text = btn_start_m3u.Text;
                    btn_validate_url.PerformClick();
                    return;
                }
                else
                {
                    return;
                }
            }
            if (url_repeat() == true) return;

            foreach (DataGridViewRow row in dg1.Rows)
            {
                if (row.Cells[3].Value.ToString() == "\u221E")
                {
                    MessageBox.Show(Properties.Strings2.undef_dur_all, Properties.Strings2.undef_seq, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    //return;
                }
            }

            String destino_test = Path.Combine(txt_path_m3u.Text, "FFBatch_test");
            String file_prueba = dg1.Rows[0].Cells[1].Value.ToString();
            String file_output = dg1.Rows[0].Cells[5].Value.ToString() + "." + combo_ext_m3u.SelectedItem.ToString();
            String fichero = Path.GetFileName(file_prueba);

            if (chk_try.CheckState == CheckState.Unchecked)
            { //Try preset
                if (!file_prueba.ToLower().Contains("youtu.be") && !file_prueba.ToLower().Contains("youtube.com"))
                {
                    Form11 frm_prog = new Form11();
                    new System.Threading.Thread(() =>
                    {
                        System.Threading.Thread.CurrentThread.IsBackground = true;
                        frm_prog.label1.Text = FFBatch.Properties.Strings.trying;
                        frm_prog.label1.Refresh();
                        frm_prog.ShowDialog();
                        frm_prog.Refresh();
                    }).Start();

                    if (!Directory.Exists(destino_test))
                    {
                        try
                        {
                            Directory.CreateDirectory(destino_test);
                        }
                        catch (System.Exception excpt)
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.error_test_f + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            this.Cursor = Cursors.Arrow;
                            return;
                        }
                    }

                    Process consola_pre = new Process();

                    consola_pre.StartInfo.FileName = Application.StartupPath + "\\" + "ffmpeg.exe";
                    consola_pre.StartInfo.Arguments = " -i " + file_prueba + " -t 0.25 " + txt_m3u_params.Text + " -y " + '\u0022' + destino_test + "\\" + file_output + '\u0022';
                    consola_pre.StartInfo.CreateNoWindow = true;
                    consola_pre.StartInfo.RedirectStandardError = true;
                    consola_pre.StartInfo.RedirectStandardOutput = true;
                    consola_pre.StartInfo.UseShellExecute = false;
                    consola_pre.Start();
                    frm_prog.procId = consola_pre.Id;
                    String err_txt_1 = "";

                    while (!consola_pre.StandardError.EndOfStream)
                    {
                        err_txt_1 = consola_pre.StandardError.ReadLine();
                        this.InvokeEx(f => f.listBox4.Items.Add(err_txt_1));
                        this.InvokeEx(f => f.listBox4.Refresh());
                    }

                    consola_pre.WaitForExit(6000);
                    consola_pre.StartInfo.Arguments = String.Empty;

                    if (consola_pre.StartInfo.Arguments != String.Empty)
                    {
                        consola_pre.Kill();
                        try
                        {
                            frm_prog.Invoke(new MethodInvoker(delegate
                            {
                                frm_prog.Dispose();
                            }));
                        }
                        catch { }
                        MessageBox.Show("Timeout trying to process url", FFBatch.Properties.Strings.url_out2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }

                    if (consola_pre.ExitCode != 0)
                    {
                        try
                        {
                            frm_prog.Invoke(new MethodInvoker(delegate
                            {
                                frm_prog.Dispose();
                            }));
                        }
                        catch { }
                        listBox4.TopIndex = listBox4.Items.Count - 1;
                        listBox4.Refresh();
                        this.Cursor = Cursors.Arrow;
                        if (File.Exists(Path.Combine(destino_test, file_output)))
                        {
                            File.Delete(Path.Combine(destino_test, file_output));
                        }

                        if (Directory.GetFiles(destino_test).Length == 0)
                        {
                            System.IO.Directory.Delete(destino_test);
                        }
                        if (frm_prog.abort_validate == false)
                        {
                            MessageBox.Show(Properties.Strings.ebc_fail_ff, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            return;
                        }
                    }
                    else
                    {
                        this.Cursor = Cursors.Arrow;

                        frm_prog.Invoke(new MethodInvoker(delegate
                        {
                            frm_prog.pic.Visible = false;
                            frm_prog.pic_ok.Visible = true;
                            frm_prog.pic_ok.Refresh();
                        }));
                        Thread.Sleep(175);
                        try
                        {
                            frm_prog.Invoke(new MethodInvoker(delegate
                            {
                                frm_prog.Dispose();
                            }));
                        }
                        catch { }
                        if (File.Exists(Path.Combine(destino_test, file_output)))
                        {
                            File.Delete(Path.Combine(destino_test, file_output));
                        }

                        if (Directory.GetFiles(destino_test).Length == 0)
                        {
                            System.IO.Directory.Delete(destino_test);
                        }
                    }
                }
                else
                {
                    this.Cursor = Cursors.Arrow;
                    try
                    {
                        if (File.Exists(Path.Combine(destino_test, file_output)))
                        {
                            File.Delete(Path.Combine(destino_test, file_output));
                        }

                        if (Directory.GetFiles(destino_test).Length == 0)
                        {
                            System.IO.Directory.Delete(destino_test);
                        }
                    }
                    catch { }
                }
                //END try preset
            }

            //Mixed youtubes
            int has_lives = 0;
            int has_no_lives = 0;

            foreach (DataGridViewRow row in dg1.Rows)
            {
                if (row.Cells[1].Value.ToString().ToLower().Contains("youtu.be") || row.Cells[1].Value.ToString().ToLower().Contains("youtube.com"))
                {
                    if (row.Cells[3].Value.ToString() == "Live") has_lives++;
                    else has_no_lives++;
                }
            }

            if (has_no_lives > 0 && has_lives > 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.mix_urls2, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            //End mixed youtubes

            //Start pre-processing
            cancel_queue = false;
            Pg1.Value = 0;
            //pg_current.Value = 0;
            Disable_Controls();
            //textBox4.Text = "0%";

            working = true;
            m3u_single_running = true;
            cancelados_paralelos = false;
            aborted_url = false;
            errors_enc = 0;
            pic_no_errors.Visible = false;
            pic_warnings.Visible = false;
            pic_recording.Visible = false;

            //Disable Datagrid edition
            foreach (DataGridViewRow row in dg1.Rows)
            {
                row.ReadOnly = true;
                row.Cells[5].Value = FFBatch.Properties.Strings.ready;
            }

            DataGridView list_proc = new DataGridView();
            foreach (DataGridViewColumn col in dg1.Columns)
            {
                list_proc.Columns.Add((DataGridViewColumn)col.Clone());
            }

            foreach (DataGridViewRow row in dg1.Rows)
            {
                list_proc.Rows.Add(row.Cells[0].Value, row.Cells[1].Value.ToString(), row.Cells[2].Value.ToString(), row.Cells[3].Value.ToString(), row.Cells[4].Value.ToString(), row.Cells[5].Value.ToString());
            }

            //Get total duration of files

            Pg1.Maximum = dg1.RowCount;

            Double total_prog = 0;
            int i_dur = 0;

            Double row_duration = 0;
            total_multi_duration = 0;

            foreach (DataGridViewRow row in dg1.Rows)
            {
                row.Cells[5].Value = FFBatch.Properties.Strings.ready;

                DateTime time2;
                if (DateTime.TryParse(row.Cells[3].Value.ToString(), out time2))

                {
                    total_duration = total_duration + TimeSpan.Parse(row.Cells[3].Value.ToString()).TotalSeconds;
                    total_multi_duration = total_multi_duration + TimeSpan.Parse(row.Cells[3].Value.ToString()).TotalSeconds;
                }
                else
                {
                    //total_duration = total_duration + 0;
                }

                i_dur = i_dur + 1;
            }

            Pg1.Minimum = 0;
            Pg1.Maximum = 100;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            String remain_time = "0";
            //End get total duration of files

            List<string> list_lines = new List<string>();
            process_glob.StartInfo.Arguments = String.Empty;

            time_n_tasks = 0;
            timer_tasks.Start();
            timer_est_size.Start();

            if (dg1.Rows[0].Cells[1].Value.ToString().ToLower().Contains("youtu.be") || dg1.Rows[0].Cells[1].Value.ToString().ToLower().Contains("youtube.com"))
            {
                timer2.Start();
            }

            String m3u_params = txt_m3u_params.Text;

            if (chk_m3u_params.CheckState == CheckState.Unchecked) m3u_params = "";
            String m3u_output_ext = combo_ext_m3u.SelectedItem.ToString();
            m3u_running = true;
            String format_out = combo_ext_m3u.SelectedItem.ToString();
            String down_speed = "";

            if (chk_best_yt.Checked) bestv_a = "-f bestvideo[ext=mp4]+bestaudio[ext=m4a]/bestvideo+bestaudio";
            else bestv_a = String.Empty;

            if (chk_down_limit.Checked == true) down_speed = "-r " + Convert.ToInt32(n_down_speed.Value).ToString() + "M";
            String embed_subs = "";
            if (chk_yout_subs.Checked == true) embed_subs = "--embed-subs --all-subs";
            String auto_subs = "";
            if (chk_auto_subs.Checked == true)
            {
                auto_subs = "--write-auto-sub --sub-lang en,es,it,pt,de,hi,ar,cn";
                if (chk_yout_subs.Checked == true) embed_subs = "--embed-subs";
            }
            String embed_meta = "";
            if (chk_embed_meta.Checked == true) embed_meta = "--add-metadata";
            String write_subs = "";
            if (chk_save_subtitles.Checked == true) embed_meta = "--write-sub";

            String convert_subs = "";
            if (chk_convert_srt.Checked == true) embed_meta = "--convert-subs=srt";
            stopped_recording = false;
            Timer_display.Enabled = true;

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;

                Disable_Controls();
                Boolean quit = false;

                for (int list_index = 0; list_index < dg1.RowCount; list_index++)
                {
                    System.Threading.Thread.Sleep(50); //Allow kill process to send cancel_queue

                    String file = list_proc.Rows[list_index].Cells[1].Value.ToString();

                    //cancel queue REVIEW
                    if (cancel_queue == true)
                    {
                        working = false;
                        m3u_running = false;
                        m3u_single_running = false;
                        timer2.Stop();
                        timer_tasks.Stop();
                        timer_est_size.Stop();
                        cancelados_paralelos = false;
                        aborted_url = false;
                        Timer_display.Enabled = false;
                        release_datagrid();

                        this.InvokeEx(f => f.lbl_dw_speed.Text = "");
                        Enable_Controls();
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));

                        MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.task_abort, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);

                        return;
                    }
                    //End cancel queue

                    //Skip current
                    if (skip_current_url == true)
                    {
                        skip_current_url = false;

                        continue;
                    }

                    //End skip current

                    String url_capture_time = String.Empty;
                    DateTime time2;
                    if (DateTime.TryParse(list_proc.Rows[list_index].Cells[3].Value.ToString(), out time2))

                    {
                        if (TimeSpan.Parse(list_proc.Rows[list_index].Cells[3].Value.ToString()).TotalSeconds > 0)
                        {
                            row_duration = TimeSpan.Parse(list_proc.Rows[list_index].Cells[3].Value.ToString()).TotalSeconds;
                            url_capture_time = " -t " + row_duration.ToString();
                        }
                        else
                        {
                            url_capture_time = String.Empty;
                        }
                    }

                    String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");
                    String fullPath = file;
                    String destino = txt_path_m3u.Text;

                    String pre_input_var = "";
                    if (txt_pre_input.Text != "")
                    {
                        pre_input_var = txt_pre_input.Text;
                    }

                    String pre_ss = "";
                    if (TimeSpan.Parse(ss_time_input.Text).TotalSeconds != 0)
                    {
                        pre_ss = " -ss " + ss_time_input.Text;
                    }

                    add_suffix = "";

                    if (chk_suffix.Checked == true && txt_suffix.Text != String.Empty)
                    {
                        add_suffix = txt_suffix.Text;
                    }

                    String ext_output1 = txt_format.Text;
                    if (txt_format.Text == String.Empty)
                    {
                        ext_output1 = Path.GetExtension(file);
                    }
                    else
                    {
                        ext_output1 = "." + txt_format.Text;
                    }

                    String AppParam = String.Empty;

                    chk_m3u_params.Invoke(new MethodInvoker(delegate
                    {
                        if (file.ToLower().Contains("m3u") && chk_m3u_params.Checked == false) m3u_params = " -bsf:a aac_adtstoasc -c copy " + m3u_params;
                    }));

                    if (chk_output_server.CheckState == CheckState.Checked)
                    {
                        AppParam = pre_input_var + " " + pre_ss + " -i " + "" + file + " -y " + m3u_params + url_capture_time + " " + output_server;
                    }
                    else
                    {
                        AppParam = pre_input_var + " " + pre_ss + " -i " + "" + file + " -y " + m3u_params + url_capture_time + " " + '\u0022' + Path.Combine(destino, list_proc.Rows[list_index].Cells[4].Value.ToString() + "." + m3u_output_ext);
                    }

                    if (!Directory.Exists(destino))
                    {
                        try
                        {
                            Directory.CreateDirectory(destino);
                        }
                        catch (System.Exception excpt)
                        {
                            MessageBox.Show(Properties.Strings2.err_write_out + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                            Enable_Controls();
                            this.InvokeEx(f => f.Timer_display.Enabled = false);
                            return;
                        }
                    }

                    if (file_prueba.ToLower().Contains("youtu.be") || file_prueba.ToLower().Contains("youtube.com") || !file_prueba.ToLower().Contains("m3u"))
                    {
                        process_glob.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe");
                        if (m3u_params.Contains("-f "))
                        {
                            process_glob.StartInfo.Arguments = bestv_a + " " + Clear_cache + " " + m3u_params + " " + down_speed + " " + embed_subs + " " + auto_subs + " " + embed_meta + " " + write_subs + " " + convert_subs + " -o " + '\u0022' + destino + "\\" + dg1.Rows[list_index].Cells[4].Value.ToString() + "." + format_out + '\u0022' + " " + file;
                        }
                        else
                        {
                            if (bestv_a.Length == 0)
                            {
                                process_glob.StartInfo.Arguments = Clear_cache + " -f " + format_out + " " + m3u_params + " " + down_speed + " " + embed_subs + " " + auto_subs + " " + embed_meta + " -o " + '\u0022' + destino + "\\" + dg1.Rows[list_index].Cells[4].Value.ToString() + "." + format_out + '\u0022' + " " + file;
                            }
                            else
                            {
                                process_glob.StartInfo.Arguments = bestv_a + " " + Clear_cache + " " + m3u_params + " " + down_speed + " " + embed_subs + " " + auto_subs + " " + embed_meta + " -o " + '\u0022' + destino + "\\" + dg1.Rows[list_index].Cells[4].Value.ToString() + "." + format_out + '\u0022' + " " + file;
                            }
                        }

                        process_glob.StartInfo.WorkingDirectory = Application.StartupPath;
                        this.InvokeEx(f => f.Pg1.Maximum = 100 * dg1.Rows.Count);
                    }
                    else
                    {
                        process_glob.StartInfo.FileName = ffm;
                        process_glob.StartInfo.Arguments = AppParam;
                    }

                    if (dg1.Rows[list_index].Cells[3].Value.ToString() == "Live")
                    {
                        this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Value = FFBatch.Properties.Strings.recording1);
                        try
                        {
                            File.Delete(destino + "\\" + dg1.Rows[list_index].Cells[4].Value.ToString() + "." + format_out);
                        }
                        catch { }
                    }
                    else this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Value = FFBatch.Properties.Strings.processing);

                    if (!File.Exists(System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe")))
                    {
                        quit = true;
                        cancel_queue = true;
                        working = false;
                        m3u_running = false;
                        m3u_single_running = false;
                        timer2.Stop();
                        timer_tasks.Stop();
                        timer_est_size.Stop();
                        cancelados_paralelos = false;
                        aborted_url = false;
                        release_datagrid();
                        this.InvokeEx(f => f.Timer_display.Enabled = false);
                        this.InvokeEx(f => f.lbl_dw_speed.Text = "");
                        Enable_Controls();

                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        MessageBox.Show(FFBatch.Properties.Strings.yt_not, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }

                    if (dg1.Rows[list_index].Cells[3].Value.ToString() == "Live")
                    {
                        process_glob.StartInfo.RedirectStandardOutput = false;
                        process_glob.StartInfo.RedirectStandardError = false;
                        this.InvokeEx(f => f.pic_recording.Visible = true);
                        this.InvokeEx(f => f.Pg1.Style = ProgressBarStyle.Marquee);
                        this.InvokeEx(f => f.Pg1.MarqueeAnimationSpeed = 50);
                    }
                    else
                    {
                        this.InvokeEx(f => f.Pg1.Style = ProgressBarStyle.Continuous);
                        process_glob.StartInfo.RedirectStandardOutput = true;
                        process_glob.StartInfo.RedirectStandardError = true;
                        process_glob.EnableRaisingEvents = true;
                        this.InvokeEx(f => f.pic_recording.Visible = false);
                    }

                    process_glob.StartInfo.CreateNoWindow = true;
                    process_glob.StartInfo.UseShellExecute = false;
                    process_glob.StartInfo.RedirectStandardInput = true;
                    //MessageBox.Show(AppParam);
                    if (quit == false) process_glob.Start();

                    System.Threading.Thread.Sleep(0);

                    combo_prio.Invoke(new MethodInvoker(delegate
                    {
                        if (combo_prio.SelectedIndex != 2)
                        {
                            Change_mem_prio();
                        }
                    }));

                    this.InvokeEx(f => validate_duration = dg1.Rows[list_index].Cells[3].Value.ToString());

                    DateTime time3;
                    if (DateTime.TryParse(list_proc.Rows[list_index].Cells[3].Value.ToString(), out time3))
                    {
                        if (TimeSpan.Parse(list_proc.Rows[list_index].Cells[3].Value.ToString()).TotalSeconds != 0)
                        {
                            valid_prog = true;
                        }
                    }
                    else
                    {
                        valid_prog = false;
                    }

                    String err_txt = "";
                    String tr_speed = "";
                    Double interval = 0;
                    Decimal est_bitrate = 0;
                    Decimal est_size = 0;
                    Double sec_prog = 0;

                    if (!file.ToLower().Contains("youtu.be") && !file.ToLower().Contains("youtube.com"))
                    {
                        while (!process_glob.StandardError.EndOfStream)
                        {
                            err_txt = process_glob.StandardError.ReadLine();
                            list_lines.Add(err_txt);

                            if (err_txt.Contains("time=") && err_txt.Contains("time=-") == false)
                            {
                                if (valid_prog == true)
                                {
                                    this.InvokeEx(f => durat_n = row_duration);
                                    int start_time_index = err_txt.IndexOf("time=") + 5;
                                    sec_prog = TimeSpan.Parse(err_txt.Substring(start_time_index, 8)).TotalSeconds;
                                    Double percent = (sec_prog * 100 / durat_n);

                                    total_prog = total_prog + (sec_prog - interval);
                                    interval = sec_prog;
                                    int percent2 = Convert.ToInt32(percent);

                                    Double percent_tot = (total_prog * 100 / total_duration);
                                    int percent_tot_2 = Convert.ToInt32(percent_tot);

                                    if (percent_tot_2 <= 100)
                                    {
                                        this.InvokeEx(f => f.Pg1.Value = percent_tot_2);
                                        this.InvokeEx(f => f.Pg1.Refresh());
                                        if (Math.Round(percent_tot, 1).ToString().Contains(".") || Math.Round(percent_tot, 1).ToString().Contains(","))
                                        {
                                            this.InvokeEx(f => f.Pg1.Text = Math.Round(percent_tot, 1).ToString() + "%");
                                        }
                                        else
                                        {
                                            this.InvokeEx(f => f.Pg1.Text = Math.Round(percent_tot, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0" + "%");
                                        }
                                        this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, percent_tot, Pg1.Maximum));
                                    }
                                    if (percent2 <= 100)
                                    {
                                        //this.InvokeEx(f => pg_lv.Value = Convert.ToInt16(percent2));
                                        if (Math.Round(percent, 1).ToString().Contains(".") || Math.Round(percent, 1).ToString().Contains(","))
                                        {
                                            this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Value = Math.Round(percent, 1).ToString() + "%");
                                            //  this.InvokeEx(f => pg_lv.Text = Math.Round(percent, 1).ToString() + "%");
                                            //  this.InvokeEx(f => pg_lv.Refresh());
                                        }
                                        //this.InvokeEx(f => pg_lv.Refresh());
                                    }

                                    //Estimated remaining time
                                    try
                                    {
                                        remain_time = err_txt.Substring(err_txt.LastIndexOf("speed=") + 6, err_txt.Length - err_txt.LastIndexOf("speed=") - 6);
                                        remain_time = remain_time.Replace("x", String.Empty);
                                        Double timing1 = 0;

                                        if (System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator == ",")
                                        {
                                            timing1 = Math.Round(Double.Parse(remain_time.Replace(".", ",")), 2);
                                        }
                                        else
                                        {
                                            timing1 = Math.Round(Double.Parse(remain_time), 2);
                                        }

                                        Decimal timing = (decimal)timing1;
                                        Decimal total_dur_dec = Convert.ToDecimal(total_duration);
                                        Decimal total_prog_dec = Convert.ToDecimal(total_prog);
                                        Decimal remain_secs = 0;
                                        if (timing > 0)
                                        {
                                            remain_secs = (decimal)(total_dur_dec - total_prog_dec) / timing;
                                        }

                                        if (remain_secs > 60)
                                        {
                                            remain_secs = remain_secs + 60;
                                        }

                                        String remain_from_secs = "";

                                        TimeSpan t = TimeSpan.FromSeconds(Convert.ToDouble(remain_secs));
                                        remain_from_secs = string.Format("{0:D2}h:{1:D2}",
                                           t.Hours,
                                          t.Minutes);

                                        if (remain_secs >= 43200)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Math.Round(remain_secs / 3600).ToString() + " " + FFBatch.Properties.Strings.hours);
                                        }

                                        if (remain_secs >= 3600 && remain_secs < 43200)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs + " " + FFBatch.Properties.Strings.minutes_abrev);
                                        }

                                        if (remain_secs < 3600 && remain_secs >= 600)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes);
                                        }
                                        if (remain_secs < 600 && remain_secs >= 120)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes);
                                        }

                                        if (remain_secs <= 59)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Convert.ToInt16(remain_secs) + " " + FFBatch.Properties.Strings.seconds);
                                        }
                                    }
                                    catch { }

                                    //End remaining time
                                }
                            }

                            //Estimated size and bitrate

                            String read_size = String.Empty;
                            if (err_txt.Contains("size=") && (time_est_size % 3 == 0))
                            {
                                int size_index = err_txt.IndexOf("size=") + 5;
                                read_size = err_txt.Substring(size_index, 8);
                                try
                                {
                                    est_bitrate = Math.Round(Convert.ToDecimal(read_size) * 8 / Convert.ToDecimal(sec_prog), 0);

                                    if (Convert.ToDecimal(read_size) > 1 && time_n_tasks > 1)
                                    {
                                        if (est_bitrate < 9999)
                                        {
                                            this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " " + est_bitrate + " " + "Kb/s");
                                        }
                                        else
                                        {
                                            this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " " + (Math.Round(est_bitrate / 1000, 0)) + " " + "Mb/s");
                                        }
                                        //Estimated size
                                        est_size = Convert.ToDecimal(durat_n) * est_bitrate / 8;

                                        if (est_size > 1000000)
                                        {
                                            this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " " + (Math.Round(est_size / 1000000, 1)).ToString() + " " + "GB");
                                        }
                                        else
                                        {
                                            this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " " + (Math.Round(est_size / 1000, 0)).ToString() + " " + "MB");
                                        }
                                    }
                                }
                                catch { }

                                this.InvokeEx(f => f.lbl_est_size.Refresh());
                            }

                            //Read output, get progress
                            this.InvokeEx(f => f.listBox4.Items.Add(err_txt));
                            this.InvokeEx(f => f.listBox4.TopIndex = listBox4.Items.Count - 1);
                        }
                    }
                    else
                    {
                        if (dg1.Rows[list_index].Cells[3].Value.ToString() != "Live")
                        {
                            while (!process_glob.StandardOutput.EndOfStream)
                            {
                                err_txt = process_glob.StandardOutput.ReadLine();
                                list_lines.Add(err_txt);
                                if (err_txt.Contains("%"))
                                {
                                    try
                                    {
                                        Double prog_y = Double.Parse(err_txt.Substring(err_txt.IndexOf("%") - 4, 4));
                                        prog_y = prog_y / 10;
                                        int progress = Convert.ToInt32(prog_y);
                                        this.InvokeEx(f => dg1.Rows[list_index].Cells[5].Value = progress.ToString() + "%");
                                    }
                                    catch { }
                                }

                                if (Convert.ToInt32(start_total_time) >= 2 && Convert.ToInt32(start_total_time % 2) == 0)
                                {
                                    if (display_eta == true)
                                    {
                                        if (err_txt.ToLower().Contains("mib/s")) tr_speed = Properties.Strings2.transfer_r + " " + err_txt.Substring(err_txt.IndexOf("-> ") + 3, 5) + " MB/s";
                                        if (err_txt.ToLower().Contains("kib/s")) tr_speed = Properties.Strings2.transfer_r + " " + err_txt.Substring(err_txt.IndexOf("-> ") + 3, 5) + " KB/s";
                                        this.InvokeEx(f => f.lbl_dw_speed.Text = tr_speed);
                                    }
                                }

                                //Read output, get progress
                                this.InvokeEx(f => f.listBox4.Items.Add(err_txt));
                                this.InvokeEx(f => f.listBox4.TopIndex = listBox4.Items.Count - 1);
                            }
                        }
                        else
                        {
                            this.InvokeEx(f => f.Pg1.Text = FFBatch.Properties.Strings.recording1);
                            this.InvokeEx(f => f.Pg1.Refresh());
                        }
                    }

                    List<string> er = new List<string>();
                    String msg_er = String.Empty;

                    if (dg1.Rows[list_index].Cells[3].Value.ToString() != "Live")
                    {
                        while (!process_glob.StandardError.EndOfStream)
                        {
                            er.Add(process_glob.StandardError.ReadLine().Replace("yt-dlp.exe:", ""));
                        }
                    }

                    if (er.Count > 0)
                    {
                        foreach (String st in er)
                        {
                            if (st.ToLower().Contains("usage: youtube-dl") == false)
                            {
                                msg_er = msg_er + st;
                            }
                        }
                    }
                    if (list_index == 0 && msg_er != String.Empty)
                    {
                        this.InvokeEx(f => f.pic_recording.Visible = false);
                        if (msg_er.ToLower().Contains("warning")) MessageBox.Show(msg_er, Properties.Strings.warning, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                        else
                        {
                            MessageBox.Show(msg_er, Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            quit = true;
                            working = false;
                            m3u_running = false;
                            m3u_single_running = false;
                            timer2.Stop();
                            timer_tasks.Stop();
                            timer_est_size.Stop();
                            cancelados_paralelos = false;
                            aborted_url = false;
                            release_datagrid();
                            this.InvokeEx(f => f.Timer_display.Enabled = false);
                            this.InvokeEx(f => f.lbl_dw_speed.Text = "");
                            //this.InvokeEx(f => f.dg1.Rows[list_index].DefaultCellStyle.BackColor = Color.PaleGoldenrod);
                            this.InvokeEx(f => f.Pg1.Style = ProgressBarStyle.Continuous);
                            this.InvokeEx(f => f.pic_recording.Visible = false);
                            Enable_Controls();
                            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                            return;
                        }
                    }
                    process_glob.WaitForExit();
                    process_glob.StartInfo.Arguments = String.Empty;

                    timer_est_size.Stop();
                    time_est_size = 0;

                    this.InvokeEx(f => f.lbl_est_size.Text = String.Empty);
                    this.InvokeEx(f => f.lbl_bitrate.Text = String.Empty);

                    list_lines.Add("");
                    list_lines.Add("---------End of " + Path.GetFileName(file) + " log---------");
                    list_lines.Add("");

                    if (process_glob.ExitCode == 0)

                    {
                        if (skipped == false && aborted_url == false)
                        {
                            this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Value = FFBatch.Properties.Strings.success);
                            //this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Style.BackColor = Color.PaleGreen);
                        }
                        else
                        {
                            this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Value = FFBatch.Properties.Strings.skipped);
                            total_prog = total_prog + durat_n - sec_prog;
                            skipped = false;
                        }
                        if (aborted_url == true)
                        {
                            this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Value = FFBatch.Properties.Strings.aborted);
                            //this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Style.BackColor = Color.PaleGoldenrod);
                            aborted_url = false;
                        }
                        if (stopped_recording == true)
                        {
                            this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Value = "Stopped");
                            this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Style.BackColor = Color.White);
                        }
                    }
                    else
                    {
                        if (skipped == true)
                        {
                            this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Value = FFBatch.Properties.Strings.skipped);
                            total_prog = total_prog + durat_n - sec_prog;
                            skipped = false;
                        }
                        else
                        {
                            this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Value = FFBatch.Properties.Strings.failed);
                            errors_enc = errors_enc + 1;
                            //this.InvokeEx(f => f.dg1.Rows[list_index].Cells[5].Style.BackColor = Color.PaleGoldenrod);
                        }
                    }

                    if (list_index + 1 == list_proc.RowCount - 1 || quit == true)
                    {
                        this.InvokeEx(f => f.Pg1.Style = ProgressBarStyle.Continuous);
                        this.InvokeEx(f => f.pic_recording.Visible = false);
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        this.InvokeEx(f => f.Pg1.Value = Pg1.Maximum);
                        this.InvokeEx(f => f.Pg1.Text = "100%");
                        timer2.Stop();
                        this.InvokeEx(f => f.lbl_dw_speed.Text = "");
                        this.InvokeEx(f => f.Timer_display.Enabled = false);

                        m3u_single_running = false;
                        working = false;
                        m3u_running = false;
                        cancelados_paralelos = false;
                        release_datagrid();
                        //Save log
                        if (no_save_logs == false)
                        {
                            string[] array_err = list_lines.ToArray();

                            String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                            if (is_portable == true) path = port_path + "ff_batch_portable.log";

                            System.IO.StreamWriter SaveFile = new System.IO.StreamWriter(path);
                            SaveFile.WriteLine("Batch log sesion: " + System.DateTime.Now);
                            SaveFile.WriteLine("-----------------------");
                            foreach (String item in array_err)
                            {
                                SaveFile.WriteLine(item);
                            }
                            if (er.Count > 0) SaveFile.WriteLine(msg_er);
                            SaveFile.Close();

                            File.AppendAllText(path, "-----------------------");
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.end_log);
                            System.IO.FileInfo fileInfo = new System.IO.FileInfo(path);

                            var bytes = fileInfo.Length;

                            var kilobytes = (double)bytes / 1024;
                            var megabytes = kilobytes / 1024;
                            var gigabytes = megabytes / 1024;

                            //Format size view
                            String size = "";
                            String separator = ".";

                            if (bytes > 1000000000)
                            {
                                if (gigabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String gigas = gigabytes.ToString();
                                if (gigas.Length >= 5)
                                {
                                    gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                                    size = (gigas + " " + "GB");
                                }
                                else
                                {
                                    size = (gigas + " " + "GB");
                                }
                            }

                            if (bytes >= 1048576 && bytes <= 1000000000)
                            {
                                if (megabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }
                                String megas = megabytes.ToString();
                                if (megas.Length > 5)
                                {
                                    megas = megas.Substring(0, megas.LastIndexOf(separator));
                                    size = (megas + " " + "MB");
                                }
                                else
                                {
                                    size = (megas + " " + "MB");
                                }
                            }

                            if (bytes >= 1024 && bytes < 1048576)

                            {
                                if (kilobytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String kbs = kilobytes.ToString();
                                if (kbs.Length >= 5)
                                {
                                    kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                                    size = (kbs + " " + "KB");
                                }
                                else
                                {
                                    size = (kbs + " " + "KB");
                                }
                            }
                            if (bytes > -1 && bytes < 1024)
                            {
                                String bits = bytes.ToString();
                                size = (bits + " Bytes");
                            }

                            //End Format size view
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.log_size + " " + size);

                            //End save log
                        }
                        this.Invoke(new MethodInvoker(delegate
                        {
                            toolT002.RemoveAll();
                            if (errors_enc == 0) pic_no_errors.Visible = true;
                            else
                            {
                                pic_no_errors.Visible = false;
                                pic_recording.Visible = false;
                                toolT002.SetToolTip(this.pic_warnings, FFBatch.Properties.Strings.there_w + " " + errors_enc.ToString() + " " + FFBatch.Properties.Strings.errors_se);
                                pic_warnings.Visible = true;
                            }
                        }));

                        //Automatic shutdown check
                        if (chkshut.Checked && cancel_queue == false)
                        {
                            auto_shut();
                            return;
                        }
                        //End shutdown check
                        else
                        {
                            if (cancel_queue == false)
                            {
                                if (Form.ActiveForm == null)
                                {
                                    notifyIcon1.BalloonTipText = "FFmpeg Batch" + " - " + Properties.Strings2.url_down_c;
                                    notifyIcon1.BalloonTipIcon = ToolTipIcon.Info;
                                    notifyIcon1.BalloonTipTitle = Properties.Strings2.url_down_c2;
                                    notifyIcon1.ShowBalloonTip(0);
                                    if (play_on_end == true && er.Count == 0) play_end();
                                    if (er.Count > 0)
                                    {
                                        String warnings = "";
                                        foreach (String st in er) warnings = warnings + st;
                                        MessageBox.Show(Properties.Strings2.warn_down + " " + Environment.NewLine + Environment.NewLine + warnings + Environment.NewLine + Environment.NewLine + Properties.Strings.check_log, Properties.Strings.warning, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                                    }
                                }

                                if (chk_open_compl.Checked)
                                {
                                    if (Directory.GetFiles(destino).Length != 0)
                                    {
                                        Process open_processed = new Process();
                                        open_processed.StartInfo.FileName = "explorer.exe";
                                        open_processed.StartInfo.Arguments = '\u0022' + destino + '\u0022';
                                        open_processed.Start();
                                    }
                                    else
                                    {
                                        if (Directory.Exists(destino_test))
                                        {
                                            try
                                            {
                                                System.IO.Directory.Delete(destino_test);
                                            }
                                            catch { }
                                        }
                                    }
                                }
                            }
                            else
                            {
                                this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                                m3u_single_running = false;
                                cancelados_paralelos = false;
                                this.InvokeEx(f => f.Pg1.Value = Pg1.Maximum);
                                this.InvokeEx(f => f.Pg1.Text = "100%");
                                this.InvokeEx(f => f.lbl_dw_speed.Text = "");
                                if (quit == false && stopped_recording == false) this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.aborted, MessageBoxButtons.OK, MessageBoxIcon.Error));
                                //if (stopped_recording == true) this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.queue_abort, "Stopped", MessageBoxButtons.OK, MessageBoxIcon.Error));
                            }
                        }
                    }
                }

                Enable_Controls();
            }).Start();
        }

        public string UppercaseFirst(string text)
        {
            // Check for empty string.
            if (string.IsNullOrEmpty(text))
            {
                return string.Empty;
            }

            // Return char and concat substring.
            return char.ToUpper(text[0]) + text.Substring(1);
        }

        private void dg1_KeyUp(object sender, KeyEventArgs e)
        {
            if (m3u_running == true || m3u_single_running == true) return;

            if (e.KeyCode == Keys.Delete)
            {
                foreach (DataGridViewCell cell in dg1.SelectedCells)
                {
                    try
                    {
                        if (dg1.Rows[cell.RowIndex].Cells[0].Selected == true || dg1.Rows[cell.RowIndex].Cells[1].Selected == true)
                        {
                            foreach (DataGridViewCell cell2 in dg1.Rows[cell.RowIndex].Cells)
                            {
                                cell2.Selected = false;
                            }

                            dg1.Rows.RemoveAt(cell.RowIndex);
                        }
                    }
                    catch (Exception ex)
                    {
                        //MessageBox.Show("Item could not be removed. " + Environment.NewLine + Environment.NewLine + ex.Message);
                    }
                }
            }
        }

        private void btn_validate_url_Click_1(object sender, EventArgs e)
        {
            if (dg1.Rows.Count == 0) return;
            check_internet();
            if (internet_up == false) return;
            Boolean all_ready = true;

            foreach (DataGridViewRow row in dg1.Rows)
            {
                if (row.Cells[5].Value.ToString() == FFBatch.Properties.Strings.ready == false && row.Cells[5].Value.ToString() == FFBatch.Properties.Strings.success == false)
                {
                    row.Cells[0].Value = pic_noimg.Image;
                    row.Cells[5].Value = "";
                    row.Cells[5].Style.BackColor = row.DefaultCellStyle.BackColor;
                }
            }
            dg1.Refresh();

            cell_zoom();

            dg1.Refresh();
            stop_validating_url = false;

            foreach (DataGridViewRow row in dg1.Rows)
            {
                row.ReadOnly = true;
            }

            foreach (Control ct in groupBox_m3u.Controls)
            {
                ct.Enabled = false;
            }

            btn_cancel_validate.Enabled = true;

            if (dg1.Rows[0].Cells[1].Value.ToString().ToLower().Contains("youtu.be") || dg1.Rows[0].Cells[1].Value.ToString().ToLower().Contains("youtube.com"))
            {
                BG_Validate_URLs_YT.RunWorkerAsync();
            }
            else
            {
                opening_youtubes = false;
                BG_Validate_URLs.RunWorkerAsync();
            }
        }

        private void combo_ext_m3u_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (dg1.Rows.Count == 0)
            {
                if (combo_ext_m3u.SelectedIndex == 0)
                {
                    txt_m3u_params.Text = "-bsf:a aac_adtstoasc -c copy";
                }

                if (combo_ext_m3u.SelectedIndex == 1)
                {
                    txt_m3u_params.Text = "-fflags +genpts";
                }
            }
            else
            {
                if (dg1.Rows[0].Cells[1].Value.ToString().ToLower().Contains("youtu.be") && !dg1.Rows[0].Cells[1].Value.ToString().ToLower().Contains("youtube.com"))
                {
                    if (combo_ext_m3u.SelectedIndex == 0)
                    {
                        txt_m3u_params.Text = "-bsf:a aac_adtstoasc -c copy";
                    }

                    if (combo_ext_m3u.SelectedIndex == 1)
                    {
                        txt_m3u_params.Text = "-fflags +genpts";
                    }
                }
            }
        }

        private void Pre_validate_urls()
        {
            foreach (DataGridViewRow row in dg1.Rows)
            {
                row.ReadOnly = true;
            }

            foreach (Control ct in groupBox_m3u.Controls)
            {
                ct.Enabled = false;
            }
            btn_stop_m3u8.Enabled = true;
            BG_Validate_URLs.RunWorkerAsync();
        }

        private void btn_stop_m3u8_Click(object sender, EventArgs e)
        {
            if (dg1.SelectedCells.Count != 1) return;
            String type = "";

            if (working == true && m3u_single_running == true)
            {
                if (dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[1].Value.ToString().ToLower().Contains("youtu.be") || dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[1].Value.ToString().ToLower().Contains("youtube.com"))
                {
                    type = "youtube-dl";
                }
                else
                {
                    type = "ffmpeg";
                }
                Process[] localByName = Process.GetProcessesByName(type);
                foreach (Process p in localByName)
                {
                    if (p.Id == process_glob.Id)
                    {
                        try { p.Kill(); }
                        catch { }
                    }
                }
                skipped = true;
            }
        }

        private void btn_cancel_validate_Click(object sender, EventArgs e)
        {
            stop_validating_url = true;
            if (checking_url_m3u == true)
            {
                try { process_glob.Kill(); } catch { }
                return;
            }
            System.Threading.Thread.Sleep(100);
            Process[] localByName0 = Process.GetProcessesByName("yt-dlp");
            foreach (Process p0 in localByName0)
            {
                p0.Kill();
            }
            System.Threading.Thread.Sleep(100);

            Process[] localByName22 = Process.GetProcessesByName("yt-dlp");
            foreach (Process p3 in localByName22)
            {
                p3.Kill();
            }
        }

        private void chk_output_server_CheckedChanged(object sender, EventArgs e)
        {
            if (chk_output_server.CheckState == CheckState.Checked)
            {
                txt_output_server.Enabled = true;
                txt_path_m3u.Enabled = false;
                btn_browse_path_m3u.Enabled = false;
            }
            else
            {
                txt_output_server.Enabled = false;
                txt_path_m3u.Enabled = true;
                btn_browse_path_m3u.Enabled = true;
            }
        }

        private void ctm_m3u_Opening(object sender, CancelEventArgs e)
        {
            if (Clipboard.ContainsText() == false)
            {
                ct_paste_m3u.Enabled = false;
                ct_paste_youtube.Enabled = false;
            }

            if (Clipboard.GetText().ToLower().Contains("youtu.be") == true || Clipboard.GetText().ToLower().Contains("youtube.com") == true)
            {
                ct_paste_youtube.Enabled = true;
                ct_paste_m3u.Enabled = false;
            }
            else
            {
                ct_paste_youtube.Enabled = false;
                if (Clipboard.GetText().ToLower().Contains("http") == true)
                {
                    if (Clipboard.GetText().ToLower().Contains("m3u") == true)
                    {
                        ct_paste_m3u.Text = Properties.Strings.Paste_M3u_URL;
                    }
                    else
                    {
                        ct_paste_m3u.Text = Properties.Strings2.Paste_any_URL;
                    }
                    ct_paste_m3u.Enabled = true;
                }
                else
                {
                    ct_paste_m3u.Enabled = false;
                }
            }

            if (dg1.RowCount == 0)
            {
                ct_del_m3u.Enabled = false;
                ct_validate_url.Enabled = false;
                ct_remove_url.Enabled = false;
                ct_ren_urls.Enabled = false;
            }
            else
            {
                ct_del_m3u.Enabled = true;
                ct_validate_url.Enabled = true;
                ct_ren_urls.Enabled = true;
            }
            if (dg1.SelectedCells.Count > 0)
            {
                ct_play_vlc.Enabled = true;
                ct_show_urls.Enabled = true;
                ct_remove_url.Enabled = true;
            }
            else
            {
                ct_show_urls.Enabled = false;
                ct_play_vlc.Enabled = false;
                ct_remove_url.Enabled = false;
            }

            if (m3u_running == true)
            {
                ct_paste_m3u.Enabled = false;
                ct_paste_youtube.Enabled = false;
                ct_del_m3u.Enabled = false;
                ct_validate_url.Enabled = false;
                ct_show_urls.Enabled = false;
                ct_play_vlc.Enabled = false;
                ctm_stop_url.Enabled = false;
                ct_remove_url.Enabled = false;

                if (dg1.SelectedCells.Count == 1 && dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[5].Value.ToString() != FFBatch.Properties.Strings.ready && dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[5].Value.ToString() != FFBatch.Properties.Strings.success && dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[5].Value.ToString() != FFBatch.Properties.Strings.failed)
                {
                    ctm_stop_url.Enabled = true;
                    ctm_stop_url.Text = Properties.Strings2.stop_capt + " " + '\u0022' + dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[4].Value.ToString() + '\u0022';
                }
            }
        }

        private void ct_play_vlc_Click(object sender, EventArgs e)
        {
            if (dg1.SelectedCells.Count > 0)
            {
                try
                {
                    Process vlc_proc = new Process();
                    vlc_proc.StartInfo.FileName = "vlc.exe";
                    vlc_proc.StartInfo.Arguments = dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[1].Value.ToString();
                    vlc_proc.Start();
                }
                catch (System.Exception exctp)
                {
                    MessageBox.Show(Properties.Strings2.err_pl_vlc + " " + exctp.Message, Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                }
            }
        }

        private void dg1_DragEnter(object sender, DragEventArgs e)
        {
            if (e.Data.GetDataPresent(DataFormats.FileDrop, false))
                e.Effect = DragDropEffects.All;
            else
                e.Effect = DragDropEffects.None;
        }

        private void dg1_DragDrop(object sender, DragEventArgs e)
        {
            string[] file_drop = (string[])e.Data.GetData(DataFormats.FileDrop);
            if (file_drop.Count() > 1)
            {
                MessageBox.Show(Properties.Strings2.multi_drop, Properties.Strings2.multi_drop2, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }

            long length = new System.IO.FileInfo(file_drop[0]).Length;

            if (length > 1048576)
            {
                MessageBox.Show(Properties.Strings2.drop_big, Properties.Strings.file_big, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            dg1.Rows.Clear();
            stop_validating_url = false;

            String[] lines = File.ReadAllLines(file_drop[0]);

            for (int i = 0; i < lines.Count(); i++)
            {
                String out_file = String.Empty;

                if (lines[i].ToString().Length > 4 && lines[i].Substring(0, 4).ToLower() == "http")
                {
                    if (i > 0)

                    {
                        if (lines[i - 1].ToString().Substring(0, 7) == "#EXTINF")
                        {
                            out_file = lines[i - 1].Substring(lines[i - 1].LastIndexOf(",") + 1, lines[i - 1].Length - lines[i - 1].LastIndexOf(",") - 1);

                            dg1.Rows.Add(lines[i], "", "", out_file, "");
                        }
                        else
                        {
                            out_file = Path.GetFileNameWithoutExtension(lines[i]);
                            dg1.Rows.Add(lines[i], "", "", out_file, "");
                        }
                    }
                }
            }

            foreach (DataGridViewRow row in dg1.Rows)
            {
                row.ReadOnly = true;
            }
            foreach (Control ct in groupBox_m3u.Controls)
            {
                ct.Enabled = false;
            }
            btn_cancel_validate.Enabled = true;

            BG_Validate_URLs.RunWorkerAsync();
        }

        private void txt_search_url_TextChanged(object sender, EventArgs e)
        {
            foreach (DataGridViewRow row in dg1.Rows)
            {
                if (row.Cells[1].Value.ToString().ToLower().Contains(txt_search_url.Text.ToLower()) || row.Cells[4].Value.ToString().ToLower().Contains(txt_search_url.Text.ToLower()))
                {
                    dg1.ClearSelection();
                    dg1.Rows[row.Index].Cells[1].Selected = true;
                    dg1.CurrentCell = dg1.Rows[row.Index].Cells[1];
                    break;
                }
                else
                {
                    dg1.ClearSelection();
                    dg1.Rows[0].Cells[1].Selected = true;
                    dg1.CurrentCell = dg1.Rows[0].Cells[1];
                }
            }
        }

        private void btn_clean_errors_Click(object sender, EventArgs e)
        {
            btn_clean_list.PerformClick();
        }

        private void timer_urls_Tick(object sender, EventArgs e)
        {
            if (probe_urls.StartInfo.Arguments != String.Empty)
            {
                probe_urls.Kill();
            }
        }

        private void btn_url_info_Click(object sender, EventArgs e)
        {
            checking_url_m3u = false;
            if (dg1.SelectedCells.Count == 0) return;
            if (dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[1].Value.ToString().ToLower().Contains("youtu.be") || dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[1].Value.ToString().ToLower().Contains("youtube.com"))
            {
                Form8 frm8_streams = new Form8();
                //frm8_streams.thumb_url_streams = dg1_thumbs[dg1.SelectedCells[0].RowIndex];
                if (dg1.SelectedCells.Count != 1) return;
                else
                {
                    frm8_streams.url_dg_item = dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[1].Value.ToString();
                    frm8_streams.pic_yout.Image = dg_thumbs[dg1.SelectedCells[0].RowIndex];
                    frm8_streams.ShowDialog();
                    if (frm8_streams.format_ID != "")
                    {
                        chk_m3u_params.Checked = true;
                        if (txt_m3u_params.Text == "-bsf:a aac_adtstoasc -c copy" || txt_m3u_params.Text == "-fflags +genpts" || txt_m3u_params.Text.Contains("-f ")) txt_m3u_params.Text = "";
                        txt_m3u_params.Text = "-f " + frm8_streams.format_ID + " " + txt_m3u_params.Text;
                    }
                }
                return;
            }

            form5.lv1_item = dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[1].Value.ToString();
            form5.pic_http = dg_thumbs[dg1.SelectedCells[0].RowIndex];
            form5.ShowDialog();
        }

        private void ct_show_urls_Click(object sender, EventArgs e)
        {
            btn_url_info.PerformClick();
        }

        private void btn_n_urls_Click(object sender, EventArgs e)
        {
            cancelados_paralelos = false;
            notifyIcon1.Visible = true;
            if (m3u_running == true || m3u_single_running == true) return;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            foreach (DataGridViewRow row in dg1.Rows)
            {
                if (row.Cells[5].Value.ToString() == FFBatch.Properties.Strings.error || row.Cells[5].Value.ToString() == FFBatch.Properties.Strings.unknown)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.errors_list, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }

            if (dg1.RowCount == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.down_empty, FFBatch.Properties.Strings.no_files, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (txt_m3u_params.Text == String.Empty && chk_m3u_params.Text.ToLower().Contains("youtube"))
            {
                MessageBox.Show(FFBatch.Properties.Strings.capt_params, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (txt_path_m3u.Text == FFBatch.Properties.Strings.no_path2 && chk_output_server.CheckState == CheckState.Unchecked)
            {
                MessageBox.Show(FFBatch.Properties.Strings.select_out, FFBatch.Properties.Strings.out_conf, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }
            output_server_m = "";
            if (chk_output_server.CheckState == CheckState.Checked && txt_output_server.Text == String.Empty)
            {
                MessageBox.Show(FFBatch.Properties.Strings.out_serv1, FFBatch.Properties.Strings.warning, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }
            else
            {
                output_server_m = txt_output_server.Text;
            }

            get_mixed_urls(); //Mixed youtubes
            if (mixed_urls == true) return;

            // Live youtubes
            has_lives_multi = false;

            int has_lives = 0;
            int has_no_lives = 0;

            foreach (DataGridViewRow row in dg1.Rows)
            {
                if (row.Cells[1].Value.ToString().ToLower().Contains("youtu.be") || row.Cells[1].Value.ToString().ToLower().Contains("youtube.com"))
                {
                    if (row.Cells[3].Value.ToString() == "Live") has_lives++;
                    else has_no_lives++;
                }
            }

            if (has_no_lives > 0 && has_lives > 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.mix_urls2, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }
            if (has_lives > 0) has_lives_multi = true;
            else has_lives_multi = false;
            //End live youtubes

            foreach (DataGridViewRow row in dg1.Rows)
            {
                if (row.Cells[5].Value.ToString() == FFBatch.Properties.Strings.ready && row.Cells[2].Value.ToString() != FFBatch.Properties.Strings.n_a)
                {
                    if (row.Cells[3].Value.ToString() != "00:00" && row.Cells[3].Value.ToString() != "Live")
                    {
                        if (TimeSpan.Parse(row.Cells[3].Value.ToString()).TotalSeconds > TimeSpan.Parse(row.Cells[2].Value.ToString()).TotalSeconds)
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.capture_time2 + " " + row.Cells[4].Value.ToString() + Properties.Strings2.exc_dur, Properties.Strings2.wrong_c_dur, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            return;
                        }
                    }
                }
            }
            foreach (DataGridViewRow row in dg1.Rows)
            {
                if (row.Cells[4].Value.ToString().Contains("/") || row.Cells[4].Value.ToString().Contains(":") || row.Cells[4].Value.ToString().Contains("*") || row.Cells[4].Value.ToString().Contains("?") || row.Cells[4].Value.ToString().Contains("¿") || row.Cells[4].Value.ToString().Contains('\u0022') || row.Cells[4].Value.ToString().Contains("<") || row.Cells[4].Value.ToString().Contains(">") || row.Cells[4].Value.ToString().Contains("|") || row.Cells[4].Value.ToString().Contains("\\"))
                {
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("/", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace(":", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("*", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("?", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("¿", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("\u0022", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("<", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace(">", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("|", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("\\", "");
                }
            }

            //Pending validation
            Boolean pre_validate = false;

            foreach (DataGridViewRow row in dg1.Rows)
            {
                if (row.Cells[5].Value.ToString() == String.Empty)
                {
                    pre_validate = true;
                }
            }
            if (pre_validate == true)
            {
                var a = MessageBox.Show(FFBatch.Properties.Strings.val_urls, FFBatch.Properties.Strings.val_pending, MessageBoxButtons.OKCancel, MessageBoxIcon.Question);
                if (a == DialogResult.OK)
                {
                    was_started.Text = btn_start_m3u.Text;
                    btn_validate_url.PerformClick();
                    return;
                }
                else
                {
                    return;
                }
            }

            if (url_repeat() == true) return;

            multi_dest = "";
            multi_dest = dg1.Rows[0].Cells[1].Value.ToString();
            String file_output = dg1.Rows[0].Cells[5].Value.ToString() + "." + combo_ext_m3u.SelectedItem.ToString();
            String fichero = Path.GetFileName(multi_dest);

            String destino_test = Path.Combine(txt_path_m3u.Text, "FFBatch_test");

            if (!multi_dest.ToLower().Contains("youtu.be") && !multi_dest.ToLower().Contains("youtube.com"))
            {
                this.Cursor = Cursors.WaitCursor;

                if (!Directory.Exists(destino_test))
                {
                    try
                    {
                        Directory.CreateDirectory(destino_test);
                    }
                    catch (System.Exception excpt)
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.error_test_f + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        this.Cursor = Cursors.Arrow;
                        return;
                    }
                }

                if (chk_try.CheckState == CheckState.Unchecked)
                {
                    //Try preset

                    Form11 frm_prog = new Form11();

                    new System.Threading.Thread(() =>
                    {
                        System.Threading.Thread.CurrentThread.IsBackground = true;
                        frm_prog.label1.Text = FFBatch.Properties.Strings.trying;
                        frm_prog.label1.Refresh();
                        frm_prog.ShowDialog();
                        frm_prog.Refresh();
                    }).Start();

                    Process consola_pre = new Process();

                    consola_pre.StartInfo.FileName = "ffmpeg.exe";
                    consola_pre.StartInfo.Arguments = " -i " + multi_dest + " -t 0.5 " + txt_m3u_params.Text + " -y " + '\u0022' + destino_test + "\\" + file_output + '\u0022';
                    consola_pre.StartInfo.CreateNoWindow = true;
                    consola_pre.StartInfo.RedirectStandardError = true;
                    consola_pre.StartInfo.RedirectStandardOutput = true;
                    consola_pre.StartInfo.UseShellExecute = false;

                    consola_pre.Start();
                    frm_prog.procId = consola_pre.Id;
                    String err_txt_1 = "";

                    while (!consola_pre.StandardError.EndOfStream)
                    {
                        err_txt_1 = consola_pre.StandardError.ReadLine();
                        this.InvokeEx(f => f.listBox4.Items.Add(err_txt_1));
                        this.InvokeEx(f => f.listBox4.Refresh());
                    }

                    consola_pre.WaitForExit(7000);

                    consola_pre.StartInfo.Arguments = String.Empty;

                    if (consola_pre.StartInfo.Arguments != String.Empty)
                    {
                        consola_pre.Kill();
                        try
                        {
                            frm_prog.Invoke(new MethodInvoker(delegate
                            {
                                frm_prog.Dispose();
                            }));
                        }
                        catch { }

                        MessageBox.Show(FFBatch.Properties.Strings.url_out, FFBatch.Properties.Strings.url_out2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }
                    if (consola_pre.ExitCode != 0)
                    {
                        this.Cursor = Cursors.Arrow;
                        try
                        {
                            frm_prog.Invoke(new MethodInvoker(delegate
                            {
                                frm_prog.Dispose();
                            }));
                        }
                        catch { }

                        listBox4.TopIndex = listBox4.Items.Count - 1;
                        listBox4.Refresh();

                        this.Cursor = Cursors.Arrow;
                        if (File.Exists(Path.Combine(destino_test, file_output)))
                        {
                            File.Delete(Path.Combine(destino_test, file_output));
                        }

                        if (Directory.GetFiles(destino_test).Length == 0)
                        {
                            System.IO.Directory.Delete(destino_test);
                        }
                        if (frm_prog.abort_validate == false)
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.ebc_fail_ff, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            return;
                        }
                    }
                    else
                    {
                        frm_prog.Invoke(new MethodInvoker(delegate
                        {
                            frm_prog.pic.Visible = false;
                            frm_prog.pic_ok.Visible = true;
                            frm_prog.pic_ok.Refresh();
                        }));
                        Thread.Sleep(175);
                        try
                        {
                            frm_prog.Invoke(new MethodInvoker(delegate
                            {
                                frm_prog.Dispose();
                            }));
                        }
                        catch { }

                        this.Cursor = Cursors.Arrow;
                        if (File.Exists(Path.Combine(destino_test, file_output)))
                        {
                            File.Delete(Path.Combine(destino_test, file_output));
                        }

                        if (Directory.GetFiles(destino_test).Length == 0)
                        {
                            System.IO.Directory.Delete(destino_test);
                        }
                    }
                }
                //END try preset
            }
            else
            {
                if (!File.Exists(System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe")))
                {
                    this.Cursor = Cursors.Arrow;
                    release_datagrid();
                    MessageBox.Show(FFBatch.Properties.Strings.yt_not, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }
            this.Cursor = Cursors.Arrow;

            //Start pre-processing
            cancel_queue = false;
            Pg1.Value = 0;
            //pg_current.Value = 0;
            Disable_Controls();
            //textBox4.Text = "0%";

            working = true;
            m3u_single_running = false;
            txt_remain.Text = "";

            //Disable Datagrid edition

            foreach (DataGridViewRow row in dg1.Rows)
            {
                row.ReadOnly = true;
                //row.DefaultCellStyle.BackColor = Color.White;
                row.Cells[5].Value = FFBatch.Properties.Strings.ready;
                //row.Cells[5].Style.BackColor = Color.White;
            }

            DataGridView list_proc = new DataGridView();
            foreach (DataGridViewColumn col in dg1.Columns)
            {
                list_proc.Columns.Add((DataGridViewColumn)col.Clone());
            }

            foreach (DataGridViewRow row in dg1.Rows)
            {
                list_proc.Rows.Add(row.Cells[1].Value.ToString(), row.Cells[2].Value.ToString(), row.Cells[3].Value.ToString(), row.Cells[4].Value.ToString(), row.Cells[5].Value.ToString());
            }

            Pg1.Minimum = 0;
            Pg1.Maximum = 100;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            //String remain_time = "0";

            //Total duration

            total_multi_duration = 0;
            foreach (DataGridViewRow row in dg1.Rows)
            {
                DateTime time2;
                if (DateTime.TryParse(row.Cells[3].Value.ToString(), out time2))

                {
                    total_multi_duration = total_multi_duration + TimeSpan.Parse((row.Cells[3].Value.ToString())).TotalSeconds;
                }
            }
            //End total duration

            procs.Clear();
            multi_logs.Clear();
            for (int ii = 0; ii < dg1.RowCount; ii++)
            {
                procs.Add("proc_urls_" + ii.ToString(), new Process());
                multi_logs.Add("log_n_" + ii.ToString(), "");
            }

            show_total_prog_m = false;
            foreach (DataGridViewRow row in dg1.Rows)
            {
                TimeSpan time = new TimeSpan();
                if (TimeSpan.TryParse(row.Cells[3].Value.ToString(), out time))
                {
                    show_total_prog_m = true;
                }
                else
                {
                    show_total_prog_m = false;
                    break;
                }
            }
            if (show_total_prog_m == true)
            {
                Pg1.Value = 0;
                Pg1.Maximum = dg1.RowCount * 100;
            }

            m3u_params_m = txt_m3u_params.Text;
            if (chk_m3u_params.CheckState == CheckState.Unchecked) m3u_params_m = "";
            m3u_output_ext_m = combo_ext_m3u.SelectedItem.ToString();

            format_out_m = m3u_output_ext_m;
            down_speed_m = ""; embed_subs_m = ""; embed_meta_m = ""; write_subs_m = ""; convert_subs_m = "";

            if (chk_best_yt.Checked) bestv_a = "-f bestvideo[ext=mp4]+bestaudio[ext=m4a]/bestvideo+bestaudio";
            else bestv_a = String.Empty;

            if (chk_down_limit.Checked == true) down_speed_m = "-r " + Convert.ToInt32(n_down_speed.Value).ToString() + "M";
            if (chk_yout_subs.Checked == true) embed_subs_m = "--embed-subs --all-subs";
            if (chk_auto_subs.Checked == true)
            {
                auto_subs_m = "--write-auto-sub --sub-lang en,es,it,pt,de,hi,ar,cn";
                if (chk_yout_subs.Checked == true) embed_subs_m = "--embed-subs";
            }
            if (chk_embed_meta.Checked == true) embed_meta_m = "--add-metadata";
            if (chk_save_subtitles.Checked == true) embed_meta_m = "--write-sub";
            if (chk_convert_srt.Checked == true) embed_meta_m = "--convert-subs=srt";

            time_n_tasks = 0;
            timer_tasks.Start();
            timer2.Start();

            m3u_running = true;
            aborted_url = false;
            pic_no_errors.Visible = false;
            pic_warnings.Visible = false;
            pic_recording.Visible = false;
            errors_enc = 0;

            if (has_lives_multi == true)
            {
                pic_recording.Visible = true;
                Pg1.Style = ProgressBarStyle.Marquee;
                Pg1.MarqueeAnimationSpeed = 50;
            }
            else
            {
                Pg1.Style = ProgressBarStyle.Continuous;
                pic_recording.Visible = false;
            }

            try
            {
                BG_Multi_Down.RunWorkerAsync();
            }
            catch
            {
                MessageBox.Show(FFBatch.Properties.Strings.queue_prog_a);
            }
        }

        private void ctm_stop_url_Click(object sender, EventArgs e)
        {
            if (dg1.SelectedCells.Count == 1 && dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[5].Value.ToString() != FFBatch.Properties.Strings.success && dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[5].Value.ToString() != FFBatch.Properties.Strings.ready)
            {
                if (m3u_single_running == false)
                {
                    if (dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[1].Value.ToString().ToLower().Contains("youtu.be") || dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[1].Value.ToString().ToLower().Contains("youtube.com"))
                    {
                        if (dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[5].Value.ToString() == FFBatch.Properties.Strings.recording1)
                        {
                            dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[5].Value = FFBatch.Properties.Strings.stopping;
                            Send_CTRLC(procs["proc_urls_" + dg1.Rows[dg1.SelectedCells[0].RowIndex].Index.ToString()]);
                        }
                        else
                        {
                            Process[] localByName = Process.GetProcessesByName("yt-dlp");
                            foreach (Process p in localByName)
                            {
                                if (p.Id == procs["proc_urls_" + dg1.Rows[dg1.SelectedCells[0].RowIndex].Index.ToString()].Id)
                                {
                                    try { p.Kill(); }
                                    catch { }
                                }
                            }
                        }
                    }
                    else
                    {
                        StreamWriter write_q = procs["proc_urls_" + dg1.Rows[dg1.SelectedCells[0].RowIndex].Index.ToString()].StandardInput;
                        write_q.Write("q");
                        aborted_url = true;
                    }
                }
                else
                {
                    if (dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[1].Value.ToString().ToLower().Contains("youtu.be") || dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[1].Value.ToString().ToLower().Contains("youtube.com"))
                    {
                        if (dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[5].Value.ToString() == FFBatch.Properties.Strings.recording1)
                        {
                            //Live YouTube abort
                            timer2.Stop();
                            aborted_url = false;
                            stopped_recording = true;
                            Pg1.MarqueeAnimationSpeed = 15;
                            Pg1.Text = FFBatch.Properties.Strings.stopping2;
                            Pg1.Refresh();
                            Send_CTRLC(process_glob);
                        }
                        else
                        {
                            Process[] localByName = Process.GetProcessesByName("yt-dlp");
                            foreach (Process p in localByName)
                            {
                                if (p.Id == process_glob.Id)
                                {
                                    try { p.Kill(); }
                                    catch { }
                                    break;
                                }
                            }
                        }
                    }
                    else
                    {
                        StreamWriter write_q = process_glob.StandardInput;
                        write_q.Write("q");
                        aborted_url = true;
                    }
                }
            }
        }

        private void check_decoders()
        {
            if (cb_hwdecode.SelectedItem.ToString() != "none")

            {
                hw_decode_glob = cb_hwdecode.SelectedItem.ToString();
            }
        }

        private void BG_Try_preset_DoWork(object sender, DoWorkEventArgs e)
        {
            if (chk_try.CheckState == CheckState.Checked)
            {
                tried_ok = true;
                return;
            }
            else tried_ok = false;

            this.InvokeEx(f => this.Enabled = false);
            Form11 frm_prog = new Form11();

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;
                frm_prog.reading = FFBatch.Properties.Strings.trying;
                frm_prog.label1.Refresh();
                frm_prog.ShowDialog();
                frm_prog.Refresh();
            }).Start();

            this.InvokeEx(f => this.Cursor = Cursors.WaitCursor);
            ListBox LB1_o = new ListBox();
            Process consola_pre = new Process();
            String file_prueba = "";
            String sel_test = "";

            Double size_dur = 0;
            Double file_size = 0;

            listView1.Invoke(new MethodInvoker(delegate
            {
                sel_test = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text;
                FileInfo fs = new FileInfo(sel_test);
                file_size = fs.Length;
                try
                {
                    size_dur = TimeSpan.Parse(listView1.Items[0].SubItems[3].Text).TotalSeconds;
                }
                catch { size_dur = 0; }
            }));

            file_prueba = sel_test;
            String destino_test = Path.GetTempPath() + "\\" + "FFBatch_test";
            Boolean bad_chars = false;
            Boolean unsupported = false;
            String second_path = "";

            if (txt_format.Text == "nul")
            {
                String[] split = txt_parameters.Text.Split(' ');
                for (int i = 0; i < split.Length; i++)
                {
                    if (split[i].Contains("\\") == true)
                    {
                        String pre_path = split[i].Replace("%fp", Path.GetDirectoryName(sel_test)).Replace("%fn", Path.GetFileNameWithoutExtension(sel_test)).Replace("%", "_");
                        second_path = Path.GetDirectoryName(pre_path.Replace('\u0022', ' '));

                        if (!Directory.Exists(second_path))
                        {
                            try
                            {
                                Directory.CreateDirectory(second_path);
                            }
                            catch
                            {
                            }
                        }
                    }
                }
            }

            Task tt = Task.Run(() =>
            {
                String fichero = Path.GetFileName(file_prueba);

                if (!Directory.Exists(destino_test))
                {
                    try
                    {
                        Directory.CreateDirectory(destino_test);
                    }
                    catch (System.Exception excpt)
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                        return;
                    }
                }

                String ext_output = txt_format.Text;
                if (txt_format.Text == String.Empty)
                {
                    ext_output = Path.GetExtension(file_prueba);
                }
                else
                {
                    ext_output = "." + txt_format.Text;
                }
                if (txt_format.Text == "nul") ext_output = "nul";

                textbox_params = txt_parameters.Text;
                String file_prueba2 = file_prueba;

                while (textbox_params.Contains("%fn"))
                {
                    if (textbox_params.Contains("%fn"))
                    {
                        textbox_params = textbox_params.Replace("%fn", Path.GetFileNameWithoutExtension(file_prueba));
                    }
                }

                while (textbox_params.Contains("%fp"))
                {
                    if (textbox_params.Contains("%fp"))
                    {
                        textbox_params = textbox_params.Replace("%fp", Path.GetDirectoryName(file_prueba));
                    }
                }

                while (textbox_params.Contains("%fd"))
                {
                    if (textbox_params.Contains("%fd"))
                    {
                        var path = Path.GetFullPath(file_prueba);
                        var dirName = Path.GetFileName(Path.GetDirectoryName(path));
                        textbox_params = textbox_params.Replace("%fd", dirName);
                    }
                }

                while (textbox_params.Contains("%1"))
                {
                    if (textbox_params.Contains("%1"))
                    {
                        if (file_prueba2.Contains("[") || file_prueba2.Contains("]"))
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.conflict_char, FFBatch.Properties.Strings.conflict_char2, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                            Enable_Controls();
                            this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                            tried_ok = false;
                            bad_chars = true;
                            return;
                        }
                        file_prueba2 = file_prueba2.Replace("\\", "\\\\\\\\");
                        file_prueba2 = file_prueba2.Replace(":", ":" + "\\\\");
                        textbox_params = textbox_params.Replace("%1", '\u0022' + file_prueba2 + '\u0022');
                    }
                }

                while (textbox_params.Contains("%2"))
                {
                    if (textbox_params.Contains("%2"))
                    {
                        file_prueba2 = file_prueba2.Replace("\\", "\\\\\\\\");
                        file_prueba2 = file_prueba2.Replace(":", ":" + "\\\\");
                        textbox_params = textbox_params.Replace("%2", '\u0022' + Path.Combine(System.IO.Path.GetDirectoryName(file_prueba2), Path.GetFileNameWithoutExtension(file_prueba2)) + '\u0022');
                    }
                }

                String pre_i = "";
                txt_pre_input.Invoke(new MethodInvoker(delegate
                {
                    pre_i = txt_pre_input.Text;
                }));

                consola_pre.StartInfo.FileName = "ffmpeg.exe";

                if (textbox_params.Contains(" (segment_size) "))
                {
                    Double split_size = Convert.ToDouble(split_by_size);
                    String ff_frames = String.Empty;
                    Double ov_bitrate = 0;
                    ov_bitrate = file_size / size_dur;
                    Double bit_r = 0;
                    bit_r = ov_bitrate / 1000000;
                    bit_r = split_size / bit_r;
                    bit_r = Math.Round(bit_r, 2);
                    textbox_params = textbox_params.Replace(" (segment_size) ", " " + bit_r.ToString().Replace(",", ".") + " ");
                }

                consola_pre.StartInfo.Arguments = pre_i + " " + hw_decode_glob + " -i " + "" + '\u0022' + file_prueba + '\u0022' + "" + " -y " + textbox_params + " -t 0.2 " + '\u0022' + destino_test + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + ext_output + '\u0022' + " -loglevel warning -stats";
                if (ext_output == "nul") consola_pre.StartInfo.Arguments = pre_i + " " + hw_decode_glob + " -loglevel warning -stats" + " -i " + "" + '\u0022' + file_prueba + '\u0022' + " " + textbox_params;

                consola_pre.StartInfo.RedirectStandardOutput = true;
                consola_pre.StartInfo.RedirectStandardError = true;
                consola_pre.StartInfo.UseShellExecute = false;
                consola_pre.StartInfo.CreateNoWindow = true;
                consola_pre.EnableRaisingEvents = true;
                consola_pre.Start();
                frm_prog.procId = consola_pre.Id;

                while (!consola_pre.StandardError.EndOfStream)
                {
                    this.InvokeEx(f => LB1_o.Items.Add(consola_pre.StandardError.ReadLine()));
                    this.InvokeEx(f => LB1_o.TopIndex = LB1_o.Items.Count - 1);
                    this.InvokeEx(f => LB1_o.Refresh());
                }

                consola_pre.WaitForExit();
                consola_pre.StartInfo.Arguments = String.Empty;
                this.InvokeEx(f => this.Enabled = true);
            });

            if (!tt.Wait(1000) && consola_pre.StartInfo.Arguments != String.Empty)
            {
                this.InvokeEx(f => this.Enabled = true);
                frm_prog.Invoke(new MethodInvoker(delegate
                {
                    frm_prog.pic.Visible = false;
                    frm_prog.pic_ok.Visible = true;
                    frm_prog.pic_ok.Refresh();
                }));
                Thread.Sleep(175);
                try
                {
                    frm_prog.Invoke(new MethodInvoker(delegate
                    {
                        frm_prog.Dispose();
                    }));
                }
                catch { }
                try { consola_pre.Kill(); } catch { }
                tried_ok = true;
                this.InvokeEx(f => f.btn_try_pr.Image = img_try.Images[1]);
                this.InvokeEx(f => this.Cursor = Cursors.Arrow);

                if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length > 0)
                {
                    foreach (String file in Directory.GetFiles(destino_test))
                    {
                        try
                        {
                            File.Delete(file);
                        }
                        catch
                        {
                        }
                    }
                }

                if (Directory.GetFiles(destino_test).Length == 0)
                {
                    System.IO.Directory.Delete(destino_test);
                }
                LB1_o.Items.Clear();
                tried_params.Add(txt_parameters.Text);
                return;
            }

            if (bad_chars == false)
            {
                if (consola_pre.ExitCode != 0)
                {
                    if (frm_prog.abort_validate == false)
                    {
                        if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length > 0)
                        {
                            foreach (String file in Directory.GetFiles(destino_test))
                            {
                                try
                                {
                                    File.Delete(file);
                                }
                                catch
                                {
                                }
                            }
                        }

                        if (Directory.GetFiles(destino_test).Length == 0)
                        {
                            System.IO.Directory.Delete(destino_test);
                        }

                        this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                        foreach (String lin in LB1_o.Items)
                        {
                            if (lin.Contains("not load the requested plugin") || lin.Contains("Cannot load nvcuda.dll"))
                            {
                                unsupported = true;
                            }
                        }
                        tried_ok = false;
                        try
                        {
                            frm_prog.Invoke(new MethodInvoker(delegate
                            {
                                frm_prog.Dispose();
                            }));
                        }
                        catch { }
                        this.InvokeEx(f => f.btn_try_pr.Image = img_try.Images[2]);
                        int n_lines = LB1_o.Items.Count;

                        if (unsupported == true)
                        {
                            this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                            this.InvokeEx(f => this.Enabled = true);
                            this.InvokeEx(f => this.TopLevel = true);

                            MessageBox.Show(FFBatch.Properties.Strings.test_failed + " " + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.unsup_enc + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 1].ToString() + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.try_pr, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        }
                        else
                        {
                            this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                            this.InvokeEx(f => this.Enabled = true);
                            this.InvokeEx(f => this.TopLevel = true);

                            if (n_lines >= 4)
                            {
                                MessageBox.Show(FFBatch.Properties.Strings.test_failed + " " + Environment.NewLine + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 4].ToString() + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 3].ToString() + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 2].ToString() + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 1].ToString() + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.try_pr, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            }
                            if (n_lines == 3)
                            {
                                MessageBox.Show(FFBatch.Properties.Strings.test_failed + " " + Environment.NewLine + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 3].ToString() + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 2].ToString() + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 1].ToString() + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.try_pr, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            }
                            if (n_lines == 2)
                            {
                                MessageBox.Show(FFBatch.Properties.Strings.test_failed + " " + Environment.NewLine + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 2].ToString() + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 1].ToString() + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.try_pr, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            }
                            if (n_lines == 1)
                            {
                                MessageBox.Show(FFBatch.Properties.Strings.test_failed + " " + Environment.NewLine + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 1].ToString() + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.try_pr, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            }
                        }

                        return;
                    }
                }
                else
                {
                    try
                    {
                        frm_prog.Invoke(new MethodInvoker(delegate
                        {
                            frm_prog.pic.Visible = false;
                            frm_prog.pic_ok.Visible = true;
                            frm_prog.pic_ok.Refresh();
                        }));
                    }
                    catch { }
                    System.Threading.Thread.Sleep(175);
                    try
                    {
                        frm_prog.Invoke(new MethodInvoker(delegate
                        {
                            frm_prog.Dispose();
                        }));
                    }
                    catch { }
                    if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length > 0)
                    {
                        foreach (String file in Directory.GetFiles(destino_test))
                        {
                            try
                            {
                                File.Delete(file);
                            }
                            catch
                            {
                            }
                        }
                    }

                    if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length == 0)
                    {
                        System.IO.Directory.Delete(destino_test);
                    }
                    tried_params.Add(txt_parameters.Text);
                    tried_ok = true;
                }
            }
            //END try preset
            this.InvokeEx(f => this.Cursor = Cursors.Arrow);

            if (Directory.Exists(destino_test))
            {
                if (Directory.GetFiles(destino_test).Length == 0)
                {
                    System.IO.Directory.Delete(destino_test);
                }
            }
            LB1_o.Items.Clear();
            consola_pre.Dispose();
        }

        private void BG_Try_preset_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            String file_prueba = "";

            String sel_test = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
            file_prueba = sel_test;
            String destino = Path.Combine(Path.GetTempPath(), "FFBatch_test");
            String borrar = destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + txt_format.Text;

            if (File.Exists(borrar))
            {
                try
                {
                    File.Delete(borrar);
                }
                catch
                {
                }
            }

            if (Directory.Exists(destino) == true)
            {
                try
                {
                    if (Directory.GetFiles(destino).Length == 0)
                    {
                        System.IO.Directory.Delete(destino);
                    }
                }
                catch { }
            }

            //Re-route to pressed button
            if (tried_ok == true)
            {
                if (was_started.Text == btn_seq.Text)
                {
                    btn_seq.PerformClick();
                }

                if (was_started.Text == btn_multi_m.Text)
                {
                    btn_multi_m.PerformClick();
                }
                if (was_started.Text == btn_concat.Text)
                {
                    btn_concat.PerformClick();
                }
                if (was_started.Text == btn_trim.Text)
                {
                    btn_trim.PerformClick();
                }
            }
        }

        private void frm_output2_FormClosing(object sender, System.EventArgs e)
        {
            this.InvokeEx(f => f.btn_try_pr.Enabled = true);
            this.InvokeEx(f => this.Enabled = true);
        }

        private void BG_Try_button_DoWork(object sender, DoWorkEventArgs e)
        {
            Boolean failed = false;
            Double size_dur = 0;
            Double file_size = 0;
            String sel_test = "";
            this.InvokeEx(f => f.btn_try_pr.Image = img_try.Images[0]);
            listView1.Invoke(new MethodInvoker(delegate
            {
                sel_test = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text;
                FileInfo fs = new FileInfo(sel_test);
                file_size = fs.Length;
                try
                {
                    size_dur = TimeSpan.Parse(listView1.Items[0].SubItems[3].Text).TotalSeconds;
                }
                catch { size_dur = 0; }
            }));
            this.InvokeEx(f => this.Cursor = Cursors.WaitCursor);
            this.InvokeEx(f => f.btn_try_pr.Enabled = false);

            frm_output2.Name = FFBatch.Properties.Strings.try_ff2;
            frm_output2.Icon = this.Icon;

            frm_output2.Height = 575;
            frm_output2.Width = 977;
            frm_output2.FormBorderStyle = FormBorderStyle.Fixed3D;
            frm_output2.MaximizeBox = false;
            frm_output2.MinimizeBox = false;

            var fuente_list = new System.Drawing.Font("Microsoft Sans Serif", 8, FontStyle.Regular);

            LB1_o_try.Items.Clear();
            LB1_o_try.Parent = frm_output2;
            LB1_o_try.Left = 20;
            LB1_o_try.Top = 65;
            LB1_o_try.Height = 425;
            LB1_o_try.Width = 920;
            LB1_o_try.Font = fuente_list;
            LB1_o_try.Click += new EventHandler(LB1_o_Click);

            TextBox titulo = new TextBox();
            titulo.Parent = frm_output2;
            titulo.Top = 15;
            titulo.Left = 20;
            titulo.Width = 921;
            titulo.TabIndex = 0;
            var fuente = new System.Drawing.Font("Microsoft Sans Serif", 11, FontStyle.Bold);

            titulo.Font = fuente;
            titulo.BorderStyle = BorderStyle.Fixed3D;
            titulo.TextAlign = HorizontalAlignment.Center;
            titulo.ReadOnly = true;

            titulo.Text = FFBatch.Properties.Strings.proc_ff;

            Button boton_ok_ff = new Button();
            boton_ok_ff.Parent = frm_output2;
            boton_ok_ff.Left = 480;
            boton_ok_ff.Top = 495;
            boton_ok_ff.Width = 461;
            boton_ok_ff.Height = 27;
            boton_ok_ff.Text = FFBatch.Properties.Strings.proc_file;
            boton_ok_ff.Click += new EventHandler(boton_ok_ff_Click);

            Button boton_copy_ff = new Button();
            boton_copy_ff.Parent = frm_output2;
            boton_copy_ff.Left = 20;
            boton_copy_ff.Top = 495;
            boton_copy_ff.Width = 461;
            boton_copy_ff.Height = 27;
            boton_copy_ff.Text = FFBatch.Properties.Strings.clipb;
            boton_copy_ff.Click += new EventHandler(boton_copy_ff_Click);

            Process consola = new Process();
            String file_prueba = "";
            file_prueba = sel_test;
            String destino = Path.GetTempPath() + "\\" + "FFBatch_test";
            Boolean timed_out = false;
            frm_output2.FormClosing += frm_output2_FormClosing;

            Task tt = Task.Run(() =>
            {
                consola.StartInfo.FileName = "ffmpeg.exe";

                String fichero = Path.GetFileName(file_prueba);
                TextBox titulo2 = new TextBox();
                titulo2.Parent = frm_output2;
                titulo2.Top = 42;
                titulo2.Left = 47;
                titulo2.Width = 867;

                var fuente2 = new System.Drawing.Font("Microsoft Sans Serif", 10, FontStyle.Regular);

                titulo2.Font = fuente2;
                titulo2.BorderStyle = BorderStyle.None;
                titulo2.TextAlign = HorizontalAlignment.Center;
                titulo2.ReadOnly = true;

                titulo2.Text = (fichero);

                frm_output2.StartPosition = FormStartPosition.CenterScreen;

                if (!Directory.Exists(destino))
                {
                    try
                    {
                        Directory.CreateDirectory(destino);
                    }
                    catch (System.Exception excpt)
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }
                }

                String ext_output = txt_format.Text;
                if (txt_format.Text == String.Empty)
                {
                    ext_output = Path.GetExtension(file_prueba);
                }
                else
                {
                    ext_output = "." + txt_format.Text;
                }
                if (txt_format.Text == "nul") ext_output = "nul";
                textbox_params = txt_parameters.Text;

                if (textbox_params.Contains(" (segment_size) "))
                {
                    Double split_size = Convert.ToDouble(split_by_size);
                    String ff_frames = String.Empty;
                    Double ov_bitrate = 0;
                    ov_bitrate = file_size / size_dur;
                    Double bit_r = 0;
                    bit_r = ov_bitrate / 1000000;
                    bit_r = split_size / bit_r;
                    bit_r = Math.Round(bit_r, 2);
                    textbox_params = textbox_params.Replace(" (segment_size) ", " " + bit_r.ToString().Replace(",", ".") + " ");
                }

                String file_prueba2 = file_prueba;

                while (textbox_params.Contains("%fn"))
                {
                    if (textbox_params.Contains("%fn"))
                    {
                        textbox_params = textbox_params.Replace("%fn", Path.GetFileNameWithoutExtension(file_prueba));
                    }
                }

                while (textbox_params.Contains("%fp"))
                {
                    if (textbox_params.Contains("%fp"))
                    {
                        textbox_params = textbox_params.Replace("%fp", Path.GetDirectoryName(file_prueba));
                    }
                }

                while (textbox_params.Contains("%fd"))
                {
                    if (textbox_params.Contains("%fd"))
                    {
                        var path = Path.GetFullPath(file_prueba);
                        var dirName = Path.GetFileName(Path.GetDirectoryName(path));
                        textbox_params = textbox_params.Replace("%fd", dirName);
                    }
                }

                while (textbox_params.Contains("%1"))
                {
                    if (textbox_params.Contains("%1"))
                    {
                        file_prueba2 = file_prueba2.Replace("\\", "\\\\\\\\");
                        file_prueba2 = file_prueba2.Replace(":", ":" + "\\\\");
                        textbox_params = textbox_params.Replace("%1", '\u0022' + file_prueba2 + '\u0022');
                    }
                }

                while (textbox_params.Contains("%2"))
                {
                    if (textbox_params.Contains("%2"))
                    {
                        file_prueba2 = file_prueba2.Replace("\\", "\\\\\\\\");
                        file_prueba2 = file_prueba2.Replace(":", ":" + "\\\\");
                        textbox_params = textbox_params.Replace("%2", '\u0022' + Path.Combine(System.IO.Path.GetDirectoryName(file_prueba2), Path.GetFileNameWithoutExtension(file_prueba2)) + '\u0022');
                    }
                }

                String second_path = "";
                if (textbox_params == "nul")
                {
                    String[] split = txt_parameters.Text.Split(' ');
                    for (int i = 0; i < split.Length; i++)
                    {
                        if (split[i].Contains("\\") == true)
                        {
                            String pre_path = split[i].Replace("%fp", Path.GetDirectoryName(file_prueba2)).Replace("%fn", Path.GetFileNameWithoutExtension(file_prueba2)).Replace("%", "_");
                            second_path = Path.GetDirectoryName(pre_path.Replace('\u0022', ' '));

                            if (!Directory.Exists(second_path))
                            {
                                try
                                {
                                    Directory.CreateDirectory(second_path);
                                }
                                catch
                                {
                                }
                            }
                        }
                    }
                }
                String pre_i = "";
                txt_pre_input.Invoke(new MethodInvoker(delegate
                {
                    pre_i = txt_pre_input.Text;
                }));

                consola.StartInfo.Arguments = pre_i + " " + hw_decode_glob + " -i " + "" + '\u0022' + file_prueba + '\u0022' + " -t 0.2" + " -y " + textbox_params + " " + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + ext_output + '\u0022' + " -loglevel warning -stats";
                if (ext_output == "nul") consola.StartInfo.Arguments = pre_i + " " + hw_decode_glob + " -loglevel warning -stats" + " -i " + '\u0022' + file_prueba + '\u0022' + " -y " + textbox_params;
                consola.StartInfo.RedirectStandardOutput = true;
                consola.StartInfo.RedirectStandardError = true;
                consola.StartInfo.UseShellExecute = false;
                consola.StartInfo.CreateNoWindow = true;
                consola.EnableRaisingEvents = true;
                consola.Start();
                this.InvokeEx(f => boton_ok_ff.Text = FFBatch.Properties.Strings.close_win);

                while (!consola.StandardError.EndOfStream)
                {
                    this.InvokeEx(f => LB1_o_try.Items.Add(consola.StandardError.ReadLine()));
                    this.InvokeEx(f => LB1_o_try.TopIndex = LB1_o_try.Items.Count - 1);
                    this.InvokeEx(f => LB1_o_try.Refresh());
                }

                //consola.WaitForExit();
                consola.StartInfo.Arguments = String.Empty;

                if (consola.ExitCode == 0)
                {
                    this.InvokeEx(f => f.btn_try_pr.Image = img_try.Images[1]);
                    this.InvokeEx(f => f.btn_try_pr.Enabled = true);
                    consola.StartInfo.Arguments = String.Empty;
                    LB1_o_try.Items.Add("");
                    LB1_o_try.Items.Add(FFBatch.Properties.Strings.ff_test_ok);
                    LB1_o_try.TopIndex = LB1_o_try.Items.Count - 1;
                    LB1_o_try.BackColor = Color.LightGreen;
                    LB1_o_try.SetSelected(LB1_o_try.Items.Count - 1, true);
                    this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                    this.InvokeEx(f => this.Enabled = true);

                    //frm_output2.ShowDialog();

                    String borrar1 = destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + txt_format.Text;

                    if (File.Exists(borrar1))
                    {
                        File.Delete(borrar1);
                    }
                    if (Directory.Exists(destino))
                    {
                        if (Directory.GetFiles(destino).Length == 0)
                        {
                            System.IO.Directory.Delete(destino);
                        }
                    }

                    return;
                }
                else
                {
                    this.InvokeEx(f => this.Enabled = false);
                    consola.StartInfo.Arguments = String.Empty;
                    if (timed_out == false)
                    {
                        this.InvokeEx(f => f.btn_try_pr.Image = img_try.Images[2]);
                        this.InvokeEx(f => LB1_o_try.Items.Add(""));
                        this.InvokeEx(f => LB1_o_try.Items.Add(FFBatch.Properties.Strings.enc_test_fail));
                        this.InvokeEx(f => LB1_o_try.TopIndex = LB1_o_try.Items.Count - 1);
                        this.InvokeEx(f => LB1_o_try.BackColor = Color.LightSalmon);
                        this.InvokeEx(f => LB1_o_try.SetSelected(LB1_o_try.Items.Count - 1, true));
                        this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                        if (failed == false)
                        {
                            frm_output2.ShowDialog();
                        }
                        String borrar2 = destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + txt_format.Text;

                        if (File.Exists(borrar2))
                        {
                            File.Delete(borrar2);
                        }
                        if (Directory.Exists(destino))
                        {
                            if (Directory.GetFiles(destino).Length == 0)
                            {
                                System.IO.Directory.Delete(destino);
                            }

                            return;
                        }
                    }
                }
            });

            if (!tt.Wait(6000) && consola.StartInfo.Arguments != String.Empty)
            {
                failed = true;
                timed_out = true;
                consola.Kill();
                LB1_o_try.Items.Add("");
                LB1_o_try.Items.Add(FFBatch.Properties.Strings.ff_test_ok);
                LB1_o_try.TopIndex = LB1_o_try.Items.Count - 1;
                LB1_o_try.BackColor = Color.LightGreen;
                this.InvokeEx(f => LB1_o_try.SetSelected(LB1_o_try.Items.Count - 1, true));
                this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                this.InvokeEx(f => f.btn_try_pr.Image = img_try.Images[1]);
                this.InvokeEx(f => f.btn_try_pr.Enabled = true);
                this.InvokeEx(f => this.Enabled = true);
                //frm_output2.ShowDialog();
                this.InvokeEx(f => frm_output2.Refresh());
            }

            String borrar = destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + txt_format.Text;

            if (File.Exists(borrar))
            {
                try
                {
                    File.Delete(borrar);
                }
                catch { }
            }
            if (Directory.Exists(destino))
            {
                if (Directory.GetFiles(destino).Length == 0)
                {
                    System.IO.Directory.Delete(destino);
                }
            }
        }

        private void cti6_Click(object sender, EventArgs e)
        {
            if (listView1.SelectedIndices.Count == 1 && listView1.Items[listView1.SelectedIndices[0]].SubItems[5].Text != FFBatch.Properties.Strings.success && listView1.Items[listView1.SelectedIndices[0]].SubItems[5].Text != FFBatch.Properties.Strings.queued && listView1.Items[listView1.SelectedIndices[0]].SubItems[5].Text != FFBatch.Properties.Strings.aborted && listView1.Items[listView1.SelectedIndices[0]].SubItems[5].Text != FFBatch.Properties.Strings.skipped)
            {
                if (multi_running == false)
                {
                    StreamWriter write_q = process_glob.StandardInput;
                    write_q.Write("q");
                    aborted_url = true;
                    listView1.Items[listView1.SelectedIndices[0]].SubItems[5].Text = FFBatch.Properties.Strings.aborting;
                    skipped = true;
                    return;
                }
                else
                {
                    StreamWriter write_q = procs["proc_urls_" + listView1.Items[listView1.SelectedIndices[0]].Index.ToString()].StandardInput;
                    write_q.Write("q");
                    listView1.Items[listView1.SelectedIndices[0]].SubItems[5].Text = FFBatch.Properties.Strings.aborting;
                    skipped = true;
                    aborted_url = true;
                    return;
                }
            }
        }

        private void combo_prio_SelectedIndexChanged(object sender, EventArgs e)
        {
            btn_save_prio.Enabled = true;
            if (just_started == true) btn_save_prio.Enabled = false;
            just_started = false;
            //mem_prio.SelectedItem = combo_prio.SelectedItem;

            if (combo_prio.SelectedIndex == current_prio)
            {
                btn_save_prio.Enabled = false;
            }
            else
            {
                btn_save_prio.Enabled = true;
            }

            if (working == true)
            {
                System.Threading.Thread.Sleep(50);
                Change_mem_prio();
            }
            if (btn_save_prio.Enabled == false)
            {
                current_save_prio = false;
            }
            else
            {
                current_save_prio = true;
            }
        }

        private void Change_mem_prio()
        {
            if (working == true) System.Threading.Thread.Sleep(500);

            int tab = 0;
            tabControl1.Invoke(new MethodInvoker(delegate
            {
                tab = tabControl1.SelectedIndex;
            }));

            if (tab == 2)
            {
                if (working == true)
                {
                    try
                    {
                        if (combo_prio.SelectedIndex == 0) process_glob.PriorityClass = ProcessPriorityClass.High;
                        if (combo_prio.SelectedIndex == 1) process_glob.PriorityClass = ProcessPriorityClass.AboveNormal;
                        if (combo_prio.SelectedIndex == 2) process_glob.PriorityClass = ProcessPriorityClass.Normal;
                        if (combo_prio.SelectedIndex == 3) process_glob.PriorityClass = ProcessPriorityClass.BelowNormal;
                        if (combo_prio.SelectedIndex == 4) process_glob.PriorityClass = ProcessPriorityClass.Idle;
                    }
                    catch
                    {
                    }
                }
            }

            if (tab == 0)
            {
                if (working == true && multi_running == false)
                {
                    try
                    {
                        if (combo_prio.SelectedIndex == 0) process_glob.PriorityClass = ProcessPriorityClass.High;
                        if (combo_prio.SelectedIndex == 1) process_glob.PriorityClass = ProcessPriorityClass.AboveNormal;
                        if (combo_prio.SelectedIndex == 2) process_glob.PriorityClass = ProcessPriorityClass.Normal;
                        if (combo_prio.SelectedIndex == 3) process_glob.PriorityClass = ProcessPriorityClass.BelowNormal;
                        if (combo_prio.SelectedIndex == 4) process_glob.PriorityClass = ProcessPriorityClass.Idle;
                    }
                    catch
                    {
                    }
                }

                if (working == true && multi_running == true)
                {
                    Process[] localFFB = Process.GetProcessesByName("FFBatch");
                    foreach (Process proc in localFFB)
                    {
                        var proc_child = proc.GetChildProcesses();

                        foreach (Process proc_ch in proc_child)
                        {
                            if (combo_prio.SelectedIndex == 0) proc_ch.PriorityClass = ProcessPriorityClass.High;
                            if (combo_prio.SelectedIndex == 1) proc_ch.PriorityClass = ProcessPriorityClass.AboveNormal;
                            if (combo_prio.SelectedIndex == 2) proc_ch.PriorityClass = ProcessPriorityClass.Normal;
                            if (combo_prio.SelectedIndex == 3) proc_ch.PriorityClass = ProcessPriorityClass.BelowNormal;
                            if (combo_prio.SelectedIndex == 4) proc_ch.PriorityClass = ProcessPriorityClass.Idle;
                            Process[] localByName = Process.GetProcessesByName("FFBatch");
                            if (localByName.Length == 1)
                            {
                                foreach (Process proc1 in localByName)
                                {
                                    if (combo_prio.SelectedIndex >= 2) proc1.PriorityClass = ProcessPriorityClass.Normal;
                                    else proc1.PriorityClass = proc_ch.PriorityClass;
                                }
                            }
                        }
                    }
                }
            }

            if (tab == 3)
            {
                if (working == true && m3u_single_running == true)
                {
                    try
                    {
                        if (combo_prio.SelectedIndex == 0) process_glob.PriorityClass = ProcessPriorityClass.High;
                        if (combo_prio.SelectedIndex == 1) process_glob.PriorityClass = ProcessPriorityClass.AboveNormal;
                        if (combo_prio.SelectedIndex == 2) process_glob.PriorityClass = ProcessPriorityClass.Normal;
                        if (combo_prio.SelectedIndex == 3) process_glob.PriorityClass = ProcessPriorityClass.BelowNormal;
                        if (combo_prio.SelectedIndex == 4) process_glob.PriorityClass = ProcessPriorityClass.Idle;
                    }
                    catch
                    {
                    }
                }
                if (working == true && m3u_running == true)
                {
                    Process[] localFFB = Process.GetProcessesByName("FFBatch");
                    foreach (Process proc in localFFB)
                    {
                        var proc_child = proc.GetChildProcesses();

                        foreach (Process proc_ch in proc_child)
                        {
                            if (combo_prio.SelectedIndex == 0) proc_ch.PriorityClass = ProcessPriorityClass.High;
                            if (combo_prio.SelectedIndex == 1) proc_ch.PriorityClass = ProcessPriorityClass.AboveNormal;
                            if (combo_prio.SelectedIndex == 2) proc_ch.PriorityClass = ProcessPriorityClass.Normal;
                            if (combo_prio.SelectedIndex == 3) proc_ch.PriorityClass = ProcessPriorityClass.BelowNormal;
                            if (combo_prio.SelectedIndex == 4) proc_ch.PriorityClass = ProcessPriorityClass.Idle;

                            Process[] localByName = Process.GetProcessesByName("FFBatch");
                            if (localByName.Length == 1)
                            {
                                foreach (Process proc1 in localByName)
                                {
                                    if (combo_prio.SelectedIndex >= 2) proc1.PriorityClass = ProcessPriorityClass.Normal;
                                    else proc1.PriorityClass = proc_ch.PriorityClass;
                                }
                            }
                        }
                    }
                }
            }
        }

        private void btn_reset_path_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            txt_path_main.Text = ".\\FFBatch";
            txt_path_mux.Text = ".\\FFBatch";
            txt_path_main.BackColor = groupBox1.BackColor;
            txt_path_mux.BackColor = groupBox1.BackColor;
            String path_s = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_path.ini";
            if (is_portable == true) path_s = port_path + "ff_path_portable.ini";
            if (File.Exists(path_s))
            {
                File.Delete(path_s);
                btn_save_path.Enabled = true;
            }
            else
            {
                btn_save_path.Enabled = false;
            }
        }

        public class WebClientWithTimeout : WebClient
        {
            protected override WebRequest GetWebRequest(Uri address)
            {
                WebRequest wr = base.GetWebRequest(address);
                wr.Timeout = 5000; // timeout in milliseconds (ms)
                return wr;
            }
        }

        private void btn_update_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            lbl_updates.Text = String.Empty;
            String current_ver = btn_update.Text;
            btn_update.Refresh();
            String content1 = String.Empty;

            try
            {
                WebClient client = new WebClientWithTimeout();
                Stream stream = client.OpenRead(down_ver);
                StreamReader reader = new StreamReader(stream);
                String content = reader.ReadToEnd();
                content1 = content;
            }
            catch
            {
                try
                {
                    //Backup server
                    WebClient client = new WebClientWithTimeout();
                    Stream stream = client.OpenRead(down_ver2);
                    StreamReader reader = new StreamReader(stream);
                    String content = reader.ReadToEnd();
                    content1 = content;
                }
                catch
                {
                    this.InvokeEx(f => f.lbl_updates.Text = FFBatch.Properties.Strings.up_err);
                    this.InvokeEx(f => f.btn_update.Text = current_ver);
                    return;
                }
            }

            try
            {
                if (Convert.ToInt16(content1.Replace(".", String.Empty).Substring(0, 3)) > Convert.ToInt16(Application.ProductVersion.Replace(".", String.Empty)))
                {
                    String f_skip_ver = String.Empty;
                    if (is_portable == false)
                    {
                        f_skip_ver = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_skip_ver.ini";
                    }
                    else
                    {
                        f_skip_ver = port_path + "ff_skip_ver_portable.ini";
                    }

                    Form21 frm21 = new Form21();
                    frm21.lbl_ver.Text = Properties.Strings2.version + " " + content1.Substring(0, 5);
                    frm21.textBox1.Text = content1.Substring(6, content1.Length - 6);
                    frm21.ShowDialog();
                    if (frm21.cancel == false && frm21.update == true && frm21.skip_ver == false)
                    {
                        try
                        {
                            File.Delete(f_skip_ver);
                        }
                        catch { }

                        Process.Start("https://sourceforge.net/p/ffmpeg-batch/wiki");
                    }
                    if (frm21.cancel == false && frm21.update == false && frm21.skip_ver == true)
                    {
                        try
                        {
                            File.WriteAllText(f_skip_ver, content1.Substring(0, 5));
                        }
                        catch (Exception excpt)
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.skip_err + Environment.NewLine + Environment.NewLine + excpt.Message, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        }
                    }
                }
                else
                {
                    MessageBox.Show(FFBatch.Properties.Strings.latestv + Environment.NewLine + Environment.NewLine + "FFmpeg Batch A/V Converter version " + content1.Substring(0, 5), FFBatch.Properties.Strings.up1, MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            }
            catch (Exception excpt)
            {
                DialogResult a = MessageBox.Show(FFBatch.Properties.Strings.err_check + Environment.NewLine + Environment.NewLine + excpt.Message + Environment.NewLine + Environment.NewLine + Properties.Strings2.check_web_up, FFBatch.Properties.Strings.error, MessageBoxButtons.YesNoCancel, MessageBoxIcon.Error);
                if (a == DialogResult.Yes) Process.Start(proj_web);
            }

            btn_update.Text = current_ver;
        }

        private void check_sort_dur()
        {
            //Sort by duration
            String f_sort_dur = String.Empty;
            if (is_portable == false)
            {
                f_sort_dur = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_sort_dur.ini";
            }
            else
            {
                f_sort_dur = port_path + "ff_sort_dur_portable.ini";
            }

            if (!File.Exists(f_sort_dur))
            {
                tip_sort_dur = false;
                sort_multi_dur = false;
            }
            else
            {
                tip_sort_dur = true;
                sort_multi_dur = true;
            }

            //End Sort by duration
        }

        private void btn_multi_m_Click(object sender, EventArgs e)

        {
            Pg1.Focus();
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";

            was_started.Text = btn_multi_m.Text;
            if (listView1.Items.Count == 1)
            {
                btn_seq.PerformClick();
                return;
            }

            cancelados_paralelos = false;

            foreach (ListViewItem file in listView1.Items)
            {
                if (!File.Exists(file.SubItems[1].Text + "\\" + file.Text))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file_not_found + " " + file.Text, FFBatch.Properties.Strings.file_not_found2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }
            if (listView1.Items.Count == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.list_empty, FFBatch.Properties.Strings.no_files, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (!File.Exists(Path.Combine(Application.StartupPath, "ffmpeg.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_ffmpeg, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (check_ff_md5() == false)
            {
                Form25 frm25 = new Form25();
                frm25.ShowDialog();
                return;
            }

            if (ss_time_input.Text != "0:00:00")
            {
                foreach (ListViewItem item in listView1.Items)
                {
                    if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                    {
                        if (TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds <= TimeSpan.Parse(ss_time_input.Text).TotalSeconds)
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.pre_input3 + " " + '\u0022' + Path.GetFileName(item.Text) + '\u0022', FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            return;
                        }
                    }
                }
            }

            if (dur_ok == false)
            {
                list_pending_dur.Clear();
                foreach (ListViewItem item in listView1.Items)
                {
                    list_pending_dur.Items.Add((ListViewItem)item.Clone());
                }
                BG_Dur.RunWorkerAsync();
                return;
            }

            avoid_overw();

            //Check path is writable
            String destino1 = String.Empty;
            Boolean rel_path = false;
            String lv1 = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text;
            if (txt_path_main.Text.Contains(".\\"))
            {
                destino1 = lv1.Substring(0, lv1.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
                rel_path = true;
            }
            else
            {
                if (checkBox1.CheckState == CheckState.Checked)
                {
                    String pre_dest = Path.GetDirectoryName(lv1);
                    destino1 = Path.Combine(txt_path_main.Text, pre_dest.Substring(3, pre_dest.Length - 3));
                    rel_path = true;
                }
                else
                {
                    destino1 = txt_path_main.Text;
                }
            }

            try
            {
                if (rel_path == true)
                {
                    Directory.CreateDirectory(destino1);
                    System.Threading.Thread.Sleep(10);
                }
                else
                {
                    if (!Directory.Exists(destino1)) Directory.CreateDirectory(destino1);
                    File.WriteAllText(destino1 + "\\" + "FFBatch_test.txt", "FFBatch_test");
                    System.Threading.Thread.Sleep(10);
                    File.Delete(destino1 + "\\" + "FFBatch_test.txt");
                }
            }
            catch (System.Exception excpt)
            {
                MessageBox.Show(FFBatch.Properties.Strings.write_error1 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            //End path is writable

            //Sort by duration

            check_sort_dur();

            String f_sort_dur = String.Empty;
            if (is_portable == false)
            {
                f_sort_dur = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_sort_dur.ini";
            }
            else
            {
                f_sort_dur = port_path + "ff_sort_dur_portable.ini";
            }

            if (File.Exists(f_sort_dur))
            {
                try
                {
                    if (File.ReadAllText(f_sort_dur) == FFBatch.Properties.Strings.yes)
                    {
                        lvwColumnSorter_Full.SortColumn = 3;
                        lvwColumnSorter_Full.Order = SortOrder.Descending;
                        this.listView1.Sort();
                    }
                }
                catch
                {
                }
            }

            if (tip_sort_dur == false)
            {
                var a = MessageBox.Show(FFBatch.Properties.Strings.sort_list2 + Environment.NewLine + Environment.NewLine + Properties.Strings2.sort_list, Properties.Strings2.sort_list2, MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                if (a == DialogResult.Yes)
                {
                    lvwColumnSorter_Full.SortColumn = 3;
                    lvwColumnSorter_Full.Order = SortOrder.Descending;
                    this.listView1.Sort();
                    File.WriteAllText(f_sort_dur, FFBatch.Properties.Strings.yes);
                }
                else
                {
                    File.WriteAllText(f_sort_dur, FFBatch.Properties.Strings.no);
                }
                tip_sort_dur = true;
            }

            //Validated list, start processing

            if (fade_v_in.Checked == true || fade_v_out.Checked == true || fade_a_in.Checked == true || fade_a_out.Checked == true)
            {
                MessageBox.Show(FFBatch.Properties.Strings.fadein1, FFBatch.Properties.Strings.warning, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }

            txt_remain.Text = "";
            txt_remain.Refresh();
            total_time = true;
            n_th_suffix = String.Empty;
            n_th_source_ext = String.Empty;

            if (listView1.SelectedIndices.Count == 0)
            {
                listView1.Items[0].Selected = true;
                listView1.Items[0].Focused = true;
                listView1.Focus();
            }

            //Save selected hw decoder

            String path2 = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_hw_dcd.ini";
            String txt_hw_dcd = cb_hwdecode.SelectedItem.ToString();
            if (txt_hw_dcd != "none")
            {
                File.WriteAllText(path2, txt_hw_dcd);
            }
            else
            {
                if (File.Exists(path2)) File.Delete(path2);
            }

            //End save hw decoder

            //Try preset
            foreach (String item in tried_params)
            {
                if (item == (txt_parameters.Text))
                {
                    tried_ok = true;
                }
            }

            if (tried_ok == false)
            {
                try
                {
                    BG_Try_preset.RunWorkerAsync();
                }
                catch
                {
                    tried_ok = true;
                }
                return;
            }
            tried_ok = false;

            //Remove test file/folder
            String file_prueba = "";
            String sel_test = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
            file_prueba = sel_test;
            String destino = Path.GetTempPath() + "\\" + "FFBatch_test";
            String borrar = destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + txt_format.Text;

            if (File.Exists(borrar))
            {
                try
                {
                    File.Delete(borrar);
                }
                catch { }
            }

            if (Directory.Exists(destino) == true)
            {
                if (Directory.GetFiles(destino).Length == 0)
                {
                    try
                    {
                        System.IO.Directory.Delete(destino);
                    }
                    catch { }
                }
            }

            //END Remove test file/folder

            //END try preset

            //Save selected theads

            String path = String.Empty;
            if (is_portable == false)
            {
                path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_nthreads.ini";
            }
            else
            {
                path = port_path + "ff_nthreads_portable.ini";
            }

            String txt_threads = String.Empty;
            txt_threads = n_threads.Value.ToString();
            File.WriteAllText(path, txt_threads);
            //End save selected threads

            //Pending duration

            if (avoid_overwriting == true && txt_path_main.Text.Contains(".\\") == false && txt_path_main.Text.Length < 4 && checkBox1.CheckState != CheckState.Checked)
            {
                avoid_overwriting = false;
                DialogResult a2 = MessageBox.Show(FFBatch.Properties.Strings.multiple_folders + " " + '\u0022' + FFBatch.Properties.Strings.recreate_path + '\u0022' + " " + Properties.Strings2.avoid_overw + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.continu, Properties.Strings2.dif_in_out_f, MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2);
                if (a2 == DialogResult.No) return;
            }

            //list_global_proc.Clear();

            //Check queued items

            if (warn_success_items == true)
            {
                //Boolean all_complete = true;
                Boolean has_complete = false;
                foreach (ListViewItem item in listView1.Items)
                {
                    if (item.SubItems[5].Text != FFBatch.Properties.Strings.queued)
                    {
                        has_complete = true;
                        break;
                    }
                }

                if (has_complete == true)
                {
                    DialogResult a = MessageBox.Show(FFBatch.Properties.Strings.already_encoded + " " + '\u0022' + FFBatch.Properties.Strings.queued + '\u0022' + " " + FFBatch.Properties.Strings.reset_items + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.cont_any, FFBatch.Properties.Strings.some_q, MessageBoxButtons.YesNoCancel, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2);
                    if (a == DialogResult.Cancel || a == DialogResult.No)
                    {
                        return;
                    }
                }
            }
            else
            {
                foreach (ListViewItem item in listView1.Items) item.SubItems[5].Text = Properties.Strings.queued;
            }
            //End check queued items

            if (chk_overw.Checked == true && txt_path_main.Text != "." + "\\")
            {
                DialogResult a = MessageBox.Show(FFBatch.Properties.Strings.overw_out, FFBatch.Properties.Strings.out_warn, MessageBoxButtons.YesNoCancel, MessageBoxIcon.Question);
                if (a != DialogResult.Yes) return;
            }

            //Verify names will not cause overwrite
            if (txt_format.Text != String.Empty)
            {
                if (dups_lv1() == true) return;
            }

            String is_overw = txt_path_main.Text + "\\" + Path.GetFileNameWithoutExtension(listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text) + "." + txt_format.Text;

            if (is_overw == listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text && chk_suffix.Checked == false)
            {
                if (chk_overw.CheckState == CheckState.Unchecked)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.overw_not_en + " " + '\u0022' + FFBatch.Properties.Strings.ren_out + '\u0022' + " " + FFBatch.Properties.Strings.checkb, FFBatch.Properties.Strings.overw_not_all, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                if (chk_overw.CheckState == CheckState.Checked)
                {
                    var a = MessageBox.Show(FFBatch.Properties.Strings.overw_confirm, FFBatch.Properties.Strings.over_conf2, MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                    if (a == DialogResult.No)
                    {
                        return;
                    }
                }
            }

            if (txt_parameters.Text.Contains("libx264") || txt_parameters.Text.Contains("libx265") || txt_parameters.Text.Contains("jpeg2000") || txt_parameters.Text.Contains("libtheora") || txt_parameters.Text.Contains("libxvid") || txt_parameters.Text.Contains("mpeg2") || txt_parameters.Text.Contains("webp") || txt_parameters.Text.Contains("mpeg4") || txt_parameters.Text.Contains("libvpx"))
            {
                if (n_threads.Value > 3 && (txt_parameters.Text.Contains("libx264") || txt_parameters.Text.Contains("libx265") || txt_parameters.Text.Contains("jpeg2000") || txt_parameters.Text.Contains("libtheora") || txt_parameters.Text.Contains("libxvid") || txt_parameters.Text.Contains("mpeg2") || txt_parameters.Text.Contains("webp") || txt_parameters.Text.Contains("mpeg4") || txt_parameters.Text.Contains("libvpx")))
                {
                    var a = MessageBox.Show(FFBatch.Properties.Strings.multi_vid, FFBatch.Properties.Strings.question, MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                    if (a == DialogResult.No) return;
                }
            }

            cancel_queue = false;
            cancelados_paralelos = false;

            listBox4.Items.Clear();
            group_prog.Focus();

            //Total duration

            total_multi_duration = 0;
            foreach (ListViewItem item in listView1.Items)
            {
                DateTime time2;
                if (DateTime.TryParse(item.SubItems[3].Text, out time2))

                {
                    total_multi_duration = total_multi_duration + TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds;
                }
            }
            //End total duration
            LB_Wait.Text = String.Empty;
            LB_Wait.Visible = false;
            pg_adding.Visible = false;
            txt_adding_p.Text = String.Empty;
            multi_dest = destino;

            notifyIcon1.Visible = true;
            Pg1.Value = 0;
            Pg1.Maximum = listView1.Items.Count * 100;
            Pg1.Text = "";
            lbl_elapsed.Text = FFBatch.Properties.Strings.time_elapsed + " " + "00h:00m:00s";

            start_total_time = 0;
            time_n_tasks = 0;
            timer_tasks.Start();
            timer1.Start();
            multi_running = true;

            listView1.Items[0].Selected = true;
            pic_no_errors.Visible = false;
            pic_warnings.Visible = false;
            pic_recording.Visible = false;
            errors_enc = 0;
            working = true;
            BG_Multi_M.RunWorkerAsync();
        }

        private void textBox2_KeyUp(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                btn_seq.PerformClick();
            }
        }

        private void extract_streams_job()
        {
            Pg1.Focus();
            cancel_queue = false;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";

            foreach (ListViewItem file in list_tracks.Items)
            {
                if (!File.Exists(file.Text))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file_not_found + " " + file.Text, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }

            String is_overw = txt_path_main.Text + "\\" + Path.GetFileNameWithoutExtension(list_tracks.Items[0].Text) + "." + txt_track_format;

            if (is_overw == list_tracks.Items[0].Text)
            {
                MessageBox.Show(FFBatch.Properties.Strings.overw_main, FFBatch.Properties.Strings.overw_not_all, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            DateTime time2;
            if (!DateTime.TryParse(ss_time_input.Text, out time2))
            {
                MessageBox.Show(FFBatch.Properties.Strings.pre_input4, FFBatch.Properties.Strings.pre_input2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            //Validated list, start processing
            //Pending duration

            if (dur_ok == false)
            {
                list_pending_dur.Items.Clear();
                foreach (ListViewItem item in listView1.Items)
                {
                    list_pending_dur.Items.Add((ListViewItem)item.Clone());
                }
                BG_Dur.RunWorkerAsync();
                return;
            }

            //Copy list of tracks for thread processing

            //End of copy list of tracks for thread processing

            Double total_duration = 0;
            Double total_prog = 0;

            //Duration

            this.Cursor = Cursors.WaitCursor;

            List<double> durations = new List<double>();
            String duracion = String.Empty;

            foreach (ListViewItem item in list_tracks.Items)
            {
                Process probe = new Process();
                probe.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
                String ffprobe_frames1 = " " + '\u0022' + "--Inform=General;%Duration/String3%" + '\u0022';
                probe.StartInfo.Arguments = ffprobe_frames1 + " " + '\u0022' + item.Text + '\u0022';

                probe.StartInfo.RedirectStandardOutput = true;
                probe.StartInfo.UseShellExecute = false;
                probe.StartInfo.CreateNoWindow = true;
                probe.EnableRaisingEvents = true;
                probe.Start();

                duracion = probe.StandardOutput.ReadLine();

                probe.WaitForExit();

                if (duracion != null)
                {
                    DateTime time;
                    if (DateTime.TryParse(duracion, out time))
                    {
                        //total_duration = Convert.ToDouble(duracion.Substring(0, 7));

                        durat_n = TimeSpan.Parse(duracion).TotalSeconds;
                        durations.Add(durat_n);
                        total_duration = total_duration + durat_n;

                        //total_duration = durat_n;
                    }
                }
                else
                {
                    durat_n = 0;
                    durations.Add(0);
                    //total_duration = 0;
                }

                //End duration
            }

            //End

            Pg1.Minimum = 0;
            Pg1.Maximum = 100;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            lbl_speed.Text = String.Empty;

            List<string> list_lines = new List<string>();
            String mux_ext = txt_track_format.Text;

            pic_no_errors.Visible = false;
            pic_recording.Visible = false;
            pic_warnings.Visible = false;

            time_est_size = 0;
            String err_txt = "";
            timer_est_size.Start();

            String destino = "";
            int count = 0;

            foreach (ListViewItem item in list_tracks.Items)
            {
                String remain_time = "0";

                String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");

                String file = item.Text;
                String fullPath = file;
                count = count + 1;

                //Track extension
                string ext_track = item.SubItems[2].Text.ToLower();

                if (ext_track.Contains("h264")) mux_ext = "m4v";
                else if (ext_track.Contains("h265")) mux_ext = "mkv";
                else if (ext_track.Contains("hevc")) mux_ext = "mkv";
                else if (ext_track.Contains("webm")) mux_ext = "webm";
                else if (ext_track.Contains("rawvideo")) mux_ext = "avi";
                else if (ext_track.Contains("divx")) mux_ext = "avi";
                else if (ext_track.Contains("xvid")) mux_ext = "avi";
                else if (ext_track.Contains("mov")) mux_ext = "mov";
                else if (ext_track.Contains("aac")) mux_ext = "aac";
                else if (ext_track.Contains("m4a")) mux_ext = "m4a";
                else if (ext_track.Contains("ac3")) mux_ext = "ac3";
                else if (ext_track.Contains("mp3")) mux_ext = "mp3";
                else if (ext_track.Contains("pcm")) mux_ext = "wav";
                else if (ext_track.Contains("flac")) mux_ext = "flac";
                else if (ext_track.Contains("truehd")) mux_ext = "thd";
                else if (ext_track.Contains("dts")) mux_ext = "dts";
                else if (ext_track.Contains("vp7")) mux_ext = "webm";
                else if (ext_track.Contains("vp8")) mux_ext = "webm";
                else if (ext_track.Contains("vp9")) mux_ext = "webm";
                else if (ext_track.Contains("wma")) mux_ext = "wma";
                else if (ext_track.Contains("wvc1")) mux_ext = "wmv";
                else if (ext_track.Contains("vorbis")) mux_ext = "ogg";
                else if (ext_track.Contains("theora")) mux_ext = "ogv";
                else if (ext_track.Contains("mjpeg")) mux_ext = "jpg";
                else if (ext_track.Contains("subrip")) mux_ext = "srt";
                else if (ext_track.Contains("ass")) mux_ext = "ass";
                else mux_ext = "mkv";

                //End Stream format

                destino = "";

                if (txt_path_main.Text.Contains(".\\"))
                {
                    destino = file.Substring(0, fullPath.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty); ;
                }
                else
                {
                    destino = txt_path_main.Text;
                }

                if (!Directory.Exists(destino))
                {
                    try
                    {
                        Directory.CreateDirectory(destino);
                    }
                    catch (System.Exception excpt)
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        this.Cursor = Cursors.Arrow;
                        Enable_Controls();
                        working = false;
                        return;
                    }
                }

                //Create joint inputs variable
                String inputs = String.Empty;

                String stream_type = String.Empty;
                if (item.SubItems[2].Text.ToLower().Contains("subtitle"))
                {
                    stream_type = "s";
                }

                if (item.SubItems[2].Text.ToLower().Contains("audio"))
                {
                    stream_type = "a";
                }
                if (item.SubItems[2].Text.ToLower().Contains("video"))
                {
                    stream_type = "v";
                }
                //{
                //inputs = inputs + " -sub_charenc UTF-8" + " -i " + '\u0022' + input_item.Text + '\u0022';
                //}
                inputs = " -i " + '\u0022' + item.Text + '\u0022';

                //End create joint inputs variable

                String dur = "";
                TimeSpan t_dur = TimeSpan.FromSeconds(durat_n);
                dur = string.Format("{0:D2}:{1:D2}:{2:D2}",
                             (int)t_dur.TotalHours,
                             t_dur.Minutes,
                             t_dur.Seconds);

                String output_file = '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + "_" + stream_type + "_demux_" + count.ToString() + "." + mux_ext + '\u0022';
                String AppParam = inputs + " -map 0:" + item.SubItems[1].Text + " -c copy " + "-y ";

                frm_mux_jobs.dg_pr.Rows.Add(frm_mux_jobs.dg_pr.RowCount + 1, Path.GetFileName(list_tracks.Items[0].Text), AppParam, list_tracks.Items.Count.ToString(), dur, output_file);

                try
                {
                    Task t = Task.Run(() =>
                    {
                        try
                        {
                            Directory.Delete(destino);
                        }
                        catch { }
                    });
                }
                catch { }
                btn_mux_show_jobs.Enabled = true;
                if (frm_mux_jobs.dg_pr.RowCount > 0) lbl_mux_jobs.Text = FFBatch.Properties.Strings.jobs + " " + frm_mux_jobs.dg_pr.RowCount;
                else lbl_mux_jobs.Text = String.Empty;
            }
        }

        private void extract_streams()
        {
            Pg1.Focus();
            cancel_queue = false;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";

            foreach (ListViewItem file in list_tracks.Items)
            {
                if (!File.Exists(file.Text))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file_not_found + " " + file.Text, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }

            String is_overw = txt_path_main.Text + "\\" + Path.GetFileNameWithoutExtension(list_tracks.Items[0].Text) + "." + txt_track_format;

            if (is_overw == list_tracks.Items[0].Text)
            {
                MessageBox.Show(FFBatch.Properties.Strings.overw_main, FFBatch.Properties.Strings.overw_not_all, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            DateTime time2;
            if (!DateTime.TryParse(ss_time_input.Text, out time2))
            {
                MessageBox.Show(FFBatch.Properties.Strings.pre_input4, FFBatch.Properties.Strings.pre_input2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            //Validated list, start processing
            //Pending duration

            if (dur_ok == false)
            {
                list_pending_dur.Items.Clear();
                foreach (ListViewItem item in listView1.Items)
                {
                    list_pending_dur.Items.Add((ListViewItem)item.Clone());
                }
                BG_Dur.RunWorkerAsync();
                return;
            }

            Disable_Controls();
            txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + "00h:00m:00s";
            time_n_tasks = 0;
            lbl_elapsed.Text = FFBatch.Properties.Strings.time_elapsed + " " + "00h:00m:00s";
            timer_tasks.Start();

            cancel_queue = false;
            Pg1.Value = 0;
            //pg_current.Value = 0;
            //textBox4.Text = "0%";

            working = true;

            //Copy list of tracks for thread processing
            ListView list_proc = new ListView();
            foreach (ListViewItem item in list_tracks.SelectedItems)
            {
                list_proc.Items.Add((ListViewItem)item.Clone());
            }
            //End of copy list of tracks for thread processing

            Double total_duration = 0;
            Double total_prog = 0;

            //Duration

            List<double> durations = new List<double>();

            foreach (ListViewItem item in list_proc.Items)
            {
                Process probe = new Process();
                probe.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
                String ffprobe_frames1 = " " + '\u0022' + "--Inform=General;%Duration/String3%" + '\u0022';
                probe.StartInfo.Arguments = ffprobe_frames1 + " " + '\u0022' + item.Text + '\u0022';

                probe.StartInfo.RedirectStandardOutput = true;
                probe.StartInfo.UseShellExecute = false;
                probe.StartInfo.CreateNoWindow = true;
                probe.EnableRaisingEvents = true;
                probe.Start();

                String duracion = probe.StandardOutput.ReadLine();

                probe.WaitForExit();

                if (duracion != null)
                {
                    DateTime time;
                    if (DateTime.TryParse(duracion, out time))
                    {
                        //total_duration = Convert.ToDouble(duracion.Substring(0, 7));

                        durat_n = TimeSpan.Parse(duracion).TotalSeconds;
                        durat_n = Math.Round(durat_n, 0);
                        durations.Add(durat_n);
                        total_duration = total_duration + durat_n;
                        //total_duration = durat_n;
                    }
                }
                else
                {
                    durat_n = 0;
                    durations.Add(0);
                    //total_duration = 0;
                }

                //End duration
            }

            //End

            Pg1.Minimum = 0;
            Pg1.Maximum = 100;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            lbl_speed.Text = String.Empty;

            List<string> list_lines = new List<string>();
            String mux_ext = txt_track_format.Text;

            pic_no_errors.Visible = false;
            pic_recording.Visible = false;
            pic_warnings.Visible = false;

            time_est_size = 0;
            String err_txt = "";
            timer_est_size.Start();

            String destino = "";
            int count = 0;

            new System.Threading.Thread(() =>
            {
                foreach (ListViewItem item in list_proc.Items)
                {
                    System.Threading.Thread.CurrentThread.IsBackground = true;

                    String remain_time = "0";

                    String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");

                    String file = item.Text;
                    String fullPath = file;
                    count = count + 1;

                    //Track extension
                    string ext_track = item.SubItems[2].Text.ToLower();

                    if (ext_track.Contains("h264")) mux_ext = "m4v";
                    else if (ext_track.Contains("h265")) mux_ext = "mkv";
                    else if (ext_track.Contains("hevc")) mux_ext = "mkv";
                    else if (ext_track.Contains("webm")) mux_ext = "webm";
                    else if (ext_track.Contains("rawvideo")) mux_ext = "avi";
                    else if (ext_track.Contains("divx")) mux_ext = "avi";
                    else if (ext_track.Contains("xvid")) mux_ext = "avi";
                    else if (ext_track.Contains("mov")) mux_ext = "mov";
                    else if (ext_track.Contains("aac")) mux_ext = "aac";
                    else if (ext_track.Contains("m4a")) mux_ext = "m4a";
                    else if (ext_track.Contains("ac3")) mux_ext = "ac3";
                    else if (ext_track.Contains("mp3")) mux_ext = "mp3";
                    else if (ext_track.Contains("pcm")) mux_ext = "wav";
                    else if (ext_track.Contains("flac")) mux_ext = "flac";
                    else if (ext_track.Contains("truehd")) mux_ext = "thd";
                    else if (ext_track.Contains("dts")) mux_ext = "dts";
                    else if (ext_track.Contains("vp7")) mux_ext = "webm";
                    else if (ext_track.Contains("vp8")) mux_ext = "webm";
                    else if (ext_track.Contains("vp9")) mux_ext = "webm";
                    else if (ext_track.Contains("wma")) mux_ext = "wma";
                    else if (ext_track.Contains("wvc1")) mux_ext = "wmv";
                    else if (ext_track.Contains("vorbis")) mux_ext = "ogg";
                    else if (ext_track.Contains("theora")) mux_ext = "ogv";
                    else if (ext_track.Contains("mjpeg")) mux_ext = "jpg";
                    else if (ext_track.Contains("subrip")) mux_ext = "srt";
                    else if (ext_track.Contains("ass")) mux_ext = "ass";
                    else mux_ext = "mkv";

                    //End Stream format

                    destino = "";

                    if (txt_path_main.Text.Contains(".\\"))
                    {
                        destino = file.Substring(0, fullPath.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty); ;
                    }
                    else
                    {
                        destino = txt_path_main.Text;
                    }

                    if (!Directory.Exists(destino))
                    {
                        try
                        {
                            Directory.CreateDirectory(destino);
                        }
                        catch (System.Exception excpt)
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            this.Cursor = Cursors.Arrow;
                            Enable_Controls();
                            working = false;
                            return;
                        }
                    }

                    //Create joint inputs variable
                    String inputs = String.Empty;

                    String stream_type = String.Empty;
                    if (item.SubItems[2].Text.ToLower().Contains("subtitle"))
                    {
                        stream_type = "s";
                    }

                    if (item.SubItems[2].Text.ToLower().Contains("audio"))
                    {
                        stream_type = "a";
                    }
                    if (item.SubItems[2].Text.ToLower().Contains("video"))
                    {
                        stream_type = "v";
                    }
                    //{
                    //inputs = inputs + " -sub_charenc UTF-8" + " -i " + '\u0022' + input_item.Text + '\u0022';
                    //}
                    inputs = " -i " + '\u0022' + item.Text + '\u0022' + " -map 0:" + item.SubItems[1].Text + " -c copy ";

                    //End create joint inputs variable

                    String AppParam = inputs + "-y " + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + "_" + stream_type + "_demux_" + count.ToString() + "." + mux_ext + '\u0022';

                    if (!Directory.Exists(destino))
                    {
                        Directory.CreateDirectory(destino);
                    }

                    process_glob.StartInfo.FileName = ffm;
                    process_glob.StartInfo.Arguments = AppParam;
                    valid_prog = false;

                    //this.InvokeEx(f => f.pg_current.Value = 0);
                    //this.InvokeEx(f => f.pg_current.Refresh());

                    process_glob.StartInfo.RedirectStandardOutput = true;
                    process_glob.StartInfo.RedirectStandardError = true;
                    process_glob.StartInfo.RedirectStandardInput = true;
                    process_glob.StartInfo.UseShellExecute = false;
                    process_glob.StartInfo.CreateNoWindow = true;
                    process_glob.EnableRaisingEvents = true;

                    if (working == true) process_glob.Start();
                    else continue;

                    System.Threading.Thread.Sleep(50);
                    combo_prio.Invoke(new MethodInvoker(delegate
                    {
                        if (combo_prio.SelectedIndex != 2)
                        {
                            Change_mem_prio();
                        }
                    }));

                    if (total_duration > 0)
                    {
                        valid_prog = true;
                    }
                    else
                    {
                        valid_prog = false;
                    }

                    err_txt = "";
                    Double interval = 0;
                    Decimal est_bitrate = 0;
                    Decimal est_size = 0;
                    Double sec_prog = 0;
                    try
                    {
                        while (!process_glob.StandardError.EndOfStream)
                        {
                            err_txt = process_glob.StandardError.ReadLine();
                            list_lines.Add(err_txt);

                            if (valid_prog == true)
                            {
                                if (err_txt.Contains("time=") && err_txt.Contains("time=-") == false)
                                {
                                    durat_n = total_duration;
                                    total_prog = durat_n;

                                    int start_time_index = err_txt.IndexOf("time=") + 5;
                                    sec_prog = TimeSpan.Parse(err_txt.Substring(start_time_index, 8)).TotalSeconds;
                                    Double percent = (sec_prog * 100 / durat_n);

                                    total_prog = total_prog + (sec_prog - interval);
                                    interval = sec_prog;
                                    int percent2 = Convert.ToInt32(percent);

                                    if (percent2 <= 100)
                                    {
                                        //this.InvokeEx(f => f.pg_current.Value = percent2);
                                        //this.InvokeEx(f => f.//textBox4.Text = (percent2).ToString() + "%");

                                        if (percent2 > Pg1.Value)
                                        {
                                            this.InvokeEx(f => f.Pg1.Value = percent2);
                                            this.InvokeEx(f => f.Pg1.Refresh());
                                            this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, percent2, Pg1.Maximum));
                                            if (Math.Round(percent, 1).ToString().Contains(".") || Math.Round(percent, 1).ToString().Contains(","))
                                            {
                                                this.InvokeEx(f => f.Pg1.Text = Math.Round(percent, 1).ToString() + "%");
                                            }
                                            else
                                            {
                                                this.InvokeEx(f => f.Pg1.Text = Math.Round(percent, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0" + "%");
                                            }
                                            this.InvokeEx(f => f.Pg1.Refresh());
                                        }
                                        //this.InvokeEx(f => f.textBox5.Text = (percent2).ToString() + "%");
                                    }

                                    //Estimated remaining time

                                    remain_time = err_txt.Substring(err_txt.LastIndexOf("speed=") + 6, err_txt.Length - err_txt.LastIndexOf("speed=") - 6);
                                    if (time_est_size % 3 == 0) this.InvokeEx(f => f.lbl_speed.Text = FFBatch.Properties.Strings.speed + " " + remain_time);
                                    remain_time = remain_time.Replace("x", String.Empty);
                                    Double timing1 = 0;

                                    if (System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator == ",")
                                    {
                                        timing1 = Math.Round(Double.Parse(remain_time.Replace(".", ",")), 2);
                                    }
                                    else
                                    {
                                        timing1 = Math.Round(Double.Parse(remain_time), 2);
                                    }
                                    Decimal timing = (decimal)timing1;
                                    Decimal total_dur_dec = Convert.ToDecimal(interval);
                                    Decimal total_prog_dec = Convert.ToDecimal(total_prog);

                                    Decimal remain_secs = 0;
                                    if (timing > 0)
                                    {
                                        remain_secs = (decimal)(total_prog_dec - total_dur_dec) / timing;
                                    }

                                    if (remain_secs > 60)
                                    {
                                        remain_secs = remain_secs + 60;
                                    }
                                    String remain_from_secs = "";

                                    TimeSpan t = TimeSpan.FromSeconds(Convert.ToDouble(remain_secs));
                                    remain_from_secs = string.Format("{0:D2}h:{1:D2}",
                                       t.Hours,
                                      t.Minutes);

                                    if (remain_secs >= 3600)
                                    {
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs + " " + FFBatch.Properties.Strings.minutes_abrev);
                                    }

                                    if (remain_secs < 3600 && remain_secs >= 600)
                                    {
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes);
                                    }
                                    if (remain_secs < 600 && remain_secs >= 120)
                                    {
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes);
                                    }

                                    if (remain_secs <= 59)
                                    {
                                        this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Convert.ToInt16(remain_secs) + " " + FFBatch.Properties.Strings.seconds);
                                    }

                                    //End remaining time
                                }
                            }

                            //Estimated size and bitrate

                            String read_size = String.Empty;
                            if (err_txt.Contains("size=") && (time_est_size % 3 == 0))
                            {
                                int size_index = err_txt.IndexOf("size=") + 5;
                                read_size = err_txt.Substring(size_index, 8);
                                try
                                {
                                    est_bitrate = (Math.Round(Convert.ToDecimal(read_size) * 8 / Convert.ToDecimal(sec_prog), 0));
                                }
                                catch
                                {
                                }

                                try
                                {
                                    if (Convert.ToDecimal(read_size) > 1 && time_n_tasks > 1)
                                    {
                                        if (est_bitrate < 9999)
                                        {
                                            this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " " + est_bitrate + " " + "Kb/s");
                                        }
                                        else
                                        {
                                            this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " " + (Math.Round(est_bitrate / 1000, 0)) + " " + "Mb/s");
                                        }
                                        //Estimated size
                                        est_size = Convert.ToDecimal(durat_n) * est_bitrate / 8;

                                        if (est_size > 1000000)
                                        {
                                            this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " " + (Math.Round(est_size / 1000000, 1)).ToString() + " " + "GB");
                                        }
                                        else
                                        {
                                            this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " " + (Math.Round(est_size / 1000, 0)).ToString() + " " + "MB");
                                        }
                                    }
                                }
                                catch
                                {
                                }

                                this.InvokeEx(f => f.lbl_est_size.Refresh());
                            }
                        }
                    }
                    catch { }

                    process_glob.WaitForExit();
                    process_glob.StartInfo.Arguments = String.Empty;
                    timer_est_size.Stop();
                    time_est_size = 0;
                    total_duration = total_duration - durations[count - 1];
                    this.InvokeEx(f => lbl_speed.Text = String.Empty);
                    this.InvokeEx(f => f.lbl_est_size.Text = String.Empty);
                    this.InvokeEx(f => f.lbl_bitrate.Text = String.Empty);

                    list_lines.Add("");
                    list_lines.Add("---------------------End of " + Path.GetFileName(file) + " log-------------------------------");
                    list_lines.Add("");
                }

                this.InvokeEx(f => f.Pg1.Value = 100);
                this.InvokeEx(f => f.Pg1.Text = "100%");
                this.InvokeEx(f => f.Pg1.Refresh());

                working = false;
                //Save log
                if (no_save_logs == false)
                {
                    string[] array_err = list_lines.ToArray();
                    String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                    if (is_portable == true) path = port_path + "ff_batch_portable.log";

                    System.IO.StreamWriter SaveFile = new System.IO.StreamWriter(path);
                    SaveFile.WriteLine("FFmpeg log sesion: " + System.DateTime.Now);
                    SaveFile.WriteLine("-------------------------------");
                    foreach (String item in array_err)
                    {
                        SaveFile.WriteLine(item);
                    }
                    SaveFile.Close();

                    File.AppendAllText(path, "-----------------------");
                    File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.end_log);
                    System.IO.FileInfo fileInfo = new System.IO.FileInfo(path);

                    var bytes = fileInfo.Length;

                    var kilobytes = (double)bytes / 1024;
                    var megabytes = kilobytes / 1024;
                    var gigabytes = megabytes / 1024;

                    //Format size view
                    String size = "";
                    String separator = ".";

                    if (bytes > 1000000000)
                    {
                        if (gigabytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }

                        String gigas = gigabytes.ToString();
                        if (gigas.Length >= 5)
                        {
                            gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                            size = (gigas + " " + "GB");
                        }
                        else
                        {
                            size = (gigas + " " + "GB");
                        }
                    }

                    if (bytes >= 1048576 && bytes <= 1000000000)
                    {
                        if (megabytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }
                        String megas = megabytes.ToString();
                        if (megas.Length > 5)
                        {
                            megas = megas.Substring(0, megas.LastIndexOf(separator));
                            size = (megas + " " + "MB");
                        }
                        else
                        {
                            size = (megas + " " + "MB");
                        }
                    }

                    if (bytes >= 1024 && bytes < 1048576)

                    {
                        if (kilobytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }

                        String kbs = kilobytes.ToString();
                        if (kbs.Length >= 5)
                        {
                            kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                            size = (kbs + " " + "KB");
                        }
                        else
                        {
                            size = (kbs + " " + "KB");
                        }
                    }
                    if (bytes > -1 && bytes < 1024)
                    {
                        String bits = bytes.ToString();
                        size = (bits + " Bytes");
                    }

                    //End Format size view
                    File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.log_size + " " + size);

                    //End save log
                }

                Enable_Controls();
                this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));

                if (process_glob.ExitCode == 0 && cancel_queue == false)
                {
                    if (chkshut.Checked)
                    {
                        this.InvokeEx(f => f.groupBox2.Enabled = true);
                        foreach (Control ct in groupBox2.Controls)
                        {
                            this.InvokeEx(f => ct.Enabled = false);
                        }
                        auto_shut();
                        return;
                    }

                    //End shutdown check
                    else
                    {
                        if (play_on_end == true) play_end();
                        if (Form.ActiveForm == null)
                        {
                            notifyIcon1.Visible = true;
                            notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.stream_saved;
                            notifyIcon1.BalloonTipIcon = ToolTipIcon.Info;
                            notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.stream_saved2;
                            notifyIcon1.ShowBalloonTip(0);
                        }

                        if (chk_open_compl.Checked)
                        {
                            if (Directory.GetFiles(destino).Length != 0)
                            {
                                Process open_processed = new Process();
                                open_processed.StartInfo.FileName = "explorer.exe";
                                open_processed.StartInfo.Arguments = '\u0022' + destino + '\u0022';
                                open_processed.Start();
                            }
                            else
                            {
                                if (Directory.Exists(destino))
                                {
                                    System.IO.Directory.Delete(destino);
                                }
                            }
                        }
                    }
                }
                else
                {
                    if (process_glob.ExitCode == 0)
                    {
                        this.InvokeEx(f => f.Pg1.Text = "100%");
                        this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.str_abort, FFBatch.Properties.Strings.aborted, MessageBoxButtons.OK, MessageBoxIcon.Error));
                    }
                    else
                    {
                        this.InvokeEx(f => f.Pg1.Text = "100%");
                        Boolean unsupported = false;
                        foreach (String lin in list_lines)
                        {
                            if (lin.Contains("Could not write header")) unsupported = true;
                        }
                        if (unsupported == true) this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.err_oc + " " + Environment.NewLine + Environment.NewLine + "Possibly incompatible container for selected track" + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.check_log, Properties.Strings2.err_save_track, MessageBoxButtons.OK, MessageBoxIcon.Error));
                        else this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.err_oc + " " + Environment.NewLine + Environment.NewLine + err_txt.TrimStart() + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.check_log, Properties.Strings2.err_save_track, MessageBoxButtons.OK, MessageBoxIcon.Error));
                    }
                }
            }).Start();
        }

        private void ct3_save_track_Click(object sender, EventArgs e)
        {
            if (list_tracks.SelectedItems.Count == 1)
            {
                btn_extract.PerformClick();
                return;
            }

            extract_streams();
        }

        private void btn_save_path_Click(object sender, EventArgs e)
        {
            String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_path.ini";
            if (is_portable == true) path = port_path + "ff_path_portable.ini";
            String path_to_save = String.Empty;
            path_to_save = txt_path_main.Text;
            File.WriteAllText(path, path_to_save);
            btn_save_path.Enabled = false;
        }

        private void btn_save_prio_Click(object sender, EventArgs e)
        {
            btn_save_prio.Enabled = false;
            String path = String.Empty;
            if (is_portable == false)
            {
                path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_priority.ini";
            }
            else
            {
                path = port_path + "ff_priority_portable.ini";
            }

            String path_to_prio = String.Empty;

            if (combo_prio.SelectedIndex != 2)
            {
                path_to_prio = combo_prio.SelectedIndex.ToString();
                File.WriteAllText(path, path_to_prio);
            }
            else
            {
                if (File.Exists(path))
                {
                    File.Delete(path);
                }
            }
            Pg1.Focus();
        }

        private void btn_del_track_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            if (list_tracks.SelectedIndices.Count > 0)
            {
                Boolean has_default = false;

                foreach (ListViewItem elemento in list_tracks.SelectedItems)
                {
                    list_tracks.Items.Remove(elemento);
                    pic_encode_param.Image = null;
                }

                //Review audio track defaults

                foreach (ListViewItem audio_item in list_tracks.Items)
                {
                    if (audio_item.SubItems[3].Text.Contains("Audio"))
                    {
                        if (audio_item.SubItems[5].Text == FFBatch.Properties.Strings.yes)
                        {
                            has_default = true;
                        }
                    }
                }

                if (has_default == false)
                {
                    foreach (ListViewItem audio_item in list_tracks.Items)
                    {
                        if (audio_item.SubItems[3].Text.Contains("Audio"))
                        {
                            audio_item.SubItems[5].Text = FFBatch.Properties.Strings.yes;
                            return;
                        }
                    }
                }
                //End review audio track defaults
                lbl_tr_n.Text = FFBatch.Properties.Strings.tracks + list_tracks.Items.Count.ToString();
            }
            else
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_track_sel, FFBatch.Properties.Strings.no_track_sel2, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
            }
        }

        private void btn_default_track_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            if (list_tracks.SelectedIndices.Count == 1)
            {
                if (list_tracks.SelectedIndices.Count == 0 || list_tracks.SelectedItems[0].SubItems[3].Text.Contains("Video"))
                {
                    return;
                }

                if (list_tracks.SelectedItems[0].SubItems[4].Text == FFBatch.Properties.Strings.yes)
                {
                    list_tracks.SelectedItems[0].SubItems[4].Text = FFBatch.Properties.Strings.no;
                }
                else
                {
                    list_tracks.SelectedItems[0].SubItems[4].Text = FFBatch.Properties.Strings.yes;
                }

                //Review audio defaults
                int default_items = 0;

                for (int i = 0; i < list_tracks.Items.Count; i++)
                {
                    if (list_tracks.Items[i].SubItems[3].Text.Contains("Audio"))
                    {
                        if (list_tracks.Items[i].SubItems[4].Text == FFBatch.Properties.Strings.yes)
                        {
                            default_items = default_items + 1;
                        }
                    }
                }

                if (default_items > 1)
                {
                    foreach (ListViewItem audio_item in list_tracks.Items)
                    {
                        if (audio_item.SubItems[3].Text.Contains("Audio"))
                        {
                            if (audio_item.Text != list_tracks.SelectedItems[0].Text)
                            {
                                audio_item.SubItems[4].Text = FFBatch.Properties.Strings.no;
                            }
                        }
                    }
                }

                if (default_items == 0)
                {
                    foreach (ListViewItem audio_item in list_tracks.Items)
                    {
                        if (audio_item.SubItems[3].Text.Contains("Audio"))
                        {
                            if (audio_item.Text != list_tracks.SelectedItems[0].Text)
                            {
                                audio_item.SubItems[4].Text = FFBatch.Properties.Strings.yes;
                                return;
                            }
                        }
                    }
                }

                //End review audio track defaults

                //Begin subtitle defaults

                //Review audio defaults
                int default_subs = 0;
                for (int i = 0; i < list_tracks.Items.Count; i++)
                {
                    if (list_tracks.Items[i].SubItems[3].Text.Contains("Subtitle"))
                    {
                        if (list_tracks.Items[i].SubItems[4].Text == FFBatch.Properties.Strings.yes)
                        {
                            default_subs = default_subs + 1;
                        }
                    }
                }

                if (default_subs > 1)
                {
                    foreach (ListViewItem audio_item in list_tracks.Items)
                    {
                        if (audio_item.SubItems[3].Text.Contains("Subtitle"))
                        {
                            if (audio_item != list_tracks.SelectedItems[0])
                            {
                                audio_item.SubItems[4].Text = FFBatch.Properties.Strings.no;
                            }
                        }
                    }
                }

                //End subtitle defaults
            }
            else
            {
                MessageBox.Show(FFBatch.Properties.Strings.one_track, FFBatch.Properties.Strings.warning, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
            }
        }

        private void tracks_background()
        {
            check_jobs();
            foreach (ListViewItem item in list_tracks.Items)
            {
                if (Properties.Settings.Default.dark_mode == false)
                {
                    if (item.SubItems[2].Text.ToLower().Contains("video"))
                    {
                        item.BackColor = Color.PapayaWhip;
                    }

                    if (item.SubItems[2].Text.ToLower().Contains("audio"))
                    {
                        item.BackColor = Color.AliceBlue;
                    }
                    if (item.SubItems[2].Text.ToLower().Contains("subtitle"))
                    {
                        item.BackColor = Color.LightGoldenrodYellow;
                    }
                }
                else
                {
                    if (item.SubItems[2].Text.ToLower().Contains("video"))
                    {
                        item.BackColor = Color.FromArgb(255, 96, 60, 60);
                    }

                    if (item.SubItems[2].Text.ToLower().Contains("audio"))
                    {
                        item.BackColor = Color.FromArgb(255, 60, 60, 96);
                    }
                    if (item.SubItems[2].Text.ToLower().Contains("subtitle"))
                    {
                        item.BackColor = Color.FromArgb(255, 96, 96, 60);
                    }
                }
            }
            //Duplicates
            if (tracks_empty == true) return;

            for (int i = 0; i < list_tracks.Items.Count; i++)
            {
                for (int j = i + 1; j < list_tracks.Items.Count; j++)
                {
                    if (list_tracks.Items[i].Text == list_tracks.Items[j].Text && list_tracks.Items[i].SubItems[1].Text == list_tracks.Items[j].SubItems[1].Text)
                    {
                        list_tracks.Items.RemoveAt(j);
                    }
                }
            }
            //End Duplicates
            lbl_tr_n.Text = FFBatch.Properties.Strings.tracks + " " + list_tracks.Items.Count.ToString();
        }

        private void check_jobs()
        {
            if (frm_mux_jobs.dg_pr.RowCount > 0)
            {
                this.InvokeEx(f => f.lbl_mux_jobs.Text = FFBatch.Properties.Strings.jobs + " " + frm_mux_jobs.dg_pr.RowCount);
            }
            else
            {
                this.InvokeEx(f => f.lbl_mux_jobs.Text = String.Empty);
                this.InvokeEx(f => f.btn_mux_show_jobs.Enabled = false);
            }
        }

        private void btn_pause_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            if (working == false) return;
            if (tabControl1.SelectedIndex == 3)
                if (dg1.Rows[0].Cells[5].Value.ToString() == FFBatch.Properties.Strings.recording1) return;

            if (btn_pause.Image != pic_resume.Image)
            {
                paused = true;

                if (tabControl1.SelectedIndex == 0)
                {
                    foreach (ListViewItem item in listView1.Items)
                    {
                        if (working == true && multi_running == false)
                        {
                            process_glob.Suspend();
                        }
                    }

                    if (working == true && multi_running == true)
                    {
                        foreach (Process proc in procs.Values)
                        {
                            try
                            {
                                proc.Suspend();
                            }
                            catch
                            {
                            }
                        }
                    }
                }

                if (tabControl1.SelectedIndex == 1)
                {
                    if (working == true && multi_running == false) process_glob.Suspend();
                }

                if (tabControl1.SelectedIndex == 2)
                {
                    foreach (ListViewItem item in listView3.Items)
                    {
                        if (working == true) process_glob.Suspend();
                    }
                }

                if (tabControl1.SelectedIndex == 3)
                {
                    foreach (DataGridViewRow row in dg1.Rows)
                    {
                        if (m3u_running == true && m3u_single_running == true)
                        {
                            process_glob.Suspend();
                        }
                    }

                    if (m3u_running == true && m3u_single_running == false)
                    {
                        foreach (Process proc in procs.Values)
                        {
                            try
                            {
                                proc.Suspend();
                            }
                            catch
                            {
                            }
                        }
                    }
                }
                this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.Paused));
                this.InvokeEx(f => f.btn_abort_all.Enabled = false);
                this.InvokeEx(f => f.btn_abort_all.Enabled = false);
                this.InvokeEx(f => f.btn_skip_main.Enabled = false);

                this.InvokeEx(f => f.btn_stop_m3u8.Enabled = false);
                this.InvokeEx(f => f.btn_pause.Image = pic_resume.Image);
                //this.InvokeEx(f => f.btn_pause.Text = "Resume encoding");
                MessageBox.Show(FFBatch.Properties.Strings.paused1, FFBatch.Properties.Strings.paused2, MessageBoxButtons.OK);
            }
            else
            {
                this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.Paused));

                paused = false;
                if (tabControl1.SelectedIndex == 0)
                {
                    if (working == true && multi_running == false)
                    {
                        foreach (ProcessThread thr in process_glob.Threads)
                        {
                            process_glob.Resume();
                        }
                    }

                    if (working == true && multi_running == true)
                    {
                        foreach (Process proc in procs.Values)
                        {
                            try
                            {
                                proc.Resume();
                            }
                            catch
                            {
                            }
                        }
                    }
                }

                if (tabControl1.SelectedIndex == 1)
                {
                    if (working == true) process_glob.Resume();
                }

                if (tabControl1.SelectedIndex == 2)
                {
                    foreach (ListViewItem item in listView3.Items)
                    {
                        if (working == true) process_glob.Resume();
                    }
                }

                if (tabControl1.SelectedIndex == 3)
                {
                    foreach (DataGridViewRow row in dg1.Rows)
                    {
                        if (m3u_single_running == true && m3u_running == true)
                        {
                            process_glob.Resume();
                        }
                    }

                    if (m3u_single_running == false && m3u_running == true)
                    {
                        foreach (Process proc in procs.Values)
                        {
                            try
                            {
                                proc.Resume();
                            }
                            catch
                            {
                            }
                        }
                    }
                }

                this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.Normal));
                this.InvokeEx(f => f.btn_abort_all.Enabled = true);
                this.InvokeEx(f => f.btn_skip_main.Enabled = true);
                this.InvokeEx(f => f.btn_stop_m3u8.Enabled = true);
                this.InvokeEx(f => f.btn_skip_main.Enabled = true);
                this.InvokeEx(f => f.btn_pause.Image = pic_pause.Image);
            }
        }

        private void button16_Click_3(object sender, EventArgs e)
        {
            folderBrowserDialog1.ShowNewFolderButton = true;

            if (folderBrowserDialog1.ShowDialog() == DialogResult.OK)
            {
                txt_path_main.Text = folderBrowserDialog1.SelectedPath;
                txt_path_main.BackColor = txt_parameters.BackColor;
                txt_path_mux.Text = folderBrowserDialog1.SelectedPath;
                txt_path_mux.BackColor = txt_parameters.BackColor;
            }
        }

        private void textBox9_DoubleClick(object sender, EventArgs e)
        {
            txt_path_main.Text = ".\\FFBatch";
            txt_path_main.BackColor = Control.DefaultBackColor;
            txt_path_mux.Text = ".\\FFBatch";
            txt_path_mux.BackColor = Control.DefaultBackColor;
        }

        private void timer_est_size_Tick(object sender, EventArgs e)
        {
            time_est_size = time_est_size + 1;
        }

        private void textBox1_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter) e.SuppressKeyPress = true;
        }

        private void btn_skip_main_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            if (working == true && multi_running == false)
            {
                StreamWriter write_q = process_glob.StandardInput;
                write_q.Write("q");
                aborted_url = true;
                skipped = true;
            }
            if (working == true && multi_running == true)
            {
                if (listView1.SelectedItems.Count == 1)
                {
                    if (listView1.SelectedItems[0].SubItems[5].Text != FFBatch.Properties.Strings.queued) cti6.PerformClick();
                    if (listView1.SelectedItems[0].SubItems[5].Text == FFBatch.Properties.Strings.queued) ctdel.PerformClick();
                }
            }
        }

        private void timer2_Tick(object sender, EventArgs e)
        {
            Double weight = 0;
            Double dg_multi_prog = 0;
            start_total_time = start_total_time + 0.5;

            foreach (DataGridViewRow row in dg1.Rows)
            {
                try
                {
                    weight = TimeSpan.Parse(row.Cells[3].Value.ToString()).TotalSeconds / total_multi_duration;
                    if (row.Cells[5].Value.ToString().Contains("%") == true && cancelados_paralelos == false)
                    {
                        dg_multi_prog = dg_multi_prog + (Convert.ToDouble(row.Cells[5].Value.ToString().Replace("%", "")) * weight) * dg1.Rows.Count;
                    }
                }
                catch { }

                if (row.Cells[5].Value.ToString() == FFBatch.Properties.Strings.success || row.Cells[5].Value.ToString() == FFBatch.Properties.Strings.failed || row.Cells[5].Value.ToString() == FFBatch.Properties.Strings.aborted || row.Cells[5].Value.ToString() == FFBatch.Properties.Strings.aborting || row.Cells[5].Value.ToString() == FFBatch.Properties.Strings.skipped)
                {
                    dg_multi_prog = dg_multi_prog + (100 * weight * dg1.Rows.Count);
                }
            }

            if (time_n_tasks > 1)
            {
                if (dg1.Rows[0].Cells[1].Value.ToString().ToLower().Contains("youtu.be") || dg1.Rows[0].Cells[1].Value.ToString().ToLower().Contains("youtube.com"))
                {
                    try
                    {
                        if (Convert.ToInt32(dg_multi_prog) > Pg1.Maximum) Pg1.Value = Pg1.Maximum;
                        else
                        {
                            if (Convert.ToInt32(dg_multi_prog) >= Pg1.Value)
                            {
                                Pg1.Value = Convert.ToInt32(dg_multi_prog);
                                Pg1.Text = Convert.ToInt32(dg_multi_prog / dg1.Rows.Count).ToString() + "%";
                                this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, Pg1.Value, Pg1.Maximum));
                            }
                        }
                    }
                    catch { }
                }
            }
            else
            {
                Pg1.Value = 0;
                Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            }

            if (Pg1.Value / dg1.Rows.Count > 0 && start_total_time > 4)
            {
                Double remain_secs = time_n_tasks * 100 / (Pg1.Value / dg1.Rows.Count) - start_total_time;
                String remain_string = String.Empty;

                TimeSpan t = TimeSpan.FromSeconds(remain_secs);
                remain_string = string.Format("{0:D2}h:{1:D2}",
                t.Hours,
                t.Minutes);

                if (remain_secs >= 43200)
                {
                    txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Math.Round(remain_secs / 3600).ToString() + " " + FFBatch.Properties.Strings.hours;
                }

                if (remain_secs >= 3600 && remain_secs < 43200)
                {
                    txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_string + " " + FFBatch.Properties.Strings.minutes_abrev;
                }

                if (remain_secs < 3600 && remain_secs >= 600)
                {
                    txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_string.Substring(remain_string.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes;
                }
                if (remain_secs < 600 && remain_secs >= 120)
                {
                    txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_string.Substring(remain_string.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes;
                }

                if (remain_secs < 120 && remain_secs > 59)
                {
                    txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.about_1;
                }

                if (remain_secs <= 59)
                {
                    txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.less_one;
                }
                if (remain_secs <= 0)
                {
                    txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.almost_done;
                }
                txt_remain.Refresh();
            }
            else
            {
                if (has_lives_multi == false) txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.calcul;
                else txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.recording;
                txt_remain.Refresh();
            }
        }

        private void btn_extract_Click(object sender, EventArgs e)
        {
            if (list_tracks.SelectedItems.Count > 1)
            {
                extract_streams();
                return;
            }

            Pg1.Focus();
            cancel_queue = false;

            if (!File.Exists(Path.Combine(Application.StartupPath, "ffmpeg.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_ffmpeg, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }
            if (check_ff_md5() == false)
            {
                Form25 frm25 = new Form25();
                frm25.ShowDialog();
                return;
            }

            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            if (list_tracks.SelectedIndices.Count > 1)
            {
                MessageBox.Show(FFBatch.Properties.Strings.only_one, FFBatch.Properties.Strings.multiple_tr, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            foreach (ListViewItem file in list_tracks.Items)
            {
                if (!File.Exists(file.Text))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file_not_found + " " + file.Text, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }

            if (list_tracks.Items.Count == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.tracks_empty, FFBatch.Properties.Strings.no_files, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }

            if (list_tracks.SelectedItems.Count == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_sel, FFBatch.Properties.Strings.warning, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }

            if (txt_track_format.Text == String.Empty && list_tracks.SelectedItems.Count > 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.track_Ext, FFBatch.Properties.Strings.warning, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }

            String is_overw = txt_path_main.Text + "\\" + Path.GetFileNameWithoutExtension(list_tracks.Items[0].Text) + "." + txt_track_format;

            if (is_overw == list_tracks.Items[0].Text)
            {
                MessageBox.Show(FFBatch.Properties.Strings.overw_main, FFBatch.Properties.Strings.overw_not_all, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            DateTime time2;
            if (!DateTime.TryParse(ss_time_input.Text, out time2))
            {
                MessageBox.Show(FFBatch.Properties.Strings.pre_input4, FFBatch.Properties.Strings.pre_input2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            //Validated list, start processing
            //Pending duration

            if (dur_ok == false)
            {
                list_pending_dur.Items.Clear();
                foreach (ListViewItem item in listView1.Items)
                {
                    list_pending_dur.Items.Add((ListViewItem)item.Clone());
                }
                BG_Dur.RunWorkerAsync();
                return;
            }

            Disable_Controls();
            txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + "00h:00m:00s";
            time_n_tasks = 0;
            lbl_elapsed.Text = FFBatch.Properties.Strings.time_elapsed + " " + "00h:00m:00s";
            timer_tasks.Start();

            cancel_queue = false;
            Pg1.Value = 0;
            //pg_current.Value = 0;
            //textBox4.Text = "0%";

            working = true;

            //Copy list of tracks for thread processing
            ListView list_proc = new ListView();
            foreach (ListViewItem item in list_tracks.SelectedItems)
            {
                list_proc.Items.Add((ListViewItem)item.Clone());
            }
            //End of copy list of tracks for thread processing

            Pg1.Maximum = list_proc.Items.Count;

            Double total_duration = 0;
            Double total_prog = 0;

            //Duration
            Process probe = new Process();
            probe.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
            String ffprobe_frames2 = " " + '\u0022' + "--Inform=General;%Duration/String3%" + '\u0022';
            probe.StartInfo.Arguments = ffprobe_frames2 + " " + '\u0022' + list_proc.Items[0].Text + '\u0022';

            probe.StartInfo.RedirectStandardOutput = true;
            probe.StartInfo.UseShellExecute = false;
            probe.StartInfo.CreateNoWindow = true;
            probe.EnableRaisingEvents = true;
            probe.Start();

            String duracion = probe.StandardOutput.ReadLine();

            probe.WaitForExit();

            if (duracion != null)
            {
                DateTime time;
                //total_duration = Convert.ToDouble(duracion.Substring(0, 7));
                if (DateTime.TryParse(duracion, out time))
                {
                    durat_n = TimeSpan.Parse(duracion).TotalSeconds;
                    total_duration = durat_n;
                }
            }
            else
            {
                durat_n = 0;
                total_duration = 0;
            }

            //End duration

            //End

            Pg1.Minimum = 0;
            Pg1.Maximum = 100;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            lbl_speed.Text = String.Empty;

            List<string> list_lines = new List<string>();
            String mux_ext = txt_track_format.Text;

            pic_no_errors.Visible = false;
            pic_recording.Visible = false;
            pic_warnings.Visible = false;

            time_est_size = 0;
            timer_est_size.Start();

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;

                String remain_time = "0";

                String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");

                String file = list_proc.Items[0].Text;
                String fullPath = file;

                String destino = "";

                if (txt_path_main.Text.Contains(".\\"))
                {
                    destino = file.Substring(0, fullPath.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty); ;
                }
                else
                {
                    destino = txt_path_main.Text;
                }

                if (!Directory.Exists(destino))
                {
                    try
                    {
                        Directory.CreateDirectory(destino);
                    }
                    catch (System.Exception excpt)
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        this.Cursor = Cursors.Arrow;
                        Enable_Controls();
                        working = false;
                        return;
                    }
                }

                //Create joint inputs variable
                String inputs = "";
                String stream_type = String.Empty;
                if (list_proc.Items[0].SubItems[2].Text.ToLower().Contains("subtitle"))
                {
                    stream_type = "s";
                }

                if (list_proc.Items[0].SubItems[2].Text.ToLower().Contains("audio"))
                {
                    stream_type = "a";
                }
                if (list_proc.Items[0].SubItems[2].Text.ToLower().Contains("video"))
                {
                    stream_type = "v";
                }
                //{
                //inputs = inputs + " -sub_charenc UTF-8" + " -i " + '\u0022' + input_item.Text + '\u0022';
                //}
                inputs = " -i " + '\u0022' + list_proc.Items[0].Text + '\u0022' + " -map 0:" + list_proc.Items[0].SubItems[1].Text + " -c:" + stream_type + " " + txt_track_param.Text + " ";

                //End create joint inputs variable

                String AppParam = inputs + "-y " + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + "_" + stream_type + "_demux" + "." + mux_ext + '\u0022';

                if (!Directory.Exists(destino))
                {
                    Directory.CreateDirectory(destino);
                }

                process_glob.StartInfo.FileName = ffm;
                process_glob.StartInfo.Arguments = AppParam;
                valid_prog = false;

                //this.InvokeEx(f => f.pg_current.Value = 0);
                //this.InvokeEx(f => f.pg_current.Refresh());

                process_glob.StartInfo.RedirectStandardOutput = true;
                process_glob.StartInfo.RedirectStandardError = true;
                process_glob.StartInfo.RedirectStandardInput = true;
                process_glob.StartInfo.UseShellExecute = false;
                process_glob.StartInfo.CreateNoWindow = true;
                process_glob.EnableRaisingEvents = true;
                process_glob.Start();
                System.Threading.Thread.Sleep(50);
                combo_prio.Invoke(new MethodInvoker(delegate
                {
                    if (combo_prio.SelectedIndex != 2)
                    {
                        Change_mem_prio();
                    }
                }));

                if (total_duration > 0)
                {
                    valid_prog = true;
                }
                else
                {
                    valid_prog = false;
                }

                String err_txt = "";
                Double interval = 0;
                Decimal est_bitrate = 0;
                Decimal est_size = 0;
                Double sec_prog = 0;
                try
                {
                    while (!process_glob.StandardError.EndOfStream)
                    {
                        err_txt = process_glob.StandardError.ReadLine();
                        list_lines.Add(err_txt);

                        if (valid_prog == true)
                        {
                            if (err_txt.Contains("time=") && err_txt.Contains("time=-") == false)
                            {
                                total_prog = durat_n;
                                int start_time_index = err_txt.IndexOf("time=") + 5;
                                sec_prog = TimeSpan.Parse(err_txt.Substring(start_time_index, 8)).TotalSeconds;
                                Double percent = (sec_prog * 100 / durat_n);

                                total_prog = total_prog + (sec_prog - interval);
                                interval = sec_prog;
                                int percent2 = Convert.ToInt32(percent);

                                if (percent2 <= 100)
                                {
                                    //this.InvokeEx(f => f.pg_current.Value = percent2);
                                    //this.InvokeEx(f => f.//textBox4.Text = (percent2).ToString() + "%");

                                    this.InvokeEx(f => f.Pg1.Value = percent2);
                                    this.InvokeEx(f => f.Pg1.Refresh());
                                    this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, percent2, Pg1.Maximum));
                                    if (Math.Round(percent, 1).ToString().Contains(".") || Math.Round(percent, 1).ToString().Contains(","))
                                    {
                                        this.InvokeEx(f => f.Pg1.Text = Math.Round(percent, 1).ToString() + "%");
                                    }
                                    else
                                    {
                                        this.InvokeEx(f => f.Pg1.Text = Math.Round(percent, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0" + "%");
                                    }
                                    //this.InvokeEx(f => f.textBox5.Text = (percent2).ToString() + "%");
                                }

                                //Estimated remaining time

                                remain_time = err_txt.Substring(err_txt.LastIndexOf("speed=") + 6, err_txt.Length - err_txt.LastIndexOf("speed=") - 6);
                                if (time_est_size % 3 == 0) this.InvokeEx(f => f.lbl_speed.Text = FFBatch.Properties.Strings.speed + " " + remain_time);
                                remain_time = remain_time.Replace("x", String.Empty);
                                Double timing1 = 0;

                                if (System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator == ",")
                                {
                                    timing1 = Math.Round(Double.Parse(remain_time.Replace(".", ",")), 2);
                                }
                                else
                                {
                                    timing1 = Math.Round(Double.Parse(remain_time), 2);
                                }
                                Decimal timing = (decimal)timing1;
                                Decimal total_dur_dec = Convert.ToDecimal(interval);
                                Decimal total_prog_dec = Convert.ToDecimal(total_prog);

                                Decimal remain_secs = 0;
                                if (timing > 0)
                                {
                                    remain_secs = (decimal)(total_prog_dec - total_dur_dec) / timing;
                                }

                                if (remain_secs > 60)
                                {
                                    remain_secs = remain_secs + 60;
                                }
                                String remain_from_secs = "";

                                TimeSpan t = TimeSpan.FromSeconds(Convert.ToDouble(remain_secs));
                                remain_from_secs = string.Format("{0:D2}h:{1:D2}",
                                   t.Hours,
                                  t.Minutes);

                                if (remain_secs >= 3600)
                                {
                                    this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs + " " + FFBatch.Properties.Strings.minutes_abrev);
                                }

                                if (remain_secs < 3600 && remain_secs >= 600)
                                {
                                    this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes);
                                }
                                if (remain_secs < 600 && remain_secs >= 120)
                                {
                                    this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes);
                                }

                                if (remain_secs <= 59)
                                {
                                    this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Convert.ToInt16(remain_secs) + " " + FFBatch.Properties.Strings.seconds);
                                }

                                //End remaining time
                            }
                        }

                        //Estimated size and bitrate

                        String read_size = String.Empty;
                        if (err_txt.Contains("size=") && (time_est_size % 3 == 0))
                        {
                            int size_index = err_txt.IndexOf("size=") + 5;
                            read_size = err_txt.Substring(size_index, 8);
                            try
                            {
                                est_bitrate = (Math.Round(Convert.ToDecimal(read_size) * 8 / Convert.ToDecimal(sec_prog), 0));
                            }
                            catch
                            {
                            }

                            try
                            {
                                if (Convert.ToDecimal(read_size) > 1 && time_n_tasks > 1)
                                {
                                    if (est_bitrate < 9999)
                                    {
                                        this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " " + est_bitrate + " " + "Kb/s");
                                    }
                                    else
                                    {
                                        this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " " + (Math.Round(est_bitrate / 1000, 0)) + " " + "Mb/s");
                                    }
                                    //Estimated size
                                    est_size = Convert.ToDecimal(durat_n) * est_bitrate / 8;

                                    if (est_size > 1000000)
                                    {
                                        this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " " + (Math.Round(est_size / 1000000, 1)).ToString() + " " + "GB");
                                    }
                                    else
                                    {
                                        this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " " + (Math.Round(est_size / 1000, 0)).ToString() + " " + "MB");
                                    }
                                }
                            }
                            catch
                            {
                            }

                            this.InvokeEx(f => f.lbl_est_size.Refresh());
                        }
                    }
                }
                catch { }

                process_glob.WaitForExit();
                process_glob.StartInfo.Arguments = String.Empty;
                timer_est_size.Stop();
                time_est_size = 0;
                this.InvokeEx(f => lbl_speed.Text = String.Empty);
                this.InvokeEx(f => f.lbl_est_size.Text = String.Empty);
                this.InvokeEx(f => f.lbl_bitrate.Text = String.Empty);

                //this.InvokeEx(f => f.pg_current.Value = 100);
                //this.InvokeEx(f => f.//textBox4.Text = "100%");
                list_lines.Add("");
                list_lines.Add("---------------------End of " + Path.GetFileName(file) + " log-------------------------------");
                list_lines.Add("");

                this.InvokeEx(f => f.Pg1.Value = 100);
                this.InvokeEx(f => f.Pg1.Text = "100%");
                working = false;
                //Save log
                if (no_save_logs == false)
                {
                    string[] array_err = list_lines.ToArray();
                    String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                    if (is_portable == true) path = port_path + "ff_batch_portable.log";

                    System.IO.StreamWriter SaveFile = new System.IO.StreamWriter(path);
                    SaveFile.WriteLine("FFmpeg log sesion: " + System.DateTime.Now);
                    SaveFile.WriteLine("-------------------------------");
                    foreach (String item in array_err)
                    {
                        SaveFile.WriteLine(item);
                    }
                    SaveFile.Close();

                    File.AppendAllText(path, "-----------------------");
                    File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.end_log);
                    System.IO.FileInfo fileInfo = new System.IO.FileInfo(path);

                    var bytes = fileInfo.Length;

                    var kilobytes = (double)bytes / 1024;
                    var megabytes = kilobytes / 1024;
                    var gigabytes = megabytes / 1024;

                    //Format size view
                    String size = "";
                    String separator = ".";

                    if (bytes > 1000000000)
                    {
                        if (gigabytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }

                        String gigas = gigabytes.ToString();
                        if (gigas.Length >= 5)
                        {
                            gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                            size = (gigas + " " + "GB");
                        }
                        else
                        {
                            size = (gigas + " " + "GB");
                        }
                    }

                    if (bytes >= 1048576 && bytes <= 1000000000)
                    {
                        if (megabytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }
                        String megas = megabytes.ToString();
                        if (megas.Length > 5)
                        {
                            megas = megas.Substring(0, megas.LastIndexOf(separator));
                            size = (megas + " " + "MB");
                        }
                        else
                        {
                            size = (megas + " " + "MB");
                        }
                    }

                    if (bytes >= 1024 && bytes < 1048576)

                    {
                        if (kilobytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }

                        String kbs = kilobytes.ToString();
                        if (kbs.Length >= 5)
                        {
                            kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                            size = (kbs + " " + "KB");
                        }
                        else
                        {
                            size = (kbs + " " + "KB");
                        }
                    }
                    if (bytes > -1 && bytes < 1024)
                    {
                        String bits = bytes.ToString();
                        size = (bits + " Bytes");
                    }

                    //End Format size view
                    File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.log_size + " " + size);

                    //End save log
                }

                Enable_Controls();
                this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));

                if (process_glob.ExitCode == 0 && cancel_queue == false)
                {
                    if (chkshut.Checked)
                    {
                        this.InvokeEx(f => f.groupBox2.Enabled = true);
                        foreach (Control ct in groupBox2.Controls)
                        {
                            this.InvokeEx(f => ct.Enabled = false);
                        }
                        auto_shut();
                        return;
                    }

                    //End shutdown check
                    else
                    {
                        if (play_on_end == true) play_end();
                        if (Form.ActiveForm == null)
                        {
                            notifyIcon1.Visible = true;
                            notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.stream_saved;
                            notifyIcon1.BalloonTipIcon = ToolTipIcon.Info;
                            notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.stream_saved2;
                            notifyIcon1.ShowBalloonTip(0);
                        }

                        if (chk_open_compl.Checked)
                        {
                            if (Directory.GetFiles(destino).Length != 0)
                            {
                                Process open_processed = new Process();
                                open_processed.StartInfo.FileName = "explorer.exe";
                                open_processed.StartInfo.Arguments = '\u0022' + destino + '\u0022';
                                open_processed.Start();
                            }
                            else
                            {
                                if (Directory.Exists(destino))
                                {
                                    System.IO.Directory.Delete(destino);
                                }
                            }
                        }
                    }
                }
                else
                {
                    if (process_glob.ExitCode == 0)
                    {
                        this.InvokeEx(f => f.Pg1.Text = "100%");
                        this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.str_abort, FFBatch.Properties.Strings.aborted, MessageBoxButtons.OK, MessageBoxIcon.Error));
                    }
                    else
                    {
                        this.InvokeEx(f => f.Pg1.Text = "100%");
                        Boolean unsupported = false;
                        foreach (String lin in list_lines)
                        {
                            if (lin.Contains("Could not write header")) unsupported = true;
                        }
                        if (unsupported == true) this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.err_oc + " " + Environment.NewLine + Environment.NewLine + "Possibly incompatible container for selected track" + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.check_log, Properties.Strings2.err_save_track, MessageBoxButtons.OK, MessageBoxIcon.Error));
                        else this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.err_oc + " " + Environment.NewLine + Environment.NewLine + err_txt.TrimStart() + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.check_log, Properties.Strings2.err_save_track, MessageBoxButtons.OK, MessageBoxIcon.Error));
                    }
                }
            }).Start();
        }

        private void btn_help_Click(object sender, EventArgs e)
        {
            String loc = FFBatch.Properties.Settings.Default.app_lang;
            String ffm = System.IO.Path.Combine(Application.StartupPath, "FFmpeg_Batch_User_Guide_" + loc + ".pdf");

            if (!File.Exists(ffm))
            {
                try
                {
                    Process.Start(System.IO.Path.Combine(Application.StartupPath, "FFmpeg_Batch_User_Guide_en.pdf"));
                    return;
                }
                catch
                {
                    MessageBox.Show(FFBatch.Properties.Strings.help_not, FFBatch.Properties.Strings.file_not_f, MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
            else
            {
                Process.Start(ffm);
            }
        }

        private void CB1_o_SelectedIndexChanged(object sender, EventArgs e)
        {
            audio_capture_device = CB1_o.SelectedItem.ToString();
            //throw new NotImplementedException();
        }

        private void boton_ok_path_Click(object sender, EventArgs e)
        {
            if (path_txt.Text == String.Empty)
            {
                MessageBox.Show(FFBatch.Properties.Strings.path_empty);
                return;
            }
            if (path_txt.Text.Substring(0, 1) == "\\")
            {
                MessageBox.Show(FFBatch.Properties.Strings.please_not + " " + "\\" + FFBatch.Properties.Strings.characters);
                return;
            }

            if (path_txt.Text.Contains("¿") || path_txt.Text.Contains("?") || path_txt.Text.Contains(":") || path_txt.Text.Contains(".") || path_txt.Text.Contains("/") || path_txt.Text.Contains(">") || path_txt.Text.Contains(">") || path_txt.Text.Contains(",") || path_txt.Text.Contains("{") || path_txt.Text.Contains("}") || path_txt.Text.Contains("&") || path_txt.Text.Contains("%"))
            {
                MessageBox.Show(FFBatch.Properties.Strings.invalid_ch);
                return;
            }

            txt_path_main.Text = ".\\" + path_txt.Text;
            txt_path_mux.Text = txt_path_main.Text;
            txt_path_main.BackColor = groupBox1.BackColor;
            //btn_reset_path.BackColor = groupBox1.BackColor;
            path_txt.Text = String.Empty;
            btn_save_path.Enabled = true;
            ActiveForm.Close();
        }

        private void path_txt_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                if (path_txt.Text == String.Empty)
                {
                    return;
                }
                if (path_txt.Text.Substring(0, 1) == "\\")
                {
                    MessageBox.Show(FFBatch.Properties.Strings.please_not + " " + "\\" + FFBatch.Properties.Strings.characters);
                    return;
                }

                if (path_txt.Text.Contains("¿") || path_txt.Text.Contains("?") || path_txt.Text.Contains(":") || path_txt.Text.Contains(".") || path_txt.Text.Contains("/") || path_txt.Text.Contains(">") || path_txt.Text.Contains(">") || path_txt.Text.Contains(",") || path_txt.Text.Contains("{") || path_txt.Text.Contains("}") || path_txt.Text.Contains("&") || path_txt.Text.Contains("%"))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.invalid_ch);
                    return;
                }

                txt_path_main.Text = ".\\" + path_txt.Text;
                txt_path_mux.Text = txt_path_main.Text;
                txt_path_main.BackColor = groupBox1.BackColor;
                //btn_reset_path.BackColor = groupBox1.BackColor;
                path_txt.Text = String.Empty;
                btn_save_path.Enabled = true;
                ActiveForm.Close();
            }
        }

        private void boton_ok_audio_Click(object sender, EventArgs e)
        {
            prev_dev_audio = CB1_o.SelectedItem.ToString();
            ActiveForm.Close();
            abort_capture = false;

            //throw new NotImplementedException();
        }

        private void btn_wizard_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            String ffm = System.IO.Path.Combine(Application.StartupPath, "AeroWizard.dll");
            if (!File.Exists(ffm))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_aerowiz, FFBatch.Properties.Strings.required_file, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }
            if (tabControl1.SelectedIndex != 0) tabControl1.SelectedIndex = 0;

            AeroWizard1 wizard1 = new AeroWizard1();
            if (show_wiz == true)
            {
                wizard1.chk_start.Checked = true;
                wizard1.chk_start_0.Checked = true;
            }
            else
            {
                wizard1.chk_start.Checked = false;
                wizard1.chk_start_0.Checked = false;
            }
            wizard1.StartPosition = FormStartPosition.CenterScreen;

            if (listView1.Items.Count > 0)
            {
                if (listView1.SelectedIndices.Count == 1)
                {
                    wizard1.lv1_item = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
                }
                else
                {
                    wizard1.lv1_item = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text;
                }
            }
            if (show_wiz_start == true) wizard1.start_no_files = true;
            else wizard1.start_no_files = false;
            if (is_portable == true) wizard1.is_portable = true;
            else wizard1.is_portable = true;
            wizard1.ShowDialog();

            if (wizard1.add_files == true)
            {
                from_wizard = true;
                btn_add_files.PerformClick();
                return;
            }
            if (wizard1.add_folder == true)
            {
                from_wizard = true;
                btn_add_folders.PerformClick();
                return;
            }
            if (wizard1.chk_start.Checked == true || wizard1.chk_start_0.Checked == true) show_wiz = true;
            else show_wiz = false;
            if (wizard1.no_two == true) return;
            if (wizard1.wiz_two_pass == true)
            {
                this.Cursor = Cursors.WaitCursor;
                menu_two_pass_wizard.PerformClick();
                this.Cursor = Cursors.Arrow;
                return;
            }
            if (wizard1.w_images == true)
            {
                this.Cursor = Cursors.WaitCursor;
                menu_extract_images.PerformClick();
                this.Cursor = Cursors.Arrow;
                return;
            }

            if (wizard1.w_split == true)
            {
                this.Cursor = Cursors.WaitCursor;
                menu_split.PerformClick();
                this.Cursor = Cursors.Arrow;
                return;
            }
            if (wizard1.no_silence == true) return;
            if (wizard1.wiz_silence == true)
            {
                this.Cursor = Cursors.WaitCursor;
                this.Cursor = Cursors.Arrow;
                detect_silence();
                return;
            }

            if (wizard1.no_img_v == true) return;
            if (wizard1.wiz_img_v == true)
            {
                this.Cursor = Cursors.WaitCursor;
                this.Cursor = Cursors.Arrow;
                menu_img_v.PerformClick();
                return;
            }

            if (wizard1.wiz_params != String.Empty)
            {
                if (wizard1.sel_preset != String.Empty)
                {
                    try
                    {
                        combo_presets.SelectedIndex = combo_presets.FindString(wizard1.sel_preset);
                        txt_parameters.Text = wizard1.wiz_params;
                        txt_format.Text = wizard1.wiz_ext;
                    }
                    catch { }
                }
                else
                {
                    combo_presets.SelectedIndex = combo_presets.Items.Count - 1;
                    combo_presets.Text = FFBatch.Properties.Strings.new_preset;
                    txt_parameters.Text = wizard1.wiz_params;
                    txt_format.Text = wizard1.wiz_ext;
                }
            }
            if (wizard1.wiz_preset != String.Empty && wizard1.wiz_save_preset == true)
            {
                combo_presets.SelectedIndex = combo_presets.Items.Count - 1;
                txt_parameters.Text = wizard1.wiz_params;
                txt_format.Text = wizard1.wiz_ext;
                combo_presets.Text = wizard1.wiz_preset;
                btn_save_preset.PerformClick();
            }
        }

        private void txt_mux_type_Enter(object sender, EventArgs e)
        {
            txt_mux_type.Enabled = false;
            txt_mux_type.Enabled = true;
        }

        private void combo_def_und_lang_DropDown(object sender, EventArgs e)
        {
            combo_def_und_lang.SelectedIndex = 0;
        }

        private void ct3_combo_language_DropDown(object sender, EventArgs e)
        {
            ct3_combo_language.SelectedIndex = 0;
        }

        private void Combo_single_subs_lang_DropDown(object sender, EventArgs e)
        {
            Combo_single_subs_lang.SelectedIndex = 0;
        }

        private void BG_refresh_dur_DoWork(object sender, DoWorkEventArgs e)
        {
            canceled_file_adding = false;
            this.InvokeEx(f => f.listView1.BeginUpdate());
            this.InvokeEx(f => f.Disable_Controls());
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.group_prog.Focus());
            this.InvokeEx(f => f.btn_cancel_add.Enabled = true);
            this.InvokeEx(f => f.btn_cancel_add.Visible = true);
            this.InvokeEx(f => f.btn_cancel_add.Refresh());
            this.InvokeEx(f => f.LB_Wait.Visible = true);
            this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.ref_dur);
            this.InvokeEx(f => f.LB_Wait.Refresh());
            this.InvokeEx(f => f.pg_adding.Visible = true);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.txt_adding_p.Visible = true);
            this.InvokeEx(f => f.txt_adding_p.Refresh());
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);

            Process probe = new Process();

            for (int i = 0; i < list_global_proc.Items.Count; i++)
            {
                if (canceled_file_adding == true) continue;

                this.InvokeEx(f => f.pg_adding.Value = pg_adding.Value + 1);
                this.InvokeEx(f => f.txt_adding_p.Text = (pg_adding.Value * 100 / list_global_proc.Items.Count + "%"));
                this.InvokeEx(f => f.txt_adding_p.Refresh());

                if (list_global_proc.Items[i].SubItems[3].Text == FFBatch.Properties.Strings.pending || list_global_proc.Items[i].SubItems[3].Text == FFBatch.Properties.Strings.n_a)
                {
                    probe.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
                    String ffprobe_frames = " " + '\u0022' + "--Inform=General;%Duration/String3%" + '\u0022';
                    probe.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + list_global_proc.Items[i].Text + '\u0022';

                    probe.StartInfo.RedirectStandardOutput = true;
                    probe.StartInfo.UseShellExecute = false;
                    probe.StartInfo.CreateNoWindow = true;
                    probe.EnableRaisingEvents = true;
                    probe.Start();

                    String duracion = probe.StandardOutput.ReadLine();
                    probe.WaitForExit();

                    if (duracion != null)
                    {
                        TimeSpan time;
                        if (TimeSpan.TryParse(duracion, out time))
                        {
                            this.InvokeEx(f => f.listView1.Items[i].SubItems[3].Text = duracion);

                            if (duracion.Length >= 12)
                            {
                                if (duracion.Substring(0, 11) == "0:00:00.000" || duracion.Substring(0, 12) == "00:00:00.000")
                                {
                                    this.InvokeEx(f => f.listView1.Items[i].BackColor = Color.LightGoldenrodYellow);
                                }
                            }
                        }
                        else
                        {
                            this.InvokeEx(f => f.listView1.Items[i].SubItems[3].Text = FFBatch.Properties.Strings.n_a);
                            this.InvokeEx(f => f.listView1.Items[i].BackColor = Color.LightGoldenrodYellow);
                        }
                    }
                    else
                    {
                        this.InvokeEx(f => f.listView1.Items[i].SubItems[3].Text = FFBatch.Properties.Strings.n_a);
                        this.InvokeEx(f => f.listView1.Items[i].BackColor = Color.LightGoldenrodYellow);
                    }
                }
            }

            this.InvokeEx(f => f.lbl_items.Text = listView1.Items.Count + " " + FFBatch.Properties.Strings.files);
            this.InvokeEx(f => f.LB_Wait.Text = "");
            this.InvokeEx(f => f.txt_adding_p.Visible = false);
            this.InvokeEx(f => f.listView1.EndUpdate());
            this.InvokeEx(f => f.Enable_Controls());
            this.InvokeEx(f => f.chkshut.Enabled = true);
            this.InvokeEx(f => f.btn_pause.Enabled = true);
            this.InvokeEx(f => f.btn_cancel_add.Visible = false);
            this.InvokeEx(f => f.txt_adding_p.Text = "");
            this.InvokeEx(f => f.txt_adding_p.Visible = false);
            this.InvokeEx(f => f.lbl_items.Visible = true);
            this.InvokeEx(f => f.lbl_dur_list.Visible = true);
            this.InvokeEx(f => f.lbl_size.Visible = true);
            this.InvokeEx(f => f.pg_adding.Visible = false);
            this.InvokeEx(f => f.LB_Wait.Visible = false);
            this.InvokeEx(f => f.tabControl1.Enabled = true);
        }

        private void btn_edit_config_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            menu_settings.PerformClick();
        }

        private void combo_shut_SelectedIndexChanged(object sender, EventArgs e)
        {
            String f_run_end = String.Empty;
            String f_run_each = String.Empty;
            if (is_portable == false)
            {
                f_run_end = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_run_end.ini";
                f_run_each = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_run_each.ini";
            }
            else
            {
                f_run_end = port_path + "ff_run_end_portable.ini";
                f_run_each = port_path + "ff_run_each_portable.ini";
            }

            if (combo_shut.SelectedIndex < 3) shut_type = combo_shut.SelectedItem.ToString();
            else
            {
                if (combo_shut.SelectedIndex == 3)
                {
                    Form13 frm_run = new Form13();
                    frm_run.run_each = false;
                    frm_run.Text = FFBatch.Properties.Strings.open_comp;
                    frm_run.label3.Text = FFBatch.Properties.Strings.sel_app;

                    if (File.Exists(f_run_end))
                    {
                        int linea = 0;
                        foreach (String line in File.ReadLines(f_run_end))
                        {
                            if (linea == 0) frm_run.txt_path.Text = line;
                            if (linea == 1) frm_run.txt_args.Text = line;
                            linea = linea + 1;
                        }
                    }

                    frm_run.ShowDialog();
                    if (frm_run.cancel == false)
                    {
                        run_command = frm_run.txt_path.Text;
                        run_command_args = frm_run.txt_args.Text;
                        try
                        {
                            File.WriteAllText(f_run_end, frm_run.txt_path.Text + Environment.NewLine + frm_run.txt_args.Text);
                        }
                        catch { }
                    }
                    else
                    {
                        run_command = String.Empty;
                        run_command_args = frm_run.txt_args.Text;
                        combo_shut.SelectedIndex = 0;
                        chkshut.Checked = false;
                    }
                }
                if (combo_shut.SelectedIndex == 4)
                {
                    Form13 frm_run = new Form13();
                    frm_run.run_each = true;
                    frm_run.Text = FFBatch.Properties.Strings.runcomm;
                    frm_run.label3.Text = FFBatch.Properties.Strings.runcom2;
                    if (File.Exists(f_run_each))
                    {
                        int linea = 0;
                        foreach (String line in File.ReadLines(f_run_each))
                        {
                            if (linea == 0) frm_run.txt_path.Text = line;
                            if (linea == 1) frm_run.txt_args.Text = line;
                            linea = linea + 1;
                        }
                    }
                    frm_run.ShowDialog();
                    if (frm_run.cancel == false)
                    {
                        run_command = frm_run.txt_path.Text;
                        run_command_args = frm_run.txt_args.Text;
                        try
                        {
                            File.WriteAllText(f_run_each, frm_run.txt_path.Text + Environment.NewLine + frm_run.txt_args.Text);
                        }
                        catch { }
                    }
                    else
                    {
                        run_command = String.Empty;
                        run_command_args = frm_run.txt_args.Text;
                        combo_shut.SelectedIndex = 0;
                        chkshut.Checked = false;
                    }
                }
            }
        }

        private void fade_v_in_CheckedChanged(object sender, EventArgs e)
        {
            if (fade_v_in.CheckState == CheckState.Checked)
            {
                num_v_in.Enabled = true;
                combo_vin_col.Enabled = true;
                if (txt_parameters.Text.Contains("-c:v copy") || txt_parameters.Text.Contains("-vcodec copy") || txt_parameters.Text.Contains("-c copy"))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.fade_str);
                }
            }
            else
            {
                num_v_in.Enabled = false;
                combo_vin_col.Enabled = false;
            }
        }

        private void fade_v_out_CheckedChanged(object sender, EventArgs e)
        {
            if (fade_v_out.CheckState == CheckState.Checked)
            {
                num_v_out.Enabled = true;
                combo_vout_color.Enabled = true;
                if (txt_parameters.Text.Contains("-c:v copy") || txt_parameters.Text.Contains("-vcodec copy") || txt_parameters.Text.Contains("-c copy"))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.fade_str);
                }
                if (txt_parameters.Text.Contains("-vf") || txt_parameters.Text.Contains("-filter:v"))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.fade_vf);
                }
            }
            else
            {
                num_v_out.Enabled = false;
                combo_vout_color.Enabled = false;
            }
        }

        private void fade_a_in_CheckedChanged(object sender, EventArgs e)
        {
            if (fade_a_in.CheckState == CheckState.Checked)
            {
                num_a_in.Enabled = true;
                if (txt_parameters.Text.Contains("-c:a copy") || txt_parameters.Text.Contains("-acodec copy") || txt_parameters.Text.Contains("-c copy"))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.fade_str);
                }
            }
            else
            {
                num_a_in.Enabled = false;
            }
        }

        private void fade_a_out_CheckedChanged(object sender, EventArgs e)
        {
            if (fade_a_out.CheckState == CheckState.Checked)
            {
                num_a_out.Enabled = true;
                if (txt_parameters.Text.Contains("-c:a copy") || txt_parameters.Text.Contains("-acodec copy") || txt_parameters.Text.Contains("-c copy"))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.fade_str);
                }
                if (txt_parameters.Text.Contains("-af") || txt_parameters.Text.Contains("-filter:a"))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.fade_af);
                }
            }
            else
            {
                num_a_out.Enabled = false;
            }
        }

        private void multiple_presets_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            if (!File.Exists(Path.Combine(Application.StartupPath, "ffmpeg.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_ffmpeg, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }
            if (check_ff_md5() == false)
            {
                Form25 frm25 = new Form25();
                frm25.ShowDialog();
                return;
            }

            String ffm = Path.Combine(Application.StartupPath, "AeroWizard.dll");
            if (!File.Exists(ffm))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_aerowiz, FFBatch.Properties.Strings.required_file, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (listView1.Items.Count == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.list_empty, FFBatch.Properties.Strings.no_files, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            foreach (ListViewItem file2 in listView1.Items)
            {
                if (!File.Exists(file2.SubItems[1].Text + "\\" + file2.Text))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file_not_found + " " + file2.Text, FFBatch.Properties.Strings.file_not_found2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }
            String element = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text;
            String is_overw = txt_path_main.Text + "\\" + Path.GetFileNameWithoutExtension(element) + "." + txt_format.Text;

            if (is_overw == element && chk_suffix.Checked == false)
            {
                MessageBox.Show(FFBatch.Properties.Strings.overw_not_en + " " + '\u0022' + FFBatch.Properties.Strings.ren_out + '\u0022' + " " + FFBatch.Properties.Strings.checkb, FFBatch.Properties.Strings.overw_not_all, MessageBoxButtons.OK, MessageBoxIcon.Error);

                return;
            }
            DateTime time2;
            if (!DateTime.TryParse(ss_time_input.Text, out time2))
            {
                MessageBox.Show(FFBatch.Properties.Strings.pre_input1, FFBatch.Properties.Strings.pre_input2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (ss_time_input.Text != "0:00:00")
            {
                foreach (ListViewItem item in listView1.Items)
                {
                    if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                    {
                        if (TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds <= TimeSpan.Parse(ss_time_input.Text).TotalSeconds)
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.pre_input3 + " " + '\u0022' + Path.GetFileName(item.Text) + '\u0022', FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            return;
                        }
                    }
                }
            }

            DateTime time;
            if (!DateTime.TryParse(ss_time_input.Text, out time))
            {
                MessageBox.Show(FFBatch.Properties.Strings.pre_input1, FFBatch.Properties.Strings.pre_input2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            avoid_overw();

            //Check path is writable
            String destino1 = String.Empty;
            Boolean rel_path = false;
            if (txt_path_main.Text.Contains(".\\"))
            {
                destino1 = element.Substring(0, element.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
                rel_path = true;
            }
            else
            {
                if (checkBox1.CheckState == CheckState.Checked)
                {
                    String pre_dest = Path.GetDirectoryName(element);
                    destino1 = Path.Combine(txt_path_main.Text, pre_dest.Substring(3, pre_dest.Length - 3));
                    rel_path = true;
                }
                else
                {
                    destino1 = txt_path_main.Text;
                }
            }

            try
            {
                if (rel_path == true)
                {
                    Directory.CreateDirectory(destino1);
                    System.Threading.Thread.Sleep(25);
                }
                else
                {
                    File.WriteAllText(destino1 + "\\" + "FFBatch_test.txt", "FFBatch_test");
                    System.Threading.Thread.Sleep(25);
                    File.Delete(destino1 + "\\" + "FFBatch_test.txt");
                }
            }
            catch (System.Exception excpt)
            {
                MessageBox.Show(FFBatch.Properties.Strings.write_error1 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }
            //End path is writable
            if (avoid_overwriting == true && txt_path_main.Text.Contains(".\\") == false && txt_path_main.Text.Length < 4 && checkBox1.CheckState != CheckState.Checked)
            {
                avoid_overwriting = false;
                DialogResult a2 = MessageBox.Show(FFBatch.Properties.Strings.multiple_folders + " " + '\u0022' + FFBatch.Properties.Strings.recreate_path + '\u0022' + " " + "to avoid opossible overwritings." + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.continu, "Different input folders to single output folder", MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2);
                if (a2 == DialogResult.No) return;
            }

            //Wizard
            AeroWizard2 wizard2 = new AeroWizard2();
            wizard2.StartPosition = FormStartPosition.CenterScreen;
            wizard2.pr1_string = multi_pr1;
            wizard2.pr1_string_ext = multi_pr1_ext;
            wizard2.pr2_string = multi_pr2;
            wizard2.pr2_string_ext = multi_pr2_ext;
            wizard2.pr3_string = multi_pr3;
            wizard2.pr3_string_ext = multi_pr3_ext;
            wizard2.ShowDialog();
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            if (wizard2.cancelled_w == true) return;
            n_multi_presets = wizard2.n_presets_w;
            multi_pr1 = wizard2.pr1_string;
            multi_pr1_ext = wizard2.pr1_string_ext;
            multi_pr2 = wizard2.pr2_string;
            multi_pr2_ext = wizard2.pr2_string_ext;
            multi_pr3 = wizard2.pr3_string;
            multi_pr3_ext = wizard2.pr3_string_ext;
            ren_multi = wizard2.rename_w;
            start_multiple();
        }

        private void BG_Try_multi_DoWork(object sender, DoWorkEventArgs e)
        {
            tried_ok = false;
            this.InvokeEx(f => this.Cursor = Cursors.WaitCursor);
            ListBox LB1_o = new ListBox();
            Process consola_pre = new Process();
            String file_prueba = "";
            String sel_test = "";
            this.InvokeEx(f => sel_test = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text);
            file_prueba = sel_test;
            String destino_test = Path.GetTempPath() + "\\" + "FFBatch_test";
            Boolean bad_chars = false;
            Boolean unsupported = false;

            Task tt = Task.Run(() =>
            {
                String fichero = Path.GetFileName(file_prueba);

                if (!Directory.Exists(destino_test))
                {
                    try
                    {
                        Directory.CreateDirectory(destino_test);
                    }
                    catch (System.Exception excpt)
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                        return;
                    }
                }

                String ext_output = "." + multi_pr1_ext;
                textbox_params = multi_pr1;
                String file_prueba2 = file_prueba;

                if (textbox_params.Contains("%fn"))
                {
                    textbox_params = textbox_params.Replace("%fn", Path.GetFileNameWithoutExtension(file_prueba));
                }
                if (textbox_params.Contains("%fp"))
                {
                    textbox_params = textbox_params.Replace("%fp", Path.GetDirectoryName(file_prueba));
                }
                if (textbox_params.Contains("%fd"))
                {
                    var path = Path.GetFullPath(file_prueba);
                    var dirName = Path.GetFileName(Path.GetDirectoryName(path));
                    textbox_params = textbox_params.Replace("%fd", dirName);
                }

                if (textbox_params.Contains("%1"))
                {
                    if (file_prueba2.Contains("[") || file_prueba2.Contains("]"))
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.conflict_char, FFBatch.Properties.Strings.conflict_char2, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                        Enable_Controls();
                        this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                        tried_ok = false;
                        bad_chars = true;
                        return;
                    }
                    file_prueba2 = file_prueba2.Replace("\\", "\\\\\\\\");
                    file_prueba2 = file_prueba2.Replace(":", ":" + "\\\\");
                    textbox_params = textbox_params.Replace("%1", file_prueba2);
                }

                String pre_i = "";
                txt_pre_input.Invoke(new MethodInvoker(delegate
                {
                    pre_i = txt_pre_input.Text;
                }));

                consola_pre.StartInfo.FileName = "ffmpeg.exe";
                consola_pre.StartInfo.Arguments = pre_i + " " + hw_decode_glob + " -i " + "" + '\u0022' + file_prueba + '\u0022' + "" + " -y " + textbox_params + " " + '\u0022' + destino_test + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + ext_output + '\u0022';

                consola_pre.StartInfo.RedirectStandardOutput = true;
                consola_pre.StartInfo.RedirectStandardError = true;
                consola_pre.StartInfo.UseShellExecute = false;
                consola_pre.StartInfo.CreateNoWindow = true;
                consola_pre.EnableRaisingEvents = true;
                consola_pre.Start();

                while (!consola_pre.StandardError.EndOfStream)
                {
                    this.InvokeEx(f => LB1_o.Items.Add(consola_pre.StandardError.ReadLine()));
                    this.InvokeEx(f => LB1_o.TopIndex = LB1_o.Items.Count - 1);
                    this.InvokeEx(f => LB1_o.Refresh());
                }

                consola_pre.WaitForExit();
                consola_pre.StartInfo.Arguments = String.Empty;
            });

            if (!tt.Wait(675) && consola_pre.StartInfo.Arguments != String.Empty)
            {
                consola_pre.Kill();
                tried_ok = true;
                this.InvokeEx(f => this.Cursor = Cursors.Arrow);

                if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length > 0)
                {
                    foreach (String file in Directory.GetFiles(destino_test))
                    {
                        try
                        {
                            File.Delete(file);
                        }
                        catch
                        {
                        }
                    }
                }

                if (Directory.GetFiles(destino_test).Length == 0)
                {
                    System.IO.Directory.Delete(destino_test);
                }
                //tried_params.Add(multi_pr1);
                LB1_o.Items.Clear();
                return;
            }

            if (bad_chars == false)
            {
                if (consola_pre.ExitCode != 0)
                {
                    if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length > 0)
                    {
                        foreach (String file in Directory.GetFiles(destino_test))
                        {
                            try
                            {
                                File.Delete(file);
                            }
                            catch
                            {
                            }
                        }
                    }

                    if (Directory.GetFiles(destino_test).Length == 0)
                    {
                        System.IO.Directory.Delete(destino_test);
                    }

                    this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                    foreach (String lin in LB1_o.Items)
                    {
                        if (lin.Contains("not load the requested plugin") || lin.Contains("Cannot load nvcuda.dll"))
                        {
                            unsupported = true;
                        }
                    }
                    if (unsupported == true) MessageBox.Show(FFBatch.Properties.Strings.test_fail1 + " " + "1:" + " " + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.unsup_enc + Environment.NewLine + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 1].ToString() + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.try_pr, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    else MessageBox.Show(FFBatch.Properties.Strings.test_fail1 + " " + "1:" + " " + Environment.NewLine + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 1].ToString() + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.try_pr, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);

                    tried_ok = false;
                    return;
                }
                else
                {
                    System.Threading.Thread.Sleep(50);
                    if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length > 0)
                    {
                        foreach (String file in Directory.GetFiles(destino_test))
                        {
                            try
                            {
                                File.Delete(file);
                            }
                            catch
                            {
                            }
                        }
                    }

                    if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length == 0)
                    {
                        System.IO.Directory.Delete(destino_test);
                    }
                    //tried_params.Add(multi_pr1);
                    tried_ok = true;
                }
            }
            //END try preset

            LB1_o.Items.Clear();
            consola_pre.Dispose();
        }

        private void BG_Try_multi_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            String file_prueba = "";
            String sel_test = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
            file_prueba = sel_test;
            String destino = Path.Combine(Path.GetTempPath(), "\\" + "FFBatch_test");
            String borrar = destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + txt_format.Text;

            if (File.Exists(borrar))
            {
                try
                {
                    File.Delete(borrar);
                }
                catch
                {
                }
            }

            if (Directory.Exists(destino) == true)
            {
                if (Directory.GetFiles(destino).Length == 0)
                {
                    try
                    {
                        System.IO.Directory.Delete(destino);
                    }
                    catch { }
                }
            }
            if (tried_ok == true) bg_try_multi_2.RunWorkerAsync();
            else this.InvokeEx(f => this.Cursor = Cursors.Arrow);
        }

        private void bg_try_multi_2_DoWork(object sender, DoWorkEventArgs e)
        {
            tried_ok = false;
            this.InvokeEx(f => this.Cursor = Cursors.WaitCursor);
            ListBox LB1_o = new ListBox();
            Process consola_pre = new Process();
            String file_prueba = "";
            String sel_test = "";
            this.InvokeEx(f => sel_test = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text);
            file_prueba = sel_test;
            String destino_test = Path.Combine(Path.GetTempPath(), "\\" + "FFBatch_test");
            Boolean bad_chars = false;
            Boolean unsupported = false;

            Task tt = Task.Run(() =>
            {
                String fichero = Path.GetFileName(file_prueba);

                if (!Directory.Exists(destino_test))
                {
                    try
                    {
                        Directory.CreateDirectory(destino_test);
                    }
                    catch (System.Exception excpt)
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                        return;
                    }
                }

                String ext_output = "." + multi_pr2_ext;

                textbox_params = multi_pr2;
                String file_prueba2 = file_prueba;

                if (textbox_params.Contains("%fn"))
                {
                    textbox_params = textbox_params.Replace("%fn", Path.GetFileNameWithoutExtension(file_prueba));
                }
                if (textbox_params.Contains("%fp"))
                {
                    textbox_params = textbox_params.Replace("%fp", Path.GetDirectoryName(file_prueba));
                }
                if (textbox_params.Contains("%fd"))
                {
                    var path2 = Path.GetFullPath(file_prueba);
                    var dirName = Path.GetFileName(Path.GetDirectoryName(path2));
                    textbox_params = textbox_params.Replace("%fd", dirName);
                }

                if (textbox_params.Contains("%1"))
                {
                    if (file_prueba2.Contains("[") || file_prueba2.Contains("]"))
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.conflict_char, FFBatch.Properties.Strings.conflict_char2, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                        Enable_Controls();
                        this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                        tried_ok = false;
                        bad_chars = true;
                        return;
                    }
                    file_prueba2 = file_prueba2.Replace("\\", "\\\\\\\\");
                    file_prueba2 = file_prueba2.Replace(":", ":" + "\\\\");
                    textbox_params = textbox_params.Replace("%1", file_prueba2);
                }

                String pre_i = "";
                txt_pre_input.Invoke(new MethodInvoker(delegate
                {
                    pre_i = txt_pre_input.Text;
                }));

                consola_pre.StartInfo.FileName = "ffmpeg.exe";
                consola_pre.StartInfo.Arguments = pre_i + " " + hw_decode_glob + " -i " + "" + '\u0022' + file_prueba + '\u0022' + "" + " -y " + textbox_params + " " + '\u0022' + destino_test + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + ext_output + '\u0022';
                consola_pre.StartInfo.RedirectStandardOutput = true;
                consola_pre.StartInfo.RedirectStandardError = true;
                consola_pre.StartInfo.UseShellExecute = false;
                consola_pre.StartInfo.CreateNoWindow = true;
                consola_pre.EnableRaisingEvents = true;
                consola_pre.Start();

                while (!consola_pre.StandardError.EndOfStream)
                {
                    this.InvokeEx(f => LB1_o.Items.Add(consola_pre.StandardError.ReadLine()));
                    this.InvokeEx(f => LB1_o.TopIndex = LB1_o.Items.Count - 1);
                    this.InvokeEx(f => LB1_o.Refresh());
                }

                consola_pre.WaitForExit();
                consola_pre.StartInfo.Arguments = String.Empty;
            });

            if (!tt.Wait(675) && consola_pre.StartInfo.Arguments != String.Empty)
            {
                consola_pre.Kill();
                tried_ok = true;

                if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length > 0)
                {
                    foreach (String file in Directory.GetFiles(destino_test))
                    {
                        try
                        {
                            File.Delete(file);
                        }
                        catch
                        {
                        }
                    }
                }

                if (Directory.GetFiles(destino_test).Length == 0)
                {
                    System.IO.Directory.Delete(destino_test);
                }

                tried_params.Add(multi_pr2);
                LB1_o.Items.Clear();
                return;
            }

            if (bad_chars == false)
            {
                if (consola_pre.ExitCode != 0)
                {
                    if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length > 0)
                    {
                        foreach (String file in Directory.GetFiles(destino_test))
                        {
                            try
                            {
                                File.Delete(file);
                            }
                            catch
                            {
                            }
                        }
                    }

                    if (Directory.GetFiles(destino_test).Length == 0)
                    {
                        System.IO.Directory.Delete(destino_test);
                    }

                    foreach (String lin in LB1_o.Items)
                    {
                        if (lin.Contains("not load the requested plugin") || lin.Contains("Cannot load nvcuda.dll"))
                        {
                            unsupported = true;
                        }
                    }
                    if (unsupported == true) MessageBox.Show(FFBatch.Properties.Strings.test_fail1 + " " + "2:" + " " + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.unsup_enc + Environment.NewLine + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 1].ToString() + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.try_pr, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    else MessageBox.Show(FFBatch.Properties.Strings.test_fail1 + " " + "2:" + " " + Environment.NewLine + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 1].ToString() + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.try_pr, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);

                    this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                    tried_ok = false;
                    return;
                }
                else
                {
                    System.Threading.Thread.Sleep(50);
                    if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length > 0)
                    {
                        foreach (String file in Directory.GetFiles(destino_test))
                        {
                            try
                            {
                                File.Delete(file);
                            }
                            catch
                            {
                            }
                        }
                    }

                    if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length == 0)
                    {
                        System.IO.Directory.Delete(destino_test);
                    }
                    tried_params.Add(multi_pr2);
                    tried_ok = true;
                }
            }
            //END try preset

            if (Directory.Exists(destino_test))
            {
                if (Directory.GetFiles(destino_test).Length == 0)
                {
                    System.IO.Directory.Delete(destino_test);
                }
            }
            LB1_o.Items.Clear();
            consola_pre.Dispose();
        }

        private void bg_try_multi_2_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            this.Cursor = Cursors.Arrow;
            String file_prueba = "";
            String sel_test = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
            file_prueba = sel_test;
            String destino = Path.GetTempPath() + "\\" + "FFBatch_test";
            String borrar = destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + txt_format.Text;

            if (File.Exists(borrar))
            {
                try
                {
                    File.Delete(borrar);
                }
                catch
                {
                }
            }

            if (Directory.Exists(destino) == true)
            {
                if (Directory.GetFiles(destino).Length == 0)
                {
                    System.IO.Directory.Delete(destino);
                }
            }
            if (tried_ok == true && n_multi_presets == 3) bg_multi_3.RunWorkerAsync();
            if (tried_ok == true && n_multi_presets == 2)
            {
                this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                start_multiple();
            }
            else this.InvokeEx(f => this.Cursor = Cursors.Arrow);
        }

        private void bg_multi_3_DoWork(object sender, DoWorkEventArgs e)
        {
            tried_ok = false;
            this.InvokeEx(f => this.Cursor = Cursors.WaitCursor);
            ListBox LB1_o = new ListBox();
            Process consola_pre = new Process();
            String file_prueba = "";
            String sel_test = "";
            this.InvokeEx(f => sel_test = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text);
            file_prueba = sel_test;
            String destino_test = Path.Combine(Path.GetTempPath(), "\\" + "FFBatch_test");
            Boolean bad_chars = false;
            Boolean unsupported = false;

            Task tt = Task.Run(() =>
            {
                String fichero = Path.GetFileName(file_prueba);

                if (!Directory.Exists(destino_test))
                {
                    try
                    {
                        Directory.CreateDirectory(destino_test);
                    }
                    catch (System.Exception excpt)
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                        return;
                    }
                }

                String ext_output = "." + multi_pr3_ext;

                textbox_params = multi_pr3;
                String file_prueba2 = file_prueba;

                if (textbox_params.Contains("%fn"))
                {
                    textbox_params = textbox_params.Replace("%fn", Path.GetFileNameWithoutExtension(file_prueba));
                }
                if (textbox_params.Contains("%fp"))
                {
                    textbox_params = textbox_params.Replace("%fp", Path.GetDirectoryName(file_prueba));
                }
                if (textbox_params.Contains("%fd"))
                {
                    var path = Path.GetFullPath(file_prueba);
                    var dirName = Path.GetFileName(Path.GetDirectoryName(path));
                    textbox_params = textbox_params.Replace("%fd", dirName);
                }

                if (textbox_params.Contains("%1"))
                {
                    if (file_prueba2.Contains("[") || file_prueba2.Contains("]"))
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.conflict_char, FFBatch.Properties.Strings.conflict_char2, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                        Enable_Controls();
                        this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                        tried_ok = false;
                        bad_chars = true;
                        return;
                    }
                    file_prueba2 = file_prueba2.Replace("\\", "\\\\\\\\");
                    file_prueba2 = file_prueba2.Replace(":", ":" + "\\\\");
                    textbox_params = textbox_params.Replace("%1", file_prueba2);
                }

                consola_pre.StartInfo.FileName = "ffmpeg.exe";
                consola_pre.StartInfo.Arguments = hw_decode_glob + " -i " + "" + '\u0022' + file_prueba + '\u0022' + "" + " -y " + textbox_params + " " + '\u0022' + destino_test + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + ext_output + '\u0022';
                consola_pre.StartInfo.RedirectStandardOutput = true;
                consola_pre.StartInfo.RedirectStandardError = true;
                consola_pre.StartInfo.UseShellExecute = false;
                consola_pre.StartInfo.CreateNoWindow = true;
                consola_pre.EnableRaisingEvents = true;
                consola_pre.Start();

                while (!consola_pre.StandardError.EndOfStream)
                {
                    this.InvokeEx(f => LB1_o.Items.Add(consola_pre.StandardError.ReadLine()));
                    this.InvokeEx(f => LB1_o.TopIndex = LB1_o.Items.Count - 1);
                    this.InvokeEx(f => LB1_o.Refresh());
                }

                consola_pre.WaitForExit();
                consola_pre.StartInfo.Arguments = String.Empty;
            });

            if (!tt.Wait(675) && consola_pre.StartInfo.Arguments != String.Empty)
            {
                consola_pre.Kill();
                tried_ok = true;
                this.InvokeEx(f => this.Cursor = Cursors.Arrow);

                if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length > 0)
                {
                    foreach (String file in Directory.GetFiles(destino_test))
                    {
                        try
                        {
                            File.Delete(file);
                        }
                        catch
                        {
                        }
                    }
                }

                if (Directory.GetFiles(destino_test).Length == 0)
                {
                    System.IO.Directory.Delete(destino_test);
                }

                LB1_o.Items.Clear();
                return;
            }

            if (bad_chars == false)
            {
                if (consola_pre.ExitCode != 0)
                {
                    if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length > 0)
                    {
                        foreach (String file in Directory.GetFiles(destino_test))
                        {
                            try
                            {
                                File.Delete(file);
                            }
                            catch
                            {
                            }
                        }
                    }

                    if (Directory.GetFiles(destino_test).Length == 0)
                    {
                        System.IO.Directory.Delete(destino_test);
                    }

                    this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                    foreach (String lin in LB1_o.Items)
                    {
                        if (lin.Contains("not load the requested plugin") || lin.Contains("Cannot load nvcuda.dll"))
                        {
                            unsupported = true;
                        }
                    }
                    if (unsupported == true) MessageBox.Show(FFBatch.Properties.Strings.test_fail1 + " " + "3:" + " " + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.unsup_enc + Environment.NewLine + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 1].ToString() + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.try_pr, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    else MessageBox.Show(FFBatch.Properties.Strings.test_fail1 + " " + "3:" + " " + Environment.NewLine + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 1].ToString() + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.try_pr, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);

                    tried_ok = false;
                    return;
                }
                else
                {
                    System.Threading.Thread.Sleep(50);
                    if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length > 0)
                    {
                        foreach (String file in Directory.GetFiles(destino_test))
                        {
                            try
                            {
                                File.Delete(file);
                            }
                            catch
                            {
                            }
                        }
                    }

                    if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length == 0)
                    {
                        System.IO.Directory.Delete(destino_test);
                    }

                    tried_ok = true;
                }
            }
            //END try preset

            if (Directory.Exists(destino_test))
            {
                if (Directory.GetFiles(destino_test).Length == 0)
                {
                    System.IO.Directory.Delete(destino_test);
                }
            }
            LB1_o.Items.Clear();
            consola_pre.Dispose();
        }

        private void bg_multi_3_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            String file_prueba = "";
            String sel_test = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
            file_prueba = sel_test;
            String destino = Path.Combine(Path.GetTempPath(), "\\" + "FFBatch_test");
            String borrar = destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + txt_format.Text;

            if (File.Exists(borrar))
            {
                try
                {
                    File.Delete(borrar);
                }
                catch
                {
                }
            }

            if (Directory.Exists(destino) == true)
            {
                if (Directory.GetFiles(destino).Length == 0)
                {
                    System.IO.Directory.Delete(destino);
                }
            }
            if (tried_ok == true) start_multiple();
            else this.InvokeEx(f => this.Cursor = Cursors.Arrow);
        }

        private void BG_Concat_one_DoWork(object sender, DoWorkEventArgs e)
        {
            Disable_Controls();
            this.InvokeEx(f => txt_remain.Text = FFBatch.Properties.Strings.remaint + " " + " 00:00:00");
            time_n_tasks = 0;
            timer_tasks.Start();
            cancel_queue = false;
            this.InvokeEx(f => Pg1.Value = 0);
            //pg_current.Value = 0;
            this.InvokeEx(f => Pg1.Text = "0%");
            notifyIcon1.Visible = true;

            working = true;

            String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");

            Pg1.Value = 0;
            String params1 = txt_parameters.Text;

            int i = 0;
            ListView list_proc = new ListView();

            Double total_duration = 0;
            int i_dur = 0;

            //Get total duration of files
            List<Double> durs = new List<Double>();
            String duracion_intro = String.Empty;
            String duracion_salida = String.Empty;

            listView1.Invoke(new MethodInvoker(delegate
            {
                foreach (ListViewItem item in listView1.Items)
                {
                    list_proc.Items.Add(item.Text);
                    list_proc.Items[item.Index].SubItems.Add(item.SubItems[1].Text);
                }
                listView1.SelectedIndices.Clear();
            }));

            listView1.Invoke(new MethodInvoker(delegate
            {
                foreach (ListViewItem item in listView1.Items)
                {
                    if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                    {
                        total_duration = total_duration + TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds;
                        durs.Add(TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds);
                        if (concat_intro != String.Empty)
                        {
                            total_duration = total_duration + TimeSpan.Parse(concat_intro_dur).TotalSeconds;
                        }

                        if (concat_end != String.Empty)
                        {
                            total_duration = total_duration + TimeSpan.Parse(concat_end_dur).TotalSeconds;
                        }
                    }
                }
            }));

            Double total_prog = 0;

            //End get total duration of files

            Pg1.Maximum = 100;
            aborted = false;

            //End total duration

            List<string> list_lines = new List<string>();
            process_glob.StartInfo.Arguments = String.Empty;

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;

                String remain_time = "";
                String path = String.Empty;
                String inputs = String.Empty;
                int list_index = 0;
                int percent_elapsed = 0;
                Double item_duration = 0;
                int errors = 0;

                foreach (ListViewItem file in list_proc.Items)
                {
                    String file1 = file.SubItems[1].Text + "\\" + file.Text;
                    inputs = "";
                    String destino = "";
                    String fullPath = file1;
                    if (txt_path_main.Text.Contains(".\\"))
                    {
                        if (txt_path_main.Text != ".\\")
                            destino = file1.Substring(0, fullPath.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
                        else
                        {
                            destino = Path.GetDirectoryName(file1);
                        }
                    }
                    else
                    {
                        if (checkBox1.CheckState == CheckState.Checked)
                        {
                            String pre_dest = Path.GetDirectoryName(file1);
                            destino = Path.Combine(txt_path_main.Text, pre_dest.Substring(3, pre_dest.Length - 3));
                        }
                        else
                        {
                            destino = txt_path_main.Text;
                        }
                    }

                    String concat_name = Path.GetFileNameWithoutExtension(file1);

                    //Aborted requested
                    if (cancel_queue == true)
                    {
                        working = false;
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        this.InvokeEx(f => f.Pg1.Value = 0);
                        //this.InvokeEx(f => f.pg_current.Value = 0);
                        Enable_Controls();
                        MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.task_abort, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                        return;
                    }
                    int concat_number = 1;
                    var lista_concat = new String[3];
                    String path_conc = System.IO.Path.Combine(Path.GetTempPath(), "concat.txt");

                    if (check_concat.Checked == true)
                    {
                        if (concat_intro.Length > 0)
                        {
                            inputs = inputs + " -i " + '\u0022' + concat_intro + '\u0022';
                            concat_number = concat_number + 1;
                        }

                        inputs = inputs + " -i " + '\u0022' + file1 + '\u0022';

                        if (concat_end.Length > 0)
                        {
                            inputs = inputs + " -i " + '\u0022' + concat_end + '\u0022';
                            concat_number = concat_number + 1;
                        }
                    }
                    if (check_concat.Checked == false)
                    {
                        if (concat_intro.Length > 0)
                        {
                            if (concat_intro.Contains(" "))
                            {
                                lista_concat[0] = "file " + "'" + concat_intro + "'";
                            }
                            else
                            {
                                lista_concat[0] = "file " + "'" + concat_intro.Replace("\\", "\\\\") + "'";
                            }
                        }
                        else lista_concat[0] = String.Empty;

                        if (file1.Contains(" "))
                        {
                            lista_concat[1] = "file " + "'" + file1 + "'";
                        }
                        else
                        {
                            lista_concat[1] = "file " + "'" + file1.Replace("\\", "\\\\") + "'";
                        }

                        if (concat_end.Length > 0)
                        {
                            if (concat_end.Contains(" "))
                            {
                                lista_concat[2] = "file " + "'" + concat_end + "'";
                            }
                            else
                            {
                                lista_concat[2] = "file " + "'" + concat_end.Replace("\\", "\\\\") + "'";
                            }
                        }
                        else lista_concat[2] = String.Empty;

                        try
                        {
                            File.WriteAllLines(path_conc, lista_concat);
                        }
                        catch (Exception exc)
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.err_concat + Environment.NewLine + Environment.NewLine + exc.Message + Environment.NewLine + Environment.NewLine + path);
                            working = false;
                            Enable_Controls();
                            return;
                        }
                    }
                    //Change Volume
                    String change_vol = "";
                    if (chk_vol.Checked == true)
                    {
                        change_vol = "-filter:a " + '\u0022' + "volume=" + vol_ch.Value.ToString() + "dB " + '\u0022' + " ";
                    }
                    //End change volume
                    if (!Directory.Exists(destino))
                    {
                        try
                        {
                            Directory.CreateDirectory(destino);
                        }
                        catch
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.dest_err, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            Enable_Controls();
                            working = false;
                            return;
                        }
                    }
                    String AppParam = String.Empty;

                    if (check_concat.Checked == true) AppParam = inputs + " -filter_complex " + '\u0022' + "concat=n=" + concat_number.ToString() + ":v=1:a=1[outv][outa]" + '\u0022' + " -map " + '\u0022' + "[outv]" + '\u0022' + " -map " + '\u0022' + "[outa]" + '\u0022' + " " + params1 + " -y " + '\u0022' + destino + "\\" + concat_name + "_joined" + "." + txt_format.Text + '\u0022';
                    if (check_concat.Checked == false) AppParam = " -f concat -safe 0 -i " + '\u0022' + path_conc + '\u0022' + " " + txt_parameters.Text + " " + " -y " + change_vol + '\u0022' + destino + "\\" + concat_name + "_joined" + "." + txt_format.Text + '\u0022';

                    //Thread thread = new Thread(() => Clipboard.SetText(ffm + " " + AppParam));
                    //thread.SetApartmentState(ApartmentState.STA); //Set the thread to STA
                    //thread.Start();
                    //thread.Join(); //Wait for the thread to end
                    process_glob.StartInfo.FileName = ffm;
                    process_glob.StartInfo.Arguments = AppParam;
                    process_glob.StartInfo.RedirectStandardOutput = true;
                    process_glob.StartInfo.RedirectStandardError = true;
                    process_glob.StartInfo.RedirectStandardInput = true;
                    process_glob.StartInfo.UseShellExecute = false;
                    process_glob.StartInfo.CreateNoWindow = true;
                    process_glob.EnableRaisingEvents = true;

                    valid_prog = false;

                    process_glob.Start();
                    System.Threading.Thread.Sleep(50);
                    combo_prio.Invoke(new MethodInvoker(delegate
                    {
                        if (combo_prio.SelectedIndex != 2)
                        {
                            Change_mem_prio();
                        }
                    }));

                    String err_txt = "";
                    Double sec_prog = 0;
                    Double interval = 0;
                    Decimal est_bitrate = 0;
                    Decimal est_size = 0;
                    lbl_bitrate.Text = "";
                    lbl_est_size.Text = "";

                    while (!process_glob.StandardError.EndOfStream)
                    {
                        err_txt = process_glob.StandardError.ReadLine();
                        list_lines.Add(err_txt);

                        if (err_txt.Contains("time=") && err_txt.Contains("time=-") == false)
                        {
                            this.InvokeEx(f => durat_n = TimeSpan.Parse(listView1.Items[list_index].SubItems[3].Text).TotalSeconds + TimeSpan.Parse(concat_intro_dur).TotalSeconds + TimeSpan.Parse(concat_end_dur).TotalSeconds);
                            int start_time_index = err_txt.IndexOf("time=") + 5;
                            sec_prog = TimeSpan.Parse(err_txt.Substring(start_time_index, 8)).TotalSeconds;

                            Double percent = (sec_prog * 100 / durat_n);

                            total_prog = total_prog + (sec_prog - interval);
                            interval = sec_prog;
                            int percent2 = Convert.ToInt32(percent);

                            Double percent_tot = (total_prog * 100 / total_duration);
                            int percent_tot_2 = Convert.ToInt32(percent_tot);

                            if (percent_tot_2 <= 100)
                            {
                                this.InvokeEx(f => f.Pg1.Value = percent_tot_2);
                                this.InvokeEx(f => f.Pg1.Refresh());

                                if (Math.Round(percent_tot, 1).ToString().Contains(".") || Math.Round(percent_tot, 1).ToString().Contains(","))
                                {
                                    this.InvokeEx(f => f.Pg1.Text = Math.Round(percent_tot, 1).ToString() + "%");
                                }
                                else
                                {
                                    this.InvokeEx(f => f.Pg1.Text = Math.Round(percent_tot, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0" + "%");
                                }

                                this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, percent_tot, Pg1.Maximum));
                            }

                            if (percent2 <= 100)
                            {
                                if (Math.Round(percent, 1).ToString().Contains(".") || Math.Round(percent, 1).ToString().Contains(","))
                                {
                                    this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = Math.Round(percent, 1).ToString() + "%");
                                }
                                else
                                {
                                    this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = Math.Round(percent, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0" + "%");
                                }
                            }
                            //Estimated remaining time
                            try
                            {
                                remain_time = err_txt.Substring(err_txt.LastIndexOf("speed=") + 6, err_txt.Length - err_txt.LastIndexOf("speed=") - 6);
                                remain_time = remain_time.Replace("x", String.Empty);

                                Double timing1 = 0;

                                if (System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator == ",")
                                {
                                    timing1 = Math.Round(Double.Parse(remain_time.Replace(".", ",")), 2);
                                }
                                else
                                {
                                    timing1 = Math.Round(Double.Parse(remain_time), 2);
                                }
                                Decimal timing = (decimal)timing1;
                                Decimal total_dur_dec = Convert.ToDecimal(total_duration);
                                Decimal total_prog_dec = Convert.ToDecimal(sec_prog);
                                Decimal remain_secs = 0;
                                if (timing > 0)
                                {
                                    remain_secs = (decimal)(total_dur_dec - total_prog_dec) / timing;
                                }

                                if (remain_secs > 60)
                                {
                                    remain_secs = remain_secs + 60;
                                }
                                String remain_from_secs = "";

                                TimeSpan t = TimeSpan.FromSeconds(Convert.ToDouble(remain_secs));
                                remain_from_secs = string.Format("{0:D2}h:{1:D2}",
                                   t.Hours,
                                  t.Minutes);

                                if (remain_secs >= 3600)
                                {
                                    this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remaint + " " + remain_from_secs + " " + FFBatch.Properties.Strings.minutes_abrev);
                                }

                                if (remain_secs < 3600 && remain_secs >= 600)
                                {
                                    this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remaint + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes);
                                }
                                if (remain_secs < 600 && remain_secs >= 120)
                                {
                                    this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remaint + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes);
                                }

                                if (remain_secs <= 59)
                                {
                                    this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remaint + " " + Convert.ToInt16(remain_secs) + " second(s)");
                                }
                                this.InvokeEx(f => f.txt_remain.Refresh());

                                //End remaining time
                            }
                            catch { }
                            //Estimated size and bitrate

                            String read_size = String.Empty;
                            if (err_txt.Contains("size=") && (time_est_size % 3 == 0))
                            {
                                int size_index = err_txt.IndexOf("size=") + 5;
                                read_size = err_txt.Substring(size_index, 8);
                                if (Convert.ToDecimal(sec_prog) != 0)
                                {
                                    est_bitrate = (Math.Round(Convert.ToDecimal(read_size) * 8 / Convert.ToDecimal(sec_prog), 0));
                                }
                                else
                                {
                                    est_bitrate = 0;
                                }

                                if (Convert.ToDecimal(read_size) > 1 && time_n_tasks > 1)
                                {
                                    if (est_bitrate < 9999)
                                    {
                                        if (est_bitrate > 48)
                                        {
                                            this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " " + est_bitrate + " " + "Kb/s");
                                        }
                                        else
                                        {
                                            this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " ");
                                        }
                                    }
                                    else
                                    {
                                        this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " " + (Math.Round(est_bitrate / 1000, 0)) + " " + "Mb/s");
                                    }
                                    //Estimated size
                                    est_size = Convert.ToDecimal(durat_n) * est_bitrate / 8;

                                    if (est_size > 1000000)
                                    {
                                        this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " " + (Math.Round(est_size / 1000000, 1)).ToString() + " " + "GB");
                                    }
                                    else
                                    {
                                        if (Math.Round(est_size / 1000, 0) > 0)
                                        {
                                            this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " " + (Math.Round(est_size / 1000, 0)).ToString() + " " + "MB");
                                        }
                                        else
                                        {
                                            this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " ");
                                        }
                                    }
                                }
                                if (time_est_size % 3 == 0) this.InvokeEx(f => f.lbl_speed.Text = remain_time.Trim() + "x");
                                this.InvokeEx(f => f.lbl_est_size.Refresh());
                            }
                        }
                    }
                    //While encoding
                    process_glob.WaitForExit();
                    process_glob.StartInfo.Arguments = String.Empty;
                    this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                    list_lines.Add("");

                    if (process_glob.ExitCode == 0)
                    {
                        this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.success);
                    }
                    else
                    {
                        errors = errors + 1;
                        this.InvokeEx(f => f.listView1.Items[list_index].SubItems[5].Text = FFBatch.Properties.Strings.error);
                    }
                    this.InvokeEx(f => f.lbl_bitrate.Text = "");
                    this.InvokeEx(f => f.lbl_est_size.Text = "");
                    this.InvokeEx(f => f.lbl_speed.Text = "");
                    list_index++;

                    if (list_index == list_proc.Items.Count)
                    {
                        working = false;
                        Enable_Controls();
                        this.InvokeEx(f => f.Pg1.Value = Pg1.Maximum);
                        this.InvokeEx(f => f.Pg1.Text = "100" + "%");

                        notifyIcon1.BalloonTipIcon = ToolTipIcon.Info;

                        if (Form.ActiveForm == null)
                        {
                            if (errors == 0)
                            {
                                notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.concat_compl;
                                notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.conc_comp;
                                notifyIcon1.ShowBalloonTip(0);
                            }
                            else
                            {
                                notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.concat_err;
                                notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.conc_comp;

                                notifyIcon1.ShowBalloonTip(1);
                            }
                        }
                        else
                        {
                            if (errors > 0 && aborted == false)
                            {
                                MessageBox.Show(FFBatch.Properties.Strings.there_w + " " + errors.ToString() + " " + Properties.Strings.errors1 + " " + Properties.Strings.check_log, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            }
                        }

                        if (chk_open_compl.Checked && aborted == false)
                        {
                            try
                            {
                                if (Directory.GetFiles(destino).Length != 0)
                                {
                                    Process open_processed = new Process();
                                    open_processed.StartInfo.FileName = "explorer.exe";
                                    open_processed.StartInfo.Arguments = '\u0022' + destino + '\u0022';
                                    open_processed.Start();
                                }
                                else
                                {
                                    if (Directory.Exists(destino))
                                    {
                                        System.IO.Directory.Delete(destino);
                                    }
                                }
                            }
                            catch { }
                        }

                        working = false;
                        Enable_Controls();
                        try
                        {
                            if (Directory.GetFiles(destino).Length == 0)
                            {
                                if (Directory.Exists(destino))
                                {
                                    System.IO.Directory.Delete(destino);
                                }
                            }
                        }
                        catch { }

                        if (aborted == true)
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.concat_abort, FFBatch.Properties.Strings.cancelled, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        }

                        //Save log
                        string[] array_err = list_lines.ToArray();
                        String path_l = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                        if (is_portable == true) path_l = port_path + "ff_batch_portable.log";

                        if (no_save_logs == false)
                        {
                            System.IO.StreamWriter SaveFile = new System.IO.StreamWriter(path_l);
                            SaveFile.WriteLine("FFmpeg log session: " + System.DateTime.Now);
                            SaveFile.WriteLine("-------------------------------");
                            foreach (String item in array_err)
                            {
                                SaveFile.WriteLine(item);
                            }
                            SaveFile.Close();

                            File.AppendAllText(path_l, "-----------------------");
                            File.AppendAllText(path_l, Environment.NewLine + FFBatch.Properties.Strings.end_log + Environment.NewLine);
                            System.IO.FileInfo fileInfo = new System.IO.FileInfo(path_l);

                            var bytes = fileInfo.Length;

                            var kilobytes = (double)bytes / 1024;
                            var megabytes = kilobytes / 1024;
                            var gigabytes = megabytes / 1024;

                            //Format size view
                            String size = "";
                            String separator = ".";

                            if (bytes > 1000000000)
                            {
                                if (gigabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String gigas = gigabytes.ToString();
                                if (gigas.Length >= 5)
                                {
                                    gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                                    size = (gigas + " " + "GB");
                                }
                                else
                                {
                                    size = (gigas + " " + "GB");
                                }
                            }

                            if (bytes >= 1048576 && bytes <= 1000000000)
                            {
                                if (megabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }
                                String megas = megabytes.ToString();
                                if (megas.Length > 5)
                                {
                                    megas = megas.Substring(0, megas.LastIndexOf(separator));
                                    size = (megas + " " + "MB");
                                }
                                else
                                {
                                    size = (megas + " " + "MB");
                                }
                            }

                            if (bytes >= 1024 && bytes < 1048576)

                            {
                                if (kilobytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String kbs = kilobytes.ToString();
                                if (kbs.Length >= 5)
                                {
                                    kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                                    size = (kbs + " " + "KB");
                                }
                                else
                                {
                                    size = (kbs + " " + "KB");
                                }
                            }
                            if (bytes > -1 && bytes < 1024)
                            {
                                String bits = bytes.ToString();
                                size = (bits + " Bytes");
                            }

                            //End Format size view
                            File.AppendAllText(path_l, Environment.NewLine + FFBatch.Properties.Strings.log_size + " " + size);

                            //End save log
                        }

                        if (File.Exists(System.IO.Path.Combine(Application.StartupPath, "concat.txt")))
                        {
                            File.Delete(System.IO.Path.Combine(Application.StartupPath, "concat.txt"));
                        }

                        Enable_Controls();
                        this.InvokeEx(f => f.btn_load_config.PerformClick());
                    }
                }
            }).Start();
        }

        private void btn_concat_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            if (!File.Exists(Path.Combine(Application.StartupPath, "ffmpeg.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_ffmpeg, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            was_started.Text = btn_concat.Text;
            foreach (ListViewItem file in listView1.Items)
            {
                if (!File.Exists(file.SubItems[1].Text + "\\" + file.Text))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file_not_found + " " + file.Text, FFBatch.Properties.Strings.file_not_found2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }

            if (listView1.Items.Count < 1)
            {
                MessageBox.Show(FFBatch.Properties.Strings.list_empty, FFBatch.Properties.Strings.add_files, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (txt_parameters.Text == "" && check_concat.CheckState == CheckState.Unchecked)
            {
                MessageBox.Show(FFBatch.Properties.Strings.params_bl, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (txt_format.Text == "")
            {
                MessageBox.Show(FFBatch.Properties.Strings.format_bl, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (chk_shift.Checked == true)
            {
                MessageBox.Show(FFBatch.Properties.Strings.shift_n, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (chkshut.Checked)
            {
                TB1.Visible = true;
                TB1.Text = FFBatch.Properties.Strings.autosh;
            }

            //Pending duration

            if (dur_ok == false)
            {
                list_pending_dur.Items.Clear();
                foreach (ListViewItem item in listView1.Items)
                {
                    list_pending_dur.Items.Add((ListViewItem)item.Clone());
                }
                BG_Dur.RunWorkerAsync();
                return;
            }
            String img = "";
            try
            {
                img = listView1.Items[0].Text.Substring(listView1.Items[0].Text.LastIndexOf(".") + 1, 3);
            }
            catch
            {
                img = listView1.Items[0].Text.Substring(listView1.Items[0].Text.LastIndexOf(".") + 1, 2);
            }
            String img_aud = String.Empty;
            if (img == "jpg" || img == "jpeg" || img == "png" || img == "gif")
            {
                if (images_from_wiz == false)
                {
                    DialogResult a = MessageBox.Show(FFBatch.Properties.Strings.images_conc, FFBatch.Properties.Strings.images_c2, MessageBoxButtons.YesNoCancel, MessageBoxIcon.Question);
                    if (a == DialogResult.Yes) images_v = true;
                    if (a == DialogResult.No) return;
                    if (a == DialogResult.Cancel) return;
                }
            }
            if (images_v == true && images_from_wiz == false)
            {
                Form18 frm18 = new Form18();
                frm18.ShowDialog();
                if (frm18.canceled == false)
                {
                    images_time = frm18.numericUpDown1.Value.ToString();
                    if (frm18.txt_audio_path.Enabled == true) img_aud = frm18.txt_audio_path.Text;
                }
                else images_v = false;
            }

            if (images_from_wiz == false)
            {
                String dialog_param = txt_parameters.Text;
                Form22 frm22 = new Form22();
                if (images_v == false)
                {
                    frm22.tx_params = txt_parameters.Text;
                    if (listView1.Items.Count > 0)
                    {
                        frm22.txt_c_format.Text = Path.GetExtension(listView1.Items[0].Text).Replace(".", "");
                        frm22.tx_params_ext = frm22.txt_c_format.Text;
                        frm22.tx_params_ext_or = txt_format.Text;
                    }

                    if (concat_intro.Length > 0)
                    {
                        frm22.txt_intro.Text = concat_intro;
                        frm22.intro_dur = concat_intro_dur;
                    }

                    if (concat_end.Length > 0)
                    {
                        frm22.txt_end.Text = concat_end;
                        frm22.end_dur = concat_end_dur;
                    }
                    if (batch_concat == true) frm22.chk_batch_concat.Checked = true;
                    else frm22.chk_batch_concat.Checked = false;

                    frm22.ShowDialog();
                    if (frm22.cancel == true) return;
                    dialog_param = frm22.txt_params.Text;
                    if (frm22.radio_demuxer.Checked) check_concat.Checked = false;
                    if (frm22.radio_filter.Checked) check_concat.Checked = true;
                    txt_parameters.Text = frm22.txt_params.Text;
                    txt_format.Text = frm22.txt_c_format.Text;

                    if (frm22.chk_batch_concat.Checked == true)
                    {
                        batch_concat = true;
                        concat_intro = frm22.txt_intro.Text;
                        concat_intro_dur = frm22.intro_dur;
                        concat_end = frm22.txt_end.Text;
                        concat_end_dur = frm22.end_dur;
                        BG_Concat_one.RunWorkerAsync();
                        return;
                    }
                }
            }

            if (images_from_wiz == true) images_v = true;

            batch_concat = false;
            if (listView1.Items.Count < 2)
            {
                MessageBox.Show(FFBatch.Properties.Strings.two_files, FFBatch.Properties.Strings.add_files, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            //Check path is writable
            String destino1 = String.Empty;
            Boolean rel_path = false;
            String element = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text;
            if (txt_path_main.Text.Contains(".\\"))
            {
                destino1 = element.Substring(0, element.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
                rel_path = true;
            }
            else
            {
                if (checkBox1.CheckState == CheckState.Checked)
                {
                    String pre_dest = Path.GetDirectoryName(element);
                    destino1 = Path.Combine(txt_path_main.Text, pre_dest.Substring(3, pre_dest.Length - 3));
                    rel_path = true;
                }
                else
                {
                    destino1 = txt_path_main.Text;
                }
            }

            try
            {
                if (rel_path == true)
                {
                    Directory.CreateDirectory(destino1);
                    System.Threading.Thread.Sleep(10);
                }
                else
                {
                    if (!Directory.Exists(destino1)) Directory.CreateDirectory(destino1);
                    File.WriteAllText(destino1 + "\\" + "FFBatch_test.txt", "FFBatch_test");
                    System.Threading.Thread.Sleep(10);
                    File.Delete(destino1 + "\\" + "FFBatch_test.txt");
                }
            }
            catch (System.Exception excpt)
            {
                MessageBox.Show(FFBatch.Properties.Strings.write_error1 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            //End path is writable

            Disable_Controls();
            txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + "00h:00m:00s";
            time_n_tasks = 0;
            timer_tasks.Start();
            cancel_queue = false;
            Pg1.Value = 0;
            //pg_current.Value = 0;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            notifyIcon1.Visible = true;

            working = true;

            String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");

            Pg1.Value = 0;

            String primero_lista = element;

            String destino = "";
            if (txt_path_main.Text.Contains(".\\"))
            {
                destino = primero_lista.Substring(0, primero_lista.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty); ;
            }
            else
            {
                destino = txt_path_main.Text;
            }

            if (!Directory.Exists(destino))
            {
                try
                {
                    Directory.CreateDirectory(destino);
                }
                catch (System.Exception excpt)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    this.Cursor = Cursors.Arrow;
                    Enable_Controls();
                    working = false;
                    return;
                }
            }

            var lista_concat = new String[listView1.Items.Count];
            int i = 0;
            ListView list_proc = new ListView();
            foreach (ListViewItem item in listView1.Items)
            {
                list_proc.Items.Add((ListViewItem)item.Clone());
                item.SubItems[5].Text = FFBatch.Properties.Strings.queued;
                //item.UseItemStyleForSubItems = true;
                //item.BackColor = Color.White;
                //item.SubItems[5].BackColor = Color.White;
            }

            listView1.SelectedIndices.Clear();
            Double total_duration = 0;
            int i_dur = 0;

            //Get total duration of files
            foreach (ListViewItem item in listView1.Items)
            {
                if (listView1.Items[i_dur].SubItems[3].Text != FFBatch.Properties.Strings.n_a && listView1.Items[i_dur].SubItems[3].Text != "0:00:00" && listView1.Items[i_dur].SubItems[3].Text != "00:00:00" && listView1.Items[i_dur].SubItems[3].Text != FFBatch.Properties.Strings.pending)
                {
                    total_duration = total_duration + TimeSpan.Parse(listView1.Items[i_dur].SubItems[3].Text).TotalSeconds;
                }
                else
                {
                    total_duration = total_duration + 0;
                }

                i_dur = i_dur + 1;
            }
            //End get total duration of files

            Pg1.Maximum = 100;
            foreach (ListViewItem item in listView1.Items)
            {
                item.SubItems[5].Text = FFBatch.Properties.Strings.processing;
            }

            //End total duration

            List<string> list_lines = new List<string>();
            process_glob.StartInfo.Arguments = String.Empty;
            String concat_name = Path.GetFileNameWithoutExtension(element);

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;

                String remain_time = "";

                String path = System.IO.Path.Combine(Path.GetTempPath(), "concat.txt");
                String inputs = String.Empty;

                if (images_v == false)
                {
                    foreach (ListViewItem item in list_proc.Items)
                    {
                        String file = item.SubItems[1].Text + "\\" + item.Text;
                        //Aborted requested
                        if (cancel_queue == true)
                        {
                            working = false;
                            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                            this.InvokeEx(f => f.Pg1.Value = 0);
                            //this.InvokeEx(f => f.pg_current.Value = 0);
                            Enable_Controls();
                            MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.task_abort, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                            return;
                        }

                        if (file.Contains(" "))
                        {
                            lista_concat[i] = "file " + "'" + file + "'";
                            i = i + 1;
                        }
                        else
                        {
                            lista_concat[i] = "file " + "'" + file.Replace("\\", "\\\\") + "'";
                            i = i + 1;
                        }
                    }
                }
                if (images_v == true)
                {
                    for (int i1 = 0; i1 < list_proc.Items.Count; i1++)
                    {
                        String file = list_proc.Items[i1].SubItems[1].Text + "\\" + list_proc.Items[i1].Text;
                        //Aborted requested
                        if (cancel_queue == true)
                        {
                            working = false;
                            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                            this.InvokeEx(f => f.Pg1.Value = 0);
                            //this.InvokeEx(f => f.pg_current.Value = 0);
                            Enable_Controls();
                            MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.task_abort, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                            return;
                        }
                        if (file.Contains(" "))
                        {
                            lista_concat[i1] = "file " + "'" + file + "'" + Environment.NewLine + "duration " + images_time;
                            if (i1 == list_proc.Items.Count - 1) lista_concat[i1] = lista_concat[i1] + Environment.NewLine + "file " + "'" + file + "'" + Environment.NewLine + "duration 1";
                        }
                        else
                        {
                            lista_concat[i1] = "file " + "'" + file.Replace("\\", "\\\\") + "'" + Environment.NewLine + "duration " + images_time;
                            if (i1 == list_proc.Items.Count - 1) lista_concat[i1] = lista_concat[i1] + Environment.NewLine + "file " + "'" + file.Replace("\\", "\\\\") + "'" + Environment.NewLine + "duration 1"; ;
                        }
                    }
                }

                //   foreach (String ln in lista_concat) MessageBox.Show(ln);
                //Array.Resize(ref lista_concat, lista_concat.Length - 1);

                try
                {
                    File.WriteAllLines(path, lista_concat);
                }
                catch (Exception exc)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.err_concat + Environment.NewLine + Environment.NewLine + exc.Message + Environment.NewLine + Environment.NewLine + path);
                    working = false;
                    Enable_Controls();
                    return;
                }

                //Change Volume
                String change_vol = "";
                if (chk_vol.Checked == true)
                {
                    change_vol = "-filter:a " + '\u0022' + "volume=" + vol_ch.Value.ToString() + "dB " + '\u0022' + " ";
                }
                //End change volume
                String AppParam = String.Empty;
                if (check_concat.CheckState == CheckState.Unchecked)
                {
                    if (img_aud == String.Empty && images_from_wiz == false) AppParam = " -f concat -safe 0 -i " + '\u0022' + path + '\u0022' + " " + txt_parameters.Text + " " + " -y " + change_vol + '\u0022' + destino + "\\" + concat_name + "_joined" + "." + txt_format.Text + '\u0022';
                    else AppParam = " -f concat -safe 0 -i " + '\u0022' + path + '\u0022' + " " + "-i " + '\u0022' + img_aud + '\u0022' + " " + txt_parameters.Text + " " + " -y " + change_vol + '\u0022' + destino + "\\" + concat_name + "_joined" + "." + txt_format.Text + '\u0022';
                }
                else
                {
                    AppParam = inputs + " -filter_complex " + '\u0022' + "concat=n=" + list_proc.Items.Count + ":v=1:a=1" + '\u0022' + " " + txt_parameters.Text + " " + " -y " + change_vol + '\u0022' + destino + "\\" + concat_name + "_joined" + "." + txt_format.Text + '\u0022';
                }
                if (images_from_wiz == true)
                {
                    String img_aud_w = String.Empty;
                    if (img_aud_from_wiz.Length > 2) img_aud_w = "-i " + img_aud_from_wiz;
                    AppParam = "-f concat -safe 0 -i " + '\u0022' + path + '\u0022' + " " + img_aud_w + " " + txt_parameters.Text + " " + " -y " + change_vol + '\u0022' + destino + "\\" + concat_name + "_joined" + "." + txt_format.Text + '\u0022';
                }

                if (images_from_wiz == true)
                {
                    total_duration = Convert.ToDouble(img_dur_wiz);
                    images_v = false;
                }
                images_from_wiz = false;

                process_glob.StartInfo.FileName = ffm;
                process_glob.StartInfo.Arguments = AppParam;
                process_glob.StartInfo.RedirectStandardOutput = true;
                process_glob.StartInfo.RedirectStandardError = true;
                process_glob.StartInfo.RedirectStandardInput = true;
                process_glob.StartInfo.UseShellExecute = false;
                process_glob.StartInfo.CreateNoWindow = true;
                process_glob.EnableRaisingEvents = true;
                valid_prog = false;

                process_glob.Start();
                System.Threading.Thread.Sleep(50);
                combo_prio.Invoke(new MethodInvoker(delegate
                {
                    if (combo_prio.SelectedIndex != 2)
                    {
                        Change_mem_prio();
                    }
                }));

                String err_txt = "";

                while (!process_glob.StandardError.EndOfStream)
                {
                    err_txt = process_glob.StandardError.ReadLine();
                    list_lines.Add(err_txt);
                    int percent2 = 0;
                    if (err_txt.Contains("time=") && err_txt.Contains("time=-") == false && images_v == false)
                    {
                        int start_time_index = err_txt.IndexOf("time=") + 5;
                        Double sec_prog = TimeSpan.Parse(err_txt.Substring(start_time_index, 8)).TotalSeconds;
                        Double percent = (sec_prog * 100 / total_duration);
                        try
                        {
                            percent2 = Convert.ToInt32(percent);
                        }
                        catch
                        {
                            percent2 = 0;
                        }

                        if (percent2 <= 100)
                        {
                            this.InvokeEx(f => f.Pg1.Text = (percent2).ToString() + "%");
                            this.InvokeEx(f => f.Pg1.Value = percent2);
                            this.InvokeEx(f => f.Pg1.Refresh());
                            this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, percent2, Pg1.Maximum));
                        }
                        //Estimated remaining time

                        remain_time = err_txt.Substring(err_txt.LastIndexOf("speed=") + 6, err_txt.Length - err_txt.LastIndexOf("speed=") - 6);
                        remain_time = remain_time.Replace("x", String.Empty);
                        Double timing1 = 0;

                        if (System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator == ",")
                        {
                            timing1 = Math.Round(Double.Parse(remain_time.Replace(".", ",")), 2);
                        }
                        else
                        {
                            timing1 = Math.Round(Double.Parse(remain_time), 2);
                        }
                        Decimal timing = (decimal)timing1;
                        Decimal total_dur_dec = Convert.ToDecimal(total_duration);
                        Decimal total_prog_dec = Convert.ToDecimal(sec_prog);
                        Decimal remain_secs = 0;
                        if (timing > 0)
                        {
                            remain_secs = (decimal)(total_dur_dec - total_prog_dec) / timing;
                        }

                        if (remain_secs > 60)
                        {
                            remain_secs = remain_secs + 60;
                        }
                        String remain_from_secs = "";

                        TimeSpan t = TimeSpan.FromSeconds(Convert.ToDouble(remain_secs));
                        remain_from_secs = string.Format("{0:D2}h:{1:D2}",
                           t.Hours,
                          t.Minutes);

                        if (remain_secs >= 3600)
                        {
                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs + " " + FFBatch.Properties.Strings.minutes_abrev);
                        }

                        if (remain_secs < 3600 && remain_secs >= 600)
                        {
                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes);
                        }
                        if (remain_secs < 600 && remain_secs >= 120)
                        {
                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes);
                        }

                        if (remain_secs <= 59)
                        {
                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Convert.ToInt16(remain_secs) + " " + FFBatch.Properties.Strings.seconds);
                        }

                        //End remaining time
                    }

                    //Read output, get progress
                }
                process_glob.WaitForExit();
                process_glob.StartInfo.Arguments = String.Empty;
                this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                this.InvokeEx(f => f.Pg1.Value = Pg1.Maximum);
                this.InvokeEx(f => f.Pg1.Text = Pg1.Value.ToString() + "%");
                list_lines.Add("");

                if (process_glob.ExitCode == 0)
                {
                    foreach (ListViewItem item in list_proc.Items)
                    {
                        this.InvokeEx(f => f.listView1.Items[item.Index].SubItems[5].Text = FFBatch.Properties.Strings.success);
                    }
                    working = false;
                    Enable_Controls();

                    if (play_on_end == true) play_end();
                    if (Form.ActiveForm == null)
                    {
                        notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.concat_compl;
                        notifyIcon1.BalloonTipIcon = ToolTipIcon.Info;
                        notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.conc_comp;
                        notifyIcon1.ShowBalloonTip(0);
                    }

                    if (chk_open_compl.Checked)
                    {
                        if (Directory.GetFiles(destino).Length != 0)
                        {
                            Process open_processed = new Process();
                            open_processed.StartInfo.FileName = "explorer.exe";
                            open_processed.StartInfo.Arguments = '\u0022' + destino + '\u0022';
                            open_processed.Start();
                        }
                        else
                        {
                            if (Directory.Exists(destino))
                            {
                                System.IO.Directory.Delete(destino);
                            }
                        }
                    }
                }
                else
                {
                    working = false;
                    Enable_Controls();
                    if (Directory.GetFiles(destino).Length == 0)
                    {
                        if (Directory.Exists(destino))
                        {
                            System.IO.Directory.Delete(destino);
                        }
                    }
                    if (cancel_queue == true)
                    {
                        foreach (ListViewItem item in list_proc.Items)
                        {
                            this.InvokeEx(f => f.listView1.Items[item.Index].SubItems[5].Text = FFBatch.Properties.Strings.aborted);
                        }
                        MessageBox.Show(FFBatch.Properties.Strings.concat_abort, FFBatch.Properties.Strings.aborted, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    }
                    else
                    {
                        foreach (ListViewItem item in list_proc.Items)
                        {
                            this.InvokeEx(f => f.listView1.Items[item.Index].SubItems[5].Text = FFBatch.Properties.Strings.error);
                        }

                        MessageBox.Show(FFBatch.Properties.Strings.concat_failed + Environment.NewLine + Environment.NewLine + '\u0022' + list_lines[list_lines.Count - 2] + '\u0022', "Concatenation failed", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }

                //Save log
                string[] array_err = list_lines.ToArray();
                String path_l = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                if (is_portable == true) path_l = port_path + "ff_batch_portable.log";

                if (no_save_logs == false)
                {
                    System.IO.StreamWriter SaveFile = new System.IO.StreamWriter(path_l);
                    SaveFile.WriteLine("FFmpeg log session: " + System.DateTime.Now);
                    SaveFile.WriteLine("-------------------------------");
                    foreach (String item in array_err)
                    {
                        SaveFile.WriteLine(item);
                    }
                    SaveFile.Close();

                    File.AppendAllText(path_l, "-----------------------");
                    File.AppendAllText(path_l, Environment.NewLine + FFBatch.Properties.Strings.end_log + Environment.NewLine);
                    System.IO.FileInfo fileInfo = new System.IO.FileInfo(path_l);

                    var bytes = fileInfo.Length;

                    var kilobytes = (double)bytes / 1024;
                    var megabytes = kilobytes / 1024;
                    var gigabytes = megabytes / 1024;

                    //Format size view
                    String size = "";
                    String separator = ".";

                    if (bytes > 1000000000)
                    {
                        if (gigabytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }

                        String gigas = gigabytes.ToString();
                        if (gigas.Length >= 5)
                        {
                            gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                            size = (gigas + " " + "GB");
                        }
                        else
                        {
                            size = (gigas + " " + "GB");
                        }
                    }

                    if (bytes >= 1048576 && bytes <= 1000000000)
                    {
                        if (megabytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }
                        String megas = megabytes.ToString();
                        if (megas.Length > 5)
                        {
                            megas = megas.Substring(0, megas.LastIndexOf(separator));
                            size = (megas + " " + "MB");
                        }
                        else
                        {
                            size = (megas + " " + "MB");
                        }
                    }

                    if (bytes >= 1024 && bytes < 1048576)

                    {
                        if (kilobytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }

                        String kbs = kilobytes.ToString();
                        if (kbs.Length >= 5)
                        {
                            kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                            size = (kbs + " " + "KB");
                        }
                        else
                        {
                            size = (kbs + " " + "KB");
                        }
                    }
                    if (bytes > -1 && bytes < 1024)
                    {
                        String bits = bytes.ToString();
                        size = (bits + " Bytes");
                    }

                    //End Format size view
                    File.AppendAllText(path_l, Environment.NewLine + FFBatch.Properties.Strings.log_size + " " + size);

                    //End save log
                }

                if (File.Exists(System.IO.Path.Combine(Path.GetTempPath(), "concat.txt")))
                {
                    try
                    {
                        File.Delete(System.IO.Path.Combine(Path.GetTempPath(), "concat.txt"));
                    }
                    catch { }
                }
                if (chkshut.Checked)
                {
                    auto_shut();
                    return;
                }
                Enable_Controls();
                this.InvokeEx(f => f.btn_load_config.PerformClick());
            }).Start();
        }

        private void play_end()
        {
            try
            {
                Task t = Task.Run(() =>
                {
                    soundPlayer.SoundLocation = play_file_path;
                    soundPlayer.Play();
                    Thread.Sleep(8000);
                    soundPlayer.Stop();
                });
            }
            catch { }
        }

        private void Timer_idle_Tick(object sender, EventArgs e)
        {
            NativeMethods.SetThreadExecutionState(EXECUTION_STATE.ES_CONTINUOUS | EXECUTION_STATE.ES_AWAYMODE_REQUIRED);
        }

        private void button7_Click_2(object sender, EventArgs e)
        {
            Pg1.Focus();
            Form frm_custom_path = new Form();
            frm_custom_path.Icon = this.Icon;
            frm_custom_path.Height = 175;
            frm_custom_path.Width = 518;
            frm_custom_path.BackColor = Color.White;
            frm_custom_path.FormBorderStyle = FormBorderStyle.Fixed3D;
            frm_custom_path.MaximizeBox = false;
            frm_custom_path.MinimizeBox = false;
            frm_custom_path.Text = FFBatch.Properties.Strings.custom_rel;

            Panel frm_panel = new Panel();
            frm_panel.Top = 80;
            frm_panel.Height = 55;
            frm_panel.Left = 0;
            frm_panel.BackColor = Control.DefaultBackColor;
            frm_panel.Width = 518;
            frm_panel.Parent = frm_custom_path;

            Label bord = new Label();
            bord.Top = 0;
            bord.Height = 1;
            bord.Left = 0;
            bord.Width = 390;
            bord.BorderStyle = BorderStyle.None;
            bord.BackColor = Color.WhiteSmoke;
            bord.Parent = frm_custom_path;
            bord.Text = "";

            Label texto = new Label();
            texto.Top = 20;
            texto.Height = 20;
            texto.Left = 77;
            texto.Width = 195;
            texto.Parent = frm_custom_path;
            texto.Text = FFBatch.Properties.Strings.write_path;

            PictureBox pic = new PictureBox();
            pic.Top = 15;
            pic.Left = 10;
            pic.Height = 26;
            pic.Width = 26;
            pic.Parent = frm_custom_path;
            Form19 frm19 = new Form19();
            pic.Image = frm19.pictureBox1.Image;

            Label texto2 = new Label();
            texto2.Top = 47;
            texto2.Left = 7;
            texto2.Width = 48;
            texto2.Parent = frm_custom_path;
            texto2.Text = FFBatch.Properties.Strings.path2;

            TextBox txt_ref = new TextBox();
            txt_ref.Left = 58;
            txt_ref.Top = 44;
            txt_ref.Width = 16;
            txt_ref.Text = ".\\";
            txt_ref.Enabled = false;
            txt_ref.Parent = frm_custom_path;

            path_txt.Parent = frm_custom_path;
            path_txt.Top = 44;
            path_txt.Left = 79;
            path_txt.Width = 400;
            path_txt.Focus();
            path_txt.TabIndex = 0;
            path_txt.KeyDown += new KeyEventHandler(path_txt_KeyDown);

            Button boton_user_source_path = new Button();
            boton_user_source_path.Parent = frm_panel;
            boton_user_source_path.Left = 78;
            boton_user_source_path.Top = 15;
            boton_user_source_path.BackColor = Control.DefaultBackColor;
            boton_user_source_path.Width = 227;
            boton_user_source_path.Height = 25;
            boton_user_source_path.Text = FFBatch.Properties.Strings.use_source;
            boton_user_source_path.TabIndex = 0;
            boton_user_source_path.Click += new EventHandler(boton_user_source_path_Click);

            Button boton_ok_path = new Button();
            boton_ok_path.Parent = frm_panel;
            boton_ok_path.Left = 417;
            boton_ok_path.Top = 15;
            boton_ok_path.BackColor = Control.DefaultBackColor;
            boton_ok_path.Width = 70;
            boton_ok_path.Height = 25;
            boton_ok_path.Text = FFBatch.Properties.Strings.cancel;
            boton_ok_path.TabIndex = 0;
            boton_ok_path.Click += new EventHandler(boton_cancel_path_Click);

            Button boton_cancel_path = new Button();
            boton_cancel_path.Parent = frm_panel;
            boton_cancel_path.Left = 343;
            boton_cancel_path.BackColor = Control.DefaultBackColor;
            boton_cancel_path.Top = 15;
            boton_cancel_path.Width = 70;
            boton_cancel_path.Height = 25;
            boton_cancel_path.Text = FFBatch.Properties.Strings.ok;

            boton_cancel_path.Click += new EventHandler(boton_ok_path_Click);

            frm_custom_path.StartPosition = FormStartPosition.CenterParent;
            frm_custom_path.ShowDialog();
        }

        private void boton_user_source_path_Click(object sender, EventArgs e)
        {
            if (txt_path_main.Text == ".\\" && btn_save_path.Enabled == false) btn_save_path.Enabled = true;
            if (txt_path_main.Text != ".\\") btn_save_path.Enabled = true;
            txt_path_main.Text = ".\\";
            txt_path_mux.Text = txt_path_main.Text;
            txt_path_main.BackColor = groupBox1.BackColor;
            //btn_reset_path.BackColor = groupBox1.BackColor;

            ActiveForm.Close();
        }

        private void BG_Try_button_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
        }

        private void item_up_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            if (tabControl1.SelectedIndex == 0)
            {
                if (listView1.SelectedItems.Count == 1 && listView1.SelectedItems[0].SubItems[5].Text == FFBatch.Properties.Strings.queued)
                {
                    lvwColumnSorter_Full.Order = SortOrder.None;
                    var currentIndex = listView1.SelectedItems[0].Index;
                    var item = listView1.Items[listView1.SelectedIndices[0]];
                    if (currentIndex > 0 && listView1.Items[currentIndex - 1].SubItems[5].Text == FFBatch.Properties.Strings.queued)
                    {
                        listView1.Items.RemoveAt(currentIndex);
                        listView1.Items.Insert(currentIndex - 1, item);
                    }
                }
            }

            if (tabControl1.SelectedIndex == 3)
            {
                if (dg1.SelectedCells.Count == 0 || dg1.SelectedCells.Count > 1) return;
                DataGridView dgv = dg1;
                try
                {
                    int totalRows = dgv.Rows.Count;
                    // get index of the row for the selected cell
                    int rowIndex = dgv.SelectedCells[0].OwningRow.Index;
                    if (rowIndex == 0)
                        return;
                    // get index of the column for the selected cell
                    int colIndex = dgv.SelectedCells[0].OwningColumn.Index;
                    DataGridViewRow selectedRow = dgv.Rows[rowIndex];
                    dgv.Rows.Remove(selectedRow);
                    dgv.Rows.Insert(rowIndex - 1, selectedRow);
                    dgv.ClearSelection();
                    dgv.Rows[rowIndex - 1].Cells[colIndex].Selected = true;
                }
                catch { }
            }
        }

        private void item_down_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            if (tabControl1.SelectedIndex == 0)
            {
                if (listView1.SelectedItems.Count == 1 && listView1.SelectedItems[0].SubItems[5].Text == FFBatch.Properties.Strings.queued)
                {
                    lvwColumnSorter_Full.Order = SortOrder.None;
                    var currentIndex = listView1.SelectedItems[0].Index;
                    var item = listView1.Items[listView1.SelectedIndices[0]];
                    if (currentIndex > -1 && currentIndex < listView1.Items.Count - 1)
                    {
                        listView1.Items.RemoveAt(currentIndex);
                        listView1.Items.Insert(currentIndex + 1, item);
                    }
                }
            }

            if (tabControl1.SelectedIndex == 3)
            {
                if (dg1.SelectedCells.Count == 0 || dg1.SelectedCells.Count > 1) return;
                DataGridView dgv = dg1;
                try
                {
                    int totalRows = dgv.Rows.Count;
                    // get index of the row for the selected cell
                    int rowIndex = dgv.SelectedCells[0].OwningRow.Index;
                    if (rowIndex == totalRows - 1)
                        return;
                    // get index of the column for the selected cell
                    int colIndex = dgv.SelectedCells[0].OwningColumn.Index;
                    DataGridViewRow selectedRow = dgv.Rows[rowIndex];
                    dgv.Rows.Remove(selectedRow);
                    dgv.Rows.Insert(rowIndex + 1, selectedRow);
                    dgv.ClearSelection();
                    dgv.Rows[rowIndex + 1].Cells[colIndex].Selected = true;
                }
                catch { }
            }
        }

        private void requeue_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            if (tabControl1.SelectedIndex == 0)
            {
                foreach (ListViewItem item in listView1.Items)
                {
                    item.SubItems[5].Text = FFBatch.Properties.Strings.queued;
                    item.BackColor = Color.White;
                }
            }
        }

        private void chk_try_CheckedChanged(object sender, EventArgs e)
        {
            String f_try = String.Empty;
            if (is_portable == false)
            {
                f_try = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_try.ini";
            }
            else
            {
                f_try = port_path + "ff_try_portable.ini";
            }

            if (chk_try.Checked == false)
            {
                if (File.Exists(f_try))
                {
                    try
                    {
                        File.Delete(f_try);
                    }
                    catch
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
            }
            else
            {
                if (!File.Exists(f_try))
                {
                    try
                    {
                        File.WriteAllText(f_try, String.Empty);
                    }
                    catch
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
            }
        }

        private void chk_no_sleep_MouseHover(object sender, EventArgs e)
        {
            toolTip01.AutoPopDelay = 5000;
            toolTip01.InitialDelay = 750;
            toolTip01.ReshowDelay = 500;
            toolTip01.ShowAlways = true;
            if (start_seq) toolTip01.SetToolTip(this.chk_autor, FFBatch.Properties.Strings2.autorun_en);
            else
            {
                toolTip01.SetToolTip(this.chk_autor, FFBatch.Properties.Strings2.autorun_dis);
            }
        }

        private void obtain_ffmpeg()
        {
            if (is_portable == true) return;

            Boolean writable = false;
            try
            {
                FileStream fs = File.Create(Path.Combine(Application.StartupPath, Path.GetRandomFileName()), 1, FileOptions.DeleteOnClose);
                writable = true;
            }
            catch
            {
                writable = false;
            }

            OpenFileDialog browse_file = new OpenFileDialog();
            String file_path = String.Empty;
            browse_file.Filter = "ffmpeg.exe |ffmpeg.exe";

            if (browse_file.ShowDialog() == DialogResult.OK)
            {
                file_path = browse_file.FileName;
                if (Path.GetFileName(file_path.ToLower()) != "ffmpeg.exe")
                {
                    MessageBox.Show(FFBatch.Properties.Strings.ff_not, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    obtain_ffmpeg();
                    return;
                }
            }
            else
            {
                is_ff_ok = false;
                return;
            }

            String path = "cmd.exe";
            String param = "/C copy " + '\u0022' + file_path + '\u0022' + " " + '\u0022' + Application.StartupPath + '\u0022' + " / Y";
            Process ff_ext = new Process();
            ff_ext.StartInfo.FileName = path;
            ff_ext.StartInfo.Arguments = param;
            ff_ext.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;
            if (writable == false) ff_ext.StartInfo.Verb = "runas";
            try
            {
                ff_ext.Start();
                ff_ext.WaitForExit();
                is_ff_ok = true;
            }
            catch
            {
                MessageBox.Show(FFBatch.Properties.Strings.err_dest, FFBatch.Properties.Strings.write_error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                is_ff_ok = false;
            }
        }

        private void obtain_mediainfo()
        {
            if (is_portable == true) return;

            Boolean writable = false;
            try
            {
                FileStream fs = File.Create(Path.Combine(Application.StartupPath, Path.GetRandomFileName()), 1, FileOptions.DeleteOnClose);
                writable = true;
            }
            catch
            {
                writable = false;
            }

            OpenFileDialog browse_file = new OpenFileDialog();
            String file_path = String.Empty;
            browse_file.Filter = "mediainfo.exe |mediainfo.exe";

            if (browse_file.ShowDialog() == DialogResult.OK)
            {
                file_path = browse_file.FileName;
                if (Path.GetFileName(file_path.ToLower()) != "mediainfo.exe")
                {
                    MessageBox.Show(FFBatch.Properties.Strings.med_not, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    obtain_mediainfo();
                    return;
                }
            }
            else
            {
                is_ff_ok = false;
                return;
            }

            String path = "cmd.exe";
            String param = "/C copy " + '\u0022' + file_path + '\u0022' + " " + '\u0022' + Application.StartupPath + '\u0022' + " / Y";
            Process ff_ext = new Process();
            ff_ext.StartInfo.FileName = path;
            ff_ext.StartInfo.Arguments = param;
            ff_ext.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;
            if (writable == false) ff_ext.StartInfo.Verb = "runas";
            try
            {
                ff_ext.Start();
                ff_ext.WaitForExit();
                is_ff_ok = true;
            }
            catch
            {
                MessageBox.Show(FFBatch.Properties.Strings.err_dest, FFBatch.Properties.Strings.write_error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                is_ff_ok = false;
            }
        }

        private void replace_ytdl()
        {
            try
            {
                FileStream fs = File.Create(Path.Combine(Application.StartupPath, Path.GetRandomFileName()), 1, FileOptions.DeleteOnClose);
                writable_yl = true;
            }
            catch
            {
                writable_yl = false;
            }
            if (writable_yl == true)
            {
                try
                {
                    File.Copy(Path.GetTempPath() + "\\" + "yt-dlp.exe", Application.StartupPath + "\\" + "yt-dlp.exe", true);
                }
                catch (Exception excp)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.err_yt_up, FFBatch.Properties.Strings.update_err, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                }
            }
            else
            {
                Process prc = new Process();
                String path = "cmd.exe";
                String param = "/C copy " + '\u0022' + Path.GetTempPath() + "yt-dlp.exe" + '\u0022' + " " + '\u0022' + Application.StartupPath + "\\" + "yt-dlp.exe" + '\u0022' + " /Y";
                prc.StartInfo.FileName = path;
                prc.StartInfo.Arguments = param;

                prc.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;
                prc.StartInfo.Verb = "runas";
                lbl_yl_name.Text = FFBatch.Properties.Strings.updating;
                try
                {
                    prc.Start();
                }
                catch (Exception excp)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.err_yt_2 + " " + Environment.NewLine + excp.Message + Environment.NewLine + " " + Properties.Strings.err_yt_up, FFBatch.Properties.Strings.update_err, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                }

                Thread.Sleep(4000);
            }

            foreach (Control ct in groupBox_m3u.Controls)
            {
                this.InvokeEx(f => ct.Enabled = true);
            }
            this.InvokeEx(f => f.btn_update_yt.Text = FFBatch.Properties.Strings.update);
            this.InvokeEx(f => f.txt_up_output.Visible = false);
            this.InvokeEx(f => f.pg_update_yl.Visible = false);
            this.InvokeEx(f => f.txt_up_output.Visible = false);
        }

        private void wc_dl_DownloadFileCompleted(object sender, AsyncCompletedEventArgs e)
        {
            if (e.Cancelled == true)
            {
                try
                {
                    File.Delete(Path.GetTempPath() + "\\" + "yt-dlp.exe");
                }
                catch { }
                wc_dl.Dispose();
                return;
            }
            else
            {
                replace_ytdl();
                youtube_dl_ver();
                try
                {
                    File.Delete(Path.GetTempPath() + "\\" + "yt-dlp.exe");
                }
                catch { }
            }
            txt_m3u_params.Enabled = false;
            txt_output_server.Enabled = false;
        }

        private void wc_dl_DownloadProgressChanged(object sender, DownloadProgressChangedEventArgs e)
        {
            this.InvokeEx(f => f.pg_update_yl.Value = e.ProgressPercentage);
            this.InvokeEx(f => f.pg_update_yl.Refresh());
        }

        private void wc2_DownloadFileCompleted(object sender, AsyncCompletedEventArgs e)
        {
            this.InvokeEx(f => f.pg_adding.Visible = false);
            this.InvokeEx(f => f.txt_adding_p.Text = "");
            this.InvokeEx(f => f.LB_Wait.Text = "");
            this.InvokeEx(f => f.btn_cancel_add.Visible = false);

            if (e.Error == null)
            {
                Process p = Process.Start(Path.Combine(Path.GetTempPath(), vc_download));
                this.InvokeEx(f => this.Enabled = false);
                p.WaitForExit();
                this.InvokeEx(f => this.Enabled = true);
                if (p.ExitCode == 0)
                {
                    Thread.Sleep(500);
                    //this.InvokeEx(f => lbl_yl_name.Left = lbl_yl_name.Left - 16);
                    //this.InvokeEx(f => lbl_yl_name.Width = lbl_yl_name.Width - 75);
                    this.InvokeEx(f => lbl_yl_name.Text = FFBatch.Properties.Strings.checking_y);
                    //this.InvokeEx(f => lbl_yt_v.Visible = false);
                    youtube_dl_ver();
                }
                else
                {
                    MessageBox.Show(FFBatch.Properties.Strings.yt_req_err, FFBatch.Properties.Strings.inst_err, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    lbl_yl_name.Text = FFBatch.Properties.Strings.err_int_yt;
                }
            }
            else
            {
                MessageBox.Show(FFBatch.Properties.Strings.err_down_u, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void wc2_DownloadProgressChanged(object sender, DownloadProgressChangedEventArgs e)
        {
            this.InvokeEx(f => f.pg_adding.Maximum = 100);
            this.InvokeEx(f => f.pg_adding.Value = e.ProgressPercentage);
            this.InvokeEx(f => f.pg_adding.Refresh());
            this.InvokeEx(f => f.txt_adding_p.Text = e.ProgressPercentage.ToString() + "%");
            this.InvokeEx(f => f.txt_adding_p.Refresh());
        }

        private void check_VC()
        {
            //this.InvokeEx(f => f.lbl_yl_name.Left = lbl_yl_name.Left + 16);
            this.InvokeEx(f => f.lbl_yl_name.Text = "Youtube-dl");
            //this.InvokeEx(f => f.lbl_yl_name.Width = lbl_yl_name.Width + 75);
            //this.InvokeEx(f => f.lbl_yt_v.Text = " error checking version");
            this.InvokeEx(f => f.pic_ok.Visible = false);

            wc2.DownloadProgressChanged += new DownloadProgressChangedEventHandler(wc2_DownloadProgressChanged);
            wc2.DownloadFileCompleted += new AsyncCompletedEventHandler(wc2_DownloadFileCompleted);

            String vc_ver = "http://download.microsoft.com/download/C/6/D/C6D0FD4E-9E53-4897-9B91-836EBA2AACD3/vcredist_x86.exe";
            vc_download = "vc_redist.x86.exe";

            //this.InvokeEx(f => f.lbl_yl_name.Left = lbl_yl_name.Left - 16);
            //this.InvokeEx(f => f.lbl_yl_name.Width = lbl_yl_name.Width - 75);
            //this.InvokeEx(f => f.lbl_yt_v.Text = " error checking version");
            this.InvokeEx(f => f.pic_ok.Visible = false);
            DialogResult a = MessageBox.Show(FFBatch.Properties.Strings.visualc_req + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.down_inst, FFBatch.Properties.Strings.add_comp, MessageBoxButtons.YesNoCancel, MessageBoxIcon.Question);
            if (a == DialogResult.Cancel || a == DialogResult.No)
            {
                //this.InvokeEx(f => f.lbl_yl_name.Left = lbl_yl_name.Left - 16);
                this.InvokeEx(f => f.lbl_yl_name.Text = FFBatch.Properties.Strings.err_int_yt);
                //this.InvokeEx(f => f.lbl_yt_v.Text = " error checking version");
                this.InvokeEx(f => f.pic_ok.Visible = false);
                return;
            }
            else
            {
                this.InvokeEx(f => f.pg_adding.Visible = true);
                this.InvokeEx(f => f.btn_cancel_add.Visible = true);
                this.InvokeEx(f => f.LB_Wait.Visible = true);
                this.InvokeEx(f => f.txt_adding_p.Visible = true);
                this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.down_up);
                this.InvokeEx(f => f.LB_Wait.Refresh());

                wc2.DownloadFileAsync(new System.Uri(vc_ver), Path.Combine(Path.GetTempPath(), vc_download));
                this.InvokeEx(f => this.TopMost = true);
                this.InvokeEx(f => this.TopMost = false);
                this.InvokeEx(f => f.pic_ok.Visible = false);
            }
        }

        private void youtube_dl_ver()
        {
            //this.InvokeEx(f => f.lbl_yl_name.Left = lbl_yl_name.Left + 16);
            //this.InvokeEx(f => f.lbl_yl_name.Width = lbl_yl_name.Width + 75);
            this.InvokeEx(f => f.lbl_yl_name.Text = FFBatch.Properties.Strings.check_ytdl);
            //this.InvokeEx(f => f.lbl_yt_v.Visible = false);
            if (!File.Exists(Path.Combine(Application.StartupPath, "yt-dlp.exe")))
            {
                this.InvokeEx(f => f.lbl_yl_name.Text = FFBatch.Properties.Strings.yt_not);
                this.InvokeEx(f => f.lbl_yl_name.Refresh());
                this.InvokeEx(f => f.btn_add_yts.Enabled = false);
                this.InvokeEx(f => f.pic_wait_1.Visible = false);
                this.InvokeEx(f => f.pic_no_yt.Visible = true);
                return;
            }
            BG_check_ytdl.RunWorkerAsync();
            //update_yt_dl_2();
        }

        private void resize()
        {
            int width_cols = 13 - listView1.Columns.Count;
            if (big_res == false)
            {
                this.MinimumSize = new Size(1276, 590);

                tabControl1.Height = this.Height - 471;
                listView1.Height = this.Height - 496;
                listView2.Height = this.Height - 496;
                listView3.Height = this.Height - 496;

                tabControl1.Width = this.Width - 18;
                listView1.Width = this.Width - 25;
                //listView1.Columns[0].Width = (listView1.Width / 2 - 5) - (7 - width_cols);
                //listView1.Columns[1].Width = (listView1.Width / 2 - 390) - (6 - width_cols) * 2;

                listView2.Width = this.Width - 25;
                listView3.Width = this.Width - 25;

                groupBox_m3u.Top = this.Height - 369;

                list_tracks.Top = this.Height - 367;
                groupBox9.Top = this.Height - 205;
                groupBox2.Top = this.Height - 205;
                group_subs.Top = this.Height - 370;
                group_prog.Top = this.Height - 120;

                dg1.Height = this.Height - 496;
                dg1.Width = this.Width - 23;
                groupBox1.Top = this.Height - 370;
                panel1.Top = this.Height - 370;

                group_subs.Width = this.Width - 25;
                listView3.Columns[1].Width = this.Width - 963;

                groupBox1.Width = this.Width / 2 - 17;
                group_prog.Width = this.Width - 26;
                panel1.Left = this.Width / 2 - 9;
                panel1.Width = this.Width / 2 - 13;
                list_tracks.Width = this.Width - 23;
                listView2.Columns[0].Width = this.Width - 645;
                list_tracks.Columns[0].Width = this.Width - 655;

                btn_edit_presets.Left = this.Width / 2 - 47;
                btn_del_preset.Left = this.Width / 2 - 73;
                btn_save_preset.Left = this.Width / 2 - 100;
                label2.Left = this.Width / 2 - 98;
                txt_format.Left = this.Width / 2 - 55;
                txt_config_ver.Left = this.Width / 2 - 55;
                lbl_config.Left = this.Width / 2 - 98;
                combo_presets.Width = this.Width / 2 - 170;
                txt_parameters.Width = this.Width / 2 - 170;

                btn_cancel_shut.Width = this.Width - 41;
                combo_prio.Left = this.Width - 181;
                btn_save_prio.Left = this.Width - 60;
                Pg1.Width = group_prog.Width - 515;
                btn_pause.Left = group_prog.Width - 247;
                btn_abort_all.Left = group_prog.Width - 213;
                lbl_updates.Left = this.Width - 141;
                btn_update.Left = this.Width - 145;
                item_up.Left = this.Width - 46;
                item_down.Left = this.Width - 69;
                requeue.Left = this.Width - 95;
                btn_refresh.Left = this.Width - 124;
                btn_clean_list.Left = this.Width - 145;
                txt_search_url.Left = this.Width - 206;
                lbl_search_url.Left = this.Width - 252;
                lbl_size.Left = this.Width - 203;
                lbl_dur_list.Left = this.Width - 283;
                lbl_items.Left = this.Width - 369;

                btn_inc_font.Left = this.Width - 409;
                btn_decr_font.Left = this.Width - 434;
                btn_undo_filter.Left = this.Width - 463;
                btn_filter.Left = this.Width - 492;
                pic_warnings.Left = (group_prog.Width / 2) - 11;
                pic_no_errors.Left = (group_prog.Width / 2) - 8;
                pic_recording.Left = (group_prog.Width / 2) - 9;
                lbl_elapsed.Left = pic_no_errors.Left - lbl_elapsed.Width - 30;
                txt_remain.Left = (group_prog.Width / 2) + 38;
                lbl_est_size.Left = (group_prog.Width / 2) + 215;
                lbl_bitrate.Left = (group_prog.Width / 2) - 310;
                lbl_speed.Left = (group_prog.Width / 2) - 102;
                btn_cancel_shut.Width = group_prog.Width - 10;
                TB1.Left = (group_prog.Width / 2) - 290;

                button24.Left = this.Width - 110;
                button25.Left = this.Width - 110;
                txt_folder_subs.Width = this.Width - 751;
                txt_hard_subs.Width = this.Width - 678;
                txt_output_subs.Width = this.Width - 751;

                Combo_def_sub_mux.Left = this.Width - 101;
                lbl_def_sub_mux.Left = Combo_def_sub_mux.Left - lbl_def_sub_mux.Width - 2;
                Combo_sub_lang_mux.Left = (group_subs.Width / 2) + 300;
                lbl_lang_sub_mux.Left = Combo_sub_lang_mux.Left - lbl_lang_sub_mux.Width - 2;

                groupBox_m3u.Width = this.Width - 25;
                dg1.Columns[4].Width = this.Width - 930;

                ss_time_input.Left = this.Width / 2 - 169;
                lbl_pre_input.Left = this.Width / 2 - 256;

                btn_ref_dcd.Left = (int)(groupBox1.Width / 2) + 55;
                cb_hwdecode.Left = (int)(groupBox1.Width / 2) - 4;
                lbl_gpu.Left = (int)(groupBox1.Width / 2) - 76;
                groupBox3.Left = (int)(groupBox1.Width / 2) - 66;
                btn_try_pr.Left = this.Width / 2 - 250;
                btn_display_log.Left = btn_try_pr.Left + btn_try_pr.Width;
                btn_save_queue.Left = btn_display_log.Left + btn_display_log.Width + 3;
                groupBox4.Width = this.Width / 2 - 97;
                panel2.Width = this.Width / 2 - 491;
                button21.Left = this.Width / 2 - 79;
                txt_path_main.Width = this.Width / 2 - 161;
                btn_save_path.Left = this.Width / 2 - 105;
                btn_reset_path.Left = this.Width / 2 - 130;
                btn_cust_path.Left = this.Width / 2 - 158;
                txt_ini.Left = this.Width / 2 - 84;
                txt_fin.Left = this.Width / 2 - 84;
                //btn_kf.Left = this.Width / 2 - 84;
                chk_trim2.Left = this.Width / 2 - 91;
                label5.Left = this.Width / 2 - 106;
                label6.Left = this.Width / 2 - 106;
                btn_trim.Left = this.Width / 2 - 159;
                btn_concat.Left = this.Width / 2 - 229;
                btn_capture.Left = this.Width / 2 - 299;

                chk_try.Left = lbl_multi_file.Left + lbl_multi_file.Width + 5 + (int)(this.Width / (1276 / 2));
                chk_delete_source.Left = chk_try.Left + chk_try.Width + 5 + (int)(this.Width / (1276 / 2));
                chk_overw.Left = chk_open_compl.Left + 394;

                groupBox2.Left = this.Width - 649;
                groupBox2.Width = 627;
                groupBox9.Width = this.Width - 657;
                btn_mux.Left = this.Width - 729;
                groupBox11.Left = this.Width - 731;
                txt_track_format.Left = this.Width - 775;
                btn_extract.Left = this.Width - 840;
                groupBox6.Left = this.Width - 847;
                btn_mux_job.Left = (int)(groupBox9.Width / 2) - 33;
                btn_mux_show_jobs.Left = (int)(groupBox9.Width / 2) + 42;
                groupBox_yout.Left = this.Width - 273;
                btn_logs_url.Left = this.Width - 337;
                btn_stop_m3u8.Left = this.Width - 397;
                btn_browse_path_m3u.Left = this.Width - 337;
                btn_save_path_url.Left = this.Width - 365;
                txt_path_m3u.Width = this.Width - 982;
                pic_title.Left = (this.Width / 2) - 130;
                change_ff.Left = (this.Width / 2) - 128;
                btn_cancel_add.Left = this.Width - 575;

                pg_adding.Width = this.Width - 1178;
                txt_adding_p.Left = pg_adding.Left + pg_adding.Width + 4;
                txt_add_remain.Left = pg_adding.Left - pg_adding.Width / 4 + ((pg_adding.Width - 100) / 4);
                txt_add_remain.Width = this.Width - 1178 + 50;
                btn_add_col.Left = this.Width - 519;

                txt_paste_links.Left = (dg1.Width / 2) - (txt_paste_links.Width / 2);
                txt_paste_links.Top = (dg1.Height / 2) - 10;
                lbl_n_urls.Left = txt_search_url.Left - 100;
                lbl_urls_time.Left = txt_search_url.Left - 173;
                panel_thumb.Left = this.Width - 366;
            }

            if (big_res == true)
            {
                this.MinimumSize = new Size(1276 + 30, 615);

                tabControl1.Left = 15;
                groupBox1.Left = 15;
                groupBox_m3u.Left = 15;
                group_subs.Left = 15;
                list_tracks.Left = 15;
                group_prog.Left = 15;
                tabControl1.Height = this.Height - 458 - 40;
                listView1.Height = this.Height - 495 - 30;
                listView2.Height = this.Height - 495 - 30;
                listView3.Height = this.Height - 495 - 30;

                tabControl1.Width = this.Width - 45;
                listView1.Width = this.Width - 50;
                //listView1.Columns[0].Width = (listView1.Width / 2 - 3) - ((listView1.Columns.Count - 5) * 99);
                //listView1.Columns[1].Width = (listView1.Width / 2 - ((listView1.Columns.Count - 4) * 99) - ((listView1.Columns.Count - 4) * 2));

                listView2.Width = this.Width - 50;
                listView3.Width = this.Width - 50;

                dg1.Height = this.Height - 495 - 30;
                dg1.Width = this.Width - 50;
                groupBox1.Top = this.Height - 369 - 20;
                panel1.Top = this.Height - 369 - 20;
                panel1.Left = this.Width / 2 - 1;
                panel1.Width = this.Width / 2 - 31;
                groupBox1.Width = this.Width / 2 - 26;

                btn_edit_presets.Left = this.Width / 2 - 57;
                btn_del_preset.Left = this.Width / 2 - 83;
                btn_save_preset.Left = this.Width / 2 - 110;
                label2.Left = this.Width / 2 - 108;
                txt_format.Left = this.Width / 2 - 65;
                txt_config_ver.Left = this.Width / 2 - 65;
                lbl_config.Left = this.Width / 2 - 108;
                combo_presets.Width = this.Width / 2 - 180;
                txt_parameters.Width = this.Width / 2 - 180; ;

                group_prog.Width = this.Width - 46;
                btn_cancel_shut.Width = this.Width - 61;
                combo_prio.Left = this.Width - 201;
                btn_save_prio.Left = this.Width - 80;
                Pg1.Width = this.Width - 560;
                btn_pause.Left = this.Width - 293;
                btn_abort_all.Left = this.Width - 259;
                lbl_updates.Left = this.Width - 150;
                btn_update.Left = this.Width - 155;
                item_up.Left = this.Width - 56;
                item_down.Left = this.Width - 79;
                requeue.Left = this.Width - 108;
                btn_refresh.Left = this.Width - 136;
                btn_clean_list.Left = this.Width - 158;
                txt_search_url.Left = this.Width - 216;
                lbl_search_url.Left = this.Width - 262;
                lbl_size.Left = this.Width - 207;
                lbl_dur_list.Left = this.Width - 292;
                lbl_items.Left = this.Width - 375;
                btn_inc_font.Left = this.Width - 419;
                btn_decr_font.Left = this.Width - 444;
                btn_undo_filter.Left = this.Width - 473;
                btn_filter.Left = this.Width - 502;
                pic_warnings.Left = (group_prog.Width / 2) - 7;
                pic_no_errors.Left = (group_prog.Width / 2) - 6;
                pic_recording.Left = (group_prog.Width / 2) - 6;
                lbl_elapsed.Left = pic_no_errors.Left - 168;
                txt_remain.Left = (group_prog.Width / 2) + 34;
                lbl_est_size.Left = (group_prog.Width / 2) + 215;
                lbl_bitrate.Left = (group_prog.Width / 2) - 310;
                lbl_speed.Left = (group_prog.Width / 2) - 97;
                btn_cancel_shut.Width = group_prog.Width - 10;
                TB1.Left = (group_prog.Width / 2) - 290;
                group_subs.Width = this.Width - 49;
                listView3.Columns[1].Width = this.Width - 988;
                button24.Left = this.Width - 130;
                button25.Left = this.Width - 130;
                txt_folder_subs.Width = this.Width - 771;
                txt_hard_subs.Width = this.Width - 698;
                txt_output_subs.Width = this.Width - 771;
                Combo_def_sub_mux.Left = this.Width - 111;
                lbl_def_sub_mux.Left = Combo_def_sub_mux.Left - lbl_def_sub_mux.Width - 2;

                Combo_sub_lang_mux.Left = (group_subs.Width / 2) + 300;
                lbl_lang_sub_mux.Left = Combo_sub_lang_mux.Left - lbl_lang_sub_mux.Width - 2;
                groupBox_m3u.Width = this.Width - 49;
                dg1.Columns[4].Width = this.Width - 954;

                ss_time_input.Left = this.Width / 2 - 179;
                lbl_pre_input.Left = this.Width / 2 - 266;

                btn_ref_dcd.Left = (int)(groupBox1.Width / 2) + 55;
                cb_hwdecode.Left = (int)(groupBox1.Width / 2) - 4;
                lbl_gpu.Left = (int)(groupBox1.Width / 2) - 76;
                groupBox3.Left = (int)(groupBox1.Width / 2) - 66;
                btn_try_pr.Left = this.Width / 2 - 260;
                btn_display_log.Left = btn_try_pr.Left + btn_try_pr.Width;
                btn_save_queue.Left = btn_display_log.Left + btn_display_log.Width + 3;
                groupBox4.Width = this.Width / 2 - 115;
                panel2.Left = this.Width / 2 - 182;
                button21.Left = this.Width / 2 - 96;
                txt_path_main.Width = this.Width / 2 - 178;
                btn_save_path.Left = this.Width / 2 - 122;
                btn_reset_path.Left = this.Width / 2 - 147;
                btn_cust_path.Left = this.Width / 2 - 175;
                txt_ini.Left = this.Width / 2 - 101;
                txt_fin.Left = this.Width / 2 - 101;
                //btn_kf.Left = this.Width / 2 - 101;
                chk_trim2.Left = this.Width / 2 - 112;
                label5.Left = this.Width / 2 - 123;
                label6.Left = this.Width / 2 - 123;
                btn_trim.Left = this.Width / 2 - 176;
                btn_concat.Left = this.Width / 2 - 246;
                btn_capture.Left = this.Width / 2 - 315;
                chk_try.Left = lbl_multi_file.Left + lbl_multi_file.Width + 5 + (int)(this.Width / (1276 / 2));
                chk_delete_source.Left = chk_try.Left + chk_try.Width + 5 + (int)(this.Width / (1276 / 2));
                chk_overw.Left = chk_delete_source.Left + chk_delete_source.Width + 32;

                grp_fade.Width = this.Width / 2 - 264;
                btn_multimedia.Left = (int)(panel1.Width / 2 - 48);
                btn_capture.Left = (int)(panel1.Width / 2 + 22);

                fade_a_in.Left = (int)(panel1.Width / 2 - 85);
                fade_a_out.Left = (int)(panel1.Width / 2 - 85);
                num_a_in.Left = (int)(panel1.Width / 2 + 5);
                num_a_out.Left = (int)(panel1.Width / 2 + 5);
                label18.Left = (int)(panel1.Width / 2 + 50);
                label23.Left = (int)(panel1.Width / 2 + 50);

                list_tracks.Width = this.Width - 49;
                listView2.Width = this.Width - 49;
                listView2.Columns[0].Width = this.Width - 677;
                list_tracks.Columns[0].Width = this.Width - 677;
                groupBox2.Left = this.Width - 658;
                groupBox2.Width = 627;
                groupBox9.Left = 15;
                groupBox9.Width = this.Width - 678;
                btn_mux.Left = this.Width - 749;
                groupBox11.Left = this.Width - 751;
                txt_track_format.Left = this.Width - 795;
                btn_extract.Left = this.Width - 860;
                groupBox6.Left = this.Width - 867;
                btn_mux_job.Left = (int)(groupBox9.Width / 2) - 23;
                btn_mux_show_jobs.Left = (int)(groupBox9.Width / 2) + 44;
                groupBox_yout.Left = this.Width - 298;
                btn_logs_url.Left = this.Width - 366;
                btn_stop_m3u8.Left = this.Width - 422;

                btn_browse_path_m3u.Left = this.Width - 365;
                btn_save_path_url.Left = this.Width - 392;
                txt_path_m3u.Width = this.Width - 1010;

                pic_title.Left = (this.Width / 2) - 130;
                change_ff.Left = (this.Width / 2) - 128;
                btn_cancel_add.Left = this.Width - 589;
                pg_adding.Width = this.Width - 1214;
                txt_adding_p.Left = pg_adding.Left + pg_adding.Width + 4;
                txt_add_remain.Left = pg_adding.Left - pg_adding.Width / 4 + ((pg_adding.Width - 100) / 4);
                txt_add_remain.Width = this.Width - 1202 + 50;
                btn_add_col.Left = this.Width - 529;

                groupBox_m3u.Top = this.Height - 369 - 20;

                list_tracks.Top = this.Height - 366 - 20;
                groupBox9.Top = this.Height - 205 - 20;
                groupBox2.Top = this.Height - 205 - 20;
                group_subs.Top = this.Height - 369 - 20;
                group_prog.Top = this.Height - 118 - 15;

                txt_paste_links.Left = (dg1.Width / 2) - (txt_paste_links.Width / 2);
                txt_paste_links.Top = (dg1.Height / 2) - 10;
                lbl_n_urls.Left = txt_search_url.Left - 100;
                lbl_urls_time.Left = txt_search_url.Left - 183;
                panel_thumb.Left = this.Width - 386;
            }
        }

        private void Form1_Shown(object sender, EventArgs e)
        {
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";

            //Create presets if file not available
            String path_pr, path_pre = "";
            if (is_portable == false)
            {
                path_pr = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_presets.ini";
                path_pre = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch_pre.ini";
            }
            else
            {
                path_pr = port_path + "ff_presets_portable.ini";
                path_pre = port_path + "ff_batch_pre_portable.ini";
            }

            if (!File.Exists(path_pr))
            {
                File.WriteAllText(path_pr, "Version 1.0" + Environment.NewLine
       + "PR: " + Properties.Strings2.pr01 + " & -c copy % mp4" + Environment.NewLine
   + "PR: " + Properties.Strings2.pr02 + " & -c:v copy -c:a aac -cutoff 20K -b:a 256K -ac 2 % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr03 + " & -map 0 -c:v copy -c:a ac3 -b:a 256K -ac 2 -c:s copy % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr04 + " & -c:v prores_ks -profile:v standard -vendor:v ap10 -pix_fmt yuv422p10le -c:a pcm_s16le -chunk_size 64K % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr05 + " & -map 0 -c:v libx264 -crf 20 -c:a copy % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr06 + "  & -map 0 -c:v libx264 -crf 23 -preset ultrafast -c:a copy % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr07 + " & -map 0 -c:v libx265 -crf 23 -c:a copy % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr08 + " & -map 0 -c:v libx264 -crf 23 -vf scale=1280:720 -c:a aac -b:a 128K % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr09 + " & -c:v libx264 -crf 21 -vf " + "\u0022" + "transpose=1" + "\u0022" + " -c:a aac -b:a 128K % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr10 + " & -c:v libx264 -crf 21 -vf " + "\u0022" + "transpose=0" + "\u0022" + " -c:a aac -b:a 128K % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr11 + "  & -c:v libx264 -crf 21 -vf " + "\u0022" + "transpose=2" + "\u0022" + " -c:a aac -b:a 128K % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr12 + " & -c:v libx264 -crf 21 -vf " + "\u0022" + "transpose=3" + "\u0022" + " -c:a aac -b:a 128K % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr13 + " & -c:v libx264 -crf 21 -vf " + "\u0022" + "transpose=2, transpose=2" + "\u0022" + " -c:a aac -b:a 128K % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr14 + " & -map 0 -c copy -sn % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr15 + " & -vn -c:a flac -ar 44100 -sample_fmt s16 -ac 2 % flac" + Environment.NewLine + "PR: " + Properties.Strings2.pr16 + " & -c:v copy -c:a libmp3lame -qscale:a 0 -ac 2  % mp3" + Environment.NewLine + "PR: " + Properties.Strings2.pr17 + " & -vn -c:a libmp3lame -qscale:a 1 -ac 2 % mp3" + Environment.NewLine + "PR: " + Properties.Strings2.pr18 + " & -vn -c:a libmp3lame -b:a 224K -ac 2 % mp3" + Environment.NewLine + "PR: " + Properties.Strings2.pr19 + " & -vn -c:a pcm_s16le -ar 44100 -sample_fmt s16 -ac 2 % wav" + Environment.NewLine + "PR: " + Properties.Strings2.pr20 + " & -map 0:2 -c:s copy % srt" + Environment.NewLine + "PR: " + Properties.Strings2.pr21 + " & -vframes 1 -f image2  % png" + Environment.NewLine + "PR: " + Properties.Strings2.pr21_2 + " & -map 0 -c:v h264_amf -rc cqp -qp_p 20 -qp_i 20 -qp_b 20 -c:a copy % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr21_21 + " & -map 0 -c:v hevc_amf -rc cqp -qp_p 20 -qp_i 20 -qp_b 20 -c:a copy % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr22 + " & -r 24 -c:a aac -b:a 128K % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr23 + " & -r 15 -vf scale=1280x720 -c:a aac -b:a 128K % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr24 + " & -c:v h264_nvenc -qp 20 -r 30 -c:a aac -b:a 128K % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr25 + " & -c:v  h264_qsv -qp 20 -r 25 -c:a aac -b:a 128K % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr26 + " & -c:v libx264 -preset veryfast -vf " + '\u0022' + "fps=25,format=yuv420p,scale=1920:-2" + '\u0022' + " -c:a aac -b:a 64K % mp4");
                btn_load_config.PerformClick();
            }

            set_font_size();

            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            if (Properties.Settings.Default.dark_mode == true)
            {
                pic_frame.Image = img_list_pic_thumb.Images[1];
                pic_frame.InitialImage = img_list_pic_thumb.Images[1];
            }

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;

                this.InvokeEx(f => f.combo_ext_m3u.SelectedIndex = 0);
                this.InvokeEx(f => f.chk_subfolders.FlatAppearance.CheckedBackColor = Color.FromArgb(255, 225, 235, 251));
                this.InvokeEx(f => f.combo_ext.SelectedIndex = 0);
                this.InvokeEx(f => f.Combo_def_sub_mux.SelectedIndex = 0);
                this.InvokeEx(f => f.Combo_ext_sub_mux.SelectedIndex = 0);
                this.InvokeEx(f => f.notifyIcon1.Visible = false);
                this.InvokeEx(f => f.listView1.LabelWrap = true);
                this.InvokeEx(f => f.combo_vin_col.SelectedIndex = 0);
                this.InvokeEx(f => f.combo_vout_color.SelectedIndex = 0);
                this.InvokeEx(f => f.combo_shut.SelectedIndex = 0);
            }).Start();

            is_ff_ok = true;
            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;
                Thread.Sleep(85);
                for (int i = Application.OpenForms.Count - 1; i >= 0; i--)
                {
                    if (Application.OpenForms[i].Name == "Form6")
                    {
                        this.InvokeEx(f => Application.OpenForms[i].Close());
                        break;
                    }
                }
            }).Start();

            String ffm = Path.Combine(Application.StartupPath, "ffmpeg.exe");
            if (!File.Exists(ffm))
            {
                this.Enabled = false;
                var a = MessageBox.Show(FFBatch.Properties.Strings.ff_not_f, FFBatch.Properties.Strings.file_not_f, MessageBoxButtons.YesNo, MessageBoxIcon.Warning);
                if (a == DialogResult.No)
                {
                    Application.Exit();
                    return;
                }
                if (a == DialogResult.Yes)
                {
                    obtain_ffmpeg();
                    if (is_ff_ok == false)
                    {
                        Application.Exit();
                    }
                    else
                    {
                        is_ff_ok = true;
                        this.Enabled = true;
                    }
                }
            }
            else
            {
                if (check_ff_md5() == false)
                {
                    Form25 frm25 = new Form25();
                    frm25.ShowDialog();
                    return;
                }
            }

            String ffm3 = System.IO.Path.Combine(Application.StartupPath, "mediainfo.exe");
            if (!File.Exists(ffm3))
            {
                this.Enabled = false;
                var a = MessageBox.Show(FFBatch.Properties.Strings.med_not_f, FFBatch.Properties.Strings.file_not_f, MessageBoxButtons.YesNo, MessageBoxIcon.Warning);
                if (a == DialogResult.No) Application.Exit();
                if (a == DialogResult.Yes)
                {
                    obtain_mediainfo();
                    if (is_ff_ok == false)
                    {
                        Application.Exit();
                    }
                    else
                    {
                        is_ff_ok = true;
                        this.Enabled = true;
                    }
                }
            }

            //FFmpeg version

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;
                try
                {
                    this.InvokeEx(f => f.change_ff.Text = FFBatch.Properties.Strings.loading1);
                    Process proc_v = new Process();
                    proc_v.StartInfo.FileName = Path.Combine(Application.StartupPath, "ffmpeg.exe");
                    proc_v.StartInfo.Arguments = "-version";

                    proc_v.StartInfo.RedirectStandardOutput = true;
                    proc_v.StartInfo.RedirectStandardError = true;
                    proc_v.StartInfo.UseShellExecute = false;
                    proc_v.StartInfo.CreateNoWindow = true;
                    proc_v.EnableRaisingEvents = true;

                    proc_v.Start();
                    String arch = String.Empty;
                    Boolean is_32 = false;
                    if (Environment.Is64BitProcess == false)
                    {
                        is_32 = true;
                        arch = "x86";
                    }
                    else
                    {
                        if ((Environment.OSVersion.Version.Major > 5) || ((Environment.OSVersion.Version.Major == 5) && (Environment.OSVersion.Version.Minor >= 1)))
                        {
                            NativeMethods.IsWow64Process(proc_v.Handle, out is_32);
                            if (is_32 == true) arch = "x86";
                            else
                            {
                                arch = "x64";
                            }
                        }
                    }
                    ff_ver_proc = proc_v.Id;

                    String err_txt = String.Empty;
                    err_txt = proc_v.StandardOutput.ReadLine();
                    if (err_txt != null)
                    {
                        err_txt = err_txt.Substring(0, err_txt.IndexOf("Copyright"));
                        err_txt = err_txt.Replace("ff", "FF");
                        err_txt = err_txt.Replace("_build-www.gyan.dev", "");
                        err_txt = err_txt.Replace("-full", " Full");
                        err_txt = err_txt.Replace("-essentials", " Essentials");

                        if (err_txt.Length >= 42)
                        {
                            this.InvokeEx(f => f.change_ff.Text = err_txt.Substring(0, 42) + " " + arch);
                        }
                        else
                        {
                            this.InvokeEx(f => f.change_ff.Text = err_txt + " " + arch);
                        }
                    }
                }
                catch
                {
                    this.InvokeEx(f => f.change_ff.Text = FFBatch.Properties.Strings.ver_ff_u);
                }
            }).Start();

            combo_vin_col.SelectedIndex = 0;
            combo_vout_color.SelectedIndex = 0;

            //End FFmpeg version

            watch_ff.Path = Application.StartupPath;

            //Automatic update

            String f_updates = String.Empty;
            if (is_portable == false)
            {
                f_updates = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_updates.ini";
            }
            else
            {
                f_updates = port_path + "ff_updates_portable.ini";
            }
            if (!File.Exists(f_updates))
            {
                chk_auto_updates.Checked = true;
                check_back_updates();
            }
            else
            {
                chk_auto_updates.Checked = false;
            }
            Pg1.Focus();
            //End automatic updates

            btn_update.Text = Properties.Strings2.version + " " + Application.ProductVersion;
            remember_tab();

            String save_path_queue = Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "saved_queue_temp.ffq";
            if (is_portable == true) save_path_queue = port_path + "saved_queue_temp.ffq";
            if (File.Exists(save_path_queue))
            {
                var a = MessageBox.Show(FFBatch.Properties.Strings.saved_qu, FFBatch.Properties.Strings.queue_temp, MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                if (a == DialogResult.No)
                {
                    try
                    {
                        File.Delete(save_path_queue);
                    }
                    catch
                    {
                    }
                }
                if (a == DialogResult.Yes)
                {
                    int linea = 0;
                    int not_found = 0;
                    combo_presets.Text = "";
                    this.Cursor = Cursors.WaitCursor;
                    List<ListViewItem> itemsToAdd = new List<ListViewItem>();
                    try
                    {
                        foreach (string line in File.ReadLines(save_path_queue))
                        {
                            if (linea == 0)
                            {
                                txt_parameters.Text = line;
                            }
                            if (linea == 1)
                            {
                                txt_format.Text = line;
                            }

                            if (linea == 2)
                            {
                                if (line == "Unchecked") checkBox1.CheckState = CheckState.Unchecked;
                                else checkBox1.CheckState = CheckState.Checked;
                            }

                            if (linea == 3)
                            {
                                if (line == "Unchecked") chk_suffix.CheckState = CheckState.Unchecked;
                                else
                                {
                                    chk_suffix.CheckState = CheckState.Checked;
                                    txt_suffix.Text = line;
                                }
                            }

                            if (linea == 4)
                            {
                                txt_path_main.Text = line;
                            }

                            if (linea > 4)
                            {
                                Boolean missing = false;
                                listView1.SmallImageList = imageList2;

                                itemsToAdd.Add(new ListViewItem(Path.GetFileName(line.Substring(0, line.LastIndexOf(" --0 "))), 1));
                                //ListViewItem elemento = new ListViewItem(line.Substring(0, line.LastIndexOf(" --0 ")), 1);
                                //Begin get file icon
                                Icon iconForFile = SystemIcons.WinLogo;

                                // Check to see if the image collection contains an image
                                // for this extension, using the extension as a key.
                                if (File.Exists(line.Substring(0, line.LastIndexOf(" --0 "))))
                                {
                                    if (!imageList2.Images.ContainsKey(System.IO.Path.GetExtension(line.Substring(0, line.LastIndexOf(" --0 ")))))
                                    {
                                        // If not, add the image to the image list.
                                        iconForFile = System.Drawing.Icon.ExtractAssociatedIcon(line.Substring(0, line.LastIndexOf(" --0 ")));
                                        imageList2.Images.Add(System.IO.Path.GetExtension(line.Substring(0, line.LastIndexOf(" --0 "))), iconForFile);
                                    }

                                    //listView1.Items.Add(elemento);
                                    itemsToAdd[linea - 5].ImageKey = System.IO.Path.GetExtension(System.IO.Path.GetExtension(line.Substring(0, line.LastIndexOf(" --0 "))));
                                }
                                else
                                {
                                    not_found = not_found + 1;
                                    missing = true;
                                }

                                //listView1.Items.Add(line.Substring(0,line.LastIndexOf(" --0 ")));
                                String type = line.Substring(line.LastIndexOf(" --0 ") + 5, line.Length - (line.LastIndexOf(" --0") + 5));
                                type = type.Substring(0, type.LastIndexOf(" --1"));
                                String dur = line.Substring(line.LastIndexOf(" --1 ") + 5, line.Length - (line.LastIndexOf(" --1") + 5));
                                dur = dur.Substring(0, dur.LastIndexOf(" --2"));
                                String size = line.Substring(line.LastIndexOf(" --2 ") + 5, line.Length - (line.LastIndexOf(" --2") + 5));
                                size = size.Substring(0, size.LastIndexOf(" --3"));
                                String status = line.Substring(line.LastIndexOf(" --3 ") + 5, line.Length - (line.LastIndexOf(" --3") + 5));

                                itemsToAdd[linea - 5].SubItems.Add(Path.GetDirectoryName(line.Substring(0, line.LastIndexOf(" --0 "))));
                                itemsToAdd[linea - 5].SubItems.Add(type);
                                itemsToAdd[linea - 5].SubItems.Add(dur);
                                itemsToAdd[linea - 5].SubItems.Add(size);
                                if (missing == false) itemsToAdd[linea - 5].SubItems.Add(status);
                                else
                                {
                                    itemsToAdd[linea - 5].SubItems.Add(FFBatch.Properties.Strings.file_not_f);
                                    itemsToAdd[linea - 5].BackColor = Color.LightGoldenrodYellow;
                                }
                            }
                            linea = linea + 1;
                        }
                        listView1.Items.AddRange(itemsToAdd.ToArray());
                    }
                    catch (Exception excpt)
                    {
                        this.Cursor = Cursors.Arrow;
                        MessageBox.Show(FFBatch.Properties.Strings.err_qf + Environment.NewLine + excpt.Message, Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        btn_load_config.PerformClick();
                        read_saved_path();
                        return;
                    }
                    foreach (ListViewItem item in listView1.Items)
                    {
                        if (item.SubItems[5].Text == FFBatch.Properties.Strings.error) item.BackColor = Color.Orange;
                    }

                    this.Cursor = Cursors.Arrow;

                    calc_list_size();
                    calc_total_dur();
                    lbl_items.Text = listView1.Items.Count.ToString() + " " + FFBatch.Properties.Strings.files;

                    if (not_found > 0)
                    {
                        this.Cursor = Cursors.Arrow;
                        MessageBox.Show(FFBatch.Properties.Strings2.queue_warn + Environment.NewLine + not_found.ToString() + " " + FFBatch.Properties.Strings2.queue_not_f + " " + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings2.sort_status + ".", FFBatch.Properties.Strings.warning, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    }
                    return;
                }
            }
            //End program crashed
            btn_load_config.PerformClick();

            //Sendto parameters

            String[] arguments = Environment.GetCommandLineArgs();
            String[] file_drop = arguments.Skip(1).ToArray();
            Boolean no_tab_change = false;
            if (file_drop.Count() != 0)
            {
                show_wiz_start = false;
                change_tab_1 = false;
                change_tab_2 = false;
                no_tab_change = true;
                this.Cursor = Cursors.WaitCursor;

                int fl = 0;
                List<string> files2 = new List<string>();

                int num_drop = 0;
                if (file_drop.Count() == 1 && Path.GetExtension(file_drop[0]) == ".ffq")
                //Load queue file
                {
                    int linea = 0;
                    int not_found = 0;
                    combo_presets.Text = "";
                    List<ListViewItem> itemsToAdd = new List<ListViewItem>();
                    try
                    {
                        foreach (string line in File.ReadLines(file_drop[0]))
                        {
                            if (linea == 0)
                            {
                                txt_parameters.Text = line;
                            }
                            if (linea == 1)
                            {
                                txt_format.Text = line;
                            }

                            if (linea == 2)
                            {
                                if (line == "Unchecked") checkBox1.CheckState = CheckState.Unchecked;
                                else checkBox1.CheckState = CheckState.Checked;
                            }

                            if (linea == 3)
                            {
                                if (line == "Unchecked") chk_suffix.CheckState = CheckState.Unchecked;
                                else
                                {
                                    chk_suffix.CheckState = CheckState.Checked;
                                    txt_suffix.Text = line;
                                }
                            }

                            if (linea == 4)
                            {
                                txt_path_main.Text = line;
                            }

                            if (linea > 4)
                            {
                                Boolean missing = false;
                                listView1.SmallImageList = imageList2;

                                itemsToAdd.Add(new ListViewItem(Path.GetFileName(line.Substring(0, line.LastIndexOf(" --0 "))), 1));
                                //ListViewItem elemento = new ListViewItem(line.Substring(0, line.LastIndexOf(" --0 ")), 1);
                                //Begin get file icon
                                Icon iconForFile = SystemIcons.WinLogo;

                                // Check to see if the image collection contains an image
                                // for this extension, using the extension as a key.
                                if (File.Exists(line.Substring(0, line.LastIndexOf(" --0 "))))
                                {
                                    if (!imageList2.Images.ContainsKey(System.IO.Path.GetExtension(line.Substring(0, line.LastIndexOf(" --0 ")))))
                                    {
                                        // If not, add the image to the image list.
                                        iconForFile = System.Drawing.Icon.ExtractAssociatedIcon(line.Substring(0, line.LastIndexOf(" --0 ")));
                                        imageList2.Images.Add(System.IO.Path.GetExtension(line.Substring(0, line.LastIndexOf(" --0 "))), iconForFile);
                                    }

                                    //listView1.Items.Add(elemento);
                                    itemsToAdd[linea - 5].ImageKey = System.IO.Path.GetExtension(System.IO.Path.GetExtension(line.Substring(0, line.LastIndexOf(" --0 "))));
                                }
                                else
                                {
                                    not_found = not_found + 1;
                                    missing = true;
                                }

                                //listView1.Items.Add(line.Substring(0,line.LastIndexOf(" --0 ")));
                                String type = line.Substring(line.LastIndexOf(" --0 ") + 5, line.Length - (line.LastIndexOf(" --0") + 5));
                                type = type.Substring(0, type.LastIndexOf(" --1"));
                                String dur = line.Substring(line.LastIndexOf(" --1 ") + 5, line.Length - (line.LastIndexOf(" --1") + 5));
                                dur = dur.Substring(0, dur.LastIndexOf(" --2"));
                                String size = line.Substring(line.LastIndexOf(" --2 ") + 5, line.Length - (line.LastIndexOf(" --2") + 5));
                                size = size.Substring(0, size.LastIndexOf(" --3"));
                                String status = line.Substring(line.LastIndexOf(" --3 ") + 5, line.Length - (line.LastIndexOf(" --3") + 5));

                                itemsToAdd[linea - 5].SubItems.Add(Path.GetDirectoryName(line.Substring(0, line.LastIndexOf(" --0 "))));
                                itemsToAdd[linea - 5].SubItems.Add(type);
                                itemsToAdd[linea - 5].SubItems.Add(dur);
                                itemsToAdd[linea - 5].SubItems.Add(size);
                                if (missing == false) itemsToAdd[linea - 5].SubItems.Add(status);
                                else
                                {
                                    itemsToAdd[linea - 5].SubItems.Add(FFBatch.Properties.Strings.file_not_f);
                                    itemsToAdd[linea - 5].BackColor = Color.LightGoldenrodYellow;
                                }
                            }
                            linea = linea + 1;
                        }
                        listView1.Items.AddRange(itemsToAdd.ToArray());
                    }
                    catch (Exception excpt)
                    {
                        this.Cursor = Cursors.Arrow;
                        MessageBox.Show(FFBatch.Properties.Strings.err_qf + Environment.NewLine + excpt.Message, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        btn_load_config.PerformClick();
                        read_saved_path();
                        return;
                    }

                    this.Cursor = Cursors.Arrow;
                    calc_list_size();
                    calc_total_dur();
                    lbl_items.Text = listView1.Items.Count.ToString() + " " + FFBatch.Properties.Strings.files;

                    if (not_found > 0)
                    {
                        this.Cursor = Cursors.Arrow;
                        MessageBox.Show(FFBatch.Properties.Strings.queue_ok + Environment.NewLine + not_found.ToString() + " " + FFBatch.Properties.Strings2.queue_not_f + " " + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings2.sort_status + " " + '\u0022' + FFBatch.Properties.Strings.file_not_f + '\u0022' + ".", Properties.Strings2.missing_f, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    }
                    this.Cursor = Cursors.Arrow;
                    return;
                }

                if (file_drop.Count() == 1 && Path.GetExtension(file_drop[0]) == ".txt")
                {
                    int not_found = 0;
                    int linea = 0;

                    List<ListViewItem> itemsToAdd = new List<ListViewItem>();

                    foreach (string line in File.ReadLines(file_drop[0]))
                    {
                        Boolean missing = false;
                        itemsToAdd.Add(new ListViewItem(Path.GetFileName(line)));
                        if (File.Exists(line))
                        {
                            listView1.SmallImageList = imageList2;

                            Icon iconForFile = SystemIcons.WinLogo;

                            if (!imageList2.Images.ContainsKey(System.IO.Path.GetExtension(line)))
                            {
                                // If not, add the image to the image list.
                                iconForFile = System.Drawing.Icon.ExtractAssociatedIcon(line);
                                imageList2.Images.Add(System.IO.Path.GetExtension(line), iconForFile);
                            }

                            //listView1.Items.Add(elemento);
                            itemsToAdd[linea].ImageKey = System.IO.Path.GetExtension(System.IO.Path.GetExtension(line));
                        }
                        else
                        {
                            not_found = not_found + 1;
                            missing = true;
                        }

                        if (File.Exists(line)) itemsToAdd[linea].SubItems.Add(Path.GetDirectoryName(line));
                        else itemsToAdd[linea].SubItems.Add(Properties.Strings.pending);
                        itemsToAdd[linea].SubItems.Add(Properties.Strings.pending);
                        itemsToAdd[linea].SubItems.Add(Properties.Strings.pending);
                        itemsToAdd[linea].SubItems.Add(Properties.Strings.pending);
                        itemsToAdd[linea].SubItems.Add(Properties.Strings.pending);

                        linea = linea + 1;
                    }
                    listView1.Items.AddRange(itemsToAdd.ToArray());
                    //btn_refresh.PerformClick();

                    this.Cursor = Cursors.Arrow;
                    calc_list_size();
                    calc_total_dur();
                    lbl_items.Text = listView1.Items.Count.ToString() + " " + FFBatch.Properties.Strings.files;

                    if (not_found > 0)
                    {
                        this.Cursor = Cursors.Arrow;
                        MessageBox.Show(FFBatch.Properties.Strings2.queue_warn + Environment.NewLine + not_found.ToString() + " " + FFBatch.Properties.Strings2.queue_not_f + " " + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings2.sort_status + ".", FFBatch.Properties.Strings.warning, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    }
                    else btn_refresh.PerformClick();
                    this.Cursor = Cursors.Arrow;
                    return;
                }

                //End load queue file
                Form11_2 frm11_2 = new Form11_2();
                Task t2 = Task.Run(() =>
                {
                    frm11_2.label1.Text = FFBatch.Properties.Strings.reading_path;
                    frm11_2.ShowDialog();
                });
                Thread.Sleep(100);

                foreach (String dropped in file_drop)
                {
                    if (File.Exists(dropped))
                    {
                        files2.Add(dropped);
                        num_drop = files2.Count;
                    }
                    else
                    {
                        if (Directory.Exists(dropped))
                        {
                            if (add_subfs == false)
                            {
                                foreach (String file in Directory.GetFiles(dropped))
                                {
                                    if (!File.GetAttributes(file).HasFlag(FileAttributes.Hidden))
                                    {
                                        files2.Add(file);
                                        fl = fl + 1;
                                        num_drop = num_drop + 1;
                                        if (frm11_2.abort_validate == true) return;
                                        else
                                        {
                                            try
                                            {
                                                frm11_2.Invoke(new MethodInvoker(delegate
                                                {
                                                    frm11_2.label2.Text = fl.ToString() + " " + FFBatch.Properties.Strings.files;
                                                }));
                                            }
                                            catch { }
                                        }
                                    }
                                }
                            }
                            else
                            {
                                try
                                {
                                    foreach (string f in Directory.GetFiles(dropped, "*.*", System.IO.SearchOption.AllDirectories))
                                    {
                                        if (!File.GetAttributes(f).HasFlag(FileAttributes.Hidden))
                                        {
                                            files2.Add(f);
                                            fl = fl + 1;
                                            num_drop = num_drop + 1;
                                            if (frm11_2.abort_validate == true)
                                            {
                                                this.Cursor = Cursors.Arrow;
                                                return;
                                            }
                                            else
                                            {
                                                try
                                                {
                                                    frm11_2.Invoke(new MethodInvoker(delegate
                                                    {
                                                        frm11_2.label2.Text = fl.ToString() + " " + FFBatch.Properties.Strings.files;
                                                    }));
                                                }
                                                catch { }
                                            }
                                        }
                                    }
                                }
                                catch (System.Exception excpt)
                                {
                                    try
                                    {
                                        frm11_2.Invoke(new MethodInvoker(delegate
                                        {
                                            frm11_2.TopMost = true;
                                            frm11_2.TopMost = false;
                                        }));
                                    }
                                    catch { }
                                    var a = MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message, FFBatch.Properties.Strings.error3, MessageBoxButtons.OK, MessageBoxIcon.Error);
                                    this.Cursor = Cursors.Arrow;
                                    return;
                                }
                            }
                        }
                    }
                }

                Thread.Sleep(100);
                try
                {
                    frm11_2.Invoke(new MethodInvoker(delegate
                    {
                        frm11_2.Dispose();
                    }));
                }
                catch { }

                files_to_add = files2;
                canceled_file_adding = false;
                btn_cancel_add.Enabled = true;
                btn_cancel_add.Visible = true;
                btn_cancel_add.Refresh();
                BG_Files.RunWorkerAsync();
                this.Cursor = Cursors.Arrow;

                //End Sendto files
            }
            //Remember last tab

            String f_remember = String.Empty;
            if (is_portable == false)
            {
                f_remember = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_remember.ini";
            }
            else
            {
                f_remember = port_path + "ff_remember_portable.ini";
            }

            if (File.Exists(f_remember))
            {
                remember_last_tab = true;
                if (no_tab_change == false) this.InvokeEx(f => f.tabControl1.SelectedIndex = Convert.ToInt16(File.ReadAllText(f_remember)));
            }
            else
            {
                remember_last_tab = false;
            }

            String f_show_wiz = String.Empty;
            if (is_portable == false)
            {
                f_show_wiz = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_show_wiz.ini";
            }
            else
            {
                f_show_wiz = port_path + "ff_show_wiz_portable.ini";
            }
            if (!File.Exists(f_show_wiz))
            {
                show_wiz = true;
                btn_wizard.PerformClick();
            }
            else show_wiz = false;

            if (yt_chk == false)
            {
                yt_chk = true;
                youtube_dl_ver();
            }
            //resize();
        }

        private void button10_Click_1(object sender, EventArgs e)
        {
            pic_title.Focus();

            Boolean writable = false;
            try
            {
                FileStream fs = File.Create(Path.Combine(Application.StartupPath, Path.GetRandomFileName()), 1, FileOptions.DeleteOnClose);
                writable = true;
            }
            catch
            {
                writable = false;
            }

            OpenFileDialog browse_file = new OpenFileDialog();
            String file_path = String.Empty;
            browse_file.Filter = "ffmpeg.exe |ffmpeg.exe";

            if (browse_file.ShowDialog() == DialogResult.OK)
            {
                file_path = browse_file.FileName;
                if (Path.GetFileName(file_path) != "ffmpeg.exe")
                {
                    MessageBox.Show(FFBatch.Properties.Strings.ff_not, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    change_ff.PerformClick();
                    return;
                }
            }
            else
            {
                return;
            }

            if (back_ff == true)
            {
                var a = MessageBox.Show(FFBatch.Properties.Strings.conf_bck, FFBatch.Properties.Strings.conf_bck2, MessageBoxButtons.YesNo, MessageBoxIcon.Question);

                if (a == DialogResult.Yes)
                {
                    FolderBrowserDialog f_back = new FolderBrowserDialog();
                    f_back.Description = FFBatch.Properties.Strings.select_p_ov;
                    f_back.ShowNewFolderButton = true;
                    if (f_back.ShowDialog() == DialogResult.OK)
                    {
                        back_ff = true;
                        try
                        {
                            File.Copy(Path.Combine(Application.StartupPath, "ffmpeg.exe"), Path.Combine(f_back.SelectedPath, "ffmpeg.exe"), false);
                        }
                        catch (Exception excpt)
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.err_bck + Environment.NewLine + excpt.Message, FFBatch.Properties.Strings.err_dest, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            return;
                        }
                    }
                    else
                    {
                        return;
                    }
                }
                else
                {
                    back_ff = false;
                }
            }

            String path = "cmd.exe";
            String param = "/C copy " + '\u0022' + file_path + '\u0022' + " " + '\u0022' + Application.StartupPath + '\u0022' + " / Y";
            Process ff_ext = new Process();
            ff_ext.StartInfo.FileName = path;
            ff_ext.StartInfo.Arguments = param;
            ff_ext.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;
            if (writable == false)
            {
                ff_ext.StartInfo.Verb = "runas";
                MessageBox.Show(FFBatch.Properties.Strings.allow_adm, FFBatch.Properties.Strings.adm_req, MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
            try
            {
                ff_ext.Start();
                ff_ext.WaitForExit();
            }
            catch
            {
                MessageBox.Show(FFBatch.Properties.Strings.err_dest, FFBatch.Properties.Strings.write_error, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }

            pic_title.Focus();
            //FFmpeg version

            change_ff.Text = FFBatch.Properties.Strings.loading1;
            Process proc_v = new Process();
            proc_v.StartInfo.FileName = Path.Combine(Application.StartupPath, "ffmpeg.exe");
            proc_v.StartInfo.Arguments = "-version";

            proc_v.StartInfo.RedirectStandardOutput = true;
            proc_v.StartInfo.RedirectStandardError = true;
            proc_v.StartInfo.UseShellExecute = false;
            proc_v.StartInfo.CreateNoWindow = true;
            proc_v.EnableRaisingEvents = true;
            try
            {
                proc_v.Start();
                proc_v.WaitForExit();

                Boolean is_32 = false;
                String arch = String.Empty;
                if ((Environment.OSVersion.Version.Major > 5)
                || ((Environment.OSVersion.Version.Major == 5) && (Environment.OSVersion.Version.Minor >= 1)))
                {
                    NativeMethods.IsWow64Process(proc_v.Handle, out is_32);
                    if (is_32 == true) arch = "x86";
                    else
                    {
                        arch = "x64";
                    }
                }
                String err_txt = String.Empty;
                err_txt = proc_v.StandardOutput.ReadLine();
                err_txt = err_txt.Substring(0, err_txt.IndexOf("Copyright"));
                err_txt = err_txt.Replace("ff", "FF");
                err_txt = err_txt.Replace("_build-www.gyan.dev", "");
                err_txt = err_txt.Replace("-full", " Full");
                err_txt = err_txt.Replace("-essentials", " Essentials");

                //err_txt = err_txt.Replace("gyan.dev", "");
                if (err_txt.Length >= 42)
                {
                    change_ff.Text = err_txt.Substring(0, 42) + " " + arch;
                }
                else
                {
                    change_ff.Text = err_txt + " " + arch;
                }
            }
            catch
            {
                MessageBox.Show(FFBatch.Properties.Strings.err_pars_ff, FFBatch.Properties.Strings.ff_error, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
            }

            if (check_ff_md5() == false)
            {
                Form25 frm25 = new Form25();
                frm25.ShowDialog();
                return;
            }
            //End FFmpeg version
        }

        private void checkBox3_CheckedChanged(object sender, EventArgs e)
        {
            Boolean prev_state = false;
            if (chk_open_compl.CheckState == CheckState.Checked) prev_state = false;
            if (chk_open_compl.CheckState == CheckState.Unchecked) prev_state = true;

            String path = String.Empty;
            if (is_portable == false)
            {
                path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.ini";
            }
            else
            {
                path = port_path + "ff_batch_portable.ini";
                if (!File.Exists(path)) reset_portable();
            }

            int linea = 0;

            foreach (string line in File.ReadLines(path))
            {
                linea = linea + 1;

                if (linea == 3)
                {
                    if (line == "Yes")
                    {
                        if (prev_state == false)
                        {
                            btn_save_config.ImageKey = "Save_settings_39.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.params_def);
                        }
                        else
                        {
                            btn_save_config.ImageKey = "save_pending.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.setting_mod);
                        }
                    }

                    if (line == "No")
                    {
                        if (prev_state == true)
                        {
                            btn_save_config.ImageKey = "Save_settings_39.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.params_def);
                        }
                        else
                        {
                            btn_save_config.ImageKey = "save_pending.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.setting_mod);
                        }
                    }
                }
            }
        }

        private void checkBox1_CheckedChanged(object sender, EventArgs e)
        {
            Boolean prev_state = false;
            if (checkBox1.CheckState == CheckState.Checked) prev_state = false;
            if (checkBox1.CheckState == CheckState.Unchecked) prev_state = true;

            String path = String.Empty;
            if (is_portable == false)
            {
                path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.ini";
            }
            else
            {
                path = port_path + "ff_batch_portable.ini";
            }

            int linea = 0;

            foreach (string line in File.ReadLines(path))
            {
                linea = linea + 1;

                if (linea == 6)
                {
                    if (line == "keep_yes")
                    {
                        if (prev_state == false)
                        {
                            btn_save_config.ImageKey = "Save_settings_39.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.params_def);
                        }
                        else
                        {
                            btn_save_config.ImageKey = "save_pending.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.setting_mod);
                        }
                    }

                    if (line == "keep_no")
                    {
                        if (prev_state == true)
                        {
                            btn_save_config.ImageKey = "Save_settings_39.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.params_def);
                        }
                        else
                        {
                            btn_save_config.ImageKey = "save_pending.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.setting_mod);
                        }
                    }
                }
            }
        }

        private void textBox1_TextChanged(object sender, EventArgs e)
        {
            btn_save_preset.Enabled = true;
            if (just_started5 == true) btn_save_preset.Enabled = false;
            just_started5 = false;
            btn_try_pr.Image = img_try.Images[0];
        }

        private void btn_exit_Click(object sender, EventArgs e)
        {
            Application.Exit();
        }

        private void combo_prio_Click(object sender, EventArgs e)
        {
            //Load priority

            String f_prio = String.Empty;
            if (is_portable == false)
            {
                f_prio = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_priority.ini";
            }
            else
            {
                f_prio = port_path + "ff_priority_portable.ini";
            }

            if (File.Exists(f_prio))
            {
                String saved_prio = File.ReadAllText(f_prio);
                if (saved_prio != String.Empty)
                {
                    current_prio = Convert.ToInt16(saved_prio);
                }
            }
            else
            {
                current_prio = 2;
            }

            //End load priority
        }

        private void cb_hwdecode_SelectedIndexChanged_1(object sender, EventArgs e)
        {
            int current_dcd = cb_hwdecode.SelectedIndex;
            String f_hw_dcd = String.Empty;
            if (is_portable == false)
            {
                f_hw_dcd = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_hw_dcd.ini";
            }
            else
            {
                f_hw_dcd = port_path + "ff_hw_dcd_portable.ini";
            }
            decoders.Clear();

            decoders.Add(cb_hwdecode.SelectedItem.ToString());

            String path_c = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch");
            if (is_portable == true) path_c = port_path;

            if (!Directory.Exists(path_c))
            {
                try
                {
                    Directory.CreateDirectory(path_c);
                    File.WriteAllText(f_hw_dcd, decoders[0]);
                }
                catch
                {
                }
            }
            else
            {
                try
                {
                    File.WriteAllText(f_hw_dcd, decoders[0]);
                }
                catch { }
            }
        }

        private void btn_ref_dcd_Click(object sender, EventArgs e)
        {
            cb_hwdecode.Items.Clear();
            String f_hw_dcd = String.Empty;
            if (is_portable == false)
            {
                f_hw_dcd = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_hw_dcd.ini";
            }
            else
            {
                f_hw_dcd = port_path + "ff_hw_dcd_portable.ini";
            }
            if (File.Exists(f_hw_dcd))
            {
                try
                {
                    File.Delete(f_hw_dcd);
                }
                catch
                {
                    MessageBox.Show(FFBatch.Properties.Strings.err_dec, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }

            cb_hwdecode.Items.Add("none");
            decoders.Add("none");
            cb_hwdecode.SelectedIndex = 0;
            String selected = cb_hwdecode.SelectedItem.ToString();
            hw_decoders = false;
            if (hw_decoders == false)
            {
                hw_decoders = true;

                //Read hardware decoders
                Process consola_hw = new Process();

                consola_hw.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");
                consola_hw.StartInfo.Arguments = " -hwaccels";
                consola_hw.StartInfo.RedirectStandardOutput = true;
                consola_hw.StartInfo.RedirectStandardError = true;
                consola_hw.StartInfo.UseShellExecute = false;
                consola_hw.StartInfo.CreateNoWindow = true;
                consola_hw.EnableRaisingEvents = true;

                String duracion = String.Empty;
                String std_out = String.Empty;
                consola_hw.Start();
                Boolean hw_found = false;

                while (!consola_hw.StandardOutput.EndOfStream)
                {
                    std_out = consola_hw.StandardOutput.ReadLine();

                    if (std_out.Contains("Hardware acceleration methods:"))
                    {
                        if (selected != "auto") cb_hwdecode.Items.Add("auto");
                        hw_found = true;
                        decoders.Add("auto");
                        continue;
                    }

                    if (hw_found == true && std_out != String.Empty && std_out != selected)
                    {
                        cb_hwdecode.Items.Add(std_out);
                        decoders.Add(std_out);
                    }
                }
                consola_hw.WaitForExit();
                consola_hw.Close();
                File.WriteAllLines(f_hw_dcd, decoders);
            }
        }

        private void btn_save_preset_Click(object sender, EventArgs e)
        {
            save_preset();
            combo_presets.SelectedIndex = combo_presets.Items.Count - 1;
            MessageBox.Show(FFBatch.Properties.Strings.pres_saved, FFBatch.Properties.Strings.saved, MessageBoxButtons.OK, MessageBoxIcon.Information);
            btn_load_config.PerformClick();
            combo_presets.SelectedIndex = combo_presets.Items.Count - 1;
        }

        private void save_preset()
        {
            if (txt_parameters.Text.Length < 6)
            {
                MessageBox.Show(FFBatch.Properties.Strings.params_short, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (combo_presets.Text == FFBatch.Properties.Strings.default_param)
            {
                btn_save_config.PerformClick();
                return;
            }
            if (combo_presets.Text == "")
            {
                MessageBox.Show(FFBatch.Properties.Strings.pres_empt);
                return;
            }
            if (combo_presets.SelectedIndex == 0)
            {
                return;
            }

            String path_d_pr = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_presets.ini";
            String path2_d_pr = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_presets2.txt";
            if (is_portable == true)
            {
                path_d_pr = port_path + "ff_presets_portable.ini";
                path2_d_pr = port_path + "ff_presets2.txt";
            }

            if (is_portable == false)
            {
                File.Create(System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_presets2.txt").Dispose();
            }
            else
            {
                File.Create(port_path + "ff_presets2.txt").Dispose();
            }

            int ind = 0;
            foreach (string line in File.ReadLines(path_d_pr))
            {
                ind = ind + 1;
                String linea_sin = String.Empty;

                if (!line.Contains("PR: "))
                {
                    linea_sin = line + Environment.NewLine;
                    File.AppendAllText(path2_d_pr, linea_sin);
                }

                if (line.LastIndexOf("&") >= 0)
                {
                    if (line.Substring(4, line.LastIndexOf("&") - 5) != combo_presets.Text)
                    {
                        if (ind <= File.ReadLines(path_d_pr).Count() - 1)
                        {
                            linea_sin = line + Environment.NewLine;
                            File.AppendAllText(path2_d_pr, linea_sin);
                        }
                        else
                        {
                            File.AppendAllText(path2_d_pr, line);
                        }
                    }
                }
            }
            File.Delete(path_d_pr);
            File.Copy(path2_d_pr, path_d_pr);
            File.Delete(path2_d_pr);
            System.Threading.Thread.Sleep(50);
            btn_save_preset.Enabled = false;

            String path_pr = "";
            if (is_portable == true) path_pr = port_path + "ff_presets_portable.ini";
            else path_pr = Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_presets.ini";

            String createText = "PR: " + combo_presets.Text + " & " + txt_parameters.Text + " % " + txt_format.Text;
            File.AppendAllText(path_pr, Environment.NewLine + createText);

            combo_presets.Items.Clear();
            combo_presets.Items.Add(FFBatch.Properties.Strings.default_param);
            String path2 = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.ini";
            if (is_portable == true) path2 = port_path + "ff_batch_portable.ini";
            int linea = 0;

            foreach (string line in File.ReadLines(path2))
            {
                linea = linea + 1;
                if (linea == 1)
                {
                    this.InvokeEx(f => f.txt_parameters.Text = line);
                    continue;
                }

                if (linea == 2)
                {
                    this.InvokeEx(f => f.txt_format.Text = line);
                    continue;
                }

                if (line == "Yes")

                {
                    this.InvokeEx(f => f.chk_open_compl.CheckState = CheckState.Checked);
                    continue;
                }

                if (line == "No")
                {
                    this.InvokeEx(f => f.chk_open_compl.CheckState = CheckState.Unchecked);
                    continue;
                }

                //if (linea == 4)
                //{
                if (line == "Vn")
                {
                    this.InvokeEx(f => f.chk_suffix.CheckState = CheckState.Unchecked);
                    continue;
                }
                if (line.Length > 1 && line.Substring(0, 2) == "Vs")
                {
                    this.InvokeEx(f => f.chk_suffix.CheckState = CheckState.Checked);
                    this.InvokeEx(f => f.txt_suffix.Text = line.Substring(3, line.Length - 3));
                    continue;
                }
                //}

                if (line == "grid_yes")
                {
                    this.InvokeEx(f => f.listView1.GridLines = true);
                    this.InvokeEx(f => f.listView2.GridLines = true);
                    this.InvokeEx(f => f.listView3.GridLines = true);
                    continue;
                }
                if (line == "grid_no")
                {
                    this.InvokeEx(f => f.listView1.GridLines = false);
                    this.InvokeEx(f => f.listView2.GridLines = false);
                    this.InvokeEx(f => f.listView3.GridLines = false);
                    continue;
                }

                if (line == "keep_yes")
                {
                    this.InvokeEx(f => f.checkBox1.CheckState = CheckState.Checked);
                    continue;
                }
                if (line == "keep_no")
                {
                    this.InvokeEx(f => f.checkBox1.CheckState = CheckState.Unchecked);
                    continue;
                }

                if (line == "subf_yes")
                {
                    this.InvokeEx(f => f.chk_subfolders.CheckState = CheckState.Checked);
                    add_subfs = true;
                    continue;
                }
                if (line == "subf_no")
                {
                    this.InvokeEx(f => f.chk_subfolders.CheckState = CheckState.Unchecked);
                    add_subfs = false;
                    continue;
                }
            }

            if (File.Exists(path_pr) == true)
            {
                foreach (string line in File.ReadLines(path_pr))
                {
                    if (line.Length > 8)
                    {
                        if (line.Substring(0, 7).ToLower() == "version")
                        {
                            txt_config_ver.Text = line.Substring(8, line.Length - 8);
                            continue;
                        }
                    }

                    if (line.Length > 4 && line.Substring(0, 4) == "PR: ")
                    {
                        this.InvokeEx(f => f.combo_presets.Items.Add(line.Substring(4, line.LastIndexOf("&") - 5)));
                    }
                }
            }
        }

        private void txt_format_TextChanged(object sender, EventArgs e)
        {
            btn_save_preset.Enabled = true;
            if (just_started5 == true) btn_save_preset.Enabled = false;
            just_started5 = false;
        }

        private void combo_presets_TextChanged(object sender, EventArgs e)
        {
            btn_save_preset.Enabled = true;
            if (combo_presets.Text == FFBatch.Properties.Strings.new_preset)
            {
                btn_save_config.ImageKey = "save_pending.png";
            }
        }

        private void textBox5_MouseClick(object sender, MouseEventArgs e)
        {
            Pg1.Focus();
        }

        private void cti4_2_Click(object sender, EventArgs e)
        {
            listView1.GridLines = !listView1.GridLines;
            listView2.GridLines = !listView2.GridLines;
            listView3.GridLines = !listView3.GridLines;

            Boolean prev_state = false;
            if (listView1.GridLines == true) prev_state = false;
            if (listView1.GridLines == false) prev_state = true;

            String path = String.Empty;
            if (is_portable == false)
            {
                path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.ini";
            }
            else
            {
                path = port_path + "ff_batch_portable.ini";
            }

            int linea = 0;

            foreach (string line in File.ReadLines(path))
            {
                linea = linea + 1;

                if (linea == 5)
                {
                    if (line == "grid_yes")
                    {
                        if (prev_state == false)
                        {
                            btn_save_config.ImageKey = "Save_settings_39.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.params_def);
                        }
                        else
                        {
                            btn_save_config.ImageKey = "save_pending.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.setting_mod);
                        }
                    }

                    if (line == "grid_no")
                    {
                        if (prev_state == true)
                        {
                            btn_save_config.ImageKey = "Save_settings_39.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.params_def);
                        }
                        else
                        {
                            btn_save_config.ImageKey = "save_pending.png";
                            toolTip_settings.SetToolTip(this.btn_save_config, FFBatch.Properties.Strings.setting_mod);
                        }
                    }
                }
            }
        }

        private void check_concat_CheckedChanged(object sender, EventArgs e)
        {
            String f_concat = String.Empty;
            if (is_portable == false)
            {
                f_concat = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_concat.ini";
            }
            else
            {
                f_concat = port_path + "ff_concat_portable.ini";
            }

            if (check_concat.Checked == false)
            {
                if (File.Exists(f_concat))
                {
                    try
                    {
                        File.Delete(f_concat);
                    }
                    catch
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
            }
            else
            {
                if (!File.Exists(f_concat))
                {
                    try
                    {
                        File.WriteAllText(f_concat, String.Empty);
                    }
                    catch
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
            }
        }

        private void btn_kf_Click(object sender, EventArgs e)
        {
            //Pg1.Focus();

            //if (listView1.Items.Count == 1)
            //{
            //    listView1.Items[0].Selected = true;
            //    listView1.Select();
            //}
            //if (listView1.SelectedIndices.Count != 1)
            //{
            //    MessageBox.Show(FFBatch.Properties.Strings.selkf, FFBatch.Properties.Strings.no_file);
            //    return;
            //}
            //String file_prueba = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;

            //txt_parameters.Text = "-vf select='eq(pict_type,PICT_TYPE_I)' -f null nul -vstats -vstats_file C:\\TEMP\\FFBatch_test\\vstats.log";
            //txt_format.Text = "nul";

            ////btn_seq.PerformClick();

            ////new System.Threading.Thread(() =>
            ////{
            ////    System.Threading.Thread.CurrentThread.IsBackground = true;

            //    this.InvokeEx(f => this.Cursor = Cursors.WaitCursor);

            //    Form frm_kf_wait = new Form();
            //    frm_kf_wait.Name = "";
            //    frm_kf_wait.Text = FFBatch.Properties.Strings.an_file;
            //    frm_kf_wait.Icon = this.Icon;
            //    frm_kf_wait.Height = 120;
            //    frm_kf_wait.Width = 267;
            //    frm_kf_wait.FormBorderStyle = FormBorderStyle.Fixed3D;
            //    frm_kf_wait.ControlBox = false;

            //    Label kf_wait = new Label();
            //    kf_wait.Top = 30;
            //    kf_wait.Left = 30;
            //    kf_wait.AutoSize = true;
            //    kf_wait.Text = FFBatch.Properties.Strings.an_file2;
            //    kf_wait.Parent = frm_kf_wait;
            //    frm_kf_wait.StartPosition = FormStartPosition.CenterScreen;
            //    //frm_kf_wait.Show();
            //    //kf_wait.Refresh();

            //    Form frm_kf = new Form();
            //    frm_kf.Name = "Keyframes";
            //    frm_kf.Text = "Keyframes";
            //    frm_kf.Icon = this.Icon;

            //    frm_kf.Height = 575;
            //    frm_kf.Width = 534;
            //    frm_kf.FormBorderStyle = FormBorderStyle.Fixed3D;
            //    frm_kf.MaximizeBox = false;
            //    frm_kf.MinimizeBox = false;

            //    var fuente_list = new System.Drawing.Font("Microsoft Sans Serif", 8, FontStyle.Regular);

            //    LB1_kf.Clear();
            //    LB1_kf.Items.Clear();
            //    LB1_kf.Parent = frm_kf;
            //    LB1_kf.Left = 20;
            //    LB1_kf.Top = 65;
            //    LB1_kf.Height = 425;
            //    LB1_kf.Width = 477;
            //    LB1_kf.Font = fuente_list;
            //    LB1_kf.Columns.Add(FFBatch.Properties.Strings.number, 58, HorizontalAlignment.Center);
            //    LB1_kf.Columns.Add(FFBatch.Properties.Strings.position, 248, HorizontalAlignment.Center);
            //    LB1_kf.Columns.Add(FFBatch.Properties.Strings.interval, 100, HorizontalAlignment.Center);
            //    LB1_kf.Activation = ItemActivation.OneClick;
            //    LB1_kf.FullRowSelect = true;
            //    LB1_kf.LabelEdit = true;
            //    LB1_kf.HeaderStyle = ColumnHeaderStyle.Nonclickable;
            //    LB1_kf.View = View.Details;
            //    LB1_kf.GridLines = true;

            //    TextBox titulo = new TextBox();
            //    titulo.Parent = frm_kf;
            //    titulo.Top = 15;
            //    titulo.Left = 20;
            //    titulo.Width = 476;
            //    titulo.TabIndex = 0;
            //    var fuente = new System.Drawing.Font("Microsoft Sans Serif", 11, FontStyle.Bold);

            //    titulo.Font = fuente;
            //    titulo.BorderStyle = BorderStyle.Fixed3D;
            //    titulo.TextAlign = HorizontalAlignment.Center;
            //    titulo.ReadOnly = true;

            //    titulo.Text = FFBatch.Properties.Strings.show_kf;

            //    Button boton_kf_close = new Button();
            //    boton_kf_close.Parent = frm_kf;
            //    boton_kf_close.Left = 443;
            //    boton_kf_close.Top = 495;
            //    boton_kf_close.Width = 55;
            //    boton_kf_close.Height = 26;
            //    boton_kf_close.Text = FFBatch.Properties.Strings.close;
            //    boton_kf_close.Click += new EventHandler(boton_kf_close_Click);

            //    Button boton_set_start = new Button();
            //    boton_set_start.Parent = frm_kf;
            //    boton_set_start.Left = 79;
            //    boton_set_start.Top = 495;
            //    boton_set_start.Width = 176;
            //    boton_set_start.Height = 26;
            //    boton_set_start.Text = FFBatch.Properties.Strings.set_st;
            //    boton_set_start.Click += new EventHandler(boton_set_start_Click);

            //    Button boton_set_end = new Button();
            //    boton_set_end.Parent = frm_kf;
            //    boton_set_end.Left = 260;
            //    boton_set_end.Top = 495;
            //    boton_set_end.Width = 176;
            //    boton_set_end.Height = 26;
            //    boton_set_end.Text = FFBatch.Properties.Strings.set_end;
            //    boton_set_end.Click += new EventHandler(boton_set_end_Click);

            //    Button boton_copy_kf = new Button();
            //    boton_copy_kf.Parent = frm_kf;
            //    boton_copy_kf.Left = 20;
            //    boton_copy_kf.Top = 495;
            //    boton_copy_kf.Width = 55;
            //    boton_copy_kf.Height = 26;
            //    boton_copy_kf.Text = FFBatch.Properties.Strings.copy;
            //    boton_copy_kf.Click += new EventHandler(boton_copy_kf_Click);

            //    Process consola = new Process();

            //    String fichero = Path.GetFileName(file_prueba);
            //    TextBox titulo2 = new TextBox();
            //    titulo2.Parent = frm_kf;
            //    titulo2.Top = 42;
            //    titulo2.Left = 20;
            //    titulo2.Width = 476;

            //    var fuente2 = new System.Drawing.Font("Microsoft Sans Serif", 10, FontStyle.Regular);

            //    titulo2.Font = fuente2;
            //    titulo2.BorderStyle = BorderStyle.None;
            //    titulo2.TextAlign = HorizontalAlignment.Center;
            //    titulo2.ReadOnly = true;

            //    titulo2.Text = Path.GetFileName(file_prueba);

            //    frm_kf.StartPosition = FormStartPosition.CenterScreen;

            //    Decimal promed = 0;
            //    Decimal prev = 0;
            //    int keyframes = 0;
            //    int prev_keys = 0;
            //    consola.StartInfo.FileName = Path.Combine(Application.StartupPath, "ffmpeg.exe");
            //    String k_item = String.Empty;
            //    String temp = Path.GetTempPath().Replace(":\\", "\\\\" + ":" + "/");

            //    temp = temp.Substring(0, temp.Length - 1);
            //    String file2 = temp + "//\\" + "FFBatch_test" + "//\\" + "vstats.log";
            //    //file2 = file2.Replace("\\", "\\\\");
            //    file2 = file2.Replace(":\\", "\\\\" + ":");

            //    file2 = "C\\\\:/TEMP/FFBatch_test/vstats.log";

            //    //String ffpr_key = " -vf " + "select=eq(pict_type,PICT_TYPE_I)'" + " -f null nul -vstats -vstats_file " + file2;
            //    String ffpr_key = "-vf select='eq(pict_type,PICT_TYPE_I)' -f null nul -vstats -vstats_file C:\\TEMP\\FFBatch_test\\vstats.log";

            //foreach (String line in File.ReadLines("C:\\TEMP\\FFBatch_test\\vstats.log"))
            //{
            //    int pos2 = line.IndexOf("br=");
            //    int pos1 = line.IndexOf("time=");
            //    int length = pos2 - pos1;
            //    String item = line.Substring(line.IndexOf("time=") + 6, length - 6).Trim();

            //    Double seconds_d = Convert.ToDouble(item);
            //    TimeSpan t = TimeSpan.FromMilliseconds(seconds_d);
            //    item = string.Format("{0:D2}:{1:D2}:{2:D2}.{3:D3}",
            //                 (int)t.TotalHours,
            //                 t.Minutes,
            //                 t.Seconds,
            //                 t.Milliseconds);

            //    LB1_kf.Items.Add(item);
            //}

            ////consola.StartInfo.Arguments = '\u0022' + file_prueba + '\u0022' + ffpr_key;

            ////consola.StartInfo.RedirectStandardOutput = true;
            ////consola.StartInfo.RedirectStandardError = true;
            ////consola.StartInfo.UseShellExecute = false;
            ////consola.StartInfo.CreateNoWindow = true;
            ////consola.EnableRaisingEvents = true;

            ////    consola.Start();

            ////k_item = consola.StandardOutput.ReadLine();
            ////if (k_item.Contains("K"))
            ////{
            ////    Decimal number = 0;
            ////    String interval2 = String.Empty;
            ////    if (LB1_kf.Items.Count > 0)
            ////    {
            ////        Decimal interval = Convert.ToDecimal(k_item.Substring(0, k_item.Length - 6));

            ////        if (LB1_kf.Items[prev_keys].Text != String.Empty)
            ////        {
            ////            interval2 = Regex.Match(LB1_kf.Items[prev_keys].SubItems[1].Text, @"(\d+(\.\d+)?)|(\.\d+)").Value;
            ////            number = Convert.ToDecimal(interval2);

            ////        }
            ////        prev = interval - number;
            ////        prev_keys = prev_keys + 1;
            ////        LB1_kf.Items.Add(keyframes.ToString());
            ////        LB1_kf.Items[keyframes].SubItems.Add(k_item.Substring(0, k_item.Length - 6) + " " + FFBatch.Properties.Strings.seconds);
            ////        if (System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator == ".")
            ////        {
            ////            LB1_kf.Items[keyframes].SubItems.Add(prev.ToString() + " s.");
            ////        }
            ////        else
            ////        {
            ////            LB1_kf.Items[keyframes].SubItems.Add(prev.ToString() + " ms.");
            ////        }
            ////    }
            ////    else
            ////    {
            ////        LB1_kf.Items.Add(keyframes.ToString());
            ////        LB1_kf.Items[keyframes].SubItems.Add(k_item.Substring(0, k_item.Length - 6) + " " + FFBatch.Properties.Strings.seconds + ".");
            ////        LB1_kf.Items[keyframes].SubItems.Add("");
            ////    }
            ////    keyframes = keyframes + 1;

            ////    promed = promed + prev;
            ////}

            ////consola.WaitForExit();

            ////    if (System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator == ".")
            ////    {
            ////        LB1_kf.Items.Add("");
            ////        LB1_kf.Items.Add("");
            ////        LB1_kf.Items[keyframes + 1].SubItems.Add(FFBatch.Properties.Strings.avg_keyf);
            ////        int l = (promed / (keyframes - 1)).ToString().Length;
            ////        if (l > 9)
            ////        {
            ////            LB1_kf.Items[keyframes + 1].SubItems.Add((promed / (keyframes - 1)).ToString().Substring(0, 5) + " s");
            ////        }
            ////        else
            ////        {
            ////            LB1_kf.Items[keyframes + 1].SubItems.Add((promed / (keyframes - 1)).ToString());
            ////        }
            ////    }
            ////    else
            ////    {
            ////        LB1_kf.Items.Add("");
            ////        LB1_kf.Items.Add("");
            ////        LB1_kf.Items[keyframes + 1].SubItems.Add(FFBatch.Properties.Strings.avg_keyf);
            ////        int l = (promed / 1000 / (keyframes - 1)).ToString().Length;
            ////        if (l > 9)
            ////        {
            ////            LB1_kf.Items[keyframes + 1].SubItems.Add((promed / 1000 / (keyframes - 1)).ToString().Substring(0, 5) + " s");
            ////        }
            ////        else
            ////        {
            ////            LB1_kf.Items[keyframes + 1].SubItems.Add((promed / 1000 / (keyframes - 1)).ToString() + " s");
            ////        }

            ////    }
            ////    LB1_kf.TopItem = LB1_kf.Items[LB1_kf.Items.Count - 1];
            ////}
            ////catch (Exception excpt)
            ////{
            ////    MessageBox.Show(FFBatch.Properties.Strings.err_kf + Environment.NewLine + excpt.Message, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error); ;
            ////    return;
            ////}

            ////    this.InvokeEx(f => this.Enabled = false);
            ////frm_kf_wait.Close();
            //frm_kf.ShowDialog();
            ////this.InvokeEx(f => this.Cursor = Cursors.Arrow);
            ////this.InvokeEx(f => this.Enabled = true);

            ////}).Start();
        }

        private void boton_set_end_Click(object sender, EventArgs e)
        {
            if (LB1_kf.SelectedIndices.Count != 1) return;
            if (LB1_kf.SelectedIndices.Count == 1)
            {
                if (LB1_kf.SelectedItems[0].Text == String.Empty) return;
            }

            String dur = "";
            String seconds = LB1_kf.SelectedItems[0].SubItems[1].Text.Replace(" " + FFBatch.Properties.Strings.seconds, String.Empty).Replace(".", String.Empty);
            Double seconds_d = Convert.ToDouble(seconds);
            seconds_d = seconds_d / 1000;
            TimeSpan t = TimeSpan.FromSeconds(seconds_d);
            dur = string.Format("{0:D2}:{1:D2}:{2:D2}.{3:D3}",
                         (int)t.TotalHours,
                         t.Minutes,
                         t.Seconds,
                         t.Milliseconds);

            if (seconds_d / 1000 < 36000)
            {
                this.InvokeEx(f => f.txt_fin.Text = dur.Substring(1, dur.Length - 1));
            }
            else
            {
                this.InvokeEx(f => f.txt_fin.Text = dur);
            }
        }

        private void boton_kf_close_Click(object sender, EventArgs e)
        {
            ActiveForm.Close();
            this.InvokeEx(f => this.TopMost = true);
            this.InvokeEx(f => this.TopMost = false);
        }

        private void boton_set_start_Click(object sender, EventArgs e)
        {
            if (LB1_kf.SelectedIndices.Count != 1) return;
            if (LB1_kf.SelectedIndices.Count == 1)
            {
                if (LB1_kf.SelectedItems[0].Text == String.Empty) return;
            }

            String dur = "";
            String seconds = LB1_kf.SelectedItems[0].SubItems[1].Text.Replace(" " + FFBatch.Properties.Strings.seconds, String.Empty).Replace(".", String.Empty);
            Double seconds_d = Convert.ToDouble(seconds);
            seconds_d = seconds_d / 1000;
            TimeSpan t = TimeSpan.FromSeconds(seconds_d);
            dur = string.Format("{0:D2}:{1:D2}:{2:D2}.{3:D3}",
                         (int)t.TotalHours,
                         t.Minutes,
                         t.Seconds,
                         t.Milliseconds);

            if (seconds_d / 1000 < 36000)
            {
                this.InvokeEx(f => txt_ini.Text = dur.Substring(1, dur.Length - 1));
            }
            else
            {
                this.InvokeEx(f => txt_ini.Text = dur);
            }
        }

        private void chk_auto_updates_CheckedChanged(object sender, EventArgs e)
        {
            String f_updates = String.Empty;
            if (is_portable == false)
            {
                f_updates = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_updates.ini";
            }
            else
            {
                f_updates = port_path + "ff_updates_portable.ini";
            }

            if (chk_auto_updates.CheckState == CheckState.Checked)
            {
                if (File.Exists(f_updates))
                {
                    try
                    {
                        File.Delete(f_updates);
                    }
                    catch
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
            }
            else
            {
                if (!File.Exists(f_updates))
                {
                    try
                    {
                        File.WriteAllText(f_updates, String.Empty);
                    }
                    catch
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
            }
        }

        private void main_f_1_Click(object sender, EventArgs e)
        {
            btn_clear_list.PerformClick();
        }

        private void main_f_2_Click(object sender, EventArgs e)
        {
            btn_add_files.PerformClick();
        }

        private void main_f_3_Click(object sender, EventArgs e)
        {
            btn_add_folders.PerformClick();
        }

        private void menu_reload_settings_Click(object sender, EventArgs e)
        {
            btn_load_config.PerformClick();
        }

        private void menu_save_settings_Click(object sender, EventArgs e)
        {
            btn_save_config.PerformClick();
        }

        private void tryCurrentPresetToolStripMenuItem_Click(object sender, EventArgs e)
        {
            btn_try_pr.PerformClick();
        }

        private void openFfmpegConsoleToolStripMenuItem_Click(object sender, EventArgs e)
        {
            btn_show_console.PerformClick();
        }

        private void quickGuideToolStripMenuItem_Click(object sender, EventArgs e)
        {
            btn_help.PerformClick();
        }

        private void helpForumToolStripMenuItem_Click(object sender, EventArgs e)
        {
            Process.Start("https://forum.videohelp.com/threads/386028-FFmpeg-Batch-for-Windows");
        }

        private void checkForUpdateToolStripMenuItem_Click(object sender, EventArgs e)
        {
            btn_update.PerformClick();
        }

        private void menu_about_Click(object sender, EventArgs e)
        {
            Form2 form2 = new Form2();
            form2.StartPosition = FormStartPosition.CenterParent;
            form2.ShowDialog();
        }

        private void menu_settings_Click(object sender, EventArgs e)
        {
            pr_default.Text = txt_parameters.Text;
            form3.StartPosition = FormStartPosition.CenterParent;
            form3.lbl_ff_ver.Text = change_ff.Text.Replace("FFmpeg version", Properties.Strings2.version);
            form3.ff_ver = latest_ff;
            String current_lang = FFBatch.Properties.Settings.Default.app_lang;
            if (language == "en") form3.combo_lang.SelectedIndex = 0;
            if (language == "es") form3.combo_lang.SelectedIndex = 1;
            if (language == "it") form3.combo_lang.SelectedIndex = 2;
            if (language == "pt-BR") form3.combo_lang.SelectedIndex = 3;
            if (language == "zh-Hans") form3.combo_lang.SelectedIndex = 4;

            if (chk_open_compl.Checked) form3.check_open_output.Checked = true;
            else form3.check_open_output.Checked = false;

            Boolean current_dark = Properties.Settings.Default.dark_mode;

            form3.ShowDialog();

            if (form3.cancel == true)
            {
                FFBatch.Properties.Settings.Default.app_lang = current_lang;
                Properties.Settings.Default.dark_mode = current_dark;
                FFBatch.Properties.Settings.Default.Save();               
                return;
            }
                        
            if (Properties.Settings.Default.dark_mode == true)
            {
                foreach (Control c in this.Controls) UpdateColorDark(c);
                this.BackColor = Color.FromArgb(255, 64, 64, 64);
                post_dark();
                
            }
            else
            {
                foreach (Control c in this.Controls) UpdateColorDefault(c);
                this.BackColor = SystemColors.InactiveBorder;
                post_color_def();
            }

            if (Properties.Settings.Default.dark_mode != current_dark)
            {
                btn_clear_list.PerformClick(); //Refresh issues
                btn_refresh.PerformClick();
            }

            if (current_lang != form3.lang_set)
            {
                if (form3.combo_lang.SelectedIndex == 0) language = "en";
                if (form3.combo_lang.SelectedIndex == 1) language = "es";
                if (form3.combo_lang.SelectedIndex == 2) language = "it";
                if (form3.combo_lang.SelectedIndex == 3) language = "pt-BR";
                if (form3.combo_lang.SelectedIndex == 4) language = "zh-Hans";

                String f_lang = String.Empty;
                if (is_portable == false)
                {
                    f_lang = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_lang.ini";
                }
                else
                {
                    f_lang = port_path + "ff_lang_portable.ini";
                }

                if (File.Exists(f_lang))
                {
                    File.WriteAllText(f_lang, language);

                    FFBatch.Properties.Settings.Default.app_lang = language;
                    FFBatch.Properties.Settings.Default.Save();
                    init_lang();

                    btn_update.Text = Properties.Strings2.version + " " + Application.ProductVersion;
                }

                Create_Tooltips();
                load_priority();
                remove_custom_cols();
            }

            if (form3.edit_presets == true)
            {
                Form15 frm_pr = new Form15();
                frm_pr.ShowDialog();
                if (frm_pr.saved == true) btn_load_config.PerformClick();
                return;
            }
            if (form3.reset_asked == true)
            {
                menu_reset.PerformClick();
                return;
            }
            if (form3.cancel == true)
            {
                if (form3.reload_config == true) btn_load_config.PerformClick();
                return;
            }

            if (form3.recreate == true) checkBox1.CheckState = CheckState.Checked;
            else checkBox1.CheckState = CheckState.Unchecked;

            if (form3.check_open_c == true) chk_open_compl.CheckState = CheckState.Checked;
            else chk_open_compl.CheckState = CheckState.Unchecked;

            if (form3.suffix == true)
            {
                chk_suffix.CheckState = CheckState.Checked;
                txt_suffix.Enabled = true;
                txt_suffix.Text = form3.txt_suffix_str;
            }
            else
            {
                chk_suffix.CheckState = CheckState.Unchecked;
                txt_suffix.Text = "_FFB";
                txt_suffix.Enabled = false;
            }

            if (form3.subfolders == true) chk_subfolders.CheckState = CheckState.Checked;
            else chk_subfolders.CheckState = CheckState.Unchecked;

            if (form3.try_preset == true) chk_try.CheckState = CheckState.Checked;
            else chk_try.CheckState = CheckState.Unchecked;

            if (form3.updates == true) chk_auto_updates.CheckState = CheckState.Checked;
            else chk_auto_updates.CheckState = CheckState.Unchecked;

            if (form3.concat_filter == true) check_concat.CheckState = CheckState.Checked;
            else check_concat.CheckState = CheckState.Unchecked;

            if (form3.updates == true) chk_auto_updates.CheckState = CheckState.Checked;
            else chk_auto_updates.CheckState = CheckState.Unchecked;

            String f_autorun = String.Empty;
            String f_multi = String.Empty;
            if (is_portable == false)
            {
                f_autorun = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_autorun.ini";
                f_multi = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_autorun_m.ini";
            }
            else
            {
                f_autorun = port_path + "ff_autorun_portable.ini";
                f_multi = port_path + "ff_autorun_m_portable.ini";
            }
            if (form3.autorun == true)
            {
                start_seq = true;
                chk_autor.ImageIndex = 1;
                File.WriteAllText(f_autorun, "");
                if (form3.automulti == true)
                {
                    File.WriteAllText(f_multi, "");
                }
                else
                {
                    try
                    {
                        File.Delete(f_multi);
                    }
                    catch
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
            }
            else
            {
                start_seq = false;
                start_multi = false;

                try
                {
                    File.Delete(f_autorun);
                    File.Delete(f_multi);
                }
                catch
                {
                    MessageBox.Show(FFBatch.Properties.Strings.err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }

            //End autorun

            String f_sleep = String.Empty;
            if (is_portable == false)
            {
                f_sleep = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_sleep.ini";
            }
            else
            {
                f_sleep = port_path + "ff_sleep_portable.ini";
            }
            if (form3.to_sleep == true)
            {
                File.WriteAllText(f_sleep, "");
                Timer_idle.Enabled = true;
                Timer_idle.Start();
            }
            else
            {
                Timer_idle.Stop();
                Timer_idle.Enabled = false;
                try
                {
                    File.Delete(f_sleep);
                }
                catch { }
            }

            txt_parameters.Text = form3.txt_preset_str;
            txt_format.Text = form3.txt_format_str;

            btn_save_config.PerformClick();

            // Sort Multi

            String f_sort_dur = String.Empty;
            if (is_portable == false)
            {
                f_sort_dur = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_sort_dur.ini";
            }
            else
            {
                f_sort_dur = port_path + "ff_sort_dur_portable.ini";
            }
            try
            {
                if (form3.sort_multi == true)
                    File.WriteAllText(f_sort_dur, "");
                else File.Delete(f_sort_dur);
            }
            catch
            {
                MessageBox.Show(FFBatch.Properties.Strings.un_err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }

            // End sort multi

            // Send to console

            String f_params_console = String.Empty;
            if (is_portable == false)
            {
                f_params_console = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_par_con.ini";
            }
            else
            {
                f_params_console = port_path + "ff_par_con_portable.ini";
            }
            try
            {
                if (form3.send_params_console == false)
                {
                    send_par_consol = false;
                    File.WriteAllText(f_params_console, String.Empty);
                }
                else
                {
                    send_par_consol = true;
                    if (File.Exists(f_params_console)) File.Delete(f_params_console);
                }
            }
            catch
            {
                MessageBox.Show(FFBatch.Properties.Strings.un_err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            // End send params console

            //Warn successful items

            String f_warn_suc = String.Empty;
            if (is_portable == false)
            {
                f_warn_suc = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_warn_suc.ini";
            }
            else
            {
                f_warn_suc = port_path + "ff_warn_suc_portable.ini";
            }
            try
            {
                if (form3.warn_successful == false)
                {
                    warn_success_items = false;
                    File.WriteAllText(f_warn_suc, String.Empty);
                }
                else
                {
                    warn_success_items = true;
                    if (File.Exists(f_warn_suc)) File.Delete(f_warn_suc);
                }
            }
            catch
            {
                MessageBox.Show(FFBatch.Properties.Strings.un_err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            //End warn successful items

            //Warn 0

            String f_warn_0 = String.Empty;
            if (is_portable == false)
            {
                f_warn_0 = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_warn_0.ini";
            }
            else
            {
                f_warn_0 = port_path + "ff_warn_0_portable.ini";
            }
            try
            {
                if (form3.no_warn_0 == true)
                {
                    no_warn_0_dur = true;
                    File.WriteAllText(f_warn_0, String.Empty);
                }
                else
                {
                    no_warn_0_dur = false;
                    if (File.Exists(f_warn_0)) File.Delete(f_warn_0);
                }
            }
            catch
            {
                MessageBox.Show(FFBatch.Properties.Strings.un_err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            //End warn 0

            //Do not save logs

            String f_nologs = String.Empty;
            if (is_portable == false)
            {
                f_nologs = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_nologs.ini";
            }
            else
            {
                f_nologs = port_path + "ff_nologs_portable.ini";
            }
            try
            {
                if (form3.not_save_logs == false)
                {
                    no_save_logs = false;
                    if (File.Exists(f_nologs)) File.Delete(f_nologs);
                }
                else
                {
                    no_save_logs = true;
                    File.WriteAllText(f_nologs, String.Empty);
                    String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                    if (is_portable == true) path = port_path + "ff_batch_portable.log";

                    if (File.Exists(path))
                    {
                        var a = MessageBox.Show(FFBatch.Properties.Strings.del_last, FFBatch.Properties.Strings.del_file, MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                        if (a == DialogResult.Yes)
                        {
                            try
                            {
                                File.Delete(path);
                            }
                            catch (Exception excpt)
                            {
                                MessageBox.Show(FFBatch.Properties.Strings.err_del_log + Environment.NewLine + Environment.NewLine + excpt.Message, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            }
                        }
                    }
                }
            }
            catch
            {
                MessageBox.Show(FFBatch.Properties.Strings.un_err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }

            //End do not save logs

            //Verbose logs

            String f_verbose = String.Empty;
            if (is_portable == false)
            {
                f_verbose = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_verbose.ini";
            }
            else
            {
                f_verbose = port_path + "ff_verbose_portable.ini";
            }
            try
            {
                if (form3.verbose_logs == false)
                {
                    verbose_logs = false;
                    if (File.Exists(f_verbose)) File.Delete(f_verbose);
                }
                else
                {
                    verbose_logs = true;
                    File.WriteAllText(f_verbose, String.Empty);
                }
            }
            catch
            {
                MessageBox.Show(FFBatch.Properties.Strings.un_err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }

            //End verbose logs

            //Full report

            String f_report = String.Empty;
            if (is_portable == false)
            {
                f_report = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_report.ini";
            }
            else
            {
                f_report = port_path + "ff_report_portable.ini";
            }
            try
            {
                if (form3.full_report == false)
                {
                    full_report = false;
                    if (File.Exists(f_report)) File.Delete(f_report);
                }
                else
                {
                    full_report = true;
                    File.WriteAllText(f_report, String.Empty);
                }
            }
            catch
            {
                MessageBox.Show(FFBatch.Properties.Strings.un_err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }

            //End full report

            //Do not cache network files

            String f_no_cache = String.Empty;
            if (is_portable == false)
            {
                f_no_cache = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_nocache.ini";
            }
            else
            {
                f_no_cache = port_path + "ff_nocache_portable.ini";
            }
            try
            {
                if (form3.not_save_cache == false)
                {
                    no_save_cache = false;
                    if (File.Exists(f_no_cache)) File.Delete(f_no_cache);
                }
                else
                {
                    no_save_cache = true;
                    File.WriteAllText(f_no_cache, String.Empty);
                }
            }
            catch
            {
                MessageBox.Show(FFBatch.Properties.Strings.un_err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            //End do not cache network files

            //use OS cache dialog

            String f_os_cache = String.Empty;
            if (is_portable == false)
            {
                f_os_cache = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_oscache.ini";
            }
            else
            {
                f_os_cache = port_path + "ff_oscache_portable.ini";
            }
            try
            {
                if (form3.use_cache_os == false)
                {
                    os_save_cache = false;
                    if (File.Exists(f_os_cache)) File.Delete(f_os_cache);
                }
                else
                {
                    os_save_cache = true;
                    File.WriteAllText(f_os_cache, String.Empty);
                }
            }
            catch
            {
                MessageBox.Show(FFBatch.Properties.Strings.un_err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            //End use OS cache dialog

            //Remember tab

            String f_remember = String.Empty;
            if (is_portable == false)
            {
                f_remember = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_remember.ini";
            }
            else
            {
                f_remember = port_path + "ff_remember_portable.ini";
            }

            if (form3.chk_remember_tab.Checked == false)
            {
                remember_last_tab = false;
                if (File.Exists(f_remember))
                {
                    try
                    {
                        File.Delete(f_remember);
                    }
                    catch { }
                }
            }
            else
            {
                remember_last_tab = true;
                File.WriteAllText(f_remember, tabControl1.SelectedIndex.ToString());
            }

            //End remember tab

            //Save play sound

            String ff_play_sound = String.Empty;
            if (is_portable == false)
            {
                ff_play_sound = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_play.ini";
            }
            else
            {
                ff_play_sound = port_path + "ff_play_portable.ini";
            }

            if (form3.play_file.Length != 0)
            {
                try
                {
                    File.WriteAllText(ff_play_sound, form3.play_file);
                    play_on_end = true;
                    play_file_path = form3.play_file;
                }
                catch (Exception excpt)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.err_set + Environment.NewLine + Environment.NewLine + excpt.Message, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    play_on_end = false;
                }
            }
            else
            {
                play_on_end = false;
                if (File.Exists(ff_play_sound))
                {
                    try
                    {
                        File.Delete(ff_play_sound);
                    }
                    catch { }
                }
            }
            //End save play sound

            //Remember window and size

            String f_remember_w = String.Empty;
            if (is_portable == false)
            {
                f_remember_w = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_remember_w.ini";
            }
            else
            {
                f_remember_w = port_path + "ff_remember_w_portable.ini";
            }
            try
            {
                if (form3.remember_w == false)
                {
                    remember_w = false;
                    if (File.Exists(f_remember_w)) File.Delete(f_remember_w);
                }
                else
                {
                    remember_w = true;
                    Rectangle rect = Screen.PrimaryScreen.Bounds;
                    File.WriteAllText(f_remember_w, rect.Width + Environment.NewLine + rect.Height);
                }
            }
            catch
            {
                MessageBox.Show(FFBatch.Properties.Strings.un_err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            //End remember window

            //Delete full

            String f_delete_full = String.Empty;
            if (is_portable == false)
            {
                f_delete_full = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_delete_full.ini";
            }
            else
            {
                f_delete_full = port_path + "ff_delete_full_portable.ini";
            }
            try
            {
                if (form3.delete_def == false)
                {
                    delete_def = false;
                    if (File.Exists(f_delete_full)) File.Delete(f_delete_full);
                }
                else
                {
                    delete_def = true;
                    File.WriteAllText(f_delete_full, "");
                }
            }
            catch
            {
            }
            //End delete full

            //Delete one

            String f_delete_one = String.Empty;
            if (is_portable == false)
            {
                f_delete_one = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_delete_one.ini";
            }
            else
            {
                f_delete_one = port_path + "ff_delete_one_portable.ini";
            }
            try
            {
                if (form3.delete_one == false)
                {
                    delete_one = false;
                    if (File.Exists(f_delete_one)) File.Delete(f_delete_one);
                }
                else
                {
                    delete_one = true;
                    File.WriteAllText(f_delete_one, "");
                }
            }
            catch
            {
            }
            //End delete one
        }

        private void menu_reset_Click(object sender, EventArgs e)
        {
            var a = MessageBox.Show(FFBatch.Properties.Strings.reset_default, FFBatch.Properties.Strings.conf_act, MessageBoxButtons.YesNo, MessageBoxIcon.Warning);
            if (a == DialogResult.No)
            {
                return;
            }

            Properties.Settings.Default.wLocation = new System.Drawing.Point(0, 0);
            Properties.Settings.Default.Save();

            String path = String.Empty;
            String path2 = String.Empty;
            String path_pr = String.Empty;
            if (is_portable == false)
            {
                path = Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.ini";
                path_pr = Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_presets.ini";
                path2 = Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_hw_dcd";
            }
            else
            {
                path = port_path + "ff_batch_portable.ini";
                path_pr = port_path + "ff_presets_portable.ini";
                path2 = port_path + "ff_hw_dcd_portable";
            }

            if (!Directory.Exists(System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch")))
            {
                Directory.CreateDirectory(System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch"));
            }

            if (File.Exists(path))
            {
                File.Delete(path);
            }
            if (File.Exists(path2))
            {
                File.Delete(path2);
            }

            combo_prio.SelectedIndex = 2;
            btn_save_prio.PerformClick();

            String f_skip_ver = String.Empty;
            if (is_portable == false)
            {
                f_skip_ver = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_skip_ver.ini";
            }
            else
            {
                f_skip_ver = port_path + "ff_skip_ver_portable.ini";
            }

            if (File.Exists(f_skip_ver))
            {
                try
                {
                    File.Delete(f_skip_ver);
                }
                catch { }
            }

            //Sleep off

            String f_sleep = String.Empty;
            if (is_portable == false)
            {
                f_sleep = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_sleep.ini";
            }
            else
            {
                f_sleep = port_path + "ff_sleep_portable.ini";
            }

            if (!File.Exists(f_sleep))
            {
                try
                {
                    prevent_sleep = false;
                    File.Delete(f_sleep);
                }
                catch
                {
                }
            }
            else
            {
                prevent_sleep = true;
            }

            //End sleep off

            //Disable try preset

            String f_try = String.Empty;
            if (is_portable == false)
            {
                f_try = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_try.ini";
            }
            else
            {
                f_try = port_path + "ff_try_portable.ini";
            }

            if (File.Exists(f_try))
            {
                try
                {
                    File.Delete(f_try);
                    chk_try.CheckState = CheckState.Unchecked;
                }
                catch
                {
                }
            }

            //End Disable preset

            //Concat video filter

            String f_concat = String.Empty;
            if (is_portable == false)
            {
                f_concat = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_concat.ini";
            }
            else
            {
                f_concat = port_path + "ff_concat_portable.ini";
            }

            if (File.Exists(f_concat))
            {
                try
                {
                    File.Delete(f_concat);
                    check_concat.CheckState = CheckState.Unchecked;
                }
                catch
                {
                }
            }
            //End concat video filter

            String f_lang = String.Empty;
            if (is_portable == false)
            {
                f_lang = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_lang.ini";
            }
            else
            {
                f_lang = port_path + "ff_lang_portable.ini";
            }
            try
            {
                File.Delete(f_lang);
            }
            catch { }

            Form24 frm24 = new Form24();
            frm24.ShowDialog();
            if (frm24.combo_lang.SelectedIndex == 0) language = "en";
            if (frm24.combo_lang.SelectedIndex == 1) language = "es";
            if (frm24.combo_lang.SelectedIndex == 2) language = "it";
            if (frm24.combo_lang.SelectedIndex == 3) language = "pt-BR";
            if (frm24.combo_lang.SelectedIndex == 4) language = "zh-Hans";
            File.WriteAllText(f_lang, language);
            FFBatch.Properties.Settings.Default.app_lang = language;
            FFBatch.Properties.Settings.Default.Save();
            init_lang();
            btn_update.Text = Properties.Strings2.version + " " + Application.ProductVersion;

            File.WriteAllText(path, "-c copy" + Environment.NewLine + "mp4" + Environment.NewLine + "Yes"
                        + Environment.NewLine + "Vn" + Environment.NewLine + "grid_yes" + Environment.NewLine + "keep_no"
                        + Environment.NewLine + "subf_no");

            File.WriteAllText(path_pr, "Version 1.0" + Environment.NewLine
       + "PR: " + Properties.Strings2.pr01 + " & -c copy % mp4" + Environment.NewLine
   + "PR: " + Properties.Strings2.pr02 + " & -c:v copy -c:a aac -cutoff 20K -b:a 256K -ac 2 % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr03 + " & -map 0 -c:v copy -c:a ac3 -b:a 256K -ac 2 -c:s copy % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr04 + " & -c:v prores_ks -profile:v standard -vendor:v ap10 -pix_fmt yuv422p10le -c:a pcm_s16le -chunk_size 64K % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr05 + " & -map 0 -c:v libx264 -crf 20 -c:a copy % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr06 + "  & -map 0 -c:v libx264 -crf 23 -preset ultrafast -c:a copy % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr07 + " & -map 0 -c:v libx265 -crf 23 -c:a copy % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr08 + " & -map 0 -c:v libx264 -crf 23 -vf scale=1280:720 -c:a aac -b:a 128K % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr09 + " & -c:v libx264 -crf 21 -vf " + "\u0022" + "transpose=1" + "\u0022" + " -c:a aac -b:a 128K % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr10 + " & -c:v libx264 -crf 21 -vf " + "\u0022" + "transpose=0" + "\u0022" + " -c:a aac -b:a 128K % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr11 + "  & -c:v libx264 -crf 21 -vf " + "\u0022" + "transpose=2" + "\u0022" + " -c:a aac -b:a 128K % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr12 + " & -c:v libx264 -crf 21 -vf " + "\u0022" + "transpose=3" + "\u0022" + " -c:a aac -b:a 128K % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr13 + " & -c:v libx264 -crf 21 -vf " + "\u0022" + "transpose=2, transpose=2" + "\u0022" + " -c:a aac -b:a 128K % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr14 + " & -map 0 -c copy -sn % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr15 + " & -vn -c:a flac -ar 44100 -sample_fmt s16 -ac 2 % flac" + Environment.NewLine + "PR: " + Properties.Strings2.pr16 + " & -c:v copy -c:a libmp3lame -qscale:a 0 -ac 2  % mp3" + Environment.NewLine + "PR: " + Properties.Strings2.pr17 + " & -vn -c:a libmp3lame -qscale:a 1 -ac 2 % mp3" + Environment.NewLine + "PR: " + Properties.Strings2.pr18 + " & -vn -c:a libmp3lame -b:a 224K -ac 2 % mp3" + Environment.NewLine + "PR: " + Properties.Strings2.pr19 + " & -vn -c:a pcm_s16le -ar 44100 -sample_fmt s16 -ac 2 % wav" + Environment.NewLine + "PR: " + Properties.Strings2.pr20 + " & -map 0:2 -c:s copy % srt" + Environment.NewLine + "PR: " + Properties.Strings2.pr21 + " & -vframes 1 -f image2  % png" + Environment.NewLine + "PR: " + Properties.Strings2.pr21_2 + " & -map 0 -c:v h264_amf -rc cqp -qp_p 20 -qp_i 20 -qp_b 20 -c:a copy % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr21_21 + " & -map 0 -c:v hevc_amf -rc cqp -qp_p 20 -qp_i 20 -qp_b 20 -c:a copy % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr22 + " & -r 24 -c:a aac -b:a 128K % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr23 + " & -r 15 -vf scale=1280x720 -c:a aac -b:a 128K % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr24 + " & -c:v h264_nvenc -qp 20 -r 30 -c:a aac -b:a 128K % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr25 + " & -c:v  h264_qsv -qp 20 -r 25 -c:a aac -b:a 128K % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr26 + " & -c:v libx264 -preset veryfast -vf " + '\u0022' + "fps=25,format=yuv420p,scale=1920:-2" + '\u0022' + " -c:a aac -b:a 64K % mp4");
            btn_load_config.PerformClick();

            txt_pre_input.Text = String.Empty;
            btn_fix_pre.PerformClick();
        }

        private void remove_custom_cols()
        {
            //Remove custom columns
            String f_cols = String.Empty;
            if (is_portable == false)
            {
                f_cols = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_cols.ini";
            }
            else
            {
                f_cols = port_path + "ff_cols_portable.ini";
            }
            try
            {
                File.Delete(f_cols);
                foreach (ColumnHeader col in listView1.Columns) if (col.Text.Contains(FFBatch.Properties.Strings.width)) listView1.Columns.Remove(col);
                foreach (ColumnHeader col in listView1.Columns) if (col.Text.Contains(FFBatch.Properties.Strings.height)) listView1.Columns.Remove(col);
                foreach (ColumnHeader col in listView1.Columns) if (col.Text.Contains(FFBatch.Properties.Strings.Video_codec)) listView1.Columns.Remove(col);
                foreach (ColumnHeader col in listView1.Columns) if (col.Text.Contains(FFBatch.Properties.Strings.Audio_codec)) listView1.Columns.Remove(col);
                foreach (ColumnHeader col in listView1.Columns) if (col.Text.Contains(FFBatch.Properties.Strings.v_bitr)) listView1.Columns.Remove(col);
                foreach (ColumnHeader col in listView1.Columns) if (col.Text.Contains(FFBatch.Properties.Strings2.a_bitr)) listView1.Columns.Remove(col);
                resize();
            }
            catch { }
        }

        private void reset_portable()
        {
            String path = String.Empty;
            String path2 = String.Empty;
            String path_pr = String.Empty;
            path = port_path + "ff_batch_portable.ini";
            path_pr = port_path + "ff_presets_portable.ini";
            path2 = port_path + "ff_hw_dcd_portable";

            if (File.Exists(path))
            {
                File.Delete(path);
            }
            if (File.Exists(path2))
            {
                File.Delete(path2);
            }

            combo_prio.SelectedIndex = 2;
            btn_save_prio.PerformClick();

            //Sleep off

            String f_sleep = String.Empty;
            if (is_portable == false)
            {
                f_sleep = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_sleep.ini";
            }
            else
            {
                f_sleep = port_path + "ff_sleep_portable.ini";
            }

            if (File.Exists(f_sleep))
            {
                try
                {
                    File.Delete(f_sleep);
                }
                catch
                {
                }
            }

            //End sleep off

            //Disable try preset

            String f_try = String.Empty;
            if (is_portable == false)
            {
                f_try = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_try.ini";
            }
            else
            {
                f_try = port_path + "ff_try_portable.ini";
            }

            if (File.Exists(f_try))
            {
                try
                {
                    File.Delete(f_try);
                    chk_try.CheckState = CheckState.Unchecked;
                }
                catch
                {
                }
            }

            //End Disable preset

            //Concat video filter

            String f_concat = String.Empty;
            if (is_portable == false)
            {
                f_concat = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_concat.ini";
            }
            else
            {
                f_concat = port_path + "ff_concat_portable.ini";
            }

            if (File.Exists(f_concat))
            {
                try
                {
                    File.Delete(f_concat);
                    check_concat.CheckState = CheckState.Unchecked;
                }
                catch
                {
                }
            }

            //End concat video filter
            File.WriteAllText(path, "-c copy" + Environment.NewLine + "mp4" + Environment.NewLine + "Yes"
                        + Environment.NewLine + "Vn" + Environment.NewLine + "grid_yes" + Environment.NewLine + "keep_no"
                        + Environment.NewLine + "subf_no");

            File.WriteAllText(path_pr, "Version 1.0" + Environment.NewLine
       + "PR: " + Properties.Strings2.pr01 + " & -c copy % mp4" + Environment.NewLine
   + "PR: " + Properties.Strings2.pr02 + " & -c:v copy -c:a aac -cutoff 20K -b:a 256K -ac 2 % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr03 + " & -map 0 -c:v copy -c:a ac3 -b:a 256K -ac 2 -c:s copy % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr04 + " & -c:v prores_ks -profile:v standard -vendor:v ap10 -pix_fmt yuv422p10le -c:a pcm_s16le -chunk_size 64K % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr05 + " & -map 0 -c:v libx264 -crf 20 -c:a copy % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr06 + "  & -map 0 -c:v libx264 -crf 23 -preset ultrafast -c:a copy % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr07 + " & -map 0 -c:v libx265 -crf 23 -c:a copy % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr08 + " & -map 0 -c:v libx264 -crf 23 -vf scale=1280:720 -c:a aac -b:a 128K % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr09 + " & -c:v libx264 -crf 21 -vf " + "\u0022" + "transpose=1" + "\u0022" + " -c:a aac -b:a 128K % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr10 + " & -c:v libx264 -crf 21 -vf " + "\u0022" + "transpose=0" + "\u0022" + " -c:a aac -b:a 128K % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr11 + "  & -c:v libx264 -crf 21 -vf " + "\u0022" + "transpose=2" + "\u0022" + " -c:a aac -b:a 128K % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr12 + " & -c:v libx264 -crf 21 -vf " + "\u0022" + "transpose=3" + "\u0022" + " -c:a aac -b:a 128K % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr13 + " & -c:v libx264 -crf 21 -vf " + "\u0022" + "transpose=2, transpose=2" + "\u0022" + " -c:a aac -b:a 128K % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr14 + " & -map 0 -c copy -sn % mp4" + Environment.NewLine + "PR: " + Properties.Strings2.pr15 + " & -vn -c:a flac -ar 44100 -sample_fmt s16 -ac 2 % flac" + Environment.NewLine + "PR: " + Properties.Strings2.pr16 + " & -c:v copy -c:a libmp3lame -qscale:a 0 -ac 2  % mp3" + Environment.NewLine + "PR: " + Properties.Strings2.pr17 + " & -vn -c:a libmp3lame -qscale:a 1 -ac 2 % mp3" + Environment.NewLine + "PR: " + Properties.Strings2.pr18 + " & -vn -c:a libmp3lame -b:a 224K -ac 2 % mp3" + Environment.NewLine + "PR: " + Properties.Strings2.pr19 + " & -vn -c:a pcm_s16le -ar 44100 -sample_fmt s16 -ac 2 % wav" + Environment.NewLine + "PR: " + Properties.Strings2.pr20 + " & -map 0:2 -c:s copy % srt" + Environment.NewLine + "PR: " + Properties.Strings2.pr21 + " & -vframes 1 -f image2  % png" + Environment.NewLine + "PR: " + Properties.Strings2.pr21_2 + " & -map 0 -c:v h264_amf -rc cqp -qp_p 20 -qp_i 20 -qp_b 20 -c:a copy % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr21_21 + " & -map 0 -c:v hevc_amf -rc cqp -qp_p 20 -qp_i 20 -qp_b 20 -c:a copy % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr22 + " & -r 24 -c:a aac -b:a 128K % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr23 + " & -r 15 -vf scale=1280x720 -c:a aac -b:a 128K % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr24 + " & -c:v h264_nvenc -qp 20 -r 30 -c:a aac -b:a 128K % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr25 + " & -c:v  h264_qsv -qp 20 -r 25 -c:a aac -b:a 128K % mkv" + Environment.NewLine + "PR: " + Properties.Strings2.pr26 + " & -c:v libx264 -preset veryfast -vf " + '\u0022' + "fps=25,format=yuv420p,scale=1920:-2" + '\u0022' + " -c:a aac -b:a 64K % mp4");

            //Remove custom columns
            String f_cols = String.Empty;
            if (is_portable == false)
            {
                f_cols = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_cols.ini";
            }
            else
            {
                f_cols = port_path + "ff_cols_portable.ini";
            }
            try
            {
                File.Delete(f_cols);
                foreach (ColumnHeader col in listView1.Columns) if (col.Text.Contains(FFBatch.Properties.Strings.width)) listView1.Columns.Remove(col);
                foreach (ColumnHeader col in listView1.Columns) if (col.Text.Contains(FFBatch.Properties.Strings.height)) listView1.Columns.Remove(col);
                foreach (ColumnHeader col in listView1.Columns) if (col.Text.Contains(FFBatch.Properties.Strings.Video_codec)) listView1.Columns.Remove(col);
                foreach (ColumnHeader col in listView1.Columns) if (col.Text.Contains(FFBatch.Properties.Strings.Audio_codec)) listView1.Columns.Remove(col);
                foreach (ColumnHeader col in listView1.Columns) if (col.Text.Contains(FFBatch.Properties.Strings.v_bitr)) listView1.Columns.Remove(col);
                foreach (ColumnHeader col in listView1.Columns) if (col.Text.Contains(FFBatch.Properties.Strings2.a_bitr)) listView1.Columns.Remove(col);
                resize();
            }
            catch { }
            txt_pre_input.Text = String.Empty;
            btn_fix_pre.PerformClick();
        }

        private void preset_menu_Click(object sender, EventArgs e)
        {
            btn_wizard.PerformClick();
        }

        private void toolStripMenuItem1_Click(object sender, EventArgs e)
        {
            btn_exit.PerformClick();
        }

        private void chk_overw_CheckedChanged(object sender, EventArgs e)
        {
            String path_first = String.Empty;
            if (is_portable == false)
            {
                path_first = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_first.ini";
            }
            else
            {
                path_first = port_path + "ff_first_portable.ini";
            }

            Boolean not_show = true;
            String not_first = File.ReadAllText(path_first);

            if (not_first.Contains("chk_overw") == false) not_show = false;

            if (chk_overw.CheckState == CheckState.Checked)
            {
                chk_overw.BackColor = Color.LightGoldenrodYellow;
                if (not_show == false)
                {
                    File.WriteAllText(path_first, "chk_overw");
                    //MessageBox.Show("Overwriting only supported for Sequential processing.", "Limited support feature", MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            }
            else
            {
                chk_overw.BackColor = this.BackColor;
            }
            if (chk_delete_source.Checked == true && chk_overw.Checked == true)
            {
                MessageBox.Show(FFBatch.Properties.Strings.del_overw);
            }
        }

        private void Form1_KeyPress(object sender, KeyPressEventArgs e)
        {
            MessageBox.Show(e.KeyChar.ToString());
        }

        private void main_f_4_Click(object sender, EventArgs e)
        {
            if (listView1.Items.Count == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.list_empty, FFBatch.Properties.Strings.list_bl, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }
            if (txt_parameters.Text == "")
            {
                MessageBox.Show(FFBatch.Properties.Strings.params_bl, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }
            this.Cursor = Cursors.WaitCursor;
            save_ffq.DefaultExt = "ffq";
            save_ffq.InitialDirectory = Path.GetDirectoryName(Environment.SpecialFolder.MyDocuments.ToString());
            save_ffq.RestoreDirectory = true;
            save_ffq.Filter = FFBatch.Properties.Strings.q_files + " " + " | *.ffq| " + FFBatch.Properties.Strings.all_files + " (*.*) | *.*";
            if (save_ffq.ShowDialog() != DialogResult.OK)
            {
                this.Cursor = Cursors.Arrow;
                return;
            }
            String save_path = save_ffq.FileName;
            List<string> list_file = new List<string>();
            list_file.Add(txt_parameters.Text);
            list_file.Add(txt_format.Text);
            list_file.Add(checkBox1.CheckState.ToString());

            if (chk_suffix.CheckState == CheckState.Unchecked) list_file.Add(chk_suffix.CheckState.ToString());
            else
            {
                list_file.Add(txt_suffix.Text);
            }

            list_file.Add(txt_path_main.Text);
            foreach (ListViewItem item in listView1.Items)
            {
                list_file.Add(item.SubItems[1].Text + "\\" + item.Text + " --0 " + item.SubItems[2].Text + " --1 " + item.SubItems[3].Text + " --2 " + item.SubItems[4].Text + " --3 " + item.SubItems[5].Text);
            }

            try
            {
                File.WriteAllLines(save_path, list_file);
            }
            catch (Exception excp)
            {
                MessageBox.Show(Properties.Strings2.err_save_qu + Environment.NewLine + Environment.NewLine + excp.Message, Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            this.Cursor = Cursors.Arrow;
        }

        private void main_f_5_Click(object sender, EventArgs e)
        {
            file_dialog_ffq.DefaultExt = "ffq";
            file_dialog_ffq.InitialDirectory = Path.GetDirectoryName(Environment.SpecialFolder.MyDocuments.ToString());
            file_dialog_ffq.RestoreDirectory = true;
            file_dialog_ffq.Filter = FFBatch.Properties.Strings.q_files + " " + " |*.ffq;*.txt|" + FFBatch.Properties.Strings.all_files + " (*.*) | *.*";
            if (file_dialog_ffq.ShowDialog() != DialogResult.OK) return;
            listView1.Items.Clear();
            String save_path = file_dialog_ffq.FileName;
            this.Cursor = Cursors.WaitCursor;

            int linea = 0;
            int not_found = 0;
            combo_presets.Text = "";
            List<ListViewItem> itemsToAdd = new List<ListViewItem>();

            Boolean ffq_format = false;
            if (Path.GetExtension(file_dialog_ffq.FileName) == ".ffq")
            {
                ffq_format = true;
                try
                {
                    foreach (string line in File.ReadLines(save_path))
                    {
                        if (linea == 0)
                        {
                            txt_parameters.Text = line;
                        }

                        if (linea == 1)
                        {
                            txt_format.Text = line;
                        }

                        if (linea == 2)
                        {
                            if (line == "Unchecked") checkBox1.CheckState = CheckState.Unchecked;
                            else checkBox1.CheckState = CheckState.Checked;
                        }

                        if (linea == 3)
                        {
                            if (line == "Unchecked") chk_suffix.CheckState = CheckState.Unchecked;
                            else
                            {
                                chk_suffix.CheckState = CheckState.Checked;
                                txt_suffix.Text = line;
                            }
                        }

                        if (linea == 4)
                        {
                            txt_path_main.Text = line;
                        }

                        if (linea > 4)
                        {
                            Boolean missing = false;
                            listView1.SmallImageList = imageList2;

                            itemsToAdd.Add(new ListViewItem(Path.GetFileName(line.Substring(0, line.LastIndexOf(" --0 "))), 1));

                            Icon iconForFile = SystemIcons.WinLogo;

                            // Check to see if the image collection contains an image
                            // for this extension, using the extension as a key.
                            if (File.Exists(line.Substring(0, line.LastIndexOf(" --0 "))))
                            {
                                if (!imageList2.Images.ContainsKey(System.IO.Path.GetExtension(line.Substring(0, line.LastIndexOf(" --0 ")))))
                                {
                                    // If not, add the image to the image list.
                                    iconForFile = System.Drawing.Icon.ExtractAssociatedIcon(line.Substring(0, line.LastIndexOf(" --0 ")));
                                    imageList2.Images.Add(System.IO.Path.GetExtension(line.Substring(0, line.LastIndexOf(" --0 "))), iconForFile);
                                }

                                //listView1.Items.Add(elemento);
                                itemsToAdd[linea - 5].ImageKey = System.IO.Path.GetExtension(System.IO.Path.GetExtension(line.Substring(0, line.LastIndexOf(" --0 "))));
                            }
                            else
                            {
                                not_found = not_found + 1;
                                missing = true;
                            }

                            //listView1.Items.Add(line.Substring(0,line.LastIndexOf(" --0 ")));
                            String type = line.Substring(line.LastIndexOf(" --0 ") + 5, line.Length - (line.LastIndexOf(" --0") + 5));
                            type = type.Substring(0, type.LastIndexOf(" --1"));
                            String dur = line.Substring(line.LastIndexOf(" --1 ") + 5, line.Length - (line.LastIndexOf(" --1") + 5));
                            dur = dur.Substring(0, dur.LastIndexOf(" --2"));
                            String size = line.Substring(line.LastIndexOf(" --2 ") + 5, line.Length - (line.LastIndexOf(" --2") + 5));
                            size = size.Substring(0, size.LastIndexOf(" --3"));
                            String status = line.Substring(line.LastIndexOf(" --3 ") + 5, line.Length - (line.LastIndexOf(" --3") + 5));

                            itemsToAdd[linea - 5].SubItems.Add(Path.GetDirectoryName(line.Substring(0, line.LastIndexOf(" --0 "))));
                            itemsToAdd[linea - 5].SubItems.Add(type);
                            itemsToAdd[linea - 5].SubItems.Add(dur);
                            itemsToAdd[linea - 5].SubItems.Add(size);
                            if (missing == false) itemsToAdd[linea - 5].SubItems.Add(status);
                            else
                            {
                                itemsToAdd[linea - 5].SubItems.Add(FFBatch.Properties.Strings.file_not_f);
                                itemsToAdd[linea - 5].BackColor = Color.LightGoldenrodYellow;
                            }
                        }
                        linea = linea + 1;
                    }
                    listView1.Items.AddRange(itemsToAdd.ToArray());
                }
                catch (Exception excpt)
                {
                    this.Cursor = Cursors.Arrow;
                    MessageBox.Show(FFBatch.Properties.Strings.err_qf + Environment.NewLine + excpt.Message, Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    btn_load_config.PerformClick();
                    read_saved_path();
                    return;
                }
            }

            if (Path.GetExtension(file_dialog_ffq.FileName) == ".txt")
            {
                ffq_format = true;
                try
                {
                    foreach (string line in File.ReadLines(save_path))
                    {
                        Boolean missing = false;
                        listView1.SmallImageList = imageList2;

                        itemsToAdd.Add(new ListViewItem(Path.GetFileName(line)));

                        Icon iconForFile = SystemIcons.WinLogo;

                        // Check to see if the image collection contains an image
                        // for this extension, using the extension as a key.
                        if (File.Exists(line))
                        {
                            if (!imageList2.Images.ContainsKey(System.IO.Path.GetExtension(line)))
                            {
                                // If not, add the image to the image list.
                                iconForFile = System.Drawing.Icon.ExtractAssociatedIcon(line);
                                imageList2.Images.Add(System.IO.Path.GetExtension(line), iconForFile);
                            }

                            //listView1.Items.Add(elemento);
                            itemsToAdd[linea].ImageKey = System.IO.Path.GetExtension(System.IO.Path.GetExtension(line));
                        }
                        else
                        {
                            not_found = not_found + 1;
                            missing = true;
                        }

                        itemsToAdd[linea].SubItems.Add(Path.GetDirectoryName(line));
                        itemsToAdd[linea].SubItems.Add(Properties.Strings.pending);
                        itemsToAdd[linea].SubItems.Add(Properties.Strings.pending);
                        itemsToAdd[linea].SubItems.Add(Properties.Strings.pending);
                        itemsToAdd[linea].BackColor = Color.White;

                        if (missing == false) itemsToAdd[linea].SubItems.Add(FFBatch.Properties.Strings.queued);
                        else
                        {
                            itemsToAdd[linea].SubItems.Add(FFBatch.Properties.Strings.file_not_f);
                            itemsToAdd[linea].BackColor = Color.LightGoldenrodYellow;
                        }

                        linea = linea + 1;
                    }
                    listView1.Items.AddRange(itemsToAdd.ToArray());
                }
                catch (Exception excpt)
                {
                    this.Cursor = Cursors.Arrow;
                    MessageBox.Show(FFBatch.Properties.Strings.err_qf + Environment.NewLine + excpt.Message, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    btn_load_config.PerformClick();
                    read_saved_path();
                    return;
                }
            }

            this.Cursor = Cursors.Arrow;
            if (tabControl1.SelectedIndex == 0)
            {
                if (ffq_format == true)
                {
                    calc_list_size();
                    calc_total_dur();
                }
                lbl_items.Text = listView1.Items.Count.ToString() + " " + FFBatch.Properties.Strings.files;

                if (not_found > 0)
                {
                    this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                    MessageBox.Show(FFBatch.Properties.Strings2.queue_warn + Environment.NewLine + not_found.ToString() + " " + FFBatch.Properties.Strings2.queue_not_f + " " + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings2.sort_status + ".", FFBatch.Properties.Strings.warning, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                }
                else btn_refresh.PerformClick();
            }
        }

        private void toolStripMenuItem4_Click(object sender, EventArgs e)
        {
            change_ff.PerformClick();
        }

        private void ctm1_queue_Click(object sender, EventArgs e)
        {
            if (listView1.SelectedIndices.Count > 0)
            {
                foreach (ListViewItem item in listView1.SelectedItems)
                {
                    item.SubItems[5].Text = FFBatch.Properties.Strings.queued;
                }
            }
        }

        private void main_m_logs_Click(object sender, EventArgs e)
        {
            btn_display_log.PerformClick();
        }

        private void btn_save_queue_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            main_f_4.PerformClick();
        }

        private void toolStripMenuItem2_Click(object sender, EventArgs e)
        {
            btn_clean_list.PerformClick();
        }

        private void toolStripMenuItem1_Click_1(object sender, EventArgs e)
        {
            btn_refresh.PerformClick();
        }

        private void toolStripMenuItem3_Click(object sender, EventArgs e)
        {
            requeue.PerformClick();
        }

        private void listView2_ColumnClick(object sender, ColumnClickEventArgs e)
        {
        }

        private void ct2_remove_Click(object sender, EventArgs e)
        {
            if (listView2.SelectedItems.Count > 0)
            {
                listView2.BeginUpdate();
                foreach (ListViewItem item in listView2.SelectedItems)
                {
                    if (working == false)
                    {
                        listView2.Items.Remove(item);
                    }
                }

                listView2.EndUpdate();
                lbl_items.Text = listView1.Items.Count + " " + FFBatch.Properties.Strings.files;
            }
        }

        private void btn_filter_Click(object sender, EventArgs e)
        {
            Pg1.Focus();

            if (listView1.Items.Count == 0 || tabControl1.SelectedIndex != 0) return;
            if (listView1.SelectedIndices.Count == 1)
            {
                form4.lv1_item = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
                form5.lv1_item = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
            }
            else
            {
                form4.lv1_item = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text;
                form5.lv1_item = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text;
            }

            form4.ShowDialog();
            if (form4.cancel_filter == true) return;

            btn_undo_filter.ImageList = img_undo;
            btn_undo_filter.ImageKey = "undo_20.png";

            unfilter_lv1.Clear();
            filtered_lv1.Clear();
            unfilter_lv1.SmallImageList = imageList2;

            //Backup current listView1
            this.Cursor = Cursors.WaitCursor;

            ListViewItem[] itemsToAdd = new ListViewItem[listView1.Items.Count];
            ListViewItem[] itemsToAdd2 = new ListViewItem[listView1.Items.Count];
            filtered_lv1.Clear();
            unfilter_lv1.Clear();

            //Backup listview1
            unfilter_lv1.Items.AddRange((from ListViewItem item in listView1.Items
                                         select (ListViewItem)item.Clone()
                   ).ToArray());

            filtered_lv1.Items.AddRange((from ListViewItem item in listView1.Items
                                         select (ListViewItem)item.Clone()
                  ).ToArray());

            this.Cursor = Cursors.Arrow;
            //End backup current lisView1

            btn_undo_filter.Enabled = true;

            //Apply status filter

            if (form4.filter_type == FFBatch.Properties.Strings.status)
            {
                for (int n = 0; n < listView1.Items.Count; n++)
                {
                    if (listView1.Items[n].SubItems[5].Text == form4.filter_value && form4.filter_action == FFBatch.Properties.Strings.remove)
                    {
                        listView1.Items[n].Remove();
                        filtered_lv1.Items[n].Remove();
                        n = n - 1;
                    }
                    else
                    {
                        if ((listView1.Items[n].SubItems[5].Text == form4.filter_value) == false && form4.filter_action == FFBatch.Properties.Strings.keep)
                        {
                            listView1.Items[n].Remove();
                            filtered_lv1.Items[n].Remove();
                            n = n - 1;
                        }
                    }
                }

                if (form4.remove_invalid == true) btn_clean_list.PerformClick();
                lbl_items.Text = listView1.Items.Count + " " + FFBatch.Properties.Strings.files;
                calc_list_dur();
                calc_list_size();
            }

            //End apply status filter

            //Apply extension filter

            if (form4.filter_type == FFBatch.Properties.Strings.file_ext)
            {
                int ni = listView1.Items.Count;
                if (listView1.Items.Count > 2500)
                {
                    pg_adding.Value = 0;
                    pg_adding.Visible = true;
                    pg_adding.Maximum = listView1.Items.Count;
                    LB_Wait.Visible = true;
                    txt_adding_p.Visible = true;
                    LB_Wait.Text = FFBatch.Properties.Strings.app_f;
                }

                for (int n = 0; n < listView1.Items.Count; n++)
                {
                    if (ni > 2500)
                    {
                        pg_adding.Value = pg_adding.Value + 1;
                        this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, pg_adding.Value, pg_adding.Maximum));
                        txt_adding_p.Text = (pg_adding.Value * 100 / ni).ToString() + "%";
                        txt_adding_p.Refresh();
                        LB_Wait.Refresh();
                        pg_adding.Refresh();
                    }

                    if (Path.GetExtension(listView1.Items[n].Text).ToLower() == "." + form4.filter_value.ToLower() && form4.filter_action == FFBatch.Properties.Strings.remove)
                    {
                        listView1.Items[n].Remove();
                        filtered_lv1.Items[n].Remove();
                        n = n - 1;
                    }
                    else
                    {
                        if ((Path.GetExtension(listView1.Items[n].Text).ToLower() == "." + form4.filter_value.ToLower()) == false && form4.filter_action == FFBatch.Properties.Strings.keep)
                        {
                            listView1.Items[n].Remove();
                            filtered_lv1.Items[n].Remove();
                            n = n - 1;
                        }
                    }
                }

                if (form4.remove_invalid == true) btn_clean_list.PerformClick();
                pg_adding.Visible = false;
                txt_adding_p.Visible = false;
                pg_adding.Value = 0;
                LB_Wait.Text = String.Empty;
                this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                listView1.EndUpdate();
                lbl_items.Text = listView1.Items.Count + " " + FFBatch.Properties.Strings.files;
                calc_list_dur();
                calc_list_size();
            }
            //End apply Extension filter

            if (form4.filter_type == FFBatch.Properties.Strings.f_bitr)
            {
                if (form4.remove_invalid == true) btn_clean_list.PerformClick();
                if (listView1.Items.Count > 999)
                {
                    start_total_time = 0;
                    time_n_tasks = 0;
                    timer_adding.Enabled = true;
                    timer_adding.Start();
                    txt_add_remain.Enabled = true;
                    pg_adding.Maximum = listView1.Items.Count;
                    pg_adding.Value = 0;
                }
                BG_File_Bitrate.RunWorkerAsync();
            }

            //File size filter
            if (form4.filter_type == FFBatch.Properties.Strings.f_size)
            {
                listView1.BeginUpdate();
                this.Cursor = Cursors.WaitCursor;

                int ni = listView1.Items.Count;
                if (listView1.Items.Count > 5000)
                {
                    pg_adding.Value = 0;
                    pg_adding.Visible = true;
                    pg_adding.Maximum = listView1.Items.Count;
                    LB_Wait.Visible = true;
                    txt_adding_p.Visible = true;
                    LB_Wait.Text = FFBatch.Properties.Strings.app_f;
                }

                for (int n = 0; n < listView1.Items.Count; n++)
                {
                    if (ni > 5000)
                    {
                        pg_adding.Value = pg_adding.Value + 1;
                        this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, pg_adding.Value, pg_adding.Maximum));
                        txt_adding_p.Text = (pg_adding.Value * 100 / ni).ToString() + "%";
                        txt_adding_p.Refresh();
                        LB_Wait.Refresh();
                        pg_adding.Refresh();
                    }

                    long size = new FileInfo(listView1.Items[n].SubItems[1].Text + "\\" + listView1.Items[n].Text).Length;
                    long compare = long.Parse(form4.filter_value) * 1048576;

                    if (size >= compare && form4.filter_action == FFBatch.Properties.Strings.remove)
                    {
                        listView1.Items[n].Remove();
                        filtered_lv1.Items[n].Remove();
                        n = n - 1;
                    }
                    else
                    {
                        if (size < compare && form4.filter_action == FFBatch.Properties.Strings.keep)
                        {
                            listView1.Items[n].Remove();
                            filtered_lv1.Items[n].Remove();
                            n = n - 1;
                        }
                    }
                }
                listView1.EndUpdate();
                this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                this.Cursor = Cursors.Arrow;

                if (form4.remove_invalid == true) btn_clean_list.PerformClick();
                pg_adding.Visible = false;
                txt_adding_p.Visible = false;
                pg_adding.Value = 0;
                LB_Wait.Text = String.Empty;
                lbl_items.Text = listView1.Items.Count + " " + FFBatch.Properties.Strings.files;
                calc_list_dur();
                calc_list_size();
            }

            //Apply video codec filter

            if (form4.filter_type == FFBatch.Properties.Strings.Video_codec)
            {
                if (form4.remove_invalid == true) btn_clean_list.PerformClick();
                if (listView1.Items.Count > 999)
                {
                    start_total_time = 0;
                    time_n_tasks = 0;
                    timer_adding.Enabled = true;
                    timer_adding.Start();
                    txt_add_remain.Enabled = true;
                    pg_adding.Maximum = listView1.Items.Count;
                    pg_adding.Value = 0;
                }
                BG_Vfilter.RunWorkerAsync();
            }

            if (form4.filter_type == FFBatch.Properties.Strings.v_bitr)
            {
                if (form4.remove_invalid == true) btn_clean_list.PerformClick();
                if (listView1.Items.Count > 999)
                {
                    start_total_time = 0;
                    time_n_tasks = 0;
                    timer_adding.Enabled = true;
                    timer_adding.Start();
                    txt_add_remain.Enabled = true;
                    pg_adding.Maximum = listView1.Items.Count;
                    pg_adding.Value = 0;
                }
                BG_Video_Bitrate.RunWorkerAsync();
            }

            if (form4.filter_type == FFBatch.Properties.Strings.Audio_codec)
            {
                if (form4.remove_invalid == true) btn_clean_list.PerformClick();
                if (listView1.Items.Count > 999)
                {
                    start_total_time = 0;
                    time_n_tasks = 0;
                    timer_adding.Enabled = true;
                    timer_adding.Start();
                    txt_add_remain.Enabled = true;
                    pg_adding.Maximum = listView1.Items.Count;
                    pg_adding.Value = 0;
                }
                BG_AFilter.RunWorkerAsync();
            }

            if (form4.filter_type == FFBatch.Properties.Strings.fr_rate)
            {
                if (form4.remove_invalid == true) btn_clean_list.PerformClick();
                if (listView1.Items.Count > 999)
                {
                    start_total_time = 0;
                    time_n_tasks = 0;
                    timer_adding.Enabled = true;
                    timer_adding.Start();
                    txt_add_remain.Enabled = true;
                    pg_adding.Maximum = listView1.Items.Count;
                    pg_adding.Value = 0;
                }
                BG_FRate.RunWorkerAsync();
            }

            if (form4.filter_type == "Frame size")
            {
                if (form4.remove_invalid == true) btn_clean_list.PerformClick();
                if (listView1.Items.Count > 999)
                {
                    start_total_time = 0;
                    time_n_tasks = 0;
                    timer_adding.Enabled = true;
                    timer_adding.Start();
                    txt_add_remain.Enabled = true;
                    pg_adding.Maximum = listView1.Items.Count;
                    pg_adding.Value = 0;
                }
                BG_Fsize.RunWorkerAsync();
            }

            if (form4.filter_type == FFBatch.Properties.Strings.c_str)
            {
                if (form4.remove_invalid == true) btn_clean_list.PerformClick();
                if (listView1.Items.Count > 999)
                {
                    start_total_time = 0;
                    time_n_tasks = 0;
                    timer_adding.Enabled = true;
                    timer_adding.Start();
                    txt_add_remain.Enabled = true;
                    pg_adding.Maximum = listView1.Items.Count;
                    pg_adding.Value = 0;
                }
                BG_Custom_search.RunWorkerAsync();
            }

            if (form4.filter_type == FFBatch.Properties.Strings.c_str + " " + "(MI)")
            {
                if (form4.remove_invalid == true) btn_clean_list.PerformClick();
                if (listView1.Items.Count > 999)
                {
                    start_total_time = 0;
                    time_n_tasks = 0;
                    timer_adding.Enabled = true;
                    timer_adding.Start();
                    txt_add_remain.Enabled = true;
                    pg_adding.Maximum = listView1.Items.Count;
                    pg_adding.Value = 0;
                }
                BG_custom_MI.RunWorkerAsync();
            }

            if (form4.filter_type == FFBatch.Properties.Strings.Metadata)
            {
                if (form4.remove_invalid == true) btn_clean_list.PerformClick();
                if (listView1.Items.Count > 999)
                {
                    start_total_time = 0;
                    time_n_tasks = 0;
                    timer_adding.Enabled = true;
                    timer_adding.Start();
                    txt_add_remain.Enabled = true;
                    pg_adding.Maximum = listView1.Items.Count;
                    pg_adding.Value = 0;
                }
                BG_Metadata.RunWorkerAsync();
            }

            lbl_items.Text = listView1.Items.Count + " " + FFBatch.Properties.Strings.files;
            calc_list_dur();
            calc_list_size();
        }

        private void btn_undo_filter_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            LB_Wait.Visible = false;
            if (btn_undo_filter.ImageKey == "undo_20.png")
            {
                btn_undo_filter.ImageKey = "redo_20.png";
                tool_undo_filter.SetToolTip(this.btn_undo_filter, FFBatch.Properties.Strings.r_fil);

                //Fill with original listview items
                listView1.Items.Clear();
                listView1.SmallImageList = imageList2;

                ListViewItem[] itemsToAdd = new ListViewItem[unfilter_lv1.Items.Count];

                for (int n = 0; n < unfilter_lv1.Items.Count; n++)
                {
                    Icon iconForFile = SystemIcons.WinLogo;

                    String new_item = unfilter_lv1.Items[n].SubItems[1].Text + "\\" + unfilter_lv1.Items[n].Text;
                    if (!imageList2.Images.ContainsKey(System.IO.Path.GetExtension(new_item)))
                    {
                        iconForFile = System.Drawing.Icon.ExtractAssociatedIcon(new_item);
                        imageList2.Images.Add(System.IO.Path.GetExtension(new_item), iconForFile);
                    }

                    itemsToAdd[n] = new ListViewItem(Path.GetFileName(new_item));
                    itemsToAdd[n].ImageKey = System.IO.Path.GetExtension(new_item);
                    itemsToAdd[n].BackColor = unfilter_lv1.Items[n].BackColor;
                    itemsToAdd[n].SubItems.Add(unfilter_lv1.Items[n].SubItems[1].Text);
                    itemsToAdd[n].SubItems.Add(unfilter_lv1.Items[n].SubItems[2].Text);
                    itemsToAdd[n].SubItems.Add(unfilter_lv1.Items[n].SubItems[3].Text);
                    itemsToAdd[n].SubItems.Add(unfilter_lv1.Items[n].SubItems[4].Text);
                    itemsToAdd[n].SubItems.Add(unfilter_lv1.Items[n].SubItems[5].Text);
                }

                listView1.Items.AddRange(itemsToAdd.ToArray());
                btn_undo_filter.Refresh();
            }
            else
            {
                btn_undo_filter.ImageKey = "undo_20.png";
                tool_undo_filter.SetToolTip(this.btn_undo_filter, FFBatch.Properties.Strings.undo_fil);
                btn_undo_filter.Refresh();

                //Fill with filtered listview items
                listView1.Items.Clear();
                listView1.SmallImageList = imageList2;

                ListViewItem[] itemsToAdd = new ListViewItem[filtered_lv1.Items.Count];

                for (int n = 0; n < filtered_lv1.Items.Count; n++)
                {
                    Icon iconForFile = SystemIcons.WinLogo;
                    String new_item = filtered_lv1.Items[n].SubItems[1].Text + "\\" + filtered_lv1.Items[n].Text;

                    if (!imageList2.Images.ContainsKey(System.IO.Path.GetExtension(unfilter_lv1.Items[n].Text)))
                    {
                        iconForFile = System.Drawing.Icon.ExtractAssociatedIcon(new_item);
                        imageList2.Images.Add(System.IO.Path.GetExtension(new_item), iconForFile);
                    }

                    itemsToAdd[n] = new ListViewItem(Path.GetFileName(new_item));
                    itemsToAdd[n].ImageKey = Path.GetExtension(new_item);
                    itemsToAdd[n].BackColor = filtered_lv1.Items[n].BackColor;
                    itemsToAdd[n].SubItems.Add(filtered_lv1.Items[n].SubItems[1].Text);
                    itemsToAdd[n].SubItems.Add(filtered_lv1.Items[n].SubItems[2].Text);
                    itemsToAdd[n].SubItems.Add(filtered_lv1.Items[n].SubItems[3].Text);
                    itemsToAdd[n].SubItems.Add(filtered_lv1.Items[n].SubItems[4].Text);
                    itemsToAdd[n].SubItems.Add(filtered_lv1.Items[n].SubItems[5].Text);
                }
                listView1.Items.AddRange(itemsToAdd.ToArray());
            }

            lbl_items.Text = listView1.Items.Count + " " + FFBatch.Properties.Strings.files;
            calc_list_dur();
            calc_list_size();
        }

        private void BG_Vfilter_DoWork(object sender, DoWorkEventArgs e)
        {
            Disable_Controls();
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.btn_pause.Enabled = false);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.pg_adding.Visible = true);
            this.InvokeEx(f => f.pg_adding.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Visible = true);
            this.InvokeEx(f => f.txt_adding_p.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Refresh());
            this.InvokeEx(f => f.LB_Wait.Visible = true);
            this.InvokeEx(f => f.LB_Wait.Enabled = true);
            this.InvokeEx(f => f.lbl_items.Visible = false);
            this.InvokeEx(f => f.lbl_items.Refresh());
            this.InvokeEx(f => f.lbl_dur_list.Visible = false);
            this.InvokeEx(f => f.lbl_dur_list.Refresh());
            this.InvokeEx(f => f.lbl_size.Visible = false);
            this.InvokeEx(f => f.lbl_size.Refresh());
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Minimum = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.btn_cancel_add.Visible = true);
            this.InvokeEx(f => f.btn_cancel_add.Enabled = true);
            canceled_file_adding = false;

            int i = 0;
            int removed = 0;

            String select_stream = String.Empty;
            if (form4.stream_n == FFBatch.Properties.Strings.f_str) select_stream = "Stream #0:0";
            if (form4.stream_n == FFBatch.Properties.Strings.s_str) select_stream = "Stream #0:1";
            if (form4.stream_n == FFBatch.Properties.Strings.any_str) select_stream = "Stream #";

            String item = String.Empty;
            this.InvokeEx(f => f.listView1.BeginUpdate());
            for (int n = 0; n < listView1.Items.Count; n++)
            {
                List<string> lines_ouput = new List<string>();
                Boolean has_video_stream = false;
                Boolean has_video_first_stream = false;
                Boolean has_streams = false;
                Boolean to_remove = false;
                Boolean match = false;

                this.InvokeEx(f => item = listView1.Items[n].SubItems[1].Text + "\\" + listView1.Items[n].Text);
                if (canceled_file_adding == false)
                {
                    Process ff_str = new Process();
                    ff_str.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");
                    ff_str.StartInfo.Arguments = " -i " + '\u0022' + item + '\u0022' + " -hide_banner";
                    ff_str.StartInfo.RedirectStandardOutput = true;
                    ff_str.StartInfo.RedirectStandardError = true;
                    ff_str.StartInfo.UseShellExecute = false;
                    ff_str.StartInfo.CreateNoWindow = true;
                    ff_str.EnableRaisingEvents = true;
                    ff_str.Start();
                    String stream = "";
                    while (!ff_str.StandardError.EndOfStream)
                    {
                        stream = ff_str.StandardError.ReadLine();
                        lines_ouput.Add(stream);
                    }
                    ff_str.WaitForExit();

                    foreach (String line in lines_ouput)
                    {
                        if (line.ToLower().Contains("invalid data")) has_streams = false;
                        if (line.Contains("Stream #")) has_streams = true;
                        if (line.Contains("Stream #") == true && line.Contains("Video:") == true) has_video_stream = true;
                        if (line.Contains("Stream #0:0") == true && line.Contains("Video:") == true) has_video_first_stream = true;

                        if (select_stream == "Stream #0:0" && line.Contains(select_stream))
                        {
                            has_streams = true;
                            if (line.ToLower().Contains(form4.filter_value))
                            {
                                match = true;
                            }
                            else
                            {
                                match = false;
                            }
                            break;
                        }

                        if (select_stream == "Stream #0:1" && line.Contains(select_stream))
                        {
                            has_streams = true;

                            if (line.ToLower().Contains(form4.filter_value))
                            {
                                match = true;
                            }
                            else
                            {
                                match = false;
                            }
                            break;
                        }

                        if (select_stream == ("Stream #"))
                        {
                            has_streams = true;
                            if (line.ToLower().Contains(form4.filter_value))
                            {
                                match = true;
                            }
                        }
                    }

                    if (match == true && form4.filter_action == FFBatch.Properties.Strings.remove) to_remove = true;
                    if (match == true && form4.filter_action == FFBatch.Properties.Strings.keep) to_remove = false;
                    if (match == false && form4.filter_action == FFBatch.Properties.Strings.remove) to_remove = false;
                    if (match == false && form4.filter_action == FFBatch.Properties.Strings.keep) to_remove = true;
                    if (has_video_first_stream == false && form4.remove_not_video == true) to_remove = true;

                    if (to_remove == true || has_streams == false)
                    {
                        this.InvokeEx(f => f.listView1.Items[n].Remove());
                        filtered_lv1.Items[n].Remove();
                        n = n - 1;
                        removed = removed + 1;
                        this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count + removed);
                    }
                }
                else
                {
                    this.InvokeEx(f => f.listView1.Items.Clear());
                    this.InvokeEx(f => f.LB_Wait.Visible = false);
                    this.InvokeEx(f => f.btn_undo_filter.Enabled = true);
                    this.InvokeEx(f => f.btn_undo_filter.ImageKey = "undo_20.png");
                    this.InvokeEx(f => f.btn_undo_filter.PerformClick());
                    this.InvokeEx(f => f.btn_undo_filter.Enabled = false);
                    timer_adding.Stop();
                    this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
                    this.InvokeEx(f => f.txt_add_remain.Visible = false);
                    this.InvokeEx(f => f.txt_add_remain.Refresh());
                    break;
                }
                i = i + 1;
                this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.app_f);
                this.InvokeEx(f => f.LB_Wait.Refresh());
                this.InvokeEx(f => f.pg_adding.Value = pg_adding.Value + 1);
                this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, pg_adding.Value, pg_adding.Maximum));
                this.InvokeEx(f => f.pg_adding.Refresh());
                this.InvokeEx(f => f.txt_adding_p.Text = (i * 100 / pg_adding.Maximum).ToString() + "%");
                this.InvokeEx(f => f.txt_adding_p.Refresh());
            }
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
            this.InvokeEx(f => f.listView1.EndUpdate());
            timer_adding.Stop();
            this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
            this.InvokeEx(f => f.txt_add_remain.Visible = false);
            this.InvokeEx(f => f.txt_add_remain.Refresh());

            this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.Removed + " " + (unfilter_lv1.Items.Count - listView1.Items.Count).ToString() + " " + FFBatch.Properties.Strings.files);
        }

        private void BG_Vfilter_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            end_bg_filters();
        }

        private void BG_AFilter_DoWork(object sender, DoWorkEventArgs e)
        {
            Disable_Controls();
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.btn_pause.Enabled = false);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.pg_adding.Visible = true);
            this.InvokeEx(f => f.pg_adding.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Visible = true);
            this.InvokeEx(f => f.txt_adding_p.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Refresh());
            this.InvokeEx(f => f.LB_Wait.Visible = true);
            this.InvokeEx(f => f.LB_Wait.Enabled = true);
            this.InvokeEx(f => f.lbl_items.Visible = false);
            this.InvokeEx(f => f.lbl_items.Refresh());
            this.InvokeEx(f => f.lbl_dur_list.Visible = false);
            this.InvokeEx(f => f.lbl_dur_list.Refresh());
            this.InvokeEx(f => f.lbl_size.Visible = false);
            this.InvokeEx(f => f.lbl_size.Refresh());
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Minimum = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.btn_cancel_add.Visible = true);
            this.InvokeEx(f => f.btn_cancel_add.Enabled = true);
            canceled_file_adding = false;

            int i = 0;
            int removed = 0;

            String select_stream = String.Empty;
            if (form4.stream_n == FFBatch.Properties.Strings.f_str) select_stream = "Stream #0:0";
            if (form4.stream_n == FFBatch.Properties.Strings.s_str) select_stream = "Stream #0:1";
            if (form4.stream_n == FFBatch.Properties.Strings.any_str) select_stream = "Stream #";

            String item = String.Empty;
            this.InvokeEx(f => f.listView1.BeginUpdate());
            for (int n = 0; n < listView1.Items.Count; n++)
            {
                List<string> lines_ouput = new List<string>();
                Boolean has_video_stream = false;
                Boolean has_video_first_stream = false;
                Boolean has_streams = false;
                Boolean to_remove = false;
                Boolean match = false;

                this.InvokeEx(f => item = listView1.Items[n].SubItems[1].Text + "\\" + listView1.Items[n].Text);
                if (canceled_file_adding == false)
                {
                    Process ff_str = new Process();
                    ff_str.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");
                    ff_str.StartInfo.Arguments = " -i " + '\u0022' + item + '\u0022' + " -hide_banner";
                    ff_str.StartInfo.RedirectStandardOutput = true;
                    ff_str.StartInfo.RedirectStandardError = true;
                    ff_str.StartInfo.UseShellExecute = false;
                    ff_str.StartInfo.CreateNoWindow = true;
                    ff_str.EnableRaisingEvents = true;
                    ff_str.Start();
                    String stream = "";
                    while (!ff_str.StandardError.EndOfStream)
                    {
                        stream = ff_str.StandardError.ReadLine();
                        lines_ouput.Add(stream);
                    }
                    ff_str.WaitForExit();

                    foreach (String line in lines_ouput)
                    {
                        if (line.ToLower().Contains("invalid data")) has_streams = false;
                        if (line.Contains("Stream #")) has_streams = true;
                        if (line.Contains("Stream #") == true && line.Contains("Video:") == true) has_video_stream = true;
                        if (line.Contains("Stream #0:0") == true && line.Contains("Video:") == true) has_video_first_stream = true;

                        if (select_stream == "Stream #0:0" && line.Contains(select_stream))
                        {
                            has_streams = true;
                            if (line.ToLower().Contains(form4.filter_value))
                            {
                                match = true;
                            }
                            else
                            {
                                match = false;
                            }
                            break;
                        }

                        if (select_stream == "Stream #0:1" && line.Contains(select_stream))
                        {
                            has_streams = true;

                            if (line.ToLower().Contains(form4.filter_value))
                            {
                                match = true;
                            }
                            else
                            {
                                match = false;
                            }
                            break;
                        }

                        if (select_stream == ("Stream #"))
                        {
                            has_streams = true;
                            if (line.ToLower().Contains(form4.filter_value))
                            {
                                match = true;
                            }
                        }
                    }

                    if (match == true && form4.filter_action == FFBatch.Properties.Strings.remove) to_remove = true;
                    if (match == true && form4.filter_action == FFBatch.Properties.Strings.keep) to_remove = false;
                    if (match == false && form4.filter_action == FFBatch.Properties.Strings.remove) to_remove = false;
                    if (match == false && form4.filter_action == FFBatch.Properties.Strings.keep) to_remove = true;
                    if (has_video_first_stream == false && form4.remove_not_video == true) to_remove = true;

                    if (to_remove == true || has_streams == false)
                    {
                        this.InvokeEx(f => f.listView1.Items[n].Remove());
                        filtered_lv1.Items[n].Remove();
                        n = n - 1;
                        removed = removed + 1;
                        this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count + removed);
                    }
                }
                else
                {
                    this.InvokeEx(f => f.listView1.Items.Clear());
                    this.InvokeEx(f => f.LB_Wait.Visible = false);
                    this.InvokeEx(f => f.btn_undo_filter.Enabled = true);
                    this.InvokeEx(f => f.btn_undo_filter.ImageKey = "undo_20.png");
                    this.InvokeEx(f => f.btn_undo_filter.PerformClick());
                    this.InvokeEx(f => f.btn_undo_filter.Enabled = false);
                    timer_adding.Stop();
                    this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
                    this.InvokeEx(f => f.txt_add_remain.Visible = false);
                    this.InvokeEx(f => f.txt_add_remain.Refresh());
                    break;
                }
                i = i + 1;
                this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.app_f);
                this.InvokeEx(f => f.LB_Wait.Refresh());
                this.InvokeEx(f => f.pg_adding.Value = pg_adding.Value + 1);
                this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, pg_adding.Value, pg_adding.Maximum));
                this.InvokeEx(f => f.pg_adding.Refresh());
                this.InvokeEx(f => f.txt_adding_p.Text = (i * 100 / pg_adding.Maximum).ToString() + "%");
                this.InvokeEx(f => f.txt_adding_p.Refresh());
            }
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
            this.InvokeEx(f => f.listView1.EndUpdate());
            timer_adding.Stop();
            this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
            this.InvokeEx(f => f.txt_add_remain.Visible = false);
            this.InvokeEx(f => f.txt_add_remain.Refresh());

            this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.Removed + " " + (unfilter_lv1.Items.Count - listView1.Items.Count).ToString() + " " + FFBatch.Properties.Strings.files);
        }

        private void end_bg_filters()
        {
            Enable_Controls();

            this.InvokeEx(f => f.btn_cancel_add.Visible = false);
            this.InvokeEx(f => f.txt_adding_p.Visible = false);
            this.InvokeEx(f => f.pg_adding.Visible = false);
            this.InvokeEx(f => f.lbl_items.Visible = true);
            this.InvokeEx(f => f.lbl_items.Text = listView1.Items.Count.ToString() + " " + FFBatch.Properties.Strings.files);
            this.InvokeEx(f => f.lbl_items.Refresh());
            this.InvokeEx(f => f.lbl_dur_list.Visible = true);
            this.InvokeEx(f => f.lbl_dur_list.Refresh());
            this.InvokeEx(f => f.lbl_size.Visible = true);
            this.InvokeEx(f => f.lbl_size.Refresh());
            calc_list_dur();
            calc_list_size();
        }

        private void BG_AFilter_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            end_bg_filters();
        }

        private void BG_FRate_DoWork(object sender, DoWorkEventArgs e)
        {
            Disable_Controls();
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.btn_pause.Enabled = false);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.pg_adding.Visible = true);
            this.InvokeEx(f => f.pg_adding.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Visible = true);
            this.InvokeEx(f => f.txt_adding_p.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Refresh());
            this.InvokeEx(f => f.LB_Wait.Visible = true);
            this.InvokeEx(f => f.LB_Wait.Enabled = true);
            this.InvokeEx(f => f.lbl_items.Visible = false);
            this.InvokeEx(f => f.lbl_items.Refresh());
            this.InvokeEx(f => f.lbl_dur_list.Visible = false);
            this.InvokeEx(f => f.lbl_dur_list.Refresh());
            this.InvokeEx(f => f.lbl_size.Visible = false);
            this.InvokeEx(f => f.lbl_size.Refresh());
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Minimum = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.btn_cancel_add.Visible = true);
            this.InvokeEx(f => f.btn_cancel_add.Enabled = true);
            canceled_file_adding = false;

            int i = 0;
            int removed = 0;

            String select_stream = String.Empty;

            String item = String.Empty;
            this.InvokeEx(f => f.listView1.BeginUpdate());
            for (int n = 0; n < listView1.Items.Count; n++)
            {
                Boolean has_streams = false;
                Boolean is_video = false;
                Boolean to_remove = false;
                decimal fade_frames = 0;
                Boolean match = false;

                this.InvokeEx(f => item = listView1.Items[n].SubItems[1].Text + "\\" + listView1.Items[n].Text);
                if (canceled_file_adding == false)
                {
                    String ff_frames = String.Empty;
                    Process get_frames = new Process();
                    get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
                    String ffprobe_frames = " " + '\u0022' + "--Inform=Video;%FrameRate%" + '\u0022';
                    get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + item + '\u0022';
                    get_frames.StartInfo.RedirectStandardOutput = true;
                    get_frames.StartInfo.RedirectStandardError = true;
                    get_frames.StartInfo.UseShellExecute = false;
                    get_frames.StartInfo.CreateNoWindow = true;
                    get_frames.EnableRaisingEvents = true;
                    get_frames.Start();

                    ff_frames = get_frames.StandardOutput.ReadLine();
                    get_frames.WaitForExit();
                    String fade_string = String.Empty;
                    if (get_frames.ExitCode == 0)
                    {
                        if (ff_frames != null)
                        {
                            try
                            {
                                fade_frames = decimal.Parse(ff_frames) / 1000;
                                fade_string = fade_frames.ToString().Replace(",", ".");
                                is_video = true;
                            }
                            catch
                            {
                                fade_frames = 0;
                                is_video = false;
                            }

                            has_streams = true;
                        }
                        else
                        {
                            has_streams = false;
                        }
                    }

                    if (form4.filter_value == fade_string && fade_frames != 0)
                    {
                        match = true;
                    }

                    if (match == true && form4.filter_action == FFBatch.Properties.Strings.remove) to_remove = true;
                    if (match == true && form4.filter_action == FFBatch.Properties.Strings.keep) to_remove = false;
                    if (match == false && form4.filter_action == FFBatch.Properties.Strings.remove) to_remove = false;
                    if (match == false && form4.filter_action == FFBatch.Properties.Strings.keep) to_remove = true;

                    if (fade_frames == 0) has_streams = false;

                    //if (has_audio_first_stream == false && form4.remove_not_video == true) to_remove = true;
                    //MessageBox.Show("Has streams: " + has_streams.ToString() + " Has audio stream: " + has_audio_stream.ToString() + " Has first video stream: " + has_audio_first_stream.ToString() + "---Remove? = " + to_remove.ToString());

                    if (to_remove == true || has_streams == false || is_video == false)
                    {
                        this.InvokeEx(f => f.listView1.Items[n].Remove());
                        filtered_lv1.Items[n].Remove();
                        n = n - 1;
                        removed = removed + 1;
                        this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count + removed);
                    }
                }
                else
                {
                    this.InvokeEx(f => f.listView1.Items.Clear());
                    this.InvokeEx(f => f.LB_Wait.Visible = false);
                    this.InvokeEx(f => f.btn_undo_filter.Enabled = true);
                    this.InvokeEx(f => f.btn_undo_filter.ImageKey = "undo_20.png");
                    this.InvokeEx(f => f.btn_undo_filter.PerformClick());
                    this.InvokeEx(f => f.btn_undo_filter.Enabled = false);
                    timer_adding.Stop();
                    this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
                    this.InvokeEx(f => f.txt_add_remain.Visible = false);
                    this.InvokeEx(f => f.txt_add_remain.Refresh());
                    break;
                }
                i = i + 1;
                this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.app_f);
                this.InvokeEx(f => f.LB_Wait.Refresh());
                this.InvokeEx(f => f.pg_adding.Value = pg_adding.Value + 1);
                this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, pg_adding.Value, pg_adding.Maximum));
                this.InvokeEx(f => f.pg_adding.Refresh());
                this.InvokeEx(f => f.txt_adding_p.Text = (i * 100 / pg_adding.Maximum).ToString() + "%");
                this.InvokeEx(f => f.txt_adding_p.Refresh());
            }
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
            this.InvokeEx(f => f.listView1.EndUpdate());
            timer_adding.Stop();
            this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
            this.InvokeEx(f => f.txt_add_remain.Visible = false);
            this.InvokeEx(f => f.txt_add_remain.Refresh());
            this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.Removed + " " + (unfilter_lv1.Items.Count - listView1.Items.Count).ToString() + " " + FFBatch.Properties.Strings.files);
        }

        private void BG_FRate_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            end_bg_filters();
        }

        private void BG_Fsize_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            end_bg_filters();
        }

        private void BG_Fsize_DoWork(object sender, DoWorkEventArgs e)
        {
            Disable_Controls();
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.btn_pause.Enabled = false);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.pg_adding.Visible = true);
            this.InvokeEx(f => f.pg_adding.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Visible = true);
            this.InvokeEx(f => f.txt_adding_p.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Refresh());
            this.InvokeEx(f => f.LB_Wait.Visible = true);
            this.InvokeEx(f => f.LB_Wait.Enabled = true);
            this.InvokeEx(f => f.lbl_items.Visible = false);
            this.InvokeEx(f => f.lbl_items.Refresh());
            this.InvokeEx(f => f.lbl_dur_list.Visible = false);
            this.InvokeEx(f => f.lbl_dur_list.Refresh());
            this.InvokeEx(f => f.lbl_size.Visible = false);
            this.InvokeEx(f => f.lbl_size.Refresh());
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Minimum = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.btn_cancel_add.Visible = true);
            this.InvokeEx(f => f.btn_cancel_add.Enabled = true);
            canceled_file_adding = false;

            int i = 0;
            int removed = 0;
            String select_stream = String.Empty;

            String item = String.Empty;
            this.InvokeEx(f => f.listView1.BeginUpdate());
            for (int n = 0; n < listView1.Items.Count; n++)
            {
                Boolean has_streams = false;
                Boolean has_video = false;
                Boolean to_remove = false;
                Boolean match = false;

                this.InvokeEx(f => item = listView1.Items[n].SubItems[1].Text + "\\" + listView1.Items[n].Text);
                if (canceled_file_adding == false)
                {
                    String ff_frames = String.Empty;
                    Process get_frames = new Process();
                    get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "Mediainfo.exe");
                    String ffprobe_frames = "--Inform=Video;%Width%" + "x" + "%Height%";
                    get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + item + '\u0022';

                    get_frames.StartInfo.RedirectStandardOutput = true;
                    get_frames.StartInfo.RedirectStandardError = true;
                    get_frames.StartInfo.UseShellExecute = false;
                    get_frames.StartInfo.CreateNoWindow = true;
                    get_frames.EnableRaisingEvents = true;
                    get_frames.Start();

                    ff_frames = get_frames.StandardOutput.ReadLine();
                    get_frames.WaitForExit();

                    if (get_frames.ExitCode == 0)
                    {
                        if (ff_frames != null)
                        {
                            has_streams = true;
                            if (ff_frames.ToLower().Contains("x"))
                            {
                                has_video = true;
                            }
                            else
                            {
                                has_video = false;
                            }
                        }
                        else
                        {
                            ff_frames = String.Empty;
                            has_streams = false;
                        }
                    }
                    if (form4.filter_value == ff_frames && ff_frames != String.Empty)
                    {
                        match = true;
                    }

                    if (match == true && form4.filter_action == FFBatch.Properties.Strings.remove) to_remove = true;
                    if (match == true && form4.filter_action == FFBatch.Properties.Strings.keep) to_remove = false;
                    if (match == false && form4.filter_action == FFBatch.Properties.Strings.remove) to_remove = false;
                    if (match == false && form4.filter_action == FFBatch.Properties.Strings.keep) to_remove = true;

                    if (ff_frames == String.Empty) has_streams = false;

                    //if (has_audio_first_stream == false && form4.remove_not_video == true) to_remove = true;
                    //MessageBox.Show("Has streams: " + has_streams.ToString() + " Has audio stream: " + has_audio_stream.ToString() + " Has first video stream: " + has_audio_first_stream.ToString() + "---Remove? = " + to_remove.ToString());

                    if (to_remove == true || has_streams == false)
                    {
                        this.InvokeEx(f => f.listView1.Items[n].Remove());
                        filtered_lv1.Items[n].Remove();
                        n = n - 1;
                        removed = removed + 1;
                        this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count + removed);
                    }
                }
                else
                {
                    this.InvokeEx(f => f.listView1.Items.Clear());
                    this.InvokeEx(f => f.LB_Wait.Visible = false);
                    this.InvokeEx(f => f.btn_undo_filter.Enabled = true);
                    this.InvokeEx(f => f.btn_undo_filter.ImageKey = "undo_20.png");
                    this.InvokeEx(f => f.btn_undo_filter.PerformClick());
                    this.InvokeEx(f => f.btn_undo_filter.Enabled = false);

                    timer_adding.Stop();
                    this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
                    this.InvokeEx(f => f.txt_add_remain.Visible = false);
                    this.InvokeEx(f => f.txt_add_remain.Refresh());
                    break;
                }
                i = i + 1;
                this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.app_f);
                this.InvokeEx(f => f.LB_Wait.Refresh());
                this.InvokeEx(f => f.pg_adding.Value = pg_adding.Value + 1);
                this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, pg_adding.Value, pg_adding.Maximum));
                this.InvokeEx(f => f.pg_adding.Refresh());
                this.InvokeEx(f => f.txt_adding_p.Text = (i * 100 / pg_adding.Maximum).ToString() + "%");
                this.InvokeEx(f => f.txt_adding_p.Refresh());
            }
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
            this.InvokeEx(f => f.listView1.EndUpdate());
            timer_adding.Stop();
            this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
            this.InvokeEx(f => f.txt_add_remain.Visible = false);
            this.InvokeEx(f => f.txt_add_remain.Refresh());
            this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.Removed + " " + (unfilter_lv1.Items.Count - listView1.Items.Count).ToString() + " " + FFBatch.Properties.Strings.files);
        }

        private void BG_Custom_search_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            end_bg_filters();
        }

        private void BG_Custom_search_DoWork(object sender, DoWorkEventArgs e)
        {
            Disable_Controls();
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.btn_pause.Enabled = false);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.pg_adding.Visible = true);
            this.InvokeEx(f => f.pg_adding.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Visible = true);
            this.InvokeEx(f => f.txt_adding_p.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Refresh());
            this.InvokeEx(f => f.LB_Wait.Visible = true);
            this.InvokeEx(f => f.LB_Wait.Enabled = true);
            this.InvokeEx(f => f.lbl_items.Visible = false);
            this.InvokeEx(f => f.lbl_items.Refresh());
            this.InvokeEx(f => f.lbl_dur_list.Visible = false);
            this.InvokeEx(f => f.lbl_dur_list.Refresh());
            this.InvokeEx(f => f.lbl_size.Visible = false);
            this.InvokeEx(f => f.lbl_size.Refresh());
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Minimum = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.btn_cancel_add.Visible = true);
            this.InvokeEx(f => f.btn_cancel_add.Enabled = true);
            canceled_file_adding = false;

            int i = 0;
            int removed = 0;

            String select_stream = String.Empty;
            if (form4.stream_n == FFBatch.Properties.Strings.f_str) select_stream = "Stream #0:0";
            if (form4.stream_n == FFBatch.Properties.Strings.s_str) select_stream = "Stream #0:1";
            if (form4.stream_n == FFBatch.Properties.Strings.any_str) select_stream = "Stream #";

            String item = String.Empty;
            this.InvokeEx(f => f.listView1.BeginUpdate());
            for (int n = 0; n < listView1.Items.Count; n++)
            {
                List<string> lines_ouput = new List<string>();
                Boolean has_streams = false;
                Boolean to_remove = false;
                Boolean match = false;

                this.InvokeEx(f => item = listView1.Items[n].SubItems[1].Text + "\\" + listView1.Items[n].Text);
                if (canceled_file_adding == false)
                {
                    Process ff_str = new Process();
                    ff_str.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");
                    ff_str.StartInfo.Arguments = " -i " + '\u0022' + item + '\u0022' + " -hide_banner";
                    ff_str.StartInfo.RedirectStandardOutput = true;
                    ff_str.StartInfo.RedirectStandardError = true;
                    ff_str.StartInfo.UseShellExecute = false;
                    ff_str.StartInfo.CreateNoWindow = true;
                    ff_str.EnableRaisingEvents = true;
                    ff_str.Start();
                    String stream = "";
                    while (!ff_str.StandardError.EndOfStream)
                    {
                        stream = ff_str.StandardError.ReadLine();
                        lines_ouput.Add(stream);
                    }
                    ff_str.WaitForExit();

                    foreach (String line in lines_ouput)
                    {
                        if (line.ToLower().Contains("invalid data")) has_streams = false;
                        if (line.Contains("Stream #")) has_streams = true;

                        if (select_stream == "Stream #0:1" && line.Contains(select_stream))
                        {
                            if (line.ToLower().Contains(form4.filter_value.ToLower()))
                            {
                                match = true;
                            }
                            else
                            {
                                match = false;
                            }
                            break;
                        }

                        if (select_stream == "Stream #0:0" && line.Contains(select_stream))
                        {
                            if (line.ToLower().Contains(form4.filter_value.ToLower()))
                            {
                                match = true;
                            }
                            else
                            {
                                match = false;
                            }
                            break;
                        }

                        if (select_stream == ("Stream #"))
                        {
                            if (line.ToLower().Contains(form4.filter_value.ToLower()))
                            {
                                match = true;
                            }
                        }
                    }

                    if (match == true && form4.filter_action == FFBatch.Properties.Strings.remove) to_remove = true;
                    if (match == true && form4.filter_action == FFBatch.Properties.Strings.keep) to_remove = false;
                    if (match == false && form4.filter_action == FFBatch.Properties.Strings.remove) to_remove = false;
                    if (match == false && form4.filter_action == FFBatch.Properties.Strings.keep) to_remove = true;

                    if (to_remove == true || has_streams == false)
                    {
                        this.InvokeEx(f => f.listView1.Items[n].Remove());
                        filtered_lv1.Items[n].Remove();
                        n = n - 1;
                        removed = removed + 1;
                        this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count + removed);
                    }
                }
                else
                {
                    this.InvokeEx(f => f.listView1.Items.Clear());
                    this.InvokeEx(f => f.LB_Wait.Visible = false);
                    this.InvokeEx(f => f.btn_undo_filter.Enabled = true);
                    this.InvokeEx(f => f.btn_undo_filter.ImageKey = "undo_20.png");
                    this.InvokeEx(f => f.btn_undo_filter.PerformClick());
                    this.InvokeEx(f => f.btn_undo_filter.Enabled = false);
                    timer_adding.Stop();
                    this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
                    this.InvokeEx(f => f.txt_add_remain.Visible = false);
                    this.InvokeEx(f => f.txt_add_remain.Refresh());
                    break;
                }

                i = i + 1;
                this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.app_f);
                this.InvokeEx(f => f.LB_Wait.Refresh());
                this.InvokeEx(f => f.pg_adding.Value = pg_adding.Value + 1);
                this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, pg_adding.Value, pg_adding.Maximum));
                this.InvokeEx(f => f.pg_adding.Refresh());
                this.InvokeEx(f => f.txt_adding_p.Text = (i * 100 / pg_adding.Maximum).ToString() + "%");
                this.InvokeEx(f => f.txt_adding_p.Refresh());
            }
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
            this.InvokeEx(f => f.listView1.EndUpdate());
            timer_adding.Stop();
            this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
            this.InvokeEx(f => f.txt_add_remain.Visible = false);
            this.InvokeEx(f => f.txt_add_remain.Refresh());
            this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.Removed + " " + (unfilter_lv1.Items.Count - listView1.Items.Count).ToString() + " " + FFBatch.Properties.Strings.files);
        }

        private void timer_adding_Tick(object sender, EventArgs e)
        {
            start_total_time = start_total_time + 1;
            time_n_tasks = time_n_tasks + 1;
            this.InvokeEx(f => f.txt_add_remain.Text = FFBatch.Properties.Strings.remain_time);
            this.InvokeEx(f => f.txt_add_remain.Refresh());

            try
            {
                if (Convert.ToUInt16(txt_adding_p.Text.Replace("%", "")) > 1 || start_total_time > 9)
                {
                    this.InvokeEx(f => f.txt_add_remain.Visible = true);
                    Double remain_secs = time_n_tasks * 100 / Convert.ToUInt16(txt_adding_p.Text.Replace("%", "")) - start_total_time;
                    //Double remain_secs = start_total_time;
                    String remain_string = String.Empty;

                    TimeSpan t = TimeSpan.FromSeconds(remain_secs);
                    remain_string = string.Format("{0:D2}h:{1:D2}",
                    t.Hours,
                    t.Minutes);

                    if (remain_secs >= 43200)
                    {
                        this.InvokeEx(f => f.txt_add_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Math.Round(remain_secs / 3600).ToString() + " " + FFBatch.Properties.Strings.hours);
                    }

                    if (remain_secs >= 3600 && remain_secs < 43200)
                    {
                        this.InvokeEx(f => f.txt_add_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_string + " " + FFBatch.Properties.Strings.minutes_abrev);
                    }

                    if (remain_secs < 3600 && remain_secs >= 600)
                    {
                        this.InvokeEx(f => f.txt_add_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_string.Substring(remain_string.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes);
                    }
                    if (remain_secs < 600 && remain_secs >= 120)
                    {
                        this.InvokeEx(f => f.txt_add_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_string.Substring(remain_string.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes);
                    }

                    if (remain_secs < 120 && remain_secs > 59)
                    {
                        this.InvokeEx(f => f.txt_add_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.about_1);
                    }

                    if (remain_secs <= 59)
                    {
                        this.InvokeEx(f => f.txt_add_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.less_one);
                    }
                    if (remain_secs <= 0)
                    {
                        this.InvokeEx(f => f.txt_add_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.almost_done);
                    }
                    this.InvokeEx(f => f.txt_remain.Refresh());
                }
                else
                {
                    this.InvokeEx(f => f.txt_add_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.calcul);
                    this.InvokeEx(f => f.txt_add_remain.Refresh());
                }
            }
            catch
            {
                this.InvokeEx(f => f.txt_add_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.calcul);
                this.InvokeEx(f => f.txt_add_remain.Refresh());
            }
            this.InvokeEx(f => f.txt_add_remain.Refresh());
        }

        private void BG_File_Bitrate_DoWork(object sender, DoWorkEventArgs e)
        {
            Disable_Controls();
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.btn_pause.Enabled = false);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.pg_adding.Visible = true);
            this.InvokeEx(f => f.pg_adding.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Visible = true);
            this.InvokeEx(f => f.txt_adding_p.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Refresh());
            this.InvokeEx(f => f.LB_Wait.Visible = true);
            this.InvokeEx(f => f.LB_Wait.Enabled = true);
            this.InvokeEx(f => f.lbl_items.Visible = false);
            this.InvokeEx(f => f.lbl_items.Refresh());
            this.InvokeEx(f => f.lbl_dur_list.Visible = false);
            this.InvokeEx(f => f.lbl_dur_list.Refresh());
            this.InvokeEx(f => f.lbl_size.Visible = false);
            this.InvokeEx(f => f.lbl_size.Refresh());
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Minimum = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.btn_cancel_add.Visible = true);
            this.InvokeEx(f => f.btn_cancel_add.Enabled = true);
            canceled_file_adding = false;

            int i = 0;
            int removed = 0;

            String select_stream = String.Empty;

            String item = String.Empty;
            this.InvokeEx(f => f.listView1.BeginUpdate());
            for (int n = 0; n < listView1.Items.Count; n++)
            {
                Boolean has_streams = false;
                Boolean is_video = false;
                Boolean to_remove = false;
                int fade_frames = 0;
                Boolean match = false;

                this.InvokeEx(f => item = listView1.Items[n].SubItems[1].Text + "\\" + listView1.Items[n].Text);
                if (canceled_file_adding == false)
                {
                    String ff_frames = String.Empty;
                    Process get_frames = new Process();
                    get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
                    String ffprobe_frames = " " + '\u0022' + "--Output=General;%OverallBitRate% " + '\u0022';
                    get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + item + '\u0022';
                    get_frames.StartInfo.RedirectStandardOutput = true;
                    get_frames.StartInfo.RedirectStandardError = true;
                    get_frames.StartInfo.UseShellExecute = false;
                    get_frames.StartInfo.CreateNoWindow = true;
                    get_frames.EnableRaisingEvents = true;
                    get_frames.Start();

                    ff_frames = get_frames.StandardOutput.ReadLine();
                    get_frames.WaitForExit();
                    String fade_string = String.Empty;
                    if (get_frames.ExitCode == 0)
                    {
                        if (ff_frames != null)
                        {
                            try
                            {
                                fade_frames = Int32.Parse(ff_frames);
                                is_video = true;
                            }
                            catch
                            {
                                fade_frames = 0;
                                is_video = false;
                            }

                            has_streams = true;
                        }
                        else
                        {
                            has_streams = false;
                        }
                    }
                    Int32 filter_value = Int32.Parse(form4.filter_value);
                    if (filter_value * 1000 <= fade_frames && fade_frames != 0)
                    {
                        match = true;
                    }

                    if (match == true && form4.filter_action == FFBatch.Properties.Strings.remove) to_remove = true;
                    if (match == true && form4.filter_action == FFBatch.Properties.Strings.keep) to_remove = false;
                    if (match == false && form4.filter_action == FFBatch.Properties.Strings.remove) to_remove = false;
                    if (match == false && form4.filter_action == FFBatch.Properties.Strings.keep) to_remove = true;

                    if (fade_frames == 0) has_streams = false;

                    if (to_remove == true || has_streams == false || is_video == false)
                    {
                        this.InvokeEx(f => f.listView1.Items[n].Remove());
                        filtered_lv1.Items[n].Remove();
                        n = n - 1;
                        removed = removed + 1;
                        this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count + removed);
                    }
                }
                else
                {
                    this.InvokeEx(f => f.listView1.Items.Clear());
                    this.InvokeEx(f => f.LB_Wait.Visible = false);
                    this.InvokeEx(f => f.btn_undo_filter.Enabled = true);
                    this.InvokeEx(f => f.btn_undo_filter.ImageKey = "undo_20.png");
                    this.InvokeEx(f => f.btn_undo_filter.PerformClick());
                    this.InvokeEx(f => f.btn_undo_filter.Enabled = false);
                    timer_adding.Stop();
                    this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
                    this.InvokeEx(f => f.txt_add_remain.Visible = false);
                    this.InvokeEx(f => f.txt_add_remain.Refresh());
                    break;
                }
                i = i + 1;
                this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.app_f);
                this.InvokeEx(f => f.LB_Wait.Refresh());
                this.InvokeEx(f => f.pg_adding.Value = pg_adding.Value + 1);
                this.InvokeEx(f => f.pg_adding.Refresh());
                this.InvokeEx(f => f.txt_adding_p.Text = (i * 100 / pg_adding.Maximum).ToString() + "%");
                this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, pg_adding.Value, pg_adding.Maximum));
                this.InvokeEx(f => f.txt_adding_p.Refresh());
            }

            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
            this.InvokeEx(f => f.listView1.EndUpdate());
            timer_adding.Stop();
            this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
            this.InvokeEx(f => f.txt_add_remain.Visible = false);
            this.InvokeEx(f => f.txt_add_remain.Refresh());
            this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.Removed + " " + (unfilter_lv1.Items.Count - listView1.Items.Count).ToString() + " " + FFBatch.Properties.Strings.files);
        }

        private void BG_File_Bitrate_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            end_bg_filters();
        }

        private void BG_Video_Bitrate_DoWork(object sender, DoWorkEventArgs e)
        {
            Disable_Controls();
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.btn_pause.Enabled = false);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.pg_adding.Visible = true);
            this.InvokeEx(f => f.pg_adding.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Visible = true);
            this.InvokeEx(f => f.txt_adding_p.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Refresh());
            this.InvokeEx(f => f.LB_Wait.Visible = true);
            this.InvokeEx(f => f.LB_Wait.Enabled = true);
            this.InvokeEx(f => f.lbl_items.Visible = false);
            this.InvokeEx(f => f.lbl_items.Refresh());
            this.InvokeEx(f => f.lbl_dur_list.Visible = false);
            this.InvokeEx(f => f.lbl_dur_list.Refresh());
            this.InvokeEx(f => f.lbl_size.Visible = false);
            this.InvokeEx(f => f.lbl_size.Refresh());
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Minimum = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.btn_cancel_add.Visible = true);
            this.InvokeEx(f => f.btn_cancel_add.Enabled = true);
            canceled_file_adding = false;

            int i = 0;
            int removed = 0;

            String select_stream = String.Empty;

            String item = String.Empty;
            this.InvokeEx(f => f.listView1.BeginUpdate());
            for (int n = 0; n < listView1.Items.Count; n++)
            {
                Boolean has_streams = false;
                Boolean is_video = false;
                Boolean to_remove = false;
                int fade_frames = 0;
                Boolean match = false;

                this.InvokeEx(f => item = listView1.Items[n].SubItems[1].Text + "\\" + listView1.Items[n].Text);
                if (canceled_file_adding == false)
                {
                    String ff_frames = String.Empty;
                    Process get_frames = new Process();
                    get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
                    String ffprobe_frames = " " + '\u0022' + "--Output=Video;%BitRate%" + '\u0022';
                    get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + item + '\u0022';
                    get_frames.StartInfo.RedirectStandardOutput = true;
                    get_frames.StartInfo.RedirectStandardError = true;
                    get_frames.StartInfo.UseShellExecute = false;
                    get_frames.StartInfo.CreateNoWindow = true;
                    get_frames.EnableRaisingEvents = true;
                    get_frames.Start();

                    ff_frames = get_frames.StandardOutput.ReadLine();
                    get_frames.WaitForExit();
                    String fade_string = String.Empty;
                    if (get_frames.ExitCode == 0)
                    {
                        if (ff_frames != null)
                        {
                            try
                            {
                                fade_frames = Int32.Parse(ff_frames);
                                is_video = true;
                            }
                            catch
                            {
                                fade_frames = 0;
                                is_video = false;
                            }

                            has_streams = true;
                        }
                        else
                        {
                            has_streams = false;
                        }
                    }
                    Int32 filter_value = Int32.Parse(form4.filter_value);

                    if (filter_value * 1000 <= fade_frames && fade_frames != 0)
                    {
                        match = true;
                    }

                    if (match == true && form4.filter_action == FFBatch.Properties.Strings.remove) to_remove = true;
                    if (match == true && form4.filter_action == FFBatch.Properties.Strings.keep) to_remove = false;
                    if (match == false && form4.filter_action == FFBatch.Properties.Strings.remove) to_remove = false;
                    if (match == false && form4.filter_action == FFBatch.Properties.Strings.keep) to_remove = true;

                    if (fade_frames == 0) has_streams = false;

                    if (to_remove == true || has_streams == false || is_video == false)
                    {
                        this.InvokeEx(f => f.listView1.Items[n].Remove());
                        filtered_lv1.Items[n].Remove();
                        n = n - 1;
                        removed = removed + 1;
                        this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count + removed);
                    }
                }
                else
                {
                    this.InvokeEx(f => f.listView1.Items.Clear());
                    this.InvokeEx(f => f.LB_Wait.Visible = false);
                    this.InvokeEx(f => f.btn_undo_filter.Enabled = true);
                    this.InvokeEx(f => f.btn_undo_filter.ImageKey = "undo_20.png");
                    this.InvokeEx(f => f.btn_undo_filter.PerformClick());
                    this.InvokeEx(f => f.btn_undo_filter.Enabled = false);
                    timer_adding.Stop();
                    this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
                    this.InvokeEx(f => f.txt_add_remain.Visible = false);
                    this.InvokeEx(f => f.txt_add_remain.Refresh());
                    break;
                }
                i = i + 1;
                this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.app_f);
                this.InvokeEx(f => f.LB_Wait.Refresh());
                this.InvokeEx(f => f.pg_adding.Value = pg_adding.Value + 1);
                this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, pg_adding.Value, pg_adding.Maximum));
                this.InvokeEx(f => f.pg_adding.Refresh());
                this.InvokeEx(f => f.txt_adding_p.Text = (i * 100 / pg_adding.Maximum).ToString() + "%");
                this.InvokeEx(f => f.txt_adding_p.Refresh());
            }
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
            this.InvokeEx(f => f.listView1.EndUpdate());
            timer_adding.Stop();
            this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
            this.InvokeEx(f => f.txt_add_remain.Visible = false);
            this.InvokeEx(f => f.txt_add_remain.Refresh());
            this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.Removed + " " + (unfilter_lv1.Items.Count - listView1.Items.Count).ToString() + " " + FFBatch.Properties.Strings.files);
        }

        private void BG_Video_Bitrate_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            end_bg_filters();
        }

        private void BG_custom_MI_DoWork(object sender, DoWorkEventArgs e)
        {
            Disable_Controls();
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.btn_pause.Enabled = false);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.pg_adding.Visible = true);
            this.InvokeEx(f => f.pg_adding.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Visible = true);
            this.InvokeEx(f => f.txt_adding_p.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Refresh());
            this.InvokeEx(f => f.LB_Wait.Visible = true);
            this.InvokeEx(f => f.LB_Wait.Enabled = true);
            this.InvokeEx(f => f.lbl_items.Visible = false);
            this.InvokeEx(f => f.lbl_items.Refresh());
            this.InvokeEx(f => f.lbl_dur_list.Visible = false);
            this.InvokeEx(f => f.lbl_dur_list.Refresh());
            this.InvokeEx(f => f.lbl_size.Visible = false);
            this.InvokeEx(f => f.lbl_size.Refresh());
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Minimum = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.btn_cancel_add.Visible = true);
            this.InvokeEx(f => f.btn_cancel_add.Enabled = true);
            canceled_file_adding = false;

            int i = 0;
            int removed = 0;

            String item = String.Empty;
            this.InvokeEx(f => f.listView1.BeginUpdate());
            for (int n = 0; n < listView1.Items.Count; n++)
            {
                List<string> lines_ouput = new List<string>();

                Boolean to_remove = false;
                Boolean match = false;

                this.InvokeEx(f => item = listView1.Items[n].SubItems[1].Text + "\\" + listView1.Items[n].Text);
                if (canceled_file_adding == false)
                {
                    Process ff_str = new Process();
                    ff_str.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "mediainfo.exe");
                    ff_str.StartInfo.Arguments = '\u0022' + item + '\u0022';
                    ff_str.StartInfo.RedirectStandardOutput = true;
                    ff_str.StartInfo.StandardOutputEncoding = Encoding.UTF8;
                    ff_str.StartInfo.UseShellExecute = false;
                    ff_str.StartInfo.CreateNoWindow = true;
                    ff_str.EnableRaisingEvents = true;
                    ff_str.Start();
                    String stream = "";

                    while (!ff_str.StandardOutput.EndOfStream)
                    {
                        stream = ff_str.StandardOutput.ReadLine();
                        lines_ouput.Add(stream);
                    }
                    ff_str.WaitForExit();

                    foreach (String line in lines_ouput)
                    {
                        if (line.ToLower().Contains(form4.filter_value.ToLower()))
                        {
                            match = true;
                            break;
                        }
                    }

                    if (match == true && form4.filter_action == FFBatch.Properties.Strings.remove) to_remove = true;
                    if (match == true && form4.filter_action == FFBatch.Properties.Strings.keep) to_remove = false;
                    if (match == false && form4.filter_action == FFBatch.Properties.Strings.remove) to_remove = false;
                    if (match == false && form4.filter_action == FFBatch.Properties.Strings.keep) to_remove = true;

                    if (to_remove == true)
                    {
                        this.InvokeEx(f => f.listView1.Items[n].Remove());
                        filtered_lv1.Items[n].Remove();
                        n = n - 1;
                        removed = removed + 1;
                        this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count + removed);
                    }
                }
                else
                {
                    this.InvokeEx(f => f.listView1.Items.Clear());
                    this.InvokeEx(f => f.LB_Wait.Visible = false);
                    this.InvokeEx(f => f.btn_undo_filter.Enabled = true);
                    this.InvokeEx(f => f.btn_undo_filter.ImageKey = "undo_20.png");
                    this.InvokeEx(f => f.btn_undo_filter.PerformClick());
                    this.InvokeEx(f => f.btn_undo_filter.Enabled = false);
                    timer_adding.Stop();
                    this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
                    this.InvokeEx(f => f.txt_add_remain.Visible = false);
                    this.InvokeEx(f => f.txt_add_remain.Refresh());
                    break;
                }

                i = i + 1;
                this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.app_f);
                this.InvokeEx(f => f.LB_Wait.Refresh());
                this.InvokeEx(f => f.pg_adding.Value = pg_adding.Value + 1);
                this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, pg_adding.Value, pg_adding.Maximum));
                this.InvokeEx(f => f.pg_adding.Refresh());
                this.InvokeEx(f => f.txt_adding_p.Text = (i * 100 / pg_adding.Maximum).ToString() + "%");
                this.InvokeEx(f => f.txt_adding_p.Refresh());
            }
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
            this.InvokeEx(f => f.listView1.EndUpdate());
            timer_adding.Stop();
            this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
            this.InvokeEx(f => f.txt_add_remain.Visible = false);
            this.InvokeEx(f => f.txt_add_remain.Refresh());
            this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.Removed + " " + (unfilter_lv1.Items.Count - listView1.Items.Count).ToString() + " " + FFBatch.Properties.Strings.files);
        }

        private void BG_custom_MI_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            end_bg_filters();
        }

        private void toolStripMenuItem6_Click(object sender, EventArgs e)
        {
            form5.lv1_item = listView2.SelectedItems[0].Text;
            form5.ShowDialog();
        }

        private void BG_Metadata_DoWork(object sender, DoWorkEventArgs e)
        {
            Disable_Controls();
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.pg_adding.Visible = true);
            this.InvokeEx(f => f.pg_adding.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Visible = true);
            this.InvokeEx(f => f.txt_adding_p.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Refresh());
            this.InvokeEx(f => f.LB_Wait.Visible = true);
            this.InvokeEx(f => f.LB_Wait.Enabled = true);
            this.InvokeEx(f => f.lbl_items.Visible = false);
            this.InvokeEx(f => f.lbl_items.Refresh());
            this.InvokeEx(f => f.lbl_dur_list.Visible = false);
            this.InvokeEx(f => f.lbl_dur_list.Refresh());
            this.InvokeEx(f => f.lbl_size.Visible = false);
            this.InvokeEx(f => f.lbl_size.Refresh());
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Minimum = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.btn_cancel_add.Visible = true);
            this.InvokeEx(f => f.btn_cancel_add.Enabled = true);
            canceled_file_adding = false;

            int i = 0;
            int removed = 0;

            String select_meta = form4.stream_n;

            String item = String.Empty;
            this.InvokeEx(f => f.listView1.BeginUpdate());
            for (int n = 0; n < listView1.Items.Count; n++)
            {
                List<string> lines_ouput = new List<string>();

                Boolean to_remove = false;
                Boolean match = false;

                this.InvokeEx(f => item = listView1.Items[n].SubItems[1].Text + "\\" + listView1.Items[n].Text);
                if (canceled_file_adding == false)
                {
                    Process ff_str = new Process();
                    ff_str.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "mediainfo.exe");
                    String ffprobe_frames = " " + '\u0022' + "--Output=General;%" + select_meta + "%" + '\u0022';
                    ff_str.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + item + '\u0022';
                    ff_str.StartInfo.RedirectStandardOutput = true;
                    ff_str.StartInfo.StandardOutputEncoding = Encoding.UTF8;
                    ff_str.StartInfo.UseShellExecute = false;
                    ff_str.StartInfo.CreateNoWindow = true;
                    ff_str.EnableRaisingEvents = true;
                    ff_str.Start();
                    String stream = "";

                    while (!ff_str.StandardOutput.EndOfStream)
                    {
                        stream = ff_str.StandardOutput.ReadLine();
                        lines_ouput.Add(stream);
                    }
                    ff_str.WaitForExit();

                    foreach (String line in lines_ouput)
                    {
                        if (line.ToLower().Contains(form4.filter_value.ToLower()))
                        {
                            match = true;
                            break;
                        }
                    }

                    if (match == true && form4.filter_action == FFBatch.Properties.Strings.remove) to_remove = true;
                    if (match == true && form4.filter_action == FFBatch.Properties.Strings.keep) to_remove = false;
                    if (match == false && form4.filter_action == FFBatch.Properties.Strings.remove) to_remove = false;
                    if (match == false && form4.filter_action == FFBatch.Properties.Strings.keep) to_remove = true;

                    if (to_remove == true)
                    {
                        this.InvokeEx(f => f.listView1.Items[n].Remove());
                        filtered_lv1.Items[n].Remove();
                        n = n - 1;
                        removed = removed + 1;
                        this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count + removed);
                    }
                }
                else
                {
                    this.InvokeEx(f => f.listView1.Items.Clear());
                    this.InvokeEx(f => f.LB_Wait.Visible = false);
                    this.InvokeEx(f => f.btn_undo_filter.Enabled = true);
                    this.InvokeEx(f => f.btn_undo_filter.ImageKey = "undo_20.png");
                    this.InvokeEx(f => f.btn_undo_filter.PerformClick());
                    this.InvokeEx(f => f.btn_undo_filter.Enabled = false);
                    timer_adding.Stop();
                    this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
                    this.InvokeEx(f => f.txt_add_remain.Visible = false);
                    this.InvokeEx(f => f.txt_add_remain.Refresh());
                    break;
                }

                i = i + 1;
                this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.app_f);
                this.InvokeEx(f => f.LB_Wait.Refresh());
                this.InvokeEx(f => f.pg_adding.Value = pg_adding.Value + 1);
                this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, pg_adding.Value, pg_adding.Maximum));
                this.InvokeEx(f => f.pg_adding.Refresh());
                this.InvokeEx(f => f.txt_adding_p.Text = (i * 100 / pg_adding.Maximum).ToString() + "%");
                this.InvokeEx(f => f.txt_adding_p.Refresh());
            }
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
            this.InvokeEx(f => f.listView1.EndUpdate());
            timer_adding.Stop();
            this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
            this.InvokeEx(f => f.txt_add_remain.Visible = false);
            this.InvokeEx(f => f.txt_add_remain.Refresh());
            this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.Removed + " " + (unfilter_lv1.Items.Count - listView1.Items.Count).ToString() + " " + Properties.Strings.files);
        }

        private void BG_Metadata_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            end_bg_filters();
        }

        private void toolStripMenuItem7_Click(object sender, EventArgs e)
        {
            if (listView1.Items.Count == 1) listView1.Items[0].Selected = true;
            cti4.PerformClick();
        }

        private void toolStripMenuItem8_Click(object sender, EventArgs e)
        {
        }

        private void toolStripMenuItem5_Click(object sender, EventArgs e)
        {
            Process.Start("https://sourceforge.net/p/ffmpeg-batch/news/");
        }

        private void toolStripMenuItem9_Click(object sender, EventArgs e)
        {
            btn_multiple_presets.PerformClick();
        }

        private void ct1_streams_Click(object sender, EventArgs e)
        {
            main_menu_streams.PerformClick();
        }

        private void toolStripMenuItem8_Click_1(object sender, EventArgs e)
        {
        }

        private void BG_Try_twopass_DoWork(object sender, DoWorkEventArgs e)
        {
            tried_ok = false;
            if (chk_try.CheckState == CheckState.Checked)
            {
                tried_ok = true;
                return;
            }

            two_try_fail = false;
            this.InvokeEx(f => this.Cursor = Cursors.WaitCursor);
            ListBox LB1_o = new ListBox();
            Process consola_pre = new Process();
            String file_prueba = "";
            String sel_test = "";
            listView1.Invoke(new MethodInvoker(delegate
            {
                if (listView1.SelectedIndices.Count == 1) this.InvokeEx(f => sel_test = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text);
                else this.InvokeEx(f => sel_test = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text);
            }));

            file_prueba = sel_test;
            String destino_test = Path.GetTempPath() + "\\" + "FFBatch_test";
            Boolean bad_chars = false;
            Boolean unsupported = false;

            Task tt = Task.Run(() =>
            {
                String fichero = Path.GetFileName(file_prueba);

                if (!Directory.Exists(destino_test))
                {
                    try
                    {
                        Directory.CreateDirectory(destino_test);
                    }
                    catch (System.Exception excpt)
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                        return;
                    }
                }

                String ext_output = "nul";

                textbox_params = multi_1st_pass;
                String templog = Path.GetTempPath() + "\\" + "FF_pass2.log";
                consola_pre.StartInfo.FileName = "ffmpeg.exe";
                consola_pre.StartInfo.Arguments = hw_decode_glob + " -y -i " + "" + '\u0022' + file_prueba + '\u0022' + " -t 00:00:0.250 " + textbox_params + " -passlogfile " + '\u0022' + templog + '\u0022' + " " + ext_output;
                consola_pre.StartInfo.RedirectStandardOutput = true;
                consola_pre.StartInfo.RedirectStandardError = true;
                consola_pre.StartInfo.UseShellExecute = false;
                consola_pre.StartInfo.CreateNoWindow = true;
                consola_pre.EnableRaisingEvents = true;
                consola_pre.Start();

                while (!consola_pre.StandardError.EndOfStream)
                {
                    this.InvokeEx(f => LB1_o.Items.Add(consola_pre.StandardError.ReadLine()));
                    this.InvokeEx(f => LB1_o.TopIndex = LB1_o.Items.Count - 1);
                    this.InvokeEx(f => LB1_o.Refresh());
                }

                consola_pre.WaitForExit();
                consola_pre.StartInfo.Arguments = String.Empty;
            });

            if (!tt.Wait(2500) && consola_pre.StartInfo.Arguments != String.Empty)
            {
                consola_pre.Kill();
                tried_ok = true;
                two_try_fail = false;
                this.InvokeEx(f => this.Cursor = Cursors.Arrow);

                if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length > 0)
                {
                    foreach (String file in Directory.GetFiles(destino_test))
                    {
                        try
                        {
                            File.Delete(file);
                        }
                        catch
                        {
                        }
                    }
                }

                if (Directory.GetFiles(destino_test).Length == 0)
                {
                    System.IO.Directory.Delete(destino_test);
                }
                LB1_o.Items.Clear();
                tried_params.Add(txt_parameters.Text);
                return;
            }

            if (bad_chars == false)
            {
                if (consola_pre.ExitCode != 0)
                {
                    two_try_fail = true;
                    tried_ok = false;
                    if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length > 0)
                    {
                        foreach (String file in Directory.GetFiles(destino_test))
                        {
                            try
                            {
                                File.Delete(file);
                            }
                            catch
                            {
                            }
                        }
                    }

                    if (Directory.GetFiles(destino_test).Length == 0)
                    {
                        System.IO.Directory.Delete(destino_test);
                    }

                    this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                    foreach (String lin in LB1_o.Items)
                    {
                        if (lin.Contains("not load the requested plugin") || lin.Contains("Cannot load nvcuda.dll"))
                        {
                            unsupported = true;
                        }
                    }
                    if (unsupported == true) MessageBox.Show(FFBatch.Properties.Strings.fail_1stp + " " + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.unsup_enc + Environment.NewLine + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 4].ToString() + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 3].ToString() + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 2].ToString() + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 1].ToString() + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.try_pr, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    else MessageBox.Show(FFBatch.Properties.Strings.fail_1stp + " " + Environment.NewLine + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 4].ToString() + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 3].ToString() + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 2].ToString() + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 1].ToString() + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.try_pr, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);

                    this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                    tried_ok = false;
                    return;
                }
                else
                {
                    tried_params.Add(multi_two_pr1);
                }
            }
            //END try preset

            LB1_o.Items.Clear();
            consola_pre.Dispose();
        }

        private void BG_Try_twopass_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            if (two_try_fail == false) BG_Try_Two_Final.RunWorkerAsync();
        }

        private void BG_Try_Two_Final_DoWork(object sender, DoWorkEventArgs e)
        {
            tried_ok = false;
            if (chk_try.CheckState == CheckState.Checked)
            {
                tried_ok = true;
                return;
            }

            this.InvokeEx(f => this.Cursor = Cursors.WaitCursor);
            ListBox LB1_o = new ListBox();
            Process consola_pre = new Process();
            String file_prueba = "";
            String sel_test = "";
            listView1.Invoke(new MethodInvoker(delegate
            {
                if (listView1.SelectedIndices.Count == 1) this.InvokeEx(f => sel_test = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text);
                else this.InvokeEx(f => sel_test = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text);
            }));

            file_prueba = sel_test;
            String destino_test = Path.GetTempPath() + "\\" + "FFBatch_test";
            Boolean bad_chars = false;
            Boolean unsupported = false;

            Task tt = Task.Run(() =>
            {
                String fichero = Path.GetFileName(file_prueba);

                if (!Directory.Exists(destino_test))
                {
                    try
                    {
                        Directory.CreateDirectory(destino_test);
                    }
                    catch (System.Exception excpt)
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                        this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                        return;
                    }
                }

                String ext_output = multi_two_ext;
                if (txt_format.Text == String.Empty)
                {
                    ext_output = Path.GetExtension(file_prueba);
                }
                else
                {
                    ext_output = "." + multi_two_ext;
                }

                textbox_params = multi_two_pr1;
                String file_prueba2 = file_prueba;

                if (textbox_params.Contains("%fn"))
                {
                    textbox_params = textbox_params.Replace("%fn", Path.GetFileNameWithoutExtension(file_prueba));
                }
                if (textbox_params.Contains("%fp"))
                {
                    textbox_params = textbox_params.Replace("%fp", Path.GetDirectoryName(file_prueba));
                }
                if (textbox_params.Contains("%fd"))
                {
                    var path = Path.GetFullPath(file_prueba);
                    var dirName = Path.GetFileName(Path.GetDirectoryName(path));
                    textbox_params = textbox_params.Replace("%fd", dirName);
                }

                if (textbox_params.Contains("%1"))
                {
                    if (file_prueba2.Contains("[") || file_prueba2.Contains("]"))
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.conflict_char, FFBatch.Properties.Strings.conflict_char2, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                        Enable_Controls();
                        this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                        tried_ok = false;
                        bad_chars = true;
                        return;
                    }
                    file_prueba2 = file_prueba2.Replace("\\", "\\\\\\\\");
                    file_prueba2 = file_prueba2.Replace(":", ":" + "\\\\");
                    textbox_params = textbox_params.Replace("%1", file_prueba2);
                }
                String templog = Path.GetTempPath() + "\\" + "FF_pass2.log";
                consola_pre.StartInfo.FileName = "ffmpeg.exe";
                consola_pre.StartInfo.Arguments = hw_decode_glob + " -y -i " + "" + '\u0022' + file_prueba + '\u0022' + " -t 00:00:0.250 " + "-y " + textbox_params + " -passlogfile " + '\u0022' + templog + '\u0022' + " " + '\u0022' + destino_test + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + ext_output + '\u0022';
                consola_pre.StartInfo.RedirectStandardOutput = true;
                consola_pre.StartInfo.RedirectStandardError = true;
                consola_pre.StartInfo.UseShellExecute = false;
                consola_pre.StartInfo.CreateNoWindow = true;
                consola_pre.EnableRaisingEvents = true;
                consola_pre.Start();

                while (!consola_pre.StandardError.EndOfStream)
                {
                    this.InvokeEx(f => LB1_o.Items.Add(consola_pre.StandardError.ReadLine()));
                    this.InvokeEx(f => LB1_o.TopIndex = LB1_o.Items.Count - 1);
                    this.InvokeEx(f => LB1_o.Refresh());
                }

                consola_pre.WaitForExit();
                consola_pre.StartInfo.Arguments = String.Empty;
            });

            if (!tt.Wait(2500) && consola_pre.StartInfo.Arguments != String.Empty)
            {
                consola_pre.Kill();
                tried_ok = true;
                this.InvokeEx(f => this.Cursor = Cursors.Arrow);

                if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length > 0)
                {
                    foreach (String file in Directory.GetFiles(destino_test))
                    {
                        try
                        {
                            File.Delete(file);
                        }
                        catch
                        {
                        }
                    }
                }

                if (Directory.GetFiles(destino_test).Length == 0)
                {
                    System.IO.Directory.Delete(destino_test);
                }
                LB1_o.Items.Clear();
                tried_params.Add(txt_parameters.Text);
                return;
            }

            if (bad_chars == false)
            {
                if (consola_pre.ExitCode != 0)
                {
                    if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length > 0)
                    {
                        foreach (String file in Directory.GetFiles(destino_test))
                        {
                            try
                            {
                                File.Delete(file);
                            }
                            catch
                            {
                            }
                        }
                    }

                    if (Directory.GetFiles(destino_test).Length == 0)
                    {
                        System.IO.Directory.Delete(destino_test);
                    }

                    this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                    foreach (String lin in LB1_o.Items)
                    {
                        if (lin.Contains("not load the requested plugin") || lin.Contains("Cannot load nvcuda.dll"))
                        {
                            unsupported = true;
                        }
                    }
                    if (unsupported == true) MessageBox.Show(FFBatch.Properties.Strings.fail_2ndp + " " + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.unsup_enc + Environment.NewLine + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 4].ToString() + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 3].ToString() + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 2].ToString() + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 1].ToString() + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.try_pr, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    else MessageBox.Show(FFBatch.Properties.Strings.fail_2ndp + " " + Environment.NewLine + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 4].ToString() + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 3].ToString() + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 2].ToString() + Environment.NewLine + LB1_o.Items[LB1_o.Items.Count - 1].ToString() + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.try_pr, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);

                    this.InvokeEx(f => this.Cursor = Cursors.Arrow);
                    tried_ok = false;
                    return;
                }
                else
                {
                    System.Threading.Thread.Sleep(50);
                    if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length > 0)
                    {
                        foreach (String file in Directory.GetFiles(destino_test))
                        {
                            try
                            {
                                File.Delete(file);
                            }
                            catch
                            {
                            }
                        }
                    }

                    if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length == 0)
                    {
                        System.IO.Directory.Delete(destino_test);
                    }
                    tried_params.Add(txt_parameters.Text);
                    tried_ok = true;
                }
            }
            //END try preset
            this.InvokeEx(f => this.Cursor = Cursors.Arrow);

            if (Directory.Exists(destino_test))
            {
                if (Directory.GetFiles(destino_test).Length == 0)
                {
                    System.IO.Directory.Delete(destino_test);
                }
            }
            LB1_o.Items.Clear();
            consola_pre.Dispose();
        }

        private void BG_Try_Two_Final_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            String file_prueba = "";
            String sel_test = String.Empty;
            listView1.Invoke(new MethodInvoker(delegate
            {
                if (listView1.SelectedIndices.Count == 1) this.InvokeEx(f => sel_test = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text);
                else this.InvokeEx(f => sel_test = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text);
            }));
            file_prueba = sel_test;
            String destino = Path.Combine(Path.GetTempPath(), "FFBatch_test");
            String borrar = destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + txt_format.Text;

            if (File.Exists(borrar))
            {
                try
                {
                    File.Delete(borrar);
                }
                catch
                {
                }
            }

            if (Directory.Exists(destino) == true)
            {
                if (Directory.GetFiles(destino).Length == 0)
                {
                    System.IO.Directory.Delete(destino);
                }
            }

            if (tried_ok == true) two_pass_encoding();
        }

        private void menu_two_pass_wizard_Click(object sender, EventArgs e)
        {
            if (!File.Exists(Path.Combine(Application.StartupPath, "ffmpeg.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_ffmpeg, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            String ffm = Path.Combine(Application.StartupPath, "AeroWizard.dll");
            if (!File.Exists(ffm))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_aerowiz, FFBatch.Properties.Strings.required_file, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (listView1.Items.Count == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.list_empty, FFBatch.Properties.Strings.no_files, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            foreach (ListViewItem file2 in listView1.Items)
            {
                if (!File.Exists(file2.SubItems[1].Text + "\\" + file2.Text))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file_not_found + " " + file2.Text, FFBatch.Properties.Strings.file_not_f, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }

            String is_overw = txt_path_main.Text + "\\" + Path.GetFileNameWithoutExtension(listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text) + "." + txt_format.Text;

            if (is_overw == listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text && chk_suffix.Checked == false)
            {
                MessageBox.Show(FFBatch.Properties.Strings.overw_not_en + " " + '\u0022' + FFBatch.Properties.Strings.ren_out + '\u0022' + " " + FFBatch.Properties.Strings.checkb, FFBatch.Properties.Strings.overw_not_all, MessageBoxButtons.OK, MessageBoxIcon.Error);

                return;
            }
            DateTime time2;
            if (!DateTime.TryParse(ss_time_input.Text, out time2))
            {
                MessageBox.Show(FFBatch.Properties.Strings.pre_input1, FFBatch.Properties.Strings.pre_input2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (ss_time_input.Text != "0:00:00")
            {
                foreach (ListViewItem item in listView1.Items)
                {
                    if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                    {
                        if (TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds <= TimeSpan.Parse(ss_time_input.Text).TotalSeconds)
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.pre_input3 + " " + '\u0022' + Path.GetFileName(item.Text) + '\u0022', FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            return;
                        }
                    }
                }
            }

            DateTime time;
            if (!DateTime.TryParse(ss_time_input.Text, out time))
            {
                MessageBox.Show(FFBatch.Properties.Strings.pre_input1, FFBatch.Properties.Strings.pre_input2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            avoid_overw();

            if (avoid_overwriting == true && txt_path_main.Text.Contains(".\\") == false && txt_path_main.Text.Length < 4 && checkBox1.CheckState != CheckState.Checked)
            {
                avoid_overwriting = false;
                DialogResult a2 = MessageBox.Show(FFBatch.Properties.Strings.multiple_folders + " " + '\u0022' + FFBatch.Properties.Strings.recreate_path + '\u0022' + " " + Properties.Strings2.avoid_overw + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.continu, Properties.Strings.warning, MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2);
                if (a2 == DialogResult.No) return;
            }

            //Check path is writable
            String destino1 = String.Empty;
            Boolean rel_path = false;
            if (txt_path_main.Text.Contains(".\\"))
            {
                String destino0 = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text;
                destino1 = destino0.Substring(0, destino0.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
                rel_path = true;
            }
            else
            {
                if (checkBox1.CheckState == CheckState.Checked)
                {
                    String pre_dest = listView1.Items[0].SubItems[1].Text;
                    destino1 = Path.Combine(txt_path_main.Text, pre_dest.Substring(3, pre_dest.Length - 3));
                    rel_path = true;
                }
                else
                {
                    destino1 = txt_path_main.Text;
                }
            }

            try
            {
                if (rel_path == true)
                {
                    Directory.CreateDirectory(destino1);
                    System.Threading.Thread.Sleep(10);
                }
                else
                {
                    File.WriteAllText(destino1 + "\\" + "FFBatch_test.txt", "FFBatch_test");
                    System.Threading.Thread.Sleep(10);
                    File.Delete(destino1 + "\\" + "FFBatch_test.txt");
                }
            }
            catch (System.Exception excpt)
            {
                MessageBox.Show(FFBatch.Properties.Strings.write_error1 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }
            //End path is writable

            //Wizard
            AeroWizard3 wizard3 = new AeroWizard3();
            wizard3.StartPosition = FormStartPosition.CenterScreen;

            if (listView1.SelectedIndices.Count == 1)
            {
                wizard3.lv1_item = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
            }
            else
            {
                wizard3.lv1_item = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text;
            }
            wizard3.pr1_string_two_params = multi_two_pr1;
            wizard3.pr1_string_two_ext = multi_two_ext;
            if (saved_pres_two.Length > 0)
            {
                wizard3.saved_pres = saved_pres_two;
            }
            if (saved_ext_two.Length > 0)
            {
                wizard3.saved_ext = saved_ext_two;
            }

            wizard3.ShowDialog();
            saved_pres_two = wizard3.saved_pres;
            saved_ext_two = wizard3.saved_ext;

            if (wizard3.cancelled_w == true) return;

            multi_1st_pass = wizard3.pr1_first_params;
            multi_two_pr1 = wizard3.pr1_string_two_params;
            multi_two_ext = wizard3.pr1_string_two_ext;

            if (tried_ok == false)
            {
                try
                {
                    BG_Try_twopass.RunWorkerAsync();
                }
                catch
                {
                    tried_ok = true;
                }
                return;
            }
            tried_ok = false;

            //Remove test file/folder

            String file_prueba = "";
            String sel_test = String.Empty;
            if (listView1.SelectedIndices.Count == 1) sel_test = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
            else sel_test = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text;
            file_prueba = sel_test;
            String destino = Path.GetTempPath() + "\\" + "FFBatch_test";
            String borrar = destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + txt_format.Text;

            if (File.Exists(borrar))
            {
                try
                {
                    File.Delete(borrar);
                }
                catch
                {
                }
            }

            if (Directory.Exists(destino) == true)
            {
                if (Directory.GetFiles(destino).Length == 0)
                {
                    System.IO.Directory.Delete(destino);
                }
            }

            //END Remove test file/folder
            two_pass_encoding();
        }

        private void btn_try_pr_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            if (!File.Exists(Path.Combine(Application.StartupPath, "ffmpeg.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_ffmpeg, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (listView1.Items.Count == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.one_try, FFBatch.Properties.Strings.list_bl, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (listView1.SelectedIndices.Count == 0)
            {
                listView1.Items[0].Selected = true;
                listView1.Items[0].Focused = true;
                listView1.Focus();
            }

            if (cb_hwdecode.SelectedItem.ToString() != "none")
            {
                hw_decode_glob = "-hwaccel " + cb_hwdecode.SelectedItem.ToString();
            }
            BG_Try_button.RunWorkerAsync();
        }

        public void CopyCache()
        {
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.btn_skip_main.Enabled = false);
            this.InvokeEx(f => f.btn_pause.Enabled = false);

            this.InvokeEx(f => f.txt_adding_p.Visible = true);
            this.InvokeEx(f => f.pg_adding.Maximum = 100);
            this.InvokeEx(f => f.pg_adding.Minimum = 0);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Style = ProgressBarStyle.Continuous);
            this.InvokeEx(f => f.pg_adding.Visible = true);
            this.InvokeEx(f => f.pg_adding.Enabled = true);
            this.InvokeEx(f => f.pg_adding.Refresh());
            this.InvokeEx(f => f.LB_Wait.Visible = true);
            this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.caching_f);
            this.InvokeEx(f => f.LB_Wait.Refresh());
            this.InvokeEx(f => f.btn_cancel_add.Visible = true);
            this.InvokeEx(f => f.btn_cancel_add.Enabled = true);
            this.InvokeEx(f => f.btn_cancel_add.Refresh());
            this.InvokeEx(f => wc.Headers.Clear());
            this.InvokeEx(f => wc.Dispose());
            net_speed();
            Boolean already_cached = false;
            if (File.Exists(Path.Combine(Path.GetTempPath(), "FFBatch_test", Path.GetFileName(file_to_copy))))
            {
                FileInfo fi = new FileInfo(Path.Combine(Path.GetTempPath(), "FFBatch_test", Path.GetFileName(file_to_copy)));
                FileInfo fi2 = new FileInfo(file_to_copy);
                if (fi.Length == fi2.Length)
                {
                    already_cached = true;
                    cached = true;
                    this.InvokeEx(f => f.pg_adding.Visible = false);
                    this.InvokeEx(f => f.txt_add_remain.Visible = false);
                    this.InvokeEx(f => f.LB_Wait.Visible = false);
                    this.InvokeEx(f => f.btn_cancel_add.Visible = false);
                    this.InvokeEx(f => f.txt_adding_p.Visible = false);
                    this.InvokeEx(f => f.txt_add_remain.Visible = false);
                    this.InvokeEx(f => f.txt_add_remain.Enabled = false);
                    this.InvokeEx(f => f.btn_abort_all.Enabled = true);
                    this.InvokeEx(f => f.btn_skip_main.Enabled = true);
                    this.InvokeEx(f => f.btn_pause.Enabled = true);
                }
                else
                {
                    already_cached = false;
                }
            }
            if (already_cached == false)
            {
                Task t = Task.Run(() =>
                {
                    this.InvokeEx(f => wc.DownloadFileAsync(new System.Uri(file_to_copy), Path.Combine(Path.GetTempPath(), "FFBatch_test", Path.GetFileName(file_to_copy))));
                });
                t.Wait();
            }
        }

        public void Extract(object sender, AsyncCompletedEventArgs e)
        {
            cached = true;
            this.InvokeEx(f => f.pg_adding.Visible = false);
            this.InvokeEx(f => f.txt_add_remain.Visible = false);
            this.InvokeEx(f => f.LB_Wait.Visible = false);
            this.InvokeEx(f => f.btn_cancel_add.Visible = false);
            this.InvokeEx(f => f.txt_adding_p.Visible = false);
            this.InvokeEx(f => f.txt_add_remain.Visible = false);
            this.InvokeEx(f => f.txt_add_remain.Enabled = false);
            this.InvokeEx(f => f.btn_abort_all.Enabled = true);
            this.InvokeEx(f => f.btn_skip_main.Enabled = true);
            this.InvokeEx(f => f.btn_pause.Enabled = true);

            if (e.Cancelled == true)
            {
                try
                {
                    File.Delete(Path.Combine(Path.GetTempPath(), "FFBatch_test", Path.GetFileName(file_to_copy)).Replace("\\\\", "\\"));
                }
                catch { }
            }
        }

        private void ProgressChanged(object sender, DownloadProgressChangedEventArgs e)
        {
            this.InvokeEx(f => f.pg_adding.Value = e.ProgressPercentage);
            this.InvokeEx(f => f.pg_adding.Refresh());
            this.InvokeEx(f => f.txt_adding_p.Text = e.ProgressPercentage.ToString() + "%");
            this.InvokeEx(f => f.txt_adding_p.Refresh());
        }

        private void pictureBox1_DoubleClick(object sender, EventArgs e)
        {
            menu_about.PerformClick();
        }

        private void net_speed()
        {
            int i_net = 0;
            float current = 0;
            float accum = 0;
            String data = String.Empty;
            Boolean valid = false;

            Task t = Task.Run(() =>
            {
                this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);

                while (cached == false)
                {
                    Thread.Sleep(2000);
                    i_net = i_net + 1;
                    try
                    {
                        PerformanceCounter pc = new PerformanceCounter("Process", "IO Data Bytes/sec", "FFbatch");
                        current = pc.NextValue();
                    }
                    catch { }

                    accum = accum + current;
                    try
                    {
                        data = Math.Round(Convert.ToDecimal(accum / 2 / 1048576 / i_net), 2).ToString();
                        valid = true;
                    }
                    catch
                    {
                        valid = false;
                    }
                    if (valid == true && data != "0")
                    {
                        this.InvokeEx(f => f.txt_add_remain.Text = FFBatch.Properties.Strings.avg_transf + " " + data + " MB/s");
                    }
                    else
                    {
                        this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
                    }
                    this.InvokeEx(f => f.txt_add_remain.Refresh());
                }
            });
        }

        private void ct1_total_frames_Click(object sender, EventArgs e)
        {
            String file = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
            String ff_frames = String.Empty;
            String ff_rate = String.Empty;
            String ff_dur = String.Empty;
            Decimal tot_frames = 0;
            Decimal ff_rate_dec = 0;
            Decimal ff_dur_dec = 0;
            this.Cursor = Cursors.WaitCursor;
            Task t = Task.Run(() =>
            {
                Process get_frames = new Process();
                get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
                String ffprobe_frames = " " + '\u0022' + "--Inform=Video;%FrameCount%,%FrameRate%" + '\u0022';
                get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + file + '\u0022';
                get_frames.StartInfo.RedirectStandardOutput = true;
                get_frames.StartInfo.RedirectStandardError = true;
                get_frames.StartInfo.UseShellExecute = false;
                get_frames.StartInfo.CreateNoWindow = true;
                get_frames.EnableRaisingEvents = true;
                get_frames.Start();

                while (!get_frames.StandardOutput.EndOfStream)
                {
                    ff_frames = get_frames.StandardOutput.ReadLine();
                }
                get_frames.WaitForExit();

                try
                {
                    int ff_rate_1 = ff_frames.IndexOf(",");
                    ff_rate = ff_frames.Substring(ff_frames.IndexOf(",") + 1, ff_frames.Length - ff_rate_1 - 1);
                    ff_frames = ff_frames.Substring(0, ff_frames.IndexOf(","));
                }
                catch
                {
                    ff_frames = null;
                    ff_rate = null;
                }

                if (get_frames.ExitCode == 0)
                {
                    if (ff_frames != null)
                    {
                        try
                        {
                            tot_frames = decimal.Parse(ff_frames) / 1000;
                        }
                        catch
                        {
                            tot_frames = 0;
                            ff_rate_dec = 0;
                        }
                    }
                    else
                    {
                        tot_frames = 0;
                        ff_rate_dec = 0;
                    }
                    if (ff_rate != null)
                    {
                        try
                        {
                            ff_rate_dec = decimal.Parse(ff_rate);
                        }
                        catch
                        {
                            tot_frames = 0;
                            ff_rate_dec = 0;
                        }
                    }
                    else
                    {
                        tot_frames = 0;
                        ff_rate_dec = 0;
                    }
                }
                else
                {
                    tot_frames = 0;
                    ff_rate_dec = 0;
                    ff_dur_dec = 0;
                }

                Process get_frames2 = new Process();
                get_frames2.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
                ffprobe_frames = " " + '\u0022' + "--Inform=General;%Duration%" + '\u0022';
                get_frames2.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + file + '\u0022';
                get_frames2.StartInfo.RedirectStandardOutput = true;
                get_frames2.StartInfo.RedirectStandardError = true;
                get_frames2.StartInfo.UseShellExecute = false;
                get_frames2.StartInfo.CreateNoWindow = true;
                get_frames2.EnableRaisingEvents = true;
                get_frames2.Start();

                ff_dur = get_frames2.StandardOutput.ReadLine();

                get_frames2.WaitForExit();

                if (get_frames2.ExitCode == 0)
                {
                    if (ff_dur != null)
                    {
                        try
                        {
                            ff_dur_dec = decimal.Parse(ff_dur) / 1000;
                        }
                        catch
                        {
                            ff_dur_dec = 0;
                        }
                    }
                    else
                    {
                        ff_dur_dec = 0;
                    }
                }
            });

            if (!t.Wait(10000))
            {
                this.Cursor = Cursors.Arrow;
                return;
            }

            this.Cursor = Cursors.Arrow;
            Form frmInfo = new Form();
            frmInfo.Name = FFBatch.Properties.Strings.mstats;
            frmInfo.Text = FFBatch.Properties.Strings.mstats;
            frmInfo.Icon = this.Icon;
            frmInfo.Height = 228;
            frmInfo.Width = 336;
            frmInfo.FormBorderStyle = FormBorderStyle.Fixed3D;
            frmInfo.MaximizeBox = false;
            frmInfo.MinimizeBox = false;
            frmInfo.BackColor = this.BackColor;

            TextBox titulo2 = new TextBox();
            titulo2.Parent = frmInfo;
            titulo2.Top = 12;
            titulo2.Left = 9;
            titulo2.Width = 293;
            titulo2.BackColor = this.BackColor;
            titulo2.BorderStyle = BorderStyle.None;
            titulo2.TextAlign = HorizontalAlignment.Center;
            titulo2.ReadOnly = true;
            titulo2.TabIndex = 2;
            titulo2.Text = Path.GetFileName(listView1.SelectedItems[0].Text);

            Label line = new Label();
            line.Parent = frmInfo;
            line.Left = 0;
            line.Top = 41;
            line.Height = 2;
            line.BorderStyle = BorderStyle.Fixed3D;
            line.Width = 336;

            Label line2 = new Label();
            line2.Parent = frmInfo;
            line2.Left = 0;
            line2.Top = 136;
            line2.Height = 2;
            line2.BorderStyle = BorderStyle.Fixed3D;
            line2.Width = 336;

            Button boton_ok_st = new Button();
            boton_ok_st.Parent = frmInfo;
            boton_ok_st.Left = 85;
            boton_ok_st.Top = 148;
            boton_ok_st.Width = 145;
            boton_ok_st.Height = 27;
            boton_ok_st.Text = FFBatch.Properties.Strings.close;
            boton_ok_st.TabIndex = 0;
            boton_ok_st.Click += new EventHandler(boton_ok_st_Click);
            frmInfo.CancelButton = boton_ok_st;

            Label lbl_frm_rate = new Label();
            lbl_frm_rate.Parent = frmInfo;
            lbl_frm_rate.Left = 20;
            lbl_frm_rate.Top = 55;
            lbl_frm_rate.Width = 90;
            lbl_frm_rate.Text = FFBatch.Properties.Strings.fr_rate + ":";

            Label lbl_frm_rate2 = new Label();
            lbl_frm_rate2.Parent = frmInfo;
            lbl_frm_rate2.Left = 123;
            lbl_frm_rate2.Top = 55;
            lbl_frm_rate2.Width = 110;
            if (ff_rate_dec != 0) lbl_frm_rate2.Text = ff_rate + " fps.";
            else lbl_frm_rate2.Text = "-";

            Label lbl_seconds = new Label();
            lbl_seconds.Parent = frmInfo;
            lbl_seconds.Left = 20;
            lbl_seconds.Top = 81;
            lbl_seconds.Width = 90;
            lbl_seconds.Text = FFBatch.Properties.Strings.total_sec + ":";

            Label lbl_seconds2 = new Label();
            lbl_seconds2.Parent = frmInfo;
            lbl_seconds2.Left = 123;
            lbl_seconds2.Top = 81;
            lbl_seconds2.Width = 110;
            if (ff_dur_dec != 0) lbl_seconds2.Text = ff_dur_dec.ToString() + " " + FFBatch.Properties.Strings.seconds + ".";
            else lbl_seconds2.Text = "-";

            Label lbl_fr_count = new Label();
            lbl_fr_count.Parent = frmInfo;
            lbl_fr_count.Left = 20;
            lbl_fr_count.Top = 107;
            lbl_fr_count.Width = 95;
            lbl_fr_count.Text = "Total frames:";

            Label lbl_fr_count2 = new Label();
            lbl_fr_count2.Parent = frmInfo;
            lbl_fr_count2.Left = 123;
            lbl_fr_count2.Top = 107;
            lbl_fr_count2.Width = 110;
            if (tot_frames != 0) lbl_fr_count2.Text = tot_frames.ToString().TrimStart('0').Replace(System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator, String.Empty) + " frames.";
            else lbl_fr_count2.Text = "-";
            frmInfo.StartPosition = FormStartPosition.CenterParent;
            frmInfo.ShowDialog();
        }

        private void boton_ok_st_Click(object sender, EventArgs e)
        {
            ActiveForm.Close();
        }

        private void watch_other_instance_Created(object sender, FileSystemEventArgs e)
        {
            String other_file = Path.Combine(Path.GetTempPath(), "FFBatch_test") + "\\" + "Other_instance.fftmp";
            if (File.Exists(other_file) && working == false)
            {
                List<string> files2 = new List<string>();
                int num_drop = 0;
                this.BringToFront();
                foreach (String dropped in File.ReadLines(other_file))
                {
                    if (File.Exists(dropped))
                    {
                        files2.Add(dropped);
                        num_drop = files2.Count();
                    }
                    else
                    {
                        if (Directory.Exists(dropped))
                        {
                            if (add_subfs == false)
                            {
                                foreach (String file in Directory.GetFiles(dropped))
                                {
                                    if (!File.GetAttributes(file).HasFlag(FileAttributes.Hidden))
                                    {
                                        files2.Add(file);
                                        num_drop = num_drop + 1;
                                    }
                                }
                            }
                            else
                            {
                                try
                                {
                                    foreach (string f in Directory.GetFiles(dropped, "*.*", System.IO.SearchOption.AllDirectories))
                                    {
                                        if (!File.GetAttributes(f).HasFlag(FileAttributes.Hidden))
                                        {
                                            files2.Add(f);
                                            num_drop = num_drop + 1;
                                        }
                                    }
                                }
                                catch (System.Exception excpt)
                                {
                                    var a = MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message, FFBatch.Properties.Strings.error3, MessageBoxButtons.OK, MessageBoxIcon.Error);
                                    return;
                                }
                            }
                        }
                    }
                }

                if (num_drop >= 5000)
                {
                    var a = MessageBox.Show(FFBatch.Properties.Strings.adding + " " + num_drop + " " + FFBatch.Properties.Strings.files_time, FFBatch.Properties.Strings.many_files, MessageBoxButtons.OKCancel, MessageBoxIcon.Question);
                    if (a == DialogResult.Cancel)
                    {
                        return;
                    }
                }

                files_to_add = files2;
                canceled_file_adding = false;
                btn_cancel_add.Enabled = true;
                btn_cancel_add.Visible = true;
                btn_cancel_add.Refresh();
                BG_Files.RunWorkerAsync();

                try
                {
                    File.Delete(other_file);
                }
                catch { }
            }
        }

        private void notifyIcon1_BalloonTipClosed(object sender, EventArgs e)
        {
            notifyIcon1.Visible = false;
        }

        private void chk_delete_source_CheckedChanged(object sender, EventArgs e)
        {
            String f_delete = String.Empty;
            if (is_portable == false)
            {
                f_delete = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_delete.ini";
            }
            else
            {
                f_delete = port_path + "ff_delete_portable.ini";
            }

            if (chk_delete_source.Checked == false)
            {
                chk_delete_source.BackColor = this.BackColor;
                if (File.Exists(f_delete))
                {
                    try
                    {
                        File.Delete(f_delete);
                    }
                    catch
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
            }
            else
            {
                chk_delete_source.BackColor = Color.LightGoldenrodYellow;
                if (!File.Exists(f_delete))
                {
                    try
                    {
                        File.WriteAllText(f_delete, String.Empty);
                    }
                    catch
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
            }
            if (chk_delete_source.Checked == true && chk_overw.Checked == true)
            {
                MessageBox.Show(FFBatch.Properties.Strings.del_overw);
            }
        }

        private void wiz_silence_menu_Click(object sender, EventArgs e)
        {
            detect_silence();
        }

        private void lbl_updates_Click(object sender, EventArgs e)
        {
            if (lbl_updates.Text == FFBatch.Properties.Strings.up_err)
            {
                DialogResult a = MessageBox.Show(FFBatch.Properties.Strings.err_check + Environment.NewLine + Environment.NewLine + Properties.Strings2.check_web_up, FFBatch.Properties.Strings.error, MessageBoxButtons.YesNoCancel, MessageBoxIcon.Question);
                if (a == DialogResult.Yes) Process.Start(proj_web);
            }
            else btn_update.PerformClick();
        }

        private void btn_abort_all_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            if (tabControl1.SelectedIndex == 0) abort_view1();
            if (tabControl1.SelectedIndex == 1) abort_mux();
            if (tabControl1.SelectedIndex == 2) abort_sub_mux();
            if (tabControl1.SelectedIndex == 3) abort_m3u();
        }

        private void abort_mux()
        {
            Pg1.Focus();
            if (working == false) return;
            cancel_queue = true;

            if (process_glob.StartInfo.Arguments.Length >= 0)
            {
                StreamWriter write_q = process_glob.StandardInput;
                write_q.Write("q");
                working = false;
                return;
            }
            else
            {
                System.Threading.Thread.Sleep(50);
                Process[] localByName = Process.GetProcessesByName("ffmpeg");
                foreach (Process p in localByName)
                {
                    p.Kill();
                }
                System.Threading.Thread.Sleep(500);

                Process[] localByName2 = Process.GetProcessesByName("ffmpeg");
                foreach (Process p2 in localByName2)
                {
                    p2.Kill();
                }
                working = false;
            }
        }

        private void abort_sub_mux()
        {
            if (working == false) return;
            cancel_queue = true;
            working = false;
            if (process_glob.StartInfo.Arguments != String.Empty)
            {
                StreamWriter write_q = process_glob.StandardInput;
                write_q.Write("q");
                return;
            }
            else
            {
                System.Threading.Thread.Sleep(250);
                Process[] localByName = Process.GetProcessesByName("ffmpeg");
                foreach (Process p in localByName)
                {
                    p.Kill();
                }
                System.Threading.Thread.Sleep(500);

                Process[] localByName2 = Process.GetProcessesByName("ffmpeg");
                foreach (Process p2 in localByName2)
                {
                    p2.Kill();
                }
            }
        }

        public Boolean Send_CTRLC(Process p)
        {
            if (AttachConsole((uint)p.Id))
            {
                SetConsoleCtrlHandler(null, true);
                try
                {
                    if (!GenerateConsoleCtrlEvent(CTRL_C_EVENT, 0))
                        return false;
                    p.WaitForExit(10000);
                }
                finally
                {
                    FreeConsole();
                    SetConsoleCtrlHandler(null, false);
                }
                return true;
            }
            return false;
        }

        private void abort_m3u()
        {
            if (m3u_running == true)
            {
                working = false;
                m3u_running = false;
                cancelados_paralelos = true;
                aborted = true;

                foreach (DataGridViewRow row in dg1.Rows)
                {
                    if ((row.Cells[5].Value.ToString().Contains(FFBatch.Properties.Strings.success) == false) && row.Cells[5].Value.ToString() != FFBatch.Properties.Strings.ready && row.Cells[5].Value.ToString() != FFBatch.Properties.Strings.skipped)
                    {
                        row.Cells[5].Value = FFBatch.Properties.Strings.aborting;
                    }
                    if (row.Cells[5].Value.ToString().Contains(FFBatch.Properties.Strings.recording1) == true) row.Cells[5].Value = "Stopping";
                }
                Boolean proc_exist = false;
                if (m3u_single_running == false)
                {
                    Process[] localByName = Process.GetProcessesByName("yt-dlp");
                    foreach (Process p in localByName)
                    {
                        foreach (DataGridViewRow row in dg1.Rows)
                        {
                            //    try
                            //    {
                            //        if (p.Id == procs["proc_urls_" + row.Index.ToString()].Id)
                            //        {
                            //            proc_exist = true;
                            //        }
                            //    }
                            //    catch
                            //    {
                            //        proc_exist = false;
                            //        continue;
                            //    }

                            //                            if (p.Id == procs["proc_urls_" + row.Index.ToString()].Id)
                            //                          {
                            //Live YouTube abort
                            if (dg1.Rows[0].Cells[3].Value.ToString() == "Live")
                            {
                                timer2.Stop();
                                aborted_url = false;
                                stopped_recording = true;
                                Pg1.MarqueeAnimationSpeed = 15;
                                Pg1.Text = FFBatch.Properties.Strings.stopping2;
                                Pg1.Refresh();

                                Send_CTRLC(p);
                            }
                            else
                            {
                                try
                                {
                                    p.Kill();
                                }
                                catch { }
                            }
                            //  }
                        }
                    }
                    //FFmpeg m3u running
                    Process[] ffs = Process.GetProcessesByName("ffmpeg");
                    foreach (Process p in ffs)
                    {
                        foreach (DataGridViewRow row in dg1.Rows)
                        {
                            try
                            {
                                if (p.Id == procs["proc_urls_" + row.Index.ToString()].Id)
                                {
                                    proc_exist = true;
                                }
                            }
                            catch
                            {
                                proc_exist = false;
                                continue;
                            }

                            if (p.Id == procs["proc_urls_" + row.Index.ToString()].Id)
                            {
                                try
                                {
                                    p.Kill();
                                }
                                catch { }
                            }
                        }
                    }
                    timer2.Stop();
                }

                if (m3u_single_running == true)
                {
                    aborted_url = true;

                    //Live YouTube abort
                    if (dg1.Rows[0].Cells[3].Value.ToString() == "Live")
                    {
                        timer2.Stop();
                        aborted_url = false;
                        stopped_recording = true;
                        Pg1.MarqueeAnimationSpeed = 15;
                        Pg1.Text = FFBatch.Properties.Strings.stopping2;
                        Pg1.Refresh();

                        Send_CTRLC(process_glob);
                    }
                    else
                    {
                        StreamWriter write_q2 = process_glob.StandardInput;
                        write_q2.Write("q");
                        Process[] localByName = Process.GetProcessesByName("yt-dlp");
                        foreach (Process p in localByName)
                        {
                            if (p.Id == process_glob.Id)
                            {
                                try { p.Kill(); }
                                catch { }
                            }
                        }
                    }

                    aborted_url = true;
                    aborted = true;
                    cancel_queue = true;
                    cancelados_paralelos = false;
                }
                return;
            }

            cancel_queue = true;
            cancelados_paralelos = true;

            if (process_glob.StartInfo.Arguments != String.Empty)
            {
                //process_glob.Kill();
                Process[] localByName = Process.GetProcessesByName("yt-dlp");
                foreach (Process p in localByName)
                {
                    try { p.Kill(); }
                    catch { }
                }
            }
            else
            {
                System.Threading.Thread.Sleep(250);
                Process[] localByName = Process.GetProcessesByName("ffmpeg");
                foreach (Process p in localByName)
                {
                    p.Kill();
                }
                System.Threading.Thread.Sleep(500);

                Process[] localByName2 = Process.GetProcessesByName("ffmpeg");
                foreach (Process p2 in localByName2)
                {
                    p2.Kill();
                }
            }
        }

        private void btn_multimedia_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            if (listView1.Items.Count == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.list_empty, FFBatch.Properties.Strings.list_bl, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }
            else
            {
                if (listView1.SelectedItems.Count == 0)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.no_f_sel);
                    return;
                }
            }
            media_info();
        }

        private void button1_Click_1(object sender, EventArgs e)
        {
            Pg1.Focus();
            try
            {
                listView1.Font = new Font("Microsoft Sans Serif", listView1.Font.Size + 1);
                listView2.Font = new Font("Microsoft Sans Serif", listView2.Font.Size + 1);
                listView3.Font = new Font("Microsoft Sans Serif", listView3.Font.Size + 1);
                list_tracks.Font = new Font("Microsoft Sans Serif", list_tracks.Font.Size + 1);
                combo_presets.Font = new Font("Microsoft Sans Serif", combo_presets.Font.Size + 1);
                txt_path_main.Font = new Font("Microsoft Sans Serif", txt_path_main.Font.Size + 1);
                txt_pre_input.Font = new Font("Microsoft Sans Serif", txt_pre_input.Font.Size + 1);
                txt_parameters.Font = new Font("Microsoft Sans Serif", txt_parameters.Font.Size + 1);
                tabControl1.Font = new Font("Microsoft Sans Serif", tabControl1.Font.Size + 1);
                dg1.Font = new Font("Microsoft Sans Serif", dg1.Font.Size + 0.5f);
                FFBatch.Properties.Settings.Default.font_size = FFBatch.Properties.Settings.Default.font_size + 1;
                FFBatch.Properties.Settings.Default.Save();
            }
            catch { }
        }

        private void button5_Click_1(object sender, EventArgs e)
        {
            Pg1.Focus();
            try
            {
                listView1.Font = new Font("Microsoft Sans Serif", listView1.Font.Size - 1);
                listView2.Font = new Font("Microsoft Sans Serif", listView2.Font.Size - 1);
                listView3.Font = new Font("Microsoft Sans Serif", listView3.Font.Size - 1);
                list_tracks.Font = new Font("Microsoft Sans Serif", list_tracks.Font.Size - 1);
                combo_presets.Font = new Font("Microsoft Sans Serif", combo_presets.Font.Size - 1);
                txt_parameters.Font = new Font("Microsoft Sans Serif", txt_parameters.Font.Size - 1);
                txt_path_main.Font = new Font("Microsoft Sans Serif", txt_path_main.Font.Size - 1);
                txt_pre_input.Font = new Font("Microsoft Sans Serif", txt_pre_input.Font.Size - 1);
                tabControl1.Font = new Font("Microsoft Sans Serif", tabControl1.Font.Size - 1);
                dg1.Font = new Font("Microsoft Sans Serif", dg1.Font.Size - 0.5f);
                FFBatch.Properties.Settings.Default.font_size = FFBatch.Properties.Settings.Default.font_size - 1;
                FFBatch.Properties.Settings.Default.Save();
            }
            catch { }
        }

        private void set_font_size()
        {
            try
            {
                if (dg1.Font.Size == 0) return;
                listView1.Font = new Font("Microsoft Sans Serif", listView1.Font.Size + font_size);
                listView2.Font = new Font("Microsoft Sans Serif", listView2.Font.Size + font_size);
                listView3.Font = new Font("Microsoft Sans Serif", listView3.Font.Size + font_size);
                list_tracks.Font = new Font("Microsoft Sans Serif", list_tracks.Font.Size + font_size);
                txt_path_main.Font = new Font("Microsoft Sans Serif", txt_path_main.Font.Size + font_size);
                txt_pre_input.Font = new Font("Microsoft Sans Serif", txt_pre_input.Font.Size + font_size);
                combo_presets.Font = new Font("Microsoft Sans Serif", combo_presets.Font.Size + font_size);
                txt_parameters.Font = new Font("Microsoft Sans Serif", txt_parameters.Font.Size + font_size);
                tabControl1.Font = new Font("Microsoft Sans Serif", tabControl1.Font.Size + font_size);
                dg1.Font = new Font("Microsoft Sans Serif", dg1.Font.Size + (font_size / 2));
            }
            catch
            {
            }
        }

        private Boolean has_m3u_row()
        {
            foreach (DataGridViewRow row in dg1.Rows)
            {
                if (!row.Cells[1].Value.ToString().ToLower().Contains("youtu.be") && !row.Cells[1].Value.ToString().ToLower().Contains("youtube.com"))
                {
                    return true;
                }
            }
            return false;
        }

        private Boolean has_you_row()
        {
            foreach (DataGridViewRow row in dg1.Rows)
            {
                if (row.Cells[1].Value.ToString().ToLower().Contains("youtu.be") || row.Cells[1].Value.ToString().ToLower().Contains("youtube.com"))
                {
                    return true;
                }
            }
            return false;
        }

        private void ct_paste_youtube_Click(object sender, EventArgs e)
        {
            check_internet();

            if (internet_up == false) return;
            String copied = Clipboard.GetText();

            if (!copied.ToLower().Contains("youtu.be") && !copied.ToLower().Contains("youtube.com"))
            {
                MessageBox.Show(FFBatch.Properties.Strings.invalid_yt);
                return;
            }

            if (copied.ToLower().Substring(copied.Length - 7, 7) == "/videos" || copied.ToLower().Substring(copied.Length - 9, 9) == "/featured" || copied.ToLower().Contains("channel"))
            {
                MessageBox.Show(FFBatch.Properties.Strings.yt_channel, FFBatch.Properties.Strings.information, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (has_m3u_row() == true)
            {
                MessageBox.Show(FFBatch.Properties.Strings.mix_urls, FFBatch.Properties.Strings.information, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (copied.Contains("&list=")) copied = copied.Substring(0, copied.IndexOf("&list="));

            if (copied != String.Empty && copied.ToLower().Contains("http"))
            {
                foreach (DataGridViewRow r in dg1.Rows)
                {
                    if (r.Cells[1].Value.ToString() == copied)
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.url_alr);
                        return;
                    }
                }

                foreach (DataGridViewRow row in dg1.Rows)
                {
                    row.ReadOnly = true;
                }
                foreach (Control ct in groupBox_m3u.Controls)
                {
                    ct.Enabled = false;
                }

                if (copied.ToLower().Contains("playlist"))
                {
                    pl_url = copied;
                    dg1.Rows.Clear();
                    Validate_added_row_YT_PL();
                }
                else
                {
                    //this.Enabled = false;
                    btn_cancel_validate.Enabled = true;
                    dg1.Rows.Add(pic_noimg.Image, copied, "", "", "", "");
                    BG_Single_yt.RunWorkerAsync();
                }
            }
        }

        private void btn_add_yts_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            if (!File.Exists(System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.yt_not, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                release_datagrid();
                return;
            }
            check_internet();
            if (internet_up == false) return;
            adding_youtube = true;
            open_file_m3u.Filter = FFBatch.Properties.Strings.txt_f + " " + "  | *.txt; *.text| " + FFBatch.Properties.Strings.all_files + " (*.*) | *.*";
            open_file_m3u.ShowDialog();
        }

        private void clonedg()
        {
            var targetRows = new List<DataGridViewRow>();

            foreach (DataGridViewRow sourceRow in dg1.Rows)
            {
                if (!sourceRow.IsNewRow)
                {
                    var targetRow = (DataGridViewRow)sourceRow.Clone();

                    foreach (DataGridViewCell cell in sourceRow.Cells)
                    {
                        targetRow.Cells[cell.ColumnIndex].Value = cell.Value;
                    }
                    targetRows.Add(targetRow);
                }
            }
        }

        //private void cell_stretch()
        //{
        //    dg1.Invoke(new MethodInvoker(delegate
        //    {
        //    for (int i = 0; i < dg1.Columns.Count; i++)
        //        if (dg1.Columns[i] is DataGridViewImageColumn)
        //        {
        //            ((DataGridViewImageColumn)dg1.Columns[i]).ImageLayout = DataGridViewImageCellLayout.Stretch;
        //            break;
        //        }
        //    }));
        //}

        private void BG_Validate_URLs_YT_DoWork(object sender, DoWorkEventArgs e)
        {
            m3u_params_checked = chk_m3u_params.Checked;
            output_server_checked = chk_output_server.Checked;
            this.InvokeEx(f => this.Enabled = false);
            cell_zoom();

            dg1.ReadOnly = false;

            groupBox_m3u.Invoke(new MethodInvoker(delegate
            {
                foreach (Control ct in groupBox_m3u.Controls)
                {
                    ct.Enabled = true;
                }
            }));

            chk_m3u_params.Invoke(new MethodInvoker(delegate
            {
                if (chk_m3u_params.CheckState == CheckState.Checked)
                {
                    txt_m3u_params.Enabled = true;
                }
                else
                {
                    txt_m3u_params.Enabled = false;
                }
            }));

            chk_output_server.Invoke(new MethodInvoker(delegate
            {
                if (chk_output_server.CheckState == CheckState.Checked)
                {
                    txt_output_server.Enabled = true;
                }
                else
                {
                    txt_output_server.Enabled = false;
                }
            }));

            foreach (DataGridViewRow row in dg1.Rows)
            {
                dg1.Invoke(new MethodInvoker(delegate
                {
                    row.ReadOnly = false;

                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("/", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace(":", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("*", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("?", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("¿", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("\u0022", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("<", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace(">", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("|", "");
                    row.Cells[4].Value = row.Cells[4].Value.ToString().Replace("\\", "");
                }));
            }

            foreach (Control ct in groupBox_m3u.Controls)
            {
                this.InvokeEx(f => ct.Enabled = false);
            }

            this.InvokeEx(f => f.btn_cancel_validate.Enabled = true);

            procs.Clear();
            m_images.Clear();
            for (int ii = 0; ii < dg1.RowCount; ii++)
            {
                procs.Add("proc_urls_" + ii.ToString(), new Process());
                m_images.Add("pics_" + ii.ToString(), new PictureBox());
            }
            clean_imgs();

            ParallelOptions par_op = new ParallelOptions();
            System.Threading.CancellationTokenSource cts = new System.Threading.CancellationTokenSource();
            par_op.CancellationToken = cts.Token;
            par_op.MaxDegreeOfParallelism = (int)n_downs.Value;

            int prog = 0;
            this.InvokeEx(f => this.Enabled = false);
            one_ok = false;
            fatal_parallel = false;
            fatal_parallel_msg = "";
            cancelados_paralelos = false;

            Form9 form_prog2 = new Form9();
            form_prog2.abort_validate = false;

            this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, 1, dg1.RowCount + 1));

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;
                form_prog2.StartPosition = FormStartPosition.CenterScreen;
                form_prog2.progressBar1.Style = ProgressBarStyle.Continuous;
                form_prog2.progressBar1.Maximum = dg1.RowCount + 1;
                form_prog2.progressBar1.Value = 1;
                form_prog2.Refresh();
                form_prog2.label1.Text = FFBatch.Properties.Strings.val_yt;
                form_prog2.lab_count.Text = "1/" + dg1.RowCount;
                form_prog2.lab_count.Refresh();
                form_prog2.Refresh();
                form_prog2.ShowDialog();
                form_prog2.Refresh();
            }).Start();
            var workItems = Enumerable.Range(0, dg1.RowCount);
            int errors = 0;
            fatal_parallel = false;
            String path_pic = Path.Combine(Path.GetTempPath(), "FFBatch_test");

            ParallelLoopResult result = new ParallelLoopResult();
            try
            {
                result = Parallel.ForEach(workItems.AsParallel().AsOrdered(), par_op, (file_int) =>
                {
                    if (form_prog2.abort_validate == true)
                    {
                        cancelados_paralelos = true;
                        cts.Cancel();
                    }

                    if (cts.IsCancellationRequested == true) form_prog2.abort_validate = true;

                    if (dg1.Rows[file_int].Cells[1].Value == null) form_prog2.abort_validate = true;

                    if (stop_validating_url == true) form_prog2.abort_validate = true;

                    if (dg1.Rows[file_int].Cells[5].Value.ToString() == FFBatch.Properties.Strings.ready || dg1.Rows[file_int].Cells[5].Value.ToString() == FFBatch.Properties.Strings.processing || dg1.Rows[file_int].Cells[5].Value.ToString() == FFBatch.Properties.Strings.success)
                    {
                        prog = prog + 1;
                        try
                        {
                            form_prog2.Invoke(new MethodInvoker(delegate
                            {
                                if (form_prog2.progressBar1.Value < form_prog2.progressBar1.Maximum)
                                {
                                    form_prog2.progressBar1.Value = form_prog2.progressBar1.Value + 1;
                                    this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, form_prog2.progressBar1.Value, form_prog2.progressBar1.Maximum));
                                }
                                form_prog2.progressBar1.Refresh();
                                form_prog2.lab_count.Text = (prog).ToString() + "/" + dg1.Rows.Count;
                                form_prog2.lab_count.Refresh();
                            }));
                        }
                        catch { }
                        return;
                    }

                    this.InvokeEx(f => f.dg1.Rows[file_int].Cells[5].Value = FFBatch.Properties.Strings.var_url);
                    this.InvokeEx(f => f.dg1.Refresh());
                    if (dg1.Rows[file_int].Cells[1].Value.ToString().ToLower().Contains("playlist") == true)
                    {
                        dg1.Rows[file_int].Cells[2].Value = "00:00:00";
                        dg1.Rows[file_int].Cells[3].Value = "00:00:00";
                        dg1.Rows[file_int].Cells[4].Value = FFBatch.Properties.Strings.yt_pl;
                        dg1.Rows[file_int].Cells[5].Value = FFBatch.Properties.Strings.yt_pl;
                        form_prog2.abort_validate = true;
                    }
                    var tmp = procs["proc_urls_" + file_int.ToString()];
                    var imgs_th = m_images["pics_" + file_int.ToString()];

                    tmp.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe");
                    tmp.StartInfo.Arguments = "--get-duration --get-title --get-thumbnail " + '\u0022' + dg1.Rows[file_int].Cells[1].Value.ToString() + '\u0022';
                    tmp.StartInfo.RedirectStandardOutput = true;
                    tmp.StartInfo.UseShellExecute = false;
                    tmp.StartInfo.CreateNoWindow = true;
                    tmp.EnableRaisingEvents = true;

                    String filename = "";
                    String out_thumb = "";
                    String duracion = "";

                    PictureBox pic = new PictureBox();
                    if (cts.IsCancellationRequested == false)
                    {
                        tmp.Start();

                        while (!tmp.StandardOutput.EndOfStream)
                        {
                            if (form_prog2.abort_validate == true)
                            {
                                cts.Cancel();
                            }
                            else
                            {
                                filename = tmp.StandardOutput.ReadLine();
                                out_thumb = tmp.StandardOutput.ReadLine();
                                duracion = tmp.StandardOutput.ReadLine();
                            }
                        }
                        tmp.WaitForExit();
                    }
                    else
                    {
                        try
                        {
                            form_prog2.Invoke(new MethodInvoker(delegate
                            {
                                form_prog2.Close();
                            }));
                        }
                        catch { }
                        release_datagrid();
                        this.InvokeEx(f => this.Enabled = true);
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));

                        return;
                    }
                    prog = prog + 1;
                    thumbs_count++;

                    form_prog2.Invoke(new MethodInvoker(delegate
                    {
                        if (form_prog2.progressBar1.Value < form_prog2.progressBar1.Maximum)
                        {
                            form_prog2.progressBar1.Value = form_prog2.progressBar1.Value + 1;
                            this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, form_prog2.progressBar1.Value, form_prog2.progressBar1.Maximum));
                        }
                        form_prog2.progressBar1.Refresh();
                        form_prog2.lab_count.Text = (prog).ToString() + "/" + dg1.Rows.Count;
                        form_prog2.lab_count.Refresh();
                    }));

                    try
                    {
                        if (out_thumb.Contains("?")) out_thumb = out_thumb.Substring(0, out_thumb.IndexOf("?"));

                        if (out_thumb.ToLower().Substring(out_thumb.Length - 4, 4) == "webp")
                        {
                            WebClient client = new WebClient();
                            client.DownloadFile(out_thumb, path_pic + "\\" + "pic_ffb_" + thumbs_count.ToString() + ".webp");

                            Process pr = new Process();
                            pr.StartInfo.FileName = "ffmpeg.exe";
                            pr.StartInfo.UseShellExecute = false;
                            pr.StartInfo.CreateNoWindow = true; ;
                            pr.StartInfo.Arguments = "-i " + '\u0022' + path_pic + "\\" + "pic_ffb_" + thumbs_count.ToString() + ".webp" + '\u0022' + " -f image2 -y " + '\u0022' + path_pic + "\\" + "pic_ffb_" + thumbs_count.ToString() + ".jpg" + '\u0022' + " -hide_banner -nostats -loglevel 0";
                            pr.Start();
                            pr.WaitForExit();

                            Image img;

                            using (var bmpTemp = new Bitmap(Path.Combine(path_pic, "pic_ffb_" + thumbs_count.ToString() + ".jpg")))
                            {
                                img = new Bitmap(bmpTemp);
                                imgs_th.Image = img;
                            }
                        }
                        else
                        {
                            imgs_th.Load(out_thumb);
                        }
                    }
                    catch { imgs_th.Image = pic_noimg.Image; }

                    this.InvokeEx(f => f.dg1.Rows[file_int].Cells[0].Value = dg_thumbs[file_int]);

                    if (duracion == null || duracion == string.Empty)
                    {
                        dg1.Invoke(new MethodInvoker(delegate
                        {
                            //dg1.Rows[file_int].DefaultCellStyle.BackColor = Color.LightGoldenrodYellow;
                            dg1.Rows[file_int].Cells[2].Value = "";
                            dg1.Rows[file_int].Cells[3].Value = "";
                            //dg1.Rows[file_int].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor;
                            dg1.Rows[file_int].Cells[5].Value = FFBatch.Properties.Strings.error;
                            this.InvokeEx(f => f.dg1.Rows[file_int].Cells[5].Style.BackColor = Color.LightGoldenrodYellow);
                            errors = errors + 1;
                        }));
                    }

                    if (duracion != null && filename != "")
                    {
                        dg1.Invoke(new MethodInvoker(delegate
                        {
                            if (duracion == "0")
                            {
                                dg1.Rows[file_int].Cells[2].Value = duracion;
                                dg1.Rows[file_int].Cells[3].Value = "Live";
                            }
                            else
                            {
                                if (duracion.Length < 6) duracion = "00:" + duracion;
                                dg1.Rows[file_int].Cells[2].Value = duracion;
                                dg1.Rows[file_int].Cells[3].Value = duracion;
                            }
                            dg1.Rows[file_int].Cells[4].Value = filename;
                            //dg1.Rows[file_int].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor;
                            one_ok = true;
                            dg1.Rows[file_int].Cells[5].Value = FFBatch.Properties.Strings.ready;
                            this.InvokeEx(f => f.dg1.Rows[file_int].Cells[5].Style.BackColor = Color.LightGreen);
                        }));
                    }
                    try
                    {
                        form_prog2.Invoke(new MethodInvoker(delegate
                        {
                            if (errors > 0 && form_prog2.abort_validate == false)
                            {
                                form_prog2.lab_err.Text = FFBatch.Properties.Strings.errors + " " + errors.ToString();
                                form_prog2.lab_err.Refresh();
                                form_prog2.pictureBox1.Visible = true;
                                form_prog2.pictureBox1.Refresh();
                            }
                        }));
                    }
                    catch { }

                    tmp.StartInfo.Arguments = String.Empty;
                }); //Parallel
            } //Try Parallel
            catch (Exception exc)
            {
                fatal_parallel_msg = exc.Message;
                fatal_parallel = true;

                try
                {
                    form_prog2.Invoke(new MethodInvoker(delegate
                    { form_prog2.Close(); }));
                }
                catch { form_prog2.abort_validate = true; }
            }
            if (result.IsCompleted == true) fatal_parallel = false;
            else
            {
                if (cts.IsCancellationRequested == false) fatal_parallel = true;
                else fatal_parallel = false;
            }

            //End Parallel
            try
            {
                form_prog2.Invoke(new MethodInvoker(delegate
                { form_prog2.Close(); }));
            }
            catch { form_prog2.abort_validate = true; }
        }

        private void BG_Validate_URLs_YT_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            if (m3u_params_checked == false) txt_m3u_params.Enabled = false;
            if (output_server_checked == false) txt_output_server.Enabled = false;

            if (fatal_parallel == true) MessageBox.Show(FFBatch.Properties.Strings.err_proc_q + Environment.NewLine + Environment.NewLine + fatal_parallel_msg, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);

            if (one_ok == true)
            {
                this.InvokeEx(f => f.chk_m3u_params.Left = 12);
                this.InvokeEx(f => f.chk_output_server.Enabled = false);
                this.InvokeEx(f => f.chk_m3u_params.Text = FFBatch.Properties.Strings.yt_params);
            }

            //Paint image
            foreach (DataGridViewRow row in dg1.Rows)
            {
                row.Cells[0].Value = dg_thumbs[row.Index];
                if (row.Cells[3].Value == null) continue;
                if (row.Cells[3].Value.ToString() == "00:60")
                {
                    row.Cells[3].Value = "01:00";
                    row.Cells[2].Value = "01:00";
                }
                if (row.Cells[3].Value.ToString() == "60:00")
                {
                    row.Cells[3].Value = "01:00:00";
                    row.Cells[2].Value = "01:00:00";
                }
                if (row.Cells[3].Value.ToString() != "" && row.Cells[3].Value.ToString() != "-" && row.Cells[3].Value.ToString() != FFBatch.Properties.Strings.n_a && row.Cells[3].Value.ToString() != "\u221E" && row.Cells[3].Value.ToString() != "Live" && row.Cells[3].Value.ToString() != FFBatch.Properties.Strings.error)
                {
                    Total_dur_urls = Total_dur_urls + TimeSpan.Parse(row.Cells[3].Value.ToString()).TotalSeconds;
                }
            }

            this.TopMost = true;
            this.TopMost = false;
            TimeSpan t = TimeSpan.FromSeconds(Total_dur_urls);
            String dur = string.Format("{0:D2}h:{1:D2}m:{2:D2}s.{3:D3}ms",
                 (int)t.TotalHours,
                 t.Minutes,
                 t.Seconds,
                 t.Milliseconds);

            this.InvokeEx(f => f.lbl_urls_time.Visible = true);
            this.InvokeEx(f => f.lbl_urls_time.Text = dur.Substring(0, 11));
            if (dur.Substring(0, 11) == "00h:00m:00s")
            { this.InvokeEx(f => f.lbl_urls_time.Text = ""); }
            //cell_stretch();
            urls_duration();
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
        }

        private void BG_Validate_PLSS_DoWork(object sender, DoWorkEventArgs e)
        {
        }

        private void BG_Validate_PLSS_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            this.TopMost = true;
            this.TopMost = false;

            if (dg1.Rows[0].Cells[1].Value.ToString().ToLower().Contains("playlist"))
            {
                BG_Validate_added_row_YT_PL_S.RunWorkerAsync();
            }
        }

        private void urls_duration()
        {
            //foreach (DataGridViewRow row in dg1.Rows)
            //{
            //    if (row.Cells[3].Value == null) continue;
            //    if (row.Cells[3].Value.ToString() != "" && row.Cells[3].Value.ToString() != "-" && row.Cells[3].Value.ToString() != FFBatch.Properties.Strings.n_a && row.Cells[3].Value.ToString() != "\u221E")
            //    {
            //        Total_dur_urls = Total_dur_urls + TimeSpan.Parse(row.Cells[3].Value.ToString()).TotalSeconds;
            //    }
            //}
            TimeSpan t = TimeSpan.FromSeconds(Total_dur_urls);
            String dur = string.Format("{0:D2}h:{1:D2}m:{2:D2}s.{3:D3}ms",
                     (int)t.TotalHours,
                     t.Minutes,
                     t.Seconds,
                     t.Milliseconds);

            this.InvokeEx(f => f.lbl_urls_time.Visible = true);
            this.InvokeEx(f => f.lbl_urls_time.Text = dur.Substring(0, 11));
            if (dur.Substring(0, 11) == "00h:00m:00s")
            { this.InvokeEx(f => f.lbl_urls_time.Text = ""); }
        }

        private void dg1_RowsRemoved(object sender, DataGridViewRowsRemovedEventArgs e)
        {
            if (dg1.RowCount > 0) lbl_n_urls.Text = dg1.RowCount.ToString() + " url(s)";
            else lbl_n_urls.Text = "";
            Total_dur_urls = 0;
            foreach (DataGridViewRow row in dg1.Rows)
            {
                if (row.Cells[3].Value == null) continue;
                if (row.Cells[3].Value.ToString() != "" && row.Cells[3].Value.ToString() != "-" && row.Cells[3].Value.ToString() != FFBatch.Properties.Strings.n_a && row.Cells[3].Value.ToString() != "\u221E")
                {
                    Total_dur_urls = Total_dur_urls + TimeSpan.Parse(row.Cells[3].Value.ToString()).TotalSeconds;
                }
            }
            urls_duration();
            if (dg1.RowCount > 0) txt_paste_links.Visible = false;
            else txt_paste_links.Visible = true;
            //dg_thumbs[e.RowIndex] = pic_noimg.Image;
        }

        private Boolean max_urls()
        {
            if (dg1.RowCount > 2000)
            {
                MessageBox.Show(FFBatch.Properties.Strings.max_links, FFBatch.Properties.Strings.max_list, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                dg1.Rows.Clear();
                clean_imgs();
                return true;
            }
            else return false;
        }

        private void dg1_RowsAdded(object sender, DataGridViewRowsAddedEventArgs e)
        {
            dg1.Rows[e.RowIndex].Height = 45;
            if (dg1.RowCount > 0) txt_paste_links.Visible = false;
            else txt_paste_links.Visible = true;
            lbl_n_urls.Text = dg1.RowCount.ToString() + " url(s)";
        }

        private void btn_save_path_url_Click(object sender, EventArgs e)
        {
            String path_s = "";
            if (is_portable == false)
            {
                path_s = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_path_url.ini";
            }
            else
            {
                path_s = port_path + "ff_path_url_portable.ini";
            }

            String path_to_save = String.Empty;
            path_to_save = txt_path_m3u.Text;
            File.WriteAllText(path_s, path_to_save);
            btn_save_path_url.Enabled = false;
        }

        private void btn_save_downs_Click(object sender, EventArgs e)
        {
            //Save selected theads

            String path = String.Empty;
            if (is_portable == false)
            {
                path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_downs.ini";
            }
            else
            {
                path = port_path + "ff_downs_portable.ini";
            }

            String txt_threads = txt_threads = n_downs.Value.ToString();
            File.WriteAllText(path, txt_threads);
            btn_save_downs.Enabled = false;
            //End save selected threads
        }

        private void n_downs_ValueChanged(object sender, EventArgs e)
        {
            //Save selected theads

            String path = String.Empty;
            if (is_portable == false)
            {
                path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_downs.ini";
            }
            else
            {
                path = port_path + "ff_downs_portable.ini";
            }

            if (File.Exists(path))
            {
                String saved_th2 = File.ReadAllText(path);
                if (n_downs.Value.ToString() != saved_th2) btn_save_downs.Enabled = true;
                else btn_save_downs.Enabled = false;
            }
            else btn_save_downs.Enabled = true;
        }

        private void pic_yout_DoubleClick(object sender, EventArgs e)
        {
            Form10 frm = new Form10();
            frm.pic_y.Image = dg_thumbs[dg1.SelectedCells[0].RowIndex];
            frm.ShowDialog();
        }

        private void chk_cache_yt_CheckedChanged(object sender, EventArgs e)
        {
            if (chk_cache_yt.Checked == true) Clear_cache = "--rm-cache-dir";
            else Clear_cache = "";
        }

        private void chk_down_limit_CheckedChanged(object sender, EventArgs e)
        {
            if (chk_down_limit.Checked == true) n_down_speed.Enabled = true;
            else n_down_speed.Enabled = false;
        }

        private void chk_save_subtitles_CheckedChanged(object sender, EventArgs e)
        {
            if (chk_save_subtitles.Checked == true) chk_convert_srt.Enabled = true;
            else chk_convert_srt.Enabled = false;
        }

        private void dg1_CellMouseDown(object sender, DataGridViewCellMouseEventArgs e)
        {
            try
            {
                if (e.Button == MouseButtons.Right || dg1.RowCount > 0)
                {
                    // Add this
                    dg1.CurrentCell = dg1.Rows[e.RowIndex].Cells[e.ColumnIndex];
                    // Can leave these here - doesn't hurt
                    dg1.Rows[e.RowIndex].Selected = true;
                    dg1.Focus();
                }
            }
            catch { }
        }

        private void ct_remove_url_Click(object sender, EventArgs e)
        {
            foreach (DataGridViewCell cell in dg1.SelectedCells)
            {
                try
                {
                    foreach (DataGridViewCell cell2 in dg1.Rows[cell.RowIndex].Cells)
                    {
                        cell2.Selected = false;
                    }

                    dg1.Rows.RemoveAt(cell.RowIndex);
                }
                catch
                {
                }
            }
        }

        private void timer_update_Tick(object sender, EventArgs e)
        {
            if (pg_update_yl.Value >= pg_update_yl.Maximum) pg_update_yl.Value = pg_update_yl.Maximum;
            else pg_update_yl.Value = pg_update_yl.Value + 1;
            pg_update_yl.Refresh();
        }

        private void btn_logs_url_Click(object sender, EventArgs e)
        {
            btn_display_log.PerformClick();
        }

        private void BG_pre_validate_url_txt_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            post_file_url();
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
            urls_duration();
            lbl_n_urls.Text = dg1.RowCount.ToString() + " url(s)";
        }

        private void ct1_paste_youtube_Click(object sender, EventArgs e)
        {
            tabControl1.SelectedTab = tabControl1.TabPages[3];
            this.Refresh();
            ct_paste_youtube.PerformClick();
        }

        private void ct1_paste_m3u_Click(object sender, EventArgs e)
        {
            tabControl1.SelectedTab = tabControl1.TabPages[3];
            this.Refresh();
            ct_paste_m3u.PerformClick();
        }

        private void BG_Multi_M_DoWork(object sender, DoWorkEventArgs e)
        {
            warn_enc = 0;

            String hw_decode = String.Empty;

            cb_hwdecode.Invoke(new MethodInvoker(delegate
            {
                if (cb_hwdecode.SelectedItem.ToString() != "none")
                {
                    hw_decode = "-hwaccel " + cb_hwdecode.SelectedItem.ToString();
                }
            }));

            procs.Clear();
            multi_logs.Clear();
            multi_params.Clear();
            multi_speeds.Clear();
            multi_fps.Clear();

            lbl_speed.Invoke(new MethodInvoker(delegate
            {
                lbl_speed.Text = "";
            }));

            List<string> destis = new List<string>();
            List<string> list_lines = new List<string>();
            list_successful_m.Clear();
            list_failed_m.Clear();

            for (int ii = 0; ii < listView1.Items.Count; ii++)
            {
                procs.Add("proc_urls_" + ii.ToString(), new Process());
                destis.Add("destis_" + ii.ToString());
                multi_logs.Add("log_n_" + ii.ToString(), "");
                multi_params.Add("path_n_" + ii.ToString(), "");
            }

            listView1.Invoke(new MethodInvoker(delegate
            {
                foreach (ListViewItem item in listView1.Items)
                {
                    multi_speeds.Add("0");
                    multi_fps.Add("0");
                }
            }));
            this.InvokeEx(f => f.Pg1.Text = "0%");

            Disable_Controls();
            this.InvokeEx(f => f.btn_add_files.Enabled = true);

            ParallelOptions par_op = new ParallelOptions();
            CancellationTokenSource cts = new System.Threading.CancellationTokenSource();
            par_op.CancellationToken = cts.Token;
            par_op.MaxDegreeOfParallelism = Convert.ToInt16(n_threads.Value);

            opened_m = false;
            aborted = false;
            Decimal tot_frames2 = 0;
            warn_space = true;

            IEnumerable<int> items_lv = Enumerable.Range(0, listView1.Items.Count);

            ParallelLoopResult result = new ParallelLoopResult();

            try
            {
                result = Parallel.ForEach(items_lv.AsParallel().AsOrdered(), par_op, (file_int) =>
                {
                    Task
                        .Factory
                        .StartNew(() =>
                        {
                            if (cancelados_paralelos == true || aborted == true)
                            {
                                cts.Cancel();
                                timer1.Stop();
                                timer_tasks.Stop();
                                working = false;
                                multi_running = false;
                                return;
                            }

                            Boolean skipped = false;
                            String item_capture_time = String.Empty;
                            String fullPath = "";
                            Double total_prog = 0;
                            Double row_duration = 0;
                            Boolean valid_prog2 = false;
                            TimeSpan time2;
                            int space_timer = 0;

                            listView1.Invoke(new MethodInvoker(delegate
                            {
                                if (listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text == FFBatch.Properties.Strings.skipped) skipped = true;
                                if (TimeSpan.TryParse(listView1.Items[Convert.ToInt32(file_int)].SubItems[3].Text, out time2))
                                {
                                    row_duration = TimeSpan.Parse(listView1.Items[Convert.ToInt32(file_int)].SubItems[3].Text).TotalSeconds - TimeSpan.Parse(ss_time_input.Text).TotalSeconds;
                                    valid_prog2 = true;
                                }
                                else
                                {
                                    row_duration = 0;
                                    valid_prog2 = false;
                                }

                                fullPath = listView1.Items[Convert.ToInt32(file_int)].SubItems[1].Text + "\\" + listView1.Items[Convert.ToInt32(file_int)].Text;
                            }));

                            if (skipped == true)
                            {
                                this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.skipped);
                                return;
                            }

                            String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");

                            // Average frames
                            int fframes = 0;
                            Decimal dec = 0;
                            try
                            {
                                String ff_frames = String.Empty;

                                Process get_frames = new Process();
                                get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "mediainfo.exe");
                                String ffprobe_frames = "--Output=" + '\u0022' + "Video;%FrameCount%" + '\u0022';
                                get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + fullPath + '\u0022';
                                get_frames.StartInfo.RedirectStandardOutput = true;
                                get_frames.StartInfo.RedirectStandardError = true;
                                get_frames.StartInfo.UseShellExecute = false;
                                get_frames.StartInfo.CreateNoWindow = true;
                                get_frames.EnableRaisingEvents = true;
                                get_frames.Start();

                                ff_frames = get_frames.StandardOutput.ReadLine();
                                get_frames.WaitForExit(3000);

                                if (get_frames.ExitCode == 0)
                                {
                                    if (ff_frames != null)
                                    {
                                        dec = decimal.Parse(ff_frames);
                                        if (dec.ToString().Substring(dec.ToString().Length - 1, 1) == "0") dec = dec / 10;
                                    }
                                    else
                                    {
                                        dec = 0;
                                    }

                                    get_frames.Dispose();
                                    tot_frames2 = tot_frames2 + dec;
                                }
                            }
                            catch
                            {
                                dec = 0;
                            }

                            // End average frames

                            //Begin Shifting
                            String shifting = "";
                            if (chk_shift.Checked == true)
                            {
                                shifting = " -itsoffset " + Num_Shift.Value.ToString().Replace(",", ".") + " -i " + '\u0022' + fullPath + '\u0022' + " -map 1:v -map 0:a ";
                            }

                            //End Shifting

                            //Change Volume
                            String change_vol = "";
                            if (chk_vol.Checked == true)
                            {
                                change_vol = "-filter:a " + '\u0022' + "volume=" + vol_ch.Value.ToString() + "dB " + '\u0022' + " ";
                            }
                            //End change volume

                            if (txt_path_main.Text.Contains(".\\"))
                            {
                                if (txt_path_main.Text != ".\\")
                                {
                                    destis[file_int] = fullPath.Substring(0, fullPath.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
                                }
                                else
                                {
                                    destis[file_int] = Path.GetDirectoryName(fullPath);
                                }
                            }
                            else
                            {
                                if (checkBox1.CheckState == CheckState.Checked)
                                {
                                    String pre_dest = Path.GetDirectoryName(fullPath);
                                    destis[file_int] = Path.Combine(txt_path_main.Text, pre_dest.Substring(3, pre_dest.Length - 3));
                                }
                                else
                                {
                                    destis[file_int] = txt_path_main.Text;
                                }
                            }
                            if (!Directory.Exists(destis[file_int]))
                            {
                                Directory.CreateDirectory(destis[file_int]);
                            }
                            multi_dest = destis[file_int];

                            String pre_input_var = "";
                            if (txt_pre_input.Text != "")
                            {
                                pre_input_var = txt_pre_input.Text;
                            }

                            String pre_ss = "";
                            if (TimeSpan.Parse(ss_time_input.Text).TotalSeconds != 0)
                            {
                                pre_ss = " -ss " + ss_time_input.Text;
                            }

                            add_suffix = "";
                            if (chk_suffix.Checked == true && txt_suffix.Text != String.Empty)
                            {
                                add_suffix = txt_suffix.Text;
                                n_th_suffix = add_suffix;
                            }

                            String ext_output1 = txt_format.Text;
                            if (txt_format.Text.Length == 0)
                            {
                                ext_output1 = Path.GetExtension(fullPath);
                            }
                            else
                            {
                                ext_output1 = "." + txt_format.Text;
                            }
                            n_th_source_ext = ext_output1;

                            // textbox_params = txt_parameters.Text;

                            var tmp = procs["proc_urls_" + file_int.ToString()];
                            var n_logs = multi_logs["log_n_" + file_int.ToString()];
                            var tmp_params = multi_params["path_n_" + file_int.ToString()];
                            tmp_params = txt_parameters.Text;

                            if (txt_format.Text == "nul") ext_output1 = "nul";

                            String file2 = fullPath;
                            while (tmp_params.Contains("%fn"))
                            {
                                if (tmp_params.Contains("%fn"))
                                {
                                    tmp_params = tmp_params.Replace("%fn", Path.GetFileNameWithoutExtension(file2));
                                }
                            }
                            while (tmp_params.Contains("%fp"))
                            {
                                if (tmp_params.Contains("%fp"))
                                {
                                    tmp_params = tmp_params.Replace("%fp", Path.GetDirectoryName(file2));
                                }
                            }

                            while (tmp_params.Contains("%fd"))
                            {
                                if (tmp_params.Contains("%fd"))
                                {
                                    var path = Path.GetFullPath(file2);
                                    var dirName = Path.GetFileName(Path.GetDirectoryName(path));
                                    tmp_params = tmp_params.Replace("%fd", dirName);
                                }
                            }

                            while (tmp_params.Contains("%1"))
                            {
                                if (tmp_params.Contains("%1"))
                                {
                                    file2 = file2.Replace("\\", "\\\\\\\\");
                                    file2 = file2.Replace(":", ":" + "\\\\");
                                    tmp_params = tmp_params.Replace("%1", '\u0022' + file2 + '\u0022');
                                }
                            }

                            while (tmp_params.Contains("%2"))
                            {
                                if (tmp_params.Contains("%2"))
                                {
                                    file2 = file2.Replace("\\", "\\\\\\\\");
                                    file2 = file2.Replace(":", ":" + "\\\\");
                                    tmp_params = tmp_params.Replace("%2", '\u0022' + Path.Combine(System.IO.Path.GetDirectoryName(file2), Path.GetFileNameWithoutExtension(file2)) + '\u0022');
                                }
                            }

                            tmp.StartInfo.Arguments = hw_decode + " " + pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + fullPath + '\u0022' + " " + shifting + " " + " -y " + tmp_params + " " + change_vol + '\u0022' + destis[file_int] + "\\" + System.IO.Path.GetFileNameWithoutExtension(fullPath) + add_suffix + ext_output1 + '\u0022' + " -hide_banner";
                            if (ext_output1 == "nul") tmp.StartInfo.Arguments = hw_decode + " " + pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + fullPath + '\u0022' + " " + shifting + " " + tmp_params + " " + change_vol + " " + " -hide_banner";

                            String second_path = "";
                            if (ext_output1 == "nul")
                            {
                                String[] split = txt_parameters.Text.Split(' ');
                                for (int i = 0; i < split.Length; i++)
                                {
                                    if (split[i].Contains("\\") == true)
                                    {
                                        String pre_path = split[i].Replace("%fp", Path.GetDirectoryName(file2)).Replace("%fn", Path.GetFileNameWithoutExtension(file2)).Replace("%", "_");
                                        second_path = Path.GetDirectoryName(pre_path.Replace('\u0022', ' '));

                                        if (!Directory.Exists(second_path))
                                        {
                                            try
                                            {
                                                Directory.CreateDirectory(second_path);
                                            }
                                            catch
                                            {
                                            }
                                        }
                                    }
                                }
                            }

                            String current_out = destis[file_int] + "\\" + System.IO.Path.GetFileNameWithoutExtension(fullPath) + add_suffix + ext_output1;
                            Boolean to_overw = false;

                            if (chk_overw.CheckState == CheckState.Checked)
                            {
                                if (current_out == fullPath)
                                {
                                    tmp.StartInfo.Arguments = hw_decode + " " + pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + fullPath + '\u0022' + " " + shifting + " " + " -y " + tmp_params + " " + change_vol + '\u0022' + destis[file_int] + "\\" + System.IO.Path.GetFileNameWithoutExtension(fullPath) + "_fftemp" + add_suffix + ext_output1 + '\u0022' + " -hide_banner";
                                    to_overw = true;
                                }
                            }

                            if (current_out == fullPath && chk_overw.CheckState == CheckState.Unchecked)
                            {
                                MessageBox.Show(FFBatch.Properties.Strings.source_overw + Environment.NewLine + Environment.NewLine + current_out, FFBatch.Properties.Strings.overw_not, MessageBoxButtons.OK, MessageBoxIcon.Error);
                                this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                                working = false;
                                time_est_size = 0;
                                cts.Cancel();
                                Enable_Controls();
                                cancelados_paralelos = true;
                            }

                            //Monitor available space

                            DriveInfo dest_drive2 = new DriveInfo(Application.StartupPath);

                            FileInfo f_root2 = new FileInfo(current_out);
                            try
                            {
                                dest_drive2 = new DriveInfo(f_root2.Directory.Root.FullName);
                            }
                            catch { warn_space = false; }

                            if (dest_drive2.AvailableFreeSpace != null && warn_space == true)
                            {
                                if (dest_drive2.AvailableFreeSpace <= 500000000)
                                {
                                    DialogResult a = DialogResult.Cancel;

                                    a = MessageBox.Show(Properties.Strings2.warn_sp, Properties.Strings2.low_sp + " (" + (dest_drive2.AvailableFreeSpace / 1000000).ToString() + "MB)", MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation);
                                    if (a == DialogResult.Yes)
                                    {
                                        aborted = true;
                                        this.InvokeEx(f => f.lbl_est_size.Text = "");
                                        this.InvokeEx(f => f.lbl_bitrate.Text = "");
                                        cts.Cancel();
                                        return;
                                    }
                                }
                            }
                            //End monitor available space

                            if (verbose_logs == false) tmp.StartInfo.Arguments = tmp.StartInfo.Arguments + " -loglevel warning -stats";
                            if (cts.IsCancellationRequested == false)
                            {
                                tmp.StartInfo.FileName = ffm;
                                tmp.StartInfo.RedirectStandardInput = true;
                                tmp.StartInfo.RedirectStandardOutput = true;
                                tmp.StartInfo.RedirectStandardError = true;
                                tmp.StartInfo.UseShellExecute = false;
                                tmp.StartInfo.CreateNoWindow = true;
                                tmp.EnableRaisingEvents = true;

                                tmp.Start();
                                this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.processing);

                                combo_prio.Invoke(new MethodInvoker(delegate
                                {
                                    if (combo_prio.SelectedIndex != 2)
                                    {
                                        try
                                        {
                                            if (combo_prio.SelectedIndex == 0) tmp.PriorityClass = ProcessPriorityClass.High;
                                            if (combo_prio.SelectedIndex == 1) tmp.PriorityClass = ProcessPriorityClass.AboveNormal;
                                            if (combo_prio.SelectedIndex == 2) tmp.PriorityClass = ProcessPriorityClass.Normal;
                                            if (combo_prio.SelectedIndex == 3) tmp.PriorityClass = ProcessPriorityClass.BelowNormal;
                                            if (combo_prio.SelectedIndex == 4) tmp.PriorityClass = ProcessPriorityClass.Idle;
                                            Process[] localByName = Process.GetProcessesByName("FFBatch");
                                            if (localByName.Length == 1)
                                            {
                                                foreach (Process proc1 in localByName)
                                                {
                                                    if (combo_prio.SelectedIndex >= 2) proc1.PriorityClass = ProcessPriorityClass.Normal;
                                                    else proc1.PriorityClass = tmp.PriorityClass;
                                                }
                                            }
                                        }
                                        catch { }
                                    }
                                }));
                            }
                            else
                            {
                                timer1.Stop();
                                this.InvokeEx(f => f.listView1.Enabled = true);
                                working = false;
                                multi_running = false;
                                Enable_Controls();
                                cancelados_paralelos = false;
                                return;
                            }

                            this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.processing);

                            FileInfo f_root = new FileInfo(destis[file_int]);
                            DriveInfo dest_drive = new DriveInfo(Application.StartupPath);
                            try
                            {
                                dest_drive = new DriveInfo(f_root.Directory.Root.FullName);
                            }
                            catch { warn_space = false; }

                            String err_txt = "";
                            Double interval = 0;
                            Double durat_n2 = 0;
                            this.InvokeEx(f => multi_logs["log_n_" + file_int.ToString()] = Properties.Strings2.logging_f + " " + '\u0022' + listView1.Items[Convert.ToInt32(file_int)].Text + '\u0022' + Environment.NewLine);
                            //REVIEW
                            while (!tmp.StandardError.EndOfStream)
                            {
                                err_txt = tmp.StandardError.ReadLine();
                                space_timer++;
                                multi_logs["log_n_" + file_int.ToString()] = multi_logs["log_n_" + file_int.ToString()] + Environment.NewLine + n_logs + err_txt;

                                if (err_txt.Contains("time=") && err_txt.Contains("time=-") == false)
                                {
                                    if (valid_prog2 == true)
                                    {
                                        this.InvokeEx(f => f.txt_remain.Refresh());
                                        this.InvokeEx(f => durat_n2 = row_duration);
                                        int start_time_index = err_txt.IndexOf("time=") + 5;
                                        Double sec_prog = TimeSpan.Parse(err_txt.Substring(start_time_index, 8)).TotalSeconds;
                                        Double percent = (sec_prog * 100 / durat_n2);

                                        total_prog = total_prog + (sec_prog - interval);
                                        interval = sec_prog;
                                        int percent2 = 0;
                                        try
                                        {
                                            percent2 = Convert.ToInt32(percent);
                                        }
                                        catch
                                        {
                                        }

                                        if (percent2 <= 100)
                                        {
                                            if (Math.Round(percent, 1).ToString().Contains(".") || Math.Round(percent, 1).ToString().Contains(","))
                                            {
                                                this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = Math.Round(percent, 1).ToString() + "%");
                                            }
                                            else
                                            {
                                                this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = Math.Round(percent, 1).ToString() + ".0" + "%");
                                            }
                                        }
                                    }
                                    try
                                    {
                                        if (err_txt.Contains("fps="))
                                        {
                                            multi_fps[file_int] = (err_txt.Substring(err_txt.LastIndexOf("fps=") + 4, 4)).TrimStart();
                                        }
                                        else
                                        {
                                            multi_fps[file_int] = "0";
                                        }
                                    }
                                    catch { multi_fps[file_int] = "0"; }
                                    try
                                    {
                                        if (err_txt.ToLower().Contains("speed="))
                                        {
                                            multi_speeds[file_int] = (err_txt.Substring(err_txt.LastIndexOf("speed=") + 6, err_txt.Length - err_txt.LastIndexOf("speed=") - 6)).Replace("x", "");
                                        }
                                        else
                                        {
                                            multi_speeds[file_int] = "0";
                                        }
                                    }
                                    catch { multi_speeds[file_int] = "0"; }
                                }

                                //Monitor available space
                                if (space_timer % 30 == 0 && dest_drive.AvailableFreeSpace <= 500000000 && warn_space == true)
                                {
                                    foreach (Process proc in procs.Values)
                                    {
                                        try
                                        {
                                            proc.Suspend();
                                        }
                                        catch
                                        {
                                        }
                                    }
                                    DialogResult a = MessageBox.Show(Properties.Strings2.warn_sp, Properties.Strings2.low_sp + " (" + (dest_drive2.AvailableFreeSpace / 1000000).ToString() + "MB)", MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation);
                                    foreach (Process proc in procs.Values)
                                    {
                                        try
                                        {
                                            proc.Resume();
                                        }
                                        catch
                                        {
                                        }
                                    }

                                    if (a == DialogResult.Yes)
                                    {
                                        cts.Cancel();
                                        aborted = true;
                                        cancelados_paralelos = true;

                                        foreach (Process proc in procs.Values)
                                        {
                                            cancelados_paralelos = true;
                                            if (proc.StartInfo.Arguments != String.Empty)

                                            {
                                                try
                                                {
                                                    StreamWriter write_q = proc.StandardInput;
                                                    write_q.Write("q");
                                                }
                                                catch { }
                                            }
                                        }
                                    }

                                    warn_space = false;
                                }
                                //End monitor space
                            }
                            tmp.WaitForExit();
                            tmp.StartInfo.Arguments = String.Empty;
                            multi_speeds[file_int] = "0";
                            multi_fps[file_int] = "0";
                            this.InvokeEx(f => multi_logs["log_n_" + file_int.ToString()] = multi_logs["log_n_" + file_int.ToString()] + Environment.NewLine + "--------End of " + '\u0022' + listView1.Items[Convert.ToInt32(file_int)].Text + '\u0022' + " log--------" + Environment.NewLine);

                            if (tmp.ExitCode == 0)
                            {
                                list_successful_m.Add(fullPath);
                                if (cancelados_paralelos == false && cts.IsCancellationRequested == false)
                                {
                                    if (aborted_url == false)
                                    {
                                        if (File.Exists(fullPath) == true)
                                        {
                                            this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.success);

                                            if (chk_overw.CheckState == CheckState.Checked)
                                            {
                                                if (current_out == fullPath)
                                                {
                                                    String sourc = destis[file_int] + "\\" + System.IO.Path.GetFileNameWithoutExtension(fullPath) + "_fftemp" + add_suffix + ext_output1;

                                                    try
                                                    {
                                                        if (File.Exists(sourc))
                                                        {
                                                            File.Delete(fullPath);
                                                            FileSystem.RenameFile(sourc, Path.GetFileNameWithoutExtension(fullPath) + add_suffix + ext_output1);
                                                            this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.replaced);
                                                        }
                                                        else
                                                        {
                                                            this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.not_replaced);
                                                            warn_enc++;
                                                            this.InvokeEx(f => multi_logs["log_n_" + file_int.ToString()] = multi_logs["log_n_" + file_int.ToString()] + Environment.NewLine + Properties.Strings2.warning_file + " " + +'\u0022' + listView1.Items[Convert.ToInt32(file_int)].Text + '\u0022' + " " + Properties.Strings2.warning_not_rep + " " + "(_fftemp)." + Environment.NewLine);
                                                        }
                                                    }
                                                    catch (Exception excpt)
                                                    {
                                                        try
                                                        {
                                                            FileSystem.RenameFile(sourc, Path.GetFileNameWithoutExtension(fullPath) + add_suffix + ext_output1);
                                                            this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.replaced);
                                                        }
                                                        catch
                                                        {
                                                            try
                                                            {
                                                                FileSystem.RenameFile('\u0022' + sourc + '\u0022', '\u0022' + Path.GetFileNameWithoutExtension(fullPath) + add_suffix + ext_output1 + '\u0022');
                                                                this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.replaced);
                                                            }
                                                            catch
                                                            {
                                                                this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.renamed);
                                                                warn_enc++;
                                                                this.InvokeEx(f => multi_logs["log_n_" + file_int.ToString()] = multi_logs["log_n_" + file_int.ToString()] + Environment.NewLine + Properties.Strings2.warning_file + " " + '\u0022' + listView1.Items[Convert.ToInt32(file_int)].Text + '\u0022' + " " + Properties.Strings2.warning_not_rep + " " + "(_fftemp)." + Environment.NewLine);
                                                            }
                                                        }
                                                    }
                                                }
                                            }

                                            if (chk_delete_source.CheckState == CheckState.Checked && delete_def == false && delete_one == true)
                                            {
                                                try
                                                {
                                                    FileSystem.DeleteFile(fullPath, UIOption.OnlyErrorDialogs, RecycleOption.SendToRecycleBin);
                                                    this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.recycled);
                                                }
                                                catch
                                                {
                                                    this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.not_recycled);
                                                    warn_enc++;
                                                }
                                            }
                                            if (chk_delete_source.CheckState == CheckState.Checked && delete_def == true && delete_one == true)
                                            {
                                                try
                                                {
                                                    FileInfo fs = new FileInfo(fullPath);
                                                    if (fs.IsReadOnly == true) fs.IsReadOnly = false;
                                                    File.Delete(fullPath);
                                                    this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.deleted);
                                                }
                                                catch
                                                {
                                                    this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.not_deleted);
                                                    warn_enc++;
                                                }
                                            }
                                        }
                                    }
                                    if (aborted_url == true)
                                    {
                                        if (skipped == false) this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.aborted);
                                        else
                                        {
                                            this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.skipped);
                                            try
                                            {
                                                File.Delete(current_out);
                                            }
                                            catch { }
                                        }
                                        aborted_url = false;
                                        skipped = false;
                                    }

                                    //Run on each file
                                    int index = 0;
                                    Boolean sh_check = false;
                                    combo_shut.Invoke(new MethodInvoker(delegate
                                    {
                                        index = combo_shut.SelectedIndex;
                                    }));
                                    chkshut.Invoke(new MethodInvoker(delegate
                                    {
                                        if (chkshut.Checked == true) sh_check = true;
                                    }));

                                    if (index == 4 && cancel_queue == false && sh_check == true)
                                    {
                                        this.InvokeEx(f => this.Enabled = false);
                                        Form14 frm_run = new Form14();
                                        frm_run.txt_path.Text = run_command;
                                        String dest_f = '\u0022' + destis[file_int] + "\\" + System.IO.Path.GetFileNameWithoutExtension(fullPath) + add_suffix + ext_output1 + '\u0022';
                                        if (ext_output1 == "nul") dest_f = '\u0022' + destis[file_int] + "\\" + System.IO.Path.GetFileNameWithoutExtension(fullPath) + add_suffix + Path.GetExtension(fullPath).Replace(".", "") + '\u0022';

                                        frm_run.args = dest_f + " " + run_command_args;
                                        frm_run.timer1.Interval = 100;
                                        frm_run.ShowDialog();
                                        this.InvokeEx(f => this.Enabled = true);
                                        Enable_Controls();

                                        if (frm_run.proc.ExitCode == 0)
                                        {
                                            this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = "OK & Run");
                                            multi_logs["log_n_" + file_int.ToString()] = multi_logs["log_n_" + file_int.ToString()] + Environment.NewLine + n_logs + Properties.Strings2.ext_com_ok + " " + dest_f + Environment.NewLine;
                                        }
                                        else
                                        {
                                            this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = "OK & Error");
                                            multi_logs["log_n_" + file_int.ToString()] = multi_logs["log_n_" + file_int.ToString()] + Environment.NewLine + n_logs + Properties.Strings2.ext_com_err + " " + dest_f + Environment.NewLine;
                                        }
                                        this.InvokeEx(f => this.TopMost = true);
                                        this.InvokeEx(f => this.TopMost = false);
                                    }

                                    //End run on each file
                                }
                                else
                                {
                                    this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.aborted);

                                    if (cancelados_paralelos == false)
                                    {
                                        aborted_url = false;
                                    }
                                }
                            }
                            else
                            {
                                list_failed_m.Add(fullPath);
                                this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.failed);
                                errors_enc = errors_enc + 1;
                            }
                        }).Wait();

                    file_int++;
                });
            }
            catch (Exception exc)
            {
                fatal_parallel_msg = exc.Message;
                fatal_parallel = true;
            }

            if (result.IsCompleted == true) fatal_parallel = false;
            else
            {
                if (cts.IsCancellationRequested == false) fatal_parallel = true;
                else fatal_parallel = false;
            }
            String avgs = "";
            //Averages

            if (start_total_time == 0) start_total_time = 1;
            Double avg_enc = Math.Round((total_multi_duration / start_total_time), 1);

            try
            {
                if (cancelados_paralelos == false)
                {
                    if (tot_frames2 != 0)
                    {
                        avgs = Environment.NewLine + (FFBatch.Properties.Strings.avg_perf + " " + avg_enc.ToString() + "x" + "  |  " + Math.Round(tot_frames2 / (decimal)start_total_time, 1)).ToString() + " fps";
                        this.InvokeEx(f => f.lbl_speed.Text = ("AVG: " + avg_enc.ToString() + "x" + "  |  " + Math.Round(tot_frames2 / (decimal)start_total_time, 1)).ToString() + " fps");
                    }
                    else
                    {
                        avgs = Environment.NewLine + (FFBatch.Properties.Strings.avg_perf + " " + avg_enc.ToString() + "x");
                        this.InvokeEx(f => f.lbl_speed.Text = ("AVG: " + avg_enc.ToString() + "x"));
                    }
                }
            }
            catch { }

            //End averages

            if (no_save_logs == false)
            {
                String[] array_err = list_lines.ToArray();

                String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                if (is_portable == true) path = port_path + "ff_batch_portable.log";
                try
                {
                    System.IO.StreamWriter SaveFile = new System.IO.StreamWriter(path);
                    SaveFile.WriteLine("Multi-file log session: " + System.DateTime.Now);
                    SaveFile.WriteLine("-----------------------------------------------------");
                    SaveFile.Write(string.Join(Environment.NewLine, multi_logs.Select(a => $"{a.Value}")));
                    SaveFile.Close();
                    File.AppendAllText(path, avgs + Environment.NewLine + Environment.NewLine);
                    File.AppendAllText(path, "--------------------------");
                    File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.end_log);
                    File.AppendAllText(path, Environment.NewLine);
                    System.IO.FileInfo fileInfo = new System.IO.FileInfo(path);

                    var bytes = fileInfo.Length;

                    var kilobytes = (double)bytes / 1024;
                    var megabytes = kilobytes / 1024;
                    var gigabytes = megabytes / 1024;

                    //Format size view
                    String size = "";
                    String separator = ".";

                    if (bytes > 1000000000)
                    {
                        if (gigabytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }

                        String gigas = gigabytes.ToString();
                        if (gigas.Length >= 5)
                        {
                            gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                            size = (gigas + " " + "GB");
                        }
                        else
                        {
                            size = (gigas + " " + "GB");
                        }
                    }

                    if (bytes >= 1048576 && bytes <= 1000000000)
                    {
                        if (megabytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }
                        String megas = megabytes.ToString();
                        if (megas.Length > 5)
                        {
                            megas = megas.Substring(0, megas.LastIndexOf(separator));
                            size = (megas + " " + "MB");
                        }
                        else
                        {
                            size = (megas + " " + "MB");
                        }
                    }

                    if (bytes >= 1024 && bytes < 1048576)

                    {
                        if (kilobytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }

                        String kbs = kilobytes.ToString();
                        if (kbs.Length >= 5)
                        {
                            kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                            size = (kbs + " " + "KB");
                        }
                        else
                        {
                            size = (kbs + " " + "KB");
                        }
                    }
                    if (bytes > -1 && bytes < 1024)
                    {
                        String bits = bytes.ToString();
                        size = (bits + " Bytes");
                    }

                    //End Format size view
                    File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.log_size + " " + size);
                }
                catch { }

                //End save log
            }
        }

        private void BG_Multi_M_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            listView1.SelectedIndices.Clear();
            clean_ffb_test();

            Boolean pending_item = false;
            foreach (ListViewItem item in listView1.Items)
            {
                if (item.SubItems[5].Text == Properties.Strings.queued)
                {
                    pending_item = true;
                    break;
                }
            }
            if (pending_item == true && aborted == false)
            {
                BG_Pending_M.RunWorkerAsync();
                return;
            }

            this.Text = "FFmpeg Batch AV Converter";

            if (is_portable == true) this.Text = "FFmpeg Batch AV Converter Portable";
            timer_aborting.Stop();

            // Close abort form
            for (int i = Application.OpenForms.Count - 1; i >= 0; i--)
            {
                if (Application.OpenForms[i].Name == "Form12")
                {
                    this.InvokeEx(f => Application.OpenForms[i].Close());
                    break;
                }
            }
            //End close abort form
            listView1.SelectedItems.Clear();
            TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress);
            timer1.Stop();
            timer_tasks.Stop();
            Pg1.Value = Pg1.Maximum;
            Pg1.Text = "100%";
            Pg1.Refresh();
            listView1.Enabled = true;
            working = false;
            multi_running = false;
            Enable_Controls();

            if (cancelados_paralelos == false && fatal_parallel == false)
            {
                //Open on completion
                String primero_lista = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text;
                String destino2 = String.Empty;
                if (chk_open_compl.Checked == true)
                {
                    if (txt_path_main.Text.Contains(".\\"))
                    {
                        destino2 = destino2 = primero_lista.Substring(0, primero_lista.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty); ;
                    }
                    else
                    {
                        destino2 = txt_path_main.Text;
                    }
                }

                if (chk_delete_source.CheckState == CheckState.Checked && delete_def == false && delete_one == false)
                {
                    Disable_Controls();

                    Label prog_txt = new Label();
                    prog_txt.Parent = panel1;
                    prog_txt.Top = 95;
                    prog_txt.Left = 80;
                    prog_txt.Width = 250;
                    prog_txt.TabIndex = 1;
                    prog_txt.BackColor = panel1.BackColor;
                    prog_txt.BorderStyle = BorderStyle.None;
                    prog_txt.TextAlign = ContentAlignment.MiddleLeft;
                    prog_txt.BringToFront();
                    prog_txt.Text = FFBatch.Properties.Strings.to_recycle;

                    ProgressBar pg_del = new ProgressBar();
                    pg_del.Parent = panel1;
                    pg_del.Top = 98;
                    pg_del.Left = 315;
                    pg_del.Width = 152;
                    pg_del.Height = 15;
                    pg_del.TabIndex = 0;
                    pg_del.BackColor = this.BackColor;
                    pg_del.Minimum = 0;
                    pg_del.BringToFront();
                    pg_del.Maximum = listView1.Items.Count;
                    pg_del.Show();
                    pg_del.Refresh();
                    int i = 0;
                    int err = 0;

                    foreach (String item in list_successful_m)
                    {
                        try
                        {
                            FileSystem.DeleteFile(item, UIOption.OnlyErrorDialogs, RecycleOption.SendToRecycleBin);
                            pg_del.Value = i;
                            i = i + 1;

                            foreach (ListViewItem item2 in listView1.Items)
                            {
                                if (item2.Text == Path.GetFileName(item))
                                {
                                    item2.SubItems[5].Text = FFBatch.Properties.Strings.recycled;
                                }
                            }
                        }
                        catch
                        {
                            err = err + 1;
                            listView1.Invoke(new MethodInvoker(delegate
                            {
                                foreach (ListViewItem item2 in listView1.Items)
                                {
                                    if (item2.Text == Path.GetFileName(item))
                                    {
                                        item2.SubItems[5].Text = FFBatch.Properties.Strings.not_recycled;
                                    }
                                }
                            }));
                        }
                        prog_txt.Text = FFBatch.Properties.Strings.to_recycle + i.ToString() + " " + FFBatch.Properties.Strings.of1 + " " + list_global_proc.Items.Count;
                        prog_txt.Refresh();
                    }
                    prog_txt.Visible = false;
                    prog_txt.Dispose();
                    pg_del.Visible = false;
                    pg_del.Dispose();
                    Enable_Controls();

                    if (err > 0) MessageBox.Show(err.ToString() + " " + Properties.Strings.not_recycled2 + Properties.Strings.check_log, FFBatch.Properties.Strings.not_recycled3, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);

                    if (list_failed_m.Count > 0)
                    {
                        String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                        if (is_portable == true) path = port_path + "ff_batch_portable.log";

                        File.AppendAllText(path, Environment.NewLine + Environment.NewLine + Properties.Strings2.source_not_deleted);
                        File.AppendAllText(path, Environment.NewLine + "-------------------------------");
                        foreach (String item in list_failed_m)
                        {
                            File.AppendAllText(path, Environment.NewLine + item);
                        }
                    }

                    //End delete source
                }

                if (chk_delete_source.CheckState == CheckState.Checked && delete_def == true && delete_one == false)
                {
                    Disable_Controls();

                    Label prog_txt = new Label();
                    prog_txt.Parent = panel1;
                    prog_txt.Top = 95;
                    prog_txt.Left = 80;
                    prog_txt.Width = 250;
                    prog_txt.TabIndex = 1;
                    prog_txt.BackColor = panel1.BackColor;
                    prog_txt.BorderStyle = BorderStyle.None;
                    prog_txt.TextAlign = ContentAlignment.MiddleLeft;
                    prog_txt.BringToFront();
                    prog_txt.Text = Properties.Strings2.deleting_files;

                    ProgressBar pg_del = new ProgressBar();
                    pg_del.Parent = panel1;
                    pg_del.Top = 98;
                    pg_del.Left = 315;
                    pg_del.Width = 152;
                    pg_del.Height = 15;
                    pg_del.TabIndex = 0;
                    pg_del.BackColor = this.BackColor;
                    pg_del.Minimum = 0;
                    pg_del.BringToFront();
                    pg_del.Maximum = listView1.Items.Count;
                    pg_del.Show();
                    pg_del.Refresh();
                    int i = 0;
                    int err = 0;

                    foreach (String item in list_successful_m)
                    {
                        try
                        {
                            FileInfo fs = new FileInfo(item);
                            if (fs.IsReadOnly == true) fs.IsReadOnly = false;
                            File.Delete(item);
                            pg_del.Value = i;
                            i = i + 1;

                            foreach (ListViewItem item2 in listView1.Items)
                            {
                                if (item2.Text == Path.GetFileName(item))
                                {
                                    item2.SubItems[5].Text = FFBatch.Properties.Strings.deleted;
                                }
                            }
                        }
                        catch
                        {
                            err = err + 1;

                            foreach (ListViewItem item2 in listView1.Items)
                            {
                                if (item2.Text == Path.GetFileName(item))
                                {
                                    item2.SubItems[5].Text = FFBatch.Properties.Strings.not_deleted;
                                }
                            }
                        }
                        prog_txt.Text = Properties.Strings2.deleting_f + " " + i.ToString() + " " + FFBatch.Properties.Strings.of1 + " " + list_global_proc.Items.Count;
                        prog_txt.Refresh();
                    }
                    prog_txt.Visible = false;
                    prog_txt.Dispose();
                    pg_del.Visible = false;
                    pg_del.Dispose();
                    Enable_Controls();

                    if (err > 0) MessageBox.Show(err.ToString() + " " + Properties.Strings.not_recycled2 + " " + Properties.Strings.check_log, FFBatch.Properties.Strings.not_recycled3, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);

                    if (list_failed_m.Count > 0)
                    {
                        String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                        if (is_portable == true) path = port_path + "ff_batch_portable.log";

                        File.AppendAllText(path, Environment.NewLine + Environment.NewLine + Properties.Strings2.source_not_deleted);
                        File.AppendAllText(path, Environment.NewLine + "-------------------------------");
                        foreach (String item in list_failed_m)
                        {
                            File.AppendAllText(path, Environment.NewLine + item);
                        }
                    }

                    //End delete source
                }
                this.InvokeEx(f => toolT002.RemoveAll());

                if (errors_enc == 0)
                {
                    pic_no_errors.Visible = true;
                    //Delete source

                    //Automatic shutdown check
                    if (chkshut.Checked)
                    {
                        auto_shut();
                        return;
                    }

                    if (warn_enc > 0)
                    {
                        pic_no_errors.Visible = false;
                        pic_recording.Visible = false;
                        toolT002.SetToolTip(this.pic_warnings, FFBatch.Properties.Strings.there_w + " " + warn_enc.ToString() + " " + Properties.Strings2.warnings_last_s);
                        pic_warnings.Visible = true;
                    }
                }
                else
                {
                    pic_no_errors.Visible = false;
                    pic_recording.Visible = false;
                    toolT002.SetToolTip(this.pic_warnings, FFBatch.Properties.Strings.there_w + " " + errors_enc.ToString() + " " + FFBatch.Properties.Strings.errors_se);
                    pic_warnings.Visible = true;
                }

                if (errors_enc == 0)
                {
                    if (play_on_end == true) play_end();
                }
                else if (play_on_end == true) System.Media.SystemSounds.Asterisk.Play();

                if (this.ContainsFocus == false)
                {
                    if (errors_enc == 0 && warn_enc == 0)
                    {
                        notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.enc_comp;
                        notifyIcon1.BalloonTipIcon = ToolTipIcon.Info;
                        notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.enc_comp2;
                        notifyIcon1.ShowBalloonTip(0);
                    }
                    if (errors_enc > 0)
                    {
                        notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.enc_comp3 + " " + errors_enc.ToString() + " " + FFBatch.Properties.Strings.errors1;
                        notifyIcon1.BalloonTipIcon = ToolTipIcon.Warning;
                        notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.enc_comp2;
                        notifyIcon1.ShowBalloonTip(0);
                    }
                    if (errors_enc == 0 && warn_enc > 0)
                    {
                        if (errors_enc == 0 && warn_enc > 0)
                        {
                            notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.enc_warns;
                            notifyIcon1.BalloonTipIcon = ToolTipIcon.Warning;
                            notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.enc_comp2;
                            notifyIcon1.ShowBalloonTip(0);
                        }
                    }
                }

                if (chk_open_compl.Checked == true && opened_m == false)
                {
                    opened_m = true;
                    try
                    {
                        if (Directory.GetFiles(destino2).Length != 0)
                        {
                            Process open_processed = new Process();
                            open_processed.StartInfo.FileName = "explorer.exe";
                            open_processed.StartInfo.Arguments = '\u0022' + multi_dest + '\u0022';
                            open_processed.Start();
                        }
                        else
                        {
                            if (Directory.Exists(destino2))
                            {
                                System.IO.Directory.Delete(destino2);
                            }
                        }
                    }
                    catch
                    {
                    }
                }

                return;
            }
            else
            {
                if (aborted == true)
                {
                    aborted = false;
                    MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.task_abort, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                }
                cancelados_paralelos = false;
            }
        }

        private void clean_ffb_test()
        {
            //Clean ffbatch_test
            String destino_test = Path.GetTempPath() + "\\" + "FFBatch_test";
            try
            {
                if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length > 0)
                {
                    foreach (String file in Directory.GetFiles(destino_test))
                    {
                        try
                        {
                            File.Delete(file);
                        }
                        catch { }
                    }
                }
            }
            catch { }

            if (Directory.Exists(destino_test) && Directory.GetFiles(destino_test).Length == 0)
                try { System.IO.Directory.Delete(destino_test); } catch { }

            try
            {
                if (Directory.Exists(destino_test))
                {
                    if (Directory.GetFiles(destino_test).Length == 0)
                    {
                        try
                        {
                            System.IO.Directory.Delete(destino_test);
                        }
                        catch { }
                    }
                }
            }
            catch { }

            //End clean ffbatch_test
        }

        private void BG_Validate_added_row_YT_PL_S_DoWork(object sender, DoWorkEventArgs e)
        {
            this.InvokeEx(f => this.Enabled = false);
            foreach (DataGridViewRow row in dg1.Rows) row.Cells[5].Value = FFBatch.Properties.Strings.get_cont;

            if (dg1.Rows[dg1.RowCount - 1].Cells[1].Value == null)
            {
                dg1.Rows[dg1.RowCount - 1].Cells[5].Value = String.Empty;
                dg1.Rows[dg1.RowCount - 1].Cells[4].Value = String.Empty;
                dg1.Rows[dg1.RowCount - 1].Cells[3].Value = String.Empty;
                dg1.Rows[dg1.RowCount - 1].Cells[2].Value = String.Empty;
                //dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor;
                return;
            }

            if (dg1.Rows[dg1.RowCount - 1].Cells[1].Value.ToString().Contains("http") == false)
            {
                dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.error;
                dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = Color.LightGoldenrodYellow;
                return;
            }

            dg1.Invoke(new MethodInvoker(delegate
            {
                dg1.Refresh();
                dg1_temp.Rows.Clear();
                dg1_temp.Columns.Clear();
                dg1.AllowUserToAddRows = false;
                foreach (DataGridViewColumn col in dg1.Columns) dg1_temp.Columns.Add((DataGridViewColumn)col.Clone()); ;
            }));

            int prog = 0;

            procs.Clear();
            for (int ii = 0; ii < dg1.RowCount; ii++)
            {
                procs.Add("proc_urls_" + ii.ToString(), new Process());
            }

            ParallelOptions par_op = new ParallelOptions();
            par_op.MaxDegreeOfParallelism = (int)n_downs.Value;
            System.Threading.CancellationTokenSource cts = new System.Threading.CancellationTokenSource();
            par_op.CancellationToken = cts.Token;

            var workItems = Enumerable.Range(0, dg1.RowCount);
            ParallelLoopResult result = new ParallelLoopResult();
            fatal_parallel = false;
            fatal_parallel_msg = "";

            Form9 form_prog2 = new Form9();

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;

                form_prog2.progressBar1.Visible = false;
                form_prog2.pictureBox2.Visible = true;
                form_prog2.label1.Text = FFBatch.Properties.Strings.pl_contents;
                form_prog2.lab_count.Text = "";
                form_prog2.lab_count.Refresh();
                form_prog2.Refresh();
                form_prog2.progressBar1.Refresh();
                form_prog2.ShowDialog();
            }).Start();

            try
            {
                result = Parallel.ForEach(workItems, par_op, (ii) =>
                {
                    var probe = procs["proc_urls_" + ii.ToString()];

                    if (form_prog2.abort_validate == true || stop_validating_url == true)
                    {
                        cts.Cancel();
                    }

                    if (cts.IsCancellationRequested == true) form_prog2.abort_validate = true;

                    if (dg1.Rows[ii].Cells[1].Value == null) form_prog2.abort_validate = true;

                    if (stop_validating_url == true) form_prog2.abort_validate = true;

                    probe.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe");
                    probe.StartInfo.WorkingDirectory = Application.StartupPath;
                    probe.StartInfo.Arguments = "--flat-playlist --dump-json " + dg1.Rows[ii].Cells[1].Value.ToString();
                    probe.StartInfo.RedirectStandardOutput = true;
                    probe.StartInfo.UseShellExecute = false;
                    probe.StartInfo.StandardOutputEncoding = Encoding.UTF8;
                    probe.StartInfo.CreateNoWindow = true;
                    probe.EnableRaisingEvents = true;

                    probe.Start();
                    String line = "";

                    while (!probe.StandardOutput.EndOfStream)
                    {
                        if (form_prog2.abort_validate == true || stop_validating_url == true)
                        {
                            cts.Cancel();
                        }
                        else
                        {
                            line = probe.StandardOutput.ReadLine();

                            if (line != null && line != "") dg1_temp.Rows.Add(pic_noimg.Image, "https://www.youtube.com/watch?v=" + line.Substring(line.IndexOf('\u0022' + "url" + '\u0022' + ": " + '\u0022') + 8, 11), "-", "-", "", "");
                        }
                    }
                    probe.WaitForExit();
                    probe.StartInfo.Arguments = String.Empty;
                    ii++;
                });
            }
            catch { }

            form_prog2.Invoke(new MethodInvoker(delegate
            { form_prog2.Close(); }));

            if (result.IsCompleted == true) fatal_parallel = false;
            else
            {
                if (cts.IsCancellationRequested == false) fatal_parallel = true;
                else fatal_parallel = false;
            }

            //End Parallel
            try
            {
                form_prog2.Invoke(new MethodInvoker(delegate
                { form_prog2.Close(); }));
            }
            catch { form_prog2.abort_validate = true; }
        }

        private void BG_Validate_added_row_YT_PL_S_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            playlists_int = dg1_temp.RowCount;
            if (dg1_temp.RowCount > 2000)
            {
                MessageBox.Show(FFBatch.Properties.Strings.max_links, FFBatch.Properties.Strings.max_list, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                release_datagrid();
                return;
            }
            else
            {
                if (stop_validating_url == false && fatal_parallel == false)
                {
                    dg1.Rows.Clear();
                    foreach (DataGridViewRow row2 in dg1_temp.Rows)
                    {
                        DataGridViewRow clonedRow = (DataGridViewRow)row2.Clone();
                        for (Int32 index = 0; index < row2.Cells.Count; index++)
                        {
                            clonedRow.Cells[index].Value = row2.Cells[index].Value;
                        }
                        dg1.Rows.Add(clonedRow);
                    }
                    foreach (DataGridViewRow row3 in dg1.Rows)
                    {
                        if (row3.Cells[1].Value == null) dg1.Rows.RemoveAt(row3.Index);
                    }
                    dg1.Refresh();
                }
                dg1.ReadOnly = false;
                this.Enabled = true;
                this.TopMost = true;
                this.TopMost = false;
                btn_validate_url.PerformClick();
            }
        }

        private void timer_aborting_Tick(object sender, EventArgs e)
        {
            timer_aborting.Stop();
            Form12 frm_abort = new Form12();
            try
            {
                frm_abort.ShowDialog();
                frm_abort.Refresh();
            }
            catch { }
        }

        private void BG_Multi_Down_DoWork(object sender, DoWorkEventArgs e)
        {
            Disable_Controls();
            aborted = false;
            cancelados_paralelos = false;
            m3u_running = true;
            m3u_single_running = false;
            fatal_parallel = false;
            fatal_parallel_msg = "";
            Boolean quit = false;
            List<string> list_lines = new List<string>();
            List<string> er = new List<string>();
            String msg_er = String.Empty;

            ParallelOptions par_op = new ParallelOptions();
            par_op.MaxDegreeOfParallelism = (int)n_downs.Value;
            CancellationTokenSource cts = new System.Threading.CancellationTokenSource();
            par_op.CancellationToken = cts.Token;

            ParallelLoopResult result = new ParallelLoopResult();
            var workItems = Enumerable.Range(0, dg1.RowCount);
            try
            {
                result = Parallel.ForEach(workItems.AsParallel().AsOrdered(), par_op, (file_int) =>
                {
                    Boolean skip = false;
                    //String all_logs = "";

                    if (dg1.Rows[file_int].IsNewRow) skip = true;

                    DataGridViewRow tmp_row = dg1.Rows[file_int];

                    if (cancelados_paralelos == true || aborted == true)
                    {
                        cts.Cancel();
                        return;
                    }

                    String url_capture_time = String.Empty;

                    Double total_prog = 0;
                    Double row_duration = 0;

                    TimeSpan time2;
                    if (TimeSpan.TryParse(tmp_row.Cells[3].Value.ToString(), out time2))
                    {
                        row_duration = TimeSpan.Parse(tmp_row.Cells[3].Value.ToString()).TotalSeconds;
                        url_capture_time = " -t " + row_duration.ToString();
                    }
                    else
                    {
                        row_duration = 0;
                        url_capture_time = String.Empty;
                    }

                    String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");
                    String file = tmp_row.Cells[1].Value.ToString();
                    String destino = txt_path_m3u.Text;

                    String pre_input_var = "";
                    if (txt_pre_input.Text != "")
                    {
                        pre_input_var = txt_pre_input.Text;
                    }

                    String pre_ss = "";
                    if (TimeSpan.Parse(ss_time_input.Text).TotalSeconds != 0)
                    {
                        pre_ss = " -ss " + ss_time_input.Text;
                    }

                    add_suffix = "";

                    String ext_output1 = txt_format.Text;
                    if (txt_format.Text == String.Empty)
                    {
                        ext_output1 = Path.GetExtension(file);
                    }
                    else
                    {
                        ext_output1 = "." + txt_format.Text;
                    }

                    String AppParam = String.Empty;

                    if (chk_output_server.CheckState == CheckState.Checked)
                    {
                        AppParam = pre_input_var + " " + pre_ss + " -i " + file + " " + url_capture_time + " " + m3u_params_m + " -y " + output_server_m;
                    }
                    else
                    {
                        AppParam = pre_input_var + " " + pre_ss + " -i " + file + " " + url_capture_time + " " + m3u_params_m + " -y " + '\u0022' + Path.Combine(destino, tmp_row.Cells[4].Value.ToString() + "." + m3u_output_ext_m);
                    }

                    if (!Directory.Exists(destino))
                    {
                        try
                        {
                            Directory.CreateDirectory(destino);
                        }
                        catch (System.Exception excpt)
                        {
                            MessageBox.Show(Properties.Strings2.err_write_out + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            this.Cursor = Cursors.Arrow;
                            return;
                        }
                    }
                    var tmp = procs["proc_urls_" + tmp_row.Index];
                    var n_logs = multi_logs["log_n_" + tmp_row.Index.ToString()];

                    if (!multi_dest.ToLower().Contains("m3u"))
                    {
                        tmp.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe");
                        if (m3u_params_m.Contains("-f "))
                        {
                            tmp.StartInfo.Arguments = bestv_a + " " + Clear_cache + " " + m3u_params_m + " " + down_speed_m + " " + embed_subs_m + " " + auto_subs_m + " " + embed_meta_m + " " + write_subs_m + " " + convert_subs_m + " -o " + '\u0022' + destino + "\\" + tmp_row.Cells[4].Value.ToString() + "." + format_out_m + '\u0022' + " " + file;
                        }
                        else
                        {
                            if (bestv_a.Length == 0)
                            {
                                tmp.StartInfo.Arguments = Clear_cache + " " + m3u_params_m + " " + down_speed_m + " " + embed_subs_m + " " + auto_subs_m + " " + embed_meta_m + " -o " + '\u0022' + destino + "\\" + tmp_row.Cells[4].Value.ToString() + "." + format_out_m + '\u0022' + " " + file;
                                tmp.StartInfo.WorkingDirectory = Application.StartupPath;
                            }
                            else
                            {
                                tmp.StartInfo.Arguments = bestv_a + " " + Clear_cache + " " + m3u_params_m + " " + down_speed_m + " " + embed_subs_m + " " + auto_subs_m + " " + embed_meta_m + " -o " + '\u0022' + destino + "\\" + tmp_row.Cells[4].Value.ToString() + "." + format_out_m + '\u0022' + " " + file;
                                tmp.StartInfo.WorkingDirectory = Application.StartupPath;
                            }
                        }
                    }
                    else
                    {
                        tmp.StartInfo.FileName = ffm;
                        tmp.StartInfo.Arguments = AppParam;
                    }

                    tmp.StartInfo.RedirectStandardInput = true;
                    tmp.StartInfo.RedirectStandardOutput = true;
                    tmp.StartInfo.RedirectStandardError = true;
                    tmp.StartInfo.UseShellExecute = false;
                    tmp.StartInfo.CreateNoWindow = true;
                    tmp.EnableRaisingEvents = true;

                    dg1.Invoke(new MethodInvoker(delegate
                    {
                        if (dg1.Rows[file_int].Cells[3].Value.ToString() == "Live") dg1.Rows[file_int].Cells[5].Value = FFBatch.Properties.Strings.recording1;
                        else dg1.Rows[file_int].Cells[5].Value = FFBatch.Properties.Strings.init1;
                    }));

                    if (cts.IsCancellationRequested == false && quit == false)
                    {
                        tmp.Start();

                        combo_prio.Invoke(new MethodInvoker(delegate
                        {
                            if (combo_prio.SelectedIndex != 2)
                            {
                                try
                                {
                                    if (combo_prio.SelectedIndex == 0) tmp.PriorityClass = ProcessPriorityClass.High;
                                    if (combo_prio.SelectedIndex == 1) tmp.PriorityClass = ProcessPriorityClass.AboveNormal;
                                    if (combo_prio.SelectedIndex == 2) tmp.PriorityClass = ProcessPriorityClass.Normal;
                                    if (combo_prio.SelectedIndex == 3) tmp.PriorityClass = ProcessPriorityClass.BelowNormal;
                                    if (combo_prio.SelectedIndex == 4) tmp.PriorityClass = ProcessPriorityClass.Idle;
                                    Process[] localByName = Process.GetProcessesByName("FFBatch");
                                    if (localByName.Length == 1)
                                    {
                                        foreach (Process proc1 in localByName)
                                        {
                                            if (combo_prio.SelectedIndex >= 2) proc1.PriorityClass = ProcessPriorityClass.Normal;
                                            else proc1.PriorityClass = tmp.PriorityClass;
                                        }
                                    }
                                }
                                catch { }
                            }
                        }));
                    }
                    else
                    {
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        timer2.Stop();
                        timer_tasks.Stop();
                        this.InvokeEx(f => f.Pg1.Value = Pg1.Maximum);
                        this.InvokeEx(f => f.Pg1.Text = "100%");
                        this.InvokeEx(f => f.Pg1.Refresh());
                        working = false;
                        m3u_running = false;
                        Enable_Controls();
                        cancelados_paralelos = false;
                        return;
                    }

                    // this.InvokeEx(f => validate_duration = tmp_row.Cells[3].Value.ToString());
                    Boolean valid_prog2 = false;
                    TimeSpan time3;
                    if (TimeSpan.TryParse(tmp_row.Cells[3].Value.ToString(), out time3))
                    {
                        if (TimeSpan.Parse(tmp_row.Cells[3].Value.ToString()).TotalSeconds > 0)
                        {
                            valid_prog2 = true;
                        }
                    }
                    else
                    {
                        valid_prog2 = false;
                    }

                    String err_txt = "";
                    Double interval = 0;
                    Double sec_prog = 0;

                    //REVIEW
                    multi_logs["log_n_" + tmp_row.Index.ToString()] = Properties.Strings2.logging_f + " " + tmp_row.Cells[4].Value.ToString() + Environment.NewLine;

                    if (file.ToLower().Contains("m3u"))
                    {
                        while (!tmp.StandardError.EndOfStream)
                        {
                            err_txt = tmp.StandardError.ReadLine();
                            multi_logs["log_n_" + tmp_row.Index.ToString()] = multi_logs["log_n_" + tmp_row.Index.ToString()] + Environment.NewLine + n_logs + err_txt;

                            if (err_txt.Contains("time=") && err_txt.Contains("time=-") == false)
                            {
                                if (valid_prog2 == true)
                                {
                                    this.InvokeEx(f => durat_n = row_duration);
                                    int start_time_index = err_txt.IndexOf("time=") + 5;
                                    sec_prog = TimeSpan.Parse(err_txt.Substring(start_time_index, 8)).TotalSeconds;
                                    Double percent = (sec_prog * 100 / durat_n);

                                    total_prog = total_prog + (sec_prog - interval);
                                    interval = sec_prog;
                                    int percent2 = Convert.ToInt32(percent);

                                    if (percent2 <= 100)
                                    {
                                        this.InvokeEx(f => f.dg1.Rows[tmp_row.Index].Cells[5].Value = percent2.ToString() + "%");

                                        if (show_total_prog_m == true)
                                        {
                                            Double dg_multi_prog = 0;
                                            foreach (DataGridViewRow row_p in dg1.Rows)
                                            {
                                                try
                                                {
                                                    if (row_p.Cells[5].Value.ToString().Contains("%") == true)
                                                    {
                                                        this.InvokeEx(f => dg_multi_prog = dg_multi_prog + Convert.ToDouble(row_p.Cells[5].Value.ToString().Replace("%", "")));
                                                    }

                                                    if (row_p.Cells[5].Value.ToString() == FFBatch.Properties.Strings.success || row_p.Cells[5].Value.ToString() == FFBatch.Properties.Strings.failed || row_p.Cells[5].Value.ToString() == FFBatch.Properties.Strings.aborted)
                                                    {
                                                        this.InvokeEx(f => dg_multi_prog = dg_multi_prog + 100);
                                                    }
                                                }
                                                catch { }
                                            }

                                            this.InvokeEx(f => f.Pg1.Value = Convert.ToInt32(dg_multi_prog));
                                            if (Math.Round(dg_multi_prog / dg1.Rows.Count, 1).ToString().Contains(".") || Math.Round(dg_multi_prog / dg1.Rows.Count, 1).ToString().Contains(","))
                                            {
                                                this.InvokeEx(f => f.Pg1.Text = Math.Round(dg_multi_prog / dg1.Rows.Count, 1).ToString() + "%");
                                            }
                                            else
                                            {
                                                this.InvokeEx(f => f.Pg1.Text = Math.Round(dg_multi_prog / dg1.Rows.Count, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0" + "%");
                                            }

                                            this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, dg_multi_prog, Pg1.Maximum));

                                            //this.InvokeEx(f => pg_lv.Value = Convert.ToInt16(percent2));
                                            if (Math.Round(percent, 1).ToString().Contains(".") || Math.Round(percent, 1).ToString().Contains(","))
                                            {
                                                this.InvokeEx(f => f.dg1.Rows[tmp_row.Index].Cells[5].Value = Math.Round(percent, 1).ToString() + "%");
                                            }
                                            if (cancelados_paralelos != true)
                                            {
                                                //this.InvokeEx(f => pg_lv.Refresh());
                                            }
                                            else
                                            {
                                                //this.InvokeEx(f => pg_lv.Visible = false);
                                            }
                                        }
                                    }
                                }
                            }
                        } // while
                    }
                    else
                    {
                        if (has_lives_multi == false)
                        {
                            //this.InvokeEx(f => pg_lv.Maximum = 100);
                            while (!tmp.StandardOutput.EndOfStream)
                            {
                                err_txt = tmp.StandardOutput.ReadLine();
                                multi_logs["log_n_" + tmp_row.Index.ToString()] = multi_logs["log_n_" + tmp_row.Index.ToString()] + Environment.NewLine + n_logs + err_txt;

                                if (err_txt.Contains("%"))
                                {
                                    Double prog_y = Double.Parse(err_txt.Substring(err_txt.IndexOf("%") - 4, 4));
                                    prog_y = prog_y / 10;
                                    int progress = Convert.ToInt32(prog_y);

                                    this.InvokeEx(f => f.dg1.Rows[tmp_row.Index].Cells[5].Value = progress.ToString() + "%");
                                    //this.InvokeEx(f => pg_lv.Refresh());
                                }
                            }
                        }
                    }

                    er.Clear();
                    msg_er = String.Empty;

                    multi_logs["log_n_" + tmp_row.Index.ToString()] = multi_logs["log_n_" + tmp_row.Index.ToString()] + Environment.NewLine;

                    while (!tmp.StandardError.EndOfStream)
                    {
                        er.Add(tmp.StandardError.ReadLine().Replace("yt-dlp.exe:", ""));
                    }

                    if (er.Count > 0)
                    {
                        try
                        {
                            foreach (String st in er)
                            {
                                if (st == null) continue;
                                if (st.ToLower().Contains("usage: youtube-dl") == false)
                                {
                                    msg_er = msg_er + st;
                                    multi_logs["log_n_" + tmp_row.Index.ToString()] = multi_logs["log_n_" + tmp_row.Index.ToString()] + n_logs + msg_er;
                                }
                            }
                        }
                        catch { }
                    }

                    tmp.WaitForExit();
                    multi_logs["log_n_" + tmp_row.Index.ToString()] = multi_logs["log_n_" + tmp_row.Index.ToString()] + Environment.NewLine;
                    multi_logs["log_n_" + tmp_row.Index.ToString()] = multi_logs["log_n_" + tmp_row.Index.ToString()] + "Exit code: " + tmp.ExitCode.ToString();
                    multi_logs["log_n_" + tmp_row.Index.ToString()] = multi_logs["log_n_" + tmp_row.Index.ToString()] + Environment.NewLine;
                    multi_logs["log_n_" + tmp_row.Index.ToString()] = multi_logs["log_n_" + tmp_row.Index.ToString()] + Environment.NewLine + "--------End of " + dg1.Rows[tmp_row.Index].Cells[4].Value.ToString() + " log--------" + Environment.NewLine;
                    tmp.StartInfo.Arguments = String.Empty;

                    if (tmp.ExitCode == 0)
                    {
                        if (aborted_url == false)
                        {
                            this.InvokeEx(f => f.dg1.Rows[tmp_row.Index].Cells[5].Value = FFBatch.Properties.Strings.success);
                        }
                        else
                        {
                            this.InvokeEx(f => f.dg1.Rows[tmp_row.Index].Cells[5].Value = FFBatch.Properties.Strings.aborted);

                            if (cancelados_paralelos == false)
                            {
                                aborted_url = false;
                            }
                        }
                    }
                    else
                    {
                        this.InvokeEx(f => f.dg1.Rows[tmp_row.Index].Cells[5].Value = FFBatch.Properties.Strings.failed);
                        this.InvokeEx(f => f.dg1.Rows[tmp_row.Index].Cells[5].Style.BackColor = Color.PaleGoldenrod);
                    }

                    file_int++;
                    //End loop
                });
            }
            catch (Exception exc)
            {
                fatal_parallel_msg = exc.Message;
                fatal_parallel = true;
            }
            if (result.IsCompleted == true) fatal_parallel = false;
            else
            {
                if (cts.IsCancellationRequested == false) fatal_parallel = true;
                else fatal_parallel = false;
            }
            if (no_save_logs == false && quit == false && has_lives_multi == false)
            {
                String[] array_err = list_lines.ToArray();

                String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                if (is_portable == true) path = port_path + "ff_batch_portable.log";

                try
                {
                    System.IO.StreamWriter SaveFile = new System.IO.StreamWriter(path);
                    SaveFile.WriteLine("Multiple downloads log sesion: " + System.DateTime.Now);
                    SaveFile.WriteLine("-----------------------------------------------------");
                    SaveFile.Write(string.Join(Environment.NewLine, multi_logs.Select(a => $"{a.Value}")));
                    if (er.Count > 0) SaveFile.WriteLine(msg_er);
                    SaveFile.Close();

                    File.AppendAllText(path, "--------------------------");
                    File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.end_log);
                    File.AppendAllText(path, Environment.NewLine);
                    System.IO.FileInfo fileInfo = new System.IO.FileInfo(path);

                    var bytes = fileInfo.Length;

                    var kilobytes = (double)bytes / 1024;
                    var megabytes = kilobytes / 1024;
                    var gigabytes = megabytes / 1024;

                    //Format size view
                    String size = "";
                    String separator = ".";

                    if (bytes > 1000000000)
                    {
                        if (gigabytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }

                        String gigas = gigabytes.ToString();
                        if (gigas.Length >= 5)
                        {
                            gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                            size = (gigas + " " + "GB");
                        }
                        else
                        {
                            size = (gigas + " " + "GB");
                        }
                    }

                    if (bytes >= 1048576 && bytes <= 1000000000)
                    {
                        if (megabytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }
                        String megas = megabytes.ToString();
                        if (megas.Length > 5)
                        {
                            megas = megas.Substring(0, megas.LastIndexOf(separator));
                            size = (megas + " " + "MB");
                        }
                        else
                        {
                            size = (megas + " " + "MB");
                        }
                    }

                    if (bytes >= 1024 && bytes < 1048576)

                    {
                        if (kilobytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }

                        String kbs = kilobytes.ToString();
                        if (kbs.Length >= 5)
                        {
                            kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                            size = (kbs + " " + "KB");
                        }
                        else
                        {
                            size = (kbs + " " + "KB");
                        }
                    }
                    if (bytes > -1 && bytes < 1024)
                    {
                        String bits = bytes.ToString();
                        size = (bits + " Bytes");
                    }

                    //End Format size view
                    File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.log_size + " " + size);
                }
                catch { }

                //End save log
            }
        }

        private void BG_Multi_Down_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
            timer_tasks.Stop();
            timer2.Stop();
            working = false;
            m3u_running = false;
            this.InvokeEx(f => f.Pg1.Value = Pg1.Maximum);
            this.InvokeEx(f => f.Pg1.Text = "100%");
            Pg1.Style = ProgressBarStyle.Continuous;
            pic_recording.Visible = false;

            clean_ffb_test();

            foreach (DataGridViewRow row1 in dg1.Rows)
            {
                this.InvokeEx(f => row1.ReadOnly = false);
            }

            // foreach (DataGridViewRow row in dg1.Rows)
            //   {
            //     if (row.Cells[5].Value.ToString() == "Stopping") row.Cells[5].Value = FFBatch.Properties.Strings.failed;
            //  }

            int faileds = 0;
            this.InvokeEx(f => toolT002.RemoveAll());
            if (errors_enc == 0)
            {
                foreach (DataGridViewRow row in dg1.Rows)
                {
                    if (row.Cells[5].Value.ToString().Contains(FFBatch.Properties.Strings.failed)) faileds++;
                }

                if (faileds == 0) pic_no_errors.Visible = true;
                else
                {
                    pic_no_errors.Visible = false;
                    pic_recording.Visible = false;
                    toolT002.SetToolTip(this.pic_warnings, FFBatch.Properties.Strings.there_w + " " + faileds.ToString() + " " + FFBatch.Properties.Strings.errors_se);
                    pic_warnings.Visible = true;
                }
            }
            else
            {
                pic_no_errors.Visible = false;
                pic_recording.Visible = false;
                toolT002.SetToolTip(this.pic_warnings, FFBatch.Properties.Strings.there_w + " " + errors_enc.ToString() + " " + FFBatch.Properties.Strings.errors_se);
                pic_warnings.Visible = true;
            }

            //Automatic shutdown
            if (chkshut.Checked && cancelados_paralelos == false)
            {
                auto_shut();
                return;
            }

            //End automatic shutdown
            else
            {
                //cancel queue REVIEW
                if (cancelados_paralelos == true)
                {
                    foreach (DataGridViewRow row1 in dg1.Rows)
                    {
                        this.InvokeEx(f => row1.ReadOnly = false);
                    }
                    Enable_Controls();
                    foreach (DataGridViewRow row1 in dg1.Rows)
                    {
                        this.InvokeEx(f => row1.ReadOnly = false);
                    }

                    this.InvokeEx(f => this.Cursor = Cursors.Arrow);

                    this.InvokeEx(f => f.ct_paste_m3u.Enabled = true);
                    this.InvokeEx(f => f.ct_del_m3u.Enabled = true);
                    this.InvokeEx(f => f.ct_show_urls.Enabled = true);
                    this.InvokeEx(f => f.ct_validate_url.Enabled = true);
                    this.InvokeEx(f => f.ct_play_vlc.Enabled = true);
                    this.InvokeEx(f => f.ctm_stop_url.Enabled = false);
                    if (aborted == true)
                    {
                        aborted = false;
                        if (has_lives_multi == false) MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.task_abort, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                        else MessageBox.Show(FFBatch.Properties.Strings.live_end, FFBatch.Properties.Strings.task_abort, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                    return;
                }

                //End cancel queue

                Enable_Controls();
                foreach (DataGridViewRow row1 in dg1.Rows)
                {
                    this.InvokeEx(f => row1.ReadOnly = false);
                }

                this.InvokeEx(f => this.Cursor = Cursors.Arrow);

                this.InvokeEx(f => f.ct_paste_m3u.Enabled = true);
                this.InvokeEx(f => f.ct_del_m3u.Enabled = true);
                this.InvokeEx(f => f.ct_show_urls.Enabled = true);
                this.InvokeEx(f => f.ct_validate_url.Enabled = true);
                this.InvokeEx(f => f.ct_play_vlc.Enabled = true);
                this.InvokeEx(f => f.ctm_stop_url.Enabled = false);

                notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.url_comp;
                notifyIcon1.BalloonTipIcon = ToolTipIcon.Info;
                notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.url_comp2;
                notifyIcon1.ShowBalloonTip(0);

                if (play_on_end == true) play_end();

                if (chk_open_compl.Checked == true)
                {
                    String destino2 = txt_path_m3u.Text;
                    if (Directory.GetFiles(destino2).Length != 0)
                    {
                        Process open_processed = new Process();
                        open_processed.StartInfo.FileName = "explorer.exe";
                        open_processed.StartInfo.Arguments = '\u0022' + destino2 + '\u0022';
                        open_processed.Start();
                    }
                }
            }

            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
            timer2.Stop();
            timer_tasks.Stop();
            this.InvokeEx(f => f.Pg1.Value = Pg1.Maximum);
            this.InvokeEx(f => f.Pg1.Text = "100%");
            this.InvokeEx(f => f.Pg1.Refresh());
            working = false;
            m3u_running = false;
            Enable_Controls();
            if (aborted == true && fatal_parallel == false)
            {
                aborted = false;
                if (has_lives_multi == false) MessageBox.Show(FFBatch.Properties.Strings.url_ab, FFBatch.Properties.Strings.task_abort, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
            }
            cancelados_paralelos = false;
        }

        private void dg1_CellBeginEdit(object sender, DataGridViewCellCancelEventArgs e)
        {
            String cell = dg1.Rows[e.RowIndex].Cells[1].Value.ToString().ToLower();

            if (e.ColumnIndex == 3)
            {
                if (cell.Contains("youtu.be") || cell.Contains("youtube.com"))
                {
                    DateTime outTime;
                    Boolean time_ok = DateTime.TryParse(dg1.Rows[e.RowIndex].Cells[3].Value.ToString(), out outTime);

                    if (time_ok == true)
                    {
                        if (outTime.Second != 0) e.Cancel = true;
                    }
                    else e.Cancel = true;
                }
            }
        }

        private void listView1_DrawColumnHeader(object sender, DrawListViewColumnHeaderEventArgs e)
        {
            e.DrawDefault = true;
        }

        private void listView1_DrawSubItem(object sender, DrawListViewSubItemEventArgs e)
        {
            int prog = 0;

            if (e.SubItem.Text.Contains("%") && e.ColumnIndex == 5)
            {
                try
                {
                    prog = int.Parse(e.SubItem.Text.Replace("%", "").Replace(",", "").Replace(".", ""));
                }
                catch { prog = 0; }
                if (e.SubItem.Text.Contains(",") || e.SubItem.Text.Contains(".")) prog = prog / 10;
                if (prog < 0) prog = 0;
                Rectangle rect = new Rectangle();
                rect.X = e.Bounds.X + 1;
                rect.Y = e.Bounds.Y;
                rect.Width = e.Bounds.Width * prog / 100;
                rect.Height = e.Bounds.Height - 2;

                Rectangle newRect = new Rectangle(e.Bounds.X + 1,
            e.Bounds.Y, e.Bounds.Width - 2,
            e.Bounds.Height - 2);
                using (
           Brush gridBrush = new SolidBrush(Color.LightGray),
           backColorBrush = new SolidBrush(Color.White))
                {
                    using (Pen gridLinePen = new Pen(gridBrush))
                    { // Erase the subitem.
                        e.Graphics.FillRectangle(backColorBrush, e.Bounds);
                    }
                }

                if (e.ColumnIndex == 5)
                {
                    e.DrawDefault = false;
                    e.DrawBackground();
                    e.Graphics.DrawImage(img_prog.Image, rect);
                    e.Graphics.DrawRectangle(Pens.LightGray, newRect);
                    e.Graphics.DrawString(e.SubItem.Text, e.SubItem.Font, new SolidBrush(e.SubItem.ForeColor), e.SubItem.Bounds.Location.X + (e.Bounds.Width / 2) - e.SubItem.Text.Length * 3, e.SubItem.Bounds.Location.Y + 1);
                }
                else e.DrawDefault = true;
            }
            else
            {
                if (e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.success) || e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.replaced) || e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.recycled) || e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.deleted) || e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.skipped) || e.Item.SubItems[5].Text.Contains("OK & Run"))
                {
                    Rectangle rect = new Rectangle();
                    rect.X = e.Bounds.X + e.Bounds.Width - 18;
                    rect.Y = e.Bounds.Y;
                    rect.Width = 16;
                    rect.Height = 16;

                    if (e.ColumnIndex == 5)
                    {
                        e.DrawDefault = false;
                        e.DrawBackground();
                        if (e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.success))
                        {
                            e.Graphics.DrawImage(pic_success.Image, rect);
                            e.Graphics.DrawString(e.SubItem.Text, e.SubItem.Font, new SolidBrush(e.SubItem.ForeColor), e.SubItem.Bounds.Location.X + (e.SubItem.Bounds.Width / 2) - (e.SubItem.Text.Length * 3), e.SubItem.Bounds.Location.Y + 1);
                        }
                        if (e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.replaced) || e.Item.SubItems[5].Text.Contains("OK & Run"))
                        {
                            e.Graphics.DrawImage(pic_doble_check.Image, rect);
                            e.Graphics.DrawString(e.SubItem.Text, e.SubItem.Font, new SolidBrush(e.SubItem.ForeColor), e.SubItem.Bounds.Location.X + (e.SubItem.Bounds.Width / 2) - (e.SubItem.Text.Length * 3), e.SubItem.Bounds.Location.Y + 1);
                        }
                        if (e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.recycled))
                        {
                            e.Graphics.DrawImage(pic_ok_recycle.Image, rect);
                            e.Graphics.DrawString(e.SubItem.Text, e.SubItem.Font, new SolidBrush(e.SubItem.ForeColor), e.SubItem.Bounds.Location.X + (e.SubItem.Bounds.Width / 2) - (e.SubItem.Text.Length * 3), e.SubItem.Bounds.Location.Y + 1);
                        }
                        if (e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.deleted))
                        {
                            e.Graphics.DrawImage(pic_ok_deleted.Image, rect);
                            e.Graphics.DrawString(e.SubItem.Text, e.SubItem.Font, new SolidBrush(e.SubItem.ForeColor), e.SubItem.Bounds.Location.X + (e.SubItem.Bounds.Width / 2) - (e.SubItem.Text.Length * 3), e.SubItem.Bounds.Location.Y + 1);
                        }
                        if (e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.skipped))
                        {
                            e.Graphics.DrawImage(pic_skip.Image, rect);
                            e.Graphics.DrawString(e.SubItem.Text, e.SubItem.Font, new SolidBrush(e.SubItem.ForeColor), e.SubItem.Bounds.Location.X + (e.SubItem.Bounds.Width / 2) - (e.SubItem.Text.Length * 3), e.SubItem.Bounds.Location.Y + 1);
                        }
                    }
                    else e.DrawDefault = true;
                }
                else
                {
                    if (e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.aborted) || e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.failed) || e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.error))
                    {
                        Rectangle rect = new Rectangle();
                        rect.X = e.Item.SubItems[5].Bounds.X + e.Bounds.Width - 18;
                        rect.Y = e.Item.SubItems[5].Bounds.Y + 1;
                        rect.Width = 14;
                        rect.Height = 14;

                        if (e.ColumnIndex == 5)
                        {
                            e.DrawDefault = false;
                            e.DrawBackground();
                            e.Graphics.DrawImage(pic_error.Image, rect);
                            e.Graphics.DrawString(e.SubItem.Text, e.SubItem.Font, new SolidBrush(e.SubItem.ForeColor), e.SubItem.Bounds.Location.X + (e.SubItem.Bounds.Width / 2) - (e.SubItem.Text.Length * 3), e.SubItem.Bounds.Location.Y + 1);
                        }
                        else e.DrawDefault = true;
                    }
                    else
                    {
                        if (e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.renamed) || e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.not_replaced) || e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.recycled) || e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.not_recycled) || e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.not_deleted) || e.Item.SubItems[5].Text.Contains("OK & Error"))
                        {
                            Rectangle rect_r = new Rectangle();
                            rect_r.X = e.Item.SubItems[5].Bounds.X + e.Bounds.Width - 18;
                            rect_r.Y = e.Item.SubItems[5].Bounds.Y + 1;
                            rect_r.Width = 14;
                            rect_r.Height = 14;

                            if (e.ColumnIndex == 5)
                            {
                                e.DrawDefault = false;
                                e.DrawBackground();
                                e.Graphics.DrawImage(pic_excl.Image, rect_r);
                                if (e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.not_replaced) || e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.not_recycled) || e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.not_deleted) || e.Item.SubItems[5].Text.Contains("OK & Error"))
                                {
                                    e.Graphics.DrawString(e.SubItem.Text, e.SubItem.Font, new SolidBrush(e.SubItem.ForeColor), e.SubItem.Bounds.Location.X + (e.SubItem.Bounds.Width / 2) - (e.SubItem.Text.Length * 3), e.SubItem.Bounds.Location.Y + 1);
                                }
                                if (e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.renamed))
                                {
                                    e.Graphics.DrawString(e.SubItem.Text, e.SubItem.Font, new SolidBrush(e.SubItem.ForeColor), e.SubItem.Bounds.Location.X + (e.SubItem.Bounds.Width / 2) - (e.SubItem.Text.Length * 3), e.SubItem.Bounds.Location.Y + 1);
                                }
                            }
                            else e.DrawDefault = true;
                        }
                        else
                        {
                            if (e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.queued))
                            {
                                if (e.ColumnIndex == 5)
                                {
                                    e.DrawDefault = false;
                                    e.DrawBackground();
                                    e.Graphics.DrawString(e.SubItem.Text, e.SubItem.Font, new SolidBrush(e.SubItem.ForeColor), e.SubItem.Bounds.Location.X + (e.SubItem.Bounds.Width / 2) - (e.SubItem.Text.Length * 3), e.SubItem.Bounds.Location.Y + 1);
                                }
                                else e.DrawDefault = true;
                            }
                            else
                            {
                                if (e.Item.SubItems[5].Text.Contains(FFBatch.Properties.Strings.processing))
                                {
                                    if (e.ColumnIndex == 5)
                                    {
                                        e.DrawDefault = false;
                                        e.DrawBackground();
                                        e.Graphics.DrawString(e.SubItem.Text, e.SubItem.Font, new SolidBrush(e.SubItem.ForeColor), e.SubItem.Bounds.Location.X + (e.SubItem.Bounds.Width / 2) - (e.SubItem.Text.Length * 3), e.SubItem.Bounds.Location.Y + 1);
                                    }
                                    else e.DrawDefault = true;
                                }
                                else
                                {
                                    e.DrawDefault = true;
                                }
                            }
                        }
                    }
                }
            }
        }

        private void dg1_CellPainting(object sender, DataGridViewCellPaintingEventArgs e)
        {
            if (e.ColumnIndex == 5 && e.RowIndex > -1)
            {
                Image img = pic_ok.Image;
                Rectangle rect = new Rectangle();

                if (e.Value.ToString().Contains("%"))
                {
                    Decimal dec_prog = Convert.ToDecimal(dg1.Rows[e.RowIndex].Cells[5].Value.ToString().Replace("%", ""));
                    int prog = (int)(dec_prog);

                    rect = new Rectangle(e.CellBounds.X + 1, e.CellBounds.Y + 1, e.CellBounds.Width * prog / 100,
                    e.CellBounds.Height - 2);
                    img = img_prog.Image;
                }
                if (e.Value.ToString().Contains(FFBatch.Properties.Strings.success))
                {
                    rect = new Rectangle(e.CellBounds.X + e.CellBounds.Width - 19, e.CellBounds.Y + e.CellBounds.Height / 2 - 8, 16, 16);
                    img = pic_ok.Image;
                }
                if (e.Value.ToString().Contains(FFBatch.Properties.Strings.failed) || e.Value.ToString().Contains(FFBatch.Properties.Strings.error) || e.Value.ToString().Contains(FFBatch.Properties.Strings.aborting) || e.Value.ToString().Contains(FFBatch.Properties.Strings.aborted))
                {
                    rect = new Rectangle(e.CellBounds.X + e.CellBounds.Width - 19, e.CellBounds.Y + e.CellBounds.Height / 2 - 8, 16, 16);
                    img = pic_error.Image;
                }
                if (e.Value.ToString().Contains(FFBatch.Properties.Strings.recording1))
                {
                    rect = new Rectangle(e.CellBounds.X + e.CellBounds.Width - 16, e.CellBounds.Y + e.CellBounds.Height / 2 - 5, 12, 12);
                    img = pic_rec_cell.Image;
                }

                using (Brush gridBrush = new SolidBrush(this.dg1.GridColor), backColorBrush = new SolidBrush(e.CellStyle.BackColor))
                {
                    using (Pen gridLinePen = new Pen(gridBrush))
                    {
                        // Erase the cell.
                        e.Graphics.FillRectangle(backColorBrush, e.CellBounds);

                        // Draw the grid lines (only the right and bottom lines;
                        // DataGridView takes care of the others).
                        e.Graphics.DrawLine(gridLinePen, e.CellBounds.Left,
                            e.CellBounds.Bottom - 1, e.CellBounds.Right - 1,
                            e.CellBounds.Bottom - 1);
                        e.Graphics.DrawLine(gridLinePen, e.CellBounds.Right - 1,
                            e.CellBounds.Top, e.CellBounds.Right - 1,
                            e.CellBounds.Bottom);
                    }
                }
                e.Graphics.DrawImage(img, rect);
                e.PaintContent(e.ClipBounds);
                e.Handled = true;
            }
        }

        private void listView3_DrawColumnHeader(object sender, DrawListViewColumnHeaderEventArgs e)
        {
            e.DrawDefault = true;
        }

        private void listView3_DrawSubItem(object sender, DrawListViewSubItemEventArgs e)
        {
            int prog = 0;
            if (e.SubItem.Text.Contains("%"))
            {
                prog = int.Parse(e.SubItem.Text.Replace("%", "").Replace(",", "").Replace(".", ""));
                if (e.SubItem.Text.Contains(",") || e.SubItem.Text.Contains(".")) prog = prog / 10;
                if (prog < 0) prog = 0;
                Rectangle rect = new Rectangle();
                rect.X = e.Bounds.X;
                rect.Y = e.Bounds.Y;
                rect.Width = e.Bounds.Width * prog / 100;
                rect.Height = e.Bounds.Height;

                Rectangle newRect = new Rectangle(e.Bounds.X + 1,
            e.Bounds.Y, e.Bounds.Width - 2,
            e.Bounds.Height - 2);
                using (
           Brush gridBrush = new SolidBrush(Color.LightGray),
           backColorBrush = new SolidBrush(Color.White))
                {
                    using (Pen gridLinePen = new Pen(gridBrush))
                    { // Erase the subitem.
                        e.Graphics.FillRectangle(backColorBrush, e.Bounds);
                    }
                }
                e.DrawDefault = false;
                e.DrawBackground();
                e.Graphics.DrawRectangle(Pens.LightGray, newRect);
                e.Graphics.DrawImage(img_prog.Image, rect);
                e.Graphics.DrawString(e.SubItem.Text, e.SubItem.Font, new SolidBrush(e.SubItem.ForeColor), e.SubItem.Bounds.Location.X + (e.Bounds.Width / 2) - e.SubItem.Text.Length * 3, e.SubItem.Bounds.Location.Y + 1);
            }
            else
            {
                if (e.SubItem.Text.Contains(FFBatch.Properties.Strings.success))
                {
                    Rectangle rect = new Rectangle();
                    rect.X = e.Bounds.X + e.Bounds.Width - 18;
                    rect.Y = e.Bounds.Y;
                    rect.Width = 16;
                    rect.Height = 16;
                    e.DrawDefault = false;
                    e.DrawBackground();
                    e.Graphics.DrawImage(pic_success.Image, rect);
                    e.Graphics.DrawString(e.SubItem.Text, e.SubItem.Font, new SolidBrush(e.SubItem.ForeColor), e.SubItem.Bounds.Location.X + (e.Bounds.Width / 2) - e.SubItem.Text.Length * 3 - 2, e.SubItem.Bounds.Location.Y + 1);
                }
                else
                {
                    if (e.SubItem.Text.Contains(FFBatch.Properties.Strings.aborted) || e.SubItem.Text.Contains(FFBatch.Properties.Strings.error) || e.SubItem.Text.Contains("No Sub"))
                    {
                        Rectangle rect = new Rectangle();
                        rect.X = e.Bounds.X + e.Bounds.Width - 18;
                        rect.Y = e.Bounds.Y + 1;
                        rect.Width = 14;
                        rect.Height = 14;
                        e.DrawDefault = false;
                        e.DrawBackground();
                        e.Graphics.DrawImage(pic_error.Image, rect);
                        e.Graphics.DrawString(e.SubItem.Text, e.SubItem.Font, new SolidBrush(e.SubItem.ForeColor), e.SubItem.Bounds.Location.X + (e.Bounds.Width / 2) - e.SubItem.Text.Length * 3 - 2, e.SubItem.Bounds.Location.Y + 1);
                    }
                    else
                    {
                        if (e.SubItem.Text.Contains(FFBatch.Properties.Strings.queued) || e.SubItem.Text.Contains(FFBatch.Properties.Strings.processing))
                        {
                            e.DrawDefault = false;
                            e.DrawBackground();
                            e.Graphics.DrawString(e.SubItem.Text, e.SubItem.Font, new SolidBrush(e.SubItem.ForeColor), e.SubItem.Bounds.Location.X + (e.Bounds.Width / 2) - e.SubItem.Text.Length * 3 - 2, e.SubItem.Bounds.Location.Y + 1);
                        }
                        else
                        {
                            e.DrawDefault = true;
                        }
                    }
                }
            }
        }

        private void lbl_yl_name_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
        }

        private void BG_check_ytdl_DoWork(object sender, DoWorkEventArgs e)
        {
            t_out_yt = true;
            String ver = String.Empty;
            Process tmp = new Process();
            tmp.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe");

            tmp.StartInfo.Arguments = "--version";
            tmp.StartInfo.RedirectStandardOutput = true;
            tmp.StartInfo.UseShellExecute = false;
            tmp.StartInfo.CreateNoWindow = true;
            tmp.EnableRaisingEvents = true;

            try
            {
                tmp.Start();

                ver = tmp.StandardOutput.ReadToEnd().Trim();

                tmp.WaitForExit();
                t_out_yt = false;
                if (tmp.ExitCode != 0)
                {
                    this.InvokeEx(f => f.pic_wait_1.Visible = false);
                    this.InvokeEx(f => f.pic_no_yt.Visible = false);
                    check_VC();
                    return;
                }
            }
            catch { }

            try
            {
                WebClient client = new WebClientWithTimeout();
                String content = client.DownloadString(yl_latest);
                String[] lines = content.Split(new[] { "\r\n", "\r", "\n" }, StringSplitOptions.RemoveEmptyEntries);
                String latest_v = "";
                foreach (String line in lines)
                {
                    if (line.Contains("yt-dlp "))
                    {
                        latest_v = line.Substring(line.IndexOf("yt-dlp ", 11)).Replace("yt-dlp ", "");
                        latest_v = latest_v.Substring(0, 10);
                    }
                }

                Boolean found_ver = false;
                if (content.Contains(ver)) found_ver = true;
                else found_ver = false;

                this.InvokeEx(f => f.pic_wait_1.Visible = false);
                if (found_ver == true)
                {
                    this.InvokeEx(f => f.lbl_yl_name.Text = "yt-dlp" + " " + Properties.Strings2.version.ToLower() + " " + ver);

                    this.InvokeEx(f => f.btn_update_yt.Visible = false);
                    this.InvokeEx(f => f.pic_ok.Visible = true);

                    this.InvokeEx(f => f.pic_no_yt.Visible = false);
                }
                else
                {
                    this.InvokeEx(f => f.lbl_yl_name.Text = FFBatch.Properties.Strings.New + " " + "yt-dlp " + latest_v + " " + FFBatch.Properties.Strings.found);

                    this.InvokeEx(f => f.btn_update_yt.Visible = true);
                    this.InvokeEx(f => f.pic_ok.Visible = false);
                    this.InvokeEx(f => f.pic_no_yt.Visible = false);
                }
            }
            catch
            {
                this.InvokeEx(f => f.lbl_yl_name.Text = FFBatch.Properties.Strings.err_yt_u);
                this.InvokeEx(f => f.pic_no_yt.Visible = true);
                this.InvokeEx(f => f.pic_ok.Visible = false);
                this.InvokeEx(f => f.pic_wait_1.Visible = false);
            }
        }

        private void BG_Single_yt_DoWork(object sender, DoWorkEventArgs e)
        {
            Boolean one_ok = false;
            String path_pic = Path.Combine(Path.GetTempPath(), "FFBatch_test");

            dg1.Invoke(new MethodInvoker(delegate
            {
                dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.var_url;

                if (dg1.Rows[dg1.RowCount - 1].Cells[1].Value == null)
                {
                    dg1.Rows[dg1.RowCount - 1].Cells[5].Value = String.Empty;
                    dg1.Rows[dg1.RowCount - 1].Cells[4].Value = String.Empty;
                    dg1.Rows[dg1.RowCount - 1].Cells[3].Value = String.Empty;
                    dg1.Rows[dg1.RowCount - 1].Cells[2].Value = String.Empty;
                    //dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor;
                    return;
                }

                if (dg1.Rows[dg1.RowCount - 1].Cells[1].Value.ToString().Contains("http") == false)
                {
                    dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.error;

                    return;
                }
                dg1.Refresh();
                cell_zoom();
            }));

            Process probe = new Process();
            probe.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe");
            if (!File.Exists(System.IO.Path.Combine(Application.StartupPath, "yt-dlp.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.yt_not, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                release_datagrid();
                return;
            }
            probe.StartInfo.WorkingDirectory = Application.StartupPath;
            probe.StartInfo.Arguments = "--get-duration --get-title --get-thumbnail " + dg1.Rows[dg1.RowCount - 1].Cells[1].Value.ToString();
            probe.StartInfo.RedirectStandardOutput = true;
            probe.StartInfo.UseShellExecute = false;
            probe.StartInfo.CreateNoWindow = true;
            probe.EnableRaisingEvents = true;
            probe.Start();

            String filename = "";
            String out_thumb = "";
            String duracion = "";

            while (!probe.StandardOutput.EndOfStream)
            {
                filename = probe.StandardOutput.ReadLine();
                out_thumb = probe.StandardOutput.ReadLine();
                duracion = probe.StandardOutput.ReadLine();
            }

            PictureBox pic = new PictureBox();
            thumbs_count++;
            if (out_thumb.Contains("http"))
            {
                try
                {
                    if (out_thumb.Contains("?")) out_thumb = out_thumb.Substring(0, out_thumb.IndexOf("?"));

                    new System.Threading.Thread(() =>
                    {
                        System.Threading.Thread.CurrentThread.IsBackground = true;
                        try
                        {
                            if (out_thumb.ToLower().Contains("webp"))
                            {
                                WebClient client = new WebClient();
                                client.DownloadFile(out_thumb, path_pic + "\\" + "pic_ffb_" + thumbs_count.ToString() + ".webp");
                                client.Dispose();
                                Process pr = new Process();
                                pr.StartInfo.FileName = "ffmpeg.exe";
                                pr.StartInfo.UseShellExecute = false;
                                pr.StartInfo.CreateNoWindow = true; ;
                                pr.StartInfo.Arguments = "-i " + '\u0022' + path_pic + "\\" + "pic_ffb_" + thumbs_count.ToString() + ".webp" + '\u0022' + " -f image2 -y " + '\u0022' + path_pic + "\\" + "pic_ffb_" + thumbs_count.ToString() + ".bmp" + '\u0022';
                                pr.Start();
                                pr.WaitForExit(1000);
                                Image img;
                                using (var bmpTemp = new Bitmap(Path.Combine(path_pic, "pic_ffb_" + thumbs_count.ToString() + ".bmp")))
                                {
                                    img = new Bitmap(bmpTemp);
                                    pic.Image = img;
                                }
                            }
                            else pic.Load(out_thumb);

                            dg_thumbs[dg1.RowCount - 1] = pic.Image;
                            dg1.Invoke(new MethodInvoker(delegate
                            {
                                dg1.Rows[dg1.RowCount - 1].Cells[0].Value = pic.Image;
                                pic_frame.Image = pic.Image;
                                if (pic_frame.Image == null) pic_frame.Image = pic_frame.InitialImage;
                                lbl_a_th.Text = "-";
                                lbl_s_th.Text = "-";
                                lbl_v_th.Text = "-";
                                lbl_gb_th.Text = "-";
                            }));
                        }
                        catch
                        {
                            dg1.Rows[dg1.RowCount - 1].Cells[0].Value = pic_noimg.Image;
                        }
                    }).Start();
                }
                catch
                {
                    dg_thumbs[dg1.RowCount - 1] = pic_noimg.Image;
                }
            }
            else
            {
                dg_thumbs[dg1.RowCount - 1] = pic_noimg.Image;
            }
            //cell_stretch();

            probe.WaitForExit(10000);
            probe.StartInfo.Arguments = "";
            pic.Dispose();

            if (duracion == null || duracion == string.Empty)
            {
                dg1.Invoke(new MethodInvoker(delegate
                {
                    //dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = Color.LightGoldenrodYellow;
                    dg1.Rows[dg1.RowCount - 1].Cells[2].Value = "";
                    dg1.Rows[dg1.RowCount - 1].Cells[3].Value = "";
                    //dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor;
                    dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.error;
                    //this.InvokeEx(f => f.dg1.Rows[dg1.RowCount - 1].Cells[5].Style.BackColor = Color.LightGoldenrodYellow);
                }));
            }

            if (duracion != null && filename != "")
            {
                dg1.Invoke(new MethodInvoker(delegate
                {
                    if (duracion == "0")
                    {
                        dg1.Rows[dg1.RowCount - 1].Cells[2].Value = duracion;
                        dg1.Rows[dg1.RowCount - 1].Cells[3].Value = "Live";
                    }
                    else
                    {
                        if (duracion.Length < 6) duracion = "00:" + duracion;
                        dg1.Rows[dg1.RowCount - 1].Cells[2].Value = duracion;
                        dg1.Rows[dg1.RowCount - 1].Cells[3].Value = duracion;
                    }
                    dg1.Rows[dg1.RowCount - 1].Cells[4].Value = filename;
                    //dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor;
                    one_ok = true;
                    dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.ready;
                    this.InvokeEx(f => f.dg1.Rows[dg1.RowCount - 1].Cells[5].Style.BackColor = Color.LightGreen);
                }));
            }

            if (duracion == null && filename != "")
            {
                dg1.Invoke(new MethodInvoker(delegate
                {
                    dg1.Rows[dg1.RowCount - 1].Cells[2].Value = "0";
                    dg1.Rows[dg1.RowCount - 1].Cells[3].Value = "Live";

                    dg1.Rows[dg1.RowCount - 1].Cells[4].Value = filename;
                    //dg1.Rows[dg1.RowCount - 1].DefaultCellStyle.BackColor = dg1.DefaultCellStyle.BackColor;
                    one_ok = true;
                    dg1.Rows[dg1.RowCount - 1].Cells[5].Value = FFBatch.Properties.Strings.ready;
                    this.InvokeEx(f => f.dg1.Rows[dg1.RowCount - 1].Cells[5].Style.BackColor = Color.LightGreen);
                }));
            }

            if (dg1.RowCount > 1)
            {
                dg1.Invoke(new MethodInvoker(delegate
                {
                    dg1.ClearSelection();
                    dg1.Rows[dg1.RowCount - 1].Cells[1].Selected = true;
                    dg1.CurrentCell = dg1.Rows[dg1.RowCount - 1].Cells[1];
                }));
            }
            urls_duration();
            if (one_ok == true)
            {
                groupBox_m3u.Invoke(new MethodInvoker(delegate
                {
                    chk_m3u_params.Left = 14;
                    chk_output_server.Enabled = false;
                    chk_m3u_params.Text = FFBatch.Properties.Strings.yt_params;
                }));
            }
            release_datagrid();
        }

        private void btn_edit_presets_Click(object sender, EventArgs e)
        {
            Form15 frm_pr = new Form15();
            frm_pr.ShowDialog();
            if (frm_pr.saved == true) btn_load_config.PerformClick();
        }

        private void btn_del_preset_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            if (combo_presets.SelectedIndex == -1)
            {
                return;
            }
            if (combo_presets.SelectedIndex == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.def_rn, FFBatch.Properties.Strings.default_param, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }
            var a = MessageBox.Show(FFBatch.Properties.Strings.rem_pres, FFBatch.Properties.Strings.conf_act, MessageBoxButtons.YesNo, MessageBoxIcon.Question);
            if (a == DialogResult.Yes)
            {
                String path, path_pr = "";
                if (is_portable == false)
                {
                    path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.ini";
                    path_pr = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_presets.ini";
                }
                else
                {
                    path = port_path + "ff_batch_portable.ini";
                    path_pr = port_path + "ff_presets_portable.ini";
                }

                String path2 = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch2.txt";
                String path2_pr = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_presets2.txt";
                if (is_portable == true)
                {
                    path2 = port_path + "ff_batch2.txt";
                    path2_pr = port_path + "ff_presets2.txt";
                }
                if (is_portable == false)
                {
                    File.Create(System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch2.txt").Dispose();
                    File.Create(System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_presets2.txt").Dispose();
                }
                else
                {
                    File.Create(port_path + "ff_batch2.txt").Dispose();
                    File.Create(port_path + "ff_presets2.txt").Dispose();
                }

                if (File.Exists(path_pr))
                {
                    path = path_pr;
                    path2 = path2_pr;
                }

                int ind = 0;
                foreach (string line in File.ReadLines(path))
                {
                    ind = ind + 1;
                    String linea_sin = String.Empty;

                    if (!line.Contains("PR: "))
                    {
                        linea_sin = line + Environment.NewLine;
                        File.AppendAllText(path2, linea_sin);
                    }

                    if (line.LastIndexOf("&") >= 0)
                    {
                        if (line.Substring(4, line.LastIndexOf("&") - 5) != combo_presets.SelectedItem.ToString())
                        {
                            if (ind <= File.ReadLines(path).Count() - 1)
                            {
                                linea_sin = line + Environment.NewLine;
                                File.AppendAllText(path2, linea_sin);
                            }
                            else
                            {
                                File.AppendAllText(path2, line);
                            }
                        }
                    }
                }
                File.Delete(path);
                File.Copy(path2, path);
                File.Delete(path2);

                String path1 = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.ini";
                String path1_pr = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_presets.ini";
                if (is_portable == true)
                {
                    path1 = port_path + "ff_batch_portable.ini";
                    path1_pr = port_path + "ff_presets_portable.ini";
                }

                combo_presets.Items.Clear();
                combo_presets.Items.Add(FFBatch.Properties.Strings.default_param);
                int linea = 0;

                foreach (string line in File.ReadLines(path1))
                {
                    linea = linea + 1;

                    if (linea == 1)
                    {
                        txt_parameters.Text = line;
                    }

                    if (linea == 2)
                    {
                        txt_format.Text = line;
                    }

                    if (line == "Yes")

                    {
                        chk_open_compl.CheckState = CheckState.Checked;
                    }

                    if (line == "No")
                    {
                        chk_open_compl.CheckState = CheckState.Unchecked;
                    }

                    if (!File.Exists(path1_pr))
                    {
                        if (line.Contains("PR: "))
                        {
                            combo_presets.Items.Add(line.Substring(4, line.LastIndexOf("&") - 5));
                        }
                    }
                }
                if (File.Exists(path1_pr))
                {
                    foreach (string line in File.ReadLines(path_pr))
                    {
                        if (line.Length > 8)
                        {
                            if (line.Substring(0, 7).ToLower() == "version")
                            {
                                txt_config_ver.Text = line.Substring(8, line.Length - 8);
                                continue;
                            }
                        }

                        if (line.Contains("PR: "))
                        {
                            combo_presets.Items.Add(line.Substring(4, line.LastIndexOf("&") - 5));
                        }
                    }
                }

                combo_presets.SelectedIndex = 0;
            }
        }

        private void pic_warnings_Click(object sender, EventArgs e)
        {
            if (pic_warnings.Visible == true) btn_display_log.PerformClick();
        }

        private void btn_display_log_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            String path_log_file = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
            if (is_portable == true) path_log_file = port_path + "ff_batch_portable.log";
            if (!File.Exists(path_log_file))
            {
                if (no_save_logs == true) MessageBox.Show(FFBatch.Properties.Strings.no_log_f, FFBatch.Properties.Strings.file_not_f, MessageBoxButtons.OK, MessageBoxIcon.Error);
                else
                if (no_save_logs == false) MessageBox.Show(FFBatch.Properties.Strings.no_log1, FFBatch.Properties.Strings.file_not_f, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }
            long length = new System.IO.FileInfo(path_log_file).Length;
            if (length > 20000000)
            {
                var a = MessageBox.Show(FFBatch.Properties.Strings.log_siz + " " + (length / 1024).ToString() + " KB " + FFBatch.Properties.Strings.time_load, FFBatch.Properties.Strings.warning, MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                if (a == DialogResult.No) return;
            }

            //Form frm_output = new Form();
            frm_log.Name = FFBatch.Properties.Strings.last_log1;
            frm_log.Text = "FFmpeg Batch AV Converter";
            frm_log.Icon = this.Icon;

            frm_log.Height = 675;
            frm_log.Width = 977;
            frm_log.FormBorderStyle = FormBorderStyle.Fixed3D;
            frm_log.MaximizeBox = false;
            frm_log.MinimizeBox = false;

            var fuente_list = new System.Drawing.Font("Microsoft Sans Serif", 9, FontStyle.Regular);

            Rtxt.Parent = frm_log;
            Rtxt.Left = 20;
            Rtxt.Top = 65;
            Rtxt.Height = 525;
            Rtxt.Width = 920;
            Rtxt.Font = fuente_list;

            ContextMenu Rtxt_menu = new ContextMenu();
            Rtxt.ContextMenu = Rtxt_menu;
            MenuItem CopyItem = new MenuItem(FFBatch.Properties.Strings.copy);
            Rtxt_menu.MenuItems.Add(CopyItem);
            CopyItem.Click += new EventHandler(CopyAction);

            TextBox titulo = new TextBox();
            titulo.Parent = frm_log;
            titulo.Top = 15;
            titulo.Left = 20;
            titulo.Width = 921;
            titulo.TabIndex = 0;
            var fuente = new System.Drawing.Font("Microsoft Sans Serif", 11, FontStyle.Bold);

            titulo.Font = fuente;
            titulo.BorderStyle = BorderStyle.Fixed3D;
            titulo.TextAlign = HorizontalAlignment.Center;
            titulo.ReadOnly = true;

            titulo.Text = FFBatch.Properties.Strings.last_b_l;

            Button boton_ok_ff = new Button();
            boton_ok_ff.Parent = frm_log;
            boton_ok_ff.Left = 20;
            boton_ok_ff.Top = 595;
            boton_ok_ff.Width = 920;
            boton_ok_ff.Height = 27;
            boton_ok_ff.Text = FFBatch.Properties.Strings.last_b_l;
            boton_ok_ff.Click += new EventHandler(boton_ok_ff_Click);

            TextBox titulo2 = new TextBox();
            titulo2.Parent = frm_log;
            titulo2.Top = 42;
            titulo2.Left = 47;
            titulo2.Width = 867;

            var fuente2 = new System.Drawing.Font("Microsoft Sans Serif", 10, FontStyle.Regular);

            titulo2.Font = fuente2;
            titulo2.BorderStyle = BorderStyle.None;
            titulo2.TextAlign = HorizontalAlignment.Center;
            titulo2.ReadOnly = true;

            titulo2.Text = "ff_batch.log";
            if (is_portable == true) titulo2.Text = "ff_batch_portable.log";

            frm_log.StartPosition = FormStartPosition.CenterScreen;
            Rtxt.Text = File.ReadAllText(path_log_file);
            boton_ok_ff.Text = FFBatch.Properties.Strings.close_win;
            frm_log.ShowDialog();
            frm_log.Refresh();
        }

        private void btn_fix_pre_Click(object sender, EventArgs e)
        {
            btn_fix_pre.Enabled = false;
            String f_fix_pre = String.Empty;
            if (is_portable == false)
            {
                f_fix_pre = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_fix_pre.ini";
            }
            else
            {
                f_fix_pre = port_path + "ff_fix_pre_portable.ini";
            }

            if (txt_pre_input.Text.Length > 0)
            {
                File.WriteAllText(f_fix_pre, txt_pre_input.Text);
                fix_pre = true;
            }
            else
            {
                fix_pre = false;
                if (File.Exists(f_fix_pre))
                {
                    try
                    {
                        File.Delete(f_fix_pre);
                    }
                    catch
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.err_set);
                    }
                }
            }
        }

        private void add_video_mux_job()
        {
            Pg1.Focus();
            cancel_queue = false;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";

            foreach (ListViewItem file0 in list_tracks.Items)
            {
                if (!File.Exists(file0.Text))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file_not_found + " " + file0.Text, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }

            if (list_tracks.Items.Count == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.tracks_empty, FFBatch.Properties.Strings.no_files, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }

            Boolean video_track_in = false;
            foreach (ListViewItem tracks_item in list_tracks.Items)
            {
                if (tracks_item.SubItems[2].Text.Contains("Video"))
                {
                    video_track_in = true;
                }
            }

            if (video_track_in == false)
            {
                MessageBox.Show(FFBatch.Properties.Strings.vid_req, FFBatch.Properties.Strings.no_video2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            String is_overw = String.Empty;
            if (txt_path_main.Text.Contains(".\\"))
            {
                if (txt_path_main.Text == ".\\")
                {
                    is_overw = Path.GetDirectoryName(list_tracks.Items[0].Text) + "\\" + Path.GetFileNameWithoutExtension(list_tracks.Items[0].Text) + "." + combo_ext.SelectedItem.ToString();
                }
                else
                {
                    is_overw = Path.GetDirectoryName(list_tracks.Items[0].Text) + txt_path_main.Text.Replace(".", String.Empty) + "\\" + Path.GetFileNameWithoutExtension(list_tracks.Items[0].Text) + "." + combo_ext.SelectedItem.ToString();
                }
            }

            if (is_overw == list_tracks.Items[0].Text)
            {
                MessageBox.Show(FFBatch.Properties.Strings.overw_not2, FFBatch.Properties.Strings.overw_not_all, MessageBoxButtons.OK, MessageBoxIcon.Error);

                return;
            }

            DateTime time2;
            if (!DateTime.TryParse(ss_time_input.Text, out time2))
            {
                MessageBox.Show(FFBatch.Properties.Strings.pre_input4, FFBatch.Properties.Strings.pre_input2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            //Validated list, start processing
            //Pending duration

            if (dur_ok == false)
            {
                list_pending_dur.Items.Clear();
                foreach (ListViewItem item in listView1.Items)
                {
                    list_pending_dur.Items.Add((ListViewItem)item.Clone());
                }
                BG_Dur.RunWorkerAsync();
                return;
            }

            txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + "00h:00m:00s";
            time_n_tasks = 0;

            cancel_queue = false;
            Pg1.Value = 0;
            //pg_current.Value = 0;
            //textBox4.Text = "0%";
            ////textBox4.Visible = true;

            //Copy list of tracks for thread processing
            ListView list_proc = new ListView();
            foreach (ListViewItem item in list_tracks.Items)
            {
                list_proc.Items.Add((ListViewItem)item.Clone());
            }
            //End of copy list of tracks for thread processing

            Pg1.Maximum = list_proc.Items.Count;

            Double total_duration = 0;
            Double total_prog = 0;

            //Get specific track list video duration
            //Duration
            Boolean has_audio_for_image = false;
            Process probe = new Process();

            probe.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
            String ffprobe_frames = " " + '\u0022' + "--Inform=General;%Duration/String3%" + '\u0022';
            probe.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + list_proc.Items[1].Text + '\u0022';

            //if (list_proc.Items[0].BackColor == Color.LightYellow)
            //{
            //    foreach (ListViewItem item1 in list_proc.Items)
            //    {
            //        if (item1.SubItems[2].Text.Contains("Audio"))
            //        {
            //            has_audio_for_image = true;
            //        }
            //    }
            //    if (has_audio_for_image == false)
            //    {
            //        MessageBox.Show(FFBatch.Properties.Strings.no_audio3, FFBatch.Properties.Strings.mux_Err1, MessageBoxButtons.OK, MessageBoxIcon.Error);
            //        working = false;
            //        Enable_Controls();
            //        return;
            //    }
            //    else
            //    {
            //        probe.StartInfo.Arguments = "-v error -show_entries format=duration -sexagesimal -of default=noprint_wrappers=1:nokey=1 " + " -i " + '\u0022' + list_proc.Items[1].Text + '\u0022';
            //    }
            //}
            //else
            //{
            //    probe.StartInfo.Arguments = "-v error -show_entries format=duration -sexagesimal -of default=noprint_wrappers=1:nokey=1 " + " -i " + '\u0022' + list_proc.Items[0].Text + '\u0022';
            //}

            probe.StartInfo.RedirectStandardOutput = true;
            probe.StartInfo.UseShellExecute = false;
            probe.StartInfo.CreateNoWindow = true;
            probe.EnableRaisingEvents = true;
            probe.Start();

            String duracion = probe.StandardOutput.ReadLine();

            probe.WaitForExit();
            DateTime time;
            if (duracion != null)
            {
                TimeSpan time0;
                if (TimeSpan.TryParse(duracion, out time0))
                {
                    //if (!DateTime.TryParse(duracion, out time))
                    //{
                    //    String ff_dur = "";
                    //    Decimal ff_dur_dec = 0;

                    //    Process get_frames2 = new Process();
                    //    get_frames2.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
                    //    String ffprobe_frames = " " + '\u0022' + "--Inform=General;%Duration%" + '\u0022';
                    //    get_frames2.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + list_proc.Items[1].Text + '\u0022';
                    //    get_frames2.StartInfo.RedirectStandardOutput = true;
                    //    get_frames2.StartInfo.RedirectStandardError = true;
                    //    get_frames2.StartInfo.UseShellExecute = false;
                    //    get_frames2.StartInfo.CreateNoWindow = true;
                    //    get_frames2.EnableRaisingEvents = true;
                    //    get_frames2.Start();

                    //    ff_dur = get_frames2.StandardOutput.ReadLine();

                    //    get_frames2.WaitForExit();

                    //    if (get_frames2.ExitCode == 0)
                    //    {
                    //        if (ff_dur != null)
                    //        {
                    //            try
                    //            {
                    //                ff_dur_dec = decimal.Parse(ff_dur) / 1000;
                    //                durat_n = Convert.ToDouble(Math.Round(ff_dur_dec, 3));
                    //                TimeSpan t = TimeSpan.FromSeconds(durat_n);

                    //                duracion = string.Format("{0:D2}:{1:D2}:{2:D2}:{3:D3}",
                    //                                t.Hours,
                    //                                t.Minutes,
                    //                                t.Seconds,
                    //                                t.Milliseconds);

                    //            }
                    //            catch
                    //            {
                    //                duracion = "00:00:00.000";
                    //                total_duration = 0;
                    //            }

                    //        }
                    //        else
                    //        {
                    //            durat_n = 0;
                    //            total_duration = 0;
                    //        }
                    //    }
                    durat_n = TimeSpan.Parse(duracion).TotalSeconds;
                    total_duration = TimeSpan.Parse(duracion).TotalSeconds;
                }
                else
                {
                    total_duration = durat_n;
                }
            }
            else
            {
                duracion = "0";
                durat_n = 0;
                total_duration = 0;
            }
            //End duration

            //End

            Pg1.Minimum = 0;
            Pg1.Maximum = 100;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            lbl_speed.Text = String.Empty;
            lbl_elapsed.Text = FFBatch.Properties.Strings.time_elapsed + " " + "00h:00m:00s";

            List<string> list_lines = new List<string>();
            String mux_ext = combo_ext.Text;

            String hw_decode = String.Empty;
            if (cb_hwdecode.SelectedItem.ToString() != "none")
            {
                hw_decode = "-hwaccel " + cb_hwdecode.SelectedItem.ToString();
            }

            //Save selected hw decoder

            String path2 = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_hw_dcd.ini";
            String txt_hw_dcd = cb_hwdecode.SelectedItem.ToString();
            if (txt_hw_dcd != "none")
            {
                File.WriteAllText(path2, txt_hw_dcd);
            }
            else
            {
                if (File.Exists(path2)) File.Delete(path2);
            }

            //End save hw decoder

            String remain_time = "0";

            String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");

            String file = list_proc.Items[0].Text;
            String fullPath = file;
            String destino = "";

            if (txt_path_main.Text.Contains(".\\"))
            {
                destino = file.Substring(0, fullPath.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
            }
            else
            {
                destino = txt_path_main.Text;
            }

            if (!Directory.Exists(destino))
            {
                Directory.CreateDirectory(destino);
            }

            //Create joint inputs variable
            String inputs = String.Empty;
            foreach (ListViewItem input_item in list_proc.Items)
            {
                if (input_item.SubItems[2].Text.Contains("Subtitle") && !input_item.SubItems[2].Text.Contains("hdmv_pgs") && !input_item.SubItems[2].Text.Contains("dvd_subtitle"))
                {
                    inputs = inputs + " -sub_charenc UTF-8" + " -i " + '\u0022' + input_item.Text + '\u0022';
                }
                else
                {
                    if (input_item.BackColor != Color.LightYellow)
                    {
                        inputs = inputs + " -i " + '\u0022' + input_item.Text + '\u0022';
                    }
                    else
                    {
                        String ext_image = Path.GetExtension(list_proc.Items[0].Text);

                        //Attempt to extract frame as image
                        Process proc_img = new System.Diagnostics.Process();
                        String ffm_img = Path.Combine(Application.StartupPath, "ffmpeg.exe");

                        String file_img = Path.GetFullPath(list_proc.Items[0].Text);
                        String fullPath_img = file_img;
                        String AppParam_img = "";

                        if (ext_image != ".jpg" && ext_image != ".jpeg" && ext_image != ".png" && ext_image != ".gif" && ext_image != ".bmp" && ext_image != ".tiff" && ext_image != ".psd")
                        {
                            AppParam_img = " -ss " + ss_time_input.Text + " -i " + "" + '\u0022' + file_img + '\u0022' + " -vframes 1 -f image2" + " -qscale:v 2" + " -vf scale=1280:-2" + " -y " + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_img) + "." + "jpg" + '\u0022';
                        }
                        else
                        {
                            AppParam_img = " -i " + "" + '\u0022' + file_img + '\u0022' + " -qscale:v 2" + " -vf scale=1280:-2" + " -y " + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_img) + "." + "jpg" + '\u0022';
                        }
                        proc_img.StartInfo.RedirectStandardOutput = false;
                        proc_img.StartInfo.RedirectStandardError = false;
                        proc_img.StartInfo.UseShellExecute = true;
                        proc_img.StartInfo.CreateNoWindow = false;
                        proc_img.EnableRaisingEvents = false;
                        proc_img.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;

                        proc_img.StartInfo.FileName = ffm_img;
                        proc_img.StartInfo.Arguments = AppParam_img;

                        proc_img.Start();
                        proc_img.WaitForExit();
                        if (proc_img.ExitCode == 0)
                        {
                            String extracted_img = "" + '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_img) + ".jpg" + '\u0022' + "";
                            inputs = inputs + " -i " + extracted_img;
                        }
                        else
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.err_ext_vid, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            Enable_Controls();
                            working = false;
                            return;
                        }
                        //End extract frame as image
                    }
                }
            }
            //End create joint inputs variable

            //Create mapping inputs variable
            String input_map = String.Empty;
            //Add video track, it must be first
            if (list_proc.Items[0].BackColor == Color.LightYellow)
            {
                //Video track is an still image

                //Attempt to extract first frame from video track as image

                input_map = input_map + " -map 0:0" + " -c:v libx264 -r 1 -crf 29 -preset veryfast -x264-params keyint=1 -pix_fmt yuv420p";
            }
            else
            {
                input_map = input_map + " -map 0:" + list_proc.Items[0].SubItems[1].Text + " -c:v " + list_proc.Items[0].SubItems[5].Text + " -metadata:s:v:0 language=" + list_proc.Items[0].SubItems[3].Text;
            }

            int int_auds = 0;
            int i_subs = 0;

            for (int i = 1; i < list_tracks.Items.Count; i++)

            {
                //Audio tracks
                if (list_proc.Items[i].SubItems[2].Text.Contains("Audio"))
                {
                    String is_default = String.Empty;
                    if (list_proc.Items[i].SubItems[4].Text == FFBatch.Properties.Strings.yes)
                    {
                        is_default = "-disposition:a:" + (int_auds).ToString() + " default";
                    }
                    else
                    {
                        is_default = "-disposition:a:" + (int_auds).ToString() + " 0";
                    }
                    String track_codec = " -c:a copy ";
                    if (list_proc.Items[i].SubItems[5].Text != "copy")
                    {
                        track_codec = " -c:a:" + int_auds + " " + list_proc.Items[i].SubItems[5].Text;
                    }
                    input_map = input_map + " -map " + (i).ToString() + ":" + list_proc.Items[i].SubItems[1].Text + track_codec + " -metadata:s:a:" + (int_auds).ToString() + " language=" + list_proc.Items[i].SubItems[3].Text + " " + is_default;
                    int_auds = int_auds + 1;
                }
            }

            for (int i = 1; i < list_tracks.Items.Count; i++)

            {
                //Subtitle tracks
                if (list_proc.Items[i].SubItems[2].Text.Contains("Subtitle"))
                {
                    String is_default = String.Empty;
                    if (list_proc.Items[i].SubItems[4].Text == FFBatch.Properties.Strings.yes)
                    {
                        is_default = "-disposition:s:" + (i_subs).ToString() + " default";
                    }
                    else
                    {
                        is_default = "-disposition:s:" + (i_subs).ToString() + " 0";
                    }

                    input_map = input_map + " -map " + (i).ToString() + ":" + list_proc.Items[i].SubItems[1].Text + " -c:s " + list_proc.Items[i].SubItems[5].Text + " -metadata:s:s:" + (i_subs).ToString() + " language=" + list_proc.Items[i].SubItems[3].Text + " " + is_default;

                    i_subs = i_subs + 1;
                }
            }

            String AppParam = String.Empty;

            if (list_proc.Items[0].BackColor == Color.LightYellow)
            {
                AppParam = hw_decode + " -loop 1 -r 6 " + inputs + input_map + " -shortest " + "-y ";
            }
            else
            {
                AppParam = hw_decode + " " + inputs + input_map + " -y ";
            }
            String output_file = '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + "." + mux_ext + '\u0022';

            if (!Directory.Exists(destino))
            {
                Directory.CreateDirectory(destino);
            }

            foreach (DataGridViewRow row in frm_mux_jobs.dg_pr.Rows)
            {
                if (row.Cells[5].Value.ToString() == output_file)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.out_ren, FFBatch.Properties.Strings.out_overw, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    output_file = '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + "_mux_" + frm_mux_jobs.dg_pr.RowCount + "." + mux_ext + '\u0022';
                }
            }
            if (duracion.Contains(".")) duracion = duracion.Substring(0, duracion.LastIndexOf("."));
            else duracion = duracion.Substring(0, duracion.LastIndexOf(":"));
            frm_mux_jobs.dg_pr.Rows.Add(frm_mux_jobs.dg_pr.RowCount + 1, Path.GetFileName(list_proc.Items[0].Text), AppParam, list_tracks.Items.Count.ToString(), duracion, output_file);

            try
            {
                Task t = Task.Run(() =>
                {
                    try
                    {
                        Directory.Delete(destino);
                    }
                    catch { }
                });
            }
            catch { }
            btn_mux_show_jobs.Enabled = true;
            if (frm_mux_jobs.dg_pr.RowCount > 0) lbl_mux_jobs.Text = FFBatch.Properties.Strings.jobs + " " + frm_mux_jobs.dg_pr.RowCount;
            else lbl_mux_jobs.Text = String.Empty;
            MessageBox.Show(lbl_mux_jobs.Text);
        }

        private void add_single_stream_job()
        {
            Pg1.Focus();
            cancel_queue = false;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";

            if (list_tracks.Items.Count == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.tracks_empty, FFBatch.Properties.Strings.no_files, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }

            if (list_tracks.SelectedIndices.Count != 1)
            {
                MessageBox.Show(FFBatch.Properties.Strings.sel_track, FFBatch.Properties.Strings.multiple_tr, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            foreach (ListViewItem file0 in list_tracks.Items)
            {
                if (!File.Exists(file0.Text))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file_not_found + " " + file0.Text, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }

            if (list_tracks.Items.Count == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.tracks_empty, FFBatch.Properties.Strings.no_files, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }

            if (txt_track_format.Text == String.Empty && list_tracks.SelectedItems.Count > 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.track_Ext, FFBatch.Properties.Strings.warning, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }

            String is_overw = txt_path_main.Text + "\\" + Path.GetFileNameWithoutExtension(list_tracks.Items[0].Text) + "." + txt_track_format;

            if (is_overw == list_tracks.Items[0].Text)
            {
                MessageBox.Show(FFBatch.Properties.Strings.overw_main, FFBatch.Properties.Strings.overw_not_all, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            DateTime time2;
            if (!DateTime.TryParse(ss_time_input.Text, out time2))
            {
                MessageBox.Show(FFBatch.Properties.Strings.pre_input4, FFBatch.Properties.Strings.pre_input2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            //Validated list, start processing
            //Pending duration

            if (dur_ok == false)
            {
                list_pending_dur.Items.Clear();
                foreach (ListViewItem item in listView1.Items)
                {
                    list_pending_dur.Items.Add((ListViewItem)item.Clone());
                }
                BG_Dur.RunWorkerAsync();
                return;
            }

            cancel_queue = false;

            //Copy list of tracks for thread processing
            ListView list_proc = new ListView();
            foreach (ListViewItem item in list_tracks.SelectedItems)
            {
                list_proc.Items.Add((ListViewItem)item.Clone());
            }
            //End of copy list of tracks for thread processing

            //Duration
            Process probe = new Process();
            probe.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");
            String ffprobe_frames2 = " " + '\u0022' + "--Inform=General;%Duration/String3%" + '\u0022';
            probe.StartInfo.Arguments = ffprobe_frames2 + " " + '\u0022' + list_proc.Items[0].Text + '\u0022';

            probe.StartInfo.RedirectStandardOutput = true;
            probe.StartInfo.UseShellExecute = false;
            probe.StartInfo.CreateNoWindow = true;
            probe.EnableRaisingEvents = true;
            probe.Start();

            String duracion = probe.StandardOutput.ReadLine();

            probe.WaitForExit();
            DateTime time0;
            if (duracion != null)
            {
                if (DateTime.TryParse(duracion, out time0))
                {
                    durat_n = TimeSpan.Parse(duracion).TotalSeconds;
                    total_duration = TimeSpan.Parse(duracion).TotalSeconds;
                    total_duration = durat_n;
                }
            }
            else
            {
                duracion = "0";
                durat_n = 0;
                total_duration = 0;
            }

            //End duration

            //End

            Pg1.Minimum = 0;
            Pg1.Maximum = 100;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            lbl_speed.Text = String.Empty;

            List<string> list_lines = new List<string>();
            String mux_ext = txt_track_format.Text;

            String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");

            String file = list_proc.Items[0].Text;
            String fullPath = file;

            String destino = "";

            if (txt_path_main.Text.Contains(".\\"))
            {
                destino = file.Substring(0, fullPath.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty); ;
            }
            else
            {
                destino = txt_path_main.Text;
            }

            if (!Directory.Exists(destino))
            {
                try
                {
                    Directory.CreateDirectory(destino);
                }
                catch (System.Exception excpt)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    this.Cursor = Cursors.Arrow;
                    Enable_Controls();
                    working = false;
                    return;
                }
            }

            //Create joint inputs variable
            String inputs = String.Empty;
            foreach (ListViewItem input_item in list_proc.Items)
            {
                String stream_type = String.Empty;
                if (input_item.SubItems[2].Text.ToLower().Contains("subtitle"))
                {
                    stream_type = "s";
                }

                if (input_item.SubItems[2].Text.ToLower().Contains("audio"))
                {
                    stream_type = "a";
                }
                if (input_item.SubItems[2].Text.ToLower().Contains("video"))
                {
                    stream_type = "v";
                }
                //{
                //inputs = inputs + " -sub_charenc UTF-8" + " -i " + '\u0022' + input_item.Text + '\u0022';
                //}
                inputs = " -i " + '\u0022' + input_item.Text + '\u0022' + " -map 0:" + input_item.SubItems[1].Text + " -c:" + stream_type + " " + txt_track_param.Text + " ";
            }
            //End create joint inputs variable

            String AppParam = inputs + "-y ";
            String output_file = '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + "." + mux_ext + '\u0022';

            if (!Directory.Exists(destino))
            {
                Directory.CreateDirectory(destino);
            }

            foreach (DataGridViewRow row in frm_mux_jobs.dg_pr.Rows)
            {
                if (row.Cells[5].Value.ToString() == output_file)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.out_ren, FFBatch.Properties.Strings.out_overw, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    output_file = '\u0022' + destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file) + "_mux_" + frm_mux_jobs.dg_pr.RowCount + "." + mux_ext + '\u0022';
                }
            }
            if (duracion.Contains(".")) duracion = duracion.Substring(0, duracion.LastIndexOf("."));
            else duracion = duracion.Substring(0, duracion.LastIndexOf(":"));
            frm_mux_jobs.dg_pr.Rows.Add(frm_mux_jobs.dg_pr.RowCount + 1, Path.GetFileName(list_proc.Items[0].Text), AppParam, list_tracks.Items.Count.ToString(), duracion, output_file);

            try
            {
                Task t = Task.Run(() =>
                {
                    try
                    {
                        Directory.Delete(destino);
                    }
                    catch { }
                });
            }
            catch { }
            btn_mux_show_jobs.Enabled = true;
            if (frm_mux_jobs.dg_pr.RowCount > 0) lbl_mux_jobs.Text = FFBatch.Properties.Strings.jobs + " " + frm_mux_jobs.dg_pr.RowCount;
            else lbl_mux_jobs.Text = String.Empty;
            MessageBox.Show(lbl_mux_jobs.Text);
        }

        private void btn_mux_job_Click(object sender, EventArgs e)
        {
            if (list_tracks.Items.Count == 0)
            {
                if (listView2.Items.Count > 1 && listView2.SelectedItems.Count > 1)
                {
                    ct2_save_allstreams.PerformClick();
                }
                else
                {
                    MessageBox.Show(FFBatch.Properties.Strings.track_empty, FFBatch.Properties.Strings.notrack_info, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }
            }

            if (!File.Exists(Path.Combine(Application.StartupPath, "ffmpeg.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_ffmpeg, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }
            if (check_ff_md5() == false)
            {
                Form25 frm25 = new Form25();
                frm25.ShowDialog();
                return;
            }
            if (list_tracks.Items.Count == 1) add_single_stream_job();
            if (list_tracks.Items.Count > 1) add_video_mux_job();
        }

        private void btn_mux_show_jobs_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            frm_mux_jobs.ShowDialog();

            if (frm_mux_jobs.dg_pr.RowCount > 0) lbl_mux_jobs.Text = FFBatch.Properties.Strings.jobs + " " + frm_mux_jobs.dg_pr.RowCount;
            else
            {
                lbl_mux_jobs.Text = String.Empty;
                btn_mux_show_jobs.Enabled = false;
            }
            if (frm_mux_jobs.view_logs == true)
            {
                show_mux_logs();
                return;
            }
            if (frm_mux_jobs.start_jobs == true) start_mux_jobs();
        }

        private void show_mux_logs()
        {
            Pg1.Focus();
            String path_log_file = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
            if (!File.Exists(path_log_file))
            {
                if (no_save_logs == true) MessageBox.Show(FFBatch.Properties.Strings.no_log_f, FFBatch.Properties.Strings.file_not_f, MessageBoxButtons.OK, MessageBoxIcon.Error);
                else
                if (no_save_logs == false) MessageBox.Show(FFBatch.Properties.Strings.no_log1, FFBatch.Properties.Strings.file_not_f, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }
            long length = new System.IO.FileInfo(path_log_file).Length;
            if (length > 20000000)
            {
                var a = MessageBox.Show(FFBatch.Properties.Strings.log_siz + " " + (length / 1024).ToString() + " KB " + FFBatch.Properties.Strings.time_load, FFBatch.Properties.Strings.warning, MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                if (a == DialogResult.No) return;
            }

            //Form frm_output = new Form();
            frm_log.Name = FFBatch.Properties.Strings.last_log1;
            frm_log.Text = "FFmpeg Batch AV Converter";
            frm_log.Icon = this.Icon;

            frm_log.Height = 675;
            frm_log.Width = 977;
            frm_log.FormBorderStyle = FormBorderStyle.Fixed3D;
            frm_log.MaximizeBox = false;
            frm_log.MinimizeBox = false;

            var fuente_list = new System.Drawing.Font("Microsoft Sans Serif", 9, FontStyle.Regular);

            Rtxt.Parent = frm_log;
            Rtxt.Left = 20;
            Rtxt.Top = 65;
            Rtxt.Height = 525;
            Rtxt.Width = 920;
            Rtxt.Font = fuente_list;

            ContextMenu Rtxt_menu = new ContextMenu();
            Rtxt.ContextMenu = Rtxt_menu;
            MenuItem CopyItem = new MenuItem(FFBatch.Properties.Strings.copy);
            Rtxt_menu.MenuItems.Add(CopyItem);
            CopyItem.Click += new EventHandler(CopyAction);

            TextBox titulo = new TextBox();
            titulo.Parent = frm_log;
            titulo.Top = 15;
            titulo.Left = 20;
            titulo.Width = 921;
            titulo.TabIndex = 0;
            var fuente = new System.Drawing.Font("Microsoft Sans Serif", 11, FontStyle.Bold);

            titulo.Font = fuente;
            titulo.BorderStyle = BorderStyle.Fixed3D;
            titulo.TextAlign = HorizontalAlignment.Center;
            titulo.ReadOnly = true;

            titulo.Text = FFBatch.Properties.Strings.last_b_l;

            Button boton_ok_ff = new Button();
            boton_ok_ff.Parent = frm_log;
            boton_ok_ff.Left = 20;
            boton_ok_ff.Top = 595;
            boton_ok_ff.Width = 920;
            boton_ok_ff.Height = 27;
            boton_ok_ff.Text = FFBatch.Properties.Strings.last_b_l;
            boton_ok_ff.Click += new EventHandler(boton_ok_ff_Click);

            TextBox titulo2 = new TextBox();
            titulo2.Parent = frm_log;
            titulo2.Top = 42;
            titulo2.Left = 47;
            titulo2.Width = 867;

            var fuente2 = new System.Drawing.Font("Microsoft Sans Serif", 10, FontStyle.Regular);

            titulo2.Font = fuente2;
            titulo2.BorderStyle = BorderStyle.None;
            titulo2.TextAlign = HorizontalAlignment.Center;
            titulo2.ReadOnly = true;

            titulo2.Text = "ff_batch.log";

            frm_log.StartPosition = FormStartPosition.CenterScreen;
            Rtxt.Text = File.ReadAllText(path_log_file);
            boton_ok_ff.Text = FFBatch.Properties.Strings.close_win;
            frm_log.ShowDialog();
            frm_log.Refresh();
        }

        private void start_mux_jobs()
        {
            Pg1.Focus();

            if (!File.Exists(Path.Combine(Application.StartupPath, "ffmpeg.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_ffmpeg, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }
            if (check_ff_md5() == false)
            {
                Form25 frm25 = new Form25();
                frm25.ShowDialog();
                return;
            }

            cancel_queue = false;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            Disable_Controls();
            txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + "00h:00m:00s";
            time_n_tasks = 0;
            timer_tasks.Start();
            timer_est_size.Start();

            cancel_queue = false;
            Pg1.Value = 0;
            working = true;

            //Copy list of tracks for thread processing

            DataGridView list_proc = new DataGridView();
            list_proc.Columns.Add("Nr", "");
            list_proc.Columns.Add(FFBatch.Properties.Strings.filename, "");
            list_proc.Columns.Add("Parameters", "");
            list_proc.Columns.Add("Streams", "");
            list_proc.Columns.Add(FFBatch.Properties.Strings.duration, "");
            list_proc.Columns.Add("Output", "");

            foreach (DataGridViewRow item in frm_mux_jobs.dg_pr.Rows)
            {
                list_proc.Rows.Add(item.Cells[0].Value, item.Cells[1].Value, item.Cells[2].Value, item.Cells[3].Value, item.Cells[4].Value, item.Cells[5].Value);
            }

            //End of copy list of tracks for thread processing

            Double total_duration = 0;
            Double total_prog = 0;

            //Duration
            foreach (DataGridViewRow row in frm_mux_jobs.dg_pr.Rows)
            {
                total_duration = total_duration + TimeSpan.Parse(row.Cells[4].Value.ToString()).TotalSeconds;
            }

            //durat_n = TimeSpan.Parse(row.Cells[5].Value.ToString()).TotalSeconds;
            //End duration

            Pg1.Minimum = 0;
            Pg1.Maximum = 100;
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
            lbl_speed.Text = String.Empty;
            lbl_elapsed.Text = FFBatch.Properties.Strings.time_elapsed + " " + "00h:00m:00s";

            List<string> list_lines = new List<string>();
            pic_no_errors.Visible = false;
            pic_recording.Visible = false;
            pic_warnings.Visible = false;

            int i = 0;
            int rows = list_proc.RowCount - 1;
            process_glob.StartInfo.Arguments = String.Empty;

            groupBox2.Enabled = true;
            foreach (Control p in groupBox2.Controls)
            {
                if (p.Name != lbl_mux_jobs.Name)
                {
                    this.InvokeEx(f => p.Enabled = false);
                }
            }

            new System.Threading.Thread(() =>
            {
                System.Threading.Thread.CurrentThread.IsBackground = true;

                foreach (DataGridViewRow row in list_proc.Rows)
                {
                    if (cancel_queue == true)
                    {
                        working = false;
                        time_est_size = 0;
                        Enable_Controls();

                        this.InvokeEx(f => f.Pg1.Value = 100);
                        this.InvokeEx(f => f.Pg1.Text = "100%");
                        this.InvokeEx(f => f.Pg1.Refresh());

                        process_glob.StartInfo.Arguments = String.Empty;
                        this.InvokeEx(f => this.Text = "FFmpeg Batch AV Converter");

                        if (is_portable == true)
                            this.InvokeEx(f => this.Text = "FFmpeg Batch AV Converter Portable");

                        this.InvokeEx(f => f.lbl_speed.Text = String.Empty);
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        this.InvokeEx(f => f.lbl_est_size.Text = String.Empty);
                        this.InvokeEx(f => f.lbl_bitrate.Text = String.Empty);

                        MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.task_abort, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                        return;
                    }

                    String remain_time = "0";
                    if (row.IsNewRow == true)
                    {
                        i++;
                        continue;
                    }

                    String destino = row.Cells[5].Value.ToString();
                    destino = destino.Substring(1, destino.Length - 2);
                    destino = Path.GetDirectoryName(destino);
                    String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");
                    String AppParam = row.Cells[2].Value.ToString();

                    if (!Directory.Exists(destino))
                    {
                        Directory.CreateDirectory(destino);
                    }
                    this.InvokeEx(f => f.lbl_mux_jobs.Text = FFBatch.Properties.Strings.jobs + " " + (i + 1).ToString() + " " + FFBatch.Properties.Strings.of1 + " " + rows.ToString());

                    valid_prog = false;
                    process_glob.StartInfo.FileName = ffm;
                    process_glob.StartInfo.Arguments = AppParam + " " + row.Cells[5].Value.ToString();
                    process_glob.StartInfo.RedirectStandardOutput = true;
                    process_glob.StartInfo.RedirectStandardError = true;
                    process_glob.StartInfo.RedirectStandardInput = true;
                    process_glob.StartInfo.UseShellExecute = false;
                    process_glob.StartInfo.CreateNoWindow = true;
                    process_glob.EnableRaisingEvents = true;

                    process_glob.Start();
                    System.Threading.Thread.Sleep(50);
                    combo_prio.Invoke(new MethodInvoker(delegate
                    {
                        if (combo_prio.SelectedIndex != 2)
                        {
                            Change_mem_prio();
                        }
                    }));

                    valid_prog = true;

                    String err_txt = "";
                    Double interval = 0;
                    Decimal est_bitrate = 0;
                    Decimal est_size = 0;
                    this.InvokeEx(f => f.lbl_speed.Text = String.Empty);
                    Double sec_prog = 0;
                    try
                    {
                        while (!process_glob.StandardError.EndOfStream)
                        {
                            err_txt = process_glob.StandardError.ReadLine();
                            list_lines.Add(err_txt);

                            if (err_txt.Contains("time=") && err_txt.Contains("time=-") == false)
                            {
                                if (valid_prog == true)
                                {
                                    this.InvokeEx(f => durat_n = TimeSpan.Parse(row.Cells[4].Value.ToString()).TotalSeconds);
                                    int start_time_index = err_txt.IndexOf("time=") + 5;
                                    sec_prog = TimeSpan.Parse(err_txt.Substring(start_time_index, 8)).TotalSeconds;

                                    Double percent = (sec_prog * 100 / durat_n);

                                    total_prog = total_prog + (sec_prog - interval);
                                    interval = sec_prog;
                                    int percent2 = Convert.ToInt32(percent);

                                    Double percent_tot = (total_prog * 100 / total_duration);
                                    int percent_tot_2 = Convert.ToInt32(percent_tot);

                                    if (percent_tot_2 <= 100)
                                    {
                                        this.InvokeEx(f => f.Pg1.Value = percent_tot_2);
                                        this.InvokeEx(f => f.Pg1.Refresh());

                                        if (Math.Round(percent_tot, 1).ToString().Contains(".") || Math.Round(percent_tot, 1).ToString().Contains(","))
                                        {
                                            this.InvokeEx(f => f.Pg1.Text = Math.Round(percent_tot, 1).ToString() + "%");
                                        }
                                        else
                                        {
                                            this.InvokeEx(f => f.Pg1.Text = Math.Round(percent_tot, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0" + "%");
                                        }
                                        this.InvokeEx(f => f.Pg1.Refresh());

                                        this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, percent_tot, Pg1.Maximum));
                                    }

                                    if (cancel_queue == false)
                                    {
                                        //Estimated remaining time

                                        remain_time = err_txt.Substring(err_txt.LastIndexOf("speed=") + 6, err_txt.Length - err_txt.LastIndexOf("speed=") - 6);
                                        if (time_est_size % 3 == 0) this.InvokeEx(f => f.lbl_speed.Text = FFBatch.Properties.Strings.speed + " " + remain_time);
                                        remain_time = remain_time.Replace("x", String.Empty);
                                        Double timing1 = 0;

                                        if (System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator == ",")
                                        {
                                            timing1 = Math.Round(Double.Parse(remain_time.Replace(".", ",")), 2);
                                        }
                                        else
                                        {
                                            timing1 = Math.Round(Double.Parse(remain_time), 2);
                                        }

                                        Decimal timing = (decimal)timing1;
                                        Decimal total_dur_dec = Convert.ToDecimal(total_duration);
                                        Decimal total_prog_dec = Convert.ToDecimal(total_prog);
                                        Decimal remain_secs = 0;
                                        if (timing > 0)
                                        {
                                            remain_secs = (decimal)(total_dur_dec - total_prog_dec) / timing;
                                        }

                                        if (remain_secs > 60)
                                        {
                                            remain_secs = remain_secs + 60;
                                        }

                                        String remain_from_secs = "";

                                        TimeSpan t = TimeSpan.FromSeconds(Convert.ToDouble(remain_secs));
                                        remain_from_secs = string.Format("{0:D2}h:{1:D2}",
                                           t.Hours,
                                          t.Minutes);

                                        if (remain_secs >= 43200)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Math.Round(remain_secs / 3600).ToString() + " " + FFBatch.Properties.Strings.hours);
                                            this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + Math.Round(remain_secs / 3600).ToString() + " " + FFBatch.Properties.Strings.hours);
                                        }

                                        if (remain_secs >= 3600 && remain_secs < 43200)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs + " " + FFBatch.Properties.Strings.minutes_abrev);
                                            this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + remain_from_secs + " " + FFBatch.Properties.Strings.minutes_abrev);
                                        }

                                        if (remain_secs < 3600 && remain_secs >= 600)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes);
                                            this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes_abrev);
                                        }
                                        if (remain_secs < 600 && remain_secs >= 120)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes);
                                            this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + remain_from_secs.Substring(remain_from_secs.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes_abrev);
                                        }

                                        if (remain_secs <= 59 && remain_secs != 0)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Convert.ToInt16(Math.Abs(remain_secs)) + " " + FFBatch.Properties.Strings.seconds);
                                            this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + Convert.ToInt16(Math.Abs(remain_secs)) + " s");
                                        }
                                        if (remain_secs == 0)
                                        {
                                            this.InvokeEx(f => f.txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.about_finish);
                                            this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text);
                                        }
                                    }
                                    //End remaining time

                                    //Estimated size and bitrate

                                    String read_size = String.Empty;
                                    if (err_txt.Contains("size=") && (time_est_size % 3 == 0))
                                    {
                                        int size_index = err_txt.IndexOf("size=") + 5;
                                        read_size = err_txt.Substring(size_index, 8);
                                        if (Convert.ToDecimal(sec_prog) != 0)
                                        {
                                            est_bitrate = (Math.Round(Convert.ToDecimal(read_size) * 8 / Convert.ToDecimal(sec_prog), 0));
                                        }
                                        else
                                        {
                                            est_bitrate = 0;
                                        }

                                        if (Convert.ToDecimal(read_size) > 1 && time_n_tasks > 1)
                                        {
                                            if (est_bitrate < 9999)
                                            {
                                                if (est_bitrate > 48)
                                                {
                                                    this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " " + est_bitrate + " " + "Kb/s");
                                                }
                                                else
                                                {
                                                    this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " ");
                                                }
                                            }
                                            else
                                            {
                                                this.InvokeEx(f => f.lbl_bitrate.Text = FFBatch.Properties.Strings.avg_bit + " " + (Math.Round(est_bitrate / 1000, 0)) + " " + "Mb/s");
                                            }
                                            //Estimated size
                                            est_size = Convert.ToDecimal(durat_n) * est_bitrate / 8;

                                            if (est_size > 1000000)
                                            {
                                                this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " " + (Math.Round(est_size / 1000000, 1)).ToString() + " " + "GB");
                                            }
                                            else
                                            {
                                                if (Math.Round(est_size / 1000, 0) > 0)
                                                {
                                                    this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " " + (Math.Round(est_size / 1000, 0)).ToString() + " " + "MB");
                                                }
                                                else
                                                {
                                                    this.InvokeEx(f => f.lbl_est_size.Text = FFBatch.Properties.Strings.est_size + " ");
                                                }
                                            }
                                        }

                                        this.InvokeEx(f => f.lbl_est_size.Refresh());
                                    }
                                }
                            }
                        }
                    }
                    catch { }

                    process_glob.WaitForExit();
                    process_glob.StartInfo.Arguments = String.Empty;

                    if (process_glob.ExitCode == 0)
                    {
                        if (cancel_queue == false) this.InvokeEx(f => f.frm_mux_jobs.dg_pr.Rows[row.Index].DefaultCellStyle.BackColor = Color.LightGreen);
                        else this.InvokeEx(f => f.frm_mux_jobs.dg_pr.Rows[row.Index].DefaultCellStyle.BackColor = Color.LightSalmon);
                    }
                    else
                    {
                        this.InvokeEx(f => f.frm_mux_jobs.dg_pr.Rows[row.Index].DefaultCellStyle.BackColor = Color.LightSalmon);
                        errors_enc = errors_enc + 1;
                    }

                    i++;

                    if (i == list_proc.RowCount - 1)
                    {
                        this.InvokeEx(f => this.Text = "FFmpeg Batch AV Converter");
                        if (is_portable == true) this.InvokeEx(f => this.Text = "FFmpeg Batch AV Converter Portable");
                        this.InvokeEx(f => f.lbl_mux_jobs.Text = FFBatch.Properties.Strings.jobs + " " + list_proc.RowCount.ToString());
                        this.InvokeEx(f => f.Pg1.Value = 100);
                        this.InvokeEx(f => f.Pg1.Text = "100%");
                        this.InvokeEx(f => f.Pg1.Refresh());

                        process_glob.StartInfo.Arguments = String.Empty;
                        this.InvokeEx(f => f.lbl_speed.Text = String.Empty);
                        this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                        this.InvokeEx(f => f.lbl_est_size.Text = String.Empty);
                        this.InvokeEx(f => f.lbl_bitrate.Text = String.Empty);

                        list_lines.Add("");
                        list_lines.Add("---------------------End of " + Path.GetFileName(row.Cells[1].Value.ToString()) + " log-------------------------------");
                        list_lines.Add("");

                        working = false;
                        //
                        if (no_save_logs == false)
                        {
                            string[] array_err = list_lines.ToArray();
                            String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                            if (is_portable == true) path = port_path + "ff_batch_portable.log";

                            System.IO.StreamWriter SaveFile = new System.IO.StreamWriter(path);
                            SaveFile.WriteLine("FFmpeg log sesion: " + System.DateTime.Now);
                            SaveFile.WriteLine("-------------------------------");
                            foreach (String item in array_err)
                            {
                                SaveFile.WriteLine(item);
                            }
                            SaveFile.Close();

                            File.AppendAllText(path, "-----------------------");
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.end_log);
                            System.IO.FileInfo fileInfo = new System.IO.FileInfo(path);

                            var bytes = fileInfo.Length;

                            var kilobytes = (double)bytes / 1024;
                            var megabytes = kilobytes / 1024;
                            var gigabytes = megabytes / 1024;

                            //Format size view
                            String size = "";
                            String separator = ".";

                            if (bytes > 1000000000)
                            {
                                if (gigabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String gigas = gigabytes.ToString();
                                if (gigas.Length >= 5)
                                {
                                    gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                                    size = (gigas + " " + "GB");
                                }
                                else
                                {
                                    size = (gigas + " " + "GB");
                                }
                            }

                            if (bytes >= 1048576 && bytes <= 1000000000)
                            {
                                if (megabytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }
                                String megas = megabytes.ToString();
                                if (megas.Length > 5)
                                {
                                    megas = megas.Substring(0, megas.LastIndexOf(separator));
                                    size = (megas + " " + "MB");
                                }
                                else
                                {
                                    size = (megas + " " + "MB");
                                }
                            }

                            if (bytes >= 1024 && bytes < 1048576)

                            {
                                if (kilobytes.ToString().Contains("."))
                                {
                                    separator = ".";
                                }
                                else
                                {
                                    separator = ",";
                                }

                                String kbs = kilobytes.ToString();
                                if (kbs.Length >= 5)
                                {
                                    kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                                    size = (kbs + " " + "KB");
                                }
                                else
                                {
                                    size = (kbs + " " + "KB");
                                }
                            }
                            if (bytes > -1 && bytes < 1024)
                            {
                                String bits = bytes.ToString();
                                size = (bits + " Bytes");
                            }

                            //End Format size view
                            File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.log_size + " " + size);

                            //End save log
                        }

                        Enable_Controls();
                        timer_est_size.Stop();
                        time_est_size = 0;

                        if (cancel_queue == false)
                        {
                            if (chkshut.Checked)
                            {
                                if (errors_enc == 0)
                                {
                                    this.InvokeEx(f => f.groupBox2.Enabled = true);
                                    foreach (Control ct in groupBox2.Controls)
                                    {
                                        this.InvokeEx(f => ct.Enabled = false);
                                    }
                                    auto_shut();
                                    return;
                                }
                            }
                            //End shutdown check
                            else
                            {
                                this.InvokeEx(f => toolT002.RemoveAll());
                                if (play_on_end == true) play_end();
                                if (errors_enc == 0) this.InvokeEx(f => f.pic_no_errors.Visible = true);
                                else
                                {
                                    this.InvokeEx(f => f.pic_no_errors.Visible = false);
                                    this.InvokeEx(f => f.pic_recording.Visible = false);
                                    this.InvokeEx(f => toolT002.SetToolTip(this.pic_warnings, FFBatch.Properties.Strings.there_w + " " + errors_enc.ToString() + " " + FFBatch.Properties.Strings.errors_se));
                                    this.InvokeEx(f => f.pic_warnings.Visible = true);
                                }

                                if (Form.ActiveForm == null)
                                {
                                    if (errors_enc == 0)
                                    {
                                        notifyIcon1.Visible = true;
                                        notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.batch_mux;
                                        notifyIcon1.BalloonTipIcon = ToolTipIcon.Info;
                                        notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.b_mux_c;
                                        notifyIcon1.ShowBalloonTip(0);
                                    }
                                    else
                                    {
                                        notifyIcon1.Visible = true;
                                        notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.b_mux_err;
                                        notifyIcon1.BalloonTipIcon = ToolTipIcon.Warning;
                                        notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.b_mux_c;
                                        notifyIcon1.ShowBalloonTip(0);
                                    }
                                }

                                if (chk_open_compl.Checked)
                                {
                                    if (Directory.GetFiles(destino).Length != 0)
                                    {
                                        destino = destino.Replace("\\\\", "\\");
                                        Process open_processed = new Process();
                                        open_processed.StartInfo.FileName = "explorer.exe";
                                        open_processed.StartInfo.Arguments = '\u0022' + destino + '\u0022';
                                        open_processed.Start();
                                    }
                                    else
                                    {
                                        if (Directory.Exists(destino))
                                        {
                                            System.IO.Directory.Delete(destino);
                                        }
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (cancel_queue == false)
                            {
                                this.InvokeEx(f => f.Pg1.Text = "100%");
                                this.InvokeEx(f => MessageBox.Show(FFBatch.Properties.Strings.mux_abort1, FFBatch.Properties.Strings.aborted, MessageBoxButtons.OK, MessageBoxIcon.Error));
                            }
                        }

                        listView1.Invoke(new MethodInvoker(delegate
                        {
                            frm_mux_jobs.ShowDialog();
                            if (frm_mux_jobs.view_logs == true)
                            {
                                show_mux_logs();
                                return;
                            }
                        }));
                    }
                }
            }).Start();
        }

        private void menu_extract_images_Click(object sender, EventArgs e)
        {
            AeroWizard5 wiz_img = new AeroWizard5();
            wiz_img.pr1_first_params = "";
            wiz_img.StartPosition = FormStartPosition.CenterParent;
            wiz_img.list_count = listView1.Items.Count;
            wiz_img.ShowDialog();
            if (wiz_img.canceled == true) return;

            if (wiz_img.save_preset == false)
            {
                combo_presets.Text = FFBatch.Properties.Strings.new_preset;
                txt_parameters.Text = wiz_img.pr1_first_params;
                txt_format.Text = "nul";
            }
            else
            {
                combo_presets.SelectedIndex = combo_presets.Items.Count - 1;
                combo_presets.Text = wiz_img.txt_preset_name.Text;
                txt_parameters.Text = wiz_img.pr1_first_params;
                txt_format.Text = "nul";
                btn_save_preset.PerformClick();
            }
            if (wiz_img.start_enc == true) btn_seq.PerformClick();
        }

        private void Form1_Resize(object sender, EventArgs e)
        {
            resize();
        }

        private void txt_path_main_TextChanged(object sender, EventArgs e)
        {
            txt_path_main.BackColor = Color.White;
            btn_save_path.Enabled = true;
        }

        private void txt_path_mux_TextChanged(object sender, EventArgs e)
        {
            txt_path_main.Text = txt_path_mux.Text;
        }

        //void refresh_vcodec_col()
        //{
        //    Boolean already_vcodec = false;
        //    foreach (ColumnHeader head_col in listView1.Columns)
        //    {
        //        if (head_col.Text.Contains(FFBatch.Properties.Strings.Video_codec))
        //        {
        //            already_vcodec = true;
        //            break;
        //        }
        //    }
        //    if (already_vcodec == false)
        //    {
        //        ColumnHeader columnHeader = listView1.Columns.Add(FFBatch.Properties.Strings.Video_codec, 100, HorizontalAlignment.Left);
        //        listView1.Columns[0].Width = listView1.Columns[0].Width - 100;
        //    }
        //    pre_add_col();
        //    Task tt = Task.Run(() =>
        //    {
        //        BG_Add_col_vcodec.RunWorkerAsync();
        //    });
        //    tt.Wait();

        //}

        //void refresh_acodec_col()
        //{
        //    Boolean already_acodec = false;
        //    foreach (ColumnHeader head_col in listView1.Columns)
        //    {
        //        if (head_col.Text.Contains(FFBatch.Properties.Strings.Audio_codec))
        //        {
        //            already_acodec = true;
        //            break;
        //        }
        //    }
        //    if (already_acodec == false)
        //    {
        //        ColumnHeader columnHeader = listView1.Columns.Add(FFBatch.Properties.Strings.Audio_codec, 100, HorizontalAlignment.Center);
        //        listView1.Columns[0].Width = listView1.Columns[0].Width - 100;
        //    }
        //    pre_add_col();
        //    BG_Add_col_Acodec.RunWorkerAsync();
        //}

        //void refresh_resol_col()
        //{
        //    Boolean already_added = false;
        //    col_width = 0;
        //    foreach (ColumnHeader head_col in listView1.Columns)
        //    {
        //        if (head_col.Text.Contains(FFBatch.Properties.Strings.width))
        //        {
        //            col_width = head_col.Index;
        //            already_added = true;
        //            break;
        //        }
        //    }
        //    if (already_added == false)
        //    {
        //        ColumnHeader columnHeader = listView1.Columns.Add(FFBatch.Properties.Strings.width, 50, HorizontalAlignment.Center);
        //        ColumnHeader columnHeader2 = listView1.Columns.Add(FFBatch.Properties.Strings.height, 50, HorizontalAlignment.Center);
        //        listView1.Columns[0].Width = listView1.Columns[0].Width - 100;
        //    }
        //    foreach (ColumnHeader head_col in listView1.Columns)
        //    {
        //        if (head_col.Text.Contains(FFBatch.Properties.Strings.width))
        //        {
        //            col_width = head_col.Index;
        //            break;
        //        }
        //    }
        //    pre_add_col();

        //    BG_add_col_res.RunWorkerAsync();
        //}

        private void btn_add_col_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            Form17 frm_add_col = new Form17();
            frm_add_col.cb_col.Items.Clear();
            Boolean has_res = false;
            Boolean has_vid = false;
            Boolean has_aud = false;
            Boolean has_bit = false;
            Boolean has_abit = false;
            Boolean has_tbit = false;

            foreach (ColumnHeader col in listView1.Columns)
            {
                if (col.Text == FFBatch.Properties.Strings.width) has_res = true;
                if (col.Text == FFBatch.Properties.Strings.Video_codec) has_vid = true;
                if (col.Text == FFBatch.Properties.Strings.Audio_codec) has_aud = true;
                if (col.Text == FFBatch.Properties.Strings.v_bitr) has_bit = true;
                if (col.Text == FFBatch.Properties.Strings2.a_bitr) has_abit = true;
                if (col.Text == FFBatch.Properties.Strings2.bitrate) has_tbit = true;
            }

            if (has_abit == false) frm_add_col.cb_col.Items.Add(FFBatch.Properties.Strings2.bitrate);
            if (has_vid == false) frm_add_col.cb_col.Items.Add(FFBatch.Properties.Strings.Video_codec);
            if (has_bit == false) frm_add_col.cb_col.Items.Add(FFBatch.Properties.Strings.v_bitr);
            if (has_res == false) frm_add_col.cb_col.Items.Add(FFBatch.Properties.Strings.resolution);
            if (has_aud == false) frm_add_col.cb_col.Items.Add(FFBatch.Properties.Strings.Audio_codec);
            if (has_abit == false) frm_add_col.cb_col.Items.Add(FFBatch.Properties.Strings2.a_bitr);
            

            frm_add_col.ShowDialog();
            if (frm_add_col.canceled == true) return;
            if (frm_add_col.to_remove == false)
            {
                selected_add_col = frm_add_col.cb_col.SelectedItem.ToString();

                if (frm_add_col.cb_col.SelectedItem.ToString() == FFBatch.Properties.Strings.resolution)
                {
                    Boolean already_added = false;
                    col_width = 0;
                    foreach (ColumnHeader head_col in listView1.Columns)
                    {
                        if (head_col.Text.Contains(FFBatch.Properties.Strings.width))
                        {
                            col_width = head_col.Index;
                            already_added = true;
                            break;
                        }
                    }
                    if (already_added == false)
                    {
                        ColumnHeader columnHeader = listView1.Columns.Add(FFBatch.Properties.Strings.width, 50, HorizontalAlignment.Center);
                        ColumnHeader columnHeader2 = listView1.Columns.Add(FFBatch.Properties.Strings.height, 50, HorizontalAlignment.Center);
                        listView1.Columns[0].Width = listView1.Columns[0].Width - 110;
                    }
                    foreach (ColumnHeader head_col in listView1.Columns)
                    {
                        if (head_col.Text.Contains(FFBatch.Properties.Strings.width))
                        {
                            col_width = head_col.Index;
                            break;
                        }
                    }
                    if (already_added == false)
                    {
                        pre_add_col();
                        BG_add_col_res.RunWorkerAsync();
                    }
                }
                if (frm_add_col.cb_col.SelectedItem.ToString() == FFBatch.Properties.Strings.Video_codec)
                {
                    Boolean already_vcodec = false;
                    foreach (ColumnHeader head_col in listView1.Columns)
                    {
                        if (head_col.Text.Contains(FFBatch.Properties.Strings.Video_codec))
                        {
                            already_vcodec = true;
                            break;
                        }
                    }
                    if (already_vcodec == false)
                    {
                        ColumnHeader columnHeader = listView1.Columns.Add(FFBatch.Properties.Strings.Video_codec, 100, HorizontalAlignment.Left);
                        listView1.Columns[0].Width = listView1.Columns[0].Width - 110;
                    }
                    if (already_vcodec == false)
                    {
                        pre_add_col();
                        BG_Add_col_vcodec.RunWorkerAsync();
                    }
                }
                if (frm_add_col.cb_col.SelectedItem.ToString() == FFBatch.Properties.Strings.Audio_codec)
                {
                    Boolean already_vcodec = false;
                    foreach (ColumnHeader head_col in listView1.Columns)
                    {
                        if (head_col.Text.Contains(FFBatch.Properties.Strings.Audio_codec))
                        {
                            already_vcodec = true;
                            break;
                        }
                    }
                    if (already_vcodec == false)
                    {
                        ColumnHeader columnHeader = listView1.Columns.Add(FFBatch.Properties.Strings.Audio_codec, 100, HorizontalAlignment.Center);
                        listView1.Columns[0].Width = listView1.Columns[0].Width - 110;
                    }
                    if (already_vcodec == false)
                    {
                        pre_add_col();
                        BG_Add_col_Acodec.RunWorkerAsync();
                    }
                }

                if (frm_add_col.cb_col.SelectedItem.ToString() == FFBatch.Properties.Strings.v_bitr)
                {
                    Boolean already_vcodec = false;
                    foreach (ColumnHeader head_col in listView1.Columns)
                    {
                        if (head_col.Text.Contains(FFBatch.Properties.Strings.v_bitr))
                        {
                            already_vcodec = true;
                            break;
                        }
                    }
                    if (already_vcodec == false)
                    {
                        ColumnHeader columnHeader = listView1.Columns.Add(FFBatch.Properties.Strings.v_bitr, 100, HorizontalAlignment.Center);
                        listView1.Columns[0].Width = listView1.Columns[0].Width - 110;
                    }
                    if (already_vcodec == false)
                    {
                        pre_add_col();
                        BG_add_VBitrate_col.RunWorkerAsync();
                    }
                }

                if (frm_add_col.cb_col.SelectedItem.ToString() == FFBatch.Properties.Strings2.a_bitr)
                {
                    Boolean already_vcodec = false;
                    foreach (ColumnHeader head_col in listView1.Columns)
                    {
                        if (head_col.Text.Contains(FFBatch.Properties.Strings2.a_bitr))
                        {
                            already_vcodec = true;
                            break;
                        }
                    }
                    if (already_vcodec == false)
                    {
                        ColumnHeader columnHeader = listView1.Columns.Add(FFBatch.Properties.Strings2.a_bitr, 100, HorizontalAlignment.Center);
                        listView1.Columns[0].Width = listView1.Columns[0].Width - 110;
                    }
                    if (already_vcodec == false)
                    {
                        pre_add_col();
                        BG_Add_col_abit.RunWorkerAsync();
                    }
                }

                if (frm_add_col.cb_col.SelectedItem.ToString() == FFBatch.Properties.Strings2.bitrate)
                {
                    Boolean already_vcodec = false;
                    foreach (ColumnHeader head_col in listView1.Columns)
                    {
                        if (head_col.Text.Contains(FFBatch.Properties.Strings2.bitrate))
                        {
                            already_vcodec = true;
                            break;
                        }
                    }
                    if (already_vcodec == false)
                    {
                        ColumnHeader columnHeader = listView1.Columns.Add(FFBatch.Properties.Strings2.bitrate, 100, HorizontalAlignment.Center);
                        listView1.Columns[0].Width = listView1.Columns[0].Width - 110;
                    }
                    if (already_vcodec == false)
                    {
                        pre_add_col();
                        BG_add_col_bitr.RunWorkerAsync();
                    }
                }

                list_cols();
            }
            else
            {
                remove_last_col();
                list_cols();
            }

            if (listView1.Columns.Count >= 13)
            {
                cti1_cols.Enabled = false;
            }
            if (listView1.Columns.Count <= 13 && listView1.Columns.Count >= 6)
            {
                cti1_cols.Enabled = true;
            }
            if (listView1.Columns.Count > 6)
            {
                cti_remove_col.Enabled = true;
            }
            else
            {
                cti_remove_col.Enabled = false;
            }
        }

        private void list_cols()
        {
            String f_cols = String.Empty;
            if (is_portable == false)
            {
                f_cols = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_cols.ini";
            }
            else
            {
                f_cols = port_path + "ff_cols_portable.ini";
            }
            String cols_lv = string.Empty;
            foreach (ColumnHeader col in listView1.Columns)
            {
                cols_lv = cols_lv + col.Text.Trim() + Environment.NewLine;
            }
            File.WriteAllText(f_cols, cols_lv);
        }

        private void pre_add_col()
        {
            listView1.Invoke(new MethodInvoker(delegate
            {
                if (listView1.Items.Count == 0 || tabControl1.SelectedIndex != 0) return;
            }));
        }

        private void BG_add_col_res_DoWork(object sender, DoWorkEventArgs e)
        {
            Disable_Controls();
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.btn_pause.Enabled = false);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.pg_adding.Visible = true);
            this.InvokeEx(f => f.pg_adding.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Visible = true);
            this.InvokeEx(f => f.txt_adding_p.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Refresh());
            this.InvokeEx(f => f.LB_Wait.Visible = true);
            this.InvokeEx(f => f.LB_Wait.Enabled = true);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Minimum = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.btn_cancel_add.Visible = true);
            this.InvokeEx(f => f.btn_cancel_add.Enabled = true);
            canceled_file_adding = false;

            int i = 0;
            listView1.Invoke(new MethodInvoker(delegate
            {
                listView1.BeginUpdate();
                foreach (ListViewItem item in listView1.Items)
                {
                    String itfull = item.SubItems[1].Text + "\\" + item.Text;

                    Boolean has_streams = false;
                    Boolean has_video = false;

                    if (canceled_file_adding == false)
                    {
                        String ff_frames = String.Empty;
                        Process get_frames = new Process();
                        get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "Mediainfo.exe");
                        String ffprobe_frames = "--Inform=Video;%Width%" + "x" + "%Height%";
                        get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + itfull + '\u0022';

                        get_frames.StartInfo.RedirectStandardOutput = true;
                        get_frames.StartInfo.RedirectStandardError = true;
                        get_frames.StartInfo.UseShellExecute = false;
                        get_frames.StartInfo.CreateNoWindow = true;
                        get_frames.EnableRaisingEvents = true;
                        get_frames.Start();
                        ff_frames = get_frames.StandardOutput.ReadLine();
                        get_frames.WaitForExit();
                        if (get_frames.ExitCode == 0)
                        {
                            if (ff_frames != null)
                            {
                                has_streams = true;
                                if (ff_frames.Length == 0)
                                {
                                    ff_frames = "-";
                                }
                            }
                            else
                            {
                                ff_frames = "-";
                            }
                        }
                        else
                        {
                            ff_frames = "-";
                        }

                        i++;

                        if (ff_frames.Length > 1 && ff_frames.Contains("x") == true)
                        {
                            listView1.Items[item.Index].SubItems.Add(ff_frames.Substring(0, ff_frames.IndexOf("x")));
                            listView1.Items[item.Index].SubItems.Add(ff_frames.Substring(ff_frames.IndexOf("x") + 1, ff_frames.Length - ff_frames.IndexOf("x") - 1));
                        }
                        else
                        {
                            listView1.Items[item.Index].SubItems.Add("-");
                            listView1.Items[item.Index].SubItems.Add("-");
                        }
                        //}

                        LB_Wait.Text = FFBatch.Properties.Strings.add_col1;
                        LB_Wait.Refresh();
                        pg_adding.Value = pg_adding.Value + 1;
                        pg_adding.Refresh();
                        txt_adding_p.Text = (i * 100 / pg_adding.Maximum).ToString() + "%";
                        TaskbarProgress.SetValue(this.Handle, i * 100 / pg_adding.Maximum, 100);
                        txt_adding_p.Refresh();
                    }
                    else
                    {
                        timer_adding.Stop();
                        txt_add_remain.Text = String.Empty;
                        txt_add_remain.Visible = false;
                        txt_add_remain.Refresh();
                        break;
                    }
                }
                this.InvokeEx(f => f.listView1.EndUpdate());
            }));

            timer_adding.Stop();
            this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
            this.InvokeEx(f => f.txt_add_remain.Visible = false);
            this.InvokeEx(f => f.txt_add_remain.Refresh());
            this.InvokeEx(f => f.LB_Wait.Text = "");
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
        }

        private void BG_add_col_res_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            end_bg_filters();
        }

        private void BG_Add_col_vcodec_DoWork(object sender, DoWorkEventArgs e)
        {
            Disable_Controls();
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.btn_pause.Enabled = false);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.pg_adding.Visible = true);
            this.InvokeEx(f => f.pg_adding.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Visible = true);
            this.InvokeEx(f => f.txt_adding_p.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Refresh());
            this.InvokeEx(f => f.LB_Wait.Visible = true);
            this.InvokeEx(f => f.LB_Wait.Enabled = true);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Minimum = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.btn_cancel_add.Visible = true);
            this.InvokeEx(f => f.btn_cancel_add.Enabled = true);
            canceled_file_adding = false;

            int i = 0;
            listView1.Invoke(new MethodInvoker(delegate
            {
                listView1.BeginUpdate();
                foreach (ListViewItem item in listView1.Items)
                {
                    String itfull = item.SubItems[1].Text + "\\" + item.Text;

                    Boolean has_streams = false;
                    Boolean has_video = false;

                    if (canceled_file_adding == false)
                    {
                        String ff_frames = String.Empty;
                        Process get_frames = new Process();
                        get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "Mediainfo.exe");
                        String ffprobe_frames = "--Inform=Video;%Format%" + "\\n";
                        get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + itfull + '\u0022';
                        get_frames.StartInfo.RedirectStandardOutput = true;
                        get_frames.StartInfo.RedirectStandardError = true;
                        get_frames.StartInfo.UseShellExecute = false;
                        get_frames.StartInfo.CreateNoWindow = true;
                        get_frames.EnableRaisingEvents = true;
                        get_frames.Start();
                        ff_frames = get_frames.StandardOutput.ReadLine();
                        get_frames.WaitForExit();
                        if (get_frames.ExitCode == 0)
                        {
                            if (ff_frames != null)
                            {
                                has_streams = true;
                                if (ff_frames.Length == 0)
                                {
                                    ff_frames = "-";
                                }
                            }
                            else
                            {
                                ff_frames = "-";
                            }
                        }
                        else
                        {
                            ff_frames = "-";
                        }

                        i++;

                        if (ff_frames.Length > 1)
                        {
                            this.InvokeEx(f => listView1.Items[item.Index].SubItems.Add(ff_frames));
                        }
                        else
                        {
                            this.InvokeEx(f => listView1.Items[item.Index].SubItems.Add("-"));
                        }
                        //}

                        this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.add_col1);
                        this.InvokeEx(f => f.LB_Wait.Refresh());
                        this.InvokeEx(f => f.pg_adding.Value = pg_adding.Value + 1);
                        this.InvokeEx(f => f.pg_adding.Refresh());
                        this.InvokeEx(f => f.txt_adding_p.Text = (i * 100 / pg_adding.Maximum).ToString() + "%");
                        this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, i * 100 / pg_adding.Maximum, 100));
                        this.InvokeEx(f => f.txt_adding_p.Refresh());
                    }
                    else
                    {
                        timer_adding.Stop();
                        this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
                        this.InvokeEx(f => f.txt_add_remain.Visible = false);
                        this.InvokeEx(f => f.txt_add_remain.Refresh());
                        break;
                    }
                }
                this.InvokeEx(f => f.listView1.EndUpdate());
            }));

            timer_adding.Stop();
            this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
            this.InvokeEx(f => f.txt_add_remain.Visible = false);
            this.InvokeEx(f => f.txt_add_remain.Refresh());
            this.InvokeEx(f => f.LB_Wait.Text = "");
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
        }

        private void BG_Add_col_vcodec_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            end_bg_filters();
        }

        private void listView1_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.Control && e.KeyCode == Keys.A)
            {
                foreach (ListViewItem item in listView1.Items) item.Selected = true;
                return;
            }

            if (listView1.Items.Count == 0)
            {
                if (e.Control && e.KeyCode == Keys.V)
                {
                    if (Directory.Exists(Clipboard.GetText()))
                    {
                        add_paste_folder(Clipboard.GetText());
                    }
                }
            }
        }

        private void BG_Add_col_Acodec_DoWork(object sender, DoWorkEventArgs e)
        {
            Disable_Controls();
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.btn_pause.Enabled = false);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.pg_adding.Visible = true);
            this.InvokeEx(f => f.pg_adding.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Visible = true);
            this.InvokeEx(f => f.txt_adding_p.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Refresh());
            this.InvokeEx(f => f.LB_Wait.Visible = true);
            this.InvokeEx(f => f.LB_Wait.Enabled = true);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Minimum = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.btn_cancel_add.Visible = true);
            this.InvokeEx(f => f.btn_cancel_add.Enabled = true);
            canceled_file_adding = false;

            int i = 0;
            listView1.Invoke(new MethodInvoker(delegate
            {
                listView1.BeginUpdate();
                foreach (ListViewItem item in listView1.Items)
                {
                    String itfull = item.SubItems[1].Text + "\\" + item.Text;

                    Boolean has_streams = false;
                    Boolean has_video = false;

                    if (canceled_file_adding == false)
                    {
                        String ff_frames = String.Empty;
                        Process get_frames = new Process();
                        get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "Mediainfo.exe");
                        String ffprobe_frames = "--Inform=Audio;%Format%" + "\\n";
                        get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + itfull + '\u0022';
                        get_frames.StartInfo.RedirectStandardOutput = true;
                        get_frames.StartInfo.RedirectStandardError = true;
                        get_frames.StartInfo.UseShellExecute = false;
                        get_frames.StartInfo.CreateNoWindow = true;
                        get_frames.EnableRaisingEvents = true;
                        get_frames.Start();
                        ff_frames = get_frames.StandardOutput.ReadLine();
                        get_frames.WaitForExit();
                        if (get_frames.ExitCode == 0)
                        {
                            if (ff_frames != null)
                            {
                                has_streams = true;
                                if (ff_frames.Length == 0)
                                {
                                    ff_frames = "-";
                                }
                            }
                            else
                            {
                                ff_frames = "-";
                            }
                        }
                        else
                        {
                            ff_frames = "-";
                        }

                        i++;

                        if (ff_frames.Length > 1)
                        {
                            this.InvokeEx(f => listView1.Items[item.Index].SubItems.Add(ff_frames));
                        }
                        else
                        {
                            this.InvokeEx(f => listView1.Items[item.Index].SubItems.Add("-"));
                        }
                        //}

                        this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.add_col1);
                        this.InvokeEx(f => f.LB_Wait.Refresh());
                        this.InvokeEx(f => f.pg_adding.Value = pg_adding.Value + 1);
                        this.InvokeEx(f => f.pg_adding.Refresh());
                        this.InvokeEx(f => f.txt_adding_p.Text = (i * 100 / pg_adding.Maximum).ToString() + "%");
                        this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, i * 100 / pg_adding.Maximum, 100));
                        this.InvokeEx(f => f.txt_adding_p.Refresh());
                    }
                    else
                    {
                        timer_adding.Stop();
                        this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
                        this.InvokeEx(f => f.txt_add_remain.Visible = false);
                        this.InvokeEx(f => f.txt_add_remain.Refresh());
                        break;
                    }
                }
                this.InvokeEx(f => f.listView1.EndUpdate());
            }));

            timer_adding.Stop();
            this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
            this.InvokeEx(f => f.txt_add_remain.Visible = false);
            this.InvokeEx(f => f.txt_add_remain.Refresh());
            this.InvokeEx(f => f.LB_Wait.Text = "");
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
        }

        private void BG_Add_col_Acodec_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            end_bg_filters();
        }

        private void cti1_cols_Click(object sender, EventArgs e)
        {
            btn_add_col.PerformClick();
        }

        private void listView1_ColumnWidthChanged(object sender, ColumnWidthChangedEventArgs e)
        {
            if (listView1.Columns[e.ColumnIndex].Width < _minimumColumnWidth)
            {
                if (e.ColumnIndex == 5)
                {
                    listView1.Columns[e.ColumnIndex].Width = 104;
                }
                if (e.ColumnIndex == 0)
                {
                    listView1.Columns[e.ColumnIndex].Width = 204;
                }
                if (e.ColumnIndex == 1)
                {
                    listView1.Columns[e.ColumnIndex].Width = 204;
                }

                if (e.ColumnIndex != 5 && e.ColumnIndex != 0 && e.ColumnIndex != 1)
                {
                    listView1.Columns[e.ColumnIndex].Width = _minimumColumnWidth;
                }
            }
        }

        private void cti_remove_col_Click(object sender, EventArgs e)
        {
            remove_last_col();
            list_cols();
        }

        private void remove_last_col()
        {
            Boolean has_resol = false;
            if (listView1.Columns.Count > 6)
            {
                foreach (ColumnHeader col in listView1.Columns)
                {
                    if (col.Index == listView1.Columns.Count - 1)
                    {
                        if (col.Text.Contains(FFBatch.Properties.Strings.height)) has_resol = true;
                        listView1.Columns.Remove(col);
                    }
                }
            }

            if (has_resol == true)
            {
                foreach (ColumnHeader col in listView1.Columns)
                {
                    if (col.Index == listView1.Columns.Count - 1)
                    {
                        if (col.Text.Contains(FFBatch.Properties.Strings.width))
                            listView1.Columns.Remove(col);
                    }
                }
            }
            refresh_full();
        }

        private void chk_trim2_CheckedChanged(object sender, EventArgs e)
        {
            String f_trim = String.Empty;
            if (is_portable == false)
            {
                f_trim = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_trim.ini";
            }
            else
            {
                f_trim = port_path + "ff_trim_portable.ini";
            }

            if (chk_trim2.CheckState == CheckState.Checked)
            {
                File.WriteAllText(f_trim, String.Empty);
            }
            else
            {
                try
                {
                    File.Delete(f_trim);
                }
                catch
                {
                    MessageBox.Show(FFBatch.Properties.Strings.err_set, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        private void pic_title_Click(object sender, EventArgs e)
        {
            menu_about.PerformClick();
        }

        private void menu_split_Click(object sender, EventArgs e)
        {
            AeroWizard6 wiz_split = new AeroWizard6();
            wiz_split.pr1_first_params = "";
            wiz_split.StartPosition = FormStartPosition.CenterParent;
            wiz_split.list_count = listView1.Items.Count;
            wiz_split.combo_ext.SelectedIndex = 0;
            wiz_split.combo_Seconds.SelectedIndex = 2;
            wiz_split.ShowDialog();
            if (wiz_split.canceled == true) return;
            split_by_size = wiz_split.combo_size.Text;

            if (wiz_split.save_preset == false)
            {
                combo_presets.Text = FFBatch.Properties.Strings.new_preset;
                txt_parameters.Text = wiz_split.pr1_first_params;
                txt_format.Text = "nul";
            }
            else
            {
                combo_presets.SelectedIndex = combo_presets.Items.Count - 1;
                combo_presets.Text = wiz_split.txt_preset_name.Text;
                txt_parameters.Text = wiz_split.pr1_first_params;
                txt_format.Text = "nul";
                btn_save_preset.PerformClick();
            }
            if (wiz_split.start_enc == true) btn_seq.PerformClick();
        }

        private void btn_track_up_Click(object sender, EventArgs e)
        {
            if (list_tracks.SelectedItems.Count == 1)
            {
                lvwColumnSorter_Full.Order = SortOrder.None;
                var currentIndex = list_tracks.SelectedItems[0].Index;
                var item = list_tracks.Items[list_tracks.SelectedIndices[0]];
                if (currentIndex > 0) // && list_tracks.Items[currentIndex - 1].SubItems[5].Text == FFBatch.Properties.Strings.queued)
                {
                    list_tracks.Items.RemoveAt(currentIndex);
                    list_tracks.Items.Insert(currentIndex - 1, item);
                }
            }
        }

        private void btn_track_down_Click(object sender, EventArgs e)
        {
            if (list_tracks.SelectedItems.Count == 1)
            {
                lvwColumnSorter_Full.Order = SortOrder.None;
                var currentIndex = list_tracks.SelectedItems[0].Index;
                var item = list_tracks.Items[list_tracks.SelectedIndices[0]];
                if (currentIndex > -1 && currentIndex < list_tracks.Items.Count - 1)
                {
                    list_tracks.Items.RemoveAt(currentIndex);
                    list_tracks.Items.Insert(currentIndex + 1, item);
                }
            }
        }

        public void add_paste_folder(string path1)
        {
            Pg1.Focus();
            if (!File.Exists(Path.Combine(Application.StartupPath, "ffmpeg.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_ffmpeg, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (listView1.Items.Count == 0)
            {
                list_not_empty = false;
            }
            else
            {
                list_not_empty = true;
            }

            if (tabControl1.SelectedIndex == 1)
            {
                change_tab_1 = true;
            }
            if (tabControl1.SelectedIndex == 2)
            {
                change_tab_2 = true;
            }
            if (!Directory.Exists(path1))
            {
                MessageBox.Show(FFBatch.Properties.Strings.path_not, FFBatch.Properties.Strings.path_not2);
                return;
            }
            Form11_2 frm11_2 = new Form11_2();
            Task t2 = Task.Run(() =>
            {
                frm11_2.label1.Text = FFBatch.Properties.Strings.reading_path;
                frm11_2.ShowDialog();
            });
            Thread.Sleep(100);
            List<string> files2 = new List<string>();
            int fl = 0;
            foreach (string file in Directory.GetFiles(path1))
            {
                if (!File.GetAttributes(file).HasFlag(FileAttributes.Hidden))
                {
                    files2.Add(file);
                    fl = fl + 1;
                    if (frm11_2.abort_validate == true) return;
                    else
                    {
                        try
                        {
                            frm11_2.Invoke(new MethodInvoker(delegate
                            {
                                frm11_2.label2.Text = fl.ToString() + " " + FFBatch.Properties.Strings.files;
                            }));
                        }
                        catch { }
                    }
                }
            }
            int num_drop = files2.Count();

            if (add_subfs == true)
            {
                string[] dirs = Directory.GetDirectories(path1);

                foreach (string ds in dirs)
                {
                    try
                    {
                        foreach (string f in Directory.GetFiles(ds, "*.*", System.IO.SearchOption.AllDirectories))
                        {
                            if (!File.GetAttributes(f).HasFlag(FileAttributes.Hidden))
                            {
                                files2.Add(f);
                                fl = fl + 1;
                                num_drop++;
                                if (frm11_2.abort_validate == true) return;
                                else
                                {
                                    try
                                    {
                                        frm11_2.Invoke(new MethodInvoker(delegate
                                        {
                                            frm11_2.label2.Text = fl.ToString() + " " + FFBatch.Properties.Strings.files;
                                        }));
                                    }
                                    catch { }
                                }
                            }
                        }
                    }
                    catch (System.Exception excpt)
                    {
                        try
                        {
                        }
                        catch { }
                        var a = MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + excpt.Message + " " + FFBatch.Properties.Strings2.contin, FFBatch.Properties.Strings.error3, MessageBoxButtons.OKCancel, MessageBoxIcon.Error);
                        if (a == DialogResult.Cancel)
                        {
                            try
                            {
                                frm11_2.Invoke(new MethodInvoker(delegate
                                {
                                    frm11_2.Dispose();
                                }));
                            }
                            catch { }

                            return;
                        }
                        try
                        {
                            frm11_2.Invoke(new MethodInvoker(delegate
                            {
                                frm11_2.TopMost = true;
                                frm11_2.TopMost = false;
                            }));
                        }
                        catch { }
                    }
                }
            }
            Thread.Sleep(100);
            try
            {
                frm11_2.Invoke(new MethodInvoker(delegate
                {
                    frm11_2.Dispose();
                }));
            }
            catch { }

            if (num_drop == 0)
            {
                var a = MessageBox.Show(FFBatch.Properties.Strings.folder_empty, FFBatch.Properties.Strings.information, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            files_to_add = files2;
            canceled_file_adding = false;
            btn_cancel_add.Enabled = true;
            btn_cancel_add.Visible = true;
            btn_cancel_add.Refresh();
            BG_Files.RunWorkerAsync();
        }

        private void btn_add_folders_MouseDown(object sender, MouseEventArgs e)
        {
            if (e.Button == MouseButtons.Right)
            {
                show_path_dialog();
            }
        }

        private void show_path_dialog()
        {
            Form19 frm19 = new Form19();
            frm19.subfs = add_subfs;
            frm19.ShowDialog();
            if (frm19.canceled == false)
            {
                add_paste_folder(frm19.textBox1.Text);
            }
        }

        private void ctm_paste_path_Click(object sender, EventArgs e)
        {
            show_path_dialog();
        }

        private void item_up_MouseClick(object sender, MouseEventArgs e)
        {
        }

        private void button1_Click_3(object sender, EventArgs e)
        {
        }

        private void button3_Click_1(object sender, EventArgs e)
        {
        }

        private void ct_move_top_Click(object sender, EventArgs e)
        {
            if (listView1.SelectedItems.Count == 1 && listView1.SelectedItems[0].SubItems[5].Text == FFBatch.Properties.Strings.queued)
            {
                lvwColumnSorter_Full.Order = SortOrder.None;
                var currentIndex = listView1.SelectedItems[0].Index;
                var item = listView1.Items[listView1.SelectedIndices[0]];
                if (currentIndex > 0 && listView1.Items[currentIndex - 1].SubItems[5].Text == FFBatch.Properties.Strings.queued)
                {
                    listView1.Items.RemoveAt(currentIndex);
                    listView1.Items.Insert(0, item);
                }
            }
            else MessageBox.Show(FFBatch.Properties.Strings.only_qu);
        }

        private void ct_move_bottom_Click(object sender, EventArgs e)
        {
            if (listView1.SelectedItems.Count == 1 && listView1.SelectedItems[0].SubItems[5].Text == FFBatch.Properties.Strings.queued)
            {
                lvwColumnSorter_Full.Order = SortOrder.None;
                var currentIndex = listView1.SelectedItems[0].Index;
                var item = listView1.Items[listView1.SelectedIndices[0]];
                if (currentIndex > -1 && currentIndex < listView1.Items.Count - 1)
                {
                    listView1.Items.RemoveAt(currentIndex);
                    listView1.Items.Insert(listView1.Items.Count, item);
                }
            }
            else MessageBox.Show(FFBatch.Properties.Strings.only_qu);
        }

        private void ct3_up_Click(object sender, EventArgs e)
        {
            if (list_tracks.SelectedItems.Count == 1)
            {
                lvwColumnSorter_Full.Order = SortOrder.None;
                var currentIndex = list_tracks.SelectedItems[0].Index;
                var item = list_tracks.Items[list_tracks.SelectedIndices[0]];
                if (currentIndex > 0)
                {
                    list_tracks.Items.RemoveAt(currentIndex);
                    list_tracks.Items.Insert(currentIndex - 1, item);
                }
            }
        }

        private void ct3_down_Click(object sender, EventArgs e)
        {
            if (list_tracks.SelectedItems.Count == 1)
            {
                lvwColumnSorter_Full.Order = SortOrder.None;
                var currentIndex = list_tracks.SelectedItems[0].Index;
                var item = list_tracks.Items[list_tracks.SelectedIndices[0]];
                if (currentIndex > -1 && currentIndex < list_tracks.Items.Count - 1)
                {
                    list_tracks.Items.RemoveAt(currentIndex);
                    list_tracks.Items.Insert(currentIndex + 1, item);
                }
            }
        }

        private void ct_ren_urls_Click(object sender, EventArgs e)
        {
            Form20 frm20 = new Form20();
            frm20.ShowDialog();
            if (frm20.canceled == false)
            {
                if (dg1.SelectedCells.Count == 1)
                {
                    for (int i = dg1.SelectedCells[0].RowIndex; i < dg1.RowCount; i++)
                    {
                        if (i < 10) dg1.Rows[i].Cells[4].Value = frm20.textBox1.Text + "0" + (i + 1 - dg1.SelectedCells[0].RowIndex).ToString();
                        else dg1.Rows[i].Cells[4].Value = frm20.textBox1.Text + (i + 1 - dg1.SelectedCells[0].RowIndex).ToString();
                    }
                }
                if (dg1.SelectedCells.Count > 1)
                {
                    if (dg1.Rows[0].Cells[4].Selected == false && dg1.Rows[0].Cells[5].Selected == false)
                    {
                        foreach (DataGridViewCell cell in dg1.SelectedCells)
                        {
                            dg1.Rows[cell.RowIndex].Cells[4].Value = frm20.textBox1.Text + cell.RowIndex.ToString();
                        }
                    }
                    else
                    {
                        foreach (DataGridViewCell cell in dg1.SelectedCells)
                        {
                            dg1.Rows[cell.RowIndex].Cells[4].Value = frm20.textBox1.Text + (cell.RowIndex + 1).ToString();
                        }
                    }
                }
            }
        }

        private void dg1_CellClick(object sender, DataGridViewCellEventArgs e)
        {
            try
            {
                pic_frame.Image = dg_thumbs[dg1.SelectedCells[0].RowIndex];
                if (pic_frame.Image == null) pic_frame.Image = pic_frame.InitialImage;
                lbl_a_th.Text = "-";
                lbl_s_th.Text = "-";
                lbl_v_th.Text = "-";
                lbl_gb_th.Text = "-";
            }
            catch { }
        }

        private void btn_all_yt_Click(object sender, EventArgs e)
        {
            String paramet = "";
            String params1 = "";

            if (chk_m3u_params.CheckState == CheckState.Unchecked) params1 = "";
            String m3u_output_ext = combo_ext_m3u.SelectedItem.ToString();

            if (chk_best_yt.Checked) bestv_a = " -f bestvideo[ext=mp4]+bestaudio[ext=m4a]/bestvideo+bestaudio";
            else bestv_a = String.Empty;

            String down_speed = "";
            if (chk_down_limit.Checked == true) down_speed = " -r " + Convert.ToInt32(n_down_speed.Value).ToString() + "M";
            String embed_subs = "";
            if (chk_yout_subs.Checked == true) embed_subs = " --embed-subs --all-subs";
            String auto_subs = "";
            if (chk_auto_subs.Checked == true)
            {
                auto_subs = " --write-auto-sub --sub-lang en,es,it,pt,de,hi,ar,cn";
                if (chk_yout_subs.Checked == true) embed_subs = " --embed-subs";
            }
            String embed_meta = "";

            if (chk_embed_meta.Checked == true) embed_meta = " --add-metadata";
            String write_subs = "";
            if (chk_save_subtitles.Checked == true) embed_meta = " --write-sub";
            String convert_subs = "";
            if (chk_convert_srt.Checked == true) embed_meta = " --convert-subs=srt";
            String clear_cache = "";
            if (chk_cache_yt.Checked == true) clear_cache = " --rm-cache-dir";

            paramet = params1 + bestv_a + clear_cache + down_speed + embed_subs + auto_subs + write_subs + convert_subs;

            Form23 frm23 = new Form23();
            frm23.txt_path_main.Text = txt_path_m3u.Text;
            if (chk_open_compl.Checked) frm23.open_complete = true;
            else frm23.open_complete = false;

            frm23.pre_params = paramet;
            frm23.txt_channel.Text = current_channel;
            frm23.ShowDialog();
            current_channel = frm23.txt_channel.Text;
        }

        private void Timer_display_Tick(object sender, EventArgs e)
        {
            display_eta = !display_eta;
        }

        private void update_yt_dl_2()
        {
            if (is_portable == true) return;

            Boolean writable = false;
            try
            {
                FileStream fs = File.Create(Path.Combine(Application.StartupPath, Path.GetRandomFileName()), 1, FileOptions.DeleteOnClose);
                writable = true;
            }
            catch
            {
                writable = false;
            }

            Task t = Task.Run(() =>
            {
                String path = Path.Combine(Application.StartupPath, "yt-dlp.exe");
                String param = "-U";
                Process ff_ext = new Process();
                ff_ext.StartInfo.FileName = path;
                ff_ext.StartInfo.Arguments = param;
                ff_ext.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;
                ff_ext.StartInfo.RedirectStandardOutput = true;
                ff_ext.StartInfo.RedirectStandardError = true;
                ff_ext.StartInfo.UseShellExecute = false;
                ff_ext.StartInfo.CreateNoWindow = true;
                ff_ext.EnableRaisingEvents = true;
                if (writable == false) ff_ext.StartInfo.Verb = "runas";
                String read_line = "";
                try
                {
                    ff_ext.Start();

                    while (!ff_ext.StandardOutput.EndOfStream)
                    {
                        read_line = ff_ext.StandardOutput.ReadLine();
                        lbl_yl_name.Invoke(new MethodInvoker(delegate
                        {
                            lbl_yl_name.Text = read_line;
                            Refresh();
                            if (read_line.Contains("up-to-date"))
                            {
                                pic_ok.Visible = true;
                            }
                        }));
                    }
                    ff_ext.WaitForExit();
                    this.InvokeEx(f => f.pic_wait_1.Visible = false);
                }
                catch (Exception exc)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.error2 + " " + Environment.NewLine + Environment.NewLine + exc.Message, FFBatch.Properties.Strings.write_error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            });
        }

        private void btn_update_yt_Click_1(object sender, EventArgs e)
        {
            lbl_yl_name.Text = FFBatch.Properties.Strings.Downloading;
            //String current = lbl_yt_v.Text;
            pg_update_yl.Style = ProgressBarStyle.Continuous;
            pg_update_yl.Maximum = 100;
            pg_update_yl.Value = 0;

            if (btn_update_yt.Text == FFBatch.Properties.Strings.cancel)
            {
                wc_dl.CancelAsync();
                btn_update_yt.Text = FFBatch.Properties.Strings.update;
                lbl_yl_name.Text = "youtube-dl new";
                txt_up_output.Text = "";
                txt_up_output.Visible = false;
                pg_update_yl.Visible = false;
                foreach (Control ct in groupBox_m3u.Controls) ct.Enabled = true;
                return;
            }

            Boolean writable = false;
            try
            {
                FileStream fs = File.Create(Path.Combine(Application.StartupPath, Path.GetRandomFileName()), 1, FileOptions.DeleteOnClose);
                writable = true;
            }
            catch
            {
                writable = false;
            }
            foreach (Control ct in groupBox_m3u.Controls) ct.Enabled = false;
            btn_update_yt.Enabled = true; txt_up_output.Enabled = true; pic_ok.Enabled = true;
            //  lbl_yt_v.Enabled = true;

            wc_dl.DownloadProgressChanged += new DownloadProgressChangedEventHandler(wc_dl_DownloadProgressChanged);
            wc_dl.DownloadFileCompleted += new AsyncCompletedEventHandler(wc_dl_DownloadFileCompleted);

            btn_update_yt.Text = FFBatch.Properties.Strings.cancel;
            pg_update_yl.Visible = true;
            txt_up_output.Visible = true;

            vc_download = "yt-dlp.exe";
            wc_dl.DownloadFileAsync(new System.Uri(yl_latest), Path.Combine(Path.GetTempPath(), vc_download));
        }

        private void BG_check_ytdl_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            pic_wait_1.Visible = false;
            //btn_all_yt.Enabled = true;

            if (t_out_yt == true)
            {
                lbl_yl_name.Text = FFBatch.Properties.Strings.err_yt_u;
                pic_ok.Visible = false;
                pic_no_yt.Visible = true;
                pic_wait_1.Visible = false;
            }
        }

        private void dg1_KeyDown(object sender, KeyEventArgs e)
        {
            if (m3u_running == true || m3u_single_running == true) return;
            if (dg1.RowCount == 0)
            {
                if (e.Control && e.KeyCode == Keys.V)
                {
                    if (Clipboard.GetText().ToLower().Contains("youtu.be") == true || Clipboard.GetText().ToLower().Contains("youtube.com") == true)
                    {
                        ct_paste_youtube.PerformClick();
                    }
                    else
                    {
                        if (Clipboard.GetText().ToLower().Contains("http") == true) ct_paste_m3u.PerformClick();
                    }
                }
            }
        }

        private void txt_paste_links_Click(object sender, EventArgs e)
        {
            dg1.Select();
            txt_paste_links.ForeColor = Color.LightGray;
        }

        private void BG_Single_yt_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            //File.Delete(Path.Combine(txt_path_m3u.Text, "pic_ffb_" + (dg1.RowCount + 1).ToString() + ".webp")); //File.Delete("pic1.jpg");
        }

        private void chk_yout_subs_CheckedChanged(object sender, EventArgs e)
        {
            if (chk_yout_subs.Checked == true) chk_auto_subs.Enabled = true;
            else chk_auto_subs.Enabled = false;
        }

        private void post_lang()
        {
            main_menu.Items[0].Text = FFBatch.Properties.Strings.file;
            main_menu.Items[1].Text = FFBatch.Properties.Strings.edit;
            main_menu.Items[2].Text = FFBatch.Properties.Strings.tools;
            main_menu.Items[3].Text = FFBatch.Properties.Strings.help;
            main_f_1.Text = FFBatch.Properties.Strings.clear_list;
            main_f_2.Text = FFBatch.Properties.Strings.add_file;
            main_f_3.Text = FFBatch.Properties.Strings.add_folder;
            main_f_5.Text = FFBatch.Properties.Strings.load_queue_file;
            main_f_4.Text = FFBatch.Properties.Strings.save_current_queue;
            main_f_exit.Text = FFBatch.Properties.Strings.exit;

            menu_refresh.Text = FFBatch.Properties.Strings.Refresh_list;
            menu_invalid.Text = FFBatch.Properties.Strings.Remove_invalid_items;
            menu_queue.Text = FFBatch.Properties.Strings.Reset_list_items_to_queued;
            menu_try.Text = FFBatch.Properties.Strings.Try_current_preset;
            menu_console.Text = FFBatch.Properties.Strings.Open_ffmpeg_console;
            menu_logs.Text = FFBatch.Properties.Strings.Display_last_log;
            menu_wizards.Text = FFBatch.Properties.Strings.Application_wizard;

            menu_reload_settings.Text = FFBatch.Properties.Strings.Reload_settings;
            menu_save_settings.Text = FFBatch.Properties.Strings.Save_settings;
            menu_reset.Text = FFBatch.Properties.Strings.Reset_to_factory_defaults;
            menu_ffm.Text = FFBatch.Properties.Strings.Replace_ffmpeg_executable;
            menu_media_info.Text = FFBatch.Properties.Strings.Display_multimedia_file_info;
            main_menu_streams.Text = FFBatch.Properties.Strings.Display_file_streams;
            menu_presets.Text = FFBatch.Properties.Strings.Multiple_presets_wizard;
            menu_two_pass_wizard.Text = FFBatch.Properties.Strings.Two_pass_encoding_wizard;
            wiz_silence_menu.Text = FFBatch.Properties.Strings.Detect_silence_wizard;
            menu_img_v.Text = Properties.Strings2.img_to_v;
            menu_extract_images.Text = FFBatch.Properties.Strings.Images_extraction_wizard;
            menu_split.Text = FFBatch.Properties.Strings.AV_split_wizard;
            menu_settings.Text = FFBatch.Properties.Strings.Settings;

            menu_guide.Text = FFBatch.Properties.Strings.User_guide;
            menu_news.Text = FFBatch.Properties.Strings.Project_news;
            menu_forum.Text = FFBatch.Properties.Strings.Help_forum;
            menu_updates.Text = FFBatch.Properties.Strings.Check_for_updates;
            menu_about.Text = FFBatch.Properties.Strings.About;

            combo_vin_col.Items.Clear();
            combo_vout_color.Items.Clear();
            combo_vin_col.Items.Add(Properties.Strings2.black);
            combo_vin_col.Items.Add(Properties.Strings2.white);
            combo_vin_col.Items.Add("Alpha");
            combo_vout_color.Items.Add(Properties.Strings2.black);
            combo_vout_color.Items.Add(Properties.Strings2.white);
            combo_vout_color.Items.Add("Alpha");

            listView1.Columns[0].Text = FFBatch.Properties.Strings.filename;
            listView1.Columns[1].Text = FFBatch.Properties.Strings.path;
            listView1.Columns[2].Text = FFBatch.Properties.Strings.file_type;
            listView1.Columns[3].Text = FFBatch.Properties.Strings.duration;
            listView1.Columns[4].Text = FFBatch.Properties.Strings.size;
            listView1.Columns[5].Text = FFBatch.Properties.Strings.status;

            listView2.Columns[0].Text = FFBatch.Properties.Strings.filename;

            listView3.Columns[0].Text = FFBatch.Properties.Strings.filename;
            listView3.Columns[1].Text = FFBatch.Properties.Strings.Subtitle_file;
            listView3.Columns[2].Text = FFBatch.Properties.Strings.Language;
            listView3.Columns[3].Text = FFBatch.Properties.Strings.Encoding;
            listView3.Columns[4].Text = FFBatch.Properties.Strings.Default;
            listView3.Columns[5].Text = FFBatch.Properties.Strings.status;

            list_tracks.Columns[0].Text = FFBatch.Properties.Strings.Stream_file;
            list_tracks.Columns[2].Text = FFBatch.Properties.Strings.Type;
            list_tracks.Columns[3].Text = FFBatch.Properties.Strings.Language;
            list_tracks.Columns[4].Text = FFBatch.Properties.Strings.Default_track;
            list_tracks.Columns[5].Text = FFBatch.Properties.Strings.Encoding_parameters;

            dg1.Columns[0].HeaderText = FFBatch.Properties.Strings.Thumbnail;
            dg1.Columns[1].HeaderText = FFBatch.Properties.Strings.URL;
            dg1.Columns[2].HeaderText = FFBatch.Properties.Strings.duration;
            dg1.Columns[3].HeaderText = FFBatch.Properties.Strings.Capture_time;
            dg1.Columns[4].HeaderText = FFBatch.Properties.Strings.Output_name;
            dg1.Columns[5].HeaderText = FFBatch.Properties.Strings.status;

            combo_shut.Items.Clear();
            combo_shut.Items.Add(FFBatch.Properties.Strings.Power_off);
            combo_shut.Items.Add(FFBatch.Properties.Strings.Hibernate);
            combo_shut.Items.Add(FFBatch.Properties.Strings.Suspend);
            combo_shut.Items.Add(FFBatch.Properties.Strings.Run_at_the_end);
            combo_shut.Items.Add(FFBatch.Properties.Strings.Run_on_each_file);

            ctm_add_files.Text = FFBatch.Properties.Strings.add_file;
            ctm_add_folder.Text = FFBatch.Properties.Strings.add_folder;
            ctm_paste_path.Text = FFBatch.Properties.Strings.Paste_write_path;
            ct1_paste_youtube.Text = FFBatch.Properties.Strings.Paste_YouTube_URL;
            ct1_paste_m3u.Text = FFBatch.Properties.Strings.Paste_M3u_URL;
            cti2.Text = FFBatch.Properties.Strings.Play_file;
            cti1.Text = FFBatch.Properties.Strings.Open_file_path;
            cti3.Text = FFBatch.Properties.Strings.Open_output_folder;
            ctdel.Text = FFBatch.Properties.Strings.Remove_file_from_list;
            ct2_del.Text = FFBatch.Properties.Strings.Remove_file_from_list;
            ct_move_top.Text = FFBatch.Properties.Strings.Move_item_to_top;
            ct_move_bottom.Text = FFBatch.Properties.Strings.Move_item_to_bottom;
            ctm1_queue.Text = FFBatch.Properties.Strings.Reset_item_status_to_queue;
            cti4.Text = FFBatch.Properties.Strings.Display_multimedia_file_info;
            ct1_streams.Text = FFBatch.Properties.Strings.Display_file_streams;
            ct1_total_frames.Text = FFBatch.Properties.Strings.Get_total_seconds_frames;
            cti1_cols.Text = FFBatch.Properties.Strings.Add_custom_column;
            cti_remove_col.Text = FFBatch.Properties.Strings.Remove_last_custom_column;
            cti4_2.Text = FFBatch.Properties.Strings.Show_hide_grid;
            cti5.Text = FFBatch.Properties.Strings.Set_as_trim_end_time;
            cti6.Text = FFBatch.Properties.Strings.Stop_task;
            ctm1_encode.Text = Properties.Strings2.encode;

            ct2_all.Text = FFBatch.Properties.Strings.add_all_str;
            ct2_v.Text = FFBatch.Properties.Strings.add_vtrack;
            ct2_a.Text = FFBatch.Properties.Strings.add_atrack;
            ct2_s.Text = FFBatch.Properties.Strings.add_strack;
            combo_def_und_lang.Text = FFBatch.Properties.Strings.lang_tracks;
            ct2_str.Text = FFBatch.Properties.Strings.Display_file_streams;
            ct2_save_allstreams.Text = Properties.Strings2.save_all_str;

            ct3_default.Text = FFBatch.Properties.Strings.change_def;
            ct3_del.Text = FFBatch.Properties.Strings.remove_item;
            ct3_up.Text = FFBatch.Properties.Strings.move_up;
            ct3_down.Text = FFBatch.Properties.Strings.move_down;
            ct3_default_enc.Text = FFBatch.Properties.Strings.set_enc_def;
            ct3_encode_default.Text = FFBatch.Properties.Strings.reste_enc;
            ct3_combo_language.Text = FFBatch.Properties.Strings.item_lang;
            ct3_save_track.Text = FFBatch.Properties.Strings.save_track;

            ct4_browse.Text = FFBatch.Properties.Strings.brow_sub;
            ct4_del.Text = FFBatch.Properties.Strings.remove_item;
            ct4_conv.Text = FFBatch.Properties.Strings.conv_utf8;
            Combo_single_subs_lang.Text = FFBatch.Properties.Strings.sub_lang;

            ct_paste_youtube.Text = FFBatch.Properties.Strings.Paste_YouTube_URL;
            ct_paste_m3u.Text = FFBatch.Properties.Strings.Paste_M3u_URL;
            ct_remove_url.Text = FFBatch.Properties.Strings.rem_row;
            ct_del_m3u.Text = FFBatch.Properties.Strings.rem_blanks;
            ct_validate_url.Text = FFBatch.Properties.Strings.rem_err_rows;
            ct_ren_urls.Text = FFBatch.Properties.Strings.ren_out_fn;
            ct_show_urls.Text = FFBatch.Properties.Strings.dis_url_streams;
            ct_play_vlc.Text = FFBatch.Properties.Strings.play_vlc;
            ctm_stop_url.Text = FFBatch.Properties.Strings.Stop_task;
            txt_help_subs.Text = FFBatch.Properties.Strings.subs_help;
            combo_shut.SelectedIndex = 0;
            Combo_def_sub_mux.Items.Clear();
            Combo_def_sub_mux.Items.Add(Properties.Strings.yes);
            Combo_def_sub_mux.Items.Add(Properties.Strings.no);
            Create_Tooltips();
            btn_update.Text = Properties.Strings2.version + " " + Application.ProductVersion;
            //Add res col
            add_col_start();
        }

        private void remember_tab()
        {
            //Remember last tab

            String f_remember = String.Empty;
            if (is_portable == false)
            {
                f_remember = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_remember.ini";
            }
            else
            {
                f_remember = port_path + "ff_remember_portable.ini";
            }

            if (File.Exists(f_remember))
            {
                remember_last_tab = true;
                tabControl1.Invoke(new MethodInvoker(delegate
                {
                    tabControl1.SelectedIndex = 0;
                    tabControl1.SelectedIndex = Convert.ToInt16(File.ReadAllText(f_remember));
                }));
            }
            else
            {
                remember_last_tab = false;
            }
        }

        private void chk_autor_Click(object sender, EventArgs e)
        {
            Pg1.Focus();

            String f_autorun = String.Empty;
            String f_multi = String.Empty;
            if (is_portable == false)
            {
                f_autorun = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_autorun.ini";
                f_multi = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_autorun_m.ini";
            }
            else
            {
                f_autorun = port_path + "ff_autorun_portable.ini";
                f_autorun = port_path + "ff_autorun_m_portable.ini";
            }
            if (start_seq == false)
            {
                start_seq = !start_seq;
                File.WriteAllText(f_autorun, "");
                chk_autor.ImageIndex = 1;
                if (File.Exists(f_multi)) start_multi = true;
                else start_multi = false;
            }
            else
            {
                start_seq = !start_seq;
                chk_autor.ImageIndex = 0;
                start_seq = false;
                start_multi = false;
                try
                {
                    File.Delete(f_autorun);
                    File.Delete(f_multi);
                }
                catch
                {
                }
            }
        }

        private void chk_autor_MouseHover(object sender, EventArgs e)
        {
            toolTip01.AutoPopDelay = 5000;
            toolTip01.InitialDelay = 750;
            toolTip01.ReshowDelay = 500;
            toolTip01.ShowAlways = true;
            if (start_seq) toolTip01.SetToolTip(this.chk_autor, FFBatch.Properties.Strings2.autorun_en);
            else
            {
                toolTip01.SetToolTip(this.chk_autor, FFBatch.Properties.Strings2.autorun_dis);
            }
        }

        private void chk_autor_MouseLeave(object sender, EventArgs e)
        {
            toolTip01.SetToolTip(this.chk_autor, String.Empty);
        }

        private void menu_img_v_Click(object sender, EventArgs e)
        {
            AeroWizard7 wiz_img = new AeroWizard7();
            wiz_img.pr1_first_params = "";
            wiz_img.pr1_pre_params = "";
            wiz_img.StartPosition = FormStartPosition.CenterParent;
            wiz_img.list_count = listView1.Items.Count;
            wiz_img.ShowDialog();
            if (wiz_img.canceled == true) return;

            if (wiz_img.radio_1_v.Checked)
            {
                combo_presets.Text = FFBatch.Properties.Strings.new_preset;
                txt_parameters.Text = wiz_img.pr1_first_params;
                txt_pre_input.Text = wiz_img.pr1_pre_params;
                txt_format.Text = wiz_img.pr1_out_format;
                images_from_wiz = true;
                img_dur_wiz = wiz_img.pr1_img_dur;
                if (wiz_img.start_enc == true) btn_seq.PerformClick();
            }
            if (wiz_img.radio_multi_v.Checked)
            {
                combo_presets.Text = FFBatch.Properties.Strings.new_preset;
                txt_parameters.Text = wiz_img.pr1_first_params;
                txt_format.Text = wiz_img.pr1_out_format;
                images_time = wiz_img.pr1_imgs_time;
                images_from_wiz = true;
                img_aud_from_wiz = wiz_img.pr1_img_aud;
                img_dur_wiz = wiz_img.pr1_img_dur;
                btn_concat.PerformClick();
            }
        }

        private void btn_load_config_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            Boolean ver = false;
            ss_time_input.Text = "0:00:00.000";

            String f_fix_pre = String.Empty;
            if (is_portable == false)
            {
                f_fix_pre = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_fix_pre.ini";
            }
            else
            {
                f_fix_pre = port_path + "ff_fix_pre_portable.ini";
            }
            if (File.Exists(f_fix_pre))
            {
                fix_pre = true;
                txt_pre_input.Text = File.ReadAllText(f_fix_pre);
            }
            else
            {
                fix_pre = false;
                txt_pre_input.Text = "";
                txt_pre_input.BackColor = txt_parameters.BackColor;
            }

            txt_suffix.Text = "_FFB";

            combo_presets.Items.Clear();
            combo_presets.Items.Add(FFBatch.Properties.Strings.default_param);
            String path = String.Empty;
            String path_pr, path_pre = String.Empty;
            if (is_portable == false)
            {
                path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.ini";
                path_pr = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_presets.ini";
                path_pre = Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch_pre.ini";
            }
            else
            {
                path = port_path + "ff_batch_portable.ini";
                path_pr = port_path + "ff_presets_portable.ini";
                path_pre = port_path + "ff_batch_portable_pre.ini";
            }

            Boolean f_presets_exist = false;
            int linea = 0;
            if (File.Exists(path_pr)) f_presets_exist = true;

            combo_presets.SelectedIndex = combo_presets.FindString(FFBatch.Properties.Strings.default_param);

            foreach (string line in File.ReadLines(path))
            {
                linea = linea + 1;
                if (linea == 1)
                {
                    this.InvokeEx(f => f.txt_parameters.Text = line);
                    continue;
                }

                if (linea == 2)
                {
                    this.InvokeEx(f => f.txt_format.Text = line);
                    continue;
                }

                if (line == "Yes")

                {
                    this.InvokeEx(f => f.chk_open_compl.CheckState = CheckState.Checked);
                    continue;
                }

                if (line == "No")
                {
                    this.InvokeEx(f => f.chk_open_compl.CheckState = CheckState.Unchecked);
                    continue;
                }

                //if (linea == 4)
                //{
                if (line == "Vn")
                {
                    this.InvokeEx(f => f.chk_suffix.CheckState = CheckState.Unchecked);
                    continue;
                }
                if (line.Length > 1 && line.Substring(0, 2) == "Vs")
                {
                    this.InvokeEx(f => f.chk_suffix.CheckState = CheckState.Checked);
                    this.InvokeEx(f => f.txt_suffix.Text = line.Substring(3, line.Length - 3));
                    continue;
                }
                //}

                if (line == "grid_yes")
                {
                    this.InvokeEx(f => f.listView1.GridLines = true);
                    this.InvokeEx(f => f.listView2.GridLines = true);
                    this.InvokeEx(f => f.listView3.GridLines = true);
                    continue;
                }
                if (line == "grid_no")
                {
                    this.InvokeEx(f => f.listView1.GridLines = false);
                    this.InvokeEx(f => f.listView2.GridLines = false);
                    this.InvokeEx(f => f.listView3.GridLines = false);
                    continue;
                }

                if (line == "keep_yes")
                {
                    this.InvokeEx(f => f.checkBox1.CheckState = CheckState.Checked);
                    continue;
                }
                if (line == "keep_no")
                {
                    this.InvokeEx(f => f.checkBox1.CheckState = CheckState.Unchecked);
                    continue;
                }

                if (line == "subf_yes")
                {
                    this.InvokeEx(f => f.chk_subfolders.CheckState = CheckState.Checked);
                    add_subfs = true;
                    continue;
                }
                if (line == "subf_no")
                {
                    this.InvokeEx(f => f.chk_subfolders.CheckState = CheckState.Unchecked);
                    add_subfs = false;
                    continue;
                }
                if (f_presets_exist == false)
                {
                    if (line.Contains("Version") == true)
                    {
                        this.InvokeEx(f => f.txt_config_ver.Text = line.Replace("Version ", String.Empty));
                        continue;
                    }

                    if (line.Contains("PR: "))
                    {
                        this.InvokeEx(f => f.combo_presets.Items.Add(line.Substring(4, line.LastIndexOf("&") - 5)));
                        continue;
                    }
                }
            }
            if (f_presets_exist == true)
            {
                foreach (string line in File.ReadLines(path_pr))
                {
                    if (line.Length > 8)
                    {
                        if (line.Substring(0, 7).ToLower() == "version")
                        {
                            txt_config_ver.Text = line.Substring(8, line.Length - 8);
                            continue;
                        }
                    }

                    if (line.Contains("PR: "))
                    {
                        this.InvokeEx(f => f.combo_presets.Items.Add(line.Substring(4, line.LastIndexOf("&") - 5)));
                    }
                }
            }
            btn_save_config.ImageKey = "Save_settings_39.png";
        }

        private void BG_Pending_M_DoWork(object sender, DoWorkEventArgs e)
        {
            total_multi_duration = 0;

            listView1.Invoke(new MethodInvoker(delegate
            {
                foreach (ListViewItem item in listView1.Items)
                {
                    DateTime time2;
                    if (DateTime.TryParse(item.SubItems[3].Text, out time2))

                    {
                        total_multi_duration = total_multi_duration + TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds;
                    }
                }

                Pg1.Value = 0;
                Pg1.Maximum = list_global_proc.Items.Count * 100;
            }));

            warn_enc = 0;
            String hw_decode = String.Empty;

            cb_hwdecode.Invoke(new MethodInvoker(delegate
            {
                if (cb_hwdecode.SelectedItem.ToString() != "none")
                {
                    hw_decode = "-hwaccel " + cb_hwdecode.SelectedItem.ToString();
                }
            }));

            procs.Clear();
            multi_logs.Clear();
            multi_params.Clear();
            multi_speeds.Clear();
            multi_fps.Clear();

            lbl_speed.Invoke(new MethodInvoker(delegate
            {
                lbl_speed.Text = "";
            }));

            List<string> destis = new List<string>();
            List<string> list_lines = new List<string>();
            list_successful_m.Clear();
            list_failed_m.Clear();

            for (int ii = 0; ii < listView1.Items.Count; ii++)
            {
                procs.Add("proc_urls_" + ii.ToString(), new Process());
                destis.Add("destis_" + ii.ToString());
                multi_logs.Add("log_n_" + ii.ToString(), "");
                multi_params.Add("path_n_" + ii.ToString(), "");
            }

            listView1.Invoke(new MethodInvoker(delegate
            {
                foreach (ListViewItem item in listView1.Items)
                {
                    multi_speeds.Add("0");
                    multi_fps.Add("0");
                }
            }));

            ParallelOptions par_op = new ParallelOptions();
            CancellationTokenSource cts = new System.Threading.CancellationTokenSource();
            par_op.CancellationToken = cts.Token;
            par_op.MaxDegreeOfParallelism = Convert.ToInt16(n_threads.Value);

            opened_m = false;
            aborted = false;
            Decimal tot_frames2 = 0;
            warn_space = true;

            IEnumerable<int> items_lv = Enumerable.Range(0, listView1.Items.Count);

            Disable_Controls();
            this.InvokeEx(f => f.btn_add_files.Enabled = true);

            ParallelLoopResult result = new ParallelLoopResult();

            try
            {
                result = Parallel.ForEach(items_lv.AsParallel().AsOrdered(), par_op, (file_int) =>
                {
                    Task
                        .Factory
                        .StartNew(() =>
                        {
                            if (cancelados_paralelos == true || aborted == true)
                            {
                                cts.Cancel();
                                timer1.Stop();
                                timer_tasks.Stop();
                                working = false;
                                multi_running = false;
                                return;
                            }

                            Boolean skipped = false;
                            Boolean encoded = false;
                            String fullPath = "";
                            String item_capture_time = String.Empty;
                            Double total_prog = 0;
                            Double row_duration = 0;
                            Boolean valid_prog2 = false;
                            TimeSpan time2;
                            int space_timer = 0;
                            String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");

                            listView1.Invoke(new MethodInvoker(delegate
                            {
                                if (listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text == FFBatch.Properties.Strings.skipped) skipped = true;
                                if (listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text != FFBatch.Properties.Strings.queued) encoded = true;
                                if (TimeSpan.TryParse(listView1.Items[Convert.ToInt32(file_int)].SubItems[3].Text, out time2))
                                {
                                    row_duration = TimeSpan.Parse(listView1.Items[Convert.ToInt32(file_int)].SubItems[3].Text).TotalSeconds - TimeSpan.Parse(ss_time_input.Text).TotalSeconds;
                                    valid_prog2 = true;
                                }
                                else
                                {
                                    row_duration = 0;
                                    valid_prog2 = false;
                                }
                                fullPath = listView1.Items[Convert.ToInt32(file_int)].SubItems[1].Text + "\\" + listView1.Items[Convert.ToInt32(file_int)].Text;
                            }));

                            if (skipped == true)
                            {
                                this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.skipped);
                                return;
                            }

                            if (encoded == true) return;

                            // Average frames
                            int fframes = 0;
                            Decimal dec = 0;
                            try
                            {
                                String ff_frames = String.Empty;

                                Process get_frames = new Process();
                                get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "mediainfo.exe");
                                String ffprobe_frames = "--Output=" + '\u0022' + "Video;%FrameCount%" + '\u0022';
                                get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + fullPath + '\u0022';
                                get_frames.StartInfo.RedirectStandardOutput = true;
                                get_frames.StartInfo.RedirectStandardError = true;
                                get_frames.StartInfo.UseShellExecute = false;
                                get_frames.StartInfo.CreateNoWindow = true;
                                get_frames.EnableRaisingEvents = true;
                                get_frames.Start();

                                ff_frames = get_frames.StandardOutput.ReadLine();
                                get_frames.WaitForExit(3000);

                                if (get_frames.ExitCode == 0)
                                {
                                    if (ff_frames != null)
                                    {
                                        dec = decimal.Parse(ff_frames);
                                        if (dec.ToString().Substring(dec.ToString().Length - 1, 1) == "0") dec = dec / 10;
                                    }
                                    else
                                    {
                                        dec = 0;
                                    }

                                    get_frames.Dispose();
                                    tot_frames2 = tot_frames2 + dec;
                                }
                            }
                            catch
                            {
                                dec = 0;
                            }

                            // End average frames

                            //Begin Shifting
                            String shifting = "";
                            if (chk_shift.Checked == true)
                            {
                                shifting = " -itsoffset " + Num_Shift.Value.ToString().Replace(",", ".") + " -i " + '\u0022' + fullPath + '\u0022' + " -map 1:v -map 0:a ";
                            }

                            //End Shifting

                            //Change Volume
                            String change_vol = "";
                            if (chk_vol.Checked == true)
                            {
                                change_vol = "-filter:a " + '\u0022' + "volume=" + vol_ch.Value.ToString() + "dB " + '\u0022' + " ";
                            }
                            //End change volume

                            if (txt_path_main.Text.Contains(".\\"))
                            {
                                if (txt_path_main.Text != ".\\")
                                {
                                    destis[file_int] = fullPath.Substring(0, fullPath.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
                                }
                                else
                                {
                                    destis[file_int] = Path.GetDirectoryName(fullPath);
                                }
                            }
                            else
                            {
                                if (checkBox1.CheckState == CheckState.Checked)
                                {
                                    String pre_dest = Path.GetDirectoryName(fullPath);
                                    destis[file_int] = Path.Combine(txt_path_main.Text, pre_dest.Substring(3, pre_dest.Length - 3));
                                }
                                else
                                {
                                    destis[file_int] = txt_path_main.Text;
                                }
                            }
                            if (!Directory.Exists(destis[file_int]))
                            {
                                Directory.CreateDirectory(destis[file_int]);
                            }

                            multi_dest = destis[file_int];

                            String pre_input_var = "";
                            if (txt_pre_input.Text != "")
                            {
                                pre_input_var = txt_pre_input.Text;
                            }

                            String pre_ss = "";
                            if (TimeSpan.Parse(ss_time_input.Text).TotalSeconds != 0)
                            {
                                pre_ss = " -ss " + ss_time_input.Text;
                            }

                            add_suffix = "";
                            if (chk_suffix.Checked == true && txt_suffix.Text != String.Empty)
                            {
                                add_suffix = txt_suffix.Text;
                                n_th_suffix = add_suffix;
                            }

                            String ext_output1 = txt_format.Text;
                            if (txt_format.Text.Length == 0)
                            {
                                ext_output1 = Path.GetExtension(fullPath);
                            }
                            else
                            {
                                ext_output1 = "." + txt_format.Text;
                            }
                            n_th_source_ext = ext_output1;

                            // textbox_params = txt_parameters.Text;

                            var tmp = procs["proc_urls_" + file_int.ToString()];
                            var n_logs = multi_logs["log_n_" + file_int.ToString()];
                            var tmp_params = multi_params["path_n_" + file_int.ToString()];
                            tmp_params = txt_parameters.Text;

                            if (txt_format.Text == "nul") ext_output1 = "nul";

                            String file2 = fullPath;
                            while (tmp_params.Contains("%fn"))
                            {
                                if (tmp_params.Contains("%fn"))
                                {
                                    tmp_params = tmp_params.Replace("%fn", Path.GetFileNameWithoutExtension(file2));
                                }
                            }
                            while (tmp_params.Contains("%fp"))
                            {
                                if (tmp_params.Contains("%fp"))
                                {
                                    tmp_params = tmp_params.Replace("%fp", Path.GetDirectoryName(file2));
                                }
                            }

                            while (tmp_params.Contains("%fd"))
                            {
                                if (tmp_params.Contains("%fd"))
                                {
                                    var path = Path.GetFullPath(file2);
                                    var dirName = Path.GetFileName(Path.GetDirectoryName(path));
                                    tmp_params = tmp_params.Replace("%fd", dirName);
                                }
                            }

                            while (tmp_params.Contains("%1"))
                            {
                                if (tmp_params.Contains("%1"))
                                {
                                    file2 = file2.Replace("\\", "\\\\\\\\");
                                    file2 = file2.Replace(":", ":" + "\\\\");
                                    tmp_params = tmp_params.Replace("%1", '\u0022' + file2 + '\u0022');
                                }
                            }

                            while (tmp_params.Contains("%2"))
                            {
                                if (tmp_params.Contains("%2"))
                                {
                                    file2 = file2.Replace("\\", "\\\\\\\\");
                                    file2 = file2.Replace(":", ":" + "\\\\");
                                    tmp_params = tmp_params.Replace("%2", '\u0022' + Path.Combine(System.IO.Path.GetDirectoryName(file2), Path.GetFileNameWithoutExtension(file2)) + '\u0022');
                                }
                            }

                            tmp.StartInfo.Arguments = hw_decode + " " + pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + fullPath + '\u0022' + " " + shifting + " " + " -y " + tmp_params + " " + change_vol + '\u0022' + destis[file_int] + "\\" + System.IO.Path.GetFileNameWithoutExtension(fullPath) + add_suffix + ext_output1 + '\u0022' + " -hide_banner";
                            if (ext_output1 == "nul") tmp.StartInfo.Arguments = hw_decode + " " + pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + fullPath + '\u0022' + " " + shifting + " " + tmp_params + " " + change_vol + " " + " -hide_banner";

                            String second_path = "";
                            if (ext_output1 == "nul")
                            {
                                String[] split = txt_parameters.Text.Split(' ');
                                for (int i = 0; i < split.Length; i++)
                                {
                                    if (split[i].Contains("\\") == true)
                                    {
                                        String pre_path = split[i].Replace("%fp", Path.GetDirectoryName(file2)).Replace("%fn", Path.GetFileNameWithoutExtension(file2)).Replace("%", "_");
                                        second_path = Path.GetDirectoryName(pre_path.Replace('\u0022', ' '));

                                        if (!Directory.Exists(second_path))
                                        {
                                            try
                                            {
                                                Directory.CreateDirectory(second_path);
                                            }
                                            catch
                                            {
                                            }
                                        }
                                    }
                                }
                            }

                            String current_out = destis[file_int] + "\\" + System.IO.Path.GetFileNameWithoutExtension(fullPath) + add_suffix + ext_output1;
                            Boolean to_overw = false;

                            if (chk_overw.CheckState == CheckState.Checked)
                            {
                                if (current_out == fullPath)
                                {
                                    tmp.StartInfo.Arguments = hw_decode + " " + pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + fullPath + '\u0022' + " " + shifting + " " + " -y " + tmp_params + " " + change_vol + '\u0022' + destis[file_int] + "\\" + System.IO.Path.GetFileNameWithoutExtension(fullPath) + "_fftemp" + add_suffix + ext_output1 + '\u0022' + " -hide_banner";
                                    to_overw = true;
                                }
                            }

                            if (current_out == fullPath && chk_overw.CheckState == CheckState.Unchecked)
                            {
                                MessageBox.Show(FFBatch.Properties.Strings.source_overw + Environment.NewLine + Environment.NewLine + current_out, FFBatch.Properties.Strings.overw_not, MessageBoxButtons.OK, MessageBoxIcon.Error);
                                this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                                working = false;
                                time_est_size = 0;
                                cts.Cancel();
                                Enable_Controls();
                                cancelados_paralelos = true;
                            }

                            //Monitor available space

                            DriveInfo dest_drive2 = new DriveInfo(Application.StartupPath);

                            FileInfo f_root2 = new FileInfo(current_out);
                            try
                            {
                                dest_drive2 = new DriveInfo(f_root2.Directory.Root.FullName);
                            }
                            catch { warn_space = false; }

                            if (dest_drive2.AvailableFreeSpace != null && warn_space == true)
                            {
                                if (dest_drive2.AvailableFreeSpace <= 500000000)
                                {
                                    DialogResult a = DialogResult.Cancel;

                                    a = MessageBox.Show(Properties.Strings2.warn_sp, Properties.Strings2.low_sp + " (" + (dest_drive2.AvailableFreeSpace / 1000000).ToString() + "MB)", MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation);
                                    if (a == DialogResult.Yes)
                                    {
                                        aborted = true;
                                        this.InvokeEx(f => f.lbl_est_size.Text = "");
                                        this.InvokeEx(f => f.lbl_bitrate.Text = "");
                                        cts.Cancel();
                                        return;
                                    }
                                }
                            }

                            //End monitor available space

                            if (verbose_logs == false) tmp.StartInfo.Arguments = tmp.StartInfo.Arguments + " -loglevel warning -stats";
                            if (cts.IsCancellationRequested == false)
                            {
                                tmp.StartInfo.FileName = ffm;
                                tmp.StartInfo.RedirectStandardInput = true;
                                tmp.StartInfo.RedirectStandardOutput = true;
                                tmp.StartInfo.RedirectStandardError = true;
                                tmp.StartInfo.UseShellExecute = false;
                                tmp.StartInfo.CreateNoWindow = true;
                                tmp.EnableRaisingEvents = true;

                                tmp.Start();

                                this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.processing);

                                combo_prio.Invoke(new MethodInvoker(delegate
                                {
                                    if (combo_prio.SelectedIndex != 2)
                                    {
                                        try
                                        {
                                            if (combo_prio.SelectedIndex == 0) tmp.PriorityClass = ProcessPriorityClass.High;
                                            if (combo_prio.SelectedIndex == 1) tmp.PriorityClass = ProcessPriorityClass.AboveNormal;
                                            if (combo_prio.SelectedIndex == 2) tmp.PriorityClass = ProcessPriorityClass.Normal;
                                            if (combo_prio.SelectedIndex == 3) tmp.PriorityClass = ProcessPriorityClass.BelowNormal;
                                            if (combo_prio.SelectedIndex == 4) tmp.PriorityClass = ProcessPriorityClass.Idle;
                                            Process[] localByName = Process.GetProcessesByName("FFBatch");
                                            if (localByName.Length == 1)
                                            {
                                                foreach (Process proc1 in localByName)
                                                {
                                                    if (combo_prio.SelectedIndex >= 2) proc1.PriorityClass = ProcessPriorityClass.Normal;
                                                    else proc1.PriorityClass = tmp.PriorityClass;
                                                }
                                            }
                                        }
                                        catch { }
                                    }
                                }));
                            }
                            else
                            {
                                timer1.Stop();
                                this.InvokeEx(f => f.listView1.Enabled = true);
                                working = false;
                                multi_running = false;
                                Enable_Controls();
                                cancelados_paralelos = false;
                                return;
                            }

                            this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.processing);

                            FileInfo f_root = new FileInfo(destis[file_int]);
                            DriveInfo dest_drive = new DriveInfo(Application.StartupPath);
                            try
                            {
                                dest_drive = new DriveInfo(f_root.Directory.Root.FullName);
                            }
                            catch { warn_space = false; }

                            String err_txt = "";
                            Double interval = 0;
                            Double durat_n2 = 0;
                            this.InvokeEx(f => multi_logs["log_n_" + file_int.ToString()] = Properties.Strings2.logging_f + " " + '\u0022' + listView1.Items[Convert.ToInt32(file_int)].Text + '\u0022' + Environment.NewLine);
                            //REVIEW
                            while (!tmp.StandardError.EndOfStream)
                            {
                                err_txt = tmp.StandardError.ReadLine();
                                space_timer++;
                                multi_logs["log_n_" + file_int.ToString()] = multi_logs["log_n_" + file_int.ToString()] + Environment.NewLine + n_logs + err_txt;

                                if (err_txt.Contains("time=") && err_txt.Contains("time=-") == false)
                                {
                                    if (valid_prog2 == true)
                                    {
                                        this.InvokeEx(f => f.txt_remain.Refresh());
                                        this.InvokeEx(f => durat_n2 = row_duration);
                                        int start_time_index = err_txt.IndexOf("time=") + 5;
                                        Double sec_prog = TimeSpan.Parse(err_txt.Substring(start_time_index, 8)).TotalSeconds;
                                        Double percent = (sec_prog * 100 / durat_n2);

                                        total_prog = total_prog + (sec_prog - interval);
                                        interval = sec_prog;
                                        int percent2 = 0;
                                        try
                                        {
                                            percent2 = Convert.ToInt32(percent);
                                        }
                                        catch
                                        {
                                        }

                                        if (percent2 <= 100)
                                        {
                                            if (Math.Round(percent, 1).ToString().Contains(".") || Math.Round(percent, 1).ToString().Contains(","))
                                            {
                                                this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = Math.Round(percent, 1).ToString() + "%");
                                            }
                                            else
                                            {
                                                this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = Math.Round(percent, 1).ToString() + ".0" + "%");
                                            }
                                        }
                                    }
                                    try
                                    {
                                        if (err_txt.Contains("fps="))
                                        {
                                            multi_fps[file_int] = (err_txt.Substring(err_txt.LastIndexOf("fps=") + 4, 4)).TrimStart();
                                        }
                                        else
                                        {
                                            multi_fps[file_int] = "0";
                                        }
                                    }
                                    catch { multi_fps[file_int] = "0"; }
                                    try
                                    {
                                        if (err_txt.ToLower().Contains("speed="))
                                        {
                                            multi_speeds[file_int] = (err_txt.Substring(err_txt.LastIndexOf("speed=") + 6, err_txt.Length - err_txt.LastIndexOf("speed=") - 6)).Replace("x", "");
                                        }
                                        else
                                        {
                                            multi_speeds[file_int] = "0";
                                        }
                                    }
                                    catch { multi_speeds[file_int] = "0"; }
                                }

                                //Monitor available space
                                if (space_timer % 30 == 0 && dest_drive.AvailableFreeSpace <= 500000000 && warn_space == true)
                                {
                                    foreach (Process proc in procs.Values)
                                    {
                                        try
                                        {
                                            proc.Suspend();
                                        }
                                        catch
                                        {
                                        }
                                    }
                                    DialogResult a = MessageBox.Show(Properties.Strings2.warn_sp, Properties.Strings2.low_sp + " (" + (dest_drive2.AvailableFreeSpace / 1000000).ToString() + "MB)", MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation);
                                    foreach (Process proc in procs.Values)
                                    {
                                        try
                                        {
                                            proc.Resume();
                                        }
                                        catch
                                        {
                                        }
                                    }

                                    if (a == DialogResult.Yes)
                                    {
                                        cts.Cancel();
                                        aborted = true;
                                        cancelados_paralelos = true;

                                        foreach (Process proc in procs.Values)
                                        {
                                            cancelados_paralelos = true;
                                            if (proc.StartInfo.Arguments != String.Empty)

                                            {
                                                try
                                                {
                                                    StreamWriter write_q = proc.StandardInput;
                                                    write_q.Write("q");
                                                }
                                                catch { }
                                            }
                                        }
                                    }

                                    warn_space = false;
                                }
                                //End monitor space
                            }
                            tmp.WaitForExit();
                            tmp.StartInfo.Arguments = String.Empty;
                            multi_speeds[file_int] = "0";
                            multi_fps[file_int] = "0";
                            this.InvokeEx(f => multi_logs["log_n_" + file_int.ToString()] = multi_logs["log_n_" + file_int.ToString()] + Environment.NewLine + "--------End of " + '\u0022' + listView1.Items[Convert.ToInt32(file_int)].Text + '\u0022' + " log--------" + Environment.NewLine);

                            if (tmp.ExitCode == 0)
                            {
                                list_successful_m.Add(fullPath);
                                if (cancelados_paralelos == false && cts.IsCancellationRequested == false)
                                {
                                    if (aborted_url == false)
                                    {
                                        if (File.Exists(fullPath) == true)
                                        {
                                            this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.success);

                                            if (chk_overw.CheckState == CheckState.Checked)
                                            {
                                                if (current_out == fullPath)
                                                {
                                                    String sourc = destis[file_int] + "\\" + System.IO.Path.GetFileNameWithoutExtension(fullPath) + "_fftemp" + add_suffix + ext_output1;

                                                    try
                                                    {
                                                        if (File.Exists(sourc))
                                                        {
                                                            File.Delete(fullPath);
                                                            FileSystem.RenameFile(sourc, Path.GetFileNameWithoutExtension(fullPath) + add_suffix + ext_output1);
                                                            this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.replaced);
                                                        }
                                                        else
                                                        {
                                                            this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.not_replaced);
                                                            warn_enc++;
                                                            this.InvokeEx(f => multi_logs["log_n_" + file_int.ToString()] = multi_logs["log_n_" + file_int.ToString()] + Environment.NewLine + Properties.Strings2.warning_file + " " + +'\u0022' + listView1.Items[Convert.ToInt32(file_int)].Text + '\u0022' + " " + Properties.Strings2.warning_not_rep + " " + "(_fftemp)." + Environment.NewLine);
                                                        }
                                                    }
                                                    catch (Exception excpt)
                                                    {
                                                        try
                                                        {
                                                            FileSystem.RenameFile(sourc, Path.GetFileNameWithoutExtension(fullPath) + add_suffix + ext_output1);
                                                            this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.replaced);
                                                        }
                                                        catch
                                                        {
                                                            try
                                                            {
                                                                FileSystem.RenameFile('\u0022' + sourc + '\u0022', '\u0022' + Path.GetFileNameWithoutExtension(fullPath) + add_suffix + ext_output1 + '\u0022');
                                                                this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.replaced);
                                                            }
                                                            catch
                                                            {
                                                                this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.renamed);
                                                                warn_enc++;
                                                                this.InvokeEx(f => multi_logs["log_n_" + file_int.ToString()] = multi_logs["log_n_" + file_int.ToString()] + Environment.NewLine + Properties.Strings2.warning_file + " " + '\u0022' + listView1.Items[Convert.ToInt32(file_int)].Text + '\u0022' + " " + Properties.Strings2.warning_not_rep + " " + "(_fftemp)." + Environment.NewLine);
                                                            }
                                                        }
                                                    }
                                                }
                                            }

                                            if (chk_delete_source.CheckState == CheckState.Checked && delete_def == false && delete_one == true)
                                            {
                                                try
                                                {
                                                    FileSystem.DeleteFile(fullPath, UIOption.OnlyErrorDialogs, RecycleOption.SendToRecycleBin);
                                                    this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.recycled);
                                                }
                                                catch
                                                {
                                                    this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.not_recycled);
                                                    warn_enc++;
                                                }
                                            }
                                            if (chk_delete_source.CheckState == CheckState.Checked && delete_def == true && delete_one == true)
                                            {
                                                try
                                                {
                                                    FileInfo fs = new FileInfo(fullPath);
                                                    if (fs.IsReadOnly == true) fs.IsReadOnly = false;
                                                    File.Delete(fullPath);
                                                    this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.deleted);
                                                }
                                                catch
                                                {
                                                    this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.not_deleted);
                                                    warn_enc++;
                                                }
                                            }
                                        }
                                    }
                                    if (aborted_url == true)
                                    {
                                        if (skipped == false) this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.aborted);
                                        else
                                        {
                                            this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.skipped);
                                            try
                                            {
                                                File.Delete(current_out);
                                            }
                                            catch { }
                                        }
                                        aborted_url = false;
                                        skipped = false;
                                    }

                                    //Run on each file
                                    int index = 0;
                                    Boolean sh_check = false;
                                    combo_shut.Invoke(new MethodInvoker(delegate
                                    {
                                        index = combo_shut.SelectedIndex;
                                    }));
                                    chkshut.Invoke(new MethodInvoker(delegate
                                    {
                                        if (chkshut.Checked == true) sh_check = true;
                                    }));

                                    if (index == 4 && cancel_queue == false && sh_check == true)
                                    {
                                        this.InvokeEx(f => this.Enabled = false);
                                        Form14 frm_run = new Form14();
                                        frm_run.txt_path.Text = run_command;
                                        String dest_f = '\u0022' + destis[file_int] + "\\" + System.IO.Path.GetFileNameWithoutExtension(fullPath) + add_suffix + ext_output1 + '\u0022';
                                        if (ext_output1 == "nul") dest_f = '\u0022' + destis[file_int] + "\\" + System.IO.Path.GetFileNameWithoutExtension(fullPath) + add_suffix + Path.GetExtension(fullPath).Replace(".", "") + '\u0022';

                                        frm_run.args = dest_f + " " + run_command_args;
                                        frm_run.timer1.Interval = 100;
                                        frm_run.ShowDialog();
                                        this.InvokeEx(f => this.Enabled = true);
                                        Enable_Controls();

                                        if (frm_run.proc.ExitCode == 0)
                                        {
                                            this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = "OK & Run");
                                            multi_logs["log_n_" + file_int.ToString()] = multi_logs["log_n_" + file_int.ToString()] + Environment.NewLine + n_logs + Properties.Strings2.ext_com_ok + " " + dest_f + Environment.NewLine;
                                        }
                                        else
                                        {
                                            this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = "OK & Error");
                                            multi_logs["log_n_" + file_int.ToString()] = multi_logs["log_n_" + file_int.ToString()] + Environment.NewLine + n_logs + Properties.Strings2.ext_com_err + " " + dest_f + Environment.NewLine;
                                        }
                                        this.InvokeEx(f => this.TopMost = true);
                                        this.InvokeEx(f => this.TopMost = false);
                                    }

                                    //End run on each file
                                }
                                else
                                {
                                    this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.aborted);

                                    if (cancelados_paralelos == false)
                                    {
                                        aborted_url = false;
                                    }
                                }
                            }
                            else
                            {
                                list_failed_m.Add(fullPath);
                                this.InvokeEx(f => f.listView1.Items[Convert.ToInt32(file_int)].SubItems[5].Text = FFBatch.Properties.Strings.failed);
                                errors_enc = errors_enc + 1;
                            }
                        }).Wait();

                    file_int++;
                });
            }
            catch (Exception exc)
            {
                fatal_parallel_msg = exc.Message;
                fatal_parallel = true;
            }

            if (result.IsCompleted == true) fatal_parallel = false;
            else
            {
                if (cts.IsCancellationRequested == false) fatal_parallel = true;
                else fatal_parallel = false;
            }
            String avgs = "";
            //Averages

            if (start_total_time == 0) start_total_time = 1;
            Double avg_enc = Math.Round((total_multi_duration / start_total_time), 1);

            try
            {
                if (cancelados_paralelos == false)
                {
                    if (tot_frames2 != 0)
                    {
                        avgs = Environment.NewLine + (FFBatch.Properties.Strings.avg_perf + " " + avg_enc.ToString() + "x" + "  |  " + Math.Round(tot_frames2 / (decimal)start_total_time, 1)).ToString() + " fps";
                        this.InvokeEx(f => f.lbl_speed.Text = ("AVG: " + avg_enc.ToString() + "x" + "  |  " + Math.Round(tot_frames2 / (decimal)start_total_time, 1)).ToString() + " fps");
                    }
                    else
                    {
                        avgs = Environment.NewLine + (FFBatch.Properties.Strings.avg_perf + " " + avg_enc.ToString() + "x");
                        this.InvokeEx(f => f.lbl_speed.Text = ("AVG: " + avg_enc.ToString() + "x"));
                    }
                }
            }
            catch { }

            //End averages

            if (no_save_logs == false)
            {
                String[] array_err = list_lines.ToArray();

                String path1 = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                if (is_portable == true) path1 = port_path + "ff_batch_portable.log";
                String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch" + listView1.Items.Count.ToString() + ".log";
                if (is_portable == true) path = port_path + "ff_batch_portable" + listView1.Items.Count.ToString() + ".log";
                try
                {
                    System.IO.StreamWriter SaveFile = new System.IO.StreamWriter(path);
                    SaveFile.WriteLine("Multi-file log session: " + System.DateTime.Now);
                    SaveFile.WriteLine("-----------------------------------------------------");
                    SaveFile.Write(string.Join(Environment.NewLine, multi_logs.Select(a => $"{a.Value}")));
                    SaveFile.Close();
                    File.AppendAllText(path, avgs + Environment.NewLine + Environment.NewLine);
                    File.AppendAllText(path, "--------------------------");
                    File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.end_log);
                    File.AppendAllText(path, Environment.NewLine);
                    System.IO.FileInfo fileInfo = new System.IO.FileInfo(path);

                    var bytes = fileInfo.Length;

                    var kilobytes = (double)bytes / 1024;
                    var megabytes = kilobytes / 1024;
                    var gigabytes = megabytes / 1024;

                    //Format size view
                    String size = "";
                    String separator = ".";

                    if (bytes > 1000000000)
                    {
                        if (gigabytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }

                        String gigas = gigabytes.ToString();
                        if (gigas.Length >= 5)
                        {
                            gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                            size = (gigas + " " + "GB");
                        }
                        else
                        {
                            size = (gigas + " " + "GB");
                        }
                    }

                    if (bytes >= 1048576 && bytes <= 1000000000)
                    {
                        if (megabytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }
                        String megas = megabytes.ToString();
                        if (megas.Length > 5)
                        {
                            megas = megas.Substring(0, megas.LastIndexOf(separator));
                            size = (megas + " " + "MB");
                        }
                        else
                        {
                            size = (megas + " " + "MB");
                        }
                    }

                    if (bytes >= 1024 && bytes < 1048576)

                    {
                        if (kilobytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }

                        String kbs = kilobytes.ToString();
                        if (kbs.Length >= 5)
                        {
                            kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                            size = (kbs + " " + "KB");
                        }
                        else
                        {
                            size = (kbs + " " + "KB");
                        }
                    }
                    if (bytes > -1 && bytes < 1024)
                    {
                        String bits = bytes.ToString();
                        size = (bits + " Bytes");
                    }

                    //End Format size view
                    File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.log_size + " " + size);
                    String p1 = "";
                    foreach (String line in File.ReadLines(path)) p1 = p1 + Environment.NewLine + line;
                    File.AppendAllText(path1, p1);
                    try
                    {
                        File.Delete(path);
                    }
                    catch { }
                }
                catch { }

                //End save log
            }
        }

        private void BG_Pending_M_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            Boolean pending_item = false;
            foreach (ListViewItem item in listView1.Items)
            {
                if (item.SubItems[5].Text == Properties.Strings.queued)
                {
                    pending_item = true;
                    break;
                }
            }
            if (pending_item == true && aborted == false)
            {
                BG_Pending_M.RunWorkerAsync();
                return;
            }

            this.Text = "FFmpeg Batch AV Converter";

            if (is_portable == true) this.Text = "FFmpeg Batch AV Converter Portable";
            timer_aborting.Stop();

            // Close abort form
            for (int i = Application.OpenForms.Count - 1; i >= 0; i--)
            {
                if (Application.OpenForms[i].Name == "Form12")
                {
                    this.InvokeEx(f => Application.OpenForms[i].Close());
                    break;
                }
            }
            //End close abort form
            listView1.SelectedItems.Clear();
            TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress);
            timer1.Stop();
            timer_tasks.Stop();
            Pg1.Value = Pg1.Maximum;
            Pg1.Text = "100%";
            Pg1.Refresh();
            listView1.Enabled = true;
            working = false;
            multi_running = false;
            Enable_Controls();

            clean_ffb_test();

            if (cancelados_paralelos == false && fatal_parallel == false)
            {
                //Open on completion
                String primero_lista = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text;
                String destino2 = String.Empty;
                if (chk_open_compl.Checked == true)
                {
                    if (txt_path_main.Text.Contains(".\\"))
                    {
                        destino2 = destino2 = primero_lista.Substring(0, primero_lista.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty); ;
                    }
                    else
                    {
                        destino2 = txt_path_main.Text;
                    }
                }

                if (chk_delete_source.CheckState == CheckState.Checked && delete_def == false && delete_one == false)
                {
                    Disable_Controls();

                    Label prog_txt = new Label();
                    prog_txt.Parent = panel1;
                    prog_txt.Top = 95;
                    prog_txt.Left = 80;
                    prog_txt.Width = 250;
                    prog_txt.TabIndex = 1;
                    prog_txt.BackColor = panel1.BackColor;
                    prog_txt.BorderStyle = BorderStyle.None;
                    prog_txt.TextAlign = ContentAlignment.MiddleLeft;
                    prog_txt.BringToFront();
                    prog_txt.Text = FFBatch.Properties.Strings.to_recycle;

                    ProgressBar pg_del = new ProgressBar();
                    pg_del.Parent = panel1;
                    pg_del.Top = 98;
                    pg_del.Left = 315;
                    pg_del.Width = 152;
                    pg_del.Height = 15;
                    pg_del.TabIndex = 0;
                    pg_del.BackColor = this.BackColor;
                    pg_del.Minimum = 0;
                    pg_del.BringToFront();
                    pg_del.Maximum = listView1.Items.Count;
                    pg_del.Show();
                    pg_del.Refresh();
                    int i = 0;
                    int err = 0;

                    foreach (String item in list_successful_m)
                    {
                        try
                        {
                            FileSystem.DeleteFile(item, UIOption.OnlyErrorDialogs, RecycleOption.SendToRecycleBin);
                            pg_del.Value = i;
                            i = i + 1;

                            foreach (ListViewItem item2 in listView1.Items)
                            {
                                if (item2.Text == Path.GetFileName(item))
                                {
                                    item2.SubItems[5].Text = FFBatch.Properties.Strings.recycled;
                                }
                            }
                        }
                        catch
                        {
                            err = err + 1;

                            foreach (ListViewItem item2 in listView1.Items)
                            {
                                if (item2.Text == Path.GetFileName(item))
                                {
                                    item2.SubItems[5].Text = FFBatch.Properties.Strings.not_recycled;
                                }
                            }
                        }
                        prog_txt.Text = FFBatch.Properties.Strings.to_recycle + i.ToString() + " " + FFBatch.Properties.Strings.of1 + " " + list_global_proc.Items.Count;
                        prog_txt.Refresh();
                    }
                    prog_txt.Visible = false;
                    prog_txt.Dispose();
                    pg_del.Visible = false;
                    pg_del.Dispose();
                    Enable_Controls();

                    if (err > 0) MessageBox.Show(err.ToString() + " " + Properties.Strings.not_recycled2 + Properties.Strings.check_log, FFBatch.Properties.Strings.not_recycled3, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);

                    if (list_failed_m.Count > 0)
                    {
                        String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                        if (is_portable == true) path = port_path + "ff_batch_portable.log";

                        File.AppendAllText(path, Environment.NewLine + Environment.NewLine + Properties.Strings2.source_not_deleted);
                        File.AppendAllText(path, Environment.NewLine + "-------------------------------");
                        foreach (String item in list_failed_m)
                        {
                            File.AppendAllText(path, Environment.NewLine + item);
                        }
                    }

                    //End delete source
                }

                if (chk_delete_source.CheckState == CheckState.Checked && delete_def == true && delete_one == false)
                {
                    Disable_Controls();

                    Label prog_txt = new Label();
                    prog_txt.Parent = panel1;
                    prog_txt.Top = 95;
                    prog_txt.Left = 80;
                    prog_txt.Width = 250;
                    prog_txt.TabIndex = 1;
                    prog_txt.BackColor = panel1.BackColor;
                    prog_txt.BorderStyle = BorderStyle.None;
                    prog_txt.TextAlign = ContentAlignment.MiddleLeft;
                    prog_txt.BringToFront();
                    prog_txt.Text = Properties.Strings2.deleting_files;

                    ProgressBar pg_del = new ProgressBar();
                    pg_del.Parent = panel1;
                    pg_del.Top = 98;
                    pg_del.Left = 315;
                    pg_del.Width = 152;
                    pg_del.Height = 15;
                    pg_del.TabIndex = 0;
                    pg_del.BackColor = this.BackColor;
                    pg_del.Minimum = 0;
                    pg_del.BringToFront();
                    pg_del.Maximum = listView1.Items.Count;
                    pg_del.Show();
                    pg_del.Refresh();
                    int i = 0;
                    int err = 0;

                    foreach (String item in list_successful_m)
                    {
                        try
                        {
                            FileInfo fs = new FileInfo(item);
                            if (fs.IsReadOnly == true) fs.IsReadOnly = false;
                            File.Delete(item);
                            pg_del.Value = i;
                            i = i + 1;

                            foreach (ListViewItem item2 in listView1.Items)
                            {
                                if (item2.Text == Path.GetFileName(item))
                                {
                                    item2.SubItems[5].Text = FFBatch.Properties.Strings.deleted;
                                }
                            }
                        }
                        catch
                        {
                            err = err + 1;

                            foreach (ListViewItem item2 in listView1.Items)
                            {
                                if (item2.Text == Path.GetFileName(item))
                                {
                                    item2.SubItems[5].Text = FFBatch.Properties.Strings.not_deleted;
                                }
                            }
                        }
                        prog_txt.Text = Properties.Strings2.deleting_f + " " + i.ToString() + " " + FFBatch.Properties.Strings.of1 + " " + list_global_proc.Items.Count;
                        prog_txt.Refresh();
                    }
                    prog_txt.Visible = false;
                    prog_txt.Dispose();
                    pg_del.Visible = false;
                    pg_del.Dispose();
                    Enable_Controls();

                    if (err > 0) MessageBox.Show(err.ToString() + " " + Properties.Strings.not_recycled2 + " " + Properties.Strings.check_log, FFBatch.Properties.Strings.not_recycled3, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);

                    if (list_failed_m.Count > 0)
                    {
                        String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                        if (is_portable == true) path = port_path + "ff_batch_portable.log";

                        File.AppendAllText(path, Environment.NewLine + Environment.NewLine + Properties.Strings2.source_not_deleted);
                        File.AppendAllText(path, Environment.NewLine + "-------------------------------");
                        foreach (String item in list_failed_m)
                        {
                            File.AppendAllText(path, Environment.NewLine + item);
                        }
                    }

                    //End delete source
                }

                this.InvokeEx(f => toolT002.RemoveAll());
                if (errors_enc == 0)
                {
                    pic_no_errors.Visible = true;
                    //Delete source

                    //Automatic shutdown check
                    if (chkshut.Checked)
                    {
                        auto_shut();
                        return;
                    }
                    //End shutdown check

                    if (warn_enc > 0)
                    {
                        pic_no_errors.Visible = false;
                        pic_recording.Visible = false;
                        toolT002.SetToolTip(this.pic_warnings, FFBatch.Properties.Strings.there_w + " " + warn_enc.ToString() + " " + Properties.Strings2.warnings_last_s);
                        pic_warnings.Visible = true;
                    }
                }
                else
                {
                    pic_no_errors.Visible = false;
                    pic_recording.Visible = false;
                    toolT002.SetToolTip(this.pic_warnings, FFBatch.Properties.Strings.there_w + " " + errors_enc.ToString() + " " + FFBatch.Properties.Strings.errors_se);
                    pic_warnings.Visible = true;
                }

                if (errors_enc == 0)
                {
                    if (play_on_end == true) play_end();
                }
                else if (play_on_end == true) System.Media.SystemSounds.Asterisk.Play();

                if (this.ContainsFocus == false)
                {
                    if (errors_enc == 0 && warn_enc == 0)
                    {
                        notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.enc_comp;
                        notifyIcon1.BalloonTipIcon = ToolTipIcon.Info;
                        notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.enc_comp2;
                        notifyIcon1.ShowBalloonTip(0);
                    }
                    if (errors_enc > 0)
                    {
                        notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.enc_comp3 + " " + errors_enc.ToString() + " " + FFBatch.Properties.Strings.errors1;
                        notifyIcon1.BalloonTipIcon = ToolTipIcon.Warning;
                        notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.enc_comp2;
                        notifyIcon1.ShowBalloonTip(0);
                    }
                    if (errors_enc == 0 && warn_enc > 0)
                    {
                        if (errors_enc == 0 && warn_enc > 0)
                        {
                            notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.enc_warns;
                            notifyIcon1.BalloonTipIcon = ToolTipIcon.Warning;
                            notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.enc_comp2;
                            notifyIcon1.ShowBalloonTip(0);
                        }
                    }
                }

                if (chk_open_compl.Checked == true && opened_m == false)
                {
                    opened_m = true;
                    try
                    {
                        if (Directory.GetFiles(destino2).Length != 0)
                        {
                            Process open_processed = new Process();
                            open_processed.StartInfo.FileName = "explorer.exe";
                            open_processed.StartInfo.Arguments = '\u0022' + multi_dest + '\u0022';
                            open_processed.Start();
                        }
                        else
                        {
                            if (Directory.Exists(destino2))
                            {
                                System.IO.Directory.Delete(destino2);
                            }
                        }
                    }
                    catch
                    {
                    }
                }

                return;
            }
            else
            {
                if (aborted == true)
                {
                    aborted = false;
                    MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.task_abort, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                }
                cancelados_paralelos = false;
            }
        }

        private void ct2_save_allstreams_Click(object sender, EventArgs e)
        {
            foreach (ListViewItem item in listView2.SelectedItems)
            {
                list_tracks.Items.Clear();
                foreach (ListViewItem item2 in listView2.Items) item2.Selected = false;
                listView2.Items[item.Index].Selected = true;
                ct2_all.PerformClick();

                foreach (ListViewItem item2 in list_tracks.Items)
                {
                    item2.Selected = true;
                }
                extract_streams_job();
            }
            this.Cursor = Cursors.Arrow;
            list_tracks.Items.Clear();
            frm_mux_jobs.ShowDialog();
            if (frm_mux_jobs.view_logs == true)
            {
                show_mux_logs();
                return;
            }
            if (frm_mux_jobs.start_jobs == true) start_mux_jobs();
        }

        private void listView1_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (listView1.Items.Count > 1 && listView1.SelectedItems.Count != 1)
            {
                pic_frame.Image = pic_frame.InitialImage;
                lbl_s_th.Text = "-";
                lbl_a_th.Text = "-";
                lbl_v_th.Text = "-";
                lbl_gb_th.Text = "-";
                return;
            }
            if (listView1.SelectedIndices.Count == 0 && listView1.Items.Count == 1) return;

            current_fr = 4000;

            Process proc_img = new System.Diagnostics.Process();

            if (listView1.SelectedIndices.Count == 1)
            {
                //Attempt to extract frame as image
                String dur_lv1 = listView1.SelectedItems[0].SubItems[3].Text;
                String lv1_item = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
                lbl_s_th.Text = "-"; lbl_s_th.Refresh();
                lbl_v_th.Text = "-"; lbl_v_th.Refresh();
                lbl_a_th.Text = "-"; lbl_a_th.Refresh();
                lbl_gb_th.Text = "-"; lbl_gb_th.Refresh();
                pic_frame.Image = pic_frame.InitialImage;

                if (!File.Exists(lv1_item)) return;

                if (!Directory.Exists(Path.Combine(Path.GetTempPath(), "FFBatch_Test"))) Directory.CreateDirectory(Path.Combine(Path.GetTempPath(), "FFBatch_Test"));

                String time_frame = "";
                Double t_to = (double)current_fr;
                TimeSpan t1 = TimeSpan.FromMilliseconds((t_to));
                String tx_1 = string.Format("{0:D2}:{1:D2}:{2:D2}.{3:D3}",
                             (int)t1.TotalHours,
                             t1.Minutes,
                             t1.Seconds,
                             t1.Milliseconds);
                time_frame = tx_1;
                String repl_frm = time_frame.Replace(",", "").Replace(".", "").Replace(":", "");

                String ffm_img = Path.Combine(Application.StartupPath, "ffmpeg.exe");
                String itfull = "";

                if (tabControl1.SelectedIndex == 0 && listView1.SelectedItems.Count == 1) itfull = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
                if (tabControl1.SelectedIndex == 1 && listView2.SelectedItems.Count == 1) itfull = listView2.SelectedItems[0].Text;

                String file_img = Path.GetFullPath(lv1_item);
                String fullPath_img = file_img;
                String AppParam_img = "";
                String config_info = Path.Combine(Path.GetTempPath(), "FFBatch_Test") + "\\" + "mediaconfig.txt";
                String rel_path = Path.GetDirectoryName(file_img).Replace(":", "_").Replace("\\", "_") + Path.GetExtension(file_img).Replace(".", "_");
                String target_img = Path.GetTempPath() + "FFBatch_Test" + "\\" + Path.GetFileNameWithoutExtension(file_img) + "_480_" + rel_path + "_" + repl_frm + "." + "jpg";
                String target_info = Path.GetTempPath() + "FFBatch_Test" + "\\" + Path.GetFileNameWithoutExtension(file_img) + rel_path + "_" + "." + "txt";

                String m_info_path = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");

                Task t = Task.Run(() =>
                {
                    List<String> lines_ouput = new List<String>();

                    Process get_frames = new Process();

                    this.Invoke(new MethodInvoker(delegate
                    {
                        try
                        {
                            if (!File.Exists(target_info))
                            {
                                String[] config_lines = new String[3];
                                config_lines[0] = "Video;%Format%" + "\\n" + "%Width%" + "\\n" + "%Height%" + "\\n" + "%DisplayAspectRatio/String%" + "\\n";
                                config_lines[1] = "Audio;%Format%" + "\\n";
                                config_lines[2] = "General;%OverallBitRate/String%" + "\\n";

                                File.WriteAllLines(config_info, config_lines);
                                get_frames.StartInfo.FileName = m_info_path;

                                String ffprobe_frames = " " + "--Inform=file://" + config_info;
                                get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + itfull + '\u0022';
                                get_frames.StartInfo.RedirectStandardOutput = true;
                                get_frames.StartInfo.UseShellExecute = false;
                                get_frames.StartInfo.CreateNoWindow = true;
                                get_frames.EnableRaisingEvents = true;

                                get_frames.Start();

                                while (!get_frames.StandardOutput.EndOfStream)
                                {
                                    lines_ouput.Add(get_frames.StandardOutput.ReadLine());
                                }
                                //foreach (String str in lines_ouput) MessageBox.Show(str);

                                get_frames.WaitForExit();
                                if (get_frames.ExitCode == 0)
                                {
                                    if (lines_ouput[1].ToLower().Contains("visual")) lines_ouput[1] = lines_ouput[1].Replace("Visual", "");
                                    try { lbl_v_th.Text = lines_ouput[1].Replace("Video", "") + "  " + lines_ouput[4]; } catch { }
                                    try { lbl_s_th.Text = lines_ouput[2] + "x" + lines_ouput[3]; } catch { }

                                    try { lbl_a_th.Text = lines_ouput[5].ToLower(); }
                                    catch
                                    {
                                        lbl_a_th.Text = lines_ouput[1].ToLower();
                                        lbl_s_th.Text = "-";
                                        lbl_v_th.Text = "-";
                                        lbl_gb_th.Text = lines_ouput[0];
                                    }
                                    String ext_a0 = Path.GetExtension(file_img);

                                    if (ext_a0 == ".flac" || ext_a0 == ".mp3" || ext_a0 == ".oga" || ext_a0 == ".ape" || ext_a0 == ".wav" || ext_a0 == ".aac" || ext_a0 == ".ac3" || ext_a0 == ".mpa" || ext_a0 == ".mka" || ext_a0 == ".wave" || ext_a0 == ".mp1" || ext_a0 == ".dsd" || ext_a0 == ".wma" || ext_a0 == ".amr" || ext_a0 == ".opus")
                                    {
                                        lbl_v_th.Text = ext_a0.Replace(".", "");
                                    }

                                    try
                                    {
                                        if (lines_ouput[0].Length > 0)
                                        {
                                            System.Globalization.CultureInfo ci = System.Threading.Thread.CurrentThread.CurrentUICulture;
                                            String sep_th = ci.NumberFormat.CurrencyGroupSeparator;
                                            if (lines_ouput[0].Substring(1, 1) == " ")
                                            {
                                                lines_ouput[0] = lines_ouput[0].Substring(0, 1) + sep_th + lines_ouput[0].Substring(2, lines_ouput[0].Length - 2);
                                            }
                                            lbl_gb_th.Text = lines_ouput[0];
                                        }
                                    }
                                    catch { lbl_gb_th.Text = "-"; }
                                }
                                else
                                {
                                    lbl_s_th.Text = "-";
                                    lbl_v_th.Text = "-";
                                    lbl_a_th.Text = "-";
                                    lbl_gb_th.Text = "-";
                                }

                                String info = lbl_v_th.Text + Environment.NewLine + lbl_a_th.Text + Environment.NewLine + lbl_s_th.Text + Environment.NewLine + lbl_gb_th.Text;
                                File.WriteAllText(target_info, info);
                            }
                            else
                            {
                                String[] lines = new String[4];
                                int l = 0;
                                foreach (String line in File.ReadLines(target_info))
                                {
                                    lines[l] = line;
                                    l++;
                                }

                                lbl_v_th.Text = lines[0];
                                lbl_a_th.Text = lines[1];
                                lbl_s_th.Text = lines[2];
                                lbl_gb_th.Text = lines[3];
                            }
                        }
                        catch { }
                    }));

                    //End Get Info

                    if (File.Exists(target_img))
                    {
                        Image img_tmp1;
                        using (var bmpTemp = new Bitmap(target_img))
                        {
                            img_tmp1 = new Bitmap(bmpTemp);

                            pic_frame.Invoke(new MethodInvoker(delegate
                            {
                                try
                                {
                                    pic_frame.Image = img_tmp1;
                                    panel_thumb.Refresh();
                                }
                                catch
                                {
                                    pic_frame.Image = pic_frame.InitialImage;
                                }
                            }));
                        }
                        return;
                    }

                    AppParam_img = " -ss " + time_frame + " -i " + "" + '\u0022' + file_img + '\u0022' + " -qscale:v 0" + " -vf scale=480:-1" + " -f image2 -y " + '\u0022' + target_img + '\u0022';

                    String ext_a = Path.GetExtension(file_img);
                    if (ext_a == ".flac" || ext_a == ".mp3") AppParam_img = " -i " + "" + '\u0022' + file_img + '\u0022' + " -f image2 -y " + '\u0022' + target_img + '\u0022';

                    proc_img.StartInfo.RedirectStandardOutput = false;
                    proc_img.StartInfo.RedirectStandardError = false;
                    proc_img.StartInfo.UseShellExecute = false;
                    proc_img.StartInfo.CreateNoWindow = true;
                    proc_img.EnableRaisingEvents = false;
                    proc_img.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;

                    proc_img.StartInfo.FileName = ffm_img;
                    proc_img.StartInfo.Arguments = AppParam_img;
                    pic_frame.Image = img_list_pic_thumb.Images[0];
                    proc_img.Start();
                    proc_img.WaitForExit(5000);

                    if (File.Exists(target_img))
                    {
                        Image img_tmp;
                        using (var bmpTemp = new Bitmap(target_img))
                        {
                            img_tmp = new Bitmap(bmpTemp);
                            pic_frame.Invoke(new MethodInvoker(delegate
                            {
                                try
                                {
                                    pic_frame.Image = img_tmp;
                                    panel_thumb.Refresh();
                                }
                                catch
                                {
                                    pic_frame.Image = pic_frame.InitialImage;
                                    panel_thumb.Refresh();
                                }
                            }));
                        }
                    }
                    else
                    {
                        String ext_a0 = Path.GetExtension(file_img);

                        if (ext_a0 == ".flac" || ext_a0 == ".mp3" || ext_a0 == ".oga" || ext_a0 == ".ape" || ext_a0 == ".wav" || ext_a0 == ".aac" || ext_a0 == ".ac3" || ext_a0 == ".mpa" || ext_a0 == ".mka" || ext_a0 == ".wave" || ext_a0 == ".mp1" || ext_a0 == ".dsd" || ext_a0 == ".wma" || ext_a0 == ".amr" || ext_a0 == ".opus")
                        {
                            pic_frame.Invoke(new MethodInvoker(delegate
                            {
                                try
                                {
                                    if (lbl_a_th.Text != ext_a0.Replace(".", "")) lbl_v_th.Text = ext_a0.Replace(".", "");
                                    else lbl_v_th.Text = "Audio";
                                    PictureBox pic2 = new PictureBox();
                                    pic2.Image = pic_frame.ErrorImage;
                                    pic_frame.Image = pic2.Image;
                                }
                                catch
                                {
                                    pic_frame.Invoke(new MethodInvoker(delegate
                                    {
                                        pic_frame.Image = pic_frame.InitialImage;
                                    }));
                                }
                            }));
                        }

                        if (ext_a0 == ".jpg" || ext_a0 == ".jpeg" || ext_a0 == ".png" || ext_a0 == ".gif" || ext_a0 == ".tif" || ext_a0 == ".bmp" || ext_a0 == ".ico" || ext_a0 == ".bmp")
                        {
                            pic_frame.Invoke(new MethodInvoker(delegate
                            {
                                try
                                {
                                    PictureBox pic2 = new PictureBox();
                                    pic2.Image = new Bitmap(file_img);
                                    pic_frame.Image = pic2.Image;
                                }
                                catch
                                {
                                    pic_frame.Invoke(new MethodInvoker(delegate
                                    {
                                        pic_frame.Image = pic_frame.InitialImage;
                                    }));
                                }
                            }));

                            get_frames.StartInfo.Arguments = "--Inform=Image;%Width%x%Height%" + " " + '\u0022' + itfull + '\u0022';
                            get_frames.StartInfo.FileName = m_info_path;

                            get_frames.StartInfo.RedirectStandardOutput = true;
                            get_frames.StartInfo.RedirectStandardError = true;
                            get_frames.StartInfo.UseShellExecute = false;
                            get_frames.StartInfo.CreateNoWindow = true;
                            get_frames.EnableRaisingEvents = false;
                            get_frames.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;

                            get_frames.Start();
                            String outp = "-";
                            while (!get_frames.StandardOutput.EndOfStream)
                            {
                                outp = get_frames.StandardOutput.ReadLine();
                            }
                            get_frames.WaitForExit();
                            pic_frame.Invoke(new MethodInvoker(delegate
                            {
                                lbl_v_th.Text = "Image";
                                lbl_s_th.Text = outp;
                                lbl_a_th.Text = ext_a0.Replace(".", "");
                            }));
                        }
                    }
                });
            }
        }

        private void pic_frame_Click(object sender, EventArgs e)
        {
            if (tabControl1.SelectedIndex == 2) return;
            show_str_thumb();
        }

        private void listView2_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (listView2.Items.Count > 1 && listView2.SelectedItems.Count != 1)
            {
                pic_frame.Image = pic_frame.InitialImage;
                lbl_s_th.Text = "-";
                lbl_a_th.Text = "-";
                lbl_v_th.Text = "-";
                return;
            }
            if (listView2.SelectedIndices.Count == 0 && listView2.Items.Count == 1) return;

            current_fr = 4000;

            Process proc_img = new System.Diagnostics.Process();

            if (listView2.SelectedIndices.Count == 1)
            {
                //Attempt to extract frame as image
                String dur_lv1 = listView1.Items[listView2.SelectedItems[0].Index].SubItems[3].Text;
                String lv1_item = listView2.SelectedItems[0].Text;
                lbl_s_th.Text = "-"; lbl_s_th.Refresh();
                lbl_v_th.Text = "-"; lbl_v_th.Refresh();
                lbl_a_th.Text = "-"; lbl_a_th.Refresh();
                pic_frame.Image = pic_frame.InitialImage;
                lbl_gb_th.Text = "-"; lbl_gb_th.Refresh();

                if (!File.Exists(lv1_item)) return;

                if (!Directory.Exists(Path.Combine(Path.GetTempPath(), "FFBatch_Test"))) Directory.CreateDirectory(Path.Combine(Path.GetTempPath(), "FFBatch_Test"));

                String time_frame = "";
                Double t_to = (double)current_fr;
                TimeSpan t1 = TimeSpan.FromMilliseconds((t_to));
                String tx_1 = string.Format("{0:D2}:{1:D2}:{2:D2}.{3:D3}",
                             (int)t1.TotalHours,
                             t1.Minutes,
                             t1.Seconds,
                             t1.Milliseconds);
                time_frame = tx_1;
                String repl_frm = time_frame.Replace(",", "").Replace(".", "").Replace(":", "");

                String ffm_img = Path.Combine(Application.StartupPath, "ffmpeg.exe");
                String itfull = "";

                if (tabControl1.SelectedIndex == 0 && listView1.SelectedItems.Count == 1) itfull = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
                if (tabControl1.SelectedIndex == 1 && listView2.SelectedItems.Count == 1) itfull = listView2.SelectedItems[0].Text;

                String file_img = Path.GetFullPath(lv1_item);
                String fullPath_img = file_img;
                String AppParam_img = "";
                String config_info = Path.Combine(Path.GetTempPath(), "FFBatch_Test") + "\\" + "mediaconfig.txt";
                String rel_path = Path.GetDirectoryName(file_img).Replace(":", "_").Replace("\\", "_") + Path.GetExtension(file_img).Replace(".", "_");
                String target_img = Path.GetTempPath() + "FFBatch_Test" + "\\" + Path.GetFileNameWithoutExtension(file_img) + "_480_" + rel_path + "_" + repl_frm + "." + "jpg";
                String target_info = Path.GetTempPath() + "FFBatch_Test" + "\\" + Path.GetFileNameWithoutExtension(file_img) + rel_path + "_" + "." + "txt";

                String m_info_path = System.IO.Path.Combine(Application.StartupPath, "MediaInfo.exe");

                Task t = Task.Run(() =>
                {
                    List<String> lines_ouput = new List<String>();

                    Process get_frames = new Process();

                    this.Invoke(new MethodInvoker(delegate
                    {
                        try
                        {
                            if (!File.Exists(target_info))
                            {
                                String[] config_lines = new String[3];
                                config_lines[0] = "Video;%Format%" + "\\n" + "%Width%" + "\\n" + "%Height%" + "\\n" + "%DisplayAspectRatio/String%" + "\\n";
                                config_lines[1] = "Audio;%Format%" + "\\n";
                                config_lines[2] = "General;%OverallBitRate/String%" + "\\n";

                                File.WriteAllLines(config_info, config_lines);
                                get_frames.StartInfo.FileName = m_info_path;

                                String ffprobe_frames = " " + "--Inform=file://" + config_info;
                                get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + itfull + '\u0022';
                                get_frames.StartInfo.RedirectStandardOutput = true;
                                get_frames.StartInfo.UseShellExecute = false;
                                get_frames.StartInfo.CreateNoWindow = true;
                                get_frames.EnableRaisingEvents = true;

                                get_frames.Start();

                                while (!get_frames.StandardOutput.EndOfStream)
                                {
                                    lines_ouput.Add(get_frames.StandardOutput.ReadLine());
                                }
                                //foreach (String str in lines_ouput) MessageBox.Show(str);

                                get_frames.WaitForExit();
                                if (get_frames.ExitCode == 0)
                                {
                                    if (lines_ouput[1].ToLower().Contains("visual")) lines_ouput[1] = lines_ouput[1].Replace("Visual", "");
                                    try { lbl_v_th.Text = lines_ouput[1].Replace("Video", "") + "  " + lines_ouput[4]; } catch { }
                                    try { lbl_s_th.Text = lines_ouput[2] + "x" + lines_ouput[3]; } catch { }

                                    try { lbl_a_th.Text = lines_ouput[5].ToLower(); }
                                    catch
                                    {
                                        lbl_a_th.Text = lines_ouput[1].ToLower();
                                        lbl_s_th.Text = "-";
                                        lbl_v_th.Text = "-";
                                        lbl_gb_th.Text = lines_ouput[0];
                                    }
                                    String ext_a0 = Path.GetExtension(file_img);

                                    if (ext_a0 == ".flac" || ext_a0 == ".mp3" || ext_a0 == ".oga" || ext_a0 == ".ape" || ext_a0 == ".wav" || ext_a0 == ".aac" || ext_a0 == ".ac3" || ext_a0 == ".mpa" || ext_a0 == ".mka" || ext_a0 == ".wave" || ext_a0 == ".mp1" || ext_a0 == ".dsd" || ext_a0 == ".wma" || ext_a0 == ".amr" || ext_a0 == ".opus")
                                    {
                                        lbl_v_th.Text = ext_a0.Replace(".", "");
                                    }

                                    try
                                    {
                                        if (lines_ouput[0].Length > 0)
                                        {
                                            System.Globalization.CultureInfo ci = System.Threading.Thread.CurrentThread.CurrentUICulture;
                                            String sep_th = ci.NumberFormat.CurrencyGroupSeparator;
                                            if (lines_ouput[0].Substring(1, 1) == " ")
                                            {
                                                lines_ouput[0] = lines_ouput[0].Substring(0, 1) + sep_th + lines_ouput[0].Substring(2, lines_ouput[0].Length - 2);
                                            }
                                            lbl_gb_th.Text = lines_ouput[0];
                                        }
                                    }
                                    catch { lbl_gb_th.Text = "-"; }
                                }
                                else
                                {
                                    lbl_s_th.Text = "-";
                                    lbl_v_th.Text = "-";
                                    lbl_a_th.Text = "-";
                                    lbl_gb_th.Text = "-";
                                }

                                String info = lbl_v_th.Text + Environment.NewLine + lbl_a_th.Text + Environment.NewLine + lbl_s_th.Text + Environment.NewLine + lbl_gb_th.Text;
                                File.WriteAllText(target_info, info);
                            }
                            else
                            {
                                String[] lines = new String[4];
                                int l = 0;
                                foreach (String line in File.ReadLines(target_info))
                                {
                                    lines[l] = line;
                                    l++;
                                }

                                lbl_v_th.Text = lines[0];
                                lbl_a_th.Text = lines[1];
                                lbl_s_th.Text = lines[2];
                                lbl_gb_th.Text = lines[3];
                            }
                        }
                        catch { }
                    }));

                    //End Get Info

                    if (File.Exists(target_img))
                    {
                        Image img_tmp1;
                        using (var bmpTemp = new Bitmap(target_img))
                        {
                            img_tmp1 = new Bitmap(bmpTemp);

                            pic_frame.Invoke(new MethodInvoker(delegate
                            {
                                try
                                {
                                    pic_frame.Image = img_tmp1;
                                    panel_thumb.Refresh();
                                }
                                catch
                                {
                                    pic_frame.Image = pic_frame.InitialImage;
                                }
                            }));
                        }
                        return;
                    }

                    AppParam_img = " -ss " + time_frame + " -i " + "" + '\u0022' + file_img + '\u0022' + " -qscale:v 0" + " -vf scale=480:-1" + " -f image2 -y " + '\u0022' + target_img + '\u0022';

                    String ext_a = Path.GetExtension(file_img);
                    if (ext_a == ".flac" || ext_a == ".mp3") AppParam_img = " -i " + "" + '\u0022' + file_img + '\u0022' + " -f image2 -y " + '\u0022' + target_img + '\u0022';

                    proc_img.StartInfo.RedirectStandardOutput = false;
                    proc_img.StartInfo.RedirectStandardError = false;
                    proc_img.StartInfo.UseShellExecute = false;
                    proc_img.StartInfo.CreateNoWindow = true;
                    proc_img.EnableRaisingEvents = false;
                    proc_img.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;

                    proc_img.StartInfo.FileName = ffm_img;
                    proc_img.StartInfo.Arguments = AppParam_img;
                    pic_frame.Image = img_list_pic_thumb.Images[0];
                    proc_img.Start();
                    proc_img.WaitForExit(5000);

                    if (File.Exists(target_img))
                    {
                        Image img_tmp;
                        using (var bmpTemp = new Bitmap(target_img))
                        {
                            img_tmp = new Bitmap(bmpTemp);
                            pic_frame.Invoke(new MethodInvoker(delegate
                            {
                                try
                                {
                                    pic_frame.Image = img_tmp;
                                    panel_thumb.Refresh();
                                }
                                catch
                                {
                                    pic_frame.Image = pic_frame.InitialImage;
                                    panel_thumb.Refresh();
                                }
                            }));
                        }
                    }
                    else
                    {
                        String ext_a0 = Path.GetExtension(file_img);

                        if (ext_a0 == ".flac" || ext_a0 == ".mp3" || ext_a0 == ".oga" || ext_a0 == ".ape" || ext_a0 == ".wav" || ext_a0 == ".aac" || ext_a0 == ".ac3" || ext_a0 == ".mpa" || ext_a0 == ".mka" || ext_a0 == ".wave" || ext_a0 == ".mp1" || ext_a0 == ".dsd" || ext_a0 == ".wma" || ext_a0 == ".amr" || ext_a0 == ".opus")
                        {
                            pic_frame.Invoke(new MethodInvoker(delegate
                            {
                                try
                                {
                                    if (lbl_a_th.Text != ext_a0.Replace(".", "")) lbl_v_th.Text = ext_a0.Replace(".", "");
                                    else lbl_v_th.Text = "Audio";
                                    PictureBox pic2 = new PictureBox();
                                    pic2.Image = pic_frame.ErrorImage;
                                    pic_frame.Image = pic2.Image;
                                }
                                catch
                                {
                                    pic_frame.Invoke(new MethodInvoker(delegate
                                    {
                                        pic_frame.Image = pic_frame.InitialImage;
                                    }));
                                }
                            }));
                        }

                        if (ext_a0 == ".jpg" || ext_a0 == ".jpeg" || ext_a0 == ".png" || ext_a0 == ".gif" || ext_a0 == ".tif" || ext_a0 == ".bmp" || ext_a0 == ".ico" || ext_a0 == ".bmp")
                        {
                            pic_frame.Invoke(new MethodInvoker(delegate
                            {
                                try
                                {
                                    PictureBox pic2 = new PictureBox();
                                    pic2.Image = new Bitmap(file_img);
                                    pic_frame.Image = pic2.Image;
                                }
                                catch
                                {
                                    pic_frame.Invoke(new MethodInvoker(delegate
                                    {
                                        pic_frame.Image = pic_frame.InitialImage;
                                    }));
                                }
                            }));

                            get_frames.StartInfo.Arguments = "--Inform=Image;%Width%x%Height%" + " " + '\u0022' + itfull + '\u0022';
                            get_frames.StartInfo.FileName = m_info_path;

                            get_frames.StartInfo.RedirectStandardOutput = true;
                            get_frames.StartInfo.RedirectStandardError = true;
                            get_frames.StartInfo.UseShellExecute = false;
                            get_frames.StartInfo.CreateNoWindow = true;
                            get_frames.EnableRaisingEvents = false;
                            get_frames.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;

                            get_frames.Start();
                            String outp = "-";
                            while (!get_frames.StandardOutput.EndOfStream)
                            {
                                outp = get_frames.StandardOutput.ReadLine();
                            }
                            get_frames.WaitForExit();
                            pic_frame.Invoke(new MethodInvoker(delegate
                            {
                                lbl_v_th.Text = "Image";
                                lbl_s_th.Text = outp;
                                lbl_a_th.Text = ext_a0.Replace(".", "");
                            }));
                        }
                    }
                });
            }
        }

        private void main_menu_streams_Click(object sender, EventArgs e)
        {
            show_str_thumb();
        }

        private void show_str_thumb()
        {
            Form5 frm5 = new Form5();
            if (tabControl1.SelectedIndex == 0)
            {
                if (listView1.Items.Count == 0)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.no_item_sel, FFBatch.Properties.Strings.no_file, MessageBoxButtons.OK);
                    return;
                }
                if (listView1.Items.Count == 1)
                {
                    listView1.Items[0].Selected = true;
                    frm5.lv1_item = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
                    frm5.dur_lv1 = listView1.SelectedItems[0].SubItems[3].Text;
                }
                else
                {
                    if (listView1.SelectedIndices.Count == 1)
                    {
                        frm5.lv1_item = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
                        frm5.dur_lv1 = listView1.SelectedItems[0].SubItems[3].Text;
                    }
                    else return;
                }
            }

            if (tabControl1.SelectedIndex == 1)
            {
                if (listView2.Items.Count == 0)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.no_item_sel, FFBatch.Properties.Strings.no_file, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }
                if (listView2.Items.Count == 1)
                {
                    listView2.Items[0].Selected = true;
                    frm5.lv1_item = listView2.SelectedItems[0].Text;
                    frm5.dur_lv1 = listView1.Items[listView2.SelectedItems[0].Index].SubItems[3].Text;
                }
                else
                {
                    if (listView2.SelectedIndices.Count == 1)
                    {
                        frm5.lv1_item = listView2.SelectedItems[0].Text;
                        frm5.dur_lv1 = listView1.Items[listView2.SelectedItems[0].Index].SubItems[3].Text;
                    }
                    else return;
                }
            }

            if (tabControl1.SelectedIndex == 3)
            {
                frm5.lv1_item = dg1.Rows[dg1.SelectedCells[0].RowIndex].Cells[1].Value.ToString();
                btn_url_info.PerformClick();
                return;
            }

            frm5.current_fr = current_fr;
            frm5.ShowDialog();
            current_fr = frm5.current_fr;
            frm5.Dispose();
            get_frame();
        }

        private void Form1_FormClosed(object sender, FormClosedEventArgs e)
        {
            notifyIcon1.Dispose();
            clean_ffb_test();
        }

        private void btn_min1_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            String dur_lv1 = "";
            String lv1_item = "";
            current_fr = current_fr - 30000;

            if (tabControl1.SelectedIndex == 0)
            {
                if (listView1.SelectedIndices.Count == 1)
                {
                    dur_lv1 = listView1.SelectedItems[0].SubItems[3].Text;
                    lv1_item = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
                }

                if (listView1.SelectedIndices.Count == 0 && listView1.Items.Count == 1)
                {
                    listView1.Items[0].Selected = true;
                    dur_lv1 = listView1.Items[0].SubItems[3].Text;
                    lv1_item = listView1.Items[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
                }
                if (listView1.Items.Count == 1 && listView1.SelectedItems.Count == 0)
                {
                    dur_lv1 = listView1.Items[0].SubItems[3].Text;
                    lv1_item = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text;
                }

                if (listView1.Items.Count == 0) return;
                if (listView1.Items.Count > 0 && listView1.SelectedItems.Count == 0) return;
            }

            if (tabControl1.SelectedIndex == 1)
            {
                if (listView2.SelectedIndices.Count == 1)
                {
                    dur_lv1 = listView1.Items[listView2.SelectedItems[0].Index].SubItems[3].Text;
                    lv1_item = listView2.SelectedItems[0].Text;
                }
                if (listView2.SelectedIndices.Count == 0 && listView2.Items.Count == 1)
                {
                    listView2.Items[0].Selected = true;
                    dur_lv1 = listView1.Items[listView2.Items[0].Index].SubItems[3].Text;
                    lv1_item = listView2.Items[0].Text;
                }
                if (listView2.Items.Count == 1 && listView2.SelectedItems.Count == 0)
                {
                    dur_lv1 = listView1.Items[listView2.Items[0].Index].SubItems[3].Text;
                    lv1_item = listView2.Items[0].Text;
                }
                if (listView2.Items.Count == 0) return;
                if (listView2.Items.Count > 0 && listView2.SelectedItems.Count == 0) return;
            }

            if (current_fr == -30000)
            {
                current_fr = 0;
                return;
            }
            if (current_fr < 0) current_fr = 0;

            get_frame();
        }

        private void btn_plus1_Click(object sender, EventArgs e)
        {
            Pg1.Focus();

            current_fr = current_fr + 30000;
            String dur_lv1 = "";
            String lv1_item = "";

            if (tabControl1.SelectedIndex == 0)
            {
                if (listView1.SelectedIndices.Count == 1)
                {
                    dur_lv1 = listView1.SelectedItems[0].SubItems[3].Text;
                    lv1_item = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
                }

                if (listView1.SelectedIndices.Count == 0 && listView1.Items.Count == 1)
                {
                    listView1.Items[0].Selected = true;
                    dur_lv1 = listView1.Items[0].SubItems[3].Text;
                    lv1_item = listView1.Items[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
                }
                if (listView1.Items.Count == 1 && listView1.SelectedItems.Count == 0)
                {
                    dur_lv1 = listView1.Items[0].SubItems[3].Text;
                    lv1_item = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text;
                }
                if (listView1.Items.Count == 0) return;
                if (listView1.Items.Count > 0 && listView1.SelectedItems.Count == 0) return;
            }

            if (tabControl1.SelectedIndex == 1)
            {
                if (listView2.SelectedIndices.Count == 1)
                {
                    dur_lv1 = listView1.Items[listView2.SelectedItems[0].Index].SubItems[3].Text;
                    lv1_item = listView2.SelectedItems[0].Text;
                }
                if (listView2.SelectedIndices.Count == 0 && listView2.Items.Count == 1)
                {
                    listView2.Items[0].Selected = true;
                    dur_lv1 = listView1.Items[listView2.Items[0].Index].SubItems[3].Text;
                    lv1_item = listView2.Items[0].Text;
                }
                if (listView2.Items.Count == 1 && listView2.SelectedItems.Count == 0)
                {
                    dur_lv1 = listView1.Items[listView2.Items[0].Index].SubItems[3].Text;
                    lv1_item = listView2.Items[0].Text;
                }
                if (listView2.Items.Count == 0) return;
                if (listView2.Items.Count > 0 && listView2.SelectedItems.Count == 0) return;
            }

            DateTime time2;
            Double seconds = 0;

            if (DateTime.TryParse(dur_lv1, out time2))
            {
                seconds = TimeSpan.Parse(dur_lv1).TotalMilliseconds;
            }
            int secs = (int)seconds;

            if (current_fr == secs + 30000)
            {
                current_fr = secs;
                return;
            }
            if (secs < current_fr) current_fr = secs;
            get_frame();
        }

        private void ct2_del_Click(object sender, EventArgs e)
        {
            try
            {
                foreach (ListViewItem item in listView2.SelectedItems)
                {
                    listView1.FindItemWithText(Path.GetFileName(item.Text));
                    listView1.Items.RemoveAt(item.Index);
                    listView2.Items.RemoveAt(item.Index);
                }
            }
            catch { }

            //listView2.Items.RemoveAt(listView2.SelectedItems[0].Index);

            listView1.BeginUpdate();
            foreach (ListViewItem item in listView1.SelectedItems)
            {
                if (working == false)
                {
                    listView1.Items.Remove(item);

                    foreach (ListViewItem item2 in listView3.Items)
                    {
                        if (item2.Text == item.Text)
                        {
                            listView3.Items.RemoveAt(item2.Index);
                        }
                    }
                }
                else
                {
                    if (item.SubItems[5].Text == FFBatch.Properties.Strings.queued)
                    {
                        listView1.Items.RemoveAt(item.Index);
                    }
                }
            }

            listView1.EndUpdate();
            lbl_items.Text = listView1.Items.Count + " " + FFBatch.Properties.Strings.files;

            calc_total_dur();
            calc_list_size();

            if (working == true && multi_running == false)
            {
                total_duration = 0;

                foreach (ListViewItem item in listView1.Items)
                {
                    if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                    {
                        total_duration = total_duration + TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds - TimeSpan.Parse(ss_time_input.Text).TotalSeconds;
                    }
                    else
                    {
                        total_duration = total_duration + 0;
                    }
                }
            }
        }

        private void listView1_DragLeave(object sender, EventArgs e)
        {
            listView1.BackgroundImage = null;
            if (Properties.Settings.Default.dark_mode == false) listView1.BackColor = SystemColors.Window;
            else
                listView1.BackColor = Color.FromArgb(255, 64, 64, 64);
        }

        private void BG_add_VBitrate_col_DoWork(object sender, DoWorkEventArgs e)
        {
            Disable_Controls();
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.btn_pause.Enabled = false);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.pg_adding.Visible = true);
            this.InvokeEx(f => f.pg_adding.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Visible = true);
            this.InvokeEx(f => f.txt_adding_p.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Refresh());
            this.InvokeEx(f => f.LB_Wait.Visible = true);
            this.InvokeEx(f => f.LB_Wait.Enabled = true);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Minimum = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.btn_cancel_add.Visible = true);
            this.InvokeEx(f => f.btn_cancel_add.Enabled = true);
            canceled_file_adding = false;

            int i = 0;
            listView1.Invoke(new MethodInvoker(delegate
            {
                listView1.BeginUpdate();
                foreach (ListViewItem item in listView1.Items)
                {
                    String itfull = item.SubItems[1].Text + "\\" + item.Text;

                    Boolean has_streams = false;
                    Boolean has_video = false;

                    if (canceled_file_adding == false)
                    {
                        String ff_frames = String.Empty;
                        Process get_frames = new Process();
                        get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "Mediainfo.exe");
                        String ffprobe_frames = "--Inform=Video;%BitRate/String%";
                        get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + itfull + '\u0022';
                        get_frames.StartInfo.RedirectStandardOutput = true;
                        get_frames.StartInfo.RedirectStandardError = true;
                        get_frames.StartInfo.UseShellExecute = false;
                        get_frames.StartInfo.CreateNoWindow = true;
                        get_frames.EnableRaisingEvents = true;
                        get_frames.Start();
                        ff_frames = get_frames.StandardOutput.ReadLine();
                        get_frames.WaitForExit();
                        if (get_frames.ExitCode == 0)
                        {
                            if (ff_frames != null)
                            {
                                has_streams = true;
                                if (ff_frames.Length == 0)
                                {
                                    ff_frames = "-";
                                }
                            }
                            else
                            {
                                ff_frames = "-";
                            }
                        }
                        else
                        {
                            ff_frames = "-";
                        }

                        i++;

                        if (ff_frames.Length > 1)
                        {
                            this.InvokeEx(f => listView1.Items[item.Index].SubItems.Add(ff_frames));
                        }
                        else
                        {
                            this.InvokeEx(f => listView1.Items[item.Index].SubItems.Add("-"));
                        }
                        //}

                        this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.add_col1);
                        this.InvokeEx(f => f.LB_Wait.Refresh());
                        this.InvokeEx(f => f.pg_adding.Value = pg_adding.Value + 1);
                        this.InvokeEx(f => f.pg_adding.Refresh());
                        this.InvokeEx(f => f.txt_adding_p.Text = (i * 100 / pg_adding.Maximum).ToString() + "%");
                        this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, i * 100 / pg_adding.Maximum, 100));
                        this.InvokeEx(f => f.txt_adding_p.Refresh());
                    }
                    else
                    {
                        timer_adding.Stop();
                        this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
                        this.InvokeEx(f => f.txt_add_remain.Visible = false);
                        this.InvokeEx(f => f.txt_add_remain.Refresh());
                        break;
                    }
                }
                this.InvokeEx(f => f.listView1.EndUpdate());
            }));

            timer_adding.Stop();
            this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
            this.InvokeEx(f => f.txt_add_remain.Visible = false);
            this.InvokeEx(f => f.txt_add_remain.Refresh());
            this.InvokeEx(f => f.LB_Wait.Text = "");
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
        }

        private void BG_add_VBitrate_col_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            end_bg_filters();
        }

        private Boolean check_ff_md5()
        {
            //Check MD5 ffmpeg

            String ffm = Path.Combine(Application.StartupPath, "ffmpeg.exe");
            String f_md5 = String.Empty;
            if (is_portable == false) { f_md5 = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_md5.ini"; }
            else { f_md5 = port_path + "ff_md5_portable.ini"; }
            String saved = Properties.Strings2.none;
            String code = "";
            String psk = "FFBatch2022_()*_";
            if (File.Exists(f_md5))
            {
                saved = StringCipher.Decrypt(File.ReadAllText(f_md5), psk);
            }

            using (var md5 = MD5.Create())
            {
                using (var stream = File.OpenRead(ffm))
                {
                    var hash = md5.ComputeHash(stream);
                    code = BitConverter.ToString(hash).Replace("-", "").ToLowerInvariant();
                }
            }
            if (saved != code)
            {
                MessageBox.Show(Properties.Strings2.md5_fail1 + Environment.NewLine + Environment.NewLine + Properties.Strings2.md5_trust + Environment.NewLine + Environment.NewLine + Properties.Strings2.md5_reinst, Properties.Strings2.md5_fail, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return false;
            }
            return true;
        }

        public void UpdateColorDark(Control myControl)
        {
            myControl.BackColor = Color.FromArgb(255, 64, 64, 64);
            myControl.ForeColor = Color.White;
            foreach (Control subC in myControl.Controls)
            {
                UpdateColorDark(subC);
            }
        }

        public void UpdateColorDefault(Control myControl)
        {
            myControl.BackColor = SystemColors.InactiveBorder;
            myControl.ForeColor = Control.DefaultForeColor;
            foreach (Control subC in myControl.Controls)
            {
                UpdateColorDefault(subC);
            }
        }

        private void post_dark()
        {
            pic_frame.Image = img_list_pic_thumb.Images[1];
            pic_frame.InitialImage = img_list_pic_thumb.Images[1];
            this.BackColor = Color.FromArgb(255, 64, 64, 64);
            listView1.BackColor = Color.FromArgb(255, 64, 64, 64); listView1.Refresh();
            listView2.BackColor = Color.FromArgb(255, 64, 64, 64); listView2.Refresh();
            listView3.BackColor = Color.FromArgb(255, 64, 64, 64); listView3.Refresh();
            dg1.BackgroundColor = Color.Gray;
            dg1.RowsDefaultCellStyle.BackColor = Color.Gray;
        }

        private void post_color_def()
        {
            pic_frame.Image = img_list_pic_thumb.Images[2];
            pic_frame.InitialImage = img_list_pic_thumb.Images[2];
            this.BackColor = SystemColors.InactiveBorder;
            listView1.BackColor = SystemColors.Window;
            listView1.Refresh();
            listView2.BackColor = SystemColors.Window; listView2.Refresh();
            listView3.BackColor = SystemColors.Window; listView3.Refresh();
            list_tracks.BackColor = SystemColors.Window; 
            listView3.BackColor = Color.White;
            txt_parameters.BackColor = Color.White;
            combo_presets.BackColor = Color.White;
            dg1.BackgroundColor = SystemColors.InactiveBorder;
            dg1.RowsDefaultCellStyle.BackColor = Color.White;
            main_menu.BackColor = SystemColors.InactiveBorder;            
        }

        private void BG_Add_col_abit_DoWork(object sender, DoWorkEventArgs e)
        {
            Disable_Controls();
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.btn_pause.Enabled = false);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.pg_adding.Visible = true);
            this.InvokeEx(f => f.pg_adding.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Visible = true);
            this.InvokeEx(f => f.txt_adding_p.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Refresh());
            this.InvokeEx(f => f.LB_Wait.Visible = true);
            this.InvokeEx(f => f.LB_Wait.Enabled = true);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Minimum = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.btn_cancel_add.Visible = true);
            this.InvokeEx(f => f.btn_cancel_add.Enabled = true);
            canceled_file_adding = false;

            int i = 0;
            listView1.Invoke(new MethodInvoker(delegate
            {
                listView1.BeginUpdate();
                foreach (ListViewItem item in listView1.Items)
                {
                    String itfull = item.SubItems[1].Text + "\\" + item.Text;

                    Boolean has_streams = false;
                    Boolean has_video = false;

                    if (canceled_file_adding == false)
                    {
                        String ff_frames = String.Empty;
                        Process get_frames = new Process();
                        get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "Mediainfo.exe");
                        String ffprobe_frames = "--Inform=Audio;%BitRate/String%" + "\\n";
                        get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + itfull + '\u0022';
                        get_frames.StartInfo.RedirectStandardOutput = true;
                        get_frames.StartInfo.RedirectStandardError = true;
                        get_frames.StartInfo.UseShellExecute = false;
                        get_frames.StartInfo.CreateNoWindow = true;
                        get_frames.EnableRaisingEvents = true;
                        get_frames.Start();
                        ff_frames = get_frames.StandardOutput.ReadLine();
                        get_frames.WaitForExit();
                        if (get_frames.ExitCode == 0)
                        {
                            if (ff_frames != null)
                            {
                                has_streams = true;
                                if (ff_frames.Length == 0)
                                {
                                    ff_frames = "-";
                                }
                            }
                            else
                            {
                                ff_frames = "-";
                            }
                        }
                        else
                        {
                            ff_frames = "-";
                        }

                        i++;

                        if (ff_frames.Length > 1)
                        {
                            this.InvokeEx(f => listView1.Items[item.Index].SubItems.Add(ff_frames));
                        }
                        else
                        {
                            this.InvokeEx(f => listView1.Items[item.Index].SubItems.Add("-"));
                        }
                        //}

                        this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.add_col1);
                        this.InvokeEx(f => f.LB_Wait.Refresh());
                        this.InvokeEx(f => f.pg_adding.Value = pg_adding.Value + 1);
                        this.InvokeEx(f => f.pg_adding.Refresh());
                        this.InvokeEx(f => f.txt_adding_p.Text = (i * 100 / pg_adding.Maximum).ToString() + "%");
                        this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, i * 100 / pg_adding.Maximum, 100));
                        this.InvokeEx(f => f.txt_adding_p.Refresh());
                    }
                    else
                    {
                        timer_adding.Stop();
                        this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
                        this.InvokeEx(f => f.txt_add_remain.Visible = false);
                        this.InvokeEx(f => f.txt_add_remain.Refresh());
                        break;
                    }
                }
                this.InvokeEx(f => f.listView1.EndUpdate());
            }));

            timer_adding.Stop();
            this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
            this.InvokeEx(f => f.txt_add_remain.Visible = false);
            this.InvokeEx(f => f.txt_add_remain.Refresh());
            this.InvokeEx(f => f.LB_Wait.Text = "");
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
        }

        private void BG_Add_col_abit_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            end_bg_filters();
        }

        private void timer_yt_Tick(object sender, EventArgs e)
        {
            show_est = !show_est;
        }

        private void dg1_CellMouseEnter(object sender, DataGridViewCellEventArgs e)
        {
            if (e.ColumnIndex == 0) this.Cursor = Cursors.Hand;
            else this.Cursor = Cursors.Arrow;
        }

        private void dg1_CellMouseLeave(object sender, DataGridViewCellEventArgs e)
        {
            this.Cursor = Cursors.Arrow;
        }

        private void dg1_CellMouseClick(object sender, DataGridViewCellMouseEventArgs e)
        {
            try
            {
                if (dg1.Rows.Count > 0 && dg1.Rows[e.RowIndex].Cells[0].Selected == true && dg1.Rows[e.RowIndex].Cells[5].Value.ToString() != String.Empty && dg1.Rows.Count > 0)
                {
                    if (dg_thumbs[dg1.SelectedCells[0].RowIndex] != null && dg_thumbs[dg1.SelectedCells[0].RowIndex].Width > 160)
                    {
                        Form10 frm = new Form10();
                        frm.pic_y.Image = dg_thumbs[dg1.SelectedCells[0].RowIndex];
                        frm.ShowDialog();
                    }
                }
            }
            catch { }
        }

        private void dg1_CellMouseMove(object sender, DataGridViewCellMouseEventArgs e)
        {
            if (e.ColumnIndex == 0) this.Cursor = Cursors.Hand;
            else this.Cursor = Cursors.Arrow;
        }

        private void dg1_MouseLeave(object sender, EventArgs e)
        {
            this.Cursor = Cursors.Arrow;
        }

        private void listView2_DragLeave(object sender, EventArgs e)
        {
            listView2.BackgroundImage = null;
            if (Properties.Settings.Default.dark_mode == false) listView2.BackColor = SystemColors.Window;
            else
                listView2.BackColor = Color.FromArgb(255, 64, 64, 64);
        }

        private void BG_Selected_items_DoWork(object sender, DoWorkEventArgs e)
        {
            warn_enc = 0;

            String hw_decode = String.Empty;

            cb_hwdecode.Invoke(new MethodInvoker(delegate
            {
                if (cb_hwdecode.SelectedItem.ToString() != "none")
                {
                    hw_decode = "-hwaccel " + cb_hwdecode.SelectedItem.ToString();
                }
            }));

            procs.Clear();
            multi_logs.Clear();
            multi_params.Clear();
            multi_speeds.Clear();
            multi_fps.Clear();

            lbl_speed.Invoke(new MethodInvoker(delegate
            {
                lbl_speed.Text = "";
            }));

            List<string> destis = new List<string>();
            List<string> list_lines = new List<string>();
            list_successful_m.Clear();
            list_failed_m.Clear();

            foreach (int i in selecs)
            {
                procs.Add("proc_urls_" + i.ToString(), new Process());
                destis.Add("destis_" + i.ToString());
                multi_logs.Add("log_n_" + i.ToString(), "");
                multi_params.Add("path_n_" + i.ToString(), "");
            }

            listView1.Invoke(new MethodInvoker(delegate
            {
                //for (int ii = 0; ii < listView1.SelectedItems.Count; ii++)
                //{
                //    procs.Add("proc_urls_" + ii.ToString(), new Process());
                //    destis.Add("destis_" + ii.ToString());
                //    multi_logs.Add("log_n_" + ii.ToString(), "");
                //    multi_params.Add("path_n_" + ii.ToString(), "");

                //}

                foreach (ListViewItem item in listView1.SelectedItems)
                {
                    multi_speeds.Add("0");
                    multi_fps.Add("0");
                }
            }));

            this.InvokeEx(f => f.Pg1.Text = "0%");

            Disable_Controls();
            this.InvokeEx(f => f.btn_add_files.Enabled = true);

            ParallelOptions par_op = new ParallelOptions();
            CancellationTokenSource cts = new System.Threading.CancellationTokenSource();
            par_op.CancellationToken = cts.Token;
            par_op.MaxDegreeOfParallelism = Convert.ToInt16(n_threads.Value);

            opened_m = false;
            aborted = false;
            Decimal tot_frames2 = 0;
            warn_space = true;
            int list_count = 0;

            IEnumerable<int> items_lv = Enumerable.Range(0, selecs.Count);

            ParallelLoopResult result = new ParallelLoopResult();

            try
            {
                result = Parallel.ForEach(items_lv.AsParallel().AsOrdered(), par_op, (file_int) =>
                {
                    Task
                        .Factory
                        .StartNew(() =>
                        {
                            if (cancelados_paralelos == true || aborted == true)
                            {
                                cts.Cancel();
                                timer_selecs.Stop();
                                timer_tasks.Stop();
                                working = false;
                                multi_running = false;
                                return;
                            }

                            Boolean skipped = false;
                            String item_capture_time = String.Empty;
                            String fullPath = "";
                            Double total_prog = 0;
                            Double row_duration = 0;
                            Boolean valid_prog2 = false;
                            TimeSpan time2;
                            int space_timer = 0;

                            listView1.Invoke(new MethodInvoker(delegate
                            {
                                if (listView1.Items[selecs[file_int]].SubItems[5].Text == FFBatch.Properties.Strings.skipped) skipped = true;
                                if (TimeSpan.TryParse(listView1.Items[selecs[file_int]].SubItems[3].Text, out time2))
                                {
                                    row_duration = TimeSpan.Parse(listView1.Items[selecs[file_int]].SubItems[3].Text).TotalSeconds - TimeSpan.Parse(ss_time_input.Text).TotalSeconds;
                                    valid_prog2 = true;
                                }
                                else
                                {
                                    row_duration = 0;
                                    valid_prog2 = false;
                                }

                                fullPath = listView1.Items[selecs[file_int]].SubItems[1].Text + "\\" + listView1.Items[selecs[file_int]].Text;
                            }));

                            if (skipped == true)
                            {
                                this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = FFBatch.Properties.Strings.skipped);
                                return;
                            }

                            String ffm = System.IO.Path.Combine(Application.StartupPath, "ffmpeg.exe");

                            // Average frames
                            int fframes = 0;
                            Decimal dec = 0;
                            try
                            {
                                String ff_frames = String.Empty;

                                Process get_frames = new Process();
                                get_frames.StartInfo.FileName = System.IO.Path.Combine(Application.StartupPath, "mediainfo.exe");
                                String ffprobe_frames = "--Output=" + '\u0022' + "Video;%FrameCount%" + '\u0022';
                                get_frames.StartInfo.Arguments = ffprobe_frames + " " + '\u0022' + fullPath + '\u0022';
                                get_frames.StartInfo.RedirectStandardOutput = true;
                                get_frames.StartInfo.RedirectStandardError = true;
                                get_frames.StartInfo.UseShellExecute = false;
                                get_frames.StartInfo.CreateNoWindow = true;
                                get_frames.EnableRaisingEvents = true;
                                get_frames.Start();

                                ff_frames = get_frames.StandardOutput.ReadLine();
                                get_frames.WaitForExit(3000);

                                if (get_frames.ExitCode == 0)
                                {
                                    if (ff_frames != null)
                                    {
                                        dec = decimal.Parse(ff_frames);
                                        if (dec.ToString().Substring(dec.ToString().Length - 1, 1) == "0") dec = dec / 10;
                                    }
                                    else
                                    {
                                        dec = 0;
                                    }

                                    get_frames.Dispose();
                                    tot_frames2 = tot_frames2 + dec;
                                }
                            }
                            catch
                            {
                                dec = 0;
                            }

                            // End average frames

                            //Begin Shifting
                            String shifting = "";
                            if (chk_shift.Checked == true)
                            {
                                shifting = " -itsoffset " + Num_Shift.Value.ToString().Replace(",", ".") + " -i " + '\u0022' + fullPath + '\u0022' + " -map 1:v -map 0:a ";
                            }

                            //End Shifting

                            //Change Volume
                            String change_vol = "";
                            if (chk_vol.Checked == true)
                            {
                                change_vol = "-filter:a " + '\u0022' + "volume=" + vol_ch.Value.ToString() + "dB " + '\u0022' + " ";
                            }
                            //End change volume

                            if (txt_path_main.Text.Contains(".\\"))
                            {
                                if (txt_path_main.Text != ".\\")
                                {
                                    destis[file_int] = fullPath.Substring(0, fullPath.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
                                }
                                else
                                {
                                    destis[file_int] = Path.GetDirectoryName(fullPath);
                                }
                            }
                            else
                            {
                                if (checkBox1.CheckState == CheckState.Checked)
                                {
                                    String pre_dest = Path.GetDirectoryName(fullPath);
                                    destis[file_int] = Path.Combine(txt_path_main.Text, pre_dest.Substring(3, pre_dest.Length - 3));
                                }
                                else
                                {
                                    destis[file_int] = txt_path_main.Text;
                                }
                            }
                            if (!Directory.Exists(destis[file_int]))
                            {
                                Directory.CreateDirectory(destis[file_int]);
                            }
                            multi_dest = destis[file_int];

                            String pre_input_var = "";
                            if (txt_pre_input.Text != "")
                            {
                                pre_input_var = txt_pre_input.Text;
                            }

                            String pre_ss = "";
                            if (TimeSpan.Parse(ss_time_input.Text).TotalSeconds != 0)
                            {
                                pre_ss = " -ss " + ss_time_input.Text;
                            }

                            add_suffix = "";
                            if (chk_suffix.Checked == true && txt_suffix.Text != String.Empty)
                            {
                                add_suffix = txt_suffix.Text;
                                n_th_suffix = add_suffix;
                            }

                            String ext_output1 = txt_format.Text;
                            if (txt_format.Text.Length == 0)
                            {
                                ext_output1 = Path.GetExtension(fullPath);
                            }
                            else
                            {
                                ext_output1 = "." + txt_format.Text;
                            }
                            n_th_source_ext = ext_output1;

                            // textbox_params = txt_parameters.Text;

                            var tmp = procs["proc_urls_" + selecs[file_int].ToString()];
                            var n_logs = multi_logs["log_n_" + selecs[file_int].ToString()];
                            var tmp_params = multi_params["path_n_" + selecs[file_int].ToString()];
                            tmp_params = txt_parameters.Text;

                            if (txt_format.Text == "nul") ext_output1 = "nul";

                            String file2 = fullPath;
                            while (tmp_params.Contains("%fn"))
                            {
                                if (tmp_params.Contains("%fn"))
                                {
                                    tmp_params = tmp_params.Replace("%fn", Path.GetFileNameWithoutExtension(file2));
                                }
                            }
                            while (tmp_params.Contains("%fp"))
                            {
                                if (tmp_params.Contains("%fp"))
                                {
                                    tmp_params = tmp_params.Replace("%fp", Path.GetDirectoryName(file2));
                                }
                            }

                            while (tmp_params.Contains("%fd"))
                            {
                                if (tmp_params.Contains("%fd"))
                                {
                                    var path = Path.GetFullPath(file2);
                                    var dirName = Path.GetFileName(Path.GetDirectoryName(path));
                                    tmp_params = tmp_params.Replace("%fd", dirName);
                                }
                            }

                            while (tmp_params.Contains("%1"))
                            {
                                if (tmp_params.Contains("%1"))
                                {
                                    file2 = file2.Replace("\\", "\\\\\\\\");
                                    file2 = file2.Replace(":", ":" + "\\\\");
                                    tmp_params = tmp_params.Replace("%1", '\u0022' + file2 + '\u0022');
                                }
                            }

                            while (tmp_params.Contains("%2"))
                            {
                                if (tmp_params.Contains("%2"))
                                {
                                    file2 = file2.Replace("\\", "\\\\\\\\");
                                    file2 = file2.Replace(":", ":" + "\\\\");
                                    tmp_params = tmp_params.Replace("%2", '\u0022' + Path.Combine(System.IO.Path.GetDirectoryName(file2), Path.GetFileNameWithoutExtension(file2)) + '\u0022');
                                }
                            }

                            tmp.StartInfo.Arguments = hw_decode + " " + pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + fullPath + '\u0022' + " " + shifting + " " + " -y " + tmp_params + " " + change_vol + '\u0022' + destis[file_int] + "\\" + System.IO.Path.GetFileNameWithoutExtension(fullPath) + add_suffix + ext_output1 + '\u0022' + " -hide_banner";
                            if (ext_output1 == "nul") tmp.StartInfo.Arguments = hw_decode + " " + pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + fullPath + '\u0022' + " " + shifting + " " + tmp_params + " " + change_vol + " " + " -hide_banner";

                            String second_path = "";
                            if (ext_output1 == "nul")
                            {
                                String[] split = txt_parameters.Text.Split(' ');
                                for (int i = 0; i < split.Length; i++)
                                {
                                    if (split[i].Contains("\\") == true)
                                    {
                                        String pre_path = split[i].Replace("%fp", Path.GetDirectoryName(file2)).Replace("%fn", Path.GetFileNameWithoutExtension(file2)).Replace("%", "_");
                                        second_path = Path.GetDirectoryName(pre_path.Replace('\u0022', ' '));

                                        if (!Directory.Exists(second_path))
                                        {
                                            try
                                            {
                                                Directory.CreateDirectory(second_path);
                                            }
                                            catch
                                            {
                                            }
                                        }
                                    }
                                }
                            }

                            String current_out = destis[file_int] + "\\" + System.IO.Path.GetFileNameWithoutExtension(fullPath) + add_suffix + ext_output1;
                            Boolean to_overw = false;

                            if (chk_overw.CheckState == CheckState.Checked)
                            {
                                if (current_out == fullPath)
                                {
                                    tmp.StartInfo.Arguments = hw_decode + " " + pre_input_var + " " + pre_ss + " -i " + "" + '\u0022' + fullPath + '\u0022' + " " + shifting + " " + " -y " + tmp_params + " " + change_vol + '\u0022' + destis[file_int] + "\\" + System.IO.Path.GetFileNameWithoutExtension(fullPath) + "_fftemp" + add_suffix + ext_output1 + '\u0022' + " -hide_banner";
                                    to_overw = true;
                                }
                            }

                            if (current_out == fullPath && chk_overw.CheckState == CheckState.Unchecked)
                            {
                                MessageBox.Show(FFBatch.Properties.Strings.source_overw + Environment.NewLine + Environment.NewLine + current_out, FFBatch.Properties.Strings.overw_not, MessageBoxButtons.OK, MessageBoxIcon.Error);
                                this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                                working = false;
                                time_est_size = 0;
                                cts.Cancel();
                                Enable_Controls();
                                cancelados_paralelos = true;
                            }

                            //Monitor available space

                            DriveInfo dest_drive2 = new DriveInfo(Application.StartupPath);

                            FileInfo f_root2 = new FileInfo(current_out);
                            try
                            {
                                dest_drive2 = new DriveInfo(f_root2.Directory.Root.FullName);
                            }
                            catch { warn_space = false; }

                            if (dest_drive2.AvailableFreeSpace != null && warn_space == true)
                            {
                                if (dest_drive2.AvailableFreeSpace <= 500000000)
                                {
                                    DialogResult a = DialogResult.Cancel;

                                    a = MessageBox.Show(Properties.Strings2.warn_sp, Properties.Strings2.low_sp + " (" + (dest_drive2.AvailableFreeSpace / 1000000).ToString() + "MB)", MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation);
                                    if (a == DialogResult.Yes)
                                    {
                                        aborted = true;
                                        this.InvokeEx(f => f.lbl_est_size.Text = "");
                                        this.InvokeEx(f => f.lbl_bitrate.Text = "");
                                        cts.Cancel();
                                        return;
                                    }
                                }
                            }
                            //End monitor available space

                            if (verbose_logs == false) tmp.StartInfo.Arguments = tmp.StartInfo.Arguments + " -loglevel warning -stats";
                            if (cts.IsCancellationRequested == false)
                            {
                                tmp.StartInfo.FileName = ffm;
                                tmp.StartInfo.RedirectStandardInput = true;
                                tmp.StartInfo.RedirectStandardOutput = true;
                                tmp.StartInfo.RedirectStandardError = true;
                                tmp.StartInfo.UseShellExecute = false;
                                tmp.StartInfo.CreateNoWindow = true;
                                tmp.EnableRaisingEvents = true;

                                tmp.Start();
                                this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = FFBatch.Properties.Strings.processing);

                                combo_prio.Invoke(new MethodInvoker(delegate
                                {
                                    if (combo_prio.SelectedIndex != 2)
                                    {
                                        try
                                        {
                                            if (combo_prio.SelectedIndex == 0) tmp.PriorityClass = ProcessPriorityClass.High;
                                            if (combo_prio.SelectedIndex == 1) tmp.PriorityClass = ProcessPriorityClass.AboveNormal;
                                            if (combo_prio.SelectedIndex == 2) tmp.PriorityClass = ProcessPriorityClass.Normal;
                                            if (combo_prio.SelectedIndex == 3) tmp.PriorityClass = ProcessPriorityClass.BelowNormal;
                                            if (combo_prio.SelectedIndex == 4) tmp.PriorityClass = ProcessPriorityClass.Idle;
                                            Process[] localByName = Process.GetProcessesByName("FFBatch");
                                            if (localByName.Length == 1)
                                            {
                                                foreach (Process proc1 in localByName)
                                                {
                                                    if (combo_prio.SelectedIndex >= 2) proc1.PriorityClass = ProcessPriorityClass.Normal;
                                                    else proc1.PriorityClass = tmp.PriorityClass;
                                                }
                                            }
                                        }
                                        catch { }
                                    }
                                }));
                            }
                            else
                            {
                                timer_selecs.Stop();
                                this.InvokeEx(f => f.listView1.Enabled = true);
                                working = false;
                                multi_running = false;
                                Enable_Controls();
                                cancelados_paralelos = false;
                                return;
                            }

                            this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = FFBatch.Properties.Strings.processing);

                            FileInfo f_root = new FileInfo(destis[file_int]);
                            DriveInfo dest_drive = new DriveInfo(Application.StartupPath);
                            try
                            {
                                dest_drive = new DriveInfo(f_root.Directory.Root.FullName);
                            }
                            catch { warn_space = false; }

                            String err_txt = "";
                            Double interval = 0;
                            Double durat_n2 = 0;
                            this.InvokeEx(f => multi_logs["log_n_" + selecs[file_int].ToString()] = Properties.Strings2.logging_f + " " + '\u0022' + listView1.Items[selecs[file_int]].Text + '\u0022' + Environment.NewLine);
                            //REVIEW
                            while (!tmp.StandardError.EndOfStream)
                            {
                                err_txt = tmp.StandardError.ReadLine();
                                space_timer++;
                                multi_logs["log_n_" + selecs[file_int].ToString()] = multi_logs["log_n_" + selecs[file_int].ToString()] + Environment.NewLine + n_logs + err_txt;

                                if (err_txt.Contains("time=") && err_txt.Contains("time=-") == false)
                                {
                                    if (valid_prog2 == true)
                                    {
                                        this.InvokeEx(f => f.txt_remain.Refresh());
                                        this.InvokeEx(f => durat_n2 = row_duration);
                                        int start_time_index = err_txt.IndexOf("time=") + 5;
                                        Double sec_prog = TimeSpan.Parse(err_txt.Substring(start_time_index, 8)).TotalSeconds;
                                        Double percent = (sec_prog * 100 / durat_n2);

                                        total_prog = total_prog + (sec_prog - interval);
                                        interval = sec_prog;
                                        int percent2 = 0;
                                        try
                                        {
                                            percent2 = Convert.ToInt32(percent);
                                        }
                                        catch
                                        {
                                        }

                                        if (percent2 <= 100)
                                        {
                                            if (Math.Round(percent, 1).ToString().Contains(".") || Math.Round(percent, 1).ToString().Contains(","))
                                            {
                                                this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = Math.Round(percent, 1).ToString() + "%");
                                            }
                                            else
                                            {
                                                this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = Math.Round(percent, 1).ToString() + ".0" + "%");
                                            }
                                        }
                                    }
                                    try
                                    {
                                        if (err_txt.Contains("fps="))
                                        {
                                            multi_fps[file_int] = (err_txt.Substring(err_txt.LastIndexOf("fps=") + 4, 4)).TrimStart();
                                        }
                                        else
                                        {
                                            multi_fps[file_int] = "0";
                                        }
                                    }
                                    catch { multi_fps[file_int] = "0"; }
                                    try
                                    {
                                        if (err_txt.ToLower().Contains("speed="))
                                        {
                                            multi_speeds[file_int] = (err_txt.Substring(err_txt.LastIndexOf("speed=") + 6, err_txt.Length - err_txt.LastIndexOf("speed=") - 6)).Replace("x", "");
                                        }
                                        else
                                        {
                                            multi_speeds[file_int] = "0";
                                        }
                                    }
                                    catch { multi_speeds[file_int] = "0"; }
                                }

                                //Monitor available space
                                if (space_timer % 30 == 0 && dest_drive.AvailableFreeSpace <= 500000000 && warn_space == true)
                                {
                                    foreach (Process proc in procs.Values)
                                    {
                                        try
                                        {
                                            proc.Suspend();
                                        }
                                        catch
                                        {
                                        }
                                    }
                                    DialogResult a = MessageBox.Show(Properties.Strings2.warn_sp, Properties.Strings2.low_sp + " (" + (dest_drive2.AvailableFreeSpace / 1000000).ToString() + "MB)", MessageBoxButtons.YesNo, MessageBoxIcon.Exclamation);
                                    foreach (Process proc in procs.Values)
                                    {
                                        try
                                        {
                                            proc.Resume();
                                        }
                                        catch
                                        {
                                        }
                                    }

                                    if (a == DialogResult.Yes)
                                    {
                                        cts.Cancel();
                                        aborted = true;
                                        cancelados_paralelos = true;

                                        foreach (Process proc in procs.Values)
                                        {
                                            cancelados_paralelos = true;
                                            if (proc.StartInfo.Arguments != String.Empty)

                                            {
                                                try
                                                {
                                                    StreamWriter write_q = proc.StandardInput;
                                                    write_q.Write("q");
                                                }
                                                catch { }
                                            }
                                        }
                                    }

                                    warn_space = false;
                                }
                                //End monitor space
                            }
                            tmp.WaitForExit();
                            tmp.StartInfo.Arguments = String.Empty;
                            multi_speeds[file_int] = "0";
                            multi_fps[file_int] = "0";
                            this.InvokeEx(f => multi_logs["log_n_" + selecs[file_int].ToString()] = multi_logs["log_n_" + selecs[file_int].ToString()] + Environment.NewLine + "--------End of " + '\u0022' + listView1.Items[selecs[file_int]].Text + '\u0022' + " log--------" + Environment.NewLine);

                            if (tmp.ExitCode == 0)
                            {
                                list_successful_m.Add(fullPath);
                                if (cancelados_paralelos == false && cts.IsCancellationRequested == false)
                                {
                                    if (aborted_url == false)
                                    {
                                        if (File.Exists(fullPath) == true)
                                        {
                                            this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = FFBatch.Properties.Strings.success);

                                            if (chk_overw.CheckState == CheckState.Checked)
                                            {
                                                if (current_out == fullPath)
                                                {
                                                    String sourc = destis[file_int] + "\\" + System.IO.Path.GetFileNameWithoutExtension(fullPath) + "_fftemp" + add_suffix + ext_output1;

                                                    try
                                                    {
                                                        if (File.Exists(sourc))
                                                        {
                                                            File.Delete(fullPath);
                                                            FileSystem.RenameFile(sourc, Path.GetFileNameWithoutExtension(fullPath) + add_suffix + ext_output1);
                                                            this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = FFBatch.Properties.Strings.replaced);
                                                        }
                                                        else
                                                        {
                                                            this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = FFBatch.Properties.Strings.not_replaced);
                                                            warn_enc++;
                                                            this.InvokeEx(f => multi_logs["log_n_" + file_int.ToString()] = multi_logs["log_n_" + file_int.ToString()] + Environment.NewLine + Properties.Strings2.warning_file + " " + +'\u0022' + listView1.Items[selecs[file_int]].Text + '\u0022' + " " + Properties.Strings2.warning_not_rep + " " + "(_fftemp)." + Environment.NewLine);
                                                        }
                                                    }
                                                    catch (Exception excpt)
                                                    {
                                                        try
                                                        {
                                                            FileSystem.RenameFile(sourc, Path.GetFileNameWithoutExtension(fullPath) + add_suffix + ext_output1);
                                                            this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = FFBatch.Properties.Strings.replaced);
                                                        }
                                                        catch
                                                        {
                                                            try
                                                            {
                                                                FileSystem.RenameFile('\u0022' + sourc + '\u0022', '\u0022' + Path.GetFileNameWithoutExtension(fullPath) + add_suffix + ext_output1 + '\u0022');
                                                                this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = FFBatch.Properties.Strings.replaced);
                                                            }
                                                            catch
                                                            {
                                                                this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = FFBatch.Properties.Strings.renamed);
                                                                warn_enc++;
                                                                this.InvokeEx(f => multi_logs["log_n_" + selecs[file_int].ToString()] = multi_logs["log_n_" + selecs[file_int].ToString()] + Environment.NewLine + Properties.Strings2.warning_file + " " + '\u0022' + listView1.Items[selecs[file_int]].Text + '\u0022' + " " + Properties.Strings2.warning_not_rep + " " + "(_fftemp)." + Environment.NewLine);
                                                            }
                                                        }
                                                    }
                                                }
                                            }

                                            if (chk_delete_source.CheckState == CheckState.Checked && delete_def == false && delete_one == true)
                                            {
                                                try
                                                {
                                                    FileSystem.DeleteFile(fullPath, UIOption.OnlyErrorDialogs, RecycleOption.SendToRecycleBin);
                                                    this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = FFBatch.Properties.Strings.recycled);
                                                }
                                                catch
                                                {
                                                    this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = FFBatch.Properties.Strings.not_recycled);
                                                    warn_enc++;
                                                }
                                            }
                                            if (chk_delete_source.CheckState == CheckState.Checked && delete_def == true && delete_one == true)
                                            {
                                                try
                                                {
                                                    FileInfo fs = new FileInfo(fullPath);
                                                    if (fs.IsReadOnly == true) fs.IsReadOnly = false;
                                                    File.Delete(fullPath);
                                                    this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = FFBatch.Properties.Strings.deleted);
                                                }
                                                catch
                                                {
                                                    this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = FFBatch.Properties.Strings.not_deleted);
                                                    warn_enc++;
                                                }
                                            }
                                        }
                                    }
                                    if (aborted_url == true)
                                    {
                                        if (skipped == false) this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = FFBatch.Properties.Strings.aborted);
                                        else
                                        {
                                            this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = FFBatch.Properties.Strings.skipped);
                                            try
                                            {
                                                File.Delete(current_out);
                                            }
                                            catch { }
                                        }
                                        aborted_url = false;
                                        skipped = false;
                                    }

                                    //Run on each file
                                    int index = 0;
                                    Boolean sh_check = false;
                                    combo_shut.Invoke(new MethodInvoker(delegate
                                    {
                                        index = combo_shut.SelectedIndex;
                                    }));
                                    chkshut.Invoke(new MethodInvoker(delegate
                                    {
                                        if (chkshut.Checked == true) sh_check = true;
                                    }));

                                    if (index == 4 && cancel_queue == false && sh_check == true)
                                    {
                                        this.InvokeEx(f => this.Enabled = false);
                                        Form14 frm_run = new Form14();
                                        frm_run.txt_path.Text = run_command;
                                        String dest_f = '\u0022' + destis[file_int] + "\\" + System.IO.Path.GetFileNameWithoutExtension(fullPath) + add_suffix + ext_output1 + '\u0022';
                                        if (ext_output1 == "nul") dest_f = '\u0022' + destis[file_int] + "\\" + System.IO.Path.GetFileNameWithoutExtension(fullPath) + add_suffix + Path.GetExtension(fullPath).Replace(".", "") + '\u0022';

                                        frm_run.args = dest_f + " " + run_command_args;
                                        frm_run.timer1.Interval = 100;
                                        frm_run.ShowDialog();
                                        this.InvokeEx(f => this.Enabled = true);
                                        Enable_Controls();

                                        if (frm_run.proc.ExitCode == 0)
                                        {
                                            this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = "OK & Run");
                                            multi_logs["log_n_" + file_int.ToString()] = multi_logs["log_n_" + file_int.ToString()] + Environment.NewLine + n_logs + Properties.Strings2.ext_com_ok + " " + dest_f + Environment.NewLine;
                                        }
                                        else
                                        {
                                            this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = "OK & Error");
                                            multi_logs["log_n_" + file_int.ToString()] = multi_logs["log_n_" + file_int.ToString()] + Environment.NewLine + n_logs + Properties.Strings2.ext_com_err + " " + dest_f + Environment.NewLine;
                                        }
                                        this.InvokeEx(f => this.TopMost = true);
                                        this.InvokeEx(f => this.TopMost = false);
                                    }

                                    //End run on each file
                                }
                                else
                                {
                                    this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = FFBatch.Properties.Strings.aborted);

                                    if (cancelados_paralelos == false)
                                    {
                                        aborted_url = false;
                                    }
                                }
                            }
                            else
                            {
                                list_failed_m.Add(fullPath);
                                this.InvokeEx(f => f.listView1.Items[selecs[file_int]].SubItems[5].Text = FFBatch.Properties.Strings.failed);
                                errors_enc = errors_enc + 1;
                            }
                        }).Wait();

                    file_int++;
                });
            }
            catch (Exception exc)
            {
                fatal_parallel_msg = exc.Message;
                fatal_parallel = true;
            }

            if (result.IsCompleted == true) fatal_parallel = false;
            else
            {
                if (cts.IsCancellationRequested == false) fatal_parallel = true;
                else fatal_parallel = false;
            }
            String avgs = "";
            //Averages

            if (start_total_time == 0) start_total_time = 1;
            Double avg_enc = Math.Round((total_multi_duration / start_total_time), 1);

            try
            {
                if (cancelados_paralelos == false)
                {
                    if (tot_frames2 != 0)
                    {
                        avgs = Environment.NewLine + (FFBatch.Properties.Strings.avg_perf + " " + avg_enc.ToString() + "x" + "  |  " + Math.Round(tot_frames2 / (decimal)start_total_time, 1)).ToString() + " fps";
                        this.InvokeEx(f => f.lbl_speed.Text = ("AVG: " + avg_enc.ToString() + "x" + "  |  " + Math.Round(tot_frames2 / (decimal)start_total_time, 1)).ToString() + " fps");
                    }
                    else
                    {
                        avgs = Environment.NewLine + (FFBatch.Properties.Strings.avg_perf + " " + avg_enc.ToString() + "x");
                        this.InvokeEx(f => f.lbl_speed.Text = ("AVG: " + avg_enc.ToString() + "x"));
                    }
                }
            }
            catch { }

            //End averages

            if (no_save_logs == false)
            {
                String[] array_err = list_lines.ToArray();

                String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                if (is_portable == true) path = port_path + "ff_batch_portable.log";
                try
                {
                    System.IO.StreamWriter SaveFile = new System.IO.StreamWriter(path);
                    SaveFile.WriteLine("Multi-file log session: " + System.DateTime.Now);
                    SaveFile.WriteLine("-----------------------------------------------------");
                    SaveFile.Write(string.Join(Environment.NewLine, multi_logs.Select(a => $"{a.Value}")));
                    SaveFile.Close();
                    File.AppendAllText(path, avgs + Environment.NewLine + Environment.NewLine);
                    File.AppendAllText(path, "--------------------------");
                    File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.end_log);
                    File.AppendAllText(path, Environment.NewLine);
                    System.IO.FileInfo fileInfo = new System.IO.FileInfo(path);

                    var bytes = fileInfo.Length;

                    var kilobytes = (double)bytes / 1024;
                    var megabytes = kilobytes / 1024;
                    var gigabytes = megabytes / 1024;

                    //Format size view
                    String size = "";
                    String separator = ".";

                    if (bytes > 1000000000)
                    {
                        if (gigabytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }

                        String gigas = gigabytes.ToString();
                        if (gigas.Length >= 5)
                        {
                            gigas = gigas.Substring(0, gigas.LastIndexOf(separator) + 3);
                            size = (gigas + " " + "GB");
                        }
                        else
                        {
                            size = (gigas + " " + "GB");
                        }
                    }

                    if (bytes >= 1048576 && bytes <= 1000000000)
                    {
                        if (megabytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }
                        String megas = megabytes.ToString();
                        if (megas.Length > 5)
                        {
                            megas = megas.Substring(0, megas.LastIndexOf(separator));
                            size = (megas + " " + "MB");
                        }
                        else
                        {
                            size = (megas + " " + "MB");
                        }
                    }

                    if (bytes >= 1024 && bytes < 1048576)

                    {
                        if (kilobytes.ToString().Contains("."))
                        {
                            separator = ".";
                        }
                        else
                        {
                            separator = ",";
                        }

                        String kbs = kilobytes.ToString();
                        if (kbs.Length >= 5)
                        {
                            kbs = kbs.Substring(0, kbs.LastIndexOf(separator));
                            size = (kbs + " " + "KB");
                        }
                        else
                        {
                            size = (kbs + " " + "KB");
                        }
                    }
                    if (bytes > -1 && bytes < 1024)
                    {
                        String bits = bytes.ToString();
                        size = (bits + " Bytes");
                    }

                    //End Format size view
                    File.AppendAllText(path, Environment.NewLine + FFBatch.Properties.Strings.log_size + " " + size);
                }
                catch { }
                //End save log
            }
        }

        private void BG_Selected_items_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            listView1.SelectedIndices.Clear();
            clean_ffb_test();

            this.Text = "FFmpeg Batch AV Converter";

            if (is_portable == true) this.Text = "FFmpeg Batch AV Converter Portable";
            timer_aborting.Stop();

            // Close abort form
            for (int i = Application.OpenForms.Count - 1; i >= 0; i--)
            {
                if (Application.OpenForms[i].Name == "Form12")
                {
                    this.InvokeEx(f => Application.OpenForms[i].Close());
                    break;
                }
            }
            //End close abort form
            listView1.SelectedItems.Clear();
            TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress);
            timer_selecs.Stop();
            timer_tasks.Stop();
            Pg1.Value = Pg1.Maximum;
            Pg1.Text = "100%";
            Pg1.Refresh();
            listView1.Enabled = true;
            working = false;
            multi_running = false;
            Enable_Controls();

            if (cancelados_paralelos == false && fatal_parallel == false)
            {
                //Open on completion
                String primero_lista = listView1.Items[0].SubItems[1].Text + "\\" + listView1.Items[0].Text;
                String destino2 = String.Empty;
                if (chk_open_compl.Checked == true)
                {
                    if (txt_path_main.Text.Contains(".\\"))
                    {
                        destino2 = destino2 = primero_lista.Substring(0, primero_lista.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty); ;
                    }
                    else
                    {
                        destino2 = txt_path_main.Text;
                    }
                }

                if (chk_delete_source.CheckState == CheckState.Checked && delete_def == false && delete_one == false)
                {
                    Disable_Controls();

                    Label prog_txt = new Label();
                    prog_txt.Parent = panel1;
                    prog_txt.Top = 95;
                    prog_txt.Left = 80;
                    prog_txt.Width = 250;
                    prog_txt.TabIndex = 1;
                    prog_txt.BackColor = panel1.BackColor;
                    prog_txt.BorderStyle = BorderStyle.None;
                    prog_txt.TextAlign = ContentAlignment.MiddleLeft;
                    prog_txt.BringToFront();
                    prog_txt.Text = FFBatch.Properties.Strings.to_recycle;

                    ProgressBar pg_del = new ProgressBar();
                    pg_del.Parent = panel1;
                    pg_del.Top = 98;
                    pg_del.Left = 315;
                    pg_del.Width = 152;
                    pg_del.Height = 15;
                    pg_del.TabIndex = 0;
                    pg_del.BackColor = this.BackColor;
                    pg_del.Minimum = 0;
                    pg_del.BringToFront();
                    pg_del.Maximum = listView1.Items.Count;
                    pg_del.Show();
                    pg_del.Refresh();
                    int i = 0;
                    int err = 0;

                    foreach (String item in list_successful_m)
                    {
                        try
                        {
                            FileSystem.DeleteFile(item, UIOption.OnlyErrorDialogs, RecycleOption.SendToRecycleBin);
                            pg_del.Value = i;
                            i = i + 1;

                            foreach (ListViewItem item2 in listView1.Items)
                            {
                                if (item2.Text == Path.GetFileName(item))
                                {
                                    item2.SubItems[5].Text = FFBatch.Properties.Strings.recycled;
                                }
                            }
                        }
                        catch
                        {
                            err = err + 1;
                            listView1.Invoke(new MethodInvoker(delegate
                            {
                                foreach (ListViewItem item2 in listView1.Items)
                                {
                                    if (item2.Text == Path.GetFileName(item))
                                    {
                                        item2.SubItems[5].Text = FFBatch.Properties.Strings.not_recycled;
                                    }
                                }
                            }));
                        }
                        prog_txt.Text = FFBatch.Properties.Strings.to_recycle + i.ToString() + " " + FFBatch.Properties.Strings.of1 + " " + list_global_proc.Items.Count;
                        prog_txt.Refresh();
                    }
                    prog_txt.Visible = false;
                    prog_txt.Dispose();
                    pg_del.Visible = false;
                    pg_del.Dispose();
                    Enable_Controls();

                    if (err > 0) MessageBox.Show(err.ToString() + " " + Properties.Strings.not_recycled2 + Properties.Strings.check_log, FFBatch.Properties.Strings.not_recycled3, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);

                    if (list_failed_m.Count > 0)
                    {
                        String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                        if (is_portable == true) path = port_path + "ff_batch_portable.log";

                        File.AppendAllText(path, Environment.NewLine + Environment.NewLine + Properties.Strings2.source_not_deleted);
                        File.AppendAllText(path, Environment.NewLine + "-------------------------------");
                        foreach (String item in list_failed_m)
                        {
                            File.AppendAllText(path, Environment.NewLine + item);
                        }
                    }

                    //End delete source
                }

                if (chk_delete_source.CheckState == CheckState.Checked && delete_def == true && delete_one == false)
                {
                    Disable_Controls();

                    Label prog_txt = new Label();
                    prog_txt.Parent = panel1;
                    prog_txt.Top = 95;
                    prog_txt.Left = 80;
                    prog_txt.Width = 250;
                    prog_txt.TabIndex = 1;
                    prog_txt.BackColor = panel1.BackColor;
                    prog_txt.BorderStyle = BorderStyle.None;
                    prog_txt.TextAlign = ContentAlignment.MiddleLeft;
                    prog_txt.BringToFront();
                    prog_txt.Text = Properties.Strings2.deleting_files;

                    ProgressBar pg_del = new ProgressBar();
                    pg_del.Parent = panel1;
                    pg_del.Top = 98;
                    pg_del.Left = 315;
                    pg_del.Width = 152;
                    pg_del.Height = 15;
                    pg_del.TabIndex = 0;
                    pg_del.BackColor = this.BackColor;
                    pg_del.Minimum = 0;
                    pg_del.BringToFront();
                    pg_del.Maximum = listView1.Items.Count;
                    pg_del.Show();
                    pg_del.Refresh();
                    int i = 0;
                    int err = 0;

                    foreach (String item in list_successful_m)
                    {
                        try
                        {
                            FileInfo fs = new FileInfo(item);
                            if (fs.IsReadOnly == true) fs.IsReadOnly = false;
                            File.Delete(item);
                            pg_del.Value = i;
                            i = i + 1;

                            foreach (ListViewItem item2 in listView1.Items)
                            {
                                if (item2.Text == Path.GetFileName(item))
                                {
                                    item2.SubItems[5].Text = FFBatch.Properties.Strings.deleted;
                                }
                            }
                        }
                        catch
                        {
                            err = err + 1;

                            foreach (ListViewItem item2 in listView1.Items)
                            {
                                if (item2.Text == Path.GetFileName(item))
                                {
                                    item2.SubItems[5].Text = FFBatch.Properties.Strings.not_deleted;
                                }
                            }
                        }
                        prog_txt.Text = Properties.Strings2.deleting_f + " " + i.ToString() + " " + FFBatch.Properties.Strings.of1 + " " + list_global_proc.Items.Count;
                        prog_txt.Refresh();
                    }
                    prog_txt.Visible = false;
                    prog_txt.Dispose();
                    pg_del.Visible = false;
                    pg_del.Dispose();
                    Enable_Controls();

                    if (err > 0) MessageBox.Show(err.ToString() + " " + Properties.Strings.not_recycled2 + " " + Properties.Strings.check_log, FFBatch.Properties.Strings.not_recycled3, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);

                    if (list_failed_m.Count > 0)
                    {
                        String path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_batch.log";
                        if (is_portable == true) path = port_path + "ff_batch_portable.log";

                        File.AppendAllText(path, Environment.NewLine + Environment.NewLine + Properties.Strings2.source_not_deleted);
                        File.AppendAllText(path, Environment.NewLine + "-------------------------------");
                        foreach (String item in list_failed_m)
                        {
                            File.AppendAllText(path, Environment.NewLine + item);
                        }
                    }

                    //End delete source
                }
                this.InvokeEx(f => toolT002.RemoveAll());

                if (errors_enc == 0)
                {
                    pic_no_errors.Visible = true;
                    //Delete source

                    //Automatic shutdown check
                    if (chkshut.Checked)
                    {
                        auto_shut();
                        return;
                    }

                    if (warn_enc > 0)
                    {
                        pic_no_errors.Visible = false;
                        pic_recording.Visible = false;
                        toolT002.SetToolTip(this.pic_warnings, FFBatch.Properties.Strings.there_w + " " + warn_enc.ToString() + " " + Properties.Strings2.warnings_last_s);
                        pic_warnings.Visible = true;
                    }
                }
                else
                {
                    pic_no_errors.Visible = false;
                    pic_recording.Visible = false;
                    toolT002.SetToolTip(this.pic_warnings, FFBatch.Properties.Strings.there_w + " " + errors_enc.ToString() + " " + FFBatch.Properties.Strings.errors_se);
                    pic_warnings.Visible = true;
                }

                if (errors_enc == 0)
                {
                    if (play_on_end == true) play_end();
                }
                else if (play_on_end == true) System.Media.SystemSounds.Asterisk.Play();

                if (this.ContainsFocus == false)
                {
                    if (errors_enc == 0 && warn_enc == 0)
                    {
                        notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.enc_comp;
                        notifyIcon1.BalloonTipIcon = ToolTipIcon.Info;
                        notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.enc_comp2;
                        notifyIcon1.ShowBalloonTip(0);
                    }
                    if (errors_enc > 0)
                    {
                        notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.enc_comp3 + " " + errors_enc.ToString() + " " + FFBatch.Properties.Strings.errors1;
                        notifyIcon1.BalloonTipIcon = ToolTipIcon.Warning;
                        notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.enc_comp2;
                        notifyIcon1.ShowBalloonTip(0);
                    }
                    if (errors_enc == 0 && warn_enc > 0)
                    {
                        if (errors_enc == 0 && warn_enc > 0)
                        {
                            notifyIcon1.BalloonTipText = FFBatch.Properties.Strings.enc_warns;
                            notifyIcon1.BalloonTipIcon = ToolTipIcon.Warning;
                            notifyIcon1.BalloonTipTitle = FFBatch.Properties.Strings.enc_comp2;
                            notifyIcon1.ShowBalloonTip(0);
                        }
                    }
                }

                if (chk_open_compl.Checked == true && opened_m == false)
                {
                    opened_m = true;
                    try
                    {
                        if (Directory.GetFiles(destino2).Length != 0)
                        {
                            Process open_processed = new Process();
                            open_processed.StartInfo.FileName = "explorer.exe";
                            open_processed.StartInfo.Arguments = '\u0022' + multi_dest + '\u0022';
                            open_processed.Start();
                        }
                        else
                        {
                            if (Directory.Exists(destino2))
                            {
                                System.IO.Directory.Delete(destino2);
                            }
                        }
                    }
                    catch
                    {
                    }
                }

                return;
            }
            else
            {
                if (aborted == true)
                {
                    aborted = false;
                    MessageBox.Show(FFBatch.Properties.Strings.queue_abort, FFBatch.Properties.Strings.task_abort, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                }
                cancelados_paralelos = false;
            }
        }

        private void timer_selecs_Tick(object sender, EventArgs e)
        {
            Double weight = 0;
            Double dg_multi_prog = 0;
            total_multi_duration = 0;

            foreach (int i in selecs)
            {
                DateTime time2;
                if (DateTime.TryParse(listView1.Items[i].SubItems[3].Text, out time2))
                {
                    total_multi_duration = total_multi_duration + TimeSpan.Parse(listView1.Items[i].SubItems[3].Text).TotalSeconds - TimeSpan.Parse(ss_time_input.Text).TotalSeconds;
                }
            }

            Pg1.Maximum = selecs.Count * 100;
            start_total_time = start_total_time + 0.5;

            try
            {
                TimeSpan t9 = TimeSpan.FromSeconds(start_total_time);
                String tx_elapsed = string.Format("{0:D2}h:{1:D2}m:{2:D2}s",
                    t9.Hours,
                    t9.Minutes,
                    t9.Seconds);
                lbl_elapsed.Text = FFBatch.Properties.Strings.time_elapsed + " " + tx_elapsed;


                foreach (int i in selecs)
                {
                    if (listView1.Items[i].SubItems[5].Text != Properties.Strings.queued)
                    {
                        if (listView1.Items[i].SubItems[3].Text == FFBatch.Properties.Strings.n_a)
                        {
                            weight = 1 / selecs.Count;
                        }
                        else
                        {
                            weight = (TimeSpan.Parse(listView1.Items[i].SubItems[3].Text).TotalSeconds - TimeSpan.Parse(ss_time_input.Text).TotalSeconds) / total_multi_duration;
                        }

                        if (listView1.Items[i].SubItems[5].Text.Contains("%") == true && cancelados_paralelos == false)
                        {
                            if (listView1.Items[i].SubItems[5].Text.Contains(".0") || listView1.Items[i].SubItems[5].Text.Contains(",0"))
                            {
                                dg_multi_prog = dg_multi_prog + Convert.ToDouble(listView1.Items[i].SubItems[5].Text.Replace("%", "")) / 10 * weight * selecs.Count;
                            }
                            else
                            {
                                dg_multi_prog = dg_multi_prog + Convert.ToDouble(listView1.Items[i].SubItems[5].Text.Replace("%", "")) * weight * selecs.Count;
                            }
                        }

                        if (listView1.Items[i].SubItems[5].Text == FFBatch.Properties.Strings.success || listView1.Items[i].SubItems[5].Text == FFBatch.Properties.Strings.failed || listView1.Items[i].SubItems[5].Text == FFBatch.Properties.Strings.aborted || listView1.Items[i].SubItems[5].Text == FFBatch.Properties.Strings.aborting || listView1.Items[i].SubItems[5].Text == FFBatch.Properties.Strings.skipped || listView1.Items[i].SubItems[5].Text == FFBatch.Properties.Strings.replaced || listView1.Items[i].SubItems[5].Text == FFBatch.Properties.Strings.not_replaced || listView1.Items[i].SubItems[5].Text == FFBatch.Properties.Strings.recycled || listView1.Items[i].SubItems[5].Text == FFBatch.Properties.Strings.not_recycled || listView1.Items[i].SubItems[5].Text == FFBatch.Properties.Strings.deleted || listView1.Items[i].SubItems[5].Text == FFBatch.Properties.Strings.not_deleted || listView1.Items[i].SubItems[5].Text == "OK & Run" || listView1.Items[i].SubItems[5].Text == "OK & Error")
                        {
                            dg_multi_prog = dg_multi_prog + (100 * weight * selecs.Count);
                        }
                    }
                }

                if (time_n_tasks > 1)
                {
                    if (Math.Round(dg_multi_prog / selecs.Count, 1).ToString().Contains(".") || Math.Round(dg_multi_prog / selecs.Count, 1).ToString().Contains(","))
                    {
                        Pg1.Text = Math.Round(dg_multi_prog / selecs.Count, 1).ToString() + "%";
                    }
                    else
                    {
                        Pg1.Text = Math.Round(dg_multi_prog / selecs.Count, 1).ToString() + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
                    }

                    Pg1.Value = (int)(dg_multi_prog);
                    TaskbarProgress.SetValue(this.Handle, Convert.ToInt32(dg_multi_prog), Pg1.Maximum);
                }
                else
                {
                    Pg1.Value = 0;
                    Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";
                }

                if (Pg1.Value / selecs.Count > 0 && start_total_time > 4)
                {
                    Double remain_secs = time_n_tasks * 100 / (Pg1.Value / selecs.Count) - start_total_time;
                    String remain_string = String.Empty;

                    TimeSpan t = TimeSpan.FromSeconds(remain_secs);
                    remain_string = string.Format("{0:D2}h:{1:D2}",
                    t.Hours,
                    t.Minutes);

                    if (remain_secs >= 43200)
                    {
                        txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + Math.Round(remain_secs / 3600).ToString() + " " + FFBatch.Properties.Strings.hours;
                        this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + Math.Round(remain_secs / 3600).ToString() + " " + FFBatch.Properties.Strings.hours);
                    }

                    if (remain_secs >= 3600 && remain_secs < 43200)
                    {
                        txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_string + " " + FFBatch.Properties.Strings.minutes_abrev;
                        this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + remain_string + " " + FFBatch.Properties.Strings.minutes_abrev);
                    }

                    if (remain_secs < 3600 && remain_secs >= 600)
                    {
                        txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_string.Substring(remain_string.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes;
                        this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + remain_string.Substring(remain_string.LastIndexOf(":") + 1, 2) + " " + FFBatch.Properties.Strings.minutes_abrev);
                    }
                    if (remain_secs < 600 && remain_secs >= 120)
                    {
                        txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + remain_string.Substring(remain_string.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes;
                        this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + remain_string.Substring(remain_string.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes_abrev);
                    }

                    if (remain_secs < 120 && remain_secs > 59)
                    {
                        txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.about_1;
                        this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + remain_string.Substring(remain_string.LastIndexOf(":") + 2, 1) + " " + FFBatch.Properties.Strings.minutes_abrev);
                    }

                    if (remain_secs <= 59)
                    {
                        txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.less_one;
                        this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + Convert.ToInt16(Math.Abs(remain_secs)) + " s");
                    }
                    if (remain_secs <= 0)
                    {
                        txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.almost_done;
                        this.InvokeEx(f => this.Text = "Enc. " + Pg1.Text + " / " + "Est. " + FFBatch.Properties.Strings.almost_done);
                    }
                    txt_remain.Refresh();
                    Decimal speeds = 0;
                    Decimal fps = 0;
                    String sep = System.Globalization.CultureInfo.CurrentUICulture.NumberFormat.NumberDecimalSeparator;

                    try
                    {
                        Decimal deci = 0;

                        foreach (String str in multi_speeds)
                        {
                            if (str.Contains(sep))
                            {
                                deci = Convert.ToDecimal(str, CultureInfo.CurrentUICulture);
                            }
                            else
                            {
                                if (str.Contains(",")) deci = Convert.ToDecimal(str.Replace(",", "."));
                                else deci = Convert.ToDecimal(str.Replace(".", ","));
                            }
                            speeds = Math.Round(Decimal.Add(speeds, deci), 2);
                        }
                    }
                    catch (Exception excpt)
                    {
                        speeds = 0;
                    }

                    try
                    {
                        Decimal deci = 0;
                        foreach (String str in multi_fps)
                        {
                            if (str.Contains(sep))
                            {
                                deci = Convert.ToDecimal(str, CultureInfo.CurrentUICulture);
                                fps = Decimal.Add(fps, deci);
                            }
                            else
                            {
                                if (str.Contains(",")) deci = Convert.ToDecimal(str.Replace(",", "."));
                                else deci = Convert.ToDecimal(str.Replace(".", ","));
                                fps = Decimal.Add(fps, deci);
                            }
                        }
                    }
                    catch { fps = 0; }

                    String fps_perf = fps.ToString();
                    if (fps_perf == "0")
                    {
                        lbl_speed.Text = FFBatch.Properties.Strings.speed + " " + speeds.ToString() + "x";
                    }
                    else
                    {
                        lbl_speed.Text = FFBatch.Properties.Strings.speed + " " + speeds.ToString() + "x" + "  |  " + fps_perf.TrimEnd() + " fps";
                    }
                }
                else
                {
                    txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.calcul;
                    txt_remain.Refresh();
                }
                if (cancelados_paralelos == true)
                {
                    this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));
                }
            }
            catch
            {
                txt_remain.Text = FFBatch.Properties.Strings.remain_time + " " + FFBatch.Properties.Strings.calcul;
                txt_remain.Refresh();
            }
        }

        private void ctm1_encode_Click(object sender, EventArgs e)
        {
            Pg1.Focus();
            Pg1.Text = "0" + System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator + "0%";

            was_started.Text = btn_multi_m.Text;

            cancelados_paralelos = false;

            foreach (ListViewItem file in listView1.SelectedItems)
            {
                if (!File.Exists(file.SubItems[1].Text + "\\" + file.Text))
                {
                    MessageBox.Show(FFBatch.Properties.Strings.file_not_found + " " + file.Text, FFBatch.Properties.Strings.file_not_found2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }
            if (listView1.SelectedItems.Count == 0)
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_f_sel, FFBatch.Properties.Strings.no_files, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (!File.Exists(Path.Combine(Application.StartupPath, "ffmpeg.exe")))
            {
                MessageBox.Show(FFBatch.Properties.Strings.no_ffmpeg, FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            if (check_ff_md5() == false)
            {
                Form25 frm25 = new Form25();
                frm25.ShowDialog();
                return;
            }

            if (ss_time_input.Text != "0:00:00")
            {
                foreach (ListViewItem item in listView1.SelectedItems)
                {
                    if (item.SubItems[3].Text != FFBatch.Properties.Strings.n_a && item.SubItems[3].Text != "0:00:00" && item.SubItems[3].Text != "00:00:00" && item.SubItems[3].Text != FFBatch.Properties.Strings.pending)
                    {
                        if (TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds <= TimeSpan.Parse(ss_time_input.Text).TotalSeconds)
                        {
                            MessageBox.Show(FFBatch.Properties.Strings.pre_input3 + " " + '\u0022' + Path.GetFileName(item.Text) + '\u0022', FFBatch.Properties.Strings.error, MessageBoxButtons.OK, MessageBoxIcon.Error);
                            return;
                        }
                    }
                }
            }

            if (dur_ok == false)
            {
                list_pending_dur.Clear();
                foreach (ListViewItem item in listView1.SelectedItems)
                {
                    list_pending_dur.Items.Add((ListViewItem)item.Clone());
                }
                BG_Dur.RunWorkerAsync();
                return;
            }

            avoid_overw();

            //Check path is writable
            String destino1 = String.Empty;
            Boolean rel_path = false;
            String lv1 = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
            if (txt_path_main.Text.Contains(".\\"))
            {
                destino1 = lv1.Substring(0, lv1.LastIndexOf('\\')) + txt_path_main.Text.Replace(".", String.Empty);
                rel_path = true;
            }
            else
            {
                if (checkBox1.CheckState == CheckState.Checked)
                {
                    String pre_dest = Path.GetDirectoryName(lv1);
                    destino1 = Path.Combine(txt_path_main.Text, pre_dest.Substring(3, pre_dest.Length - 3));
                    rel_path = true;
                }
                else
                {
                    destino1 = txt_path_main.Text;
                }
            }

            try
            {
                if (rel_path == true)
                {
                    Directory.CreateDirectory(destino1);
                    System.Threading.Thread.Sleep(10);
                }
                else
                {
                    if (!Directory.Exists(destino1)) Directory.CreateDirectory(destino1);
                    File.WriteAllText(destino1 + "\\" + "FFBatch_test.txt", "FFBatch_test");
                    System.Threading.Thread.Sleep(10);
                    File.Delete(destino1 + "\\" + "FFBatch_test.txt");
                }
            }
            catch (System.Exception excpt)
            {
                MessageBox.Show(FFBatch.Properties.Strings.write_error1 + " " + excpt.Message, FFBatch.Properties.Strings.write_error2, MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            //End path is writable         

            //Validated list, start processing

            if (fade_v_in.Checked == true || fade_v_out.Checked == true || fade_a_in.Checked == true || fade_a_out.Checked == true)
            {
                MessageBox.Show(FFBatch.Properties.Strings.fadein1, FFBatch.Properties.Strings.warning, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                return;
            }

            txt_remain.Text = "";
            txt_remain.Refresh();
            total_time = true;
            n_th_suffix = String.Empty;
            n_th_source_ext = String.Empty;

            //Save selected hw decoder

            String path2 = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_hw_dcd.ini";
            String txt_hw_dcd = cb_hwdecode.SelectedItem.ToString();
            if (txt_hw_dcd != "none")
            {
                File.WriteAllText(path2, txt_hw_dcd);
            }
            else
            {
                if (File.Exists(path2)) File.Delete(path2);
            }

            //End save hw decoder

            //Try preset
            //foreach (String item in tried_params)
            //{
            //    if (item == (txt_parameters.Text))
            //    {
            //        tried_ok = true;
            //    }
            //}

            //if (tried_ok == false)
            //{
            //    try
            //    {
            //        BG_Try_preset.RunWorkerAsync();
            //    }
            //    catch
            //    {
            //        tried_ok = true;
            //    }
            //    return;
            //}
            //tried_ok = false;

            //Remove test file/folder
            String file_prueba = "";
            String sel_test = listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text;
            file_prueba = sel_test;
            String destino = Path.GetTempPath() + "\\" + "FFBatch_test";
            String borrar = destino + "\\" + System.IO.Path.GetFileNameWithoutExtension(file_prueba) + "." + txt_format.Text;

            if (File.Exists(borrar))
            {
                try
                {
                    File.Delete(borrar);
                }
                catch { }
            }

            if (Directory.Exists(destino) == true)
            {
                if (Directory.GetFiles(destino).Length == 0)
                {
                    try
                    {
                        System.IO.Directory.Delete(destino);
                    }
                    catch { }
                }
            }

            //END Remove test file/folder

            //END try preset

            //Save selected theads

            String path = String.Empty;
            if (is_portable == false)
            {
                path = System.IO.Path.Combine(Environment.GetEnvironmentVariable("appdata"), "FFBatch") + "\\" + "ff_nthreads.ini";
            }
            else
            {
                path = port_path + "ff_nthreads_portable.ini";
            }

            String txt_threads = String.Empty;
            txt_threads = n_threads.Value.ToString();
            File.WriteAllText(path, txt_threads);
            //End save selected threads

            //Pending duration

            if (avoid_overwriting == true && txt_path_main.Text.Contains(".\\") == false && txt_path_main.Text.Length < 4 && checkBox1.CheckState != CheckState.Checked)
            {
                avoid_overwriting = false;
                DialogResult a2 = MessageBox.Show(FFBatch.Properties.Strings.multiple_folders + " " + '\u0022' + FFBatch.Properties.Strings.recreate_path + '\u0022' + " " + Properties.Strings2.avoid_overw + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.continu, Properties.Strings2.dif_in_out_f, MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2);
                if (a2 == DialogResult.No) return;
            }

            //Check queued items

            if (warn_success_items == true)
            {
                //Boolean all_complete = true;
                Boolean has_complete = false;
                foreach (ListViewItem item in listView1.SelectedItems)
                {
                    if (item.SubItems[5].Text != FFBatch.Properties.Strings.queued)
                    {
                        has_complete = true;
                        break;
                    }
                }

                if (has_complete == true)
                {
                    DialogResult a = MessageBox.Show(FFBatch.Properties.Strings.already_encoded + " " + '\u0022' + FFBatch.Properties.Strings.queued + '\u0022' + " " + FFBatch.Properties.Strings.reset_items + Environment.NewLine + Environment.NewLine + FFBatch.Properties.Strings.cont_any, FFBatch.Properties.Strings.some_q, MessageBoxButtons.YesNoCancel, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2);
                    if (a == DialogResult.Cancel || a == DialogResult.No)
                    {
                        return;
                    }
                }
            }
            else
            {
                foreach (ListViewItem item in listView1.SelectedItems) item.SubItems[5].Text = Properties.Strings.queued;
            }
            //End check queued items

            if (chk_overw.Checked == true && txt_path_main.Text != "." + "\\")
            {
                DialogResult a = MessageBox.Show(FFBatch.Properties.Strings.overw_out, FFBatch.Properties.Strings.out_warn, MessageBoxButtons.YesNoCancel, MessageBoxIcon.Question);
                if (a != DialogResult.Yes) return;
            }

            //Verify names will not cause overwrite
            if (txt_format.Text != String.Empty)
            {
                if (dups_lv1() == true) return;
            }

            String is_overw = txt_path_main.Text + "\\" + Path.GetFileNameWithoutExtension(listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text) + "." + txt_format.Text;

            if (is_overw == listView1.SelectedItems[0].SubItems[1].Text + "\\" + listView1.SelectedItems[0].Text && chk_suffix.Checked == false)
            {
                if (chk_overw.CheckState == CheckState.Unchecked)
                {
                    MessageBox.Show(FFBatch.Properties.Strings.overw_not_en + " " + '\u0022' + FFBatch.Properties.Strings.ren_out + '\u0022' + " " + FFBatch.Properties.Strings.checkb, FFBatch.Properties.Strings.overw_not_all, MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                if (chk_overw.CheckState == CheckState.Checked)
                {
                    var a = MessageBox.Show(FFBatch.Properties.Strings.overw_confirm, FFBatch.Properties.Strings.over_conf2, MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                    if (a == DialogResult.No)
                    {
                        return;
                    }
                }
            }

            if (txt_parameters.Text.Contains("libx264") || txt_parameters.Text.Contains("libx265") || txt_parameters.Text.Contains("jpeg2000") || txt_parameters.Text.Contains("libtheora") || txt_parameters.Text.Contains("libxvid") || txt_parameters.Text.Contains("mpeg2") || txt_parameters.Text.Contains("webp") || txt_parameters.Text.Contains("mpeg4") || txt_parameters.Text.Contains("libvpx"))
            {
                if (n_threads.Value > 3 && (txt_parameters.Text.Contains("libx264") || txt_parameters.Text.Contains("libx265") || txt_parameters.Text.Contains("jpeg2000") || txt_parameters.Text.Contains("libtheora") || txt_parameters.Text.Contains("libxvid") || txt_parameters.Text.Contains("mpeg2") || txt_parameters.Text.Contains("webp") || txt_parameters.Text.Contains("mpeg4") || txt_parameters.Text.Contains("libvpx")))
                {
                    var a = MessageBox.Show(FFBatch.Properties.Strings.multi_vid, FFBatch.Properties.Strings.question, MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                    if (a == DialogResult.No) return;
                }
            }

            cancel_queue = false;
            cancelados_paralelos = false;

            listBox4.Items.Clear();
            group_prog.Focus();

            //Total duration

            total_multi_duration = 0;
            foreach (ListViewItem item in listView1.SelectedItems)
            {
                DateTime time2;
                if (DateTime.TryParse(item.SubItems[3].Text, out time2))

                {
                    total_multi_duration = total_multi_duration + TimeSpan.Parse(item.SubItems[3].Text).TotalSeconds;
                }
            }
            //End total duration
            LB_Wait.Text = String.Empty;
            LB_Wait.Visible = false;
            pg_adding.Visible = false;
            txt_adding_p.Text = String.Empty;
            multi_dest = destino;

            notifyIcon1.Visible = true;
            Pg1.Value = 0;
            Pg1.Maximum = listView1.SelectedItems.Count * 100;
            Pg1.Text = "";
            lbl_elapsed.Text = FFBatch.Properties.Strings.time_elapsed + " " + "00h:00m:00s";

            start_total_time = 0;
            time_n_tasks = 0;
            timer_tasks.Start();
            timer_selecs.Start();
            multi_running = true;

            listView1.SelectedItems[0].Selected = true;
            pic_no_errors.Visible = false;
            pic_warnings.Visible = false;
            pic_recording.Visible = false;
            errors_enc = 0;
            working = true;
            selecs.Clear();
            foreach (ListViewItem item in listView1.Items)
            {
                if (item.Selected == true) selecs.Add(item.Index);
            }
            BG_Selected_items.RunWorkerAsync();
        }

        private void BG_add_col_bitr_DoWork(object sender, DoWorkEventArgs e)
        {
            Disable_Controls();
            this.InvokeEx(f => f.btn_abort_all.Enabled = false);
            this.InvokeEx(f => f.btn_pause.Enabled = false);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.pg_adding.Visible = true);
            this.InvokeEx(f => f.pg_adding.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Visible = true);
            this.InvokeEx(f => f.txt_adding_p.Enabled = true);
            this.InvokeEx(f => f.txt_adding_p.Refresh());
            this.InvokeEx(f => f.LB_Wait.Visible = true);
            this.InvokeEx(f => f.LB_Wait.Enabled = true);
            this.InvokeEx(f => f.pg_adding.Value = 0);
            this.InvokeEx(f => f.pg_adding.Minimum = 0);
            this.InvokeEx(f => f.pg_adding.Maximum = listView1.Items.Count);
            this.InvokeEx(f => f.btn_cancel_add.Visible = true);
            this.InvokeEx(f => f.btn_cancel_add.Enabled = true);
            canceled_file_adding = false;

            int i = 0;
            listView1.Invoke(new MethodInvoker(delegate
            {
                listView1.BeginUpdate();
                foreach (ListViewItem item in listView1.Items)
                {
                    String itfull = item.SubItems[1].Text + "\\" + item.Text;

                    Boolean has_streams = false;
                    Boolean has_video = false;

                    if (canceled_file_adding == false)
                    {

                        try
                        {
                            FileInfo fi = new FileInfo(listView1.Items[i].SubItems[1].Text + "\\" + listView1.Items[i].Text);
                            Double size = fi.Length;
                            Double dur = TimeSpan.Parse(listView1.Items[i].SubItems[3].Text).TotalSeconds;
                            Double bytes = Math.Round((size / dur * 8 / 1000), 0);
                            String subit = "0 Kb";
                            if (bytes >= 1000000) subit = (bytes / 1000000).ToString("#,##0.0") + " " + "Gb/s";
                            if (bytes >= 10000 && bytes < 1000000)
                            {
                                subit = (bytes / 1000).ToString("#,##0.0") + " " + "Mb/s";
                                //if (size.Length == 9) size = (size.Substring(0, 1) + sep_th + size.Substring(1, size.Length - 1));
                            }

                            ////if (bytes < 100000 && bytes > 10000) size = bytes / 1000 + " " + "Mb/s";
                            if (bytes < 10000) subit = bytes.ToString("#,##0") + " " + "Kb/s";
                            listView1.Items[item.Index].SubItems.Add(subit);
                        }
                        catch { listView1.Items[item.Index].SubItems.Add("-"); }

                        i++;                     

                        this.InvokeEx(f => f.LB_Wait.Text = FFBatch.Properties.Strings.add_col1);
                        this.InvokeEx(f => f.LB_Wait.Refresh());
                        this.InvokeEx(f => f.pg_adding.Value = pg_adding.Value + 1);
                        this.InvokeEx(f => f.pg_adding.Refresh());
                        this.InvokeEx(f => f.txt_adding_p.Text = (i * 100 / pg_adding.Maximum).ToString() + "%");
                        this.InvokeEx(f => TaskbarProgress.SetValue(this.Handle, i * 100 / pg_adding.Maximum, 100));
                        this.InvokeEx(f => f.txt_adding_p.Refresh());
                    }
                    else
                    {
                        timer_adding.Stop();
                        this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
                        this.InvokeEx(f => f.txt_add_remain.Visible = false);
                        this.InvokeEx(f => f.txt_add_remain.Refresh());
                        break;
                    }
                }
                this.InvokeEx(f => f.listView1.EndUpdate());
            }));

            timer_adding.Stop();
            this.InvokeEx(f => f.txt_add_remain.Text = String.Empty);
            this.InvokeEx(f => f.txt_add_remain.Visible = false);
            this.InvokeEx(f => f.txt_add_remain.Refresh());
            this.InvokeEx(f => f.LB_Wait.Text = "");
            this.InvokeEx(f => TaskbarProgress.SetState(this.Handle, TaskbarProgress.TaskbarStates.NoProgress));

        }

        private void BG_add_col_bitr_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
        {
            end_bg_filters();
        }

        private void dg1_CellEndEdit(object sender, DataGridViewCellEventArgs e)
        {
            String cell_out = "";

            if (e.ColumnIndex == 4)
            {
                if (dg1.Rows[e.RowIndex].Cells[4].Value == null)
                {
                    String url1 = dg1.Rows[e.RowIndex].Cells[1].Value.ToString().Substring(dg1.Rows[e.RowIndex].Cells[1].Value.ToString().LastIndexOf("=") + 1, 11);
                    MessageBox.Show(FFBatch.Properties.Strings.out_blank);
                    dg1.Rows[e.RowIndex].Cells[4].Value = url1 + "_" + (e.RowIndex + 1).ToString();
                    return;
                }
                else
                {
                    cell_out = dg1.Rows[e.RowIndex].Cells[4].Value.ToString();
                    if (cell_out.Contains("/") || cell_out.Contains(":") || cell_out.Contains("*") || cell_out.Contains("?") || cell_out.Contains("¿") || cell_out.Contains('\u0022') || cell_out.Contains("<") || cell_out.Contains(">") || cell_out.Contains("|") || cell_out.Contains("\\"))
                    {
                        MessageBox.Show(FFBatch.Properties.Strings.invalid_rem + " " + "(\\/:*?'\u0022'<>|", FFBatch.Properties.Strings.invalid_ch2, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                        cell_out = cell_out.Replace("/", "");
                        cell_out = cell_out.Replace(":", "");
                        cell_out = cell_out.Replace("*", "");
                        cell_out = cell_out.Replace("?", "");
                        cell_out = cell_out.Replace("¿", "");
                        cell_out = cell_out.Replace("\u0022", "");
                        cell_out = cell_out.Replace("<", "");
                        cell_out = cell_out.Replace(">", "");
                        cell_out = cell_out.Replace("|", "");
                        cell_out = cell_out.Replace("\\", "");
                        dg1.Rows[e.RowIndex].Cells[4].Value = cell_out.ToString();
                    }
                }
            }
        }

        // End code
    } //Form Class

    public static class ISynchronizeInvokeExtensions
    {
        public static void InvokeEx<T>(this T @this, Action<T> action) where T : ISynchronizeInvoke
        {
            if (@this.InvokeRequired)
            {
                @this.Invoke(action, new object[] { @this });
            }
            else
            {
                action(@this);
            }
        }
    }

    public static class TextFileEncodingDetector
    {
        private const long _defaultHeuristicSampleSize = 0x10000; //completely arbitrary - inappropriate for high numbers of files / high speed requirements

        public static Encoding DetectTextFileEncoding(string InputFilename)
        {
            using (FileStream textfileStream = File.OpenRead(InputFilename))
            {
                return DetectTextFileEncoding(textfileStream, _defaultHeuristicSampleSize);
            }
        }

        public static Encoding DetectTextFileEncoding(FileStream InputFileStream, long HeuristicSampleSize)
        {
            bool uselessBool = false;
            return DetectTextFileEncoding(InputFileStream, _defaultHeuristicSampleSize, out uselessBool);
        }

        public static Encoding DetectTextFileEncoding(FileStream InputFileStream, long HeuristicSampleSize, out bool HasBOM)
        {
            if (InputFileStream == null)
                throw new ArgumentNullException("Must provide a valid Filestream!", "InputFileStream");

            if (!InputFileStream.CanRead)
                throw new ArgumentException("Provided file stream is not readable!", "InputFileStream");

            if (!InputFileStream.CanSeek)
                throw new ArgumentException("Provided file stream cannot seek!", "InputFileStream");

            Encoding encodingFound = null;

            long originalPos = InputFileStream.Position;

            InputFileStream.Position = 0;

            //First read only what we need for BOM detection
            byte[] bomBytes = new byte[InputFileStream.Length > 4 ? 4 : InputFileStream.Length];
            InputFileStream.Read(bomBytes, 0, bomBytes.Length);

            encodingFound = DetectBOMBytes(bomBytes);

            if (encodingFound != null)
            {
                InputFileStream.Position = originalPos;
                HasBOM = true;
                return encodingFound;
            }

            //BOM Detection failed, going for heuristics now.
            //  create sample byte array and populate it
            byte[] sampleBytes = new byte[HeuristicSampleSize > InputFileStream.Length ? InputFileStream.Length : HeuristicSampleSize];
            Array.Copy(bomBytes, sampleBytes, bomBytes.Length);
            if (InputFileStream.Length > bomBytes.Length)
                InputFileStream.Read(sampleBytes, bomBytes.Length, sampleBytes.Length - bomBytes.Length);
            InputFileStream.Position = originalPos;

            //test byte array content
            encodingFound = DetectUnicodeInByteSampleByHeuristics(sampleBytes);

            HasBOM = false;
            return encodingFound;
        }

        public static Encoding DetectTextByteArrayEncoding(byte[] TextData)
        {
            bool uselessBool = false;
            return DetectTextByteArrayEncoding(TextData, out uselessBool);
        }

        public static Encoding DetectTextByteArrayEncoding(byte[] TextData, out bool HasBOM)
        {
            if (TextData == null)
                throw new ArgumentNullException("Must provide a valid text data byte array!", "TextData");

            Encoding encodingFound = null;

            encodingFound = DetectBOMBytes(TextData);

            if (encodingFound != null)
            {
                HasBOM = true;
                return encodingFound;
            }
            else
            {
                //test byte array content
                encodingFound = DetectUnicodeInByteSampleByHeuristics(TextData);

                HasBOM = false;
                return encodingFound;
            }
        }

        public static string GetStringFromByteArray(byte[] TextData, Encoding DefaultEncoding)
        {
            return GetStringFromByteArray(TextData, DefaultEncoding, _defaultHeuristicSampleSize);
        }

        public static string GetStringFromByteArray(byte[] TextData, Encoding DefaultEncoding, long MaxHeuristicSampleSize)
        {
            if (TextData == null)
                throw new ArgumentNullException("Must provide a valid text data byte array!", "TextData");

            Encoding encodingFound = null;

            encodingFound = DetectBOMBytes(TextData);

            if (encodingFound != null)
            {
                //For some reason, the default encodings don't detect/swallow their own preambles!!
                return encodingFound.GetString(TextData, encodingFound.GetPreamble().Length, TextData.Length - encodingFound.GetPreamble().Length);
            }
            else
            {
                byte[] heuristicSample = null;
                if (TextData.Length > MaxHeuristicSampleSize)
                {
                    heuristicSample = new byte[MaxHeuristicSampleSize];
                    Array.Copy(TextData, heuristicSample, MaxHeuristicSampleSize);
                }
                else
                {
                    heuristicSample = TextData;
                }

                encodingFound = DetectUnicodeInByteSampleByHeuristics(TextData) ?? DefaultEncoding;
                return encodingFound.GetString(TextData);
            }
        }

        public static Encoding DetectBOMBytes(byte[] BOMBytes)
        {
            if (BOMBytes == null)
                throw new ArgumentNullException("Must provide a valid BOM byte array!", "BOMBytes");

            if (BOMBytes.Length < 2)
                return null;

            if (BOMBytes[0] == 0xff
                && BOMBytes[1] == 0xfe
                && (BOMBytes.Length < 4
                    || BOMBytes[2] != 0
                    || BOMBytes[3] != 0
                    )
                )
                return Encoding.Unicode;

            if (BOMBytes[0] == 0xfe
                && BOMBytes[1] == 0xff
                )
                return Encoding.BigEndianUnicode;

            if (BOMBytes.Length < 3)
                return null;

            if (BOMBytes[0] == 0xef && BOMBytes[1] == 0xbb && BOMBytes[2] == 0xbf)
                return Encoding.UTF8;

            if (BOMBytes[0] == 0x2b && BOMBytes[1] == 0x2f && BOMBytes[2] == 0x76)
                return Encoding.UTF7;

            if (BOMBytes.Length < 4)
                return null;

            if (BOMBytes[0] == 0xff && BOMBytes[1] == 0xfe && BOMBytes[2] == 0 && BOMBytes[3] == 0)
                return Encoding.UTF32;

            if (BOMBytes[0] == 0 && BOMBytes[1] == 0 && BOMBytes[2] == 0xfe && BOMBytes[3] == 0xff)
                return Encoding.GetEncoding(12001);

            return null;
        }

        public static Encoding DetectUnicodeInByteSampleByHeuristics(byte[] SampleBytes)
        {
            long oddBinaryNullsInSample = 0;
            long evenBinaryNullsInSample = 0;
            long suspiciousUTF8SequenceCount = 0;
            long suspiciousUTF8BytesTotal = 0;
            long likelyUSASCIIBytesInSample = 0;

            //Cycle through, keeping count of binary null positions, possible UTF-8
            //  sequences from upper ranges of Windows-1252, and probable US-ASCII
            //  character counts.

            long currentPos = 0;
            int skipUTF8Bytes = 0;

            while (currentPos < SampleBytes.Length)
            {
                //binary null distribution
                if (SampleBytes[currentPos] == 0)
                {
                    if (currentPos % 2 == 0)
                        evenBinaryNullsInSample++;
                    else
                        oddBinaryNullsInSample++;
                }

                //likely US-ASCII characters
                if (IsCommonUSASCIIByte(SampleBytes[currentPos]))
                    likelyUSASCIIBytesInSample++;

                //suspicious sequences (look like UTF-8)
                if (skipUTF8Bytes == 0)
                {
                    int lengthFound = DetectSuspiciousUTF8SequenceLength(SampleBytes, currentPos);

                    if (lengthFound > 0)
                    {
                        suspiciousUTF8SequenceCount++;
                        suspiciousUTF8BytesTotal += lengthFound;
                        skipUTF8Bytes = lengthFound - 1;
                    }
                }
                else
                {
                    skipUTF8Bytes--;
                }

                currentPos++;
            }

            //1: UTF-16 LE - in english / european environments, this is usually characterized by a
            //  high proportion of odd binary nulls (starting at 0), with (as this is text) a low
            //  proportion of even binary nulls.
            //  The thresholds here used (less than 20% nulls where you expect non-nulls, and more than
            //  60% nulls where you do expect nulls) are completely arbitrary.

            if (((evenBinaryNullsInSample * 2.0) / SampleBytes.Length) < 0.2
                && ((oddBinaryNullsInSample * 2.0) / SampleBytes.Length) > 0.6
                )
                return Encoding.Unicode;

            //2: UTF-16 BE - in english / european environments, this is usually characterized by a
            //  high proportion of even binary nulls (starting at 0), with (as this is text) a low
            //  proportion of odd binary nulls.
            //  The thresholds here used (less than 20% nulls where you expect non-nulls, and more than
            //  60% nulls where you do expect nulls) are completely arbitrary.

            if (((oddBinaryNullsInSample * 2.0) / SampleBytes.Length) < 0.2
                && ((evenBinaryNullsInSample * 2.0) / SampleBytes.Length) > 0.6
                )
                return Encoding.BigEndianUnicode;

            //3: UTF-8 - Martin Dürst outlines a method for detecting whether something CAN be UTF-8 content
            //  using regexp, in his w3c.org unicode FAQ entry:
            //  http://www.w3.org/International/questions/qa-forms-utf-8
            //  adapted here for C#.
            string potentiallyMangledString = Encoding.ASCII.GetString(SampleBytes);

            Regex UTF8Validator = new Regex(@"\A(" + @"[\x09\x0A\x0D\x20-\x7E]" + @"|[\xC2-\xDF][\x80-\xBF]" + @"|\xE0[\xA0-\xBF][\x80-\xBF]" + @"|[\xE1-\xEC\xEE\xEF][\x80-\xBF]{2}" + @"|\xED[\x80-\x9F][\x80-\xBF]" + @"|\xF0[\x90-\xBF][\x80-\xBF]{2}" + @"|[\xF1-\xF3][\x80-\xBF]{3}" + @"|\xF4[\x80-\x8F][\x80-\xBF]{2}" + @")*\z");
            if (UTF8Validator.IsMatch(potentiallyMangledString))
            {
                //Unfortunately, just the fact that it CAN be UTF-8 doesn't tell you much about probabilities.
                //If all the characters are in the 0-127 range, no harm done, most western charsets are same as UTF-8 in these ranges.
                //If some of the characters were in the upper range (western accented characters), however, they would likely be mangled to 2-byte by the UTF-8 encoding process.
                // So, we need to play stats.

                // The "Random" likelihood of any pair of randomly generated characters being one
                //   of these "suspicious" character sequences is:
                //     128 / (256 * 256) = 0.2%.
                //
                // In western text data, that is SIGNIFICANTLY reduced - most text data stays in the <127
                //   character range, so we assume that more than 1 in 500,000 of these character
                //   sequences indicates UTF-8. The number 500,000 is completely arbitrary - so sue me.
                //
                // We can only assume these character sequences will be rare if we ALSO assume that this
                //   IS in fact western text - in which case the bulk of the UTF-8 encoded data (that is
                //   not already suspicious sequences) should be plain US-ASCII bytes. This, I
                //   arbitrarily decided, should be 80% (a random distribution, eg binary data, would yield
                //   approx 40%, so the chances of hitting this threshold by accident in random data are
                //   VERY low).

                if ((suspiciousUTF8SequenceCount * 500000.0 / SampleBytes.Length >= 1) //suspicious sequences
                    && (
                           //all suspicious, so cannot evaluate proportion of US-Ascii
                           SampleBytes.Length - suspiciousUTF8BytesTotal == 0
                           ||
                           likelyUSASCIIBytesInSample * 1.0 / (SampleBytes.Length - suspiciousUTF8BytesTotal) >= 0.8
                       )
                    )
                    return Encoding.UTF8;
            }

            return null;
        }

        private static bool IsCommonUSASCIIByte(byte testByte)
        {
            if (testByte == 0x0A //lf
                || testByte == 0x0D //cr
                || testByte == 0x09 //tab
                || (testByte >= 0x20 && testByte <= 0x2F) //common punctuation
                || (testByte >= 0x30 && testByte <= 0x39) //digits
                || (testByte >= 0x3A && testByte <= 0x40) //common punctuation
                || (testByte >= 0x41 && testByte <= 0x5A) //capital letters
                || (testByte >= 0x5B && testByte <= 0x60) //common punctuation
                || (testByte >= 0x61 && testByte <= 0x7A) //lowercase letters
                || (testByte >= 0x7B && testByte <= 0x7E) //common punctuation
                )
                return true;
            else
                return false;
        }

        private static int DetectSuspiciousUTF8SequenceLength(byte[] SampleBytes, long currentPos)
        {
            int lengthFound = 0;

            if (SampleBytes.Length >= currentPos + 1
                && SampleBytes[currentPos] == 0xC2
                )
            {
                if (SampleBytes[currentPos + 1] == 0x81
                    || SampleBytes[currentPos + 1] == 0x8D
                    || SampleBytes[currentPos + 1] == 0x8F
                    )
                    lengthFound = 2;
                else if (SampleBytes[currentPos + 1] == 0x90
                    || SampleBytes[currentPos + 1] == 0x9D
                    )
                    lengthFound = 2;
                else if (SampleBytes[currentPos + 1] >= 0xA0
                    && SampleBytes[currentPos + 1] <= 0xBF
                    )
                    lengthFound = 2;
            }
            else if (SampleBytes.Length >= currentPos + 1
                && SampleBytes[currentPos] == 0xC3
                )
            {
                if (SampleBytes[currentPos + 1] >= 0x80
                    && SampleBytes[currentPos + 1] <= 0xBF
                    )
                    lengthFound = 2;
            }
            else if (SampleBytes.Length >= currentPos + 1
                && SampleBytes[currentPos] == 0xC5
                )
            {
                if (SampleBytes[currentPos + 1] == 0x92
                    || SampleBytes[currentPos + 1] == 0x93
                    )
                    lengthFound = 2;
                else if (SampleBytes[currentPos + 1] == 0xA0
                    || SampleBytes[currentPos + 1] == 0xA1
                    )
                    lengthFound = 2;
                else if (SampleBytes[currentPos + 1] == 0xB8
                    || SampleBytes[currentPos + 1] == 0xBD
                    || SampleBytes[currentPos + 1] == 0xBE
                    )
                    lengthFound = 2;
            }
            else if (SampleBytes.Length >= currentPos + 1
                && SampleBytes[currentPos] == 0xC6
                )
            {
                if (SampleBytes[currentPos + 1] == 0x92)
                    lengthFound = 2;
            }
            else if (SampleBytes.Length >= currentPos + 1
                && SampleBytes[currentPos] == 0xCB
                )
            {
                if (SampleBytes[currentPos + 1] == 0x86
                    || SampleBytes[currentPos + 1] == 0x9C
                    )
                    lengthFound = 2;
            }
            else if (SampleBytes.Length >= currentPos + 2
                && SampleBytes[currentPos] == 0xE2
                )
            {
                if (SampleBytes[currentPos + 1] == 0x80)
                {
                    if (SampleBytes[currentPos + 2] == 0x93
                        || SampleBytes[currentPos + 2] == 0x94
                        )
                        lengthFound = 3;
                    if (SampleBytes[currentPos + 2] == 0x98
                        || SampleBytes[currentPos + 2] == 0x99
                        || SampleBytes[currentPos + 2] == 0x9A
                        )
                        lengthFound = 3;
                    if (SampleBytes[currentPos + 2] == 0x9C
                        || SampleBytes[currentPos + 2] == 0x9D
                        || SampleBytes[currentPos + 2] == 0x9E
                        )
                        lengthFound = 3;
                    if (SampleBytes[currentPos + 2] == 0xA0
                        || SampleBytes[currentPos + 2] == 0xA1
                        || SampleBytes[currentPos + 2] == 0xA2
                        )
                        lengthFound = 3;
                    if (SampleBytes[currentPos + 2] == 0xA6)
                        lengthFound = 3;
                    if (SampleBytes[currentPos + 2] == 0xB0)
                        lengthFound = 3;
                    if (SampleBytes[currentPos + 2] == 0xB9
                        || SampleBytes[currentPos + 2] == 0xBA
                        )
                        lengthFound = 3;
                }
                else if (SampleBytes[currentPos + 1] == 0x82
                    && SampleBytes[currentPos + 2] == 0xAC
                    )
                    lengthFound = 3;
                else if (SampleBytes[currentPos + 1] == 0x84
                    && SampleBytes[currentPos + 2] == 0xA2
                    )
                    lengthFound = 3;
            }

            return lengthFound;
        }
    }

    //Pause code

    [Flags]
    public enum ThreadAccess : int
    {
        TERMINATE = (0x0001),
        SUSPEND_RESUME = (0x0002),
        GET_CONTEXT = (0x0008),
        SET_CONTEXT = (0x0010),
        SET_INFORMATION = (0x0020),
        QUERY_INFORMATION = (0x0040),
        SET_THREAD_TOKEN = (0x0080),
        IMPERSONATE = (0x0100),
        DIRECT_IMPERSONATION = (0x0200)
    }

    public enum EXECUTION_STATE : uint
    {
        ES_AWAYMODE_REQUIRED = 0x00000040,
        ES_CONTINUOUS = 0x80000000,
        ES_DISPLAY_REQUIRED = 0x00000002,
        ES_SYSTEM_REQUIRED = 0x00000001,
    }

    public static class NativeMethods
    {
        [DllImport("kernel32.dll", SetLastError = true, CallingConvention = CallingConvention.Winapi)]
        [return: MarshalAs(UnmanagedType.Bool)]
        internal static extern bool IsWow64Process([In] IntPtr process, [Out] out bool wow64Process);

        [DllImport("kernel32.dll", CharSet = CharSet.Auto, SetLastError = true)]
        public static extern EXECUTION_STATE SetThreadExecutionState(EXECUTION_STATE esFlags);

        [DllImport("kernel32.dll")]
        private static extern IntPtr OpenThread(ThreadAccess dwDesiredAccess, bool bInheritHandle, uint dwThreadId);

        [DllImport("kernel32.dll")]
        private static extern uint SuspendThread(IntPtr hThread);

        [DllImport("kernel32.dll")]
        private static extern int ResumeThread(IntPtr hThread);

        public static void Suspend(this Process process)
        {
            foreach (ProcessThread thread in process.Threads)
            {
                var pOpenThread = OpenThread(ThreadAccess.SUSPEND_RESUME, false, (uint)thread.Id);
                if (pOpenThread == IntPtr.Zero)
                {
                    break;
                }
                SuspendThread(pOpenThread);
            }
        }

        public static void Resume(this Process process)
        {
            foreach (ProcessThread thread in process.Threads)
            {
                var pOpenThread = OpenThread(ThreadAccess.SUSPEND_RESUME, false, (uint)thread.Id);
                if (pOpenThread == IntPtr.Zero)
                {
                    break;
                }
                ResumeThread(pOpenThread);
            }
        }
    }

    //End pause code
    //Flickering progress bar text
    public class ProgressBarWithText : ProgressBar
    {
        private const int WmPaint = 15;
        private SizeF TextSize;
        private PointF TextPos;

        public ProgressBarWithText()
        {
            this.DoubleBuffered = true;
            this.TextChanged += ProgressBarWithText_TextChanged;
            this.SizeChanged += ProgressBarWithText_SizeChanged;
        }

        public override string Text
        {
            get { return base.Text; }
            set { base.Text = value; }
        }

        private void RecalcTextPos()
        {
            if (string.IsNullOrEmpty(base.Text))
                return;

            using (var graphics = Graphics.FromHwnd(this.Handle))
            {
                TextSize = graphics.MeasureString(base.Text, this.Font);
                TextPos.X = (this.Width / 2) - (TextSize.Width / 2) + 1;
                TextPos.Y = (this.Height / 2) - (TextSize.Height / 2);
            }
        }

        private void ProgressBarWithText_SizeChanged(object sender, EventArgs e)
        {
            RecalcTextPos();
        }

        private void ProgressBarWithText_TextChanged(object sender, EventArgs e)
        {
            RecalcTextPos();
        }

        protected override void WndProc(ref Message m)
        {
            base.WndProc(ref m);

            switch (m.Msg)
            {
                case WmPaint:
                    using (var graphics = Graphics.FromHwnd(Handle))
                        graphics.DrawString(base.Text, base.Font, Brushes.Black, TextPos.X, TextPos.Y);
                    break;
            }
        }

        protected override CreateParams CreateParams
        {
            get
            {
                CreateParams result = base.CreateParams;
                result.ExStyle |= 0x02000000; // WS_EX_COMPOSITED
                return result;
            }
        }
    }

    public static class TaskbarProgress
    {
        public enum TaskbarStates
        {
            NoProgress = 0,
            Indeterminate = 0x1,
            Normal = 0x2,
            Error = 0x4,
            Paused = 0x8
        }

        [ComImport()]
        [Guid("ea1afb91-9e28-4b86-90e9-9e9f8a5eefaf")]
        [InterfaceType(ComInterfaceType.InterfaceIsIUnknown)]
        private interface ITaskbarList3
        {
            // ITaskbarList
            [PreserveSig]
            void HrInit();

            [PreserveSig]
            void AddTab(IntPtr hwnd);

            [PreserveSig]
            void DeleteTab(IntPtr hwnd);

            [PreserveSig]
            void ActivateTab(IntPtr hwnd);

            [PreserveSig]
            void SetActiveAlt(IntPtr hwnd);

            // ITaskbarList2
            [PreserveSig]
            void MarkFullscreenWindow(IntPtr hwnd, [MarshalAs(UnmanagedType.Bool)] bool fFullscreen);

            // ITaskbarList3
            [PreserveSig]
            void SetProgressValue(IntPtr hwnd, UInt64 ullCompleted, UInt64 ullTotal);

            [PreserveSig]
            void SetProgressState(IntPtr hwnd, TaskbarStates state);
        }

        [ComImport()]
        [Guid("56fdf344-fd6d-11d0-958a-006097c9a090")]
        [ClassInterface(ClassInterfaceType.None)]
        private class TaskbarInstance
        {
        }

        private static ITaskbarList3 taskbarInstance = (ITaskbarList3)new TaskbarInstance();
        private static bool taskbarSupported = Environment.OSVersion.Version >= new Version(6, 1);

        public static void SetState(IntPtr windowHandle, TaskbarStates taskbarState)
        {
            if (taskbarSupported) taskbarInstance.SetProgressState(windowHandle, taskbarState);
        }

        public static void SetValue(IntPtr windowHandle, double progressValue, double progressMax)
        {
            if (taskbarSupported) taskbarInstance.SetProgressValue(windowHandle, (ulong)progressValue, (ulong)progressMax);
        }
    }

    //END APP
}